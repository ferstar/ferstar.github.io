<?xml version="1.0" encoding="utf-8"?><rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title>STAY REAL</title><link>https://blog.ferstar.org/</link><description>闲谈莫论人非，静坐常思己过。</description><generator>Hugo 0.118.2 https://gohugo.io/</generator><language>zh-CN</language><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><lastBuildDate>Sat, 02 Sep 2023 05:28:25 +0000</lastBuildDate><atom:link rel="self" type="application/rss+xml" href="https://blog.ferstar.org/rss.xml"/><item><title>Try github self-hosted action runner</title><link>https://blog.ferstar.org/post/issue-79/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-79/</guid><pubDate>Sat, 02 Sep 2023 04:23:11 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>Official docs: &lt;a href="https://docs.github.com/en/actions/hosting-your-own-runners">https://docs.github.com/en/actions/hosting-your-own-runners&lt;/a>&lt;/p>
&lt;p>Simple docker compose file:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;3.8&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">services&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">worker&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">myoung34/github-runner:ubuntu-bionic&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">environment&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">REPO_URL&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">${RUNNER_REPO}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">RUNNER_NAME&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">${RUNNER_NAME}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">RUNNER_TOKEN&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">${RUNNER_TOKEN}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">CONFIGURED_ACTIONS_RUNNER_FILES_DIR&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">${CONFIGURED_ACTIONS_RUNNER_FILES_DIR}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">DISABLE_AUTOMATIC_DEREGISTRATION&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">${DISABLE_AUTOMATIC_DEREGISTRATION}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">RUNNER_WORKDIR&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/tmp/runner/work&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ORG_RUNNER&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;false&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">LABELS&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">linux,x64,home-1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">security_opt&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># needed on SELinux systems to allow docker container to manage other docker containers&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">label:disable&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s1">&amp;#39;/var/run/docker.sock:/var/run/docker.sock&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s1">&amp;#39;/tmp/runner:/tmp/runner&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s1">&amp;#39;./data:/data&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># note: a quirk of docker-in-docker is that this path&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># needs to be the same path on host and inside the container,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># docker mgmt cmds run outside of docker but expect the paths from within&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Your &lt;code>.env&lt;/code> file may be like this:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">RUNNER_REPO&lt;/span>&lt;span class="o">=&lt;/span>https://github.com/user/repo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">RUNNER_TOKEN&lt;/span>&lt;span class="o">=&lt;/span>NOT THE GITHUB ACCESS TOKEN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">RUNNER_NAME&lt;/span>&lt;span class="o">=&lt;/span>foo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">CONFIGURED_ACTIONS_RUNNER_FILES_DIR&lt;/span>&lt;span class="o">=&lt;/span>/data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">DISABLE_AUTOMATIC_DEREGISTRATION&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Please note that the &lt;code>RUNNER_TOKEN&lt;/code> is not your github access token&lt;/p>
&lt;ol>
&lt;li>visit &lt;a href="https://github.com/user/repo/settings/actions/runners/new">https://github.com/user/repo/settings/actions/runners/new&lt;/a>&lt;/li>
&lt;li>get your action's real token&lt;/li>
&lt;/ol>
&lt;p>&lt;img src="https://github.com/ferstar/blog/assets/2854276/7d6a6fbe-0812-4299-91b3-a2dc2d595167" alt="image">&lt;/p>
&lt;p>Some normal running logs:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">docker-compose up
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Recreating github-actions_worker_1 ... &lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Attaching to github-actions_worker_1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span> Runner reusage is disabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span> Configuring
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span> --------------------------------------------------------------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> ____ _ _ _ _ _ _ _ _ &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> / ___&lt;span class="o">(&lt;/span>_&lt;span class="o">)&lt;/span> &lt;span class="p">|&lt;/span>_&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>_ _&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>__ / &lt;span class="se">\ &lt;/span> ___&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>_&lt;span class="o">(&lt;/span>_&lt;span class="o">)&lt;/span> ___ _ __ ___ &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> _&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> __&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>_&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="s1">&amp;#39;_ \ / _ \ / __| __| |/ _ \| &amp;#39;&lt;/span>_ &lt;span class="se">\/&lt;/span> __&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>_&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>_&lt;span class="p">|&lt;/span> _ &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>_&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>_&lt;span class="o">)&lt;/span> &lt;span class="p">|&lt;/span> / ___ &lt;span class="se">\ &lt;/span>&lt;span class="o">(&lt;/span>__&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>_&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="o">(&lt;/span>_&lt;span class="o">)&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="se">\_&lt;/span>_ &lt;span class="se">\ &lt;/span> &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="se">\_&lt;/span>___&lt;span class="p">|&lt;/span>_&lt;span class="p">|&lt;/span>&lt;span class="se">\_&lt;/span>_&lt;span class="p">|&lt;/span>_&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>_&lt;span class="p">|&lt;/span>&lt;span class="se">\_&lt;/span>_,_&lt;span class="p">|&lt;/span>_.__/ /_/ &lt;span class="se">\_\_&lt;/span>__&lt;span class="p">|&lt;/span>&lt;span class="se">\_&lt;/span>_&lt;span class="p">|&lt;/span>_&lt;span class="p">|&lt;/span>&lt;span class="se">\_&lt;/span>__/&lt;span class="p">|&lt;/span>_&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>_&lt;span class="p">|&lt;/span>___/ &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> Self-hosted runner registration &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span> --------------------------------------------------------------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span> &lt;span class="c1"># Authentication&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span> √ Connected to GitHub
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span> &lt;span class="c1"># Runner Registration&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span> √ Runner successfully added
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span> √ Runner connection is good
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span> &lt;span class="c1"># Runner settings&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span> √ Settings Saved.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span> √ Connected to GitHub
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span> Current runner version: &lt;span class="s1">&amp;#39;2.308.0&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span> 2023-09-02 03:22:29Z: Listening &lt;span class="k">for&lt;/span> Jobs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span> 2023-09-02 03:23:08Z: Running job: build_deb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_1 &lt;span class="p">|&lt;/span> 2023-09-02 03:26:51Z: Job build_deb completed with result: Succeeded
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2023-09-02T04:23:11+08:00
update@2023-09-02T05:21:40+08:00
comment@https://github.com/ferstar/blog/issues/79
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/git/">Git</category></item><item><title>信创之从PostgreSQL到GaussDB</title><link>https://blog.ferstar.org/post/issue-78/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-78/</guid><pubDate>Thu, 15 Jun 2023 06:19:44 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>信创是个啥玩意具体我懒得说了，简单记录下作为中年 CRUD 仔给 Web 后端换 DB 这件事。&lt;/p>
&lt;/blockquote>
&lt;p>情况大概是这样：&lt;/p>
&lt;p>我们 ORM 是 &lt;a href="https://snyk.io/advisor/python/gino">Gino&lt;/a>&lt;/p>
&lt;p>然后 Gino 依赖 &lt;a href="https://github.com/MagicStack/asyncpg">asyncpg&lt;/a> 来链接 PostgreSQL，换 GaussDB 的话，由于这玩意是华为从 PostgreSQL 一个古早版本 9.2.4 一通魔改糊起来的，一些特性并不支持，所以这一步就掉坑了：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> await self._protocol.query&lt;span class="o">(&lt;/span>query, timeout&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> File &lt;span class="s2">&amp;#34;asyncpg/protocol/protocol.pyx&amp;#34;&lt;/span>, line 338, in query
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">asyncpg.exceptions.FeatureNotSupportedError: UNLISTEN statement is not yet supported.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>查了下华为云的说明：&lt;/p>
&lt;p>&lt;a href="https://support.huaweicloud.com/intl/en-us/sqlreference-dws/dws_06_0006.html">https://support.huaweicloud.com/intl/en-us/sqlreference-dws/dws_06_0006.html&lt;/a>&lt;/p>
&lt;p>嗯，发现不支持 notification 相关特性，那么看来要小改下 asyncpg，见：&lt;/p>
&lt;p>&lt;a href="https://github.com/ferstar/asyncpg/commit/0be6023443346213a26795a27ef3add7abc79aea">https://github.com/ferstar/asyncpg/commit/0be6023443346213a26795a27ef3add7abc79aea&lt;/a>&lt;/p>
&lt;p>让 asyncpg 识别到 GaussDB 以后关几个 feature 即可，这里的 server_settings 可以通过初始化 DB Pool 的时候传过去。&lt;/p>
&lt;p>我们通过 &lt;a href="https://alembic.sqlalchemy.org/">alembic&lt;/a> 来做 DB migration，这个环节也出现了类似的问题，就是人家不认这个 GaussDB，解决也简单：改到让他认。&lt;/p>
&lt;p>见：https://github.com/sqlalchemy/sqlalchemy/commit/3a0794ce455201a219a5e8491a9c346d69558ad9&lt;/p>
&lt;p>然后正常连接是没有问题了，但跑到一些 GaussDB 不支持的迁移脚本时就又扑街：项目用到了 gin 的 extension，看一时半会估计是不太会兼容了，所以么办法只能改写用普通索引。&lt;/p>
&lt;p>接下来，项目初始化、DB migration都顺利完成，于是就跑了一发单元测试，再次被打脸：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">ProgrammingError: syntax error at or near &lt;span class="s2">&amp;#34;ON CONFLICT (&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>也就是说&lt;code>UPDATE ... ON CONFLICT ... DO ...&lt;/code>这种也是不支持，要改也简单：先查冲突，然后再更新。&lt;/p>
&lt;p>一通操作后，项目总算正常运行。后续有几个需要注意的问题：&lt;/p>
&lt;ol>
&lt;li>代码要考虑兼容性：从base version来看，横跨了好几个大版本，基本上告别 PostgreSQL 新特性&lt;/li>
&lt;li>DB 相关组件也要考虑兼容性，自己订制魔改的部分，几乎不太可能被主线合并&lt;/li>
&lt;li>组员代码审核：需要维护一个lint机制来自动检测组员提交的 DB 相关代码的兼容性&lt;/li>
&lt;/ol>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2023-06-15T06:19:44+08:00
update@2023-06-15T06:19:44+08:00
comment@https://github.com/ferstar/blog/issues/78
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/postgresql/">PostgreSQL</category></item><item><title>Migrate from Tornado to FastAPI</title><link>https://blog.ferstar.org/post/issue-77/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-77/</guid><pubDate>Fri, 09 Jun 2023 12:32:25 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;ul>
&lt;li>Why&lt;/li>
&lt;li>How&lt;/li>
&lt;li>Benefits&lt;/li>
&lt;/ul>
&lt;p>W.I.P.&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2023-06-09T12:32:25+08:00
update@2023-06-09T12:33:02+08:00
comment@https://github.com/ferstar/blog/issues/77
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/todo/">TODO</category></item><item><title>如何在Linux X11开启R9000P2021款笔记本165Hz刷新率</title><link>https://blog.ferstar.org/post/issue-76/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-76/</guid><pubDate>Tue, 25 Apr 2023 02:40:04 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>我这款本子是 3050Ti 的显卡，Linux 下偶尔炼个超迷你小丹凑合用一下，平常大部分时候都是闲置状态，所以多数情况用的是&lt;strong>混合模式&lt;/strong>而非&lt;strong>独显直通&lt;/strong>。&lt;/p>
&lt;p>这样有个问题，不管是 Archlinux 还是 Ubuntu，进桌面显示器配置就只有 60Hz 的选项，但切到&lt;strong>独显直通&lt;/strong>，165Hz 的高刷就又有了，一通搜索以后，得出结论：在混合模式下系统无法准确获取EDID文件。另外即使是&lt;strong>独显直通&lt;/strong>状态，屏幕回报的刷新率是 165.02Hz，说明这块屏幕不是标准的 165Hz 行刷新率，操作系统并没有正确的屏幕分辨率信息。&lt;/p>
&lt;p>我在这里 &lt;a href="https://wiki.archlinux.org/title/xrandr#Troubleshooting">https://wiki.archlinux.org/title/xrandr#Troubleshooting&lt;/a> 找到了这个问题的解决办法：&lt;/p>
&lt;p>先在&lt;strong>独显直通&lt;/strong>状态，通过&lt;code>xrandr --verbose&lt;/code>记下 60、165Hz 的 Modeline，我的机器是这样的：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 60Hz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">282.7 &lt;span class="m">2560&lt;/span> &lt;span class="m">2608&lt;/span> &lt;span class="m">2640&lt;/span> &lt;span class="m">2720&lt;/span> &lt;span class="m">1600&lt;/span> &lt;span class="m">1603&lt;/span> &lt;span class="m">1609&lt;/span> &lt;span class="m">1732&lt;/span> -HSync -VSync
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 165Hz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">777.410 &lt;span class="m">2560&lt;/span> &lt;span class="m">2608&lt;/span> &lt;span class="m">2640&lt;/span> &lt;span class="m">2720&lt;/span> &lt;span class="m">1600&lt;/span> &lt;span class="m">1603&lt;/span> &lt;span class="m">1609&lt;/span> &lt;span class="m">1732&lt;/span> -HSync -VSync
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>接下来就是把这两种配置用&lt;code>xrandr&lt;/code>添加到内屏配置上，由于&lt;strong>混合模式&lt;/strong>和&lt;strong>独显直通&lt;/strong>两种模式下，内屏设备名并不固定，可以通过如下命令找到：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">xrandr &lt;span class="p">|&lt;/span> grep -i &lt;span class="s1">&amp;#39; connected&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> cut -d &lt;span class="s1">&amp;#39; &amp;#39;&lt;/span> -f &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>我的机器输出如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">eDP-1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DP-1-0 &lt;span class="c1"># 这个其实是我的外接屏幕&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>确定好内屏设备名（eDP-1）以后，就可以来指定我们上面探测到的分辨率配置了：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 65Hz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">xrandr --newmode &lt;span class="s2">&amp;#34;2560x1600_60.00&amp;#34;&lt;/span> 282.7 &lt;span class="m">2560&lt;/span> &lt;span class="m">2608&lt;/span> &lt;span class="m">2640&lt;/span> &lt;span class="m">2720&lt;/span> &lt;span class="m">1600&lt;/span> &lt;span class="m">1603&lt;/span> &lt;span class="m">1609&lt;/span> &lt;span class="m">1732&lt;/span> -HSync -VSync
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">xrandr --addmode eDP-1 2560x1600_60.00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 165Hz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">xrandr --newmode &lt;span class="s2">&amp;#34;2560x1600_165.00&amp;#34;&lt;/span> 777.410 &lt;span class="m">2560&lt;/span> &lt;span class="m">2608&lt;/span> &lt;span class="m">2640&lt;/span> &lt;span class="m">2720&lt;/span> &lt;span class="m">1600&lt;/span> &lt;span class="m">1603&lt;/span> &lt;span class="m">1609&lt;/span> &lt;span class="m">1732&lt;/span> -HSync -VSync
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">xrandr --addmode eDP-1 2560x1600_165.00
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>此时打开显示器配置，熟悉的高刷分辨率就回来了，且可以自由切换。&lt;/p>
&lt;p>&lt;img src="https://user-images.githubusercontent.com/2854276/234154957-dab73e59-5526-40bd-a1be-8e5ebdf0f103.png" alt="image">&lt;/p>
&lt;p>当然你也可以继续用&lt;code>xrandr&lt;/code>在命令行切换当前显示器的刷新率：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">xrandr --output eDP-1 --mode &lt;span class="s2">&amp;#34;2560x1600_165.00&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">xrandr --output eDP-1 --mode &lt;span class="s2">&amp;#34;2560x1600_60.00&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>以上临时注入的配置在重启以后就会消失，Archlinux Wiki 里贴心的写了持久化方案，也就是把配置写到 xorg 文件里。作为懒癌患者，因为偶尔还有不插电的使用场景，所以当然是要搞成自动挡啦：插电 165、电池 60。那么就有两个问题需要解决：&lt;/p>
&lt;ol>
&lt;li>插电、离电条件触发&lt;/li>
&lt;li>写个切换分辨率的脚本&lt;/li>
&lt;/ol>
&lt;p>KDE 的系统配置==》电源管理==》节能==》（交流供电、电池供电）运行脚本刚好可以解决脚本触发条件的问题，接下来就是上脚本了：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/usr/bin/env bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>&lt;span class="nv">intern&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>xrandr &lt;span class="p">|&lt;/span> grep &lt;span class="s2">&amp;#34; connected&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> grep &lt;span class="s2">&amp;#34;eDP&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> cut -d&lt;span class="s2">&amp;#34; &amp;#34;&lt;/span> -f1&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">resolution&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;2560x1600&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">low_mode&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">resolution&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">_60.00&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">high_mode&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">resolution&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">_165.00&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">function&lt;/span> add_mode &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>xrandr &lt;span class="p">|&lt;/span> grep -E -c &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> -eq &lt;span class="m">0&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$low_mode&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> xrandr --newmode &lt;span class="nv">$low_mode&lt;/span> 282.7 &lt;span class="m">2560&lt;/span> &lt;span class="m">2608&lt;/span> &lt;span class="m">2640&lt;/span> &lt;span class="m">2720&lt;/span> &lt;span class="m">1600&lt;/span> &lt;span class="m">1603&lt;/span> &lt;span class="m">1609&lt;/span> &lt;span class="m">1732&lt;/span> -HSync -VSync
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> xrandr --addmode &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$intern&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="nv">$low_mode&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$high_mode&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> xrandr --newmode &lt;span class="nv">$high_mode&lt;/span> 777.410 &lt;span class="m">2560&lt;/span> &lt;span class="m">2608&lt;/span> &lt;span class="m">2640&lt;/span> &lt;span class="m">2720&lt;/span> &lt;span class="m">1600&lt;/span> &lt;span class="m">1603&lt;/span> &lt;span class="m">1609&lt;/span> &lt;span class="m">1732&lt;/span> -HSync -VSync
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> xrandr --addmode &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$intern&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="nv">$high_mode&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">function&lt;/span> change_fps &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;low&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> add_mode &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$low_mode&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> xrandr --output &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$intern&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> --mode &lt;span class="nv">$low_mode&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;high&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> add_mode &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$high_mode&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> xrandr --output &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$intern&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> --mode &lt;span class="nv">$high_mode&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$#&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> -eq &lt;span class="m">0&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;-h&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Usage: &lt;/span>&lt;span class="nv">$0&lt;/span>&lt;span class="s2"> [low|high]&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">change_fps &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2023-04-25T02:40:04+08:00
update@2023-05-08T05:52:52+08:00
comment@https://github.com/ferstar/blog/issues/76
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>记一次莫名的BTRFS修复过程</title><link>https://blog.ferstar.org/post/issue-75/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-75/</guid><pubDate>Tue, 07 Feb 2023 06:32:08 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>吃着火锅唱着歌，啪，分区被锁，dmesg 日志飘红 —— 盘挂了&lt;/p>
&lt;/blockquote>
&lt;p>赶紧重启进 LiveCD 尝试挂载&lt;code>mount -o rescue=usebackuproot /dev/nvme0n1p5 /mnt&lt;/code>，扑街&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> 183.966960&lt;span class="o">]&lt;/span> BTRFS info &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: using crc32c &lt;span class="o">(&lt;/span>crc32c-intel&lt;span class="o">)&lt;/span> checksum algorithm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> 183.966967&lt;span class="o">]&lt;/span> BTRFS info &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: trying to use backup root at mount &lt;span class="nb">time&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> 183.966968&lt;span class="o">]&lt;/span> BTRFS info &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: using free space tree
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> 183.968909&lt;span class="o">]&lt;/span> BTRFS info &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: bdev /dev/nvme0n1p5 errs: wr 0, rd 0, flush 0, corrupt 1, gen &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> 183.985663&lt;span class="o">]&lt;/span> BTRFS info &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: enabling ssd optimizations
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> 183.985665&lt;span class="o">]&lt;/span> BTRFS info &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: start tree-log replay
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> 184.107729&lt;span class="o">]&lt;/span> BTRFS error &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: incorrect extent count &lt;span class="k">for&lt;/span> 122436976640&lt;span class="p">;&lt;/span> counted 1577, expected &lt;span class="m">1575&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> 184.107744&lt;span class="o">]&lt;/span> BTRFS: error &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span> in btrfs_replay_log:2395: &lt;span class="nv">errno&lt;/span>&lt;span class="o">=&lt;/span>-5 IO failure &lt;span class="o">(&lt;/span>Failed to recover log tree&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> 184.120547&lt;span class="o">]&lt;/span> BTRFS error &lt;span class="o">(&lt;/span>device nvme0n1p5: state E&lt;span class="o">)&lt;/span>: open_ctree failed
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>死马当活马医，&lt;code>btrfsck --repair /dev/nvme0n1p5&lt;/code> 有个倒计时警告，不管了，直接上&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">enabling repair mode
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">WARNING:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Do not use --repair unless you are advised to &lt;span class="k">do&lt;/span> so by a developer
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> or an experienced user, and &lt;span class="k">then&lt;/span> only after having accepted that no
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> fsck can successfully repair all types of filesystem corruption. Eg.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> some software or hardware bugs can fatally damage a volume.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> The operation will start in &lt;span class="m">10&lt;/span> seconds.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Use Ctrl-C to stop it.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">10&lt;/span> &lt;span class="m">9&lt;/span> &lt;span class="m">8&lt;/span> &lt;span class="m">7&lt;/span> &lt;span class="m">6&lt;/span> &lt;span class="m">5&lt;/span> &lt;span class="m">4&lt;/span> &lt;span class="m">3&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Starting repair.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Opening filesystem to check...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Checking filesystem on /dev/nvme0n1p5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">UUID: 3681c364-deb7-4275-8e5d-9c6991467acb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">repair mode will force to clear out log tree, are you sure? &lt;span class="o">[&lt;/span>y/N&lt;span class="o">]&lt;/span>: y
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>1/7&lt;span class="o">]&lt;/span> checking root items
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Fixed &lt;span class="m">0&lt;/span> roots.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>2/7&lt;span class="o">]&lt;/span> checking extents
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">data extent&lt;span class="o">[&lt;/span>124231548928, 61440&lt;span class="o">]&lt;/span> referencer count mismatch &lt;span class="o">(&lt;/span>parent 180895744&lt;span class="o">)&lt;/span> wanted &lt;span class="m">0&lt;/span> have &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">data extent&lt;span class="o">[&lt;/span>124231548928, 61440&lt;span class="o">]&lt;/span> bytenr mimsmatch, extent item bytenr &lt;span class="m">124231548928&lt;/span> file item bytenr &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">data extent&lt;span class="o">[&lt;/span>124231548928, 61440&lt;span class="o">]&lt;/span> referencer count mismatch &lt;span class="o">(&lt;/span>parent 4503599808266240&lt;span class="o">)&lt;/span> wanted &lt;span class="m">1&lt;/span> have &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">backpointer mismatch on &lt;span class="o">[&lt;/span>&lt;span class="m">124231548928&lt;/span> 61440&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">repair deleting extent record: key &lt;span class="o">[&lt;/span>124231548928,168,61440&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">adding new data backref on &lt;span class="m">124231548928&lt;/span> parent &lt;span class="m">180895744&lt;/span> owner &lt;span class="m">0&lt;/span> offset &lt;span class="m">0&lt;/span> found &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Repaired extent references &lt;span class="k">for&lt;/span> &lt;span class="m">124231548928&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">super bytes used &lt;span class="m">112946282496&lt;/span> mismatches actual used &lt;span class="m">112946118656&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">No device size related problem found
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>3/7&lt;span class="o">]&lt;/span> checking free space tree
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">free space info recorded &lt;span class="m">1575&lt;/span> extents, counted &lt;span class="m">1577&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">There are still entries left in the space cache
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cache appears valid but isn&lt;span class="err">&amp;#39;&lt;/span>t &lt;span class="m">122436976640&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Clear free space cache v2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">free space cache v2 cleared
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>4/7&lt;span class="o">]&lt;/span> checking fs roots
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>5/7&lt;span class="o">]&lt;/span> checking only csums items &lt;span class="o">(&lt;/span>without verifying data&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>6/7&lt;span class="o">]&lt;/span> checking root refs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>7/7&lt;span class="o">]&lt;/span> checking quota groups skipped &lt;span class="o">(&lt;/span>not enabled on this FS&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">found &lt;span class="m">225892401152&lt;/span> bytes used, no error found
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total csum bytes: &lt;span class="m">217257440&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total tree bytes: &lt;span class="m">3289513984&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total fs tree bytes: &lt;span class="m">2747269120&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total extent tree bytes: &lt;span class="m">271155200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btree space waste bytes: &lt;span class="m">533066137&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">file data blocks allocated: &lt;span class="m">2738343133184&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> referenced &lt;span class="m">315154259968&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>估摸着有戏，赶紧再挂一次&lt;code>mount -o rescue=usebackuproot /dev/nvme0n1p5 /mnt&lt;/code>，居然就成了，赶紧&lt;code>dmesg | grep -i btrfs&lt;/code>瞧一瞧&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> 183.966960&lt;span class="o">]&lt;/span> BTRFS info &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: using crc32c &lt;span class="o">(&lt;/span>crc32c-intel&lt;span class="o">)&lt;/span> checksum algorithm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> 183.966967&lt;span class="o">]&lt;/span> BTRFS info &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: trying to use backup root at mount &lt;span class="nb">time&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> 183.966968&lt;span class="o">]&lt;/span> BTRFS info &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: using free space tree
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> 183.968909&lt;span class="o">]&lt;/span> BTRFS info &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: bdev /dev/nvme0n1p5 errs: wr 0, rd 0, flush 0, corrupt 1, gen &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这时候分区已经正常了，但是这行数字看着扎眼，强迫症不能忍：&lt;code> errs: wr 0, rd 0, flush 0, corrupt 1, gen 0&lt;/code>&lt;/p>
&lt;p>再来一发&lt;code>btrfs scrub start /mnt&lt;/code>，开&lt;code>dmesg -w&lt;/code>看下哪些文档没得救&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">BTRFS info &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: scrub: started on devid &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BTRFS warning &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: checksum error at logical &lt;span class="m">54326345728&lt;/span> on dev /dev/nvme0n1p5, physical 56482217984, root 259, inode 611588, offset 1441792, length 4096, links &lt;span class="m">1&lt;/span> &lt;span class="o">(&lt;/span>path: ferstar/Downloads/log &lt;span class="o">(&lt;/span>2&lt;span class="o">)&lt;/span>.tar.gz&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BTRFS error &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: bdev /dev/nvme0n1p5 errs: wr 0, rd 0, flush 0, corrupt 2, gen &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BTRFS error &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: unable to fixup &lt;span class="o">(&lt;/span>regular&lt;span class="o">)&lt;/span> error at logical &lt;span class="m">54326345728&lt;/span> on dev /dev/nvme0n1p5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BTRFS warning &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: checksum error at logical &lt;span class="m">123690389504&lt;/span> on dev /dev/nvme0n1p5, physical 125846261760, root 259, inode 2161195, offset 593920, length 4096, links &lt;span class="m">1&lt;/span> &lt;span class="o">(&lt;/span>path: ferstar/pyprojects/hkex/data/files/cf/0cdb845691cbe2c22789c727e00745&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BTRFS warning &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: checksum error at logical &lt;span class="m">123690455040&lt;/span> on dev /dev/nvme0n1p5, physical 125846327296, root 259, inode 2161195, offset 659456, length 4096, links &lt;span class="m">1&lt;/span> &lt;span class="o">(&lt;/span>path: ferstar/pyprojects/hkex/data/files/cf/0cdb845691cbe2c22789c727e00745&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BTRFS error &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: bdev /dev/nvme0n1p5 errs: wr 0, rd 0, flush 0, corrupt 3, gen &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BTRFS error &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: bdev /dev/nvme0n1p5 errs: wr 0, rd 0, flush 0, corrupt 4, gen &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BTRFS error &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: unable to fixup &lt;span class="o">(&lt;/span>regular&lt;span class="o">)&lt;/span> error at logical &lt;span class="m">123690455040&lt;/span> on dev /dev/nvme0n1p5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BTRFS error &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: unable to fixup &lt;span class="o">(&lt;/span>regular&lt;span class="o">)&lt;/span> error at logical &lt;span class="m">123690389504&lt;/span> on dev /dev/nvme0n1p5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BTRFS warning &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: checksum error at logical &lt;span class="m">123690463232&lt;/span> on dev /dev/nvme0n1p5, physical 125846335488, root 259, inode 2161195, offset 667648, length 4096, links &lt;span class="m">1&lt;/span> &lt;span class="o">(&lt;/span>path: ferstar/pyprojects/hkex/data/files/cf/0cdb845691cbe2c22789c727e00745&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BTRFS error &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: bdev /dev/nvme0n1p5 errs: wr 0, rd 0, flush 0, corrupt 5, gen &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BTRFS error &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: unable to fixup &lt;span class="o">(&lt;/span>regular&lt;span class="o">)&lt;/span> error at logical &lt;span class="m">123690463232&lt;/span> on dev /dev/nvme0n1p5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BTRFS info &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: scrub: finished on devid &lt;span class="m">1&lt;/span> with status: &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>把没救的文档删掉，然后清一下错误计数器&lt;code>btrfs dev stats -z /mnt&lt;/code>&lt;/p>
&lt;p>卸载再挂载一次，日志终于正常，完美&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">Btrfs loaded, &lt;span class="nv">crc32c&lt;/span>&lt;span class="o">=&lt;/span>crc32c-intel, &lt;span class="nv">zoned&lt;/span>&lt;span class="o">=&lt;/span>yes, &lt;span class="nv">fsverity&lt;/span>&lt;span class="o">=&lt;/span>yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BTRFS: device fsid 3681c364-deb7-4275-8e5d-9c6991467acb devid &lt;span class="m">1&lt;/span> transid &lt;span class="m">104541&lt;/span> /dev/nvme0n1p5 scanned by systemd-udevd &lt;span class="o">(&lt;/span>270&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BTRFS info &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: using crc32c &lt;span class="o">(&lt;/span>crc32c-intel&lt;span class="o">)&lt;/span> checksum algorithm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BTRFS info &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: disk space caching is enabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BTRFS info &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: enabling ssd optimizations
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BTRFS info &lt;span class="o">(&lt;/span>device nvme0n1p5&lt;span class="o">)&lt;/span>: checking UUID tree
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BTRFS info &lt;span class="o">(&lt;/span>device nvme0n1p5: state M&lt;span class="o">)&lt;/span>: trying to use backup root at mount &lt;span class="nb">time&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BTRFS info &lt;span class="o">(&lt;/span>device nvme0n1p5: state M&lt;span class="o">)&lt;/span>: force zstd compression, level &lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>附上参考资料：&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://zyyme.com/btrfs-fix.html">https://zyyme.com/btrfs-fix.html&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://btrfs.readthedocs.io">https://btrfs.readthedocs.io&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.firerain.me/article/21">https://blog.firerain.me/article/21&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.reddit.com/r/btrfs/comments/plmm01/comment/hcc83el">https://www.reddit.com/r/btrfs/comments/plmm01/comment/hcc83el&lt;/a>&lt;/li>
&lt;/ul>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2023-02-07T06:32:08+08:00
update@2023-02-07T06:32:15+08:00
comment@https://github.com/ferstar/blog/issues/75
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>Upgrading PostgreSQL from v14 to v15</title><link>https://blog.ferstar.org/post/issue-74/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-74/</guid><pubDate>Fri, 03 Feb 2023 11:51:35 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>&lt;a href="https://wiki.archlinux.org/title/PostgreSQL#Upgrading_PostgreSQL">https://wiki.archlinux.org/title/PostgreSQL#Upgrading_PostgreSQL&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>我的 PG 一般是随项目走的，假设路径：data/pg_data&lt;/p>
&lt;ul>
&lt;li>mv data/pg_data data/pg_data.old&lt;/li>
&lt;li>pacman -S postgresql-old-upgrade&lt;/li>
&lt;li>initdb -D data/pg_data --locale=zh_CN.UTF-8 --encoding=UTF8&lt;/li>
&lt;li>pg_upgrade -b /opt/pgsql-14/bin -B /usr/bin -d data/pg_data.old -D data/pg_data&lt;/li>
&lt;li>一切正常后删掉 data/pg_data.old 备份&lt;/li>
&lt;li>卸载掉 postgresql-old-upgrade&lt;/li>
&lt;/ul>
&lt;p>一些输出：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;span class="lnt">76
&lt;/span>&lt;span class="lnt">77
&lt;/span>&lt;span class="lnt">78
&lt;/span>&lt;span class="lnt">79
&lt;/span>&lt;span class="lnt">80
&lt;/span>&lt;span class="lnt">81
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">The files belonging to this database system will be owned by user &lt;span class="s2">&amp;#34;ferstar&amp;#34;&lt;/span>.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">This user must also own the server process.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">The database cluster will be initialized with locale &lt;span class="s2">&amp;#34;zh_CN.UTF-8&amp;#34;&lt;/span>.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">initdb: could not find suitable text search configuration &lt;span class="k">for&lt;/span> locale &lt;span class="s2">&amp;#34;zh_CN.UTF-8&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">The default text search configuration will be &lt;span class="nb">set&lt;/span> to &lt;span class="s2">&amp;#34;simple&amp;#34;&lt;/span>.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Data page checksums are disabled.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">creating directory data/pg_data ... ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">creating subdirectories ... ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">selecting dynamic shared memory implementation ... posix
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">selecting default max_connections ... &lt;span class="m">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">selecting default shared_buffers ... 128MB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">selecting default &lt;span class="nb">time&lt;/span> zone ... Asia/Shanghai
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">creating configuration files ... ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">running bootstrap script ... ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">performing post-bootstrap initialization ... ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">syncing data to disk ... ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">initdb: warning: enabling &lt;span class="s2">&amp;#34;trust&amp;#34;&lt;/span> authentication &lt;span class="k">for&lt;/span> &lt;span class="nb">local&lt;/span> connections
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">initdb: hint: You can change this by editing pg_hba.conf or using the option -A, or --auth-local and --auth-host, the next &lt;span class="nb">time&lt;/span> you run initdb.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Success. You can now start the database server using:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pg_ctl -D data/pg_data -l logfile start
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Performing Consistency Checks
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-----------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Checking cluster versions ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Checking database user is the install user ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Checking database connection settings ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Checking &lt;span class="k">for&lt;/span> prepared transactions ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Checking &lt;span class="k">for&lt;/span> system-defined composite types in user tables ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Checking &lt;span class="k">for&lt;/span> reg* data types in user tables ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Checking &lt;span class="k">for&lt;/span> contrib/isn with bigint-passing mismatch ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Creating dump of global objects ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Creating dump of database schemas
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Checking &lt;span class="k">for&lt;/span> presence of required libraries ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Checking database user is the install user ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Checking &lt;span class="k">for&lt;/span> prepared transactions ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Checking &lt;span class="k">for&lt;/span> new cluster tablespace directories ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">If pg_upgrade fails after this point, you must re-initdb the
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">new cluster before continuing.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Performing Upgrade
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Analyzing all rows in the new cluster ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Freezing all rows in the new cluster ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Deleting files from new pg_xact ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Copying old pg_xact to new server ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Setting oldest XID &lt;span class="k">for&lt;/span> new cluster ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Setting next transaction ID and epoch &lt;span class="k">for&lt;/span> new cluster ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Deleting files from new pg_multixact/offsets ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Copying old pg_multixact/offsets to new server ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Deleting files from new pg_multixact/members ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Copying old pg_multixact/members to new server ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Setting next multixact ID and offset &lt;span class="k">for&lt;/span> new cluster ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Resetting WAL archives ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Setting frozenxid and minmxid counters in new cluster ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Restoring global objects in the new cluster ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Restoring database schemas in the new cluster
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Copying user relation files
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Setting next OID &lt;span class="k">for&lt;/span> new cluster ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sync data directory to disk ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Creating script to delete old cluster ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Checking &lt;span class="k">for&lt;/span> extension updates ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Upgrade Complete
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">----------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Optimizer statistics are not transferred by pg_upgrade.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Once you start the new server, consider running:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /usr/bin/vacuumdb --all --analyze-in-stages
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Running this script will delete the old cluster&lt;span class="err">&amp;#39;&lt;/span>s data files:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ./delete_old_cluster.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>可能会碰到的报错：&lt;/p>
&lt;p>Q: lc_collate values for database &amp;quot;template1&amp;quot; do not match: old &amp;quot;zh_CN.UTF-8&amp;quot;, new &amp;quot;en_US.UTF-8&amp;quot;&lt;/p>
&lt;p>A: initdb -D data/pg_data --locale=zh_CN.UTF-8 --encoding=UTF8 指定一样的locale即可&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2023-02-03T11:51:35+08:00
update@2023-02-03T11:56:34+08:00
comment@https://github.com/ferstar/blog/issues/74
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/postgresql/">PostgreSQL</category></item><item><title>Linux触控板手势增强之「三指拖拽」</title><link>https://blog.ferstar.org/post/issue-73/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-73/</guid><pubDate>Sun, 29 Jan 2023 02:08:34 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>转用 Linux 后一直都比较怀念 macOS 上丝滑的&lt;strong>三指拖拽&lt;/strong>效果，鉴于近几年出的 Windows 本子触控板面积以及跟手性肉眼可见的改善了很多，我觉得是时候在 Linux 上折腾下&lt;strong>触控板手势&lt;/strong>了。&lt;/p>
&lt;/blockquote>
&lt;p>说干就干，放狗搜了一下，发现类似的实现还不少，小罗列下：&lt;/p>
&lt;ol>
&lt;li>&lt;a href="https://github.com/riley-martin/gestures">https://github.com/riley-martin/gestures&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/bulletmark/libinput-gestures">https://github.com/bulletmark/libinput-gestures&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/Coffee2CodeNL/gebaar-libinput">https://github.com/Coffee2CodeNL/gebaar-libinput&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/osleg/gebaar-libinput-fork">https://github.com/osleg/gebaar-libinput-fork&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/iberianpig/fusuma">https://github.com/iberianpig/fusuma&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/marsqing/libinput-three-finger-drag">https://github.com/marsqing/libinput-three-finger-drag&lt;/a>&lt;/li>
&lt;/ol>
&lt;p>基本上就是两种实现思路：&lt;/p>
&lt;ol>
&lt;li>解析&lt;code>libinput debug-events&lt;/code>输出，判断手势进而借用类似&lt;code>xdotool&lt;/code>之类的工具发送具体的键盘组合或者鼠标点击或位移指令&lt;/li>
&lt;li>直接调用&lt;code>libinput&lt;/code> API，明显此方法性能最优&lt;/li>
&lt;/ol>
&lt;p>我最在意的手势莫过于&lt;strong>三指拖拽&lt;/strong>，实现这个功能有两个注意的点：&lt;/p>
&lt;ol>
&lt;li>拖拽起止会有持续不断的位移指令发出，所以通过 fork shell 不间断发送位移指令的操作是非常低效的，见这个&lt;a href="https://github.com/riley-martin/gestures/discussions/6">讨论&lt;/a>。&lt;/li>
&lt;li>为了媲美 macOS 的丝滑拖拽效果，必须使用尽可能高效的实现。&lt;/li>
&lt;/ol>
&lt;p>于是乎我选择了一个 Rust &lt;a href="https://github.com/riley-martin/gestures">实现&lt;/a>开抄，负责实现 API 级别的触控手势识别，然后缝合了另一个 Rust &lt;a href="https://github.com/marsqing/libinput-three-finger-drag">实现&lt;/a>，负责实现 API 级别的&lt;strong>拖拽&lt;/strong>效果。&lt;/p>
&lt;p>终极缝合以后的产物效果还不错，基本符合预期：&lt;/p>
&lt;ol>
&lt;li>CPU 占用极低（极限情况：疯狂三指拖拽某窗口，本 fork 实现 CPU 占用不到1%；原实现5~10%；Python、Ruby等实现20%+）内存占用不到5MB，程序体积不到2MB，无多余依赖&lt;/li>
&lt;li>拖拽体验丝滑（如果觉得不够滑，那一定是你本子的触控板太渣，逃~）&lt;/li>
&lt;li>重放手指后支持继续拖动（延迟时间&lt;code>mouse_up_delay&lt;/code>可配）&lt;/li>
&lt;li>拖拽速度&lt;code>acceleration&lt;/code>可配置&lt;/li>
&lt;/ol>
&lt;p>编译好的二进制和示例配置文件见：&lt;a href="https://github.com/ferstar/gestures/releases">点我直达，选最新发布的就行&lt;/a> 理论上支持所有使用libinput触摸板驱动的 Linux 桌面环境。&lt;/p>
&lt;p>除X11「三指拖拽」以外，其他功能与原作一致。&lt;/p>
&lt;p>Enjoy！&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2023-01-29T02:08:34+08:00
update@2023-02-19T00:59:19+08:00
comment@https://github.com/ferstar/blog/issues/73
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>Super in comprehension</title><link>https://blog.ferstar.org/post/issue-72/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-72/</guid><pubDate>Tue, 24 Jan 2023 01:24:35 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>占坑🕳️&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2023-01-24T01:24:35+08:00
update@2023-01-24T01:24:50+08:00
comment@https://github.com/ferstar/blog/issues/72
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/todo/">TODO</category></item><item><title>gRPC小记</title><link>https://blog.ferstar.org/post/issue-71/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-71/</guid><pubDate>Tue, 24 Jan 2023 01:23:27 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>占坑🕳️&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2023-01-24T01:23:27+08:00
update@2023-01-24T01:23:39+08:00
comment@https://github.com/ferstar/blog/issues/71
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/todo/">TODO</category></item><item><title>AX3600 ShellClash 替换 clash-meta 核心</title><link>https://blog.ferstar.org/post/issue-70/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-70/</guid><pubDate>Tue, 24 Jan 2023 01:17:09 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>这个路由的 root 包括安装 shellclash 这个帖子介绍的很清楚：https://qust.me/post/ax3600_shellclash/&lt;/p>
&lt;p>我自然懒得赘述，下面主要提一下如何替换 clash-meta 核心以支持 hysteria 以及 tuic 这种非主流代理协议的方法 #66&lt;/p>
&lt;ol>
&lt;li>当然是先下载 clash 的啦（选 arm64 ）：https://github.com/MetaCubeX/Clash.Meta/releases，我用 Alpha，就是这么头铁&lt;/li>
&lt;li>解压&amp;amp;塞到路由器里&lt;/li>
&lt;/ol>
&lt;p>悲剧的事情发生了：clash-meta 这玩意解压完近 20MB，你看了下折腾完 shellclash 的路由根分区：只剩不到 8MB，灵机一动，掏出加壳压缩大法 upx，同样，先从官网下载 &lt;a href="https://github.com/upx/upx">https://github.com/upx/upx&lt;/a>&lt;/p>
&lt;p>压缩之：&lt;code>upx -9 clash&lt;/code>，最后 7MB 不到的样子，可以轻松塞进路由，替换掉原有 clash&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">root@XiaoQiang:~# du -sh /data/clash/clash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">6.6M /data/clash/clash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@XiaoQiang:~# file /data/clash/clash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/data/clash/clash: ELF 64-bit LSB executable, ARM aarch64, version &lt;span class="m">1&lt;/span> &lt;span class="o">(&lt;/span>SYSV&lt;span class="o">)&lt;/span>, statically linked, corrupted section header size
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@XiaoQiang:~# /data/clash/clash -v
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Clash Meta alpha-096bb8d linux arm64 with go1.19.5 Mon Jan &lt;span class="m">23&lt;/span> 06:08:40 UTC &lt;span class="m">2023&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>你以为这就完了？naive，默认固件有个地方乱拉屎 &lt;code>/data/usr/log&lt;/code>，莫名其妙就会被 log 文件塞满，导致网络不定时卡顿，所以得弄个任务定时清一波&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">root@XiaoQiang:/data/usr/log# crontab -l
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">*/15 * * * * /usr/sbin/ntpsetclock &lt;span class="m">60&lt;/span> log &amp;gt;/dev/null 2&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#* * * * * /usr/sbin/startscene_crontab.lua `/bin/date &amp;#34;+%u %H:%M&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">0&lt;/span> &lt;span class="m">12&lt;/span> * * * /usr/sbin/recordscene_crontab.lua
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">45&lt;/span> &lt;span class="m">23&lt;/span> * * * /usr/sbin/points_sysset_pro.lua &amp;gt;/dev/null 2&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#*/1 * * * * /usr/sbin/wwdog&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">0&lt;/span> &lt;span class="m">20&lt;/span> * * * /usr/bin/stat_lan
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">0&lt;/span> &lt;span class="m">5&lt;/span> * * &lt;span class="m">3&lt;/span> /etc/init.d/web_filter_record restart &amp;gt;/dev/null 2&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">0&lt;/span> &lt;span class="m">3&lt;/span> * * * /etc/init.d/sysapihttpd restart &amp;gt;/dev/null 2&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">0&lt;/span> 8,19 * * * /usr/sbin/netdig.sh &amp;gt;/dev/null 2&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">*/2 * * * * sh /usr/sbin/xqwhc_push.cron &amp;gt;/dev/null 2&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#*/1 * * * * /sbin/trafficd_cpucheck_wifisync.sh&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">0&lt;/span> &lt;span class="m">3&lt;/span> * * * /usr/sbin/rmportscanresult.sh &amp;gt;/dev/null 2&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">30&lt;/span> &lt;span class="m">3&lt;/span> * * 1~7 /data/clash/start.sh restart &amp;gt;/dev/null 2&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">1&lt;/span> &lt;span class="c1">#每周1~7的3点30分重启clash服务&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">*/3 * * * * rm -rf /data/usr/log/* &lt;span class="c1"># 清垃圾日志&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">*/10 * * * * &lt;span class="nb">test&lt;/span> -n &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>pidof clash&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> /data/clash/start.sh web_save &lt;span class="c1">#每10分钟保存节点配置&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>看着上面这一坨定时任务不禁有想把这玩意刷个原生 openwrt 的冲动，但回想 N 年前折腾 openwrt 孱弱的无线驱动浪费的青春，算了放弃，又不是不能用，要啥自行车。&lt;/p>
&lt;p>One more thing，hysteria 这个协议比较吃 CPU，建议适当限制下行参数以降低路由负载，我一般用 100 mbps 足够用了。&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2023-01-24T01:17:09+08:00
update@2023-01-24T17:19:55+08:00
comment@https://github.com/ferstar/blog/issues/70
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>Ubuntu安装第三方内核后如何使用linux-common-tools</title><link>https://blog.ferstar.org/post/issue-69/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-69/</guid><pubDate>Tue, 24 Jan 2023 01:11:05 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>Ubuntu 有点讨厌，内核相关的包给拆好几个，如果一直官方内核倒也没啥，关键官方内核太老，我一般第一时间就会替换成第三方的内核，比如：https://github.com/xanmod/linux&lt;/p>
&lt;p>但是一旦换成第三方内核，你要使用类似 perf cpupower 这种内核相关命令的时候就会提示下面的错误：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">perf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">WARNING: perf not found &lt;span class="k">for&lt;/span> kernel 6.1.7-x64v3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> You may need to install the following packages &lt;span class="k">for&lt;/span> this specific kernel:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> linux-tools-6.1.7-x64v3-xanmod1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> linux-cloud-tools-6.1.7-x64v3-xanmod1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> You may also want to install one of the following packages to keep up to date:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> linux-tools-xanmod1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> linux-cloud-tools-xanmod1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>缺包，但还贴心的给出了提示，估计是做了一层包装，我们拆开看看：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">~ head -n &lt;span class="m">18&lt;/span> &lt;span class="k">$(&lt;/span>which perf&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#!/bin/bash&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">full_version&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="sb">`&lt;/span>uname -r&lt;span class="sb">`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># First check for a fully qualified version.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">this&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;/usr/lib/linux-tools/&lt;/span>&lt;span class="nv">$full_version&lt;/span>&lt;span class="s2">/`basename &lt;/span>&lt;span class="nv">$0&lt;/span>&lt;span class="s2">`&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> -f &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$this&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exec&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$this&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$@&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Removing flavour from version i.e. generic or server.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">flavour_abi&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">full_version&lt;/span>&lt;span class="p">#*-&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">flavour&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">flavour_abi&lt;/span>&lt;span class="p">#*-&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">version&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">full_version&lt;/span>&lt;span class="p">%-&lt;/span>&lt;span class="nv">$flavour&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">this&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$0&lt;/span>&lt;span class="s2">_&lt;/span>&lt;span class="nv">$version&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> -f &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$this&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exec&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$this&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$@&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>显然是从&lt;code>/usr/lib/linux-tools/$(uname -r)&lt;/code>这个目录里去找&lt;code>perl&lt;/code>了，解决也很简单：&lt;/p>
&lt;ol>
&lt;li>拉内核源码编译perf二进制塞到上面的目录&lt;/li>
&lt;li>因为这种工具代码更新频率很低，所以可以直接从低版本官方内核包中拖出来，丢到上面的目录&lt;/li>
&lt;/ol>
&lt;p>迫于太懒，我肯定选方法二：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mkdir -p /usr/lib/linux-tools/&lt;span class="k">$(&lt;/span>uname -r&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apt download linux-tools-5.19.0-21
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 把deb解压，/./usr/lib/linux-tools-5.19.0-21/ 目录里的文件全拷贝到 /usr/lib/linux-tools/$(uname -r)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>大概的目录结构是这样：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">➜ ~ uname -a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Linux u2004-p13 6.1.7-x64v3-xanmod1 &lt;span class="c1">#0~20230118.a4fbffc SMP PREEMPT_DYNAMIC Wed Jan 18 23:47:06 UTC x86_64 x86_64 x86_64 GNU/Linux&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">➜ ~ tree /usr/lib/linux-tools/6.1.7-x64v3-xanmod1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/usr/lib/linux-tools/6.1.7-x64v3-xanmod1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── acpidbg
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── bpftool
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── cpupower
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── libperf-jvmti.so
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── perf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── turbostat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── usbip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── usbipd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">└── x86_energy_perf_policy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">0&lt;/span> directories, &lt;span class="m">9&lt;/span> files
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>敲个命令试试看：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">➜ ~ cpupower frequency-info
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">analyzing CPU 0:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> driver: acpi-cpufreq
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CPUs which run at the same hardware frequency: &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CPUs which need to have their frequency coordinated by software: &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> maximum transition latency: Cannot determine or is not supported.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> hardware limits: 1.40 GHz - 1.80 GHz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> available frequency steps: 1.80 GHz, 1.70 GHz, 1.40 GHz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> available cpufreq governors: conservative ondemand userspace powersave performance schedutil
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> current policy: frequency should be within 1.40 GHz and 1.80 GHz.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> The governor &lt;span class="s2">&amp;#34;performance&amp;#34;&lt;/span> may decide which speed to use
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> within this range.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> current CPU frequency: Unable to call hardware
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> current CPU frequency: 1.90 GHz &lt;span class="o">(&lt;/span>asserted by call to kernel&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> boost state support:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Supported: yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Active: no
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>完美，后续内核有更新的话，只需要重命名一下 /usr/lib/linux-tools/$(uname -r) 即可&lt;/p>
&lt;p>有关的几个issue:&lt;/p>
&lt;ol>
&lt;li>&lt;a href="https://github.com/xanmod/linux/issues/94">https://github.com/xanmod/linux/issues/94&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/xanmod/linux/issues/121">https://github.com/xanmod/linux/issues/121&lt;/a>&lt;/li>
&lt;/ol>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2023-01-24T01:11:05+08:00
update@2023-01-24T16:51:52+08:00
comment@https://github.com/ferstar/blog/issues/69
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>更换Manjaro默认坑爹的grub</title><link>https://blog.ferstar.org/post/issue-68/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-68/</guid><pubDate>Tue, 24 Jan 2023 00:57:55 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>前阵子换了个新电脑，重装是不可能的，于是拷一份老机的数据到新机，具体过程不表，基本就是 &lt;a href="https://blog.ferstar.org/post/issue-32/">#32&lt;/a> 说的那套。&lt;/p>
&lt;p>搞完发现系统么发启动，具体报错忘了，大概就是找不到启动配置的意思，这种一般就是grub的问题，于是进&lt;code>/boot/efi&lt;/code>瞧一瞧：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /boot/efi/EFI/manjaro
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">strings grubx64.efi &lt;span class="p">|&lt;/span> grep gpt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 以下为输出&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">partmap/gpt.c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">part_gpt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">grub_gpt_partition_map_iterate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>,gpt5&lt;span class="o">)&lt;/span>/@/boot/grub
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>好家伙，这里把grub入口写死了，我旧盘root在gpt5，但新盘是gpt2，咋玩呢？一种方法是搞个Manjaro的rescure镜像，从镜像chroot进去给重装一下grub，见：https://wiki.manjaro.org/index.php/UEFI_-_Install_Guide&lt;/p>
&lt;p>鉴于对这种写死做法的鄙夷，我决定换一种优雅的解决办法：&lt;/p>
&lt;p>&lt;del>随便找了个 Ubuntu 的 Server 镜像，从里面把 /efi/{Boot,ubuntu} 一起拷贝出来&lt;/del>&lt;/p>
&lt;p>&lt;del>把 /boot/efi/EFI/Boot/bootx64.efi 用 Ubuntu 的替换掉&lt;/del>&lt;/p>
&lt;p>其实完全可以用&lt;code>grub-mkimage&lt;/code>这个工具来自定义生成一个个性的efi文件：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">grub-mkimage -o bootx64.efi -O x86_64-efi -p /EFI/helloworld ntfs hfs appleldr &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> boot cat efi_gop efi_uga elf fat hfsplus iso9660 linux keylayouts memdisk &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> minicmd part_apple ext2 extcmd xfs xnu part_bsd part_gpt search &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> search_fs_file chain btrfs loadbios loadenv lvm minix minix2 reiserfs &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> memrw mmap msdospart scsi loopback normal configfile gzio all_video efi_gop &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> efi_uga gfxterm gettext &lt;span class="nb">echo&lt;/span> boot chain &lt;span class="nb">eval&lt;/span> ls &lt;span class="nb">test&lt;/span> sleep png gfxmenu part_msdos
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>把 /boot/efi/EFI/ubuntu 复制过去，修改一下 grub.cfg 里面的 uuid 指向新盘 root 分区的 uuid 即可&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">search.fs_uuid f622fc86-161c-42dc-9a19-9c3c756d6ced root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">set&lt;/span> &lt;span class="nv">prefix&lt;/span>&lt;span class="o">=(&lt;/span>&lt;span class="nv">$root&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="s1">&amp;#39;/@/boot/grub&amp;#39;&lt;/span> &lt;span class="c1"># 这里我用的是 btrfs 子卷 @ 作为 rootfs&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">configfile &lt;span class="nv">$prefix&lt;/span>/grub.cfg
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>可以看一下 Ubuntu 这个 grubx64.efi 的部分内容 &lt;code>strings grubx64.efi | grep cfg&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">%s/grub.cfg
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">feature_net_search_cfg
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>引导路径是这样的：EFI -&amp;gt; Boot -&amp;gt; bootx64.efi -&amp;gt; grubx64.efi -&amp;gt; grub.cfg -&amp;gt; rootfs/grub.cfg -&amp;gt; boot，比 Manjaro 多了按配置查找 grub.cfg 的这一步，我觉得很赞。&lt;/p>
&lt;p>当然这个方式有个小瑕疵：如果你用类似 refind 这种 boot manager 的话，会发现启动 Manjaro 的启动图标变成了 Ubuntu，明显这玩意是靠 /boot/efi/EFI/xxx 来判断目标OS的，对于我这种 N 久不关机的人来说，可以忽略不计。&lt;/p>
&lt;p>强迫症患者可以在正常进入 Manjaro 以后自行重装 grub，然后删除 /boot/efi/EFI/ubuntu 即可。&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2023-01-24T00:57:55+08:00
update@2023-02-09T15:16:17+08:00
comment@https://github.com/ferstar/blog/issues/68
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>Ubuntu升级openssl到3.x以后旧应用的处理</title><link>https://blog.ferstar.org/post/issue-67/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-67/</guid><pubDate>Fri, 09 Dec 2022 06:22:11 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>注意：Manjaro/Arch 里这个包叫 &lt;code>openssl-1.1&lt;/code> 不小心卸载了的话，得装回来。&lt;/p>
&lt;/blockquote>
&lt;p>最近把Ubuntu更新到22.10，发现openssl已经到3.x了，之前万年1.1.1包居然默认被删掉，这就导致一个问题：之前基于这玩意的很多包如果没有及时做兼容的话，大概率是不能用的，如utools：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl"> JavaScript error occurred in the main process
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Uncaught Exception:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Error: libcrypto.so.1.1: cannot open shared object file: No such file or directory
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> at process.func &lt;span class="o">[&lt;/span>as dlopen&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>node:electron/js2c/asar_bundle:5:1812&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> at Module._extensions..node &lt;span class="o">(&lt;/span>node:internal/modules/cjs/loader:1205:18&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> at Object.func &lt;span class="o">[&lt;/span>as .node&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>node:electron/js2c/asar_bundle:5:2039&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> at Module.load &lt;span class="o">(&lt;/span>node:internal/modules/cjs/loader:988:32&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> at Module._load &lt;span class="o">(&lt;/span>node:internal/modules/cjs/loader:829:12&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> at c._load &lt;span class="o">(&lt;/span>node:electron/js2c/asar_bundle:5:13343&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> at Module.require &lt;span class="o">(&lt;/span>node:internal/modules/cjs/loader:1012:19&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> at require &lt;span class="o">(&lt;/span>node:internal/modules/cjs/helpers:102:18&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> at Object.&amp;lt;anonymous&amp;gt; &lt;span class="o">(&lt;/span>/opt/uTools/resources/app.asar/node_modules/addon/index.js:18:62&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> at Module._compile &lt;span class="o">(&lt;/span>node:internal/modules/cjs/loader:1120:14&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Gtk-Message: 14:00:48.050: Failed to load module &lt;span class="s2">&amp;#34;xapp-gtk3-module&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>本来我是想省事把3.x的so软链接过去，好家伙还不兼容，没办法只好从低版本Ubuntu里拖个1.1.x的openssl应应急了。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">wget http://nz2.archive.ubuntu.com/ubuntu/pool/main/o/openssl/libssl1.1_1.1.1f-1ubuntu2.16_amd64.deb -O /tmp/ssl.deb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo dpkg -i /tmp/ssl.deb
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>搞定&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2022-12-09T06:22:11+08:00
update@2023-01-24T17:24:02+08:00
comment@https://github.com/ferstar/blog/issues/67
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>再说点梯子的事情</title><link>https://blog.ferstar.org/post/issue-66/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-66/</guid><pubDate>Mon, 14 Nov 2022 00:39:53 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>被我放弃的甲骨文坡县小机居然坚挺了大半年之久，于是又废物利用，试用了一下最近风头正盛的几个小众的梯子。&lt;/p>
&lt;p>从跑带宽测速来排位：Hysteria &amp;gt; tuic &amp;gt; naiveproxy
从抗封锁来排位：naiveproxy &amp;gt; Hysteria/tuic
从性能表现来说：tuic &amp;gt; naiveproxy &amp;gt; Hysteria&lt;/p>
&lt;p>总体看未来爬墙梯应该会是 quic 的天下，一众 tcp 方案可休矣&lt;/p>
&lt;ul>
&lt;li>Hysteria 这玩意其实他一出来我就在用了，目前绝对主力&lt;/li>
&lt;li>tuic&lt;/li>
&lt;li>naiveproxy&lt;/li>
&lt;/ul>
&lt;p>配置这玩意其实没什么好讲的，自然 Docker 一把梭哈&lt;/p>
&lt;p>这是 naiveproxy + filebrowser 的一个组合&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;3&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">services&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">caddy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">restart&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">unless-stopped&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">container_name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">caddy&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">kwaabot/caddy&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;80:80&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;443:443&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;443:443/udp&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;./naiveproxy:/etc/caddy&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># State data will be stored in this directory&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;/home/ubuntu/.local/share/caddy:/root/.local/share/caddy&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Required for tailscale to work&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">sysctls&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">net.ipv4.tcp_congestion_control=bbr&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">filebrowser&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">restart&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">unless-stopped&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">container_name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">filebrowser&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">filebrowser/filebrowser&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;./filebrowser/srv:/srv&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># State data will be stored in this directory&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;./filebrowser/database.db:/database.db&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># State data will be stored in this directory&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;./filebrowser/.filebrowser.json:/.filebrowser.json&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># State data will be stored in this directory&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;/etc/timezone:/etc/timezone:ro&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;/etc/localtime:/etc/localtime:ro&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ cat filebrowser/.filebrowser.json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;port&amp;#34;&lt;/span>: 80,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;locale&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;zh-cn&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;baseURL&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;address&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;log&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;stdout&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;database&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;/database.db&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;root&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;/srv&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ cat naiveproxy/Caddyfile
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> order forward_proxy before reverse_proxy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">:443, play.ferstar.org
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tls fer_star@qq.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> forward_proxy &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> basic_auth username password
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> hide_ip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> hide_via
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> probe_resistance
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> reverse_proxy filebrowser:80
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>再来个 hysteria 的&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">sudo docker run -td --name hysteria -p 8443:443/udp -v /home/ubuntu/myprojects/hysteria/config.json:/etc/config.json -v /home/ubuntu/.local/share/caddy/certificates/acme-v02.api.letsencrypt.org-directory/:/etc/hysteria/ --sysctl net.ipv4.tcp_congestion_control&lt;span class="o">=&lt;/span>bbr --restart unless-stopped tobyxdd/hysteria -config /etc/config.json server --log-level&lt;span class="o">=&lt;/span>panic
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>tuic:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>Unit&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">After&lt;/span>&lt;span class="o">=&lt;/span>network.target
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>Service&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">User&lt;/span>&lt;span class="o">=&lt;/span>tuic
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">CapabilityBoundingSet&lt;/span>&lt;span class="o">=&lt;/span>CAP_NET_BIND_SERVICE CAP_NET_RAW
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">AmbientCapabilities&lt;/span>&lt;span class="o">=&lt;/span>CAP_NET_BIND_SERVICE CAP_NET_RAW
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">NoNewPrivileges&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">WorkingDirectory&lt;/span>&lt;span class="o">=&lt;/span>/etc/tuic
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#Environment=HYSTERIA_LOG_LEVEL=info&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">ExecStart&lt;/span>&lt;span class="o">=&lt;/span>/usr/local/bin/tuic -c /etc/tuic/config.json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">Restart&lt;/span>&lt;span class="o">=&lt;/span>on-failure
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">RestartPreventExitStatus&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">RestartSec&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>Install&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">WantedBy&lt;/span>&lt;span class="o">=&lt;/span>multi-user.target
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2022-11-14T00:39:53+08:00
update@2023-01-04T13:03:12+08:00
comment@https://github.com/ferstar/blog/issues/66
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/docker/">DOCKER</category><category domain="https://blog.ferstar.org/tags/android/">Android</category></item><item><title>黑苹果显示电池建议维修的一个解决方法</title><link>https://blog.ferstar.org/post/issue-65/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-65/</guid><pubDate>Fri, 11 Nov 2022 02:11:54 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>装黑苹果用了三年多的小新pro13电池终于不行了，提示“电池建议维修”&lt;/p>
&lt;p>&lt;img src="https://user-images.githubusercontent.com/2854276/201245551-5ab8aa61-6a5f-4532-999e-d19d070b813c.png" alt="image">&lt;/p>
&lt;p>于是跑Windows下看了一眼电池健康度，已经掉到73%了，于是某宝一百来块购入电池一块，拆机换之，发现原电池已经鼓包，再不换可能就有boom的风险&lt;/p>
&lt;p>一顿操作之后，进macOS一看，卧槽居然还提示“电池建议维修”，乱搜一通什么清NVRAM、换SMCBatteryManager驱动等等办法都没效果，忽然想到可能跟电池序列号有关，因为这款机器黑苹果的人很多，也许电池id会在苹果爹地的数据库里有健康度的绑定，所以就尝试修改电池序列号，果然换完就正常了&lt;/p>
&lt;p>&lt;img src="https://user-images.githubusercontent.com/2854276/201246112-702e1df5-0ea0-4f93-a9a6-83d70eb8f320.png" alt="image">&lt;/p>
&lt;p>下面简单说一下修改电池序列号的方法：&lt;/p>
&lt;ul>
&lt;li>About This Mac -&amp;gt; System Information -&amp;gt; Power -&amp;gt; Serial Number 记下你现在的电池序列号，小新的话默认应该是&lt;code>123456789&lt;/code>&lt;/li>
&lt;li>工具：&lt;a href="https://github.com/acidanthera/MaciASL">MaciASL&lt;/a>&lt;/li>
&lt;li>挂载EFI分区，打开SSDT-BATS-PRO13.aml文件&lt;/li>
&lt;li>查找上面记下的序列号&lt;code>123456789&lt;/code>，替换成任意你喜欢的数字组合，最好保证长度一致&lt;/li>
&lt;li>改完点保存&lt;/li>
&lt;li>重启电脑，电池维修的提示就没有了&lt;/li>
&lt;/ul>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2022-11-11T02:11:54+08:00
update@2022-11-11T02:15:58+08:00
comment@https://github.com/ferstar/blog/issues/65
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/macos/">macOS</category></item><item><title>指定第三方工具加速下载AUR包</title><link>https://blog.ferstar.org/post/issue-64/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-64/</guid><pubDate>Tue, 31 May 2022 07:35:23 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>众所周知的原因，一些位于github上的AUR包不挂梯子默认是很难直接下载成功的，哪怕仅仅就几百KB。简单搜了下网友的解决方案，自己糊了个脚本，基本满足需求&lt;/p>
&lt;/blockquote>
&lt;ol>
&lt;li>修改&lt;code>/etc/makepkg.conf&lt;/code>，将pacman默认下载工具指向自己写的脚本&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># DLAGENTS=(&amp;#39;file::/usr/bin/curl -qgC - -o %o %u&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># &amp;#39;ftp::/usr/bin/curl -qgfC - --ftp-pasv --retry 3 --retry-delay 3 -o %o %u&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># &amp;#39;http::/usr/bin/curl -qgb &amp;#34;&amp;#34; -fLC - --retry 3 --retry-delay 3 -o %o %u&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># &amp;#39;https::/usr/bin/curl -qgb &amp;#34;&amp;#34; -fLC - --retry 3 --retry-delay 3 -o %o %u&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># &amp;#39;rsync::/usr/bin/rsync --no-motd -z %u %o&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># &amp;#39;scp::/usr/bin/scp -C %u %o&amp;#39;)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">DLAGENTS&lt;/span>&lt;span class="o">=(&lt;/span>&lt;span class="s1">&amp;#39;file::/home/ferstar/.local/bin/lftp_wrapper.sh %u %o&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;ftp::/home/ferstar/.local/bin/lftp_wrapper.sh %u %o&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;http::/home/ferstar/.local/bin/lftp_wrapper.sh %u %o&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;https::/home/ferstar/.local/bin/lftp_wrapper.sh %u %o&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;rsync::/usr/bin/rsync --no-motd -z %u %o&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;scp::/usr/bin/scp -C %u %o&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>/etc/pacman.conf&lt;/code>这里也改一下&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#XferCommand = /usr/bin/wget --passive-ftp -c -O %o %u&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">XferCommand&lt;/span> &lt;span class="o">=&lt;/span> /home/ferstar/.local/bin/lftp_wrapper.sh %u %o
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="2">
&lt;li>写脚本处理URL&amp;amp;调起第三方下载工具下载文件&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/usr/bin/env bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">LFTP_BIN&lt;/span>&lt;span class="o">=&lt;/span>/usr/bin/lftp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">AXEL_BIN&lt;/span>&lt;span class="o">=&lt;/span>/usr/bin/axel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">USER_AGENT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">PROCESS_COUNT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(($(&lt;/span>nproc&lt;span class="k">)&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="k">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">URL&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">OUT_PATH&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># check if http or https proxy is set&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> -n &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$http_proxy&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">PROXY&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$http_proxy&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">elif&lt;/span> &lt;span class="o">[&lt;/span> -n &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$https_proxy&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">PROXY&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$https_proxy&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">PROXY&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> -z &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$PROXY&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># replace &amp;#34;github.com&amp;#34; with &amp;#34;hub.fastgit.xyz&amp;#34; mirror&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">URL&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">URL&lt;/span>&lt;span class="p">//github.com/hub.fastgit.xyz&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># replace &amp;#34;raw.githubusercontent.com&amp;#34; with &amp;#34;raw.fastgit.org&amp;#34; mirror&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">URL&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">URL&lt;/span>&lt;span class="p">//raw.githubusercontent.com/raw.fastgit.org&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$LFTP_BIN&lt;/span> -e &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> &lt;span class="s2">&amp;#34;set ssl:verify-certificate false;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> set net:idle 10;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> set net:max-retries 3;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> set net:reconnect-interval-base 3;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> set net:reconnect-interval-max 3;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> set http:user-agent &amp;#39;&lt;/span>&lt;span class="nv">$USER_AGENT&lt;/span>&lt;span class="s2">&amp;#39;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> pget -n &lt;/span>&lt;span class="nv">$PROCESS_COUNT&lt;/span>&lt;span class="s2"> -c &lt;/span>&lt;span class="nv">$URL&lt;/span>&lt;span class="s2"> -o &lt;/span>&lt;span class="nv">$OUT_PATH&lt;/span>&lt;span class="s2">;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> quit;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># $AXEL_BIN --max-redirect=3 -n $PROCESS_COUNT -a -k -U &amp;#34;$USER_AGENT&amp;#34; $URL -o $OUT_PATH&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>脚本里用到的&lt;code>lftp&lt;/code>和&lt;code>axel&lt;/code>都需要单独安装，实测网络实在垃圾的情况下，&lt;code>lftp&lt;/code>比&lt;code>axel&lt;/code>要靠谱一些，基本上不会失败；但网络还可以的话，大部分情况&lt;code>axel&lt;/code>是要快一倍左右，平均&lt;code>2MB/s&lt;/code>上下的速度，基本也够用了。&lt;/p>
&lt;hr>
&lt;blockquote>
&lt;p>参考&lt;/p>
&lt;/blockquote>
&lt;p>&lt;a href="https://zhuanlan.zhihu.com/p/176987140">机智的解决arch/manjaro安装AUR软件时github下载软件包慢或不可获得的问题&lt;/a>&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2022-05-31T07:35:23+08:00
update@2022-09-08T06:02:16+08:00
comment@https://github.com/ferstar/blog/issues/64
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>利用memray重构项目，提升内存利用效率</title><link>https://blog.ferstar.org/post/issue-63/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-63/</guid><pubDate>Wed, 25 May 2022 08:13:58 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>人生苦短，快用&lt;code>memray&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>不知不觉距离上次大的重构 #43 已经过去一年多，不曾想冷启动时间又肉眼可见的慢了起来，坚决不能忍，搞起&lt;/p>
&lt;/blockquote>
&lt;p>因为是某个炼丹项目的配套，代码有好几个人的参与。工程这边还好，组内有明确的 lint 规则以及一直坚持的 codereview，代码质量基本可控；但炼丹组的代码就显得很飘逸了，一些暗坑往往出现在这部分。炼丹我是不懂的，咋搞？上工具呗&lt;/p>
&lt;p>这次使用的是：&lt;a href="https://github.com/bloomberg/memray">memray&lt;/a>，官网介绍很全面了，工具使用起来也是非常简单，我就用了两句&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">memray run hello.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">memray flamegraph memray-hello.py.xxx.bin
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>几行用来测试的代码&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">torch&lt;/span> &lt;span class="c1"># 实际项目的引用关系要复杂得多&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">do_ai_pipe&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">torch&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">__version__&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="vm">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;hello world!&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>跑出来的火焰图是这样的&lt;/p>
&lt;img width="803" alt="image" src="https://user-images.githubusercontent.com/2854276/172029253-cd00d6cd-f287-4a86-80de-f237e7976455.png">
&lt;p>好家伙，我跑个 hello world 就干掉三十来兆内存，明显是&lt;code>import torch&lt;/code>搞的鬼，果断改一下&lt;code>import&lt;/code>位置&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">do_ai_pipe&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 可能有人会有疑问：改成 local import 的话，岂不是每次调用方法都要重复 import 一次，这多浪费&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 先说答案：不会，因为 import 是有全局缓存的，第二次 import 直接从缓存里取了&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">import&lt;/span> &lt;span class="nn">torch&lt;/span> &lt;span class="c1"># 实际项目的引用关系要复杂得多&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">torch&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">__version__&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="vm">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;hello world!&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>再跑个图&lt;/p>
&lt;img width="802" alt="image" src="https://user-images.githubusercontent.com/2854276/172029321-3f2e33d4-ed06-4436-bbf7-a0396919df01.png">
&lt;p>可以看到内存骤降至 KB 级别，代码几乎是不需要做什么改动的。&lt;/p>
&lt;p>当然这只是一个简单的例子：某些情况下一些方法引用了一个比较重的依赖，那么就可以考虑把这个重依赖从&lt;code>global import&lt;/code>改为&lt;code>local import&lt;/code>，可以极大降低项目整体启动的时间和内存占用。&lt;/p>
&lt;p>借助&lt;code>memray&lt;/code>可以清晰直观地展现出项目所有调用的内存使用情况，你可以很快定位到最需要优化的&lt;code>func&lt;/code>，然后根据实际需要，稍微做一点调整，即可获得不错的性能收益。&lt;/p>
&lt;p>算个收益账：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>支出：2.5 小时，基本就是 按照&lt;code>memray&lt;/code>的指示，把该延迟引用的延迟引用，能惰性求值的换成惰性求值，不必要的初始化状态丢到对应实例化方法中，等等&lt;/p>
&lt;/li>
&lt;li>
&lt;p>收益：未优化前启动需要 &lt;code>3.5~5&lt;/code>s 左右按 4s 算，优化后仅 &lt;code>0.8~1.2&lt;/code>s按 1s 算，按开发一天调试启停项目 500 次计算，每天节省 500 * 3s / 60 = 25min 相当于一个番茄钟的时间&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>算起来 6 个工作日即可回本，这买卖很划算。&lt;/p>
&lt;p>甩个实际成果：项目冷启动内存占用减半，速度提升了2~3倍。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">yyyy-mm-dd HH:18:28,729 - &lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>MainThread&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>server:27&lt;span class="o">)&lt;/span> starting remarkable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yyyy-mm-dd HH:18:28,729 - &lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>MainThread&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>base_handler:54&lt;span class="o">)&lt;/span> loading web handlers
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yyyy-mm-dd HH:18:29,661 - &lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>MainThread&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>file_utils:41&lt;span class="o">)&lt;/span> PyTorch version 1.4.0 available.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yyyy-mm-dd HH:18:31,789 - &lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>MainThread&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>base_handler:79&lt;span class="o">)&lt;/span> /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yyyy-mm-dd HH:18:31,806 - &lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>MainThread&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>server:89&lt;span class="o">)&lt;/span> Server started...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yyyy-mm-dd HH:18:31,806 - &lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>MainThread&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>server:90&lt;span class="o">)&lt;/span> the web server is listening on http://0.0.0.0:8000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yyyy-mm-dd HH:20:06,448 - &lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>MainThread&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>server:27&lt;span class="o">)&lt;/span> starting remarkable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yyyy-mm-dd HH:20:06,448 - &lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>MainThread&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>base_handler:54&lt;span class="o">)&lt;/span> loading web handlers
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yyyy-mm-dd HH:20:06,495 - &lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>MainThread&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>base_handler:64&lt;span class="o">)&lt;/span> loading plugins
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yyyy-mm-dd HH:20:07,615 - &lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>MainThread&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>base_handler:79&lt;span class="o">)&lt;/span> /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yyyy-mm-dd HH:20:07,631 - &lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>MainThread&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>server:89&lt;span class="o">)&lt;/span> Server started...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yyyy-mm-dd HH:20:07,631 - &lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>MainThread&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>server:90&lt;span class="o">)&lt;/span> the web server is listening on http://0.0.0.0:8000
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2022-05-25T08:13:58+08:00
update@2022-06-05T00:28:06+08:00
comment@https://github.com/ferstar/blog/issues/63
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>利用msgspec加速大json文件反序列化速度</title><link>https://blog.ferstar.org/post/issue-62/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-62/</guid><pubDate>Wed, 25 May 2022 08:12:46 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>一个库的命运啊，当然要靠自我奋斗，但是也要考虑到项目的实际需求，有舍才有得。&lt;/p>
&lt;/blockquote>
&lt;p>内部项目有一个基础依赖的结果「下文简述为 origin.json.gz」是&lt;code>json.dump&lt;/code>然后压缩成&lt;code>gz&lt;/code>文件存储的，下游引用的时候有个头大的问题就是这玩意太大了，动辄百兆级别，一般的&lt;code>json.load&lt;/code>就很慢，于是就一直在寻找可用的性能更为优秀的方法来替换掉内置&lt;code>json&lt;/code>处理，至少期望是&lt;code>load&lt;/code>快一些。&lt;/p>
&lt;p>先后尝试过不同的&lt;code>json&lt;/code>库，包括不限于以下选手：&lt;code>orjson/ujson/rapidjson/simplejson&lt;/code>，基本的对比效果就是：序列化各种吊打内置库，但反序列化基本上没啥太大的优势，直到有一天老板甩了个分享链接：&lt;a href="https://pythonspeed.com/articles/faster-python-json-parsing/">Faster, more memory-efficient Python JSON parsing with msgspec (pythonspeed.com)&lt;/a>&lt;/p>
&lt;p>发现&lt;code>msgspec&lt;/code>这玩意简直强的离谱：提前定义好&lt;code>struct&lt;/code>然后按需&lt;code>streaming&lt;/code>加载的思路性能极佳且内存极度友好。&lt;/p>
&lt;p>简单说明一下这个&lt;code>origin.json.gz&lt;/code>的大致结构：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;A&amp;#34;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">...&lt;/span>&lt;span class="nx">一堆子子孙孙&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;B&amp;#34;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">...&lt;/span>&lt;span class="nx">二堆子子孙孙&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Z&amp;#34;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;ZA&amp;#34;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">...&lt;/span>&lt;span class="nx">aaa&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;ZB&amp;#34;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">...&lt;/span>&lt;span class="nx">bbb&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;ZZ&amp;#34;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">...&lt;/span>&lt;span class="nx">zzz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>某个下游引用的场景是：需要&lt;code>origin.json.gz&lt;/code>里的某个节点的部分信息来做一些二次处理的事情。以往的操作不管如何先&lt;code>load&lt;/code>一把，实在浪费资源。如果用&lt;code>msgspec&lt;/code>来处理，是这样的姿势：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">gzip&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">msgspec.json&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">decode&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">msgspec&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">Struct&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;...path...of...origin...json...gz...&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Z&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Struct&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ZZ&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nb">dict&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Item&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Struct&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Z&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">Dict&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nb">str&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ZZ&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">with&lt;/span> &lt;span class="n">gzip&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;rb&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">fp&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 可以看到我只需要定义自己关心的节点链路即可，其他用不到的数据完全可以忽略不写&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 这种读取方式必然是内存友好型了&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">data&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nb">type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">Item&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="n">item&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">data&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Z&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>代码量看起来是比以前一把梭哈&lt;code>json.load&lt;/code>多了一点，但收益巨大：同样的硬件条件，使用&lt;code>msgspec.decode&lt;/code>快了近一个数量级。&lt;/p>
&lt;p>虽然没有去翻源码去看具体实现，但二进制的世界没有魔法，无非就是在玩时间空间的把戏。&lt;code>msgspec.decode&lt;/code>的快源于两点：&lt;/p>
&lt;ol>
&lt;li>预定义了数据类型，他的核心解析器可以节省大量不必要的类型判断&lt;/li>
&lt;li>按需定义，忽略不必要的数据&lt;/li>
&lt;/ol>
&lt;p>这就是一个&lt;strong>空间换时间&lt;/strong>的玩法，&lt;strong>按需加载&lt;/strong>显著降低了需要处理的数据量，自然性能就上来了。&lt;/p>
&lt;p>这时候来了个成年人说我都要行不行？很遗憾，不行。在预定义了所有节点的数据结构「去掉&lt;strong>按需加载&lt;/strong>的 buff」以后，&lt;code>msgspec.decode&lt;/code>的速度甚至比内置&lt;code>json&lt;/code>还慢 20% （基于一坨 400MB 大小的&lt;code>origin.json&lt;/code>测试所得），&lt;code>object&lt;/code>显然要比&lt;code>dict&lt;/code>慢上一拍的。&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2022-05-25T08:12:46+08:00
update@2022-06-04T23:18:21+08:00
comment@https://github.com/ferstar/blog/issues/62
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>Fcitx不停往xxxtmp.log写入日志的治标方法</title><link>https://blog.ferstar.org/post/issue-61/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-61/</guid><pubDate>Wed, 25 May 2022 08:09:52 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>偶然发现&lt;code>/tmp/xxxtmp.log&lt;/code>会不停的写入一些日志，于是就想搞清楚是谁干的&lt;/p>
&lt;/blockquote>
&lt;p>用&lt;em>auditctl&lt;/em>监听一下文件状态： &lt;a href="https://serverfault.com/a/320718">https://serverfault.com/a/320718&lt;/a> 发现是&lt;code>Fcitx&lt;/code>干的&lt;/p>
&lt;p>日志大概是这样子&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">time-&amp;gt;Tue May &lt;span class="m">24&lt;/span> 14:33:12 &lt;span class="m">2022&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">type&lt;/span>&lt;span class="o">=&lt;/span>PROCTITLE &lt;span class="nv">msg&lt;/span>&lt;span class="o">=&lt;/span>audit&lt;span class="o">(&lt;/span>1653373992.503:379&lt;span class="o">)&lt;/span>: &lt;span class="nv">proctitle&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;fcitx&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">type&lt;/span>&lt;span class="o">=&lt;/span>PATH &lt;span class="nv">msg&lt;/span>&lt;span class="o">=&lt;/span>audit&lt;span class="o">(&lt;/span>1653373992.503:379&lt;span class="o">)&lt;/span>: &lt;span class="nv">item&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span> &lt;span class="nv">name&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;/tmp/xxxtmp.log&amp;#34;&lt;/span> &lt;span class="nv">inode&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">4469&lt;/span> &lt;span class="nv">dev&lt;/span>&lt;span class="o">=&lt;/span>00:23 &lt;span class="nv">mode&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0100644&lt;/span> &lt;span class="nv">ouid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1000&lt;/span> &lt;span class="nv">ogid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1001&lt;/span> &lt;span class="nv">rdev&lt;/span>&lt;span class="o">=&lt;/span>00:00 &lt;span class="nv">nametype&lt;/span>&lt;span class="o">=&lt;/span>NORMAL &lt;span class="nv">cap_fp&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">cap_fi&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">cap_fe&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">cap_fver&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">cap_frootid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">type&lt;/span>&lt;span class="o">=&lt;/span>PATH &lt;span class="nv">msg&lt;/span>&lt;span class="o">=&lt;/span>audit&lt;span class="o">(&lt;/span>1653373992.503:379&lt;span class="o">)&lt;/span>: &lt;span class="nv">item&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">name&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;/tmp/&amp;#34;&lt;/span> &lt;span class="nv">inode&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span> &lt;span class="nv">dev&lt;/span>&lt;span class="o">=&lt;/span>00:23 &lt;span class="nv">mode&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">041777&lt;/span> &lt;span class="nv">ouid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">ogid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">rdev&lt;/span>&lt;span class="o">=&lt;/span>00:00 &lt;span class="nv">nametype&lt;/span>&lt;span class="o">=&lt;/span>PARENT &lt;span class="nv">cap_fp&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">cap_fi&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">cap_fe&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">cap_fver&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="nv">cap_frootid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">type&lt;/span>&lt;span class="o">=&lt;/span>CWD &lt;span class="nv">msg&lt;/span>&lt;span class="o">=&lt;/span>audit&lt;span class="o">(&lt;/span>1653373992.503:379&lt;span class="o">)&lt;/span>: &lt;span class="nv">cwd&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;/dev/mqueue&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">type&lt;/span>&lt;span class="o">=&lt;/span>SYSCALL &lt;span class="nv">msg&lt;/span>&lt;span class="o">=&lt;/span>audit&lt;span class="o">(&lt;/span>1653373992.503:379&lt;span class="o">)&lt;/span>: &lt;span class="nv">arch&lt;/span>&lt;span class="o">=&lt;/span>c000003e &lt;span class="nv">syscall&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">257&lt;/span> &lt;span class="nv">success&lt;/span>&lt;span class="o">=&lt;/span>yes &lt;span class="nv">exit&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">15&lt;/span> &lt;span class="nv">a0&lt;/span>&lt;span class="o">=&lt;/span>ffffff9c &lt;span class="nv">a1&lt;/span>&lt;span class="o">=&lt;/span>7f0bd1206b4b &lt;span class="nv">a2&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">442&lt;/span> &lt;span class="nv">a3&lt;/span>&lt;span class="o">=&lt;/span>1b6 &lt;span class="nv">items&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">2&lt;/span> &lt;span class="nv">ppid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span> &lt;span class="nv">pid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1720&lt;/span> &lt;span class="nv">auid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1000&lt;/span> &lt;span class="nv">uid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1000&lt;/span> &lt;span class="nv">gid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1001&lt;/span> &lt;span class="nv">euid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1000&lt;/span> &lt;span class="nv">suid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1000&lt;/span> &lt;span class="nv">fsuid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1000&lt;/span> &lt;span class="nv">egid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1001&lt;/span> &lt;span class="nv">sgid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1001&lt;/span> &lt;span class="nv">fsgid&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1001&lt;/span> &lt;span class="nv">tty&lt;/span>&lt;span class="o">=(&lt;/span>none&lt;span class="o">)&lt;/span> &lt;span class="nv">ses&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span> &lt;span class="nv">comm&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;fcitx&amp;#34;&lt;/span> &lt;span class="nv">exe&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;/usr/bin/fcitx&amp;#34;&lt;/span> &lt;span class="nv">subj&lt;/span>&lt;span class="o">==&lt;/span>unconfined &lt;span class="nv">key&lt;/span>&lt;span class="o">=(&lt;/span>null&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>翻了下GitHub发现是陈年老bug，治本是不太可能了，只能治标：把这玩意输出重定向到宇宙黑洞：&lt;code>/dev/null&lt;/code>&lt;/p>
&lt;p>说干就干，先删源文件：&lt;code>rm /tmp/xxxtmp.log&lt;/code>&lt;/p>
&lt;p>然后软链接到黑洞：&lt;code>ln -s /dev/null /tmp/xxxtmp.log&lt;/code>&lt;/p>
&lt;p>大功告成！等等，这玩意下次重启还会恢复原样，当然可以搞个启动脚本简单处理，但是本着逼格无限的折腾精神，我找到了&lt;code>logrotate&lt;/code>：定时根据定义配置来rotate指定的文件，还可以定义post hooks命令，就是你了杰尼龟：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">~ cat /etc/logrotate.d/xxxtmp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/tmp/xxxtmp.log &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> su ferstar ferstar
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> daily
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nocreate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> rotate &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> missingok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> size 1k
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> postrotate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ln -s /dev/null /tmp/xxxtmp.log
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> endscript
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>嗯，就这么几行搞定，你fcitx dbus爱写入啥垃圾无所谓了，眼不见心不烦&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2022-05-25T08:09:52+08:00
update@2022-05-25T08:10:27+08:00
comment@https://github.com/ferstar/blog/issues/61
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>不死小强——timeshift+btrfs-grub</title><link>https://blog.ferstar.org/post/issue-60/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-60/</guid><pubDate>Sun, 01 May 2022 14:04:25 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>以下几个组合可以达到这样的一个效果: 系统自动快照, 同时快照会自动添加到开机启动项, 机器从此变身不死小强&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>BTRFS 文件系统&lt;/li>
&lt;li>TimeShift&lt;/li>
&lt;li>btrfs-grub&lt;/li>
&lt;/ul>
&lt;p>我的挂载信息：&lt;/p>
&lt;blockquote>
&lt;p>可以看到我把 cache log docker 等划分了单独的 subvolume，同时启用了 zstd 压缩等特性&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl"> ~ cat /etc/fstab
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># /etc/fstab: static file system information.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Use &amp;#39;blkid&amp;#39; to print the universally unique identifier for a&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># device; this may be used with UUID= as a more robust way to name devices&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># that works even if disks are added and removed. See fstab(5).&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># &amp;lt;file system&amp;gt; &amp;lt;mount point&amp;gt; &amp;lt;type&amp;gt; &amp;lt;options&amp;gt; &amp;lt;dump&amp;gt; &amp;lt;pass&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">UUID&lt;/span>&lt;span class="o">=&lt;/span>3EB0-83DA /boot/efi vfat &lt;span class="nv">umask&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0077&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">UUID&lt;/span>&lt;span class="o">=&lt;/span>d28630c8-a642-45e6-baae-b41de3da008e / btrfs defaults,ssd,noatime,compress-force&lt;span class="o">=&lt;/span>zstd,commit&lt;span class="o">=&lt;/span>120,space_cache&lt;span class="o">=&lt;/span>v2,subvol&lt;span class="o">=&lt;/span>/@ &lt;span class="m">0&lt;/span> &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">UUID&lt;/span>&lt;span class="o">=&lt;/span>d28630c8-a642-45e6-baae-b41de3da008e /home btrfs defaults,ssd,noatime,compress-force&lt;span class="o">=&lt;/span>zstd,commit&lt;span class="o">=&lt;/span>120,space_cache&lt;span class="o">=&lt;/span>v2,subvol&lt;span class="o">=&lt;/span>/@home &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">UUID&lt;/span>&lt;span class="o">=&lt;/span>d28630c8-a642-45e6-baae-b41de3da008e /var/lib/docker btrfs defaults,ssd,noatime,compress-force&lt;span class="o">=&lt;/span>zstd,commit&lt;span class="o">=&lt;/span>120,space_cache&lt;span class="o">=&lt;/span>v2,subvol&lt;span class="o">=&lt;/span>/@docker &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">UUID&lt;/span>&lt;span class="o">=&lt;/span>d28630c8-a642-45e6-baae-b41de3da008e /var/cache btrfs defaults,ssd,noatime,compress-force&lt;span class="o">=&lt;/span>zstd,commit&lt;span class="o">=&lt;/span>120,space_cache&lt;span class="o">=&lt;/span>v2,subvol&lt;span class="o">=&lt;/span>/@cache &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">UUID&lt;/span>&lt;span class="o">=&lt;/span>d28630c8-a642-45e6-baae-b41de3da008e /var/log btrfs defaults,ssd,noatime,compress-force&lt;span class="o">=&lt;/span>zstd,commit&lt;span class="o">=&lt;/span>120,space_cache&lt;span class="o">=&lt;/span>v2,subvol&lt;span class="o">=&lt;/span>/@log &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Timeshift 这个不必多说，很好用的一个快照管理软件；&lt;/p>
&lt;p>btrfs-grub &lt;a href="https://github.com/Antynea/grub-btrfs">https://github.com/Antynea/grub-btrfs&lt;/a> 直接去项目主页看说明比较好&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2022-05-01T14:04:25+08:00
update@2023-01-25T15:43:30+08:00
comment@https://github.com/ferstar/blog/issues/60
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>一个简单计算PDF页数的方法</title><link>https://blog.ferstar.org/post/issue-59/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-59/</guid><pubDate>Fri, 08 Apr 2022 02:51:14 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>还是老老实实用现成的轮子吧&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">pdfminer.pdfdocument&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">PDFDocument&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">pdfminer.pdfparser&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">PDFParser&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">pdfminer.pdftypes&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">resolve1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">count_pdf_pages&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">bytes&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :param data: pdf data
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :return: page count
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">parser&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">PDFParser&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">BytesIO&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">doc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">PDFDocument&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">parser&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">parser&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set_document&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">doc&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pages&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">resolve1&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">doc&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">catalog&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;Pages&amp;#39;&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">pages&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Count&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>翻车了, 下面的代码仅适用于 PDF1.4 及以下版本&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">re&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">count_pages&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">count_pages_p&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">re&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">compile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">rb&lt;/span>&lt;span class="s2">&amp;#34;/Type\s*/Page([^s]|$)&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">re&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">MULTILINE&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">re&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">DOTALL&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;rb&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">fp&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">count_pages_p&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">findall&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">()))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2022-04-08T02:51:14+08:00
update@2022-04-18T11:41:56+08:00
comment@https://github.com/ferstar/blog/issues/59
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/snippet/">Snippet</category></item><item><title>薅大厂羊毛之改善MatterMost安卓客户端的消息推送</title><link>https://blog.ferstar.org/post/issue-58/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-58/</guid><pubDate>Mon, 04 Apr 2022 13:23:51 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>#23 之前这里用的&lt;code>Alertover&lt;/code>服务最近正式扑街没法用, 只好再挪个别的法子&lt;/p>
&lt;/blockquote>
&lt;p>用到的推送工具: &lt;a href="https://github.com/easychen/pushdeer">PushDeer&lt;/a>&lt;/p>
&lt;p>脚本运行环境: 腾讯云函数&lt;/p>
&lt;p>代码基本还是原来的, 只不过通过&lt;code>Alertover&lt;/code>服务推送消息变成了使用&lt;code>PushDeer&lt;/code>, 对应的方法改造也很简单, 就不放码了: &lt;a href="https://github.com/easychen/pushdeer#%E5%8F%91%E9%80%81%E5%AE%9E%E4%BE%8B">发送示例&lt;/a>&lt;/p>
&lt;p>至于云函数, 网上一堆教程, 这也不啰嗦, 我配置了&lt;strong>每五分钟&lt;/strong>运行一次, 主动调低了实例内存要求至&lt;code>64MB&lt;/code>&lt;/p>
&lt;p>当然节假日最好是不要推送的, 这就需要另一个 API 服务: &lt;a href="http://tool.bitefu.net/jiari/">http://tool.bitefu.net/jiari/&lt;/a> 检测消息前判断一下是否工作日, 是工作日才检查&amp;amp;发通知, 完美!&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2022-04-04T13:23:51+08:00
update@2022-04-04T13:24:00+08:00
comment@https://github.com/ferstar/blog/issues/58
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>吹一波vxTrans服务</title><link>https://blog.ferstar.org/post/issue-57/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-57/</guid><pubDate>Wed, 16 Mar 2022 23:47:52 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>最早用微林的服务是他家的http://tmp.link/, 前阵子在他家推上看到&lt;code>vxTrans&lt;/code>服务, 立马充值(丐中丐套餐)体验了一波, 真香&lt;/p>
&lt;/blockquote>
&lt;p>这里是关于&lt;code>vxTrans&lt;/code>服务的介绍: &lt;a href="https://www.vx.link/?tmpui_page=/help/vxtrans.html">https://www.vx.link/?tmpui_page=/help/vxtrans.html&lt;/a>&lt;/p>
&lt;p>官方讲的其实很克制, 就说了个加速 ssh, 这时候你可以认为他就是个 ssh 跳板, 但稍微往深挖一挖, 这玩意能玩的东西很多, 嗯, 就包括科学上网, 没错我又要利用他来拯救我的垃圾美西🐔了...&lt;/p>
&lt;p>简单说个用法: 用 vxTrans 来对接你的弱鸡, 然后原来科学上网的客户端配置里把 server/port 换成你 vxTrans 里的配置, 芜湖起飞!&lt;/p>
&lt;p>彩蛋: 关注他家 telegram 机器人@system_vx_bot, 发送&lt;code>getGift&lt;/code>有惊喜&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2022-03-16T23:47:52+08:00
update@2022-03-16T23:48:16+08:00
comment@https://github.com/ferstar/blog/issues/57
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/idea/">Idea</category></item><item><title>Cloudflare Argo Tunnels+Brook 一种非主流的科学上网姿势</title><link>https://blog.ferstar.org/post/issue-56/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-56/</guid><pubDate>Wed, 16 Mar 2022 23:10:03 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>先把用到的东西摆出来:&lt;/p>
&lt;ol>
&lt;li>&lt;a href="https://blog.cloudflare.com/argo-tunnels-that-live-forever/">https://blog.cloudflare.com/argo-tunnels-that-live-forever/&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://txthinking.github.io/brook/#/brook-wsserver">https://txthinking.github.io/brook/#/brook-wsserver&lt;/a>&lt;/li>
&lt;/ol>
&lt;p>用&lt;code>Cloudflare Argo Tunnels&lt;/code>(以下简称&lt;code>cft&lt;/code>)的目的主要是薅&lt;code>Cloudflare&lt;/code>的&lt;code>CDN&lt;/code>网络为自己的垃圾&lt;code>VPS&lt;/code>加速&lt;/p>
&lt;p>食用方法:&lt;/p>
&lt;ol>
&lt;li>把上面两样东西装好&lt;/li>
&lt;li>&lt;a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/tunnel-guide/">启动 cft&lt;/a> &lt;code>cloudflared tunnel run --url http://localhost:8888 hello&lt;/code>&lt;/li>
&lt;li>启动 brook ws: &lt;code>brook wsserver --listen 127.0.0.1:8888 --password auok&lt;/code>&lt;/li>
&lt;li>虽然小众, 但基本该有的&lt;a href="https://txthinking.github.io/brook/#/install-gui-client">客户端&lt;/a>都有&lt;/li>
&lt;li>注意客户端需要以 wss 的方式链接, 因为要过 cft&lt;/li>
&lt;/ol>
&lt;p>优点:&lt;/p>
&lt;ol>
&lt;li>背靠 cft , VPS 的 IP 几乎不可能被封&lt;/li>
&lt;li>如果你的 VPS 恰好是那种纯 docker 型或者网络出口有限制(有v6无v4)的话, &lt;code>cft&lt;/code>也能帮你突破&lt;code>VPS&lt;/code>所在域的网络限制&lt;/li>
&lt;li>有 CDN 加持, 垃圾线路也可以轻松满速&lt;/li>
&lt;li>相比 ss/v2ray 这种盛名在外的方案, brook ws 还是个小众的东西, 墙也许不那么敏感&lt;/li>
&lt;/ol>
&lt;p>缺点:&lt;/p>
&lt;ol>
&lt;li>延时高(&amp;gt;500ms), 所以不适合臭打游戏的&lt;/li>
&lt;li>&lt;code>cft&lt;/code>当前免费有 1TB/month 的流量, 但不确定未来收费水平&lt;/li>
&lt;li>移动端比较耗电&lt;/li>
&lt;/ol>
&lt;p>还有一种非主流的姿势, 对弱鸡加速效果明显: &lt;a href="https://github.com/HyNetwork/hysteria/wiki">https://github.com/HyNetwork/hysteria/wiki&lt;/a>&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2022-03-16T23:10:03+08:00
update@2022-03-16T23:35:15+08:00
comment@https://github.com/ferstar/blog/issues/56
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/idea/">Idea</category></item><item><title>以openpyxl为例, 不要太信任你所使用的库</title><link>https://blog.ferstar.org/post/issue-55/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-55/</guid><pubDate>Wed, 16 Mar 2022 22:41:01 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>最近在使用&lt;code>openpyxl&lt;/code>时踩了个小坑: 遍历 Excel 时&lt;code>openpyxl&lt;/code>可能会由于对行数的误判而提前终止&lt;/p>
&lt;/blockquote>
&lt;p>测试 Excel: &lt;a href="https://github.com/ferstar/blog/files/8274837/sample.xlsx">sample.xlsx&lt;/a> 这个 Excel 实际只有 10 行&lt;/p>
&lt;p>代码(分别使用了&lt;code>openpyxl/pylightxl/xlrd&lt;/code>来计算示例文件的行数):&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">openpyxl&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">pylightxl&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">xlrd&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">openpyxl_count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> Counts the number of rows in an Excel file with openpyxl.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">wb&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">openpyxl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">load_workbook&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sheet&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">wb&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">active&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">sheet&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">max_row&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">pylightxl_count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> Counts the number of rows in an Excel file with pylightxl.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">db&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">pylightxl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">readxl&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ws&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">db&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ws&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">db&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ws_names&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">ws&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">maxrow&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">xlrd_count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> Counts the number of rows in an Excel file with xlrd.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">wb&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">xlrd&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">open_workbook&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sheet&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">wb&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sheet_by_index&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">sheet&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">nrows&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="vm">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">excel_path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;sample.xlsx&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">openpyxl_count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">excel_path&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pylightxl_count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">excel_path&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">xlrd_count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">excel_path&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>结果很奇怪, &lt;code>openpyxl&lt;/code>得出&lt;code>14&lt;/code>行的结论, 其他两个工具结论正确&lt;code>10&lt;/code>, 实际上使用 MS office 打开也确实显示只有&lt;code>10&lt;/code>行&lt;/p>
&lt;p>哪里出问题了呢? 我拆开这个文档, 查了下&lt;code>xml&lt;/code>文件, 发现后四行确实是存在的, 只不过没有内容&lt;/p>
&lt;p>也就是说从视觉上看&lt;code>openpyxl&lt;/code>是错的, 但从真实数据上看他又是对的&lt;/p>
&lt;p>甲方客户可不管真实底层数据的情况, 他只关心他给你了 N 行数据, 结果你给人整了 M 行, 此为坑也&lt;/p>
&lt;p>排坑无非两个方案: 要么换库, 要么把源文件改造一下&lt;/p>
&lt;p>我选改造源文件, 即遍历 Excel 前先把&lt;code>xml&lt;/code>中隐藏的空值行全干掉, 这样就欧了, 同时也提了个 issue 给&lt;code>openpyxl&lt;/code>项目: &lt;a href="https://foss.heptapod.net/openpyxl/openpyxl/-/issues/1806">https://foss.heptapod.net/openpyxl/openpyxl/-/issues/1806&lt;/a>&lt;/p>
&lt;p>但官方不认为这是个 bug, 因为 xml 文件确实是有内容的, 只不过是几个空行, 尴尬&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2022-03-16T22:41:01+08:00
update@2022-04-04T13:09:32+08:00
comment@https://github.com/ferstar/blog/issues/55
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>利用Nginx Stream模块把 ssh 藏在 443 端口</title><link>https://blog.ferstar.org/post/issue-54/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-54/</guid><pubDate>Sun, 13 Mar 2022 13:36:29 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>Stream 模块真是牛的不行, 直接放配置&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">stream &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> map &lt;span class="nv">$ssl_preread_server_name&lt;/span> &lt;span class="nv">$name&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mydomain xtls&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> www.mydomain http&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> default ssh&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># upstream pool&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> upstream xtls &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server localhost:8081&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> upstream http &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server localhost:8080&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> upstream ssh &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 默认 ssh 连接会回落到 default , 然后到本机 22 端口&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server localhost:22&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 你甚至可以在这里挂个 openvpn ...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> listen &lt;span class="m">443&lt;/span> reuseport&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> listen &lt;span class="o">[&lt;/span>::&lt;span class="o">]&lt;/span>&lt;span class="m">443&lt;/span> reuseport&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_pass &lt;span class="nv">$name&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 这个开不开在你, 我反正没开, 因为就一个静态博客加微信公众号后台, 并不关心客户端 IP 的问题&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_protocol on&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ssl_preread on&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这样做的好处显而易见: ssh 可以经过 443 端口接入, 所以防火墙可以直接屏蔽掉&lt;code>22&lt;/code>端口, VPS 安全性又能上个台阶, 虽然有&lt;code>fail2ban&lt;/code>护体但每天 auth.log 里一堆垃圾试探看着也是神烦&lt;/p>
&lt;p>当然 由于工作在四层, 你可以有更多的玩法, 比如&lt;a href="https://github.com/XTLS/Xray-core/discussions/697#discussioncomment-1295912">搭把梯子&lt;/a>&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2022-03-13T13:36:29+08:00
update@2022-03-13T13:44:12+08:00
comment@https://github.com/ferstar/blog/issues/54
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/snippet/">Snippet</category></item><item><title>撸了个甲骨文ARM(4C24G200G)的机子</title><link>https://blog.ferstar.org/post/issue-53/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-53/</guid><pubDate>Sun, 13 Mar 2022 13:17:06 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>2022年04月28日更新：垃圾甲骨文，又莫须有删我实例，告辞。&lt;/p>
&lt;/blockquote>
&lt;p>后知后觉入了甲骨文坡县的账号, 发现正经建免费 ARM 实例几乎不可能, 于是就随便找了篇&lt;a href="https://www.daniao.org/14121.html">抢购教程&lt;/a>, 具体过程不细表, 只说几个关键的点:&lt;/p>
&lt;ol>
&lt;li>网传的 Python 啊 Go 的啥脚本基本没啥用, 还容易被甲骨文封 IP;&lt;/li>
&lt;li>为了增加抢购成功率, 可以先&lt;strong>不配公网IP; 选个中低配/不要一下子拉满; 使用官方 OCI cli 工具来刷(基本不会被封 IP)&lt;/strong>&lt;/li>
&lt;li>官方 OCI 工具也是个 Python 脚本, 视网络情况不同可能执行一次需要几秒甚至几十秒不等&lt;/li>
&lt;/ol>
&lt;p>贡献一个自用的脚本(依赖&lt;code>at&lt;/code>程序做定时运行)&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">oci compute instance launch --availability-domain LyQn:AP-SINGAPORE-1-AD-1 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --image-id ocid1.image.oc1.ap-singapore-1.xxx &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --subnet-id ocid1.subnet.oc1.ap-singapore-1.ooo &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --shape VM.Standard.A1.Flex &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --assign-public-ip &lt;span class="nb">false&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --metadata &lt;span class="s1">&amp;#39;{&amp;#34;ssh_authorized_keys&amp;#34;: &amp;#34;ssh-rsa xxx+yyy+hHrDIzDuudkARI7/zzz/WbQYN+0sGVt096LnU8gf2VE+kPIf6hbeTcQYcZC89l4Nn0z+G5VlF1J1H15MZrVzl2XIdv2egqQXEclYtgnUT5WkDumW6A7NCWXM/9y+qqq ssh-key-2022-02-07&amp;#34;}&amp;#39;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --compartment-id ocid1.tenancy.oc1..zzzz &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --shape-config &lt;span class="s1">&amp;#39;{&amp;#34;ocpus&amp;#34;: 2, &amp;#34;memory_in_gbs&amp;#34;: 12, &amp;#34;boot_volume_size_in_gbs&amp;#34;: 50}&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 我这用的是中配&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 执行完两分钟以后继续运行&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">at &lt;span class="k">$(&lt;/span>date -d &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>date&lt;span class="k">)&lt;/span>&lt;span class="s2"> + 2 minutes&amp;#34;&lt;/span> +&lt;span class="s2">&amp;#34;%H:%M %Y-%m-%d&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span> &amp;lt; ~/oracle.cron.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>我是挂了大概 12 小时左右就抢到两台(超免费账户限额后就不能创建新的, 所以不用担心脚本会重建一堆实例然后甲骨文把你扣到底裤不剩), &lt;strong>然后删掉一台, 再对剩下的一台做扩容操作(CPU/RAM/DISK 都拉满), 再上公网 IP, 再上 ipv6&lt;/strong>&lt;/p>
&lt;p>PS: 注意甲骨文的 OS 比较恶心的一点是预置了一堆 iptables 规则, 最好提前干掉(我换了&lt;code>ufw&lt;/code>来管理, 有效降低了心智负担)&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 开放所有&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -P INPUT ACCEPT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -P FORWARD ACCEPT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -P OUTPUT ACCEPT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -F
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 持久化&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables-save &amp;gt; /etc/iptables/rules.v4
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>默认 Ubuntu 系统内核版本已经很高了, 早就内置了&lt;code>bbr&lt;/code>拥塞协议, 所以简单配置一下就能开启&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># /etc/sysctl.conf 增加一行&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net.ipv4.tcp_congestion_control&lt;span class="o">=&lt;/span>bbr
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 应用即可, 无需重启&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># sysctl -p&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2022-03-13T13:17:06+08:00
update@2022-04-28T10:22:24+08:00
comment@https://github.com/ferstar/blog/issues/53
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>Build a simple Python GUI and an associated installer with fbs and github actions</title><link>https://blog.ferstar.org/post/issue-52/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-52/</guid><pubDate>Sun, 16 Jan 2022 07:19:22 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>Over the past few years I've written a few little tools in Python to improve productivity, and when I shared them with colleagues, it was a pain to package them until I met &lt;a href="https://build-system.fman.io/">fbs&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>In this post I will show you &lt;a href="https://github.com/ferstar/fbs_demo">a demo&lt;/a> which can do build things automatically with the github actions service.&lt;/p>
&lt;h3 id="setup-a-fbs-env">Setup a fbs env&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mkdir fbs_demo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> fbs_demo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">python3 -m venv fbs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">source&lt;/span> fbs/bin/activate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pip3 install pip -U
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pip3 install fbs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pip3 install &lt;span class="nv">PyQt5&lt;/span>&lt;span class="o">==&lt;/span>5.9.2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="start-a-project">Start a project&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">fbs startproject
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="run-it">Run it&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">fbs run
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="build-it">Build it&lt;/h3>
&lt;p>See my &lt;a href="https://github.com/ferstar/fbs_demo/blob/main/.github/workflows/build.yml">workflow file&lt;/a> for different platforms(Ubuntu, macOS and Windows)&lt;/p>
&lt;p>Thanks to the github actions, the only thing you need to care is about the code, not the build environment.&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2022-01-16T07:19:22+08:00
update@2022-01-16T07:19:28+08:00
comment@https://github.com/ferstar/blog/issues/52
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>Find common substring between two strings</title><link>https://blog.ferstar.org/post/issue-51/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-51/</guid><pubDate>Tue, 23 Nov 2021 06:56:34 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>有一段损失了定位信息的文字: &lt;code>plain_text = '我爱北京天安门, 天安门上放鞭炮'&lt;/code>, 要求还原这段文字在给定段落中尽可能相近的位置&lt;/p>
&lt;p>这个段落数据结构大概长这样: &lt;code>paragraph = {'text': '佛曰 我爱北京天安门, 天安门上太阳升...', chars': [{'text': '佛', 'box': [1, 2, 3, 4]}, {'text': '曰', 'box': [1, 2, 3, 4]}, ..., {'text': '我', 'box': [1, 2, 3, 4]}, ..., {'text': '门', 'box': [1, 2, 3, 4]}, ]}&lt;/code>&lt;/p>
&lt;p>其实这就是一个&lt;code>求最长公共子串&lt;/code>的问题, 先简单粗暴实现了一发:&lt;/p>
&lt;ol>
&lt;li>找出最大公共子串&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">find_longest_sub_str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">string1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">string2&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">answer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">len1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">len2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">string1&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">string2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">len1&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">len2&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lcs_temp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">match&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">lcs_temp&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">len1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">lcs_temp&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">len2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="n">string1&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">lcs_temp&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">string2&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">lcs_temp&lt;/span>&lt;span class="p">]:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">match&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">string2&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">lcs_temp&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lcs_temp&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">match&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">answer&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">answer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">match&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">answer&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="vm">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">str_a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;我爱北京天安门, 天安门上放鞭炮&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">str_b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;佛曰 我爱北京天安门, 天安门上太阳升...&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">find_longest_sub_str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">str_a&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">str_b&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="2">
&lt;li>按index取对应的box信息&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">find_longest_sub_str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">string1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">string2&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">answer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">len1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">len2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">string1&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">string2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">len1&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">len2&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lcs_temp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">match&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">lcs_temp&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">len1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">lcs_temp&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">len2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="n">string1&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">lcs_temp&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">string2&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">lcs_temp&lt;/span>&lt;span class="p">]:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">match&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">lcs_temp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lcs_temp&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">match&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">answer&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">answer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">match&lt;/span>&lt;span class="p">[:]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">answer&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="vm">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">str_a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;我爱北京天安门, 天安门上放鞭炮&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">str_b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;佛曰 我爱北京天安门, 天安门上太阳升...&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">indexes&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">find_longest_sub_str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">str_a&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">str_b&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 这里拦头去尾就可以从段落中拿到对应字的位置信息了&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>粗看起来貌似能交差, 但实际上很坑, 这玩意是&lt;code>O(N^2)&lt;/code>, 段落文字如果略长的话, 会慢到怀疑人生, 所以必须优化之, 放狗一搜, 发现标准库就有对应实现, 果断抄之&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">find_longest_sub_str1&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">str_a&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">str_b&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">SequenceMatcher&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">str_a&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">str_b&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">find_longest_match&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">str_a&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">str_b&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>跑了个分, 当字符串长度过长时, 人比人得死了...&lt;/p>
&lt;p>&lt;img src="https://user-images.githubusercontent.com/2854276/142982012-cf3d0cc4-58f2-4094-9ef0-cbf7223fcd21.png" alt="image">&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2021-11-23T06:56:34+08:00
update@2022-09-08T04:40:39+08:00
comment@https://github.com/ferstar/blog/issues/51
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/snippet/">Snippet</category></item><item><title>Remove old kernel</title><link>https://blog.ferstar.org/post/issue-50/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-50/</guid><pubDate>Sat, 20 Nov 2021 03:17:30 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="ch">#!/usr/bin/env python3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">subprocess&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">logging&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">re&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">sys&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">collections&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">defaultdict&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">kernel_version_p&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">re&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">compile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">r&lt;/span>&lt;span class="s2">&amp;#34;[\d\-\.]{8,}&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">run_command&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">command&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ignore_exception&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">False&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">timeout&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">60&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">60&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">24&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">no_out&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">False&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">logging&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">debug&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;exec command :&amp;#34;&lt;/span>&lt;span class="si">%s&lt;/span>&lt;span class="s1">&amp;#34;&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">command&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">no_out&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">subprocess&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Popen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">command&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">shell&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">subprocess&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Popen&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">command&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">stdout&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">subprocess&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PIPE&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">stderr&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">subprocess&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PIPE&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">shell&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">outs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">errs&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">o&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">decode&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">o&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">proc&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">communicate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">timeout&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">timeout&lt;/span>&lt;span class="p">)]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span> &lt;span class="n">subprocess&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">SubprocessError&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">exp&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">outs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">errs&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">exp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">ignore_exception&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">logging&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">warning&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">errs&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">raise&lt;/span> &lt;span class="n">exp&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">finally&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proc&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">kill&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">outs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">errs&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">parse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">kernels&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">generic_kernels&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">defaultdict&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">set&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">oem_kernels&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">defaultdict&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">set&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">k&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">kernels&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">match&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">kernel_version_p&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">k&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="k">match&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">logging&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">warning&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;wrong: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">k&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">continue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">num_k&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">match&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">replace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;-&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">replace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;.&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="s2">&amp;#34;edge&amp;#34;&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">k&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">oem_kernels&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">num_k&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">k&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">generic_kernels&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">num_k&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">k&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">k&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">kernels&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">match&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">kernel_version_p&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">k&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="k">match&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">logging&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">warning&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;wrong: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">k&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">continue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">num_k&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">match&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">replace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;-&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">replace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;.&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">d&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">generic_kernels&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">oem_kernels&lt;/span>&lt;span class="p">]:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">num_k&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">d&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">d&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">num_k&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">k&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">generic_kernels&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">oem_kernels&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="vm">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;__main__&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cli&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;dpkg --get-selections | egrep -i &amp;#39;linux-[himo]&amp;#39; | awk &amp;#39;{print $1}&amp;#39; | grep -v $(egrep -i &amp;#39;^DISTRIB_RELEASE=&amp;#39; /etc/lsb-release | awk -F &amp;#39;=&amp;#39; &amp;#39;{print $NF}&amp;#39;)&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">outs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">errors&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">run_command&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cli&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">outs&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">errors&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">errors&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">kernels&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">i&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">outs&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">re&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">r&lt;/span>&lt;span class="s2">&amp;#34;[a-z]+\-generic$&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">d&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">parse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">kernels&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">k&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">sorted&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">d&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">items&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">lambda&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">reverse&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cmd&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;apt purge &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="s1">&amp;#39; &amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">k&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2"> -y&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">op&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">input&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cmd&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strip&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">op&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">lower&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;y&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">run_command&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cmd&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2021-11-20T03:17:30+08:00
update@2021-11-20T03:19:06+08:00
comment@https://github.com/ferstar/blog/issues/50
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/snippet/">Snippet</category></item><item><title>Make use of invoke klass param to simplify our daily CLI task</title><link>https://blog.ferstar.org/post/issue-49/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-49/</guid><pubDate>Sat, 13 Nov 2021 12:26:24 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>invoke version: &amp;gt;= 1.1&lt;/p>
&lt;/blockquote>
&lt;h3 id="code">Code&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># filename=tasks.py&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">asyncio&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">inspect&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">isgeneratorfunction&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">iscoroutinefunction&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">invoke&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">Task&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">invoke.tasks&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">task&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">InvokeWrapper&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Task&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__call__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">kwargs&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">io_loop&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">asyncio&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get_event_loop&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">isgeneratorfunction&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">body&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">io_loop&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">run_until_complete&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">asyncio&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">coroutine&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">body&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">kwargs&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="n">iscoroutinefunction&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">body&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">io_loop&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">run_until_complete&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">body&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">kwargs&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">body&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">kwargs&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">times_called&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">result&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@task&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">klass&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">InvokeWrapper&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">foo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ctx&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;sync task&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;foo&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@task&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">klass&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">InvokeWrapper&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">async&lt;/span> &lt;span class="k">def&lt;/span> &lt;span class="nf">bar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ctx&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;async/await style async task&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">await&lt;/span> &lt;span class="n">asyncio&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">0.1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;bar&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@task&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">klass&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">InvokeWrapper&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">baz&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ctx&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;yield from(&amp;lt; py3.6) style async task&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">yield from&lt;/span> &lt;span class="n">asyncio&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">0.1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;baz&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="test">Test&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">~ inv -l
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Available tasks:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> bar async/await style async task
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> baz yield from&lt;span class="o">(&lt;/span>&amp;lt; py3.6&lt;span class="o">)&lt;/span> style async task
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> foo sync task
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">~ inv bar&lt;span class="p">|&lt;/span>foo&lt;span class="p">|&lt;/span>baz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bar
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">baz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">foo
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2021-11-13T12:26:24+08:00
update@2021-11-13T12:27:13+08:00
comment@https://github.com/ferstar/blog/issues/49
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/snippet/">Snippet</category><category domain="https://blog.ferstar.org/tags/invoke/">Invoke</category></item><item><title>Tornado热重载机制下使用lru_cache一个隐藏的坑点</title><link>https://blog.ferstar.org/post/issue-48/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-48/</guid><pubDate>Tue, 09 Nov 2021 11:02:12 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>经常用&lt;code>lru_cache&lt;/code>来加速一些重复耗时的&lt;code>func&lt;/code>, 今天栽了个坑: &lt;code>func&lt;/code>的缓存在服务热重载后并没有被释放掉, 导致重跑这个方法的时候总是返回旧的数据, 放代码解释:&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@lru_cache&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">parse_file&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">pass&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>parse_file&lt;/code>接收一个文件路径, 对给定文件做了若干处理, 正常情况是没有问题的, 但是如果文件内容发生了变化, 本例实际上是因为要重跑某些process, 连带着这个文件内容是有更新的, 但是&lt;code>path&lt;/code>不变, 在热重载的时候, 全局缓存并没有清掉, 导致每次调用方法返回的还是旧缓存数据&lt;/p>
&lt;p>关于 Tornado 的热重载, 我在这里有过介绍: &lt;a href="https://blog.ferstar.org/post/issue-39">init_process&lt;/a>&lt;/p>
&lt;p>问题搞清楚, 解决起来就很简单, 重载的时候清一波就完事&lt;/p>
&lt;ul>
&lt;li>定义一个清缓存的方法&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">clear_caches&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># All objects cleared&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">obj&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">gc&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get_objects&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">functools&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_lru_cache_wrapper&lt;/span>&lt;span class="p">)):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">obj&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cache_clear&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">gc&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">collect&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>热重载前清掉缓存&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">TornadoWorker&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Worker&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">......&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">init_process&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># IOLoop cannot survive a fork or be shared across processes&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># in any way. When multiple processes are being used, each process&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># should create its own IOLoop. We should clear current IOLoop&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># if exists before os.fork.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">IOLoop&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">clear_current&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">clear_caches&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># You can do something like release db conn/clean fp or else.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">super&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">init_process&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后, 整个世界清净了~&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2021-11-09T11:02:12+08:00
update@2021-11-09T11:03:56+08:00
comment@https://github.com/ferstar/blog/issues/48
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/todo/">TODO</category><category domain="https://blog.ferstar.org/tags/tornado/">Tornado</category></item><item><title>拥抱 WSLg</title><link>https://blog.ferstar.org/post/issue-47/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-47/</guid><pubDate>Tue, 02 Nov 2021 22:47:57 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>好了，我宣布WSLg就是个锤锤，投奔Linux怀抱&lt;/p>
&lt;hr>
&lt;blockquote>
&lt;p>开个坑, 慢慢填&lt;/p>
&lt;/blockquote>
&lt;ol start="0">
&lt;li>垃圾WSL IO巨慢&lt;/li>
&lt;/ol>
&lt;p>这里喷IO慢的仔细一看基本都是项目在Windows里, 然后 runtime 在 WSL, 这他喵跨着9p不卡才怪&lt;/p>
&lt;p>解决方法也很简单, runtime IDE什么的一股脑统统丢 WSL 里不就完了, 啥? 嫌空间不够用? WSL挂载磁盘了解下? 直接就是原生磁盘IO的性能&lt;/p>
&lt;ol>
&lt;li>&lt;del>PyCharm 全局搜索框调不出来或者一闪而逝&lt;/del>&lt;code>此坑已填: https://youtrack.jetbrains.com/issue/IDEA-265390&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>&lt;del>这个&lt;a href="https://github.com/microsoft/wslg/issues/96#issuecomment-858257113">issue&lt;/a>里找到了神仙解法: 狂按快捷键, 直到全局搜索框出来为止, 然后 pin 住, 就欧了...&lt;/del>&lt;/p>
&lt;ol start="2">
&lt;li>中文输入法&lt;/li>
&lt;/ol>
&lt;p>方法是从&lt;a href="https://blog.csdn.net/defrag257/article/details/117326000">CSDN淘的&lt;/a> , 装好&lt;code>fcitx&lt;/code>后, 这段丢到bashrc 或 zshrc 或 profile 里, 然后启动GUI前运行&lt;code>fcitx-autostart&lt;/code>即可, 只需要运行一次&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">LANG&lt;/span>&lt;span class="o">=&lt;/span>zh_CN.UTF-8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">INPUT_METHOD&lt;/span>&lt;span class="o">=&lt;/span>fcitx &lt;span class="c1"># wayland输入法&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">XMODIFIERS&lt;/span>&lt;span class="o">=&lt;/span>@im&lt;span class="o">=&lt;/span>fcitx &lt;span class="c1"># x11输入法&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">GTK_IM_MODULE&lt;/span>&lt;span class="o">=&lt;/span>fcitx &lt;span class="c1"># gtk输入法&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">QT_IM_MODULE&lt;/span>&lt;span class="o">=&lt;/span>fcitx &lt;span class="c1"># qt输入法&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="3">
&lt;li>OpenGL 也就是显卡加速&lt;/li>
&lt;/ol>
&lt;p>老老实实按&lt;a href="https://github.com/microsoft/wslg#pre-requisites">官方说明&lt;/a>去装一下支持wslg的显卡驱动即可, 直观的感受是拖拽WSL的GUI应用窗口不会撕裂, 也明显不卡顿了, 纵享丝滑&lt;/p>
&lt;p>后续的Windows更新可能会把装好的vGPU驱动替换成正常驱动, 从而导致WSLg GUI 应用丢掉 OpenGL 加速支持, 会显得比较卡, 暂时的解决办法是从组策略禁用Windows更新驱动程序&lt;/p>
&lt;p>&lt;code>Win + R -&amp;gt; gpedit.msc -&amp;gt; 计算机配置 -&amp;gt; 管理模板 -&amp;gt; Windows组件 -&amp;gt; Windows更新 -&amp;gt; 管理从Windows更新提供的更新 -&amp;gt; Windows更新不包括驱动程序 -&amp;gt; 启用 -&amp;gt; 应用&lt;/code>&lt;/p>
&lt;ol start="4">
&lt;li>IP老变的问题&lt;/li>
&lt;/ol>
&lt;p>这个也就是一个小脚本解决的事情, 以我常用的 proxychains(wsl中使用host代理) 为例&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">new_host&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>grep &lt;span class="s1">&amp;#39;nameserver&amp;#39;&lt;/span> /etc/resolv.conf &lt;span class="p">|&lt;/span> head -n &lt;span class="m">1&lt;/span> &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;{print $2}&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">old_host&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>grep -E &lt;span class="s1">&amp;#39;^socks5&amp;#39;&lt;/span> /etc/proxychains4.conf &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;{print $2}&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo sed -i &lt;span class="s2">&amp;#34;s/&lt;/span>&lt;span class="nv">$old_host&lt;/span>&lt;span class="s2">/&lt;/span>&lt;span class="nv">$new_host&lt;/span>&lt;span class="s2">/g&amp;#34;&lt;/span> /etc/proxychains4.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="5">
&lt;li>Windows Terminal 进 Ubuntu 子系统默认目录不是&lt;code>~&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>设置 -&amp;gt; Ubuntu -&amp;gt; 常规 -&amp;gt; 命令行 -&amp;gt; &lt;code>wsl.exe -d Ubuntu-20.04 --cd ~&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://user-images.githubusercontent.com/2854276/142790024-9b05f0e5-1784-4ae6-a575-d9536f793242.png" alt="image">&lt;/p>
&lt;ol start="6">
&lt;li>Nahimic 无法发布?&lt;/li>
&lt;/ol>
&lt;p>直接卸载就完事, 如果卸载不掉, 可以试试我从&lt;a href="https://zhuanlan.zhihu.com/p/347961733">知乎&lt;/a>淘来的一个脚本
&lt;a href="https://github.com/ferstar/blog/files/7599644/RemoveNahimic_20210111.zip">RemoveNahimic_20210111.zip&lt;/a>&lt;/p>
&lt;ol start="7">
&lt;li>JB全家桶里面中文输入法没法光标跟随?&lt;/li>
&lt;/ol>
&lt;p>参考我之前&lt;a href="https://blog.ferstar.org/post/issue-33/">这里&lt;/a>的说明, WSLg环境依然有效, 主要就是用魔改的&lt;code>jbr&lt;/code>替换JB官方的&lt;code>jbr&lt;/code>目录&lt;/p>
&lt;p>&lt;img src="https://user-images.githubusercontent.com/2854276/144391926-256746e8-f2cb-49d9-9476-0168fbe88b85.png" alt="image">&lt;/p>
&lt;ol start="8">
&lt;li>偶尔 WSLg GUI 没有响应, 一般发生在长时间睡眠的唤醒时, 不频繁&lt;/li>
&lt;/ol>
&lt;p>&lt;del>shutdown掉子系统, 卸载重装 WSLg 再开子系统即可&lt;/del>&lt;/p>
&lt;p>后来定位到其实是 AMD 核显驱动的问题, 换&lt;code>独显直通&lt;/code>用 NVIDIA 独显就没事了&lt;/p>
&lt;ol start="9">
&lt;li>某次更新后发现没法完全关闭Windows defender了?&lt;/li>
&lt;/ol>
&lt;p>用这个工具关闭: &lt;a href="https://github.com/ferstar/blog/files/8218101/dControl.zip">dControl.zip&lt;/a>&lt;/p>
&lt;p>或者随便选择装一个安全软件, 比如&lt;code>火绒&lt;/code>即可&lt;/p>
&lt;ol start="10">
&lt;li>某次更新以后网卡地球仪图标, 显示无网络?&lt;/li>
&lt;/ol>
&lt;p>&lt;a href="https://docs.microsoft.com/zh-cn/windows/privacy/manage-connections-from-windows-operating-system-components-to-microsoft-services#14-%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5%E7%8A%B6%E6%80%81%E6%8C%87%E7%A4%BA%E5%99%A8">https://docs.microsoft.com/zh-cn/windows/privacy/manage-connections-from-windows-operating-system-components-to-microsoft-services&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://github.com/ferstar/blog/files/8339080/NoActiveProbe.zip">现成的注册表备份: NoActiveProbe.zip&lt;/a>&lt;/p>
&lt;ol start="11">
&lt;li>系统更新后 Scoop Apps 内应用图标丢失?&lt;/li>
&lt;/ol>
&lt;p>见: &lt;a href="https://github.com/ScoopInstaller/Scoop/issues/3941">https://github.com/ScoopInstaller/Scoop/issues/3941&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">scoop reset *
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="12">
&lt;li>zsh 粘贴又卡又慢?&lt;/li>
&lt;/ol>
&lt;p>看这里: &lt;a href="https://github.com/zsh-users/zsh-autosuggestions/issues/238#issuecomment-389324292">https://github.com/zsh-users/zsh-autosuggestions/issues/238#issuecomment-389324292&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 粘贴到.zshrc再source一下即可&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># This speeds up pasting w/ autosuggest&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># https://github.com/zsh-users/zsh-autosuggestions/issues/238&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pasteinit&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">OLD_SELF_INSERT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="si">${${&lt;/span>&lt;span class="p">(s.:.)widgets[self-insert]&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="p">[2,3]&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> zle -N self-insert url-quote-magic &lt;span class="c1"># I wonder if you&amp;#39;d need `.url-quote-magic`?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pastefinish&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> zle -N self-insert &lt;span class="nv">$OLD_SELF_INSERT&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">zstyle :bracketed-paste-magic paste-init pasteinit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">zstyle :bracketed-paste-magic paste-finish pastefinish
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="13">
&lt;li>微软输入法选字框消失?&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>设置〉时间和语言〉语言和区域〉选项〉微软拼音〉常规〉兼容性〉使用以前版本的微软拼音输入法&lt;/p>
&lt;/blockquote>
&lt;ol start="14">
&lt;li>开启 SSH&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>从这抄的: &lt;a href="http://dancingline.cn/%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5WSL2/">http://dancingline.cn/%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5WSL2/&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>为防 404, 摘抄一份&lt;/p>
&lt;/blockquote>
&lt;p>据说自带的OpenSSH有问题，需要先卸后装&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">sudo apt remove openssh-server
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo apt install openssh-server
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>修改 sshd 配置文件&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">Port &lt;span class="m">2222&lt;/span> &lt;span class="c1">#设置ssh的端口号, 由于22在windows中有别的用处, 尽量不修改系统的端口号&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">PermitRootLogin yes &lt;span class="c1"># 可以root远程登录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">PasswordAuthentication yes &lt;span class="c1"># 允许密码验证登录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">AllowUsers dancingline &lt;span class="c1"># 远程登录时的用户名&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重启服务&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">sudo service ssh --full-restart
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Windows端口转发(保存为.ps1 后缀, 直接运行即可, 会自动申请管理员权限)&lt;/p>
&lt;blockquote>
&lt;p>防火墙配置就不多说, 我是直接关掉&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">-NOT&lt;/span> &lt;span class="p">([&lt;/span>&lt;span class="no">Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">GetCurrent&lt;/span>&lt;span class="p">()).&lt;/span>&lt;span class="py">IsInRole&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="no">Security.Principal.WindowsBuiltInRole&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="s2">&amp;#34;Administrator&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$arguments&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;&amp;amp; &amp;#39;&amp;#34;&lt;/span> &lt;span class="p">+&lt;/span>&lt;span class="nv">$myinvocation&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">mycommand&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">definition&lt;/span> &lt;span class="p">+&lt;/span> &lt;span class="s2">&amp;#34;&amp;#39;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">Start-Process&lt;/span> &lt;span class="n">powershell&lt;/span> &lt;span class="n">-Verb&lt;/span> &lt;span class="n">runAs&lt;/span> &lt;span class="n">-ArgumentList&lt;/span> &lt;span class="nv">$arguments&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">Break&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># 找到WSL2的IP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$ip&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="n">bash&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">-c&lt;/span> &lt;span class="s2">&amp;#34;ifconfig eth0 | grep &amp;#39;inet &amp;#39;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$found&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nv">$ip&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s1">&amp;#39;\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$found&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$ip&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nv">$matches&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mf">0&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;Found IP &lt;/span>&lt;span class="nv">$ip&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># 端口转发，listenport和listenaddress表示监听的端口和IP，connectport和connectaddress表示转发到的端口和IP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">iex &lt;/span>&lt;span class="s2">&amp;#34;netsh interface portproxy add v4tov4 listenport=2222 listenaddress=* connectport=2222 connectaddress=&lt;/span>&lt;span class="nv">$ip&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># 展示已有的&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">iex &lt;/span>&lt;span class="s2">&amp;#34;netsh interface portproxy show all;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;The ip address of WSL2 cannot be found!&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>完事以后就可以从局域网 or 外网直接 ssh 链接了&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">ssh root@x.x.x.x -p &lt;span class="m">2222&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2021-11-02T22:47:57+08:00
update@2022-08-15T06:46:18+08:00
comment@https://github.com/ferstar/blog/issues/47
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/windows/">WINDOWS</category><category domain="https://blog.ferstar.org/tags/wsl2/">WSL2</category></item><item><title>爸爸你走开，我在看电视不要打扰我！</title><link>https://blog.ferstar.org/post/issue-46/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-46/</guid><pubDate>Mon, 25 Oct 2021 16:05:16 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>下班到家想强啵一发闺女，小家伙双手环抱，一本正经的对我说：「爸爸你走开，我在看电视不要打扰我！」&lt;/p>
&lt;p>老父亲的心💔💔💔&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2021-10-25T16:05:16+08:00
update@2021-10-25T16:05:35+08:00
comment@https://github.com/ferstar/blog/issues/46
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/baby/">Baby</category><category domain="https://blog.ferstar.org/tags/life/">Life</category></item><item><title>我可能是最能删代码的了</title><link>https://blog.ferstar.org/post/issue-45/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-45/</guid><pubDate>Mon, 25 Oct 2021 15:55:45 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>转眼主力参与项目已经三年整，统计了下，发现自己代码总量是&lt;code>-10万+&lt;/code>，没错，是负的，要按代码量算工钱我得倒贴，遥谢老板不开之恩。&lt;/p>
&lt;p>&lt;img src="https://user-images.githubusercontent.com/2854276/138729280-b25f701b-324d-4caa-be8a-e59155bf74eb.jpg" alt="IMG_20211025_233843.jpg">&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2021-10-25T15:55:45+08:00
update@2021-11-02T23:01:04+08:00
comment@https://github.com/ferstar/blog/issues/45
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/life/">Life</category></item><item><title>Use literal_eval instead of eval</title><link>https://blog.ferstar.org/post/issue-44/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-44/</guid><pubDate>Mon, 25 Oct 2021 01:49:59 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;ul>
&lt;li>code&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">ast&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">operator&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">valid_ops&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ast&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Add&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">operator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">add&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ast&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Sub&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">operator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sub&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ast&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Mult&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">operator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">mul&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ast&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Div&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">operator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">truediv&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ast&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">USub&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">operator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">neg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1"># negative number&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">safe_eval&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">expr&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;Use `ast.literal_eval` instead of `eval`
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> via: https://stackoverflow.com/a/20748308
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">_eval&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ast&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Expression&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">_eval&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">body&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ast&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Str&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">node&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">s&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ast&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Num&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">node&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">n&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ast&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">UnaryOp&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">valid_ops&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nb">type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">op&lt;/span>&lt;span class="p">)](&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">operand&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ast&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">BinOp&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">valid_ops&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nb">type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">op&lt;/span>&lt;span class="p">)](&lt;/span>&lt;span class="n">_eval&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">left&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">_eval&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">right&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">raise&lt;/span> &lt;span class="ne">TypeError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Unsupported type &lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">_eval&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ast&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">expr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">mode&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;eval&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">body&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>test&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">safe_eval&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;1 + 2 / 3&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Out&lt;span class="o">[&lt;/span>3&lt;span class="o">]&lt;/span>: 1.6666666666666665
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">safe_eval&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;(1 + 2) / 3&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Out&lt;span class="o">[&lt;/span>4&lt;span class="o">]&lt;/span>: 1.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">safe_eval&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;-1&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Out&lt;span class="o">[&lt;/span>5&lt;span class="o">]&lt;/span>: -1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2021-10-25T01:49:59+08:00
update@2021-11-09T07:21:25+08:00
comment@https://github.com/ferstar/blog/issues/44
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/snippet/">Snippet</category></item><item><title>关于最近项目持续重构的一点复盘</title><link>https://blog.ferstar.org/post/issue-43/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-43/</guid><pubDate>Sun, 11 Jul 2021 14:46:05 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;h1 id="关于最近项目持续重构的粗略复盘">关于最近项目持续重构的粗略复盘&lt;/h1>
&lt;blockquote>
&lt;p>先抛成果：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>&lt;/th>
&lt;th>重构前&lt;/th>
&lt;th>重构后&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Python版本&lt;/td>
&lt;td>3.6.x&lt;/td>
&lt;td>3.8.x&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Tornado版本&lt;/td>
&lt;td>4.5.3&lt;/td>
&lt;td>6.1(latest)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>DB driver&lt;/td>
&lt;td>momoko&lt;/td>
&lt;td>gino(latest)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Code style check&lt;/td>
&lt;td>pylint only&lt;/td>
&lt;td>multi pre-commit hooks&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>单元测试&lt;/td>
&lt;td>无&lt;/td>
&lt;td>有(基本覆盖基础业务API&amp;amp;主要数据处理流程)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>热重载&lt;/td>
&lt;td>不支持&lt;/td>
&lt;td>支持(gunicorn)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>项目冷启动速度&lt;/td>
&lt;td>8~10秒&lt;/td>
&lt;td>&amp;lt;2秒&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>类型注释&lt;/td>
&lt;td>无&lt;/td>
&lt;td>有(持续完善中)&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;/blockquote>
&lt;h2 id="缘起">缘起&lt;/h2>
&lt;p>一般来说，作为业务CRUD仔，其实没有太大的动力对项目进行重构，能跑就对了，要啥自行车，对吧？但是实际上我就是看不惯再加上若干次组员很傻逼的低级错误引发的线上扑街问题以后，重构就变成了一件很必要的事。&lt;/p>
&lt;h2 id="过程">过程&lt;/h2>
&lt;p>下定决心重构以后，接下来的事情就是琢磨下怎么做。时间上，肯定是优先响应bug以及新需求，其次抠出点时间来做重构；顺序方面，因为涉及到多人合作，实在不想老在codereview时就一些基本语法、样式之类的臭裹脚布问题扯皮，所以首先从引入&lt;code>pre-commit hooks&lt;/code>强制规范代码风格做起。&lt;/p>
&lt;h3 id="pre-commit-hooks">pre-commit hooks&lt;/h3>
&lt;blockquote>
&lt;p>这个还是直接贴配置说的清楚些&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">default_stages&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="l">commit]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">fail_fast&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">repos&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">repo&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">https://github.com/ambv/black &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 自动格式化&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">rev&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">21.&lt;/span>&lt;span class="l">5b2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">hooks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">id&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">black&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">repo&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">https://github.com/pre-commit/pre-commit-hooks&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">rev&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v4.0.1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">hooks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">id&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">check-added-large-files &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 大的二进制文件提交检查，主要是模型有时候会被别组的同事误提交，导致.git很膨胀&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">id&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">trailing-whitespace&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">stages&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="l">commit]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">id&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">end-of-file-fixer&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">stages&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="l">commit]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">id&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">debug-statements&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">repo&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">https://github.com/commitizen-tools/commitizen&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">rev&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v2.17.9&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">hooks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">id&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">commitizen &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># commit msg规范检查&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">repo&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">local&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">hooks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">id&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pylint &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 代码静态检查&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pylint&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">entry&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pylint&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">language&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">system&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">types&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="l">python]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="单元测试">单元测试&lt;/h3>
&lt;blockquote>
&lt;p>这个没说的，欠的坑要填上，不然不管是新需求还是重构旧代码心里都没谱&lt;/p>
&lt;/blockquote>
&lt;ol>
&lt;li>核心基础逻辑测试&lt;/li>
&lt;/ol>
&lt;p>这部分其实挺糟心的, 莽荒时期的项目, 既然无单元测试, 那必然写的是非常放飞自我, 业务代码/基础逻辑基本一锅粥, 要想舒服顺利地搞单元测试, 服务分层势在必行, 基本上开始大概就分了四层: 核心逻辑/业务逻辑/接口/数据库&lt;/p>
&lt;ol start="2">
&lt;li>通用业务接口测试 &lt;code>这个优先级比较低&lt;/code>&lt;/li>
&lt;/ol>
&lt;h3 id="db-driver">DB driver&lt;/h3>
&lt;blockquote>
&lt;p>这个巨坑爹，光是把成吨的&lt;code>yield from&lt;/code>换成&lt;code>async/await&lt;/code>都够喝一壶&lt;/p>
&lt;/blockquote>
&lt;ol>
&lt;li>新需求全换&lt;code>gino&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>一个悲伤的事情, 好不容易完成替换半年多以后, SQLAlchemy 这个渣男官宣支持异步了...&lt;/p>
&lt;ol start="2">
&lt;li>旧代码&lt;code>momoko&lt;/code>替换&lt;/li>
&lt;li>删掉&lt;code>momoko&lt;/code>&lt;/li>
&lt;/ol>
&lt;h3 id="类型注释">类型注释&lt;/h3>
&lt;blockquote>
&lt;p>切换 DB driver 的过程中就发现很多方法，特别是一些又臭又长的拼裸 SQL 方法，不头铁挨个找线上环境真实环境测试，你根本不知道自己要改的是啥玩意。&lt;/p>
&lt;/blockquote>
&lt;ol>
&lt;li>新代码复杂逻辑都要求声明类型, 如果费解又做不好抽象, 那必须有 UT&lt;/li>
&lt;li>旧代码改造：单元测试铺路，然后补上类型注释&lt;/li>
&lt;/ol>
&lt;h3 id="python版本升级">Python版本升级&lt;/h3>
&lt;blockquote>
&lt;p>祖师爷都亲自放话未来Python的重心之一是大幅提升性能，我们又有什么理由不跟一下呢？实际上同等条件，仅升级 Python 到&lt;code>3.8.x&lt;/code>的性能提升贡献就超过了百分之五十多。&lt;/p>
&lt;/blockquote>
&lt;h3 id="优化冷启动速度">优化冷启动速度&lt;/h3>
&lt;blockquote>
&lt;p>通过健全代码风格检查规则以及单元测试的保驾护航，我们对项目的架构做了相对更科学的分层处理，优化了超长代码的模块，使得启动时间由&lt;code>8~10&lt;/code>秒缩短至现在的不到&lt;code>2&lt;/code>秒&lt;/p>
&lt;/blockquote>
&lt;h3 id="热重载">热重载&lt;/h3>
&lt;blockquote>
&lt;p>这是运维同事提的需求，对于一个活跃开发的分支环境，&lt;code>CI&lt;/code> 的频繁启停，导致服务不可用的情况时有发生，对业务组的同事非常不友好。关于这部分的折腾，可以看我这里的说明：&lt;a href="https://blog.ferstar.org/post/issue-39">https://github.com/ferstar/blog/issues/39&lt;/a> 其实就是借助&lt;code>gunicorn&lt;/code>实现了&lt;code>HUP signal&lt;/code>的支持。&lt;/p>
&lt;/blockquote>
&lt;h2 id="结论">结论&lt;/h2>
&lt;p>项目运行得更快更稳定，节省大把时间，用来思考人生或者摸鱼？&lt;/p>
&lt;h2 id="教训">教训&lt;/h2>
&lt;p>最大的坑点就是换 ORM 么有做好技术选型, 匆匆选择了 gino, 当时哪怕换个 peewee-async 也比 gino 香啊, 何况 SQLAlchemy 这个渣男人家 blog 上早就把异步支持写进了 roadmap, 当然了, 也没有说 gino 就垃圾, 只是我们用的不爽而已, 比如: xxx.gino.xxx() 这种强烈的个人主义设定, 以及屎一样的 join 支持......&lt;/p>
&lt;blockquote>
&lt;p>下一次重构: 干掉 gino 换 SQLAlchemy!&lt;/p>
&lt;/blockquote>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2021-07-11T14:46:05+08:00
update@2022-01-16T03:42:52+08:00
comment@https://github.com/ferstar/blog/issues/43
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/postgresql/">PostgreSQL</category><category domain="https://blog.ferstar.org/tags/todo/">TODO</category></item><item><title>Deal with a class cell not found runtime error</title><link>https://blog.ferstar.org/post/issue-42/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-42/</guid><pubDate>Sat, 10 Jul 2021 23:11:20 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>When I use &lt;a href="https://github.com/cython">cython&lt;/a> compile my *.py files to *.so, it looks good and no error occurred. But when I run my project it throw out such error exception: &lt;code>RuntimeError: super(): __class__ cell not found&lt;/code>(I'm sure I can run the project from the source code without any problems)&lt;/p>
&lt;p>...debuging...&lt;/p>
&lt;p>After debugging for a few minutes, I found this ancient issue: &lt;a href="https://github.com/cython/cython/issues/1127">https://github.com/cython/cython/issues/1127&lt;/a>&lt;/p>
&lt;p>My goodness, this bug has not been resolved for more than ten years......&lt;/p>
&lt;p>Fortunately, I got a simple solution: &lt;em>roll back the legacy python2 super style&lt;/em>&lt;/p>
&lt;p>And here comes the problems:&lt;/p>
&lt;ol>
&lt;li>How to roll back the py2 super style in batches? I have so many *.py files...&lt;/li>
&lt;li>How to warn team members not to use the py3 super style?&lt;/li>
&lt;/ol>
&lt;p>...coding...&lt;/p>
&lt;p>And here comes the solution:&lt;/p>
&lt;ol>
&lt;li>Because I am lazy, I wrote a script to help me do this:&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;Change py3 super style to py2&amp;#39;s&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">re&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">pathlib&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">Path&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">class_p&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">re&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">compile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">r&lt;/span>&lt;span class="s1">&amp;#39;class (?P&amp;lt;class_name&amp;gt;\w+)[\(:]&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">replace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;r&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">read_file&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">reversed_lines&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">read_file&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">readlines&lt;/span>&lt;span class="p">()[::&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">idx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">line&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">enumerate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">reversed_lines&lt;/span>&lt;span class="p">[:]):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="s1">&amp;#39;super().&amp;#39;&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">line&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">:&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">reversed_lines&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">idx&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cls_str&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;cls&amp;#39;&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="s1">&amp;#39;__new__&amp;#39;&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">line&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="s1">&amp;#39;self&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">above_line&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">reversed_lines&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">idx&lt;/span>&lt;span class="p">:]:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="s1">&amp;#39;@classmethod&amp;#39;&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">line&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cls_str&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;cls&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">continue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">match&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">class_p&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">above_line&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="k">match&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">reversed_lines&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">idx&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">line&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">replace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;super().&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sa">f&lt;/span>&lt;span class="s1">&amp;#39;super(&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">match&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">group&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;class_name&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">, &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">cls_str&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">).&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;w&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">write_file&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">write_file&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">writelines&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">reversed_lines&lt;/span>&lt;span class="p">[::&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="vm">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">file&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">Path&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;.&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">glob&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;**/*.py&amp;#39;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="vm">__file__&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">as_posix&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">replace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="2">
&lt;li>Like most Python projects, we also use &lt;a href="http://pylint.pycqa.org/">pylint&lt;/a> to check the code style, I copied the template and wrote a custom checker:&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;file: py3_style_checker.py&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">astroid&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">pylint&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">checkers&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">interfaces&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">pylint.checkers&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">utils&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">PY3StyleSupperChecker&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">checkers&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">BaseChecker&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">__implements__&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">interfaces&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">IAstroidChecker&lt;/span>&lt;span class="p">,)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;py3-style-super&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">msgs&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;R0711&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Consider using Python 2 style super() within arguments&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;super-without-arguments&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Emitted when calling the super() builtin with the current class &amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;and instance. We need to keep the legacy Python 2 style super to &amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;make the Cython compile correct.&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">options&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">priority&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nd">@utils.check_messages&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;super-without-arguments&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">visit_call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">node&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_check_super_without_arguments&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">_check_super_without_arguments&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">node&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">func&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">astroid&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">or&lt;/span> &lt;span class="n">node&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">func&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">name&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="s2">&amp;#34;super&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">add_message&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;super-without-arguments&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">node&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">register&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">linter&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">linter&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">register_checker&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">PY3StyleSupperChecker&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">linter&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>We need to add the checker's parent directory into current &lt;code>PYTHONPATH&lt;/code>, and run &lt;code>pylint&lt;/code> like this:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ pylint --load-plugins&lt;span class="o">=&lt;/span>py3_style_checker --disable&lt;span class="o">=&lt;/span>all --enable&lt;span class="o">=&lt;/span>super-without-arguments &amp;lt;path_to_your_py_file&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>done!&lt;/p>
&lt;blockquote>
&lt;p>Ref&lt;/p>
&lt;ol>
&lt;li>&lt;a href="http://pylint.pycqa.org/en/latest/how_tos/custom_checkers.html">How to Write a Checker&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/cython/cython/issues/1127">super doesn't work with cpdef methods&lt;/a>&lt;/li>
&lt;/ol>
&lt;/blockquote>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2021-07-10T23:11:20+08:00
update@2021-07-10T23:23:59+08:00
comment@https://github.com/ferstar/blog/issues/42
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>Git lfs将某个文件回退到任意历史oid</title><link>https://blog.ferstar.org/post/issue-41/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-41/</guid><pubDate>Tue, 11 May 2021 04:11:25 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>最近对项目做了一个比较大的架构调整, 某个dev分支的一个单元测试数据乱入到stable分支, 导致单元测试失败, 所以需要把stable分支的测试样例bin回退到以前旧的版本&lt;/p>
&lt;/blockquote>
&lt;p>我们二进制数据是用lfs管理的, 所以并不能通过简单的git revert处理, 最终Google一通解决, 简单记录下.&lt;/p>
&lt;p>假定这个文件叫&lt;code>data/tests/test.bin&lt;/code>, 需要回退的commit id是&lt;code>074bf35a&lt;/code>, 那么首先需要获取他的&lt;code>lfs oid&lt;/code>&lt;/p>
&lt;p>&lt;code>git cat-file -p '074bf35a:data/tests/test.bin&lt;/code>输出如下:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">version https://git-lfs.github.com/spec/v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">oid sha256:ed60a8c13728a47db0e8789ce9b20dc212a92fd0d0fb306fd4007b9aa6dd6b57
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">size &lt;span class="m">32731432&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>拿到oid以后, 从lfs缓存中把旧数据拷贝出来&lt;/p>
&lt;p>&lt;code>cp .git/lfs/objects/ed/60/ed60a8c13728a47db0e8789ce9b20dc212a92fd0d0fb306fd4007b9aa6dd6b57 data/tests/test.bin&lt;/code>&lt;/p>
&lt;p>然后把这个旧数据重新push到repo即可&lt;/p>
&lt;p>可能的问题:&lt;/p>
&lt;ol>
&lt;li>本地环境可能没有旧的oid缓存, 需要从远端拉取一下: &lt;code>git lfs fetch --include=data/tests/test.bin&lt;/code>&lt;/li>
&lt;li>远端环境(CI)可能取不到这个oid, 这就需要从本地重推一次: &lt;code>git lfs push origin --object-id ed60a8c13728a47db0e8789ce9b20dc212a92fd0d0fb306fd4007b9aa6dd6b57&lt;/code>&lt;/li>
&lt;/ol>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2021-05-11T04:11:25+08:00
update@2021-11-20T03:33:35+08:00
comment@https://github.com/ferstar/blog/issues/41
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/git/">Git</category></item><item><title>Find the row count for all tables in Postgres</title><link>https://blog.ferstar.org/post/issue-40/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-40/</guid><pubDate>Fri, 07 May 2021 04:03:57 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>via &lt;a href="https://stackoverflow.com/a/2611745">https://stackoverflow.com/a/2611745&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>total count&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="line">&lt;span class="cl">&lt;span class="k">SELECT&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">sum&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">reltuples&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pg_class&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">C&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">LEFT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">JOIN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pg_namespace&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">N&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">N&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">oid&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">C&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">relnamespace&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">nspname&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">IN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;pg_catalog&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;information_schema&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AND&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">relkind&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;r&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>summary details&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="line">&lt;span class="cl">&lt;span class="k">SELECT&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">nspname&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">schemaname&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">relname&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">reltuples&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pg_class&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">C&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">LEFT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">JOIN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pg_namespace&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">N&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">N&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">oid&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">C&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">relnamespace&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">nspname&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">IN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;pg_catalog&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;information_schema&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AND&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">relkind&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;r&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">ORDER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">BY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">reltuples&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DESC&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2021-05-07T04:03:57+08:00
update@2021-05-07T04:04:24+08:00
comment@https://github.com/ferstar/blog/issues/40
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/postgresql/">PostgreSQL</category></item><item><title>Fix TypeError: call() takes 2 positional arguments but 3 were given</title><link>https://blog.ferstar.org/post/issue-39/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-39/</guid><pubDate>Tue, 23 Mar 2021 01:54:07 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>用&lt;code>gunicorn&lt;/code>启动一个&lt;code>tornado&lt;/code>服务时报了个错:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>ERROR&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>MainThread&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>http1connection:67&lt;span class="o">)&lt;/span> Uncaught exception
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Traceback &lt;span class="o">(&lt;/span>most recent call last&lt;span class="o">)&lt;/span>:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> File &lt;span class="s2">&amp;#34;/Users/ferstar/.pyenv/versions/scriber/lib/python3.6/site-packages/tornado/http1connection.py&amp;#34;&lt;/span>, line 273, in _read_message
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> delegate.finish&lt;span class="o">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> File &lt;span class="s2">&amp;#34;/Users/ferstar/.pyenv/versions/scriber/lib/python3.6/site-packages/tornado/httpserver.py&amp;#34;&lt;/span>, line 280, in finish
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> self.request_callback&lt;span class="o">(&lt;/span>self.request&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> File &lt;span class="s2">&amp;#34;/Users/ferstar/.pyenv/versions/scriber/lib/python3.6/site-packages/tornado/wsgi.py&amp;#34;&lt;/span>, line 114, in __call__
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> WSGIContainer.environ&lt;span class="o">(&lt;/span>request&lt;span class="o">)&lt;/span>, start_response
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">TypeError: __call__&lt;span class="o">()&lt;/span> takes &lt;span class="m">2&lt;/span> positional arguments but &lt;span class="m">3&lt;/span> were given
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>调试发现是&lt;a href="https://github.com/benoitc/gunicorn/blob/master/gunicorn/workers/gtornado.py#L113">这行代码&lt;/a>的问题:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Assume the app is a WSGI callable if its not an&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># instance of tornado.web.Application or is an&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># instance of tornado.wsgi.WSGIApplication&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">app&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">wsgi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">tornado&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">version_info&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">6&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">app&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tornado&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">web&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Application&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">or&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">app&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tornado&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">wsgi&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">WSGIApplication&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">app&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">WSGIContainer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">app&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">app&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">WSGIContainer&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">app&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">WSGIContainer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">app&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>我用的 tornado 版本是&lt;code>6.1&lt;/code>, 可以看到, &lt;code>web.Application&lt;/code>被&lt;code>WSGIContainer&lt;/code>包了一层, 实际上&lt;code>tornado&lt;/code>自&lt;code>6.0&lt;/code>以后的版本中有意在剥离&lt;code>WSGI&lt;/code>的支持, 所以比较苟的一个解决方法是退回到&lt;code>6.0&lt;/code>之前的版本, 比如&lt;code>5.1.1&lt;/code>, 即可正常; 然而作为一个有追求的攻城狮, 怎么能够因为一个小小的兼容问题就退版本号呢, 我选择硬肛, 既然&lt;code>gunicorn&lt;/code>自己的&lt;code>tornado worker&lt;/code>不能用, 那就照抄另写一个:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;span class="lnt">107
&lt;/span>&lt;span class="lnt">108
&lt;/span>&lt;span class="lnt">109
&lt;/span>&lt;span class="lnt">110
&lt;/span>&lt;span class="lnt">111
&lt;/span>&lt;span class="lnt">112
&lt;/span>&lt;span class="lnt">113
&lt;/span>&lt;span class="lnt">114
&lt;/span>&lt;span class="lnt">115
&lt;/span>&lt;span class="lnt">116
&lt;/span>&lt;span class="lnt">117
&lt;/span>&lt;span class="lnt">118
&lt;/span>&lt;span class="lnt">119
&lt;/span>&lt;span class="lnt">120
&lt;/span>&lt;span class="lnt">121
&lt;/span>&lt;span class="lnt">122
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># This file is part of gunicorn released under the MIT license.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># See the NOTICE for more information.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># filename: gtornado.py&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">copy&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">gettext&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">logging.config&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">os&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">sys&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">gunicorn.workers.base&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">Worker&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">tornado&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">tornado.httpserver&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">tornado.web&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">tornado.ioloop&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">IOLoop&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PeriodicCallback&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">TornadoWorker&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Worker&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">handle_exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sig&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">frame&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">alive&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">super&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">handle_exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sig&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">frame&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">handle_request&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">nr&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">alive&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">nr&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">max_requests&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">log&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Autorestarting worker after current request.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">alive&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">False&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">watchdog&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">alive&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">notify&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ppid&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">getppid&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">log&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Parent changed, shutting down: &lt;/span>&lt;span class="si">%s&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">alive&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">False&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">heartbeat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">alive&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">server_alive&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">hasattr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;server&amp;#39;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">server&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">stop&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span> &lt;span class="ne">Exception&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="c1"># pylint: disable=broad-except&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">pass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">server_alive&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">False&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">callback&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">callbacks&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">callback&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">stop&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ioloop&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">stop&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">init_process&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># IOLoop cannot survive a fork or be shared across processes&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># in any way. When multiple processes are being used, each process&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># should create its own IOLoop. We should clear current IOLoop&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># if exists before os.fork.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">IOLoop&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">clear_current&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">super&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">init_process&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ioloop&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">IOLoop&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">current&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">alive&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">True&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">server_alive&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">False&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">callbacks&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">callbacks&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">PeriodicCallback&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">watchdog&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">callbacks&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">PeriodicCallback&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">heartbeat&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">callback&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">callbacks&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">callback&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">start&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Assume the app is a WSGI callable if its not an&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># instance of tornado.web.Application or is an&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># instance of tornado.wsgi.WSGIApplication&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">app&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">wsgi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Monkey-patching HTTPConnection.finish to count the&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># number of requests being handled by Tornado. This&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># will help gunicorn shutdown the worker if max_requests&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># is exceeded.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">httpserver&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">modules&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;tornado.httpserver&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">hasattr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">httpserver&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;HTTPConnection&amp;#39;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">old_connection_finish&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">httpserver&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">HTTPConnection&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">finish&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">finish&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">other&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">handle_request&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">old_connection_finish&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">other&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">httpserver&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">HTTPConnection&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">finish&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">finish&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">modules&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;tornado.httpserver&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">httpserver&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">server_class&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tornado&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">httpserver&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">HTTPServer&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">class&lt;/span> &lt;span class="nc">_HTTPServer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tornado&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">httpserver&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">HTTPServer&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">on_close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">server_conn&lt;/span>&lt;span class="p">):&lt;/span> &lt;span class="c1"># pylint: disable=no-self-argument&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">handle_request&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">super&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">_HTTPServer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">instance&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">on_close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">server_conn&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">server_class&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">_HTTPServer&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">app_params&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;max_buffer_size&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">200&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">1024&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">1024&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1"># 200MB&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;decompress_request&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">True&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cfg&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">is_ssl&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">_ssl_opt&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">copy&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">deepcopy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cfg&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ssl_options&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># tornado refuses initialization if ssl_options contains following&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># options&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">del&lt;/span> &lt;span class="n">_ssl_opt&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;do_handshake_on_connect&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">del&lt;/span> &lt;span class="n">_ssl_opt&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;suppress_ragged_eofs&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">app_params&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;ssl_options&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">_ssl_opt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">server&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">server_class&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">app&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">app_params&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">server&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">server&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">server_alive&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">True&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">socket&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sockets&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">socket&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">setblocking&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">server&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">add_socket&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">socket&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">server&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">no_keep_alive&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cfg&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">keepalive&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">server&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">start&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">num_processes&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ioloop&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">start&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>主要就是直接丢掉&lt;code>WSGIContainer&lt;/code>, 使用&lt;code>tornado.web.Application&lt;/code>, 然后运行:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">gunicorn -k gtornado.TornadoWorker main:app -b 0.0.0.0:8080 --graceful-timeout &lt;span class="m">120&lt;/span> --timeout &lt;span class="m">600&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>发送个&lt;code>HUP&lt;/code>信号看看反应, 嗯, 顺利重载&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> Starting gunicorn 20.1.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> Listening at: http://0.0.0.0:8080 &lt;span class="o">(&lt;/span>51702&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> Using worker: gtornado.TornadoWorker
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> Booting worker with pid: &lt;span class="m">51756&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> Handling signal: hup &lt;span class="c1"># 收到信号&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> Hang up: Master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> Booting worker with pid: &lt;span class="m">52640&lt;/span> &lt;span class="c1"># 顺利重载&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> Worker exiting &lt;span class="o">(&lt;/span>pid: 51756&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>附上测试代码:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># filename: main.py&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">asyncio&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">tornado.web&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">Application&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">RequestHandler&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">MainHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">RequestHandler&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Hello, world&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">LongPollHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">RequestHandler&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">async&lt;/span> &lt;span class="k">def&lt;/span> &lt;span class="nf">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lines&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;line 1&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;line 2&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">line&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">lines&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">line&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">await&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">flush&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">await&lt;/span> &lt;span class="n">asyncio&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">0.5&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">await&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">finish&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">app&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Application&lt;/span>&lt;span class="p">([&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="sa">r&lt;/span>&lt;span class="s2">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MainHandler&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="sa">r&lt;/span>&lt;span class="s2">&amp;#34;/longpoll&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">LongPollHandler&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2021-03-23T01:54:07+08:00
update@2021-11-09T11:07:43+08:00
comment@https://github.com/ferstar/blog/issues/39
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/tornado/">Tornado</category><category domain="https://blog.ferstar.org/tags/gunicorn/">Gunicorn</category></item><item><title>dyld: Library not loaded: /usr/local/opt/icu4c/lib/libicui18n.67.dylib</title><link>https://blog.ferstar.org/post/issue-38/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-38/</guid><pubDate>Fri, 05 Mar 2021 02:33:26 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>起pg的时候报了这么个错&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">pg_ctl: another server might be running&lt;span class="p">;&lt;/span> trying to start server anyway
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dyld: Library not loaded: /usr/local/opt/icu4c/lib/libicui18n.67.dylib
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Referenced from: /usr/local/Cellar/postgresql/13.1/bin/postgres
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Reason: image not found
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">no data was returned by &lt;span class="nb">command&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>/usr/local/Cellar/postgresql/13.1/bin/postgres&lt;span class="s2">&amp;#34; -V&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">The program &lt;span class="s2">&amp;#34;postgres&amp;#34;&lt;/span> is needed by pg_ctl but was not found in the
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">same directory as &lt;span class="s2">&amp;#34;/usr/local/Cellar/postgresql/13.1/bin/pg_ctl&amp;#34;&lt;/span>.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Check your installation.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>看样子是&lt;code>brew&lt;/code>更新把&lt;code>icu4c&lt;/code>这个包搞挂了, 所以解决也很简单, 卸了重装即可&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">brew uninstall --ignore-dependencies icu4c postgresql
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">brew install postgresql
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2021-03-05T02:33:26+08:00
update@2021-03-05T02:33:40+08:00
comment@https://github.com/ferstar/blog/issues/38
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/postgresql/">PostgreSQL</category><category domain="https://blog.ferstar.org/tags/macos/">macOS</category></item><item><title>Using COUNT(*) OVER() in current query with SQLAlchemy over PostgreSQL</title><link>https://blog.ferstar.org/post/issue-37/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-37/</guid><pubDate>Fri, 19 Feb 2021 02:56:17 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>via &lt;a href="https://stackoverflow.com/a/5215028">https://stackoverflow.com/a/5215028&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>So I could not find any examples in the SQLAlchemy documentation, but I found these functions:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="http://docs.sqlalchemy.org/en/latest/core/metadata.html?highlight=label#sqlalchemy.schema.Column.label">&lt;code>count()&lt;/code>&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://docs.sqlalchemy.org/en/latest/core/metadata.html?highlight=label#sqlalchemy.schema.Column.label">&lt;code>over()&lt;/code>&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://docs.sqlalchemy.org/en/latest/core/metadata.html?highlight=label#sqlalchemy.schema.Column.label">&lt;code>label()&lt;/code>&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>And I managed to combine them to produce exactly the result I was looking for:&lt;/p>
&lt;pre tabindex="0">&lt;code>from sqlalchemy import func
query = session.query(Guest, func.count(Guest.id).over().label(&amp;#39;total&amp;#39;))
query = query.filter(Guest.deleted == None)
query = query.order_by(Guest.id.asc())
query = query.offset(0)
query = query.limit(50)
result = query.all()
&lt;/code>&lt;/pre>&lt;p>Cheers!&lt;/p>
&lt;p>P.S. I also found this &lt;a href="https://stackoverflow.com/questions/27510382/python-sqlalchemy-query-using-labeled-over-clause-with-orm">question on Stack Overflow&lt;/a>, which was unanswered.&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2021-02-19T02:56:17+08:00
update@2021-02-19T02:56:31+08:00
comment@https://github.com/ferstar/blog/issues/37
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/postgresql/">PostgreSQL</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>Lenovo XiaoXinPro13 2109 hackintosh</title><link>https://blog.ferstar.org/post/issue-36/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-36/</guid><pubDate>Sun, 14 Feb 2021 14:47:15 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;h2 id="电脑配置">电脑配置&lt;/h2>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:center">规格&lt;/th>
&lt;th style="text-align:center">详细信息&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:center">电脑型号&lt;/td>
&lt;td style="text-align:center">联想小新pro13 2019笔记本电脑&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">操作系统&lt;/td>
&lt;td style="text-align:center">11.2 (20D64)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">处理器&lt;/td>
&lt;td style="text-align:center">英特尔 酷睿 i7-10710U&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">内存&lt;/td>
&lt;td style="text-align:center">16GB板载无法更换&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">硬盘&lt;/td>
&lt;td style="text-align:center">&lt;del>原装三星981A 512GB&lt;/del> 更换为 三星PM961 1TB&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">显卡&lt;/td>
&lt;td style="text-align:center">Intel HD Graphics CFL CRB（UHD620）&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">显示器&lt;/td>
&lt;td style="text-align:center">13.3 英寸 IPS 2560x1600 华星光电&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">声卡&lt;/td>
&lt;td style="text-align:center">Realtek ALC257&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">网卡&lt;/td>
&lt;td style="text-align:center">&lt;del>原装Intel AX201NGW&lt;/del> 更换为 BCM94360CS2(需加转接卡)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">SMBIOS&lt;/td>
&lt;td style="text-align:center">MacBookPro16,2&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="使用说明请仔细阅读">使用说明【请仔细阅读】&lt;/h2>
&lt;h3 id="注意">注意&lt;/h3>
&lt;ul>
&lt;li>强烈建议不要使用&lt;code>OpenCore Configurator&lt;/code>来修改&lt;code>config.plist&lt;/code> &lt;code>OpenCore Configurator&lt;/code>更新缓慢与&lt;code>OpenCore&lt;/code>版本不匹配，推荐使用&lt;code>ProperTree&lt;/code>
&lt;ul>
&lt;li>Win下修改&lt;code>config.plist&lt;/code>请下载群文件&lt;code>ProperTree中文版-WIN&lt;/code>来修改&lt;code>config.plist&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>小新由于安装过程中触摸板可能无法驱动，使用U盘安装macOS会占用仅仅一个USB接口,建议安装之前先买个usb拓展,用于插入鼠标,来进行安装步骤选项设定。&lt;/li>
&lt;li>安装或更新系统完成后请使用&lt;code>终端&lt;/code>输入&lt;code>sudo kextcache -i /&lt;/code>清理缓存并重启，触控板才能正常使用&lt;/li>
&lt;/ul>
&lt;h3 id="biso设置-重要">BISO设置 【重要】&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>需要更新&lt;code>BIOS&lt;/code>【重要】&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://pan.baidu.com/s/1bNwPFp6RHZvGNAaPx_IcJA">&lt;code>BIOS&lt;/code>下载&lt;/a> 密码: dpoe&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>解锁 &lt;code>DVMT&lt;/code> 、 &lt;code>CFG&lt;/code> 【或参考@Donald 《修改DVMT Pre-Allocated数值方法》】&lt;/p>
&lt;ul>
&lt;li>&lt;code>DVMT&lt;/code> =&lt;code>64M&lt;/code>;位置:&lt;code>Advanced&lt;/code> -&amp;gt;&lt;code> System Agent&lt;/code> -&amp;gt; &lt;code>Graphics Configura&lt;/code> -&amp;gt; &lt;code>DVMT Pre- Allocated&lt;/code> 【重要】&lt;/li>
&lt;li>&lt;code>CFG&lt;/code> =&lt;code>disable&lt;/code>;位置:&lt;code>Advanced&lt;/code> -&amp;gt; &lt;code>Power Performanc&lt;/code> -&amp;gt; &lt;code>CPU Power Manage&lt;/code> -&amp;gt; &lt;code>CPU Lock Configura&lt;/code>【重要】&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Security &lt;/code>【重要】&lt;/p>
&lt;ul>
&lt;li>&lt;code>Intel Platform Trust Technology &lt;/code>= &lt;code>Disable&lt;/code>&lt;/li>
&lt;li>&lt;code>Intel SGX Control&lt;/code> = &lt;code>Disable&lt;/code> 【建议】&lt;/li>
&lt;li>&lt;code>Secure Boot&lt;/code> =&lt;code>Disable&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="smbios">SMBIOS&lt;/h3>
&lt;ul>
&lt;li>默认 &lt;code>MacBookPro16,2&lt;/code>
&lt;ul>
&lt;li>使用其它机型&lt;code>SMBIOS&lt;/code>时请修改&lt;code>USBPorts.kext&lt;/code>-&lt;code>Contents&lt;/code>-&lt;code>Info.plist&lt;/code>
&lt;img src="https://user-images.githubusercontent.com/2854276/107879595-bc0e1280-6f14-11eb-8a16-f21c7896b2df.png" alt="image">&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="关闭触摸板快捷键">关闭触摸板快捷键&lt;/h3>
&lt;ul>
&lt;li>组合键: FN+F6&lt;/li>
&lt;/ul>
&lt;h3 id="唤醒方法">唤醒方法&lt;/h3>
&lt;ul>
&lt;li>电源键&lt;/li>
&lt;/ul>
&lt;h3 id="不正常工作">不正常工作&lt;/h3>
&lt;ul>
&lt;li>&lt;del>睡眠&lt;/del> (小新PRO13不能真正睡眠，可以仿真睡眠。唤醒比较困难，&lt;code>OC&lt;/code> 下唤醒方法是：&lt;code>电源键&lt;/code>唤醒)&lt;/li>
&lt;li>声卡MIC(&lt;code>暂时解决方法&lt;/code>：启动台-声音-输入：手动切换到“&lt;code>外接可用麦克风设备&lt;/code>”)&lt;/li>
&lt;/ul>
&lt;details>
&lt;summary>关于 小新PRO13(2019/2020/13S Intel版本) 没有S3睡眠延展&lt;/summary>
&lt;p>D0 就是正常工作状态，S0 是 D0 的电源管理，S0睡眠应该是不存在的，说 S0 睡眠，本质就是 D0 状态下进入了空闲，所以有了空闲状态下的电源管理，这个机器没有 S3睡眠，没有设计相关硬件&lt;/p>
&lt;p>但因 ACPI 有了 S3才导致苹果试图进入睡眠，但因缺少必须的硬件最终失败，对于 Windows 不妨碍&lt;/p>更详细的说明移步&lt;a href="https://github.com/daliansky/OC-little/tree/master/01-%E5%85%B3%E4%BA%8EAOAC" target="_blank">OC-little&lt;/a>
&lt;p>实测选择省电的SSD可有效延长待机时间。如：三星PM961+BCM94360CS2并使用SleepWithoutBluetoothAndWifi盒盖一小时耗电仅需0.86%，而西数SN750+BCM94360CS2并使用SleepWithoutBluetoothAndWif则需要3%每小时&lt;/p>
&lt;/details>
&lt;h3 id="哪些可以工作更好">哪些可以工作更好&lt;/h3>
&lt;ul>
&lt;li>开启 &lt;a href="https://github.com/xzhih/one-key-hidpi">HIDPI&lt;/a> 来提升系统UI质量, &lt;code>可能会出现花屏现象&lt;/code>&lt;/li>
&lt;/ul>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>AAPL,ig-platform-id&lt;/th>
&lt;th>device-id&lt;/th>
&lt;th>备注&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>0500A53E&lt;/td>
&lt;td>A53E0000&lt;/td>
&lt;td>解决i7-10710u花屏/闪屏&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>0400A53E&lt;/td>
&lt;td>A53E0004&lt;/td>
&lt;td>解决i7-10710u花屏/闪屏&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>0500A63E&lt;/td>
&lt;td>A63E0000&lt;/td>
&lt;td>通用&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="镜像下载">镜像下载&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://blog.daliansky.net/categories/%E4%B8%8B%E8%BD%BD/%E9%95%9C%E5%83%8F/">[&lt;strong>黑果小兵的部落阁&lt;/strong>] :【黑果小兵】原版镜像&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="感谢">感谢&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>本EFI所使用的&lt;code>ACPI&lt;/code>均来自 @宪武 大佬&lt;/p>
&lt;/li>
&lt;li>
&lt;p>daliansky黑果小兵&lt;/p>
&lt;/li>
&lt;li>
&lt;p>感谢PS@Donald提供的解锁&lt;code>DVMT&lt;/code> &lt;code>CFG lock&lt;/code>工具&lt;/p>
&lt;/li>
&lt;li>
&lt;p>感谢群友QQ876310253提供的&lt;code>解锁dvmt及cfglock.docx&lt;/code>教程&lt;/p>
&lt;/li>
&lt;li>
&lt;p>感谢群友Dreamn提供的&lt;a href="https://github.com/dreamncn/SleepWithoutBluetoothAndWifi">&lt;code>SleepWithoutBluetoothAndWifi&lt;/code>&lt;/a>工具&lt;/p>
&lt;p>......&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="本人自用efi">本人自用EFI&lt;/h2>
&lt;p>&lt;a href="https://github.com/ferstar/blog/files/5977914/EFI.zip">点击下载-&amp;gt;&amp;gt;EFI.zip&amp;lt;&amp;lt;-&lt;/a>&lt;/p>
&lt;ol>
&lt;li>机型&lt;code>MacBookPro16,2&lt;/code>&lt;/li>
&lt;li>添加&lt;code>CPUFriend&lt;/code>以改善变频效果&lt;code>实测10710U单核可跑到4.7GHz&lt;/code> - &lt;a href="https://browser.geekbench.com/v5/cpu/6501218">附GeekBench5跑分&lt;/a>&lt;/li>
&lt;li>&lt;code>Scan Policy配置为524547&lt;/code>仅扫描并引导macOS&lt;/li>
&lt;li>&lt;code>Show Picker=False&lt;/code>, 跳过OC引导菜单直接进入系统&lt;/li>
&lt;li>三码为空, 需要自行修改适配&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>意外发现还保留了当年卡特琳娜的跑分记录, 当时用的型号是&lt;code>MacBookAir9,1&lt;/code>, 看起来单核能跑4.7GHz对于跑分而言, 意义不大&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>&lt;a href="https://browser.geekbench.com/v5/cpu/compare/2194367?baseline=6535363">https://browser.geekbench.com/v5/cpu/compare/2194367?baseline=6535363&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://user-images.githubusercontent.com/2854276/108083812-708f6c00-70ae-11eb-8d1c-b316e2658909.png" alt="image">&lt;/p>
&lt;p>养老了养老了, 受不了 bugsur, 果断退回Catalina, 本子宛如新生, 香~&lt;/p>
&lt;p>PS: 时光机恢复了两遍才恢复成功, 先是用 bigsur 的 recovery 恢复, 结果卡苹果, 万幸重启以后变成 Catalina 的 recovery 了, 忐忑之中又恢复了一把, 搞定&lt;/p>
&lt;h2 id="零散tips">零散tips&lt;/h2>
&lt;ol>
&lt;li>解锁网卡区域设置: boot-args: brcmfx-country=#a&lt;/li>
&lt;li>igfxonln=1, igfxrpsc=1 两个同时配置boot-args参数会偶发核显满频不降&lt;code>Intel Power Gadget -&amp;gt; GFX/AVG 5.xx&lt;/code>, 我只保留了&lt;code>igfxrpsc=1&lt;/code>, 据说能稍微提升一点点垃圾核显的性能&lt;/li>
&lt;/ol>
&lt;h2 id="散热改造">散热改造&lt;/h2>
&lt;ol>
&lt;li>换导热硅脂&lt;code>传说中的信越7921&lt;/code>, 作用: 增强CPU&amp;amp;GPU散热&lt;/li>
&lt;li>加装硅脂垫&lt;code>利民80x40x2mm&lt;/code>, 作用: 及时将热量导出到D面&lt;/li>
&lt;/ol>
&lt;p>效果对比:&lt;/p>
&lt;ul>
&lt;li>未改造前, R23多核测试第一轮从55W掉到38W, 全程稳定35W+, 核心最高温度100°, C面60°+, D面50°+&lt;/li>
&lt;li>单换硅脂, R23多核测试第一轮稳定55W, 全程稳定45W+, 核心最高温度98°, C面55°+, D面58°+&lt;/li>
&lt;li>加装硅脂垫, R23多核测试第一轮稳定56W, 全程稳定48W+, 核心最高温度96°, C面45°+, D面62°+&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>最终不到一百块的成本(硅脂+硅脂垫), CPU性能释放从官方默认35W提升到48W的水平, 也就是所谓的PL1提升了13W, 而PL2则可以干到56W的水平, 简直超值, 再战三年不是梦...同时因为增强了散热, 跑分/重负载任务一旦结束, 温度会迅速降低到正常水平&lt;/p>
&lt;/blockquote>
&lt;p>附导热垫放置图:&lt;/p>
&lt;p>&lt;img src="https://user-images.githubusercontent.com/2854276/122636006-88890200-d119-11eb-88a8-1991f5aa9ad4.png" alt="image">&lt;/p>
&lt;p>首轮R23跑分功耗&amp;amp;温度图(单换硅脂, 未加硅脂垫)&lt;/p>
&lt;p>&lt;img src="https://user-images.githubusercontent.com/2854276/122636021-a48ca380-d119-11eb-97b1-fd0bd498ad71.png" alt="image">&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2021-02-14T14:47:15+08:00
update@2021-06-19T08:22:21+08:00
comment@https://github.com/ferstar/blog/issues/36
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/macos/">macOS</category></item><item><title>Use pyenv to build a full functional Python interpreter on macOS Big Sur(11.1)</title><link>https://blog.ferstar.org/post/issue-35/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-35/</guid><pubDate>Fri, 22 Jan 2021 04:57:41 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;ul>
&lt;li>no build errors&lt;/li>
&lt;li>&lt;code>tkinter&lt;/code> module enabled&lt;/li>
&lt;li>openssl from homebrew&lt;/li>
&lt;li>CPython with Framework support&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">brew install zlib bzip2 tcl-tk openssl
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">py_version&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;3.6.11&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">CFLAGS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;-I&lt;/span>&lt;span class="k">$(&lt;/span>brew --prefix openssl&lt;span class="k">)&lt;/span>&lt;span class="s2">/include -I&lt;/span>&lt;span class="k">$(&lt;/span>brew --prefix bzip2&lt;span class="k">)&lt;/span>&lt;span class="s2">/include -I&lt;/span>&lt;span class="k">$(&lt;/span>brew --prefix readline&lt;span class="k">)&lt;/span>&lt;span class="s2">/include -I&lt;/span>&lt;span class="k">$(&lt;/span>xcrun --show-sdk-path&lt;span class="k">)&lt;/span>&lt;span class="s2">/usr/include -I&lt;/span>&lt;span class="k">$(&lt;/span>brew --prefix tcl-tk&lt;span class="k">)&lt;/span>&lt;span class="s2">/include&amp;#34;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>&lt;span class="nv">LDFLAGS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;-L&lt;/span>&lt;span class="k">$(&lt;/span>brew --prefix openssl&lt;span class="k">)&lt;/span>&lt;span class="s2">/lib -L&lt;/span>&lt;span class="k">$(&lt;/span>brew --prefix readline&lt;span class="k">)&lt;/span>&lt;span class="s2">/lib -L&lt;/span>&lt;span class="k">$(&lt;/span>brew --prefix zlib&lt;span class="k">)&lt;/span>&lt;span class="s2">/lib -L&lt;/span>&lt;span class="k">$(&lt;/span>brew --prefix bzip2&lt;span class="k">)&lt;/span>&lt;span class="s2">/lib -L&lt;/span>&lt;span class="k">$(&lt;/span>brew --prefix tcl-tk&lt;span class="k">)&lt;/span>&lt;span class="s2">/lib&amp;#34;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>&lt;span class="nv">PYTHON_CONFIGURE_OPTS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;--with-tcltk-includes=&amp;#39;-I/usr/local/opt/tcl-tk/include&amp;#39; --with-tcltk-libs=&amp;#39;-L/usr/local/opt/tcl-tk/lib -ltcl8.6 -ltk8.6&amp;#39; --enable-framework&amp;#34;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>pyenv install --patch &lt;span class="nv">$py_version&lt;/span> &amp;lt; &amp;lt;&lt;span class="o">(&lt;/span>curl -sSL https://github.com/python/cpython/commit/8ea6353.patch&lt;span class="se">\?&lt;/span>full_index&lt;span class="se">\=&lt;/span>1&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>output:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">pyenv install --patch 3.6.11 &amp;lt; &amp;lt;&lt;span class="o">(&lt;/span>curl -sSL https://github.com/python/cpython/commit/8ea6353.patch&lt;span class="se">\?&lt;/span>full_index&lt;span class="se">\=&lt;/span>1&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">python-build: use openssl@1.1 from homebrew
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">python-build: use readline from homebrew
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Downloading Python-3.6.11.tar.xz...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-&amp;gt; https://www.python.org/ftp/python/3.6.11/Python-3.6.11.tar.xz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Installing Python-3.6.11...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">patching file Misc/NEWS.d/next/macOS/2020-06-24-13-51-57.bpo-41100.mcHdc5.rst
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">patching file configure
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Hunk &lt;span class="c1">#1 succeeded at 3375 (offset -51 lines).&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">patching file configure.ac
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Hunk &lt;span class="c1">#1 succeeded at 495 (offset -15 lines).&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">python-build: use readline from homebrew
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">python-build: use zlib from xcode sdk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Installed Python-3.6.11 to /Users/ferstar/.pyenv/versions/3.6.11
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>test &lt;code>tkinter&lt;/code> module&lt;/p>
&lt;p>&lt;code>python -m tkinter -c 'tkinter._test()'&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://user-images.githubusercontent.com/2854276/105448243-e4597700-5cb0-11eb-8c6a-90105ee869cd.png" alt="image">&lt;/p>
&lt;p>references&lt;/p>
&lt;ol>
&lt;li>&lt;a href="https://stackoverflow.com/a/60469203">https://stackoverflow.com/a/60469203&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/pyenv/pyenv/issues/1375#issuecomment-549754431">https://github.com/pyenv/pyenv/issues/1375#issuecomment-549754431&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/pyenv/pyenv/wiki#which-shell-startup-file-do-i-put-pyenv-config-in">https://github.com/pyenv/pyenv/wiki#which-shell-startup-file-do-i-put-pyenv-config-in&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/pyenv/pyenv/issues/1737#issuecomment-738080459">https://github.com/pyenv/pyenv/issues/1737#issuecomment-738080459&lt;/a>&lt;/li>
&lt;/ol>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
created_date: 2021-01-22T04:57:41+08:00
update_date: 2021-02-12T22:03:34+08:00
comment_url: https://github.com/ferstar/blog/issues/35
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/macos/">macOS</category></item><item><title>Compiling Python with latest OpenSSL on earlier version macOS</title><link>https://blog.ferstar.org/post/issue-34/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-34/</guid><pubDate>Thu, 21 Jan 2021 23:48:52 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>I used to write some Python scripts, and some of them crashed when run on earlier version of macOS(&amp;lt;10.15.x).&lt;/p>
&lt;p>A typical exception may like this:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">urllib3.exceptions.MaxRetryError: HTTPSConnectionPool&lt;span class="o">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">host&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;xxx.com&amp;#39;&lt;/span>, &lt;span class="nv">port&lt;/span>&lt;span class="o">=&lt;/span>443&lt;span class="o">)&lt;/span>: Max retries exceeded with url: /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>Caused by SSLError&lt;span class="o">(&lt;/span>SSLError&lt;span class="o">(&lt;/span>1, &lt;span class="s1">&amp;#39;[SSL: TLSV1_ALERT_PROTOCOL_VERSION]
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">tlsv1 alert protocol version (_ssl.c:720)&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>,&lt;span class="o">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>This was caused by macOS using an outdated OpenSSL version.&lt;/p>
&lt;p>I found &lt;a href="https://fman.io/blog/battling-with-macos/#appendix">this page&lt;/a> on Google and follow these steps to solve the problem:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">brew update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">brew install openssl
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># brew install pyenv # I skipped this line because I used pyenv too&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">PYTHON_CONFIGURE_OPTS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;--enable-shared&amp;#34;&lt;/span> &lt;span class="nv">CFLAGS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;-I&lt;/span>&lt;span class="k">$(&lt;/span>brew --prefix openssl&lt;span class="k">)&lt;/span>&lt;span class="s2">/include&amp;#34;&lt;/span> &lt;span class="nv">LDFLAGS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;-L&lt;/span>&lt;span class="k">$(&lt;/span>brew --prefix openssl&lt;span class="k">)&lt;/span>&lt;span class="s2">/lib&amp;#34;&lt;/span> pyenv install 3.6.9
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>After using this newly compiled Python interpreter, the problem disappeared&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
created_date: 2021-01-21T23:48:52+08:00
update_date: 2021-02-12T21:44:52+08:00
comment_url: https://github.com/ferstar/blog/issues/34
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/macos/">macOS</category></item><item><title>修复Fcitx输入法文字候选框在PyCharm中无法跟随光标问题</title><link>https://blog.ferstar.org/post/issue-33/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-33/</guid><pubDate>Wed, 30 Dec 2020 10:25:21 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;ul>
&lt;li>症状：搜狗输入法文字候选框一直在窗口的左下角，根本看不见候选，只能盲打&lt;/li>
&lt;li>系统：&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>大概JB也知道自家runtime坑了，所以不知从哪个版本开始支持更换自定义的runtime，所以事情就变得更简单了： 下载合适的runtime换一下就行OK&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>注意：如果你最近更新了PyCharm，然后发现频繁闪退，那就得先把runtime切换为IDE默认，然后再更新一下自定义runtime即可&lt;/p>
&lt;/blockquote>
&lt;p>&lt;a href="https://github.com/ayanamist/JetBrainsRuntime-for-fcitx">https://github.com/ayanamist/JetBrainsRuntime-for-fcitx&lt;/a>&lt;/p>
&lt;hr>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">fcitx version: 4.2.9.7
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">OS: Ubuntu 20.04.1 LTS x86_64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Host: 82DM Lenovo XiaoXinPro-13ARE &lt;span class="m">2020&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Kernel: 5.6.0-1038-oem
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Uptime: &lt;span class="m">3&lt;/span> days, &lt;span class="m">15&lt;/span> hours, &lt;span class="m">10&lt;/span> mins
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Packages: &lt;span class="m">2526&lt;/span> &lt;span class="o">(&lt;/span>dpkg&lt;span class="o">)&lt;/span>, &lt;span class="m">17&lt;/span> &lt;span class="o">(&lt;/span>snap&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Shell: zsh 5.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Resolution: 1680x1050, 1920x1080
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DE: GNOME
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">WM: Mutter
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">WM Theme: Yaru-dark
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Theme: Yaru &lt;span class="o">[&lt;/span>GTK2/3&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Icons: Yaru &lt;span class="o">[&lt;/span>GTK2/3&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Terminal: x-terminal-emul
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">CPU: AMD Ryzen &lt;span class="m">7&lt;/span> 4800U with Radeon Graphics &lt;span class="o">(&lt;/span>16&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">GPU: AMD ATI 03:00.0 Renoir
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Memory: 5793MiB / 15432MiB
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>
&lt;p>PyCharm版本：&lt;code>2020.3.1 Professional Edition from SnapStore&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>解决办法：&lt;/p>
&lt;p>下载解压 &lt;a href="https://github.com/RikudouPatrickstar/JetBrainsRuntime-for-Linux-x64/releases">这个runtime&lt;/a>&lt;/p>
&lt;p>假设你解压的路径在&lt;code>~/myprojects/jbr&lt;/code>&lt;/p>
&lt;p>&lt;code>sudo mount -o bind ~/myprojects/jbr /snap/pycharm-professional/current/jbr&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>效果图：&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://user-images.githubusercontent.com/2854276/103345249-d78b9e00-4acb-11eb-9fd1-6f3bf0444f92.png" alt="image">&lt;/p>
&lt;ul>
&lt;li>默认runtime：&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://user-images.githubusercontent.com/2854276/103345287-f722c680-4acb-11eb-920a-da50e6af00fb.png" alt="default-runtime">&lt;/p>
&lt;ul>
&lt;li>打patch后的runtime：&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://user-images.githubusercontent.com/2854276/103345302-01dd5b80-4acc-11eb-90dc-b5b75aa3f3a3.png" alt="new-runtime">&lt;/p>
&lt;ul>
&lt;li>参考&lt;code>对我基本无用，snap商店里的pycharm没有idea.sh这个启动脚本&lt;/code>&lt;/li>
&lt;/ul>
&lt;ol>
&lt;li>&lt;a href="https://bbs.archlinuxcn.org/viewtopic.php?pid=43982#p43982">https://bbs.archlinuxcn.org/viewtopic.php?pid=43982#p43982&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.csdn.net/u011166277/article/details/106287587">https://blog.csdn.net/u011166277/article/details/106287587&lt;/a>&lt;/li>
&lt;/ol>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2020-12-30T10:25:21+08:00
update@2022-12-30T06:33:09+08:00
comment@https://github.com/ferstar/blog/issues/33
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>Linux系统备份小计</title><link>https://blog.ferstar.org/post/issue-32/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-32/</guid><pubDate>Sun, 13 Dec 2020 08:08:17 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;h3 id="终极奥义btrfs-sendreceive">终极奥义btrfs send&amp;amp;receive&lt;/h3>
&lt;blockquote>
&lt;p>我现在换新机直接用这招：先清一波垃圾文件如缓存日志等，然后把旧机硬盘拆出来放移动硬盘盒里，挂到新机器启动，再用btrfs send&amp;amp;receive转移子卷数据，转完以后把新盘uuid写入/etc/fstab和/boot/grub/grub.cfg即可，方便快捷&lt;/p>
&lt;/blockquote>
&lt;p>&lt;code>sudo btrfs send root | sudo btrfs receive /tmp/rootfs&lt;/code>&lt;/p>
&lt;h3 id="btrfs专用snapshot">BTRFS专用，snapshot&lt;/h3>
&lt;blockquote>
&lt;p>这个其实最方便最无感，有个软件很犀利：&lt;a href="https://github.com/teejee2008/timeshift">timeshift&lt;/a>，核心就是利用btrfs文件系统的快照能力，但是成也快照败也快照，只能放在同盘分区下，如果单盘扑街，资料就跪了。&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://user-images.githubusercontent.com/2854276/102006755-83a85780-3d5e-11eb-8c52-22be45b05e78.png" alt="image">&lt;/p>
&lt;h3 id="利用tar做备份">利用tar做备份&lt;/h3>
&lt;blockquote>
&lt;p>以Ubuntu为例, 参考&lt;a href="https://help.ubuntu.com/community/BackupYourSystem/TAR">BackuoYourSystem&lt;/a>，适用于任意文件系统备份&lt;/p>
&lt;/blockquote>
&lt;h4 id="用到的非系统内置软件">用到的非系统内置软件&lt;/h4>
&lt;ul>
&lt;li>zstd：新一代无损压缩算法实现，用来压缩备份文件（需安装）&lt;/li>
&lt;li>pv：用以显示命令行工具执行进度（需安装）&lt;/li>
&lt;/ul>
&lt;h4 id="备份">备份&lt;/h4>
&lt;blockquote>
&lt;p>以zstd压缩方式打包/目录（除/proc /sys /mnt /media /home外），并切分为最大3900MB的分片文件（backup_xxx）&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">sudo tar -I zstd -cpf - --exclude&lt;span class="o">=&lt;/span>/home --exclude&lt;span class="o">=&lt;/span>/proc --exclude&lt;span class="o">=&lt;/span>/tmp --exclude&lt;span class="o">=&lt;/span>/mnt --exclude&lt;span class="o">=&lt;/span>/dev --exclude&lt;span class="o">=&lt;/span>/sys --exclude&lt;span class="o">=&lt;/span>/run --exclude&lt;span class="o">=&lt;/span>/media --exclude&lt;span class="o">=&lt;/span>/var/log --exclude&lt;span class="o">=&lt;/span>/var/cache/apt/archives --one-file-system / &lt;span class="p">|&lt;/span> pv -s &lt;span class="k">$(&lt;/span>du -sb . &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;{print $1}&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span> &lt;span class="p">|&lt;/span> split -b 3900m - -d -a &lt;span class="m">3&lt;/span> backup_
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>附上备份输出，可以看出pv给的进度其实不准，看看而已&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">tar: Removing leading &lt;span class="sb">`&lt;/span>/&lt;span class="s1">&amp;#39; from member names
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">tar: Removing leading `/&amp;#39;&lt;/span> from hard link targets &lt;span class="o">]&lt;/span> 17% ETA 0:01:05
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tar: /root/.cache/keyring-87BMU0/control: socket ignored &lt;span class="o">]&lt;/span> 19% ETA 0:01:10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tar: /var/snap/canonical-livepatch/95/livepatchd-priv.sock: socket ignored:00:05
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tar: /var/snap/canonical-livepatch/95/livepatchd.sock: socket ignored
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tar: /var/xdroid/common/data/system/ndebugsocket: socket ignored108% ETA 0:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tar: /var/xdroid/common/runtime/xdroid/sockets/0/qemu_pipe: socket ignored:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tar: /var/xdroid/common/runtime/xdroid/sockets/0/xdroid_bridge: socket ignored
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tar: /var/xdroid/common/runtime/xdroid/input/0/event0: socket ignored
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tar: /var/xdroid/common/runtime/xdroid/input/0/event1: socket ignored
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tar: /var/xdroid/common/runtime/xdroid/input/0/event2: socket ignored
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tar: /var/xdroid/common/sockets/xdroid-container.socket: socket ignored
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10.1GiB 0:01:49 &lt;span class="o">[&lt;/span>94.8MiB/s&lt;span class="o">]&lt;/span> &lt;span class="o">[=================================]&lt;/span> 116%
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="恢复">恢复&lt;/h4>
&lt;blockquote>
&lt;p>进入recovery模式或者liveCD模式，恢复备份&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">cat backup_* &lt;span class="p">|&lt;/span> pv - &lt;span class="p">|&lt;/span> sudo tar -I zstd -xpf - -C /media/path_to_rec --numeric-owner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 补足缺失的目录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkdir /proc /sys /mnt /media /dev /tmp
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="修复引导">修复引导&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">sudo -s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> f in dev dev/pts proc &lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span> mount --bind /&lt;span class="nv">$f&lt;/span> /media/whatever/&lt;span class="nv">$f&lt;/span> &lt;span class="p">;&lt;/span> &lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chroot /media/whatever
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dpkg-reconfigure grub-pc
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2020-12-13T08:08:17+08:00
update@2023-01-04T13:16:40+08:00
comment@https://github.com/ferstar/blog/issues/32
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>给SQLAlchemy declarative_base加个基类</title><link>https://blog.ferstar.org/post/issue-31/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-31/</guid><pubDate>Fri, 11 Dec 2020 22:39:38 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>作为CRUD仔，经常这样的套路用ORM，想加个&lt;code>to_dict&lt;/code>的方法来把ORM对象转换成json给前端返回，但已有的项目都是在各自的子类里写个&lt;code>to_dict&lt;/code>的方法，太累了，放到基类可好？是可以的。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">sqlalchemy&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">Column&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">create_engine&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">sqlalchemy.orm&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">sessionmaker&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">sqlalchemy.ext.declarative&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">declarative_base&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Base&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">declarative_base&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">User&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Base&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">__tablename__&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;user&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Column&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">primary_key&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Column&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">to_dict&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">School&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Base&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">__tablename__&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;school&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">to_dict&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">engine&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">create_engine&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;mysql+mysqlconnector://root:password@localhost:3306/test&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">DBSession&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sessionmaker&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">bind&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">engine&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>看&lt;code>declarative_base&lt;/code>源码发现可以给塞个自定义的class进去作为基类，所以以上代码可以这样改进&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">sqlalchemy&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">inspect&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">sqlalchemy.ext.declarative&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">declarative_base&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">_Base&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">__banned_cols__&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nb">str&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;deleted_utc&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">__extra_cols__&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nb">str&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">to_dict&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">kwargs&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cols&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">__extra_cols__&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">name&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">c&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">inspect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="vm">__class__&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ret_dict&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">col&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">getattr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">col&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">col&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">cols&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nb">hasattr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">col&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="n">col&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">__banned_cols__&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">func&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">custom_funcs&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">callable&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">func&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ret_dict&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">update&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ret_dict&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">kwargs&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">ret_dict&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">custom_funcs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">FunctionType&lt;/span>&lt;span class="p">]:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Base&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">declarative_base&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">cls&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">_Base&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这样子类model class就没必要去再写一遍&lt;code>to_dict&lt;/code>方法了&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
created_date: 2020-12-11T22:39:38+08:00
update_date: 2021-02-12T22:14:58+08:00
comment_url: https://github.com/ferstar/blog/issues/31
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>记一次公众号后台删库不需跑路的过程</title><link>https://blog.ferstar.org/post/issue-30/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-30/</guid><pubDate>Fri, 11 Dec 2020 22:12:02 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>created_date: 2020-12-11T22:12:02+08:00&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>update_date: 2020-12-27T03:51:51+08:00&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>comment_url: &lt;a href="https://github.com/ferstar/blog/issues/30">https://github.com/ferstar/blog/issues/30&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>我digital ocean的5刀丐版vps上面放了个人公众号的服务，就是些许python脚本拼凑起来的，还是科研狗的时候偷懒搞的&lt;a href="https://blog.ferstar.org/post/scihub_spider/">东西&lt;/a>，不小心维护到现在。&lt;/p>
&lt;p>前几日因为数据源站更新，需要更新爬虫策略，开vscode登上去改代码，不小心手贱删掉了工作目录，蛋疼啊，火急火燎关掉vps，
刚关完就有粉丝反馈公众号故障，所以临时挂了个维护的通知，开始苦逼恢复数据。&lt;/p>
&lt;ol>
&lt;li>
&lt;p>git、备份恢复 - 扑街，因为很多功能调整都是断断续续加的，没有及时的备份，拿到的旧代码相当于没用&lt;/p>
&lt;/li>
&lt;li>
&lt;p>extundelete大法&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>这个网上一堆教程，比较有用的一个参数是&lt;code>after&lt;/code>，因为我知道确切的删文档时间点，那么只需要恢复删档时间以后的资料就可以&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mount -o remount,ro /dev/sdX1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 举个栗子，恢复一小时内删除的资料&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">extundelete --restore-all --after &lt;span class="k">$(&lt;/span>date -d &lt;span class="s2">&amp;#34;-1 hours&amp;#34;&lt;/span> +%s&lt;span class="k">)&lt;/span> /dev/sdX1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">find RECOVERED_FILES/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="3">
&lt;li>uncompyle6恢复丢失的py代码&lt;/li>
&lt;/ol>
&lt;p>extundelete恢复后，悲剧的发现py代码几乎全丢了，但神奇的是&lt;code>__pycache__&lt;/code>居然完整恢复，于是赶紧用&lt;code>uncompyle6&lt;/code>反编译pyc试试&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> i in &lt;span class="k">$(&lt;/span>ls &lt;span class="p">|&lt;/span> awk -F . &lt;span class="s1">&amp;#39;{print $1}&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span> uncompyle6 &lt;span class="nv">$i&lt;/span>.cpython-36.pyc &amp;gt; ../&lt;span class="nv">$i&lt;/span>.py&lt;span class="p">;&lt;/span> &lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>跑完效果好的出奇，基本上完美还原&lt;/p>
&lt;ol start="4">
&lt;li>
&lt;p>重启&amp;amp;恢复服务 - 一切正常&lt;/p>
&lt;/li>
&lt;li>
&lt;p>复盘 - crontab rsync + git code 走起来，可保江山永固&lt;/p>
&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>从手欠删工作目录到恢复完成耗时1.5h，能完美恢复的关键是发现问题需要立即把盘离线（避免覆写，神仙难救）&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>大概就是损失了午休的时间，于是公众号卖惨求红包，果然收到几个热心粉丝老板的红包打赏，开心。。。&lt;/p>
&lt;/blockquote>
&lt;p>刚看到这里说&lt;code>ext4magic&lt;/code>恢复效果要比&lt;code>extundelete&lt;/code>好，mark一下&lt;/p>
&lt;p>&lt;a href="https://gist.github.com/ebautistabar/cca12863e6335d08a019f015f53fac4a">https://gist.github.com/ebautistabar/cca12863e6335d08a019f015f53fac4a&lt;/a>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>对PostgreSQL jsonb部分key进行索引</title><link>https://blog.ferstar.org/post/issue-29/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-29/</guid><pubDate>Fri, 11 Dec 2020 21:22:57 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>由于是在已有的项目上添加一点新的功能，比如需要支持模糊搜索，但不凑巧的是有几个key是存在一个jsonb col里的，&lt;code>like&lt;/code>无法命中缓存，所以查询速度略慢。&lt;/p>
&lt;p>一番搜索发现&lt;code>pg_trgm&lt;/code>模块提供函数和操作符测定字母，数字，文本基于三元模型匹配的相似性， 还有支持快速搜索相似字符串的索引操作符类，于是实测了下，确实可以命中缓存。&lt;/p>
&lt;p>&lt;img src="https://user-images.githubusercontent.com/2854276/101956219-287d4480-3c3a-11eb-93e6-bd34b5d7e3db.png" alt="image">&lt;/p>
&lt;p>记录下启用gin index的SQL:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">create&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">extension&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">not&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">exists&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pg_trgm&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">create&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">extension&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">not&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">exists&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">btree_gin&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">create&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">index&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">idx_file_meta&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">on&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">using&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">gin&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">meta&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&amp;gt;&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;name&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">meta&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&amp;gt;&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;alias&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">gin_trgm_ops&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ORM查询&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;name&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;sample&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cond&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">File&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">meta&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">astext&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">like&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s1">&amp;#39;%&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">replace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;%&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">%&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 转成实际的SQL语句就是&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">meta&lt;/span> &lt;span class="o">-&amp;gt;&amp;gt;&lt;/span> &lt;span class="s1">&amp;#39;name&amp;#39;&lt;/span> &lt;span class="n">like&lt;/span> &lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="si">%s&lt;/span>&lt;span class="s1">ample%&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
created_date: 2020-12-11T21:22:57+08:00
update_date: 2021-02-12T22:15:41+08:00
comment_url: https://github.com/ferstar/blog/issues/29
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/postgresql/">PostgreSQL</category></item><item><title>关于鼻炎</title><link>https://blog.ferstar.org/post/issue-28/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-28/</guid><pubDate>Fri, 11 Dec 2020 20:38:06 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>列一下还算有效的喷剂&lt;/p>
&lt;ol>
&lt;li>辅舒良 - 过敏性鼻炎（季节性、花粉）可以在季节交替或花粉期之前预防性使用，可能效果会更好&lt;/li>
&lt;li>内舒拿 - 内舒拿的全身生物利用度更低，更安全些，所以说明书批的低至三岁可用&lt;/li>
&lt;li>日本佐藤的喷剂&lt;/li>
&lt;/ol>
&lt;p>实在堵的受不了可以用上述任何一个喷剂都能有效缓解&lt;/p>
&lt;p>减少过敏反应的药物&lt;/p>
&lt;ol>
&lt;li>氯雷他定片&lt;/li>
&lt;li>息斯敏 貌似有效成分还是氯雷他定&lt;/li>
&lt;/ol>
&lt;p>因为鼻子实在太脆弱，清洗必不可少，可选的有&lt;/p>
&lt;ol>
&lt;li>生理性海盐水 - 这玩意挺贵&lt;/li>
&lt;li>洗鼻器 - 据说坚持用有很好的效果&lt;/li>
&lt;/ol>
&lt;p>迫于日益厚重的雾霾&amp;amp;预防新冠，&lt;strong>口罩&lt;/strong>也是必不可少，毕竟鼻子实在太脆&lt;/p>
&lt;blockquote>
&lt;p>万万没想到疫情持续到现在还没有停的迹象，得益于天天戴口罩，鼻炎竟然不药而愈，看来关键还是空气质量太差的锅，自己鼻子太脆，不扛艹。。。&lt;/p>
&lt;/blockquote>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2020-12-11T20:38:06+08:00
update@2022-09-08T04:44:10+08:00
comment@https://github.com/ferstar/blog/issues/28
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/life/">Life</category></item><item><title>miniconda的一个坑</title><link>https://blog.ferstar.org/post/issue-27/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-27/</guid><pubDate>Sat, 28 Nov 2020 00:56:32 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>created_date: 2020-11-28T00:56:32+08:00&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>update_date: 2021-01-08T23:10:26+08:00&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>comment_url: &lt;a href="https://github.com/ferstar/blog/issues/27">https://github.com/ferstar/blog/issues/27&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>这货socket模块没有&lt;code>SO_REUSEPORT&lt;/code>，着实坑我不少，还是用官方源码编译靠谱，鬼知道类似这种魔改选手又在哪里缺金少两。&lt;/p>
&lt;/blockquote>
&lt;p>有个tornado项目起手式是这样的&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">app&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">TornadoApplication&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">server&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tornado&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">httpserver&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">HTTPServer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">app&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">server&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">bind&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">8888&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">reuse_port&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">server&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">start&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">tornado&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ioloop&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">IOLoop&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">current&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">start&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后赤裸裸报错：&lt;/p>
&lt;pre tabindex="0">&lt;code>the platform doesn&amp;#39;t support SO_REUSEPORT
&lt;/code>&lt;/pre>&lt;p>找到出错的源码位置&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">reuse_port&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="nb">hasattr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">socket&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;SO_REUSEPORT&amp;#34;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">raise&lt;/span> &lt;span class="ne">ValueError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;the platform doesn&amp;#39;t support SO_REUSEPORT&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>好吧居然没有&lt;code>SO_REUSEPORT&lt;/code>属性，我一度以为是自己系统问题，然而并不是，问题出在miniconda的Python包上，换系统内置Python或者官方源码编译的就没有问题。&lt;/p>
&lt;p>准备给Conda官方提个issue，发现早有人遇到了这个问题&lt;/p>
&lt;p>&lt;a href="https://github.com/conda/conda/issues/9151">https://github.com/conda/conda/issues/9151&lt;/a>&lt;/p>
&lt;p>只不过一直没人理会的感觉，瞟一眼1.7k+的issues，我还是跟conda拜拜吧，毕竟又不炼丹。&lt;/p>
&lt;p>PS: macOS 中这个属性又正常, 但配置了&lt;code>reuse_port&lt;/code>也没用, 只有最先启动的实例才会响应请求, 后面启动的实例看上去完全被阻塞了&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>小米8养老折腾</title><link>https://blog.ferstar.org/post/issue-26/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-26/</guid><pubDate>Sat, 17 Oct 2020 10:23:39 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>养老养老了，MIUI11 9.9.27，只装个面具root，其他模块调度全扔&lt;/p>
&lt;/blockquote>
&lt;p>一路官方 OTA 上到 MIUI12, 感觉手上的米 8 已经战不动了, 正好官方最后的开发版定格在 MIUI12 20.9.4, 所以是时候再搞一波机, 养个老&lt;/p>
&lt;ol>
&lt;li>官方 or 官改 or 类原生&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>因为 NFC 公交卡是刚需, 类原生就不能考虑, 官改感觉改的乱七八糟, 所以只能自己整整官方包了&lt;/p>
&lt;/blockquote>
&lt;ol start="2">
&lt;li>ext4 or f2fs&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>这个当然是 f2fs yes(4k随机写性能大概能比 ext4 高 25% 左右) 其实从 MIUI10 起官方内核也是支持 f2fs 的, 只不过 ROM 默认还是用的是 ext4, 附一个补丁
&lt;a href="https://github.com/ferstar/blog/files/5395404/Patch-wayne-f2fs-any-rom.zip">Patch-wayne-f2fs-any-rom.zip&lt;/a> 其实很简单, 就是修改了系统&lt;code>/data&lt;/code>及&lt;code>/cache&lt;/code>的挂载参数, 另外最好再加刷一个 f2fs 优化补丁
&lt;a href="https://github.com/ferstar/blog/files/5395405/f2fs-optimize.zip">f2fs-optimize.zip&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>改 f2fs 步骤大概说一下: REC 里把/data, /cache 格式化为 f2fs -&amp;gt; 重启至REC -&amp;gt; 刷补丁 -&amp;gt; 重启手机即可&lt;/p>
&lt;/blockquote>
&lt;ol start="3">
&lt;li>官核 &lt;del>or 第三方内核&lt;/del>&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>UPDATE: 弃坑，还是官核稳。&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>第三方内核的优点是自定义了一坨东西, 代码上较官方内核新一些, 我主要看重快充, 以及支持 MIUI DC 调光, 所以这方面选择就比较窄, 因为没几个三方内核支持 DC 调光的, 目前试用下来有两个内核支持, 一个是巫女内核, 我只用过 7.1 这个是支持 DC 调光的, 另外还有个Tsing Kernel这个也是支持 DC 调光, 安卓 9 以下的三方内核没有一个支持 DC 调光, 所以直接 pass&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>刷三方内核的步骤: 刷回原生 ROM 内核 -&amp;gt; 刷 magisk -&amp;gt; 刷三方内核 -&amp;gt; 刷 magisk -&amp;gt; 双清cache(不需要清数据)&lt;/p>
&lt;/blockquote>
&lt;ol start="4">
&lt;li>要不要上调度&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>神他么的 yc 调度, 你值得拥有: &lt;a href="https://github.com/yc9559/uperf">https://github.com/yc9559/uperf&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;ol start="5">
&lt;li>magisk 模块&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>这个自己去酷安捞, 我主要用了杜比&amp;amp;蝰蛇音效的模块以及 Riru core &amp;amp; EdXposed &amp;amp; Busybox &amp;amp; SQLite 加上上面提到的 yc调度&lt;/p>
&lt;/blockquote>
&lt;ol start="6">
&lt;li>exposed 模块&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>ChiMi &amp;amp; 微X模块 &amp;amp; 腾爱优芒豆去广告 &amp;amp; 知了 &amp;amp; AD 快消&lt;/p>
&lt;/blockquote>
&lt;ol start="7">
&lt;li>搞机常用 APP 们&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>酷安 &amp;amp; Scene &amp;amp; MT 管理器 &amp;amp; 钛备份 &amp;amp; AccuBattery &amp;amp; STM工具箱 &amp;amp; 搞机助手 &amp;amp; EX kernel manager&lt;/p>
&lt;/blockquote>
&lt;p>&lt;del>8. To be continue...&lt;/del>&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
created_date: 2020-10-17T10:23:39+08:00
update_date: 2021-02-12T22:13:34+08:00
comment_url: https://github.com/ferstar/blog/issues/26
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/android/">Android</category></item><item><title>Docker 清日志</title><link>https://blog.ferstar.org/post/issue-25/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-25/</guid><pubDate>Fri, 25 Sep 2020 02:27:34 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>这玩意属于粗暴玩法，要确定日志没用才能搞&lt;/p>
&lt;/blockquote>
&lt;p>&lt;code>truncate -s 0 /var/lib/docker/containers/*/*-json.log&lt;/code>&lt;/p>
&lt;p>出处: &lt;a href="https://stackoverflow.com/a/43570083">https://stackoverflow.com/a/43570083&lt;/a>&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2020-09-25T02:27:34+08:00
update@2021-02-14T16:34:40+08:00
comment@https://github.com/ferstar/blog/issues/25
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/docker/">DOCKER</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>利用GitHub Actions改善MatterMost安卓客户端的消息推送</title><link>https://blog.ferstar.org/post/issue-23/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-23/</guid><pubDate>Mon, 13 Jul 2020 15:37:46 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>MatterMost是一款非常好用的团队沟通工具，但是这货的安卓客户端推送服务非常的垃圾，夸张到昨天的消息今天才可能收到，就算挂梯子也不行。有时候团队有啥要紧事的时候就很蛋疼，只能在微信群里at某某某，体验很不好。所幸他的API非常详细，通过一番组合加上GitHub Actions服务完全可以拯救糟糕的消息推送。&lt;/p>
&lt;h3 id="1-利用到的服务">1. 利用到的服务&lt;/h3>
&lt;ul>
&lt;li>AlertOver: &lt;a href="https://www.alertover.com">https://www.alertover.com&lt;/a>&lt;/li>
&lt;li>GitHub Actions: &lt;a href="https://github.com/features/actions">https://github.com/features/actions&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="2-用到的api">2. 用到的API&lt;/h3>
&lt;blockquote>
&lt;p>就是遍历所有频道，拿到未读消息计数，利用AlertOver进行推送&lt;/p>
&lt;/blockquote>
&lt;ol>
&lt;li>公开频道未读消息 &lt;code>/api/v4/users/me/teams/unread&lt;/code>&lt;/li>
&lt;li>列出所有频道 &lt;code>/api/v4/users/me/teams/&amp;lt;channel_id&amp;gt;/channels&lt;/code>&lt;/li>
&lt;li>列出频道未读消息 &lt;code>/api/v4/users/me/channels/&amp;lt;channel_id&amp;gt;/unread&lt;/code>&lt;/li>
&lt;li>推送AlertOver &lt;code>https://api.alertover.com/v1/alert&lt;/code>&lt;/li>
&lt;/ol>
&lt;h3 id="3-配置alertover服务安装客户端">3. 配置AlertOver服务&amp;amp;安装客户端&lt;/h3>
&lt;blockquote>
&lt;p>这个没啥好说的，注册账号，下载安装客户端，比较开心的是，客户端支持 MIPush，不用单独给他留后台服务。然后再新建一个组织，如图
&lt;img src="https://user-images.githubusercontent.com/2854276/87322778-6b8a9d00-c560-11ea-9e7b-180247f5c0a5.png" alt="image">&lt;/p>
&lt;/blockquote>
&lt;h3 id="4-配置github-actions">4. 配置GitHub Actions&lt;/h3>
&lt;ol>
&lt;li>代码部分：https://github.com/ferstar/blog/blob/master/static/mm_notify.py&lt;/li>
&lt;li>workflow：https://github.com/ferstar/blog/blob/master/.github/workflows/mm_notify.yml&lt;/li>
&lt;li>secrets配置：敏感信息，如cookie等可以配置到这里，如图
&lt;img src="https://user-images.githubusercontent.com/2854276/87323301-2e72da80-c561-11ea-95a0-895f81144984.png" alt="image">&lt;/li>
&lt;/ol>
&lt;h3 id="5-最终效果">5. 最终效果&lt;/h3>
&lt;blockquote>
&lt;p>一番折腾后，手机上可以比较及时的收到MatterMost中的未读消息提示，飒！&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://user-images.githubusercontent.com/2854276/87391930-345ad100-c5de-11ea-9213-43a3c891fe8a.png" alt="image">&lt;/p>
&lt;blockquote>
&lt;p>当然你完全可以把脚本扔到自己的VPS上，然后AlertOver也可以替换成类似的服务，比如IFTTT之类，条条大路通罗马~&lt;/p>
&lt;/blockquote>
&lt;p>PS: cookie如图示
&lt;img src="https://user-images.githubusercontent.com/2854276/102732042-86b1d200-4374-11eb-9b66-215ed7a20fea.png" alt="image">&lt;/p>
&lt;p>白嫖的action服务越来越不守时了，只好把脚本改改放自己vps上，crontab安排起，也是蛮香的😌&lt;/p>
&lt;blockquote>
&lt;p>mattermost 有私人聊天信息api吗。官网好像没看到&lt;/p>
&lt;/blockquote>
&lt;p>这个我也没看到, 另外 MatterMost 在iOS上的推送挺及时的, 不需要折腾&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2020-07-13T15:37:46+08:00
update@2021-04-25T06:36:21+08:00
comment@https://github.com/ferstar/blog/issues/23
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/idea/">Idea</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>ThinkPad X220 装黑苹果小记</title><link>https://blog.ferstar.org/post/issue-22/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-22/</guid><pubDate>Sun, 12 Jul 2020 04:50:33 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>created_date: 2020-07-12T04:50:33+08:00&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>update_date: 2020-07-15T00:20:36+08:00&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>comment_url: &lt;a href="https://github.com/ferstar/blog/issues/22">https://github.com/ferstar/blog/issues/22&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>从这抄的EFI &lt;a href="https://github.com/tluck/Lenovo-T420-Clover">https://github.com/tluck/Lenovo-T420-Clover&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>各处拖的驱动集合了一下，硬件基本完美驱动。&lt;/p>
&lt;p>不工作的：读卡器、PCI express，当然还有无线网卡，自带的无线网卡是无解的，淘宝十八块换了乞丐版BCM4322 DW1510网卡，10.15以下免驱。&lt;/p>
&lt;p>蓝牙：BCM20702A0，也OK，不过平时又几乎不用&lt;/p>
&lt;p>打了这么些驱动：
&lt;img src="https://user-images.githubusercontent.com/2854276/87239101-b8298780-c43d-11ea-96d4-3f110eaa131f.png" alt="image">&lt;/p>
&lt;p>关于Intel HD3000集显冻屏的问题，需要选择适合的旧版驱动才行，这个可以在http://dosdude1.com/mojave/ 拿到，安装后从未碰到冻屏死机问题，就是偶尔屏幕有细横线，基本不影响码字，话说这本子键盘手感真好！&lt;/p>
&lt;p>&lt;img src="https://user-images.githubusercontent.com/2854276/87239143-30904880-c43e-11ea-85f3-350dc2d398c1.png" alt="image">&lt;/p>
&lt;p>因为用到的&lt;code>Shades&lt;/code>调光软件是32位的，x220这块垃圾TN屏PWM调光，低亮度下闪瞎眼，只有靠这个软件才能活的样子，所以停留在Mojave养老了。&lt;/p>
&lt;p>升级路径：10.13.6 -&amp;gt; Mojave Patcher -&amp;gt; 10.14.6&lt;/p>
&lt;p>EFI链接&lt;code>亲测最高可支持到10.15.5，乞丐网卡驱动正常&lt;/code>：https://github.com/ferstar/blog/files/4908021/EFI_X220.zip&lt;/p>
&lt;p>其实最适合x220的macOS版本是10.12.x，各种完美，屏幕也不会有细线，更不用说冻屏啥的，然而一堆软件不支持，迫不得已上10.14.x。&lt;/p>
&lt;p>传一个&lt;code>Shades&lt;/code>软件：
&lt;a href="https://github.com/ferstar/blog/files/4922167/shades-intel.zip">shades-intel.zip&lt;/a>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/macos/">macOS</category></item><item><title>记一次迁移postgresql数据库的过程</title><link>https://blog.ferstar.org/post/issue-21/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-21/</guid><pubDate>Thu, 21 May 2020 02:15:07 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>created_date: 2020-05-21T02:15:07+08:00&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>update_date: 2020-05-21T02:15:28+08:00&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>comment_url: &lt;a href="https://github.com/ferstar/blog/issues/21">https://github.com/ferstar/blog/issues/21&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>主要照抄这个gist &lt;a href="https://gist.github.com/brock/7a7a70300096632cec30">https://gist.github.com/brock/7a7a70300096632cec30&lt;/a>&lt;/p>
&lt;p>以往小数据直接scp大法走起就可以，但是这次比较大，裸SQL大概有30GB，gzip压完都有3.6GB，现有网络环境下，scp传不了多少就异常关闭，就算不关闭，因为是跨区域机房迁移，速度也是非常龟速，所以选择了一个有cdn加持的&lt;a href="https://app.tmp.link">临时文件中转服务&lt;/a>来迁移，实际效果也是非常棒，Local 机器上传基本跑满带宽，Remote 机器下载能稳定维持在5MB/s，一次成功，共耗时半小时左右。&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Local 导出&lt;code>直接压成gzip，能节省巨量的存储空间&lt;/code>&lt;/p>
&lt;p>&lt;code>pg_dump -d &amp;lt;db_name&amp;gt; -p &amp;lt;port&amp;gt; -U &amp;lt;db_user&amp;gt; -Z9 -f &amp;lt;dump_file.sql.gz&amp;gt;&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>加密&lt;code>因为要通过中转服务传输&lt;/code>&lt;/p>
&lt;p>&lt;code>zip -e -1 &amp;lt;dump_file.sql.gz.zip&amp;gt; &amp;lt;dump_file.sql.gz&amp;gt;&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>md5sum&lt;/p>
&lt;p>&lt;code>md5sum &amp;lt;dump_file.sql.gz.zip&amp;gt; &amp;gt; &amp;lt;dump_file.sql.gz.zip.md5sum&amp;gt;&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>上传至中转服务器&lt;code>tmp.link&lt;/code>&lt;/p>
&lt;p>&lt;code>curl -k -F &amp;quot;file=@&amp;lt;dump_file.sql.gz.zip&amp;gt;&amp;quot; -F &amp;quot;token=kzzzzaypns&amp;quot; -F &amp;quot;model=0&amp;quot; -F &amp;quot;utoken=sCH066OaaaC&amp;quot; -X POST &amp;quot;https://connect.tmp.link/api_v2/cli_uploader2&amp;quot;&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>从中转服务器下载&lt;code>先在浏览器打开临时链接，拿到真实下载地址，去 Remote 服务器下载&lt;/code>&lt;/p>
&lt;p>&lt;code>wget &amp;lt;tmp_down_link&amp;gt;&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Remote 解压&amp;amp;恢复数据库&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">unzip &amp;lt;dump_file.sql.gz.zip&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dropdb &amp;lt;database&amp;gt; &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> createdb &amp;lt;database&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gunzip &amp;lt;dump_file.sql.gz&amp;gt; &lt;span class="p">|&lt;/span> psql -d &amp;lt;db_name&amp;gt; -p &amp;lt;port&amp;gt; -U &amp;lt;db_user&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ol></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/postgresql/">PostgreSQL</category></item><item><title>临时解决plasmashell狂占CPU的bug</title><link>https://blog.ferstar.org/post/issue-20/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-20/</guid><pubDate>Thu, 07 May 2020 08:29:38 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>created_date: 2020-05-07T08:29:38+08:00&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>update_date: 2020-05-26T23:35:15+08:00&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>comment_url: &lt;a href="https://github.com/ferstar/blog/issues/20">https://github.com/ferstar/blog/issues/20&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>怒装黑苹果了，香~&lt;/p>
&lt;/blockquote>
&lt;p>本子升到20.04, 顺路换成了KDE, 不过一直有个问题就是: 每次从休眠唤醒一段时间后, 桌面会变的异常卡, htop一发发现plasmashell占了近100%, 这明显不科学, google一发发现似乎是kde的陈年烂事, 没办法, 大力出奇迹~&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">killall plasmashell&lt;span class="p">;&lt;/span> kstart5 plasmashell&lt;span class="p">;&lt;/span> &lt;span class="nb">exit&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>后来发现把独显屏蔽似乎就没这个问题了, 看来还是NV显卡驱动的锅
&lt;img src="https://user-images.githubusercontent.com/2854276/81272274-db236e00-907f-11ea-99bc-f5219cbd83b1.png" alt="image">&lt;/p>
&lt;p>另外如果发现菜单图标雪花, 也可以通过kill大法搞定, 如图
&lt;img src="https://user-images.githubusercontent.com/2854276/81284262-78869e00-9090-11ea-91a7-c13f3dc179e2.png" alt="image">&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>ThinkPad x220首装Manjaro Xfce4配置</title><link>https://blog.ferstar.org/post/issue-19/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-19/</guid><pubDate>Wed, 22 Apr 2020 06:45:22 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>created_date: 2020-04-22T06:45:22+08:00&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>update_date: 2020-07-12T05:36:08+08:00&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>comment_url: &lt;a href="https://github.com/ferstar/blog/issues/19">https://github.com/ferstar/blog/issues/19&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>装黑苹果了，香。。。&lt;/p>
&lt;hr>
&lt;blockquote>
&lt;p>给老古董x220装了个Manjaro，顺路记录一下安装完成之后大概的配置过程&lt;/p>
&lt;/blockquote>
&lt;h5 id="1-机器配置">1. 机器配置&lt;/h5>
&lt;p>&lt;img src="https://user-images.githubusercontent.com/2854276/79948260-19c50000-84a6-11ea-9869-291df81aa785.png" alt="image">&lt;/p>
&lt;h5 id="2-换源">2. 换源&lt;/h5>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 选择一个快的, 我选了中科大和清华的&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo pacman-mirrors -i -c China -m rank
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h5 id="3-添加archlinuxcn-中文源">3. 添加ArchLinuxCN 中文源&lt;/h5>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">sudo vi /etc/pacman.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 在文件的末尾添加&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>archlinuxcn&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">SigLevel&lt;/span> &lt;span class="o">=&lt;/span> Optional TrustedOnly
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">Server&lt;/span> &lt;span class="o">=&lt;/span> https://mirrors.tuna.tsinghua.edu.cn/archlinuxcn//&lt;span class="nv">$arch&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 更新源和密钥环&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo pacman -Syy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo pacman -S archlinux-keyring archlinuxcn-keyring
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h5 id="4-装yay并修改-aur-源">4. 装yay并修改 AUR 源&lt;/h5>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">sudo pacman -S yay
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yay --aururl &lt;span class="s2">&amp;#34;https://aur.tuna.tsinghua.edu.cn&amp;#34;&lt;/span> --save
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h5 id="5-装输入法">5. 装输入法&lt;/h5>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 如果之前安装了 fcitx-im 或者相关的包，直接删除。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo pacman -Rsn fcitx-im fcitx-configtool
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 然后从 ArchLinuxCN 中文源里安装 fcitx-lilydjwg-git 和搜狗输入法的包， fcitx-lilydjwg-git 这个包里默认是包含 fcitx-qt4 的。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo pacman -S fcitx-lilydjwg-git fcitx-sogoupinyin fcitx-qt5 fcitx-configtool
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 这里需要安装 fcitx-qt5 的原因是 fcitx-configtool 这个包依赖于 QT5。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 安装完成后手动添加用户变量，编辑 ~/.pam_environment 这个文件，如果没有就手动创建&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vi ~/.pam_environment
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">GTK_IM_MODULE&lt;/span>&lt;span class="o">=&lt;/span>fcitx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">QT_IM_MODULE&lt;/span>&lt;span class="o">=&lt;/span>fcitx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">XMODIFIERS&lt;/span>&lt;span class="o">=&lt;/span>@im&lt;span class="o">=&lt;/span>fcitx
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h5 id="6-看见啥好用yay之">6. 看见啥好用yay之&lt;/h5>
&lt;ul>
&lt;li>
&lt;p>比如&lt;code>火焰截图-flameshot&lt;/code>，超级好用的截图工具，当然深度截图工具也不错&lt;/p>
&lt;/li>
&lt;li>
&lt;p>又比如Google Chrome，vscode，qv2ray，WPS for Linux之类&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h5 id="7-调快捷键">7. 调快捷键&lt;/h5>
&lt;p>xfce4有两处可以调快捷键的地方，如图，比较割裂，我只是小改一下以适应Windows的风格。&lt;/p>
&lt;p>&lt;img src="https://user-images.githubusercontent.com/2854276/79948925-4b8a9680-84a7-11ea-8b67-07a9db2a553a.png" alt="image">
&lt;img src="https://user-images.githubusercontent.com/2854276/79948974-5e9d6680-84a7-11ea-950c-b039e429998c.png" alt="image">&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>Ubuntu禁用自动挂载USB设备</title><link>https://blog.ferstar.org/post/issue-18/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-18/</guid><pubDate>Sat, 14 Mar 2020 09:17:59 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>created_date: 2020-03-14T09:17:59+08:00&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>update_date: 2020-03-14T09:20:07+08:00&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>comment_url: &lt;a href="https://github.com/ferstar/blog/issues/18">https://github.com/ferstar/blog/issues/18&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>18.04.4有效，有的帖子说禁用&lt;code>udisks2.service&lt;/code>服务这招并不靠谱&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">sudo apt install dconf-editor
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>配置如图：
&lt;img src="https://user-images.githubusercontent.com/2854276/76678989-8f23f200-6617-11ea-8ef2-668854c64bb4.png" alt="image">&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>为知笔记在Ubuntu 18.04上的编译过程</title><link>https://blog.ferstar.org/post/issue-17/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-17/</guid><pubDate>Tue, 18 Feb 2020 02:14:03 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>created_date: 2020-02-18T02:14:03+08:00&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>update_date: 2020-02-18T02:21:06+08:00&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>comment_url: &lt;a href="https://github.com/ferstar/blog/issues/17">https://github.com/ferstar/blog/issues/17&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>装Qt，注意安装的时候要选择桌面开发环境，默认没有选&lt;/li>
&lt;/ul>
&lt;p>&lt;a href="http://mirrors.ustc.edu.cn/qtproject/archive/qt/5.9/5.9.0/qt-opensource-linux-x64-5.9.0.run">http://mirrors.ustc.edu.cn/qtproject/archive/qt/5.9/5.9.0/qt-opensource-linux-x64-5.9.0.run&lt;/a>&lt;/p>
&lt;ul>
&lt;li>安装一坨依赖&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">sudo apt-get install git build-essential cmake zlib1g-dev extra-cmake-modules fcitx-libs-dev mesa-common-dev libjasper-dev libxkbcommon-dev
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>克隆源码到本地&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> ~
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkdir WizTeam
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> WizTeam
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git clone https://github.com/ferstar/WizQTClient.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> WizQTClient
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git checkout 2.8.2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>编译fcitx-qt5解决中文输入问题&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">git clone https://github.com/fcitx/fcitx-qt5.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> fcitx-qt5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cmake .
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">make
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo make install
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 拷贝platforminputcontext/libfcitxplatforminputcontextplugin.so到Qt安装目录的Tools/QtCreator/lib/Qt/plugins/platforminputcontexts目录内&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>编译打包&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">chmod a+x linuxdeployqt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">PATH&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$HOME&lt;/span>&lt;span class="s2">/Qt5.9.0/5.9/gcc_64/bin&amp;#34;&lt;/span>:&lt;span class="nv">$PATH&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">./linux-package.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>无法登录的问题&lt;/li>
&lt;/ul>
&lt;p>以上步骤成功完成后会生成一个AppImage文件，双击即可运行，但登录会报错&lt;code>Failed to exec json request, network error=99, message=&lt;/code>
Google一番发现是openssl库的问题导致其联网同步时安全验证失败,官网上提供了解决方案&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">sudo apt-get install aptitude
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 安装aptitude&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo aptitude install libssl1.0-dev
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># aptitude会自动解决依赖，这里我们需要降级系统默认的ssl包，选择接受即可&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重新打开为知笔记即可正常登录&lt;/p>
&lt;blockquote>
&lt;p>预编译版本见：https://github.com/ferstar/WizQTClient/releases/tag/v2.8.2&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://user-images.githubusercontent.com/2854276/74698328-5c652480-5238-11ea-9040-b8ee4de7ee3d.png" alt="image">&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>转换ext4文件系统为btrfs</title><link>https://blog.ferstar.org/post/issue-16/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-16/</guid><pubDate>Thu, 23 Jan 2020 08:09:06 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>created_date: 2020-01-23T08:09:06+08:00&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>update_date: 2020-12-19T03:27:38+08:00&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>comment_url: &lt;a href="https://github.com/ferstar/blog/issues/16">https://github.com/ferstar/blog/issues/16&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>主要用这个工具&lt;code>fstransform&lt;/code>
先记录一下运行日志：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;span class="lnt">107
&lt;/span>&lt;span class="lnt">108
&lt;/span>&lt;span class="lnt">109
&lt;/span>&lt;span class="lnt">110
&lt;/span>&lt;span class="lnt">111
&lt;/span>&lt;span class="lnt">112
&lt;/span>&lt;span class="lnt">113
&lt;/span>&lt;span class="lnt">114
&lt;/span>&lt;span class="lnt">115
&lt;/span>&lt;span class="lnt">116
&lt;/span>&lt;span class="lnt">117
&lt;/span>&lt;span class="lnt">118
&lt;/span>&lt;span class="lnt">119
&lt;/span>&lt;span class="lnt">120
&lt;/span>&lt;span class="lnt">121
&lt;/span>&lt;span class="lnt">122
&lt;/span>&lt;span class="lnt">123
&lt;/span>&lt;span class="lnt">124
&lt;/span>&lt;span class="lnt">125
&lt;/span>&lt;span class="lnt">126
&lt;/span>&lt;span class="lnt">127
&lt;/span>&lt;span class="lnt">128
&lt;/span>&lt;span class="lnt">129
&lt;/span>&lt;span class="lnt">130
&lt;/span>&lt;span class="lnt">131
&lt;/span>&lt;span class="lnt">132
&lt;/span>&lt;span class="lnt">133
&lt;/span>&lt;span class="lnt">134
&lt;/span>&lt;span class="lnt">135
&lt;/span>&lt;span class="lnt">136
&lt;/span>&lt;span class="lnt">137
&lt;/span>&lt;span class="lnt">138
&lt;/span>&lt;span class="lnt">139
&lt;/span>&lt;span class="lnt">140
&lt;/span>&lt;span class="lnt">141
&lt;/span>&lt;span class="lnt">142
&lt;/span>&lt;span class="lnt">143
&lt;/span>&lt;span class="lnt">144
&lt;/span>&lt;span class="lnt">145
&lt;/span>&lt;span class="lnt">146
&lt;/span>&lt;span class="lnt">147
&lt;/span>&lt;span class="lnt">148
&lt;/span>&lt;span class="lnt">149
&lt;/span>&lt;span class="lnt">150
&lt;/span>&lt;span class="lnt">151
&lt;/span>&lt;span class="lnt">152
&lt;/span>&lt;span class="lnt">153
&lt;/span>&lt;span class="lnt">154
&lt;/span>&lt;span class="lnt">155
&lt;/span>&lt;span class="lnt">156
&lt;/span>&lt;span class="lnt">157
&lt;/span>&lt;span class="lnt">158
&lt;/span>&lt;span class="lnt">159
&lt;/span>&lt;span class="lnt">160
&lt;/span>&lt;span class="lnt">161
&lt;/span>&lt;span class="lnt">162
&lt;/span>&lt;span class="lnt">163
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">tianbot@ros2go:~$ sudo fstransform /dev/nvme0n1p4 btrfs --force-untested-file-systems
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fstransform: starting version 0.9.3, checking environment
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fstransform: checking &lt;span class="k">for&lt;/span> which... &lt;span class="s1">&amp;#39;/usr/bin/which&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fstransform: checking &lt;span class="k">for&lt;/span> expr... &lt;span class="s1">&amp;#39;/usr/bin/expr&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fstransform: checking &lt;span class="k">for&lt;/span> id... &lt;span class="s1">&amp;#39;/usr/bin/id&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fstransform: parsing &lt;span class="nb">command&lt;/span> line arguments
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fstransform: forcing trasformation of untested file systems &lt;span class="o">(&lt;/span>DANGEROUS&lt;span class="o">)&lt;/span>. &lt;span class="s1">&amp;#39;--force-untested-file-systems&amp;#39;&lt;/span> bytes specified on &lt;span class="nb">command&lt;/span> line
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fstransform: checking &lt;span class="k">for&lt;/span> stat... &lt;span class="s1">&amp;#39;/usr/bin/stat&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fstransform: checking &lt;span class="k">for&lt;/span> mkfifo... &lt;span class="s1">&amp;#39;/usr/bin/mkfifo&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fstransform: checking &lt;span class="k">for&lt;/span> blockdev... &lt;span class="s1">&amp;#39;/sbin/blockdev&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fstransform: checking &lt;span class="k">for&lt;/span> losetup... &lt;span class="s1">&amp;#39;/sbin/losetup&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fstransform: checking &lt;span class="k">for&lt;/span> fsck... &lt;span class="s1">&amp;#39;/sbin/fsck&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fstransform: checking &lt;span class="k">for&lt;/span> mkfs... &lt;span class="s1">&amp;#39;/sbin/mkfs&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fstransform: checking &lt;span class="k">for&lt;/span> mount... &lt;span class="s1">&amp;#39;/bin/mount&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fstransform: checking &lt;span class="k">for&lt;/span> umount... &lt;span class="s1">&amp;#39;/bin/umount&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fstransform: checking &lt;span class="k">for&lt;/span> mkdir... &lt;span class="s1">&amp;#39;/bin/mkdir&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fstransform: checking &lt;span class="k">for&lt;/span> rmdir... &lt;span class="s1">&amp;#39;/bin/rmdir&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fstransform: checking &lt;span class="k">for&lt;/span> rm... &lt;span class="s1">&amp;#39;/bin/rm&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fstransform: checking &lt;span class="k">for&lt;/span> dd... &lt;span class="s1">&amp;#39;/bin/dd&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fstransform: checking &lt;span class="k">for&lt;/span> sync... &lt;span class="s1">&amp;#39;/bin/sync&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fstransform: checking &lt;span class="k">for&lt;/span> fsmove... &lt;span class="s1">&amp;#39;/usr/sbin/fsmove&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fstransform: checking &lt;span class="k">for&lt;/span> fsremap... &lt;span class="s1">&amp;#39;/usr/sbin/fsremap&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fstransform: checking &lt;span class="k">for&lt;/span> fsck&lt;span class="o">(&lt;/span>&lt;span class="nb">source&lt;/span> file-system&lt;span class="o">)&lt;/span>... &lt;span class="s1">&amp;#39;/sbin/fsck&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fstransform: checking &lt;span class="k">for&lt;/span> fsck&lt;span class="o">(&lt;/span>target file-system&lt;span class="o">)&lt;/span>... &lt;span class="s1">&amp;#39;/sbin/fsck&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fstransform: looking &lt;span class="k">for&lt;/span> optional commands
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fstransform: checking &lt;span class="k">for&lt;/span> sleep... &lt;span class="s1">&amp;#39;/bin/sleep&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fstransform: checking &lt;span class="k">for&lt;/span> date... &lt;span class="s1">&amp;#39;/bin/date&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:24:46 fstransform: environment check passed.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:24:46 fstransform: saving output of this execution into /var/tmp/fstransform/fstransform.log.5394
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:24:46 fstransform: preparing to transform device &lt;span class="s1">&amp;#39;/dev/nvme0n1p4&amp;#39;&lt;/span> to file-system &lt;span class="nb">type&lt;/span> &lt;span class="s1">&amp;#39;btrfs&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:24:46 fstransform: device &lt;span class="s1">&amp;#39;/dev/nvme0n1p4&amp;#39;&lt;/span> not found in the output of &lt;span class="nb">command&lt;/span> /bin/mount, assuming it is not mounted
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:24:46 fstransform: device is now mounted at &lt;span class="s1">&amp;#39;/tmp/fstransform.mount.5394&amp;#39;&lt;/span> with file-system &lt;span class="nb">type&lt;/span> &lt;span class="s1">&amp;#39;ext4&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:24:46 fstransform: WARNING: this program is UNTESTED on target file system &lt;span class="s1">&amp;#39;btrfs&amp;#39;&lt;/span> !
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:24:46 fstransform: WARNING: this program is tested ONLY on file systems: minix ext2 ext3 ext4 reiserfs jfs xfs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:24:46 fstransform: WARNING: continuing anyway due to option &lt;span class="s1">&amp;#39;--force-untested-file-systems&amp;#39;&lt;/span> &lt;span class="o">(&lt;/span>DANGEROUS&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:24:46 fstransform: device raw &lt;span class="nv">size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">348535128064&lt;/span> bytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:24:46 fstransform: creating sparse loop file &lt;span class="s1">&amp;#39;/tmp/fstransform.mount.5394/.fstransform.loop.5394&amp;#39;&lt;/span> inside device &lt;span class="s1">&amp;#39;/dev/nvme0n1p4&amp;#39;&lt;/span>...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:24:46 dd: 1+0 records in
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:24:46 dd: 1+0 records out
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:24:46 dd: &lt;span class="m">1&lt;/span> byte copied, 0.000131407 s, 7.6 kB/s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:24:46 fstransform: device file-system block &lt;span class="nv">size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">4096&lt;/span> bytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:24:46 fstransform: device usable &lt;span class="nv">size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">348535128064&lt;/span> bytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:24:46 dd: 1+0 records in
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:24:46 dd: 1+0 records out
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:24:46 dd: &lt;span class="m">1&lt;/span> byte copied, 0.000102059 s, 9.8 kB/s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:24:46 fstransform: connected loop device &lt;span class="s1">&amp;#39;/dev/loop11&amp;#39;&lt;/span> to file &lt;span class="s1">&amp;#39;/tmp/fstransform.mount.5394/.fstransform.loop.5394&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:24:46 fstransform: formatting loop device &lt;span class="s1">&amp;#39;/dev/loop11&amp;#39;&lt;/span> with file-system &lt;span class="nb">type&lt;/span> &lt;span class="s1">&amp;#39;btrfs&amp;#39;&lt;/span>...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:24:46 fstransform: mounting loop device &lt;span class="s1">&amp;#39;/dev/loop11&amp;#39;&lt;/span> on &lt;span class="s1">&amp;#39;/tmp/fstransform.loop.5394&amp;#39;&lt;/span> ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:24:46 fstransform: loop device &lt;span class="s1">&amp;#39;/dev/loop11&amp;#39;&lt;/span> mounted successfully.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:24:46 fstransform: preliminary steps completed, now comes the delicate part:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:24:46 fstransform: fstransform will move &lt;span class="s1">&amp;#39;/dev/nvme0n1p4&amp;#39;&lt;/span> contents into the loop file.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:24:46 fstransform: WARNING: THIS IS IMPORTANT! &lt;span class="k">if&lt;/span> either the original device &lt;span class="s1">&amp;#39;/dev/nvme0n1p4&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> or the loop device &lt;span class="s1">&amp;#39;/dev/loop11&amp;#39;&lt;/span> become FULL,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> YOU WILL LOSE YOUR DATA !
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> fstransform checks &lt;span class="k">for&lt;/span> enough available space,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> in any &lt;span class="k">case&lt;/span> it is recommended to open another terminal, &lt;span class="nb">type&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> watch df /dev/nvme0n1p4 /dev/loop11
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> and check that both the original device &lt;span class="s1">&amp;#39;/dev/nvme0n1p4&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> and the loop device &lt;span class="s1">&amp;#39;/dev/loop11&amp;#39;&lt;/span> are NOT becoming full.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> one of them is becoming full &lt;span class="o">(&lt;/span>or both&lt;span class="o">)&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> you MUST stop fstransform with CTRL+C or equivalent.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> this is your chance to quit.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> press ENTER to &lt;span class="k">continue&lt;/span>, or CTRL+C to quit:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:25:24 fstransform: moving &lt;span class="s1">&amp;#39;/dev/nvme0n1p4&amp;#39;&lt;/span> contents into the loop file.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:25:24 fstransform: this may take a long time, please be patient...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">15:25:24 fsmove: move&lt;span class="o">()&lt;/span> skipped &lt;span class="sb">`&lt;/span>/tmp/fstransform.mount.5394/.fstransform.loop.5394&lt;span class="s1">&amp;#39;, matches exclude list
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:25:45 fsmove: progress: 1.5% done, 180.7 gigabytes still to move
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:25:54 fsmove: progress: 2.9% done, 178.0 gigabytes still to move, estimated 15 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:26:07 fsmove: progress: 4.4% done, 175.3 gigabytes still to move, estimated 15 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:26:16 fsmove: progress: 5.9% done, 172.6 gigabytes still to move, estimated 15 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:26:21 fsmove: progress: 7.4% done, 169.9 gigabytes still to move, estimated 15 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:26:27 fsmove: progress: 8.8% done, 167.2 gigabytes still to move, estimated 15 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:26:33 fsmove: progress: 10.3% done, 164.5 gigabytes still to move, estimated 10 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:26:38 fsmove: progress: 11.8% done, 161.8 gigabytes still to move, estimated 10 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:26:46 fsmove: progress: 13.3% done, 159.1 gigabytes still to move, estimated 10 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:26:51 fsmove: progress: 14.7% done, 156.4 gigabytes still to move, estimated 10 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:26:56 fsmove: progress: 16.2% done, 153.7 gigabytes still to move, estimated 10 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:27:05 fsmove: progress: 17.7% done, 151.0 gigabytes still to move, estimated 8 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:27:10 fsmove: progress: 19.2% done, 148.3 gigabytes still to move, estimated 8 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:27:15 fsmove: progress: 20.6% done, 145.6 gigabytes still to move, estimated 6 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:27:30 fsmove: progress: 22.1% done, 142.9 gigabytes still to move, estimated 5 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:27:39 fsmove: progress: 23.6% done, 140.1 gigabytes still to move, estimated 5 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:27:44 fsmove: progress: 25.1% done, 137.4 gigabytes still to move, estimated 5 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:27:50 fsmove: progress: 26.5% done, 134.7 gigabytes still to move, estimated 6 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:28:00 fsmove: progress: 28.0% done, 132.0 gigabytes still to move, estimated 6 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:28:21 fsmove: progress: 29.5% done, 129.3 gigabytes still to move, estimated 5 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:28:26 fsmove: progress: 31.0% done, 126.6 gigabytes still to move, estimated 6 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:28:35 fsmove: progress: 32.4% done, 123.9 gigabytes still to move, estimated 6 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:28:49 fsmove: progress: 33.9% done, 121.2 gigabytes still to move, estimated 5 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:28:52 fsmove: progress: 35.4% done, 118.5 gigabytes still to move, estimated 8 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:28:58 fsmove: progress: 36.9% done, 115.8 gigabytes still to move, estimated 8 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:29:04 fsmove: progress: 38.3% done, 113.1 gigabytes still to move, estimated 6 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:29:09 fsmove: progress: 39.8% done, 110.4 gigabytes still to move, estimated 5 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:29:26 fsmove: progress: 41.3% done, 107.7 gigabytes still to move, estimated 6 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:29:44 fsmove: progress: 42.8% done, 105.0 gigabytes still to move, estimated 8 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:29:54 fsmove: progress: 44.2% done, 102.3 gigabytes still to move, estimated 7 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:30:02 fsmove: progress: 45.7% done, 99.6 gigabytes still to move, estimated 5 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:30:13 fsmove: progress: 47.2% done, 96.9 gigabytes still to move, estimated 6 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:30:22 fsmove: progress: 48.7% done, 94.2 gigabytes still to move, estimated 6 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:30:31 fsmove: progress: 50.1% done, 91.4 gigabytes still to move, estimated 4 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:30:42 fsmove: progress: 51.6% done, 88.7 gigabytes still to move, estimated 4 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:30:52 fsmove: progress: 53.1% done, 86.0 gigabytes still to move, estimated 4 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:31:06 fsmove: progress: 54.6% done, 83.3 gigabytes still to move, estimated 6 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:31:14 fsmove: progress: 56.0% done, 80.6 gigabytes still to move, estimated 7 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:31:19 fsmove: progress: 57.5% done, 77.9 gigabytes still to move, estimated 6 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:31:27 fsmove: progress: 59.0% done, 75.2 gigabytes still to move, estimated 4 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:31:32 fsmove: progress: 60.5% done, 72.5 gigabytes still to move, estimated 4 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:31:38 fsmove: progress: 61.9% done, 69.8 gigabytes still to move, estimated 4 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:31:45 fsmove: progress: 63.4% done, 67.1 gigabytes still to move, estimated 4 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:31:53 fsmove: progress: 64.9% done, 64.4 gigabytes still to move, estimated 4 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:31:58 fsmove: progress: 66.4% done, 61.7 gigabytes still to move, estimated 3 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:04 fsmove: progress: 67.8% done, 59.0 gigabytes still to move, estimated 3 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:12 fsmove: progress: 69.3% done, 56.3 gigabytes still to move, estimated 3 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:27 fsmove: progress: 70.8% done, 53.6 gigabytes still to move, estimated 2 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:33 fsmove: progress: 72.3% done, 50.9 gigabytes still to move, estimated 2 minutes left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:36 fsmove: job completed.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:36 fstransform: unmounting and running &amp;#39;&lt;/span>/sbin/fsck&lt;span class="s1">&amp;#39; (disk check) on loop file &amp;#39;&lt;/span>/tmp/fstransform.mount.5394/.fstransform.loop.5394&lt;span class="s1">&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:39 fsck: fsck from util-linux 2.31.1
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:39 fstransform: disconnected loop device &amp;#39;&lt;/span>/dev/loop11&lt;span class="s1">&amp;#39; from file &amp;#39;&lt;/span>/tmp/fstransform.mount.5394/.fstransform.loop.5394&lt;span class="s1">&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:39 fstransform: unmounting device &amp;#39;&lt;/span>/dev/nvme0n1p4&lt;span class="s1">&amp;#39; before disk check
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:42 fstransform: running &amp;#39;&lt;/span>/sbin/fsck&lt;span class="s1">&amp;#39; (disk check) on device &amp;#39;&lt;/span>/dev/nvme0n1p4&lt;span class="s1">&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:42 fsck: fsck from util-linux 2.31.1
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:42 fsck: home: Inode 3336 extent tree (at level 2) could be narrower. IGNORED.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:43 fsck: home: 12/21274624 files (0.0% non-contiguous), 36800594/85091584 blocks
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:43 fstransform: mounting again device &amp;#39;&lt;/span>/dev/nvme0n1p4&lt;span class="s1">&amp;#39; read-only
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:43 fstransform: launching &amp;#39;&lt;/span>/usr/sbin/fsremap&lt;span class="s1">&amp;#39; in simulated mode
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:43 fsremap: starting job 1, persistence data and logs are in &amp;#39;&lt;/span>/var/tmp/fstransform/fsremap.job.1&lt;span class="s1">&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:43 fsremap: if this job is interrupted, for example by a power failure,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:43 fsremap: you CAN RESUME it with: /usr/sbin/fsremap -n -q --resume-job=1 -- /dev/nvme0n1p4
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:43 fsremap: analysis completed: 135.22 gigabytes must be relocated
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:45 fsremap: allocated 3.50 gigabytes RAM as memory buffer
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:45 fsremap: primary-storage is 7.01 gigabytes, initialized and mmapped() to contiguous RAM
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:45 fsremap: (simulated) starting in-place remapping. this may take a LONG time ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:45 fsremap: (simulated) progress: 2.6% done, 135.2 gigabytes still to relocate
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:45 fsremap: (simulated) progress: 69.0% done, 45.4 gigabytes still to relocate
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:45 fsremap: (simulated) clearing 1.38 gigabytes free-space from device ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:45 fsremap: (simulated) job completed.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:45 fstransform: launching &amp;#39;&lt;/span>/usr/sbin/fsremap&lt;span class="s1">&amp;#39; in REAL mode to perform in-place remapping.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:45 fsremap: starting job 2, persistence data and logs are in &amp;#39;&lt;/span>/var/tmp/fstransform/fsremap.job.2&lt;span class="s1">&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:45 fsremap: if this job is interrupted, for example by a power failure,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:45 fsremap: you CAN RESUME it with: /usr/sbin/fsremap -q --resume-job=2 -- /dev/nvme0n1p4
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:45 fsremap: analysis completed: 135.22 gigabytes must be relocated
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:46 fsremap: allocated 3.50 gigabytes RAM as memory buffer
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:49 fsremap: primary-storage is 7.01 gigabytes, initialized and mmapped() to contiguous RAM
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:49 fsremap: successfully unmounted device &amp;#39;&lt;/span>/dev/nvme0n1p4&lt;span class="s1">&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:49 fsremap: everything ready for in-place remapping, this is your LAST chance to quit.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:32:49 fsremap: WARN: press ENTER to proceed, or CTRL+C to quit
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:33:32 fsremap: starting in-place remapping. this may take a LONG time ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:33:43 fsremap: progress: 2.6% done, 135.2 gigabytes still to relocate
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:36:29 fsremap: progress: 69.0% done, 45.4 gigabytes still to relocate, estimated 1 minute and 20 seconds left
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:37:43 fsremap: clearing 1.38 gigabytes free-space from device ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:41:25 fsremap: job completed.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:41:28 fstransform: running again &amp;#39;&lt;/span>/sbin/fsck&lt;span class="s1">&amp;#39; (disk check) on device &amp;#39;&lt;/span>/dev/nvme0n1p4&lt;span class="s1">&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:41:28 fsck: fsck from util-linux 2.31.1
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">15:41:28 fstransform: completed successfully. device &amp;#39;&lt;/span>/dev/nvme0n1p4&lt;span class="s1">&amp;#39; now contains &amp;#39;&lt;/span>btrfs&lt;span class="err">&amp;#39;&lt;/span> file-system
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>转换完毕后挂载随便看几个文件看是不是正常，一般是OK的，然后改一下挂载参数
&lt;code>/etc/fstab&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">UUID&lt;/span>&lt;span class="o">=&lt;/span>361c83ca-fa86-417a-96ce-29569c9bc98e /home btrfs ssd,noatime,subvol&lt;span class="o">=&lt;/span>/ &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>下一步再搞一下透明压缩（用lzo算法）：&lt;/p>
&lt;p>&lt;code>btrfs filesystem defragment -v -clzo /mountpoint&lt;/code>&lt;/p>
&lt;p>注意这是压缩已有文件。如果要真正的“实时透明压缩”请在挂载参数上加&lt;code>compress-force=lzo&lt;/code>，这样存进去的文件都会被压缩了。&lt;/p>
&lt;p>玩一玩子卷&lt;code>subvolume&lt;/code>&lt;/p>
&lt;p>新建只读子卷，当做备份&lt;/p>
&lt;p>&lt;code>sudo btrfs subvolume snapshot -r /@ /@backup&lt;/code>&lt;/p>
&lt;p>若干天后可能胡折腾系统挂了，需要还原&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">1. 删除原来启动的子卷
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo btrfs subvolume delete /@
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2. 从原来备份的子卷再建一个同名子卷
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo btrfs subvolume snapshot /@backup /@
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>所有更改就又回来了&lt;/p>
&lt;p>不习惯手动挡可以用这个自动挡：&lt;a href="https://github.com/teejee2008/timeshift">timeshift&lt;/a>&lt;/p>
&lt;p>BTRFS大法好!&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>JetBrains全家桶升级到2019.3无法使用输入法的解决方法</title><link>https://blog.ferstar.org/post/issue-15/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-15/</guid><pubDate>Wed, 15 Jan 2020 08:24:42 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>created_date: 2020-01-15T08:24:42+08:00&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>update_date: 2020-03-27T01:35:05+08:00&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>comment_url: &lt;a href="https://github.com/ferstar/blog/issues/15">https://github.com/ferstar/blog/issues/15&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>我用的是PyCharm，也遇到这个问题，后来在官方论坛找到了解决方法：&lt;/p>
&lt;p>&lt;a href="https://intellij-support.jetbrains.com/hc/en-us/community/posts/360006740379/comments/360001272440">https://intellij-support.jetbrains.com/hc/en-us/community/posts/360006740379/comments/360001272440&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>Hello everyone!&lt;/p>
&lt;p>Please use the following VM option -Dauto.disable.input.methods=false to resolve the problem.&lt;/p>
&lt;/blockquote>
&lt;p>我的&lt;code>pycharm64.vmoptions&lt;/code>文件内容如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">-Xms1024m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-Xmx4096m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-XX:ReservedCodeCacheSize&lt;span class="o">=&lt;/span>1024m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-XX:+UseCompressedOops
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-XX:+UseConcMarkSweepGC
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-XX:SoftRefLRUPolicyMSPerMB&lt;span class="o">=&lt;/span>&lt;span class="m">50&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-ea
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-XX:CICompilerCount&lt;span class="o">=&lt;/span>&lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-Dsun.io.useCanonPrefixCache&lt;span class="o">=&lt;/span>&lt;span class="nb">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-Djava.net.preferIPv4Stack&lt;span class="o">=&lt;/span>&lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-Djdk.http.auth.tunneling.disabledSchemes&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-XX:+HeapDumpOnOutOfMemoryError
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-XX:-OmitStackTraceInFastThrow
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-Djdk.attach.allowAttachSelf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-Dkotlinx.coroutines.debug&lt;span class="o">=&lt;/span>off
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-Djdk.module.illegalAccess.silent&lt;span class="o">=&lt;/span>&lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-Dawt.useSystemAAFontSettings&lt;span class="o">=&lt;/span>lcd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-Dsun.java2d.renderer&lt;span class="o">=&lt;/span>sun.java2d.marlin.MarlinRenderingEngine
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-Dsun.tools.attach.tmp.only&lt;span class="o">=&lt;/span>&lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-Dauto.disable.input.methods&lt;span class="o">=&lt;/span>&lt;span class="nb">false&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>Tornado专题</title><link>https://blog.ferstar.org/post/issue-14/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-14/</guid><pubDate>Fri, 03 Jan 2020 13:10:40 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;h5 id="1-断点续传分片下载">1. 断点续传/分片下载&lt;/h5>
&lt;blockquote>
&lt;p>抄这里的实现，主要应用场景就是某个接口要提供导出某某静态文件啊什么的，直接把文件绝对路径传给&lt;code>export&lt;/code>方法即可。&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>&lt;a href="https://github.com/kzahel/tornado_gen/blob/master/tornado/web.py#L1414">https://github.com/kzahel/tornado_gen/blob/master/tornado/web.py#L1414&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;span class="lnt">107
&lt;/span>&lt;span class="lnt">108
&lt;/span>&lt;span class="lnt">109
&lt;/span>&lt;span class="lnt">110
&lt;/span>&lt;span class="lnt">111
&lt;/span>&lt;span class="lnt">112
&lt;/span>&lt;span class="lnt">113
&lt;/span>&lt;span class="lnt">114
&lt;/span>&lt;span class="lnt">115
&lt;/span>&lt;span class="lnt">116
&lt;/span>&lt;span class="lnt">117
&lt;/span>&lt;span class="lnt">118
&lt;/span>&lt;span class="lnt">119
&lt;/span>&lt;span class="lnt">120
&lt;/span>&lt;span class="lnt">121
&lt;/span>&lt;span class="lnt">122
&lt;/span>&lt;span class="lnt">123
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 你肯定得有个类似`BaseHandler`的类&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">BaseHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tornado&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">web&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">RequestHandler&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">kwargs&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;此处省略若干自定义初始化过程&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">pass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">export&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">abs_path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file_name&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">content_type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">set_content_length&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">this&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">req_range&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">getsize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">req_range&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">start&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">end&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">req_range&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">start&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="n">start&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">size&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">or&lt;/span> &lt;span class="n">end&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># As per RFC 2616 14.35.1, a range is not satisfiable only: if&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># the first requested byte is equal to or greater than the&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># content, or when a suffix with length 0 is specified&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set_status&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">416&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># Range Not Satisfiable&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set_header&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Content-Type&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;text/plain&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set_header&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Content-Range&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;bytes */&lt;/span>&lt;span class="si">%s&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">,))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">start&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">start&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="n">start&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">start&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">size&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">end&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="n">end&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">size&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Clients sometimes blindly use a large range to limit their&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># download size; cap the endpoint at the actual file size.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">end&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">size&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Note: only return HTTP 206 if less than the entire range has been&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># requested. Not only is this semantically correct, but Chrome&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># refuses to play audio if it gets an HTTP 206 in response to&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># ``Range: bytes=0-``.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">size&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">end&lt;/span> &lt;span class="ow">or&lt;/span> &lt;span class="n">size&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">start&lt;/span> &lt;span class="ow">or&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set_status&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">206&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># Partial Content&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># pylint: disable=protected-access&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set_header&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Content-Range&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">httputil&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_get_content_range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">start&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">end&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">start&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">end&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">start&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="n">end&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">length&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">end&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">start&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="n">end&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">length&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="n">start&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">length&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">size&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">start&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">length&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">size&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set_header&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Content-Length&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">length&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">start&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">end&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">get_content_type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">mime_type&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">encoding&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">mimetypes&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">guess_type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># per RFC 6713, use the appropriate type for a gzip compressed file&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">encoding&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;gzip&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="s2">&amp;#34;application/gzip&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># As of 2015-07-21 there is no bzip2 encoding defined at&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># http://www.iana.org/assignments/media-types/media-types.xhtml&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># So for that (and any other encoding), use octet-stream.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="n">encoding&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="s2">&amp;#34;application/octet-stream&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="n">mime_type&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">mime_type&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># if mime_type not detected, use application/octet-stream&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="s2">&amp;#34;application/octet-stream&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">get_content&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">abspath&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">start&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">end&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">abspath&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;rb&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">start&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">file&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">seek&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">start&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">end&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">remaining&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">end&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">start&lt;/span> &lt;span class="ow">or&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">remaining&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="kc">True&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">chunk_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">64&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">1024&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">remaining&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="n">remaining&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">chunk_size&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">chunk_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">remaining&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">chunk&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">chunk_size&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">chunk&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">remaining&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">remaining&lt;/span> &lt;span class="o">-=&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">chunk&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">yield&lt;/span> &lt;span class="n">chunk&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">remaining&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">assert&lt;/span> &lt;span class="n">remaining&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">abs_path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">bytes&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set_header&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Content-Type&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sa">f&lt;/span>&lt;span class="s1">&amp;#39;application/&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">content_type&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">file_name&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">file_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">urllib&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parse&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">quote&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file_name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set_header&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Content-Disposition&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sa">f&lt;/span>&lt;span class="s1">&amp;#39;attachment; filename=&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">file_name&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">finish&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">abs_path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">exists&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">abs_path&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">raise&lt;/span> &lt;span class="n">CustomError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">_&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;File not found&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">file_name&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">file_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">basename&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">abs_path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">file_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">urllib&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parse&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">quote&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file_name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set_header&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Content-Disposition&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sa">f&lt;/span>&lt;span class="s1">&amp;#39;attachment; filename=&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">file_name&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">content_type&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">content_type&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">get_content_type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">abs_path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set_header&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Content-Type&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">content_type&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set_header&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Accept-Ranges&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;bytes&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set_header&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Last-Modified&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">utcfromtimestamp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">getmtime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">abs_path&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">request_range&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">range_header&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">headers&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Range&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">range_header&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># As per RFC 2616 14.16, if an invalid Range header is specified,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># the request will be treated as if the header didn&amp;#39;t exist.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">request_range&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">httputil&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_parse_request_range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">range_header&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># pylint: disable=protected-access&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">start&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">end&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">set_content_length&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">abs_path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">request_range&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">method&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;GET&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">content&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">get_content&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">abs_path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">start&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">end&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">content&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">bytes&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">content&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">content&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">chunk&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">content&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">chunk&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span> &lt;span class="n">iostream&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">StreamClosedError&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">assert&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">method&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;HEAD&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h5 id="2-csrf">2. CSRF&lt;/h5>
&lt;blockquote>
&lt;p>&lt;a href="https://en.wikipedia.org/wiki/Cross-site_request_forgery">维基传送门&lt;/a>，这里只说说咋防&lt;/p>
&lt;/blockquote>
&lt;p>其实tornado已经有对应的&lt;a href="https://github.com/tornadoweb/tornado/blob/master/tornado/web.py#L1489">实现&lt;/a>，
大概就是每次请求多带一个预先分发的token，然后用浏览器cookie里的token跟这个做比对&lt;/p>
&lt;p>但实际实施过程中总有些接口比如&lt;code>/login&lt;/code>，都没登录自然拿不到派发的&lt;code>_xsrf&lt;/code>，所以这个接口不能开&lt;code>csrf&lt;/code>验证，再比如我们各个微服务间的通讯一般是用基于token的认证方式，这种方式是免疫&lt;code>csrf&lt;/code>的，自然也不需要验证，基于可能的自定义需求，我们需要重写这个方法&lt;code>check_xsrf_cookie&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 你肯定得有个类似`BaseHandler`的类&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">BaseHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tornado&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">web&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">RequestHandler&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">kwargs&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;此处省略若干自定义初始化过程&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">pass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">check_xsrf_cookie&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">method&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;GET&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;HEAD&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;OPTIONS&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">or&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">get_config&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;xsrf开关&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">False&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">route_ext&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">get_config&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;不检查的路由白名单&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[]):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">re&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">rf&lt;/span>&lt;span class="s1">&amp;#39;不检查的路由&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">logging&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">debug&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Skip xsrf check: &lt;/span>&lt;span class="si">%s&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 可能有些系统内接口用的是token认证，那么这些接口也是不需要检查xsrf的，所以也要跳过&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">url&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">full_url&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">query&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">urllib&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parse&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">urlparse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">url&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">query&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">params&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">urllib&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parse&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parse_qs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">query&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">query&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">all&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">k&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">v&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">items&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">k&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;藏在url里的token key1&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;藏在url里的token key2&amp;#39;&lt;/span>&lt;span class="p">)]&lt;/span> &lt;span class="ow">or&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">]):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">logging&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">debug&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Skip xsrf check: &lt;/span>&lt;span class="si">%s&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">super&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">BaseHandler&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">check_xsrf_cookie&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span> &lt;span class="n">tornado&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">web&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">HTTPError&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">exp&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 返回一个对前端友好的错误消息提示&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">custom_error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">exp&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">status_code&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">exp&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 你的Application类需要塞进去点参数&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Application&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tornado&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">web&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Application&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">settings&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;compiled_template_cache&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">False&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;template_path&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;templates&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;serve_traceback&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">get_config&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;要不要开调试&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">True&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;xsrf_cookies&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">get_config&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;要不要开xsrf验证&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">False&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;xsrf_cookie_kwargs&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">dict&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">httponly&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="c1"># _xsrf cookie 加个`httponly`的属性，这样脚本就没办法偷你的cookie了&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;cookie_secret&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;a_u_ok?&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">tornado&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">web&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Application&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">handlers&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">debug&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">get_config&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;要不要开调试&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">True&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">settings&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>接下来告诉前端同学，任何&lt;code>POST&lt;/code>，&lt;code>DELETE&lt;/code>，&lt;code>PUT&lt;/code>请求都带上&lt;code>_xsrf&lt;/code>参数或者&lt;code>X-Xsrftoken&lt;/code>请求头或者&lt;code>X-Csrftoken&lt;/code>请求头，不要问为什么，问就甩&lt;a href="https://github.com/tornadoweb/tornado/blob/master/tornado/web.py#L1513">源码&lt;/a>&lt;/p>
&lt;h5 id="3-自适应修正可能错误的-content-type-post-请求头">&lt;del>3. 自适应修正可能错误的 Content-Type POST 请求头&lt;/del>&lt;/h5>
&lt;blockquote>
&lt;p>&lt;del>后端N久没动的一个接口被产品吐槽出bug了，debug发现原来是前端的锅，原本这个接口要求 Content-Type 得是 multipart/form-data，然而前端某次重构后，这个 Content-Type 变成了 application/json，于是在没有经过充分回归测试的情况下，bug出现了，接口没办法正常拿到正确的参数。&lt;/del>&lt;/p>
&lt;/blockquote>
&lt;p>&lt;del>定位到问题后，解决就很简单了，要么前端抖抖小手把这个header写对，要么后端在接收 POST 请求之前把 header 改对。介于我司小厂，测试不足，所以我还是双保险，后端也对这种情况做一个兼容。&lt;/del>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">BaseHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tornado&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">web&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">RequestHandler&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">SessionMixin&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">application&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">kwargs&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">super&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">BaseHandler&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">application&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">kwargs&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 一系列init方法&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">prepare&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> Called at the beginning of a request before `get`/`post`/etc.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">method&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;POST&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;PUT&amp;#39;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">adapt_req_headers&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">adapt_req_headers&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;根据request body自适应修正Content-Type&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">form_data_prefix&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;multipart/form-data;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">content_disp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="sa">b&lt;/span>&lt;span class="s1">&amp;#39;Content-Disposition: form-data;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">www_form_prefix&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;application/x-www-form-urlencoded&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">parse_body&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_parse_body&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1"># pylint: disable=protected-access&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">logging&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">warning&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Content-Type does not match the request body, will correct it&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">body&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ow">not&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">headers&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Content-Type&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">startswith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">form_data_prefix&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ow">and&lt;/span> &lt;span class="n">content_disp&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">body&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">boundary&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">body&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">b&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="se">\r\n&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">:]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">decode&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="ow">or&lt;/span> &lt;span class="s1">&amp;#39;boundary&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span> &lt;span class="ne">UnicodeDecodeError&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">exp&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">logging&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">exception&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">exp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">headers&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">update&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="s1">&amp;#39;Content-Type&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="sa">f&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">form_data_prefix&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1"> boundary=&amp;#34;&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">boundary&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#34;&amp;#39;&lt;/span>&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">parse_body&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">headers&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Content-Type&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">startswith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">www_form_prefix&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="nb">all&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">[&lt;/span>&lt;span class="nb">all&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">partition&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">b&lt;/span>&lt;span class="s1">&amp;#39;=&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">body&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">b&lt;/span>&lt;span class="s1">&amp;#39;&amp;amp;&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">content_disp&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ow">or&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kc">False&lt;/span>&lt;span class="p">,)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">headers&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">update&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="s1">&amp;#39;Content-Type&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">www_form_prefix&lt;/span>&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">parse_body&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h5 id="4-跨域资源共享cors">4. 跨域资源共享(CORS)&lt;/h5>
&lt;blockquote>
&lt;p>跨域资源共享(CORS) 是一种机制，它使用额外的HTTP 头来告诉浏览器 让运行在一个origin (domain) 上的Web应用被准许访问来自不同源服务器上的指定的资源。 当一个资源从与该资源本身所在的服务器不同的域、协议或端口请求一个资源时，资源会发起一个跨域HTTP 请求。&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>tornado 正确处理 CORS 请求的代码如下&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">set_cors_header&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">origin&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="sa">f&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">headers&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Origin&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rstrip&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">trust_hosts&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">origin&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">trust_hosts&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">logging&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">warning&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s1">&amp;#39;Untrusted source request detected: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">origin&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># NOTE: Can&amp;#39;t be set &amp;#34;*&amp;#34; because a valid request always sending with cookies&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># which will be blocked by CORS policy&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set_header&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Access-Control-Allow-Origin&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">origin&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Must be set as &amp;#34;true&amp;#34;(case sensitive) to allow CORS with cookies&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set_header&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Access-Control-Allow-Credentials&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;true&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set_header&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Access-Control-Allow-Methods&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;POST, GET, PUT, DELETE, OPTIONS&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Must contain all possible request headers from frontend requests&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set_header&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Access-Control-Allow-Headers&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Accept, Accept-Encoding, Accept-Language, Access-Control-Request-Headers, Access-Control-Request-Method, &amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Cache-Control, Connection, Content-Type, &amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Host, Origin, Pragma, Referer, Sec-Fetch-Mode, User-Agent, X-Csrftoken&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>参考:&lt;/p>
&lt;p>&lt;a href="https://fullstackbb.com/http/options-method-and-cors-preflight/">https://fullstackbb.com/http/options-method-and-cors-preflight/&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS&lt;/a>&lt;/p>
&lt;h5 id="5-under-tornado-v4-websocket-connections-get-refused-with-403">5. Under tornado v4+ WebSocket connections get refused with 403&lt;/h5>
&lt;blockquote>
&lt;p>&lt;a href="https://stackoverflow.com/a/24800437">https://stackoverflow.com/a/24800437&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>简单说就是基于安全原因, 新一点的 Tornado 版本在 ws 增加了 同源 校验&lt;/p>
&lt;p>Tornado 4.0 introduced an, on by default, same origin check. This checks that the origin header set by the browser is the same as the host header&lt;/p>
&lt;p>The &lt;a href="https://github.com/tornadoweb/tornado/blob/master/tornado/websocket.py#L274">code looks like:&lt;/a>&lt;/p>
&lt;pre tabindex="0">&lt;code> def check_origin(self, origin):
&amp;#34;&amp;#34;&amp;#34;Override to enable support for allowing alternate origins.
The ``origin`` argument is the value of the ``Origin`` HTTP header,
the url responsible for initiating this request.
.. versionadded:: 4.0
&amp;#34;&amp;#34;&amp;#34;
parsed_origin = urlparse(origin)
origin = parsed_origin.netloc
origin = origin.lower()
host = self.request.headers.get(&amp;#34;Host&amp;#34;)
# Check to see that origin matches host directly, including ports
return origin == host
&lt;/code>&lt;/pre>&lt;p>In order for your proxied websocket connection to still work you will need to override check origin on the WebSocketHandler and whitelist the domains that you care about. Something like this.&lt;/p>
&lt;pre tabindex="0">&lt;code>import re
from tornado import websocket
class YouConnection(websocket.WebSocketHandler):
def check_origin(self, origin):
return bool(re.match(r&amp;#39;^.*?\.mydomain\.com&amp;#39;, origin))
&lt;/code>&lt;/pre>&lt;p>This will let the connections coming through from &lt;code>info.mydomain.com&lt;/code> to get through as before.&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2020-01-03T13:10:40+08:00
update@2021-11-30T04:16:11+08:00
comment@https://github.com/ferstar/blog/issues/14
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/todo/">TODO</category></item><item><title>宝宝日常</title><link>https://blog.ferstar.org/post/issue-13/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-13/</guid><pubDate>Thu, 02 Jan 2020 12:14:45 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>&lt;em>2020年了，在这里记录下关于宝宝的日常，希望她健康成长&lt;/em>&lt;/p>
&lt;/blockquote>
&lt;h5 id="1-爬爬垫是有必要的">1. 爬爬垫是有必要的&lt;/h5>
&lt;h5 id="2-磨牙棒是个好东西">2. 磨牙棒是个好东西&lt;/h5>
&lt;blockquote>
&lt;p>吮吸手指的次数明显变少&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>口水泗流的情况也大为缓解&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>安慰作用明显&lt;/p>
&lt;/blockquote>
&lt;p>我买的是这一款，不会糊的满脸都是，宝宝很喜欢。
&lt;img src="https://user-images.githubusercontent.com/2854276/72357324-bcdae080-3725-11ea-931b-a97f597064dd.jpg" alt="photo_2020-01-14_23-29-04">&lt;/p>
&lt;h5 id="3-尽可能的多晒太阳">3. 尽可能的多晒太阳&lt;/h5>
&lt;blockquote>
&lt;p>去黄疸有奇效&lt;/p>
&lt;/blockquote>
&lt;h5 id="4-生出来之前几乎所有囤货都是大概率失败的">4. 生出来之前，几乎所有囤货都是大概率失败的&lt;/h5>
&lt;blockquote>
&lt;p>比如尿不湿，没人肉体验之前你不知道哪款才不会红屁屁，我宝只有穿花王才不会红屁屁 ，之前囤的好奇就悲剧了，总不能自己穿:sob:&lt;/p>
&lt;/blockquote>
&lt;h5 id="5-关于黄疸">5. 关于黄疸&lt;/h5>
&lt;ol>
&lt;li>不要轻易停母乳&lt;/li>
&lt;li>不要轻易给宝宝喂茵栀黄口服液&lt;/li>
&lt;li>多晒太阳&lt;/li>
&lt;li>自购黄疸灯比把宝宝放医院灯箱好&lt;/li>
&lt;li>褪黄时间个体差异巨大，没有特别严格的标准，只要宝宝精神正常，能吃能拉，管球多久褪，我宝3个月才褪掉&lt;/li>
&lt;/ol>
&lt;h5 id="6-辅食6个月后就可以添母乳会越来越不顶饱的">6. 辅食6个月后就可以添，母乳会越来越不顶饱的&lt;/h5>
&lt;h5 id="7-买了米高的滑板车-质量不错-宝宝很喜欢-然而很快就不小心摔伤了">7. 买了米高的滑板车, 质量不错, 宝宝很喜欢, 然而很快就不小心摔伤了&lt;/h5>
&lt;h5 id="8-前天把闺女打了后悔不已">8. 前天把闺女打了，后悔不已&lt;/h5>
&lt;p>主要就是早上起来赖床耍脾气不穿衣服，光屁股满屋子跑，此为背景。眼看已经迟到，没忍住抽了几巴掌屁股，事后果然又心疼又后悔。想了一天咋给闺女道歉，结果晚上下班回家开门直接还是一如既往的给我一个大大的拥抱，似乎完全不记得早上挨打的事情。&lt;/p>
&lt;p>我要忏悔，要养气，要讲究疏导方法，要淡定。。。&lt;/p>
&lt;h5 id="9-发现个超棒的玩具弹射竹蜻蜓">9. 发现个超棒的玩具：弹射竹蜻蜓&lt;/h5>
&lt;p>女儿很喜欢，逗猫一级棒&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2020-01-02T12:14:45+08:00
update@2022-12-21T05:05:24+08:00
comment@https://github.com/ferstar/blog/issues/13
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/baby/">Baby</category></item><item><title>利用 GitHub Issues 持续写博灌水</title><link>https://blog.ferstar.org/post/issue-12/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-12/</guid><pubDate>Thu, 02 Jan 2020 11:41:46 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>如题，有好的想法随时开&lt;code>issue&lt;/code>写一发，然后借助&lt;code>CI&lt;/code>自动把同一&lt;code>issue&lt;/code>下的&lt;code>comments&lt;/code>都拼接到一起，生成&lt;code>post&lt;/code>。&lt;/p>
&lt;p>每次想到什么写什么，不论多少，没有一定要写完的压力，日积月累，应该会能形成一些起码篇幅不小的博文，想想都好激动的说。&lt;/p>
&lt;p>基本思路就是：&lt;/p>
&lt;ol>
&lt;li>新建一个issue，或者评论一个issue&lt;/li>
&lt;li>触发一个issue event&lt;/li>
&lt;li>利用webhook将这个event推送到vps&lt;/li>
&lt;li>解析event中的issue id&lt;/li>
&lt;li>通过issue id调用github api获得issue及comments正文&lt;/li>
&lt;li>拼装成hugo post&lt;/li>
&lt;li>提交到blog repo&lt;/li>
&lt;li>触发push event&lt;/li>
&lt;li>vps收到push event后拉取blog repo最新提交&lt;/li>
&lt;li>调用hugo命令重新生成blog页面&lt;/li>
&lt;/ol>
&lt;p>其实就是issue+comments到hugo post的一个转换过程，对应关系如下：&lt;/p>
&lt;pre tabindex="0">&lt;code>issue label --&amp;gt; hugo tags
issue + comments --&amp;gt; hugo article(post)
issue create date --&amp;gt; hugo post time
issue or comments update date --&amp;gt; hugo post update date
comments --&amp;gt; hugo post comments
&lt;/code>&lt;/pre>&lt;p>除&lt;code>1&lt;/code>需要人肉参与外，剩余流程都可以自动进行，也即所谓的&lt;code>CI&lt;/code>（实现这样一个流程想想其实还是有一定的技术门槛的）&lt;/p>
&lt;p>搭配 GitHub Actions 食用似乎味道更佳~&lt;/p>
&lt;blockquote>
&lt;p>不知不觉 Actions 积累了一大堆 runs, 貌似目前为止(2022年01月07日) GitHub 无法批量删除这些无用的 runs, 所以写了个脚本处理下&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>更舒服的使用姿势是, 随便找个云服务商建个账号, 撸一下函数服务, 设好定时执行即可, 非常舒服&lt;/p>
&lt;/blockquote>
&lt;p>&lt;a href="https://gist.github.com/ferstar/972623e6a7af464d5437d4a3b710ade2">https://gist.github.com/ferstar/972623e6a7af464d5437d4a3b710ade2&lt;/a>&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2020-01-02T11:41:46+08:00
update@2022-01-07T01:29:40+08:00
comment@https://github.com/ferstar/blog/issues/12
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/idea/">Idea</category><category domain="https://blog.ferstar.org/tags/git/">Git</category><category domain="https://blog.ferstar.org/tags/todo/">TODO</category></item><item><title>Ubuntu优化</title><link>https://blog.ferstar.org/post/issue-11/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-11/</guid><pubDate>Thu, 02 Jan 2020 11:29:24 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;h2 id="1-关闭错误报告">1. 关闭错误报告&lt;/h2>
&lt;blockquote>
&lt;p>可以选择直接卸载&lt;code>apport&lt;/code>这个软件包, 但最好还是改配置&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 看说明&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo vi /etc/default/apport
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>贴个图&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://user-images.githubusercontent.com/2854276/71665297-49d18180-2d97-11ea-81d5-ce927479c346.png" alt="DeepinScreenshot_select-area_20200102193713">&lt;/p>
&lt;h2 id="2关于根分区文件系统的选择">2.关于根分区文件系统的选择&lt;/h2>
&lt;blockquote>
&lt;p>&lt;code>ext4&lt;/code>老当益壮，选他没错&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>&lt;code>btrfs&lt;/code>真香, subvolume很赞!&lt;/p>
&lt;/blockquote>
&lt;p>拿了个64GB的U盘（因为我想搞个Ubuntu2GO的东东）跑了下分：&lt;/p>
&lt;p>跑分代码如下，哪抄的忘了，就是随机建大量小文件，然后再写&amp;amp;读，看耗时多少&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="ch">#!/usr/bin/python&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># -*- coding: utf-8 -*-&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">filecount&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">30000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">filesize&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1024&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">random&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="nn">time&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">os&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">system&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">flush&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;sudo su -c &amp;#39;sync ; echo 3 &amp;gt; /proc/sys/vm/drop_caches&amp;#39;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">randfile&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;/dev/urandom&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;r&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">create test folder:&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">starttime&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">system&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;rm -rf test &amp;amp;&amp;amp; mkdir test&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">starttime&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">system&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">flush&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">create files:&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">starttime&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">xrange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">filecount&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rand&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">randfile&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">filesize&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mf">0.5&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">filesize&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">random&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">random&lt;/span>&lt;span class="p">()))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">outfile&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;test/&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">unicode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s2">&amp;#34;w&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">outfile&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rand&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">starttime&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">system&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">flush&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">rewrite files:&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">starttime&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">xrange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">filecount&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">)):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rand&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">randfile&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">filesize&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mf">0.5&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">filesize&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">random&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">random&lt;/span>&lt;span class="p">()))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">outfile&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;test/&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">unicode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">random&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">random&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">filecount&lt;/span>&lt;span class="p">)),&lt;/span> &lt;span class="s2">&amp;#34;w&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">outfile&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rand&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">starttime&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">system&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">flush&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">read linear:&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">starttime&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">xrange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">filecount&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">)):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">infile&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;test/&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">unicode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s2">&amp;#34;r&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">outfile&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">infile&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">starttime&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">system&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">flush&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">read random:&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">starttime&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">outfile&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;/dev/null&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;w&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">xrange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">filecount&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">)):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">infile&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;test/&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">unicode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">random&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">random&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">filecount&lt;/span>&lt;span class="p">)),&lt;/span> &lt;span class="s2">&amp;#34;r&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">outfile&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">infile&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">starttime&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">system&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">flush&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">delete all files:&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">starttime&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">system&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;rm -rf test&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">starttime&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">system&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">flush&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>U盘被我格成这样：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># sudo gdisk -l /dev/sda&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Disk /dev/sda: &lt;span class="m">124822487&lt;/span> sectors, 59.5 GiB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Model: ROS2GO
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sector size &lt;span class="o">(&lt;/span>logical/physical&lt;span class="o">)&lt;/span>: 512/512 bytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Disk identifier &lt;span class="o">(&lt;/span>GUID&lt;span class="o">)&lt;/span>: B3D0C73A-433D-44C1-8F80-FA90167AAADC
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Partition table holds up to &lt;span class="m">128&lt;/span> entries
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Main partition table begins at sector &lt;span class="m">2&lt;/span> and ends at sector &lt;span class="m">33&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">First usable sector is 34, last usable sector is &lt;span class="m">124822453&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Partitions will be aligned on 2048-sector boundaries
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Total free space is &lt;span class="m">1942420&lt;/span> sectors &lt;span class="o">(&lt;/span>948.4 MiB&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Number Start &lt;span class="o">(&lt;/span>sector&lt;span class="o">)&lt;/span> End &lt;span class="o">(&lt;/span>sector&lt;span class="o">)&lt;/span> Size Code Name
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">1&lt;/span> &lt;span class="m">2048&lt;/span> &lt;span class="m">20482047&lt;/span> 9.8 GiB &lt;span class="m">8300&lt;/span> ext4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">2&lt;/span> &lt;span class="m">20482048&lt;/span> &lt;span class="m">40962047&lt;/span> 9.8 GiB &lt;span class="m">8300&lt;/span> btrfs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">3&lt;/span> &lt;span class="m">40962048&lt;/span> &lt;span class="m">61442047&lt;/span> 9.8 GiB &lt;span class="m">8300&lt;/span> f2fs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">4&lt;/span> &lt;span class="m">61442048&lt;/span> &lt;span class="m">81922047&lt;/span> 9.8 GiB &lt;span class="m">8300&lt;/span> xfs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">5&lt;/span> &lt;span class="m">81922048&lt;/span> &lt;span class="m">102402047&lt;/span> 9.8 GiB &lt;span class="m">8300&lt;/span> reiserfs
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>各分区挂载参数均是Ubuntu系统默认参数&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">f2fs &lt;span class="o">(&lt;/span>rw,nosuid,nodev,relatime,lazytime,background_gc&lt;span class="o">=&lt;/span>on,discard,no_heap,user_xattr,inline_xattr,acl,inline_data,inline_dentry,flush_merge,extent_cache,mode&lt;span class="o">=&lt;/span>adaptive,active_logs&lt;span class="o">=&lt;/span>6,alloc_mode&lt;span class="o">=&lt;/span>reuse,fsync_mode&lt;span class="o">=&lt;/span>posix,uhelper&lt;span class="o">=&lt;/span>udisks2&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">btrfs &lt;span class="o">(&lt;/span>rw,nosuid,nodev,relatime,space_cache,subvolid&lt;span class="o">=&lt;/span>5,subvol&lt;span class="o">=&lt;/span>/,uhelper&lt;span class="o">=&lt;/span>udisks2&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ext4 &lt;span class="o">(&lt;/span>rw,nosuid,nodev,relatime,uhelper&lt;span class="o">=&lt;/span>udisks2&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">xfs &lt;span class="o">(&lt;/span>rw,nosuid,nodev,relatime,attr2,inode64,logbufs&lt;span class="o">=&lt;/span>8,logbsize&lt;span class="o">=&lt;/span>32k,noquota,uhelper&lt;span class="o">=&lt;/span>udisks2&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">reiserfs &lt;span class="o">(&lt;/span>rw,nosuid,nodev,relatime,uhelper&lt;span class="o">=&lt;/span>udisks2&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>测试机系统：&lt;/p>
&lt;p>&lt;img src="https://user-images.githubusercontent.com/2854276/72120333-9f5aef00-3392-11ea-9e2e-131115439826.png" alt="DeepinScreenshot_select-area_20200110101815">&lt;/p>
&lt;p>内核版本：&lt;/p>
&lt;p>&lt;code>Linux xiaoxinpro 5.3.0-24-generic #26-Ubuntu SMP Thu Nov 14 01:33:18 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux
&lt;/code>&lt;/p>
&lt;p>跑分结果：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>&lt;/th>
&lt;th>create files&lt;/th>
&lt;th>rewrite files&lt;/th>
&lt;th>read linear&lt;/th>
&lt;th>read random&lt;/th>
&lt;th>delete all files&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>ext4&lt;/td>
&lt;td>0.593394041&lt;/td>
&lt;td>3.646025896&lt;/td>
&lt;td>0.960836887&lt;/td>
&lt;td>2.286855936&lt;/td>
&lt;td>0.646140814&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>btrfs&lt;/td>
&lt;td>5.707916975&lt;/td>
&lt;td>2.0158391&lt;/td>
&lt;td>0.446825027&lt;/td>
&lt;td>2.039553881&lt;/td>
&lt;td>2.933115005&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>f2fs&lt;/td>
&lt;td>0.737277031&lt;/td>
&lt;td>2.216201067&lt;/td>
&lt;td>0.841583014&lt;/td>
&lt;td>2.216186047&lt;/td>
&lt;td>17.70262408&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>xfs&lt;/td>
&lt;td>0.781413078&lt;/td>
&lt;td>5.908052206&lt;/td>
&lt;td>1.212768078&lt;/td>
&lt;td>3.198234081&lt;/td>
&lt;td>4.744434118&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>reiserfs&lt;/td>
&lt;td>1.735713959&lt;/td>
&lt;td>1.866363049&lt;/td>
&lt;td>0.23438096&lt;/td>
&lt;td>1.559979916&lt;/td>
&lt;td>2.575639963&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>&lt;img src="https://user-images.githubusercontent.com/2854276/72119789-92d59700-3390-11ea-80c3-b3af0b1f83f7.png" alt="bench">&lt;/p>
&lt;p>对于系统性能影响最大的应该是随机读写，这么看来还是&lt;code>reiserfs&lt;/code>牛逼，几乎全面领先，可惜这货作者杀老婆，进局子了，但并不妨碍我用脚投票，&lt;del>选&lt;code>reiserfs&lt;/code>做根分区文件系统&lt;/del>，然并卵，Ubuntu用这货做根分区丢资料，放弃。剩下的，&lt;code>ext4&lt;/code>还是老当益壮，&lt;code>btrfs&lt;/code>也可以，&lt;code>xfs&lt;/code>则并没有如网传那样犀利，&lt;code>f2fs&lt;/code>删除文件居然那么慢。&lt;/p>
&lt;h2 id="3-tlp---linux电源优化利器">3. TLP - Linux电源优化利器&lt;/h2>
&lt;blockquote>
&lt;p>via: &lt;a href="https://linrunner.de/en/tlp/docs/tlp-linux-advanced-power-management.html">https://linrunner.de/en/tlp/docs/tlp-linux-advanced-power-management.html&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>有人说跟&lt;code>powertop&lt;/code>搭配可能效果更好，然而我不觉得，这两货一起用卡的要死，所以只留一个就好&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>btrfs 文件系统的话, 需要改个东西&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># AHCI link power management (ALPM) for disk devices:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># min_power, med_power_with_dipm(*), medium_power, max_performance.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># (*) Kernel &amp;gt;= 4.15 required, then recommended.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Multiple values separated with spaces are tried sequentially until success.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Default:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># - &amp;#34;med_power_with_dipm max_performance&amp;#34; (AC)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># - &amp;#34;med_power_with_dipm min_power&amp;#34; (BAT)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">SATA_LINKPWR_ON_AC&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;med_power_with_dipm max_performance&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">SATA_LINKPWR_ON_BAT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;med_power_with_dipm max_performance&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="4-要不要swap分区">4. 要不要&lt;code>swap&lt;/code>分区&lt;/h2>
&lt;p>我倾向于不要，万一想要&lt;code>swap&lt;/code>了完全可以用&lt;code>swapfile&lt;/code>的形式随用随开&lt;/p>
&lt;p>Archlinux Wiki的&lt;a href="https://wiki.archlinux.org/index.php/Swap#Swap_file">文档真是优秀&lt;/a>&lt;/p>
&lt;p>摘抄几个命令&lt;/p>
&lt;h4 id="swap-file-creation">Swap file creation&lt;/h4>
&lt;p>For copy-on-write file systems like &lt;a href="https://wiki.archlinux.org/index.php/Btrfs">Btrfs&lt;/a>, first create a zero length file, set the &lt;code>No_COW&lt;/code> attribute on it with &lt;a href="https://wiki.archlinux.org/index.php/Chattr">chattr&lt;/a>, and make sure compression is disabled:&lt;/p>
&lt;pre tabindex="0">&lt;code># truncate -s 0 /swapfile
# chattr +C /swapfile
# btrfs property set /swapfile compression none
&lt;/code>&lt;/pre>&lt;p>See &lt;a href="https://wiki.archlinux.org/index.php/Btrfs#Swap_file">Btrfs#Swap file&lt;/a> for more information.&lt;/p>
&lt;p>Use &lt;code>fallocate&lt;/code> to create a swap file the size of your choosing (M = &lt;a href="https://en.wikipedia.org/wiki/Mebibyte">Mebibytes&lt;/a>, G = &lt;a href="https://en.wikipedia.org/wiki/Gibibyte">Gibibytes&lt;/a>). For example, creating a 512 MiB swap file:&lt;/p>
&lt;pre tabindex="0">&lt;code># fallocate -l 512M /swapfile
&lt;/code>&lt;/pre>&lt;p>&lt;strong>Note:&lt;/strong> &lt;em>fallocate&lt;/em> may cause problems with some file systems such as &lt;a href="https://wiki.archlinux.org/index.php/F2FS">F2FS&lt;/a>.[&lt;a href="https://github.com/karelzak/util-linux/issues/633">1]&lt;/a> As an alternative, using &lt;em>dd&lt;/em> is more reliable, but slower:&lt;/p>
&lt;pre tabindex="0">&lt;code># dd if=/dev/zero of=/swapfile bs=1M count=512 status=progress
&lt;/code>&lt;/pre>&lt;p>Set the right permissions (a world-readable swap file is a huge local vulnerability):&lt;/p>
&lt;pre tabindex="0">&lt;code># chmod 600 /swapfile
&lt;/code>&lt;/pre>&lt;p>After creating the correctly sized file, format it to swap:&lt;/p>
&lt;pre tabindex="0">&lt;code># mkswap /swapfile
&lt;/code>&lt;/pre>&lt;p>Activate the swap file:&lt;/p>
&lt;pre tabindex="0">&lt;code># swapon /swapfile
&lt;/code>&lt;/pre>&lt;p>Finally, edit the fstab configuration to add an entry for the swap file:&lt;/p>
&lt;pre tabindex="0">&lt;code>/etc/fstab
/swapfile none swap defaults 0 0
&lt;/code>&lt;/pre>&lt;p>For additional information, see &lt;a href="https://wiki.archlinux.org/index.php/Fstab#Usage">fstab#Usage&lt;/a>.&lt;/p>
&lt;p>&lt;strong>Note:&lt;/strong> The swap file must be specified by its location on the file system not by its UUID or LABEL.&lt;/p>
&lt;h4 id="remove-swap-file">Remove swap file&lt;/h4>
&lt;p>To remove a swap file, it must be turned off first and then can be removed:&lt;/p>
&lt;pre tabindex="0">&lt;code># swapoff /swapfile
# rm -f /swapfile
&lt;/code>&lt;/pre>&lt;hr>
&lt;blockquote>
&lt;p>关于性能也抄几句，我给&lt;code>vm.swappiness&lt;/code>配了&lt;code>1&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;h2 id="performance">Performance&lt;/h2>
&lt;p>Swap operations are usually significantly slower than directly accessing data in RAM. Disabling swap entirely to improve performance can sometimes lead to a degradation, since it decreases the memory available for VFS caches, causing more frequent and costly disk I/O.&lt;/p>
&lt;p>Swap values can be adjusted to help performance:&lt;/p>
&lt;h3 id="swappiness">Swappiness&lt;/h3>
&lt;p>The &lt;em>swappiness&lt;/em> &lt;a href="https://wiki.archlinux.org/index.php/Sysctl">sysctl&lt;/a> parameter represents the kernel's preference (or avoidance) of swap space. Swappiness can have a value between 0 and 100, the default value is 60. A low value causes the kernel to avoid swapping, a higher value causes the kernel to try to use swap space. Using a low value on sufficient memory is known to improve responsiveness on many systems.&lt;/p>
&lt;p>To check the current swappiness value:&lt;/p>
&lt;pre tabindex="0">&lt;code>$ sysctl vm.swappiness
&lt;/code>&lt;/pre>&lt;p>Alternatively, the files &lt;code>/sys/fs/cgroup/memory/memory.swappiness&lt;/code> or &lt;code>/proc/sys/vm/swappiness&lt;/code> can be read in order to obtain the raw integer value.&lt;/p>
&lt;p>&lt;strong>Note:&lt;/strong> As &lt;code>/proc&lt;/code> is a lot less organized and is kept only for compatibility purposes, you are encouraged to use &lt;code>/sys&lt;/code> instead.&lt;/p>
&lt;p>To temporarily set the swappiness value:&lt;/p>
&lt;pre tabindex="0">&lt;code># sysctl -w vm.swappiness=10
&lt;/code>&lt;/pre>&lt;p>To set the swappiness value permanently, create a &lt;a href="https://jlk.fjfi.cvut.cz/arch/manpages/man/sysctl.d.5">sysctl.d(5)&lt;/a> configuration file. For example:&lt;/p>
&lt;pre tabindex="0">&lt;code>/etc/sysctl.d/99-swappiness.conf
vm.swappiness=10
&lt;/code>&lt;/pre>&lt;p>To test and more on why this may work, take a look at &lt;a href="http://rudd-o.com/en/linux-and-free-software/tales-from-responsivenessland-why-linux-feels-slow-and-how-to-fix-that">this article&lt;/a>.&lt;/p>
&lt;h2 id="5-常用软件">5. 常用软件&lt;/h2>
&lt;ul>
&lt;li>&lt;del>Google Chrome/Chromium&lt;/del>Edge已经堪用, 巨硬威武!!!&lt;/li>
&lt;/ul>
&lt;p>支持的一些启动参数如下所示，我一般用的是&lt;code>--disk-cache-dir=/tmp/chrome_cache --process-per-site&lt;/code>，即缓存扔到&lt;code>/tmp&lt;/code>分区，每个站点使用一个进程&lt;/p>
&lt;p>对于Chromium，可以在&lt;code>/etc/chromium-browser/default&lt;/code>添加自己想要的配置参数，而对于Google Chrome，貌似只能从这里&lt;code>/usr/share/applications/chromium-browser.desktop&lt;/code>加&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">--user-data-dir&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;[PATH]&amp;#34;&lt;/span> 自定义用户数据目录
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--start-maximized 启动就最大化
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--no-sandbox 取消沙盒模式
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--single-process 单进程运行
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--process-per-tab 每个标签使用单独进程
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--process-per-site 每个站点使用单独进程
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--in-process-plugins 插件不启用单独进程
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--disable-popup-blocking 禁用弹出拦截
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--disable-javascript 禁用JavaScript
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--disable-java 禁用Java
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--disable-plugins 禁用插件
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--disable-images 禁用图像
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-incognito 启动进入隐身模式
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--enable-udd-profiles 启用账户切换菜单
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--proxy-pac-url 使用pac代理 &lt;span class="o">[&lt;/span>via 1/2&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--lang&lt;span class="o">=&lt;/span>zh-CN 设置语言为简体中文
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--disk-cache-dir&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;[PATH]&amp;#34;&lt;/span> 自定义缓存目录
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--disk-cache-size&lt;span class="o">=&lt;/span> 自定义缓存最大值（单位byte）
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--media-cache-size&lt;span class="o">=&lt;/span> 自定义多媒体缓存最大值（单位byte）
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--bookmark-menu 在工具栏增加一个书签按钮
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--enable-sync 启用书签同步
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>Foxit Reader&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>安装方法见：https://websiteforstudents.com/how-to-install-foxit-reader-on-ubuntu-16-04-17-10-18-04-desktop/&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>Barrier 在Linux和其他设备之间共享键盘和鼠标&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>我是从snap安装的，挺方便，务必带好梯子&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>&lt;a href="https://snapcraft.io/barrier">https://snapcraft.io/barrier&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>FlameShot - 火焰截图&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>最近发现高分屏上面用他会冻屏，参考这里的解决方法暂时得到解决 &lt;a href="https://github.com/flameshot-org/flameshot/issues/564#issuecomment-750014960">https://github.com/flameshot-org/flameshot/issues/564#issuecomment-750014960&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>
&lt;p>DeepinTerminal - 深度终端&lt;/p>
&lt;/li>
&lt;li>
&lt;p>alacritty - 最近在用这个，跟tmux搭配还是蛮舒服&lt;/p>
&lt;/li>
&lt;li>
&lt;p>CopyQ - 剪贴板增强&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Qv2ray - 梯子客户端&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Typora - MarkDown编辑器，配合坚果云同步算是比较非常舒服的个人文档管理方案了&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="6-snap相关不再推荐装这玩意">6. SNAP相关&lt;code>不再推荐装这玩意&lt;/code>&lt;/h2>
&lt;blockquote>
&lt;p>via &lt;a href="https://plumz.me/archives/11705/">https://plumz.me/archives/11705/&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>一起来干掉这些傻逼的 Snap，恢复原有的商店。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> p in &lt;span class="k">$(&lt;/span>snap list &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;{print $1}&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sudo snap remove &lt;span class="nv">$p&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>删掉所有的已经安装的 Snap 软件。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">sudo systemctl stop snapd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> m in /snap/core/*&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sudo umount &lt;span class="nv">$m&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo snap remove core
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>干掉 Snap 的 Core 文件，很大哟。&lt;/p>
&lt;p>&lt;code>sudo apt autoremove --purge snapd&lt;/code>&lt;/p>
&lt;p>干掉 Snap 的管理工具。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">rm -rf ~/snap
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo rm -rf /snap
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo rm -rf /var/snap
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo rm -rf /var/lib/snapd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo rm -rf /var/cache/snapd
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>干掉 Snap 的目录。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">sudo bash -c &lt;span class="s2">&amp;#34;cat &amp;gt; /etc/apt/preferences.d/no-snapd.pref&amp;#34;&lt;/span> &lt;span class="s">&amp;lt;&amp;lt; EOL
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">Package: snapd
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">Pin: origin &amp;#34;&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">Pin-Priority: -1
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">EOL&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>干掉 Snap 的更新源。&lt;/p>
&lt;hr>
&lt;blockquote>
&lt;p>有人号称装完Ubuntu第一时间卸载snap, 但我觉得很香&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>&lt;del>挂梯子&lt;/del>&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>新的snap看起来用上了国内CDN，不用挂梯子也可以很舒服了&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>删除旧的snap包&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">LANG&lt;/span>&lt;span class="o">=&lt;/span>C snap list --all &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;/disabled/{print $1, $(NF-3)}&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="nb">read&lt;/span> snapname revision&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sudo snap remove &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$snapname&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> --revision&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$revision&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="7-禁用普通用户锁定登出关机重启">7. 禁用普通用户锁定/登出/关机/重启&lt;/h2>
&lt;p>&lt;a href="https://askubuntu.com/a/1064704">https://askubuntu.com/a/1064704&lt;/a>&lt;/p>
&lt;h1 id="disable-lock-screen">Disable Lock Screen&lt;/h1>
&lt;p>You can disable the lock screen permanently when waking from suspend.&lt;/p>
&lt;p>First use this command to discover current settings:&lt;/p>
&lt;pre tabindex="0">&lt;code>$ gsettings get org.gnome.desktop.lockdown disable-lock-screen
false
&lt;/code>&lt;/pre>&lt;p>Now set it to &lt;code>true&lt;/code> using this command:&lt;/p>
&lt;pre tabindex="0">&lt;code>gsettings set org.gnome.desktop.lockdown disable-lock-screen &amp;#39;true&amp;#39;
&lt;/code>&lt;/pre>&lt;p>If you are unhappy with the new setting you can reverse it using:&lt;/p>
&lt;pre tabindex="0">&lt;code>gsettings set org.gnome.desktop.lockdown disable-lock-screen &amp;#39;false&amp;#39;
&lt;/code>&lt;/pre>&lt;hr>
&lt;h1 id="disable-screen-saver-locking">Disable Screen Saver Locking&lt;/h1>
&lt;p>There was some confusion where people think disabling the Lock screen also disables the screen saver which is invoked after a certain period of inactivity. The screen saver requires input to get your desktop back. Some people may want the screen saver to come on but not have it locked when waking up the screen.&lt;/p>
&lt;p>To check screen saver lock status use:&lt;/p>
&lt;pre tabindex="0">&lt;code>$ gsettings get org.gnome.desktop.screensaver lock-enabled
true
&lt;/code>&lt;/pre>&lt;p>If true you can turn off screen saver locking with:&lt;/p>
&lt;pre tabindex="0">&lt;code>gsettings set org.gnome.desktop.screensaver lock-enabled false
&lt;/code>&lt;/pre>&lt;p>To reverse the setting back use:&lt;/p>
&lt;pre tabindex="0">&lt;code>gsettings set org.gnome.desktop.screensaver lock-enabled true
&lt;/code>&lt;/pre>&lt;hr>
&lt;p>In Gnome &lt;a href="https://help.gnome.org/users/gnome-power-manager/stable/preferences-advanced.html.en_GB#advanced-preferences-locking">screen locking guide&lt;/a> it says:&lt;/p>
&lt;blockquote>
&lt;h2 id="62screen-locking">6.2. Screen Locking&lt;/h2>
&lt;p>By default, GNOME Power Manager supports a simple locking scheme. This means that the screen will lock if set to &lt;strong>Lock screen&lt;/strong> in gnome-screensaver when the lid is closed, or the system performs a suspend or hibernate action.&lt;/p>
&lt;p>There is a complex locking scheme available for power users that allows locking policy to change for the lid, suspend and hibernate actions. To enable this complex mode, you will have to disable the GConf key:&lt;/p>
&lt;ul>
&lt;li>&lt;code>/apps/gnome-power-manager/lock/use_screensaver_settings&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>Then the policy keys can be set to force a &lt;em>gnome-screensaver&lt;/em> lock and unlock when the action is performed:&lt;/p>
&lt;ul>
&lt;li>&lt;code>/apps/gnome-power-manager/lock/blank_screen&lt;/code>&lt;/li>
&lt;li>&lt;code>/apps/gnome-power-manager/lock/suspend&lt;/code>&lt;/li>
&lt;li>&lt;code>/apps/gnome-power-manager/lock/hibernate&lt;/code>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;h2 id="8-文件管理nautilus左侧边栏消失">8. 文件管理nautilus左侧边栏消失&lt;/h2>
&lt;blockquote>
&lt;p>&lt;a href="https://askubuntu.com/a/766618">https://askubuntu.com/a/766618&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>If you want to come back to default behavior (nautilus with sidebar) you can simply set the previous setting to true:&lt;/p>
&lt;p>&lt;code>gsettings set org.gnome.nautilus.window-state start-with-sidebar true&lt;/code>&lt;/p>
&lt;h2 id="9-this-location-could-not-be-displayedhttpsaskubuntucomquestions858793this-location-could-not-be-displayed-on-ubuntu-16-10">9. &lt;a href="https://askubuntu.com/questions/858793/this-location-could-not-be-displayed-on-ubuntu-16-10">This location could not be displayed&lt;/a>&lt;/h2>
&lt;p>&lt;code>chmod -R 775 /media&lt;/code>&lt;/p>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2020-01-02T11:29:24+08:00
update@2022-11-06T06:45:17+08:00
comment@https://github.com/ferstar/blog/issues/11
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>Git常用操作</title><link>https://blog.ferstar.org/post/issue-10/</link><guid isPermaLink="true">https://blog.ferstar.org/post/issue-10/</guid><pubDate>Thu, 02 Jan 2020 10:51:58 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;ol>
&lt;li>强行抹掉远程commit log&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>不小心把不该提交的东西提交了, 可以用这招救命, &lt;strong>团队协作慎用&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">git reset --hard &amp;lt;需要回退到的commit tag&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git push --force
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="2">
&lt;li>强制同步远端代码&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>不小心把本地搞乱, 除了&lt;code>rm and clone again&lt;/code>大法外, 还可以这样&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">git fetch origin master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git reset --hard origin/master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git pull -r
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="3">
&lt;li>git clone xxx --depth=x 后遗症&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>包括不仅限于: 看不到太多 commit log 以及无法查看/切换远程分支&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>解决办法要么直接删了 repo 重新 clone, 这属于大力出奇迹的方案&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>要么:&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">git fetch --unshallow
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git remote set-branches origin &lt;span class="s1">&amp;#39;*&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git fetch -v
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>算了，没什么好写的，官方文档很清楚，遇事不决直接查就是。&lt;/p>
&lt;/blockquote>
&lt;pre tabindex="0">&lt;code># NOTE: I am not responsible for any expired content.
create@2020-01-02T10:51:58+08:00
update@2022-09-08T04:45:18+08:00
comment@https://github.com/ferstar/blog/issues/10
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/git/">Git</category></item><item><title>检查某列是否在某表中</title><link>https://blog.ferstar.org/post/check-column-existence-pg/</link><guid isPermaLink="true">https://blog.ferstar.org/post/check-column-existence-pg/</guid><pubDate>Wed, 25 Dec 2019 23:17:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>某次数据库升级漏了几个commit, 得修一下, 还是写个alembic, 到时候upgrade就自动修复, 爽歪歪&lt;/p>
&lt;/blockquote>
&lt;p>因为主要就是丢失了几个col, 但又不确定线上哪几个表丢了哪些col, 那么就需要根据数据库实际情况来判断要不要加col, 主要就一句SQL:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">xxx&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">in&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">column_name&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">information_schema&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">columns&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">table_name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;xxx_table&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">and&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">table_schema&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;public&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>转成alembic就是这么个func:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">is_col_in&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">conn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">table&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">col&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sql&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> select &amp;#39;&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">col&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#39; in (
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> select column_name
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> from information_schema.columns
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> where table_name = &amp;#39;&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">table&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> and table_schema = &amp;#39;public&amp;#39;)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">conn&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">execute&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sql&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fetchone&lt;/span>&lt;span class="p">()[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">upgrade&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">conn&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">op&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get_bind&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">table&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">col&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">missing_tables&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">is_col_in&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">conn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">table&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">col&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">pass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>怀疑哪些col丢了就轮一遍, 再搞一次, 没毛病&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>给snap加代理</title><link>https://blog.ferstar.org/post/speed-up-snap-with-proxy/</link><guid isPermaLink="true">https://blog.ferstar.org/post/speed-up-snap-with-proxy/</guid><pubDate>Mon, 23 Dec 2019 14:38:05 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>Ubuntu 自 16.04 开始自带的 snap 用起来真是舒服, 不过直连网络太差, 需要代理
需要在&lt;code>/etc/environment&lt;/code>中指定需要使用的proxy&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">http_proxy&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;socks5://192.168.0.25:7891&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">https_proxy&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;socks5://192.168.0.25:7891&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后重启一下 snap service
&lt;code>sudo systemctl restart snapd.service&lt;/code>&lt;/p>
&lt;h2 id="删除snap历史packages">删除snap历史packages&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>&lt;span class="c1"># Removes old revisions of snaps&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># CLOSE ALL SNAPS BEFORE RUNNING THIS&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">set&lt;/span> -eu
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">LANG&lt;/span>&lt;span class="o">=&lt;/span>C snap list --all &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;/disabled/{print $1, $3}&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="nb">read&lt;/span> snapname revision&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> snap remove &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$snapname&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> --revision&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$revision&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>_csv.Error: field larger than field limit (131072)</title><link>https://blog.ferstar.org/post/csv-field-larger-than-field-limit/</link><guid isPermaLink="true">https://blog.ferstar.org/post/csv-field-larger-than-field-limit/</guid><pubDate>Mon, 16 Dec 2019 23:17:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>数据库部分翻车, 写了点脚本搞恢复&lt;/p>
&lt;p>导出脚本大概长这样&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">temp_dump_answer&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> 导出部分数据
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">with&lt;/span> &lt;span class="n">gzip&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;dump_answer.csv.gz&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;wt&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">newline&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">file_obj&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">writer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">csv&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">writer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file_obj&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">value&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">data&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">items&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">writer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">writerow&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">json&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">dumps&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">)])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">export&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">conn&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>&lt;span class="n">我是导出&lt;/span>&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>恢复的脚本免不了要&lt;code>read&lt;/code>一下这个csv文件&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">restore&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">with&lt;/span> &lt;span class="n">gzip&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;dump_answer.csv.gz&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;rt&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">newline&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">file_obj&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">qid&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ans&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">csv&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">reader&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file_obj&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">pass&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>一顿骚操作, 报错如题, 于是放狗, 解决~&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># fix &amp;#34;_csv.Error: field larger than field limit (131072)&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># via https://stackoverflow.com/a/15063941&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csv.field_size_limit&lt;span class="o">(&lt;/span>sys.maxsize&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>Reload Intel AX201 wireless card on Ubuntu</title><link>https://blog.ferstar.org/post/reload-ax201-wireless-card/</link><guid isPermaLink="true">https://blog.ferstar.org/post/reload-ax201-wireless-card/</guid><pubDate>Sat, 14 Dec 2019 16:47:09 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>我佛了，不知道进行了某次更新后，WiFi开始狂掉，坑爹的不行，各种骚操作也是没锤子卵用，后来换成连2.4G，好了。。。WiFi6的5G有毒？&lt;/p>
&lt;p>---fuck iwlwifi---&lt;/p>
&lt;p>前阵子买了美帝联想的年度真香本:小新pro 13 i7版, 装Ubuntu是必须的, 然而这个本子硬件太新, 无线网卡驱动要求系统内核&amp;gt;5.2才能装, 然而实际上就算是装了官网的驱动, 这破网卡也是会间歇性断网, 重连还没发连, dmesg看一堆关于网卡的报错, 没法子, 只能写个批处理重载驱动&amp;amp;重启nm了, 还真好使, 总比重启大法好&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rmmod iwlmvm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rmmod iwlwifi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">modprobe iwlwifi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl restart NetworkManager.service
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>玩Linux机器还是不能太新啊~&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/ubuntu/">UBUNTU</category></item><item><title>Upload Tmp File to Tmplink</title><link>https://blog.ferstar.org/post/upload-tmp-file-to-tmplink/</link><guid isPermaLink="true">https://blog.ferstar.org/post/upload-tmp-file-to-tmplink/</guid><pubDate>Wed, 18 Sep 2019 14:52:03 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>这服务可能是要收费了, 最近不停的修改API, 蛋疼, 还好改一下还能用&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>后续更新见 &lt;a href="https://gist.github.com/ferstar/e3a63bf9ea3be3229c591a185801747c">gist&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>2020年03月06日14:23:15&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>又双更新了, 这里不再贴代码&lt;/p>
&lt;/blockquote></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>SimpleHTTPServerWithUpload</title><link>https://blog.ferstar.org/post/simplehttpserverwithupload/</link><guid isPermaLink="true">https://blog.ferstar.org/post/simplehttpserverwithupload/</guid><pubDate>Wed, 12 Jun 2019 16:47:09 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>如题, 抄了个脚本, 偶尔从服务器上传或者下载比较用得着&lt;/p>
&lt;p>出处: &lt;a href="https://gist.github.com/touilleMan/eb02ea40b93e52604938">https://gist.github.com/touilleMan/eb02ea40b93e52604938&lt;/a>&lt;/p>
&lt;p>我的Fork: &lt;a href="https://gist.github.com/ferstar/c620ef181c230beaf469f70451ffac9d">https://gist.github.com/ferstar/c620ef181c230beaf469f70451ffac9d&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;span class="lnt">107
&lt;/span>&lt;span class="lnt">108
&lt;/span>&lt;span class="lnt">109
&lt;/span>&lt;span class="lnt">110
&lt;/span>&lt;span class="lnt">111
&lt;/span>&lt;span class="lnt">112
&lt;/span>&lt;span class="lnt">113
&lt;/span>&lt;span class="lnt">114
&lt;/span>&lt;span class="lnt">115
&lt;/span>&lt;span class="lnt">116
&lt;/span>&lt;span class="lnt">117
&lt;/span>&lt;span class="lnt">118
&lt;/span>&lt;span class="lnt">119
&lt;/span>&lt;span class="lnt">120
&lt;/span>&lt;span class="lnt">121
&lt;/span>&lt;span class="lnt">122
&lt;/span>&lt;span class="lnt">123
&lt;/span>&lt;span class="lnt">124
&lt;/span>&lt;span class="lnt">125
&lt;/span>&lt;span class="lnt">126
&lt;/span>&lt;span class="lnt">127
&lt;/span>&lt;span class="lnt">128
&lt;/span>&lt;span class="lnt">129
&lt;/span>&lt;span class="lnt">130
&lt;/span>&lt;span class="lnt">131
&lt;/span>&lt;span class="lnt">132
&lt;/span>&lt;span class="lnt">133
&lt;/span>&lt;span class="lnt">134
&lt;/span>&lt;span class="lnt">135
&lt;/span>&lt;span class="lnt">136
&lt;/span>&lt;span class="lnt">137
&lt;/span>&lt;span class="lnt">138
&lt;/span>&lt;span class="lnt">139
&lt;/span>&lt;span class="lnt">140
&lt;/span>&lt;span class="lnt">141
&lt;/span>&lt;span class="lnt">142
&lt;/span>&lt;span class="lnt">143
&lt;/span>&lt;span class="lnt">144
&lt;/span>&lt;span class="lnt">145
&lt;/span>&lt;span class="lnt">146
&lt;/span>&lt;span class="lnt">147
&lt;/span>&lt;span class="lnt">148
&lt;/span>&lt;span class="lnt">149
&lt;/span>&lt;span class="lnt">150
&lt;/span>&lt;span class="lnt">151
&lt;/span>&lt;span class="lnt">152
&lt;/span>&lt;span class="lnt">153
&lt;/span>&lt;span class="lnt">154
&lt;/span>&lt;span class="lnt">155
&lt;/span>&lt;span class="lnt">156
&lt;/span>&lt;span class="lnt">157
&lt;/span>&lt;span class="lnt">158
&lt;/span>&lt;span class="lnt">159
&lt;/span>&lt;span class="lnt">160
&lt;/span>&lt;span class="lnt">161
&lt;/span>&lt;span class="lnt">162
&lt;/span>&lt;span class="lnt">163
&lt;/span>&lt;span class="lnt">164
&lt;/span>&lt;span class="lnt">165
&lt;/span>&lt;span class="lnt">166
&lt;/span>&lt;span class="lnt">167
&lt;/span>&lt;span class="lnt">168
&lt;/span>&lt;span class="lnt">169
&lt;/span>&lt;span class="lnt">170
&lt;/span>&lt;span class="lnt">171
&lt;/span>&lt;span class="lnt">172
&lt;/span>&lt;span class="lnt">173
&lt;/span>&lt;span class="lnt">174
&lt;/span>&lt;span class="lnt">175
&lt;/span>&lt;span class="lnt">176
&lt;/span>&lt;span class="lnt">177
&lt;/span>&lt;span class="lnt">178
&lt;/span>&lt;span class="lnt">179
&lt;/span>&lt;span class="lnt">180
&lt;/span>&lt;span class="lnt">181
&lt;/span>&lt;span class="lnt">182
&lt;/span>&lt;span class="lnt">183
&lt;/span>&lt;span class="lnt">184
&lt;/span>&lt;span class="lnt">185
&lt;/span>&lt;span class="lnt">186
&lt;/span>&lt;span class="lnt">187
&lt;/span>&lt;span class="lnt">188
&lt;/span>&lt;span class="lnt">189
&lt;/span>&lt;span class="lnt">190
&lt;/span>&lt;span class="lnt">191
&lt;/span>&lt;span class="lnt">192
&lt;/span>&lt;span class="lnt">193
&lt;/span>&lt;span class="lnt">194
&lt;/span>&lt;span class="lnt">195
&lt;/span>&lt;span class="lnt">196
&lt;/span>&lt;span class="lnt">197
&lt;/span>&lt;span class="lnt">198
&lt;/span>&lt;span class="lnt">199
&lt;/span>&lt;span class="lnt">200
&lt;/span>&lt;span class="lnt">201
&lt;/span>&lt;span class="lnt">202
&lt;/span>&lt;span class="lnt">203
&lt;/span>&lt;span class="lnt">204
&lt;/span>&lt;span class="lnt">205
&lt;/span>&lt;span class="lnt">206
&lt;/span>&lt;span class="lnt">207
&lt;/span>&lt;span class="lnt">208
&lt;/span>&lt;span class="lnt">209
&lt;/span>&lt;span class="lnt">210
&lt;/span>&lt;span class="lnt">211
&lt;/span>&lt;span class="lnt">212
&lt;/span>&lt;span class="lnt">213
&lt;/span>&lt;span class="lnt">214
&lt;/span>&lt;span class="lnt">215
&lt;/span>&lt;span class="lnt">216
&lt;/span>&lt;span class="lnt">217
&lt;/span>&lt;span class="lnt">218
&lt;/span>&lt;span class="lnt">219
&lt;/span>&lt;span class="lnt">220
&lt;/span>&lt;span class="lnt">221
&lt;/span>&lt;span class="lnt">222
&lt;/span>&lt;span class="lnt">223
&lt;/span>&lt;span class="lnt">224
&lt;/span>&lt;span class="lnt">225
&lt;/span>&lt;span class="lnt">226
&lt;/span>&lt;span class="lnt">227
&lt;/span>&lt;span class="lnt">228
&lt;/span>&lt;span class="lnt">229
&lt;/span>&lt;span class="lnt">230
&lt;/span>&lt;span class="lnt">231
&lt;/span>&lt;span class="lnt">232
&lt;/span>&lt;span class="lnt">233
&lt;/span>&lt;span class="lnt">234
&lt;/span>&lt;span class="lnt">235
&lt;/span>&lt;span class="lnt">236
&lt;/span>&lt;span class="lnt">237
&lt;/span>&lt;span class="lnt">238
&lt;/span>&lt;span class="lnt">239
&lt;/span>&lt;span class="lnt">240
&lt;/span>&lt;span class="lnt">241
&lt;/span>&lt;span class="lnt">242
&lt;/span>&lt;span class="lnt">243
&lt;/span>&lt;span class="lnt">244
&lt;/span>&lt;span class="lnt">245
&lt;/span>&lt;span class="lnt">246
&lt;/span>&lt;span class="lnt">247
&lt;/span>&lt;span class="lnt">248
&lt;/span>&lt;span class="lnt">249
&lt;/span>&lt;span class="lnt">250
&lt;/span>&lt;span class="lnt">251
&lt;/span>&lt;span class="lnt">252
&lt;/span>&lt;span class="lnt">253
&lt;/span>&lt;span class="lnt">254
&lt;/span>&lt;span class="lnt">255
&lt;/span>&lt;span class="lnt">256
&lt;/span>&lt;span class="lnt">257
&lt;/span>&lt;span class="lnt">258
&lt;/span>&lt;span class="lnt">259
&lt;/span>&lt;span class="lnt">260
&lt;/span>&lt;span class="lnt">261
&lt;/span>&lt;span class="lnt">262
&lt;/span>&lt;span class="lnt">263
&lt;/span>&lt;span class="lnt">264
&lt;/span>&lt;span class="lnt">265
&lt;/span>&lt;span class="lnt">266
&lt;/span>&lt;span class="lnt">267
&lt;/span>&lt;span class="lnt">268
&lt;/span>&lt;span class="lnt">269
&lt;/span>&lt;span class="lnt">270
&lt;/span>&lt;span class="lnt">271
&lt;/span>&lt;span class="lnt">272
&lt;/span>&lt;span class="lnt">273
&lt;/span>&lt;span class="lnt">274
&lt;/span>&lt;span class="lnt">275
&lt;/span>&lt;span class="lnt">276
&lt;/span>&lt;span class="lnt">277
&lt;/span>&lt;span class="lnt">278
&lt;/span>&lt;span class="lnt">279
&lt;/span>&lt;span class="lnt">280
&lt;/span>&lt;span class="lnt">281
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="ch">#!/usr/bin/env python3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;Simple HTTP Server With Upload.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">This module builds on BaseHTTPServer by implementing the standard GET
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">and HEAD requests in a fairly straightforward manner.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">see: https://gist.github.com/UniIsland/3346170
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">__version__&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;0.1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">__all__&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;SimpleHTTPRequestHandler&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">__author__&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;bones7456&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">__home_page__&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;http://li2z.cn/&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">os&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">posixpath&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">sys&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">http.server&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">urllib.request&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="nn">urllib.parse&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="nn">urllib.error&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">cgi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">shutil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">mimetypes&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">re&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">io&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">BytesIO&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">SimpleHTTPRequestHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">http&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">server&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">BaseHTTPRequestHandler&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;Simple HTTP request handler with GET/HEAD/POST commands.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> This serves files from the current directory and any of its
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> subdirectories. The MIME type for files is determined by
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> calling the .guess_type() method. And can reveive file uploaded
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> by client.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> The GET/HEAD/POST requests are identical except that the HEAD
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> request omits the actual contents of the file.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">server_version&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;SimpleHTTPWithUpload/&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">__version__&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">do_GET&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;Serve a GET request.&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send_head&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">f&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">copyfile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">wfile&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">do_HEAD&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;Serve a HEAD request.&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send_head&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">f&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">do_POST&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;Serve a POST request.&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">r&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">info&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">deal_post_data&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">r&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">info&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;by: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">client_address&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">BytesIO&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">b&lt;/span>&lt;span class="s1">&amp;#39;&amp;lt;!DOCTYPE html PUBLIC &amp;#34;-//W3C//DTD HTML 3.2 Final//EN&amp;#34;&amp;gt;&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">b&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;html&amp;gt;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;lt;title&amp;gt;Upload Result Page&amp;lt;/title&amp;gt;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">b&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;body&amp;gt;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;lt;h2&amp;gt;Upload Result Page&amp;lt;/h2&amp;gt;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">b&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;hr&amp;gt;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">r&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">b&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;strong&amp;gt;Success:&amp;lt;/strong&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">b&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;strong&amp;gt;Failed:&amp;lt;/strong&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">info&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">encode&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;br&amp;gt;&amp;lt;a href=&lt;/span>&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="si">%s&lt;/span>&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="s2">&amp;gt;back&amp;lt;/a&amp;gt;&amp;#34;&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">headers&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;referer&amp;#39;&lt;/span>&lt;span class="p">])&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">encode&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">b&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;hr&amp;gt;&amp;lt;small&amp;gt;Powerd By: bones7456, check new version at &amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">b&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;a href=&lt;/span>&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="s2">http://li2z.cn/?s=SimpleHTTPServerWithUpload&lt;/span>&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="s2">&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">b&lt;/span>&lt;span class="s2">&amp;#34;here&amp;lt;/a&amp;gt;.&amp;lt;/small&amp;gt;&amp;lt;/body&amp;gt;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;lt;/html&amp;gt;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">length&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">tell&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">seek&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send_response&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">200&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send_header&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Content-type&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;text/html&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send_header&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Content-Length&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">length&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">end_headers&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">f&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">copyfile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">wfile&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">deal_post_data&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">content_type&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">headers&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;content-type&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">content_type&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kc">False&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;Content-Type header doesn&amp;#39;t contain boundary&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">boundary&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">content_type&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;=&amp;#34;&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">encode&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">remainbytes&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">headers&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;content-length&amp;#39;&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">line&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rfile&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">readline&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">remainbytes&lt;/span> &lt;span class="o">-=&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">line&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">boundary&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">line&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kc">False&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;Content NOT begin with boundary&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">line&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rfile&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">readline&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">remainbytes&lt;/span> &lt;span class="o">-=&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">line&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">fn&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">re&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">findall&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">r&lt;/span>&lt;span class="s1">&amp;#39;Content-Disposition.*name=&amp;#34;file&amp;#34;; filename=&amp;#34;(.*)&amp;#34;&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">line&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">decode&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">fn&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kc">False&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;Can&amp;#39;t find out file name...&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">translate_path&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">fn&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">fn&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">line&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rfile&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">readline&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">remainbytes&lt;/span> &lt;span class="o">-=&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">line&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">line&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rfile&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">readline&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">remainbytes&lt;/span> &lt;span class="o">-=&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">line&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">out&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;wb&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span> &lt;span class="ne">IOError&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kc">False&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;Can&amp;#39;t create file to write, do you have permission to write?&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">preline&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rfile&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">readline&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">remainbytes&lt;/span> &lt;span class="o">-=&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">preline&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="n">remainbytes&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">line&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rfile&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">readline&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">remainbytes&lt;/span> &lt;span class="o">-=&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">line&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">boundary&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">line&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">preline&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">preline&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">preline&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">endswith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">b&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="se">\r&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">preline&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">preline&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">preline&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;File &amp;#39;&lt;/span>&lt;span class="si">%s&lt;/span>&lt;span class="s2">&amp;#39; upload success!&amp;#34;&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="n">fn&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">preline&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">preline&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">line&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kc">False&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;Unexpect Ends of data.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">send_head&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;Common code for GET and HEAD commands.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> This sends the response code and MIME headers.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> Return value is either a file object (which has to be copied
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> to the outputfile by the caller unless the command was HEAD,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> and must be closed by the caller under all circumstances), or
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> None, in which case the caller has nothing further to do.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">translate_path&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">isdir&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">endswith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;/&amp;#39;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># redirect browser - doing basically what apache does&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send_response&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">301&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send_header&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Location&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s2">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">end_headers&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">index&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="s2">&amp;#34;index.html&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;index.htm&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">index&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">index&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">exists&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">index&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">list_directory&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ctype&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">guess_type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Always read in binary mode. Opening files in text mode may cause&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># newline translations, making the actual size of the content&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># transmitted *less* than the content-length!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;rb&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span> &lt;span class="ne">IOError&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send_error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">404&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;File not found&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send_response&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">200&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send_header&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Content-type&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ctype&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">fs&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fstat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fileno&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send_header&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Content-Length&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fs&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">6&lt;/span>&lt;span class="p">]))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send_header&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Last-Modified&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">date_time_string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fs&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">st_mtime&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">end_headers&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">f&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">list_directory&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">path&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;Helper to produce a directory listing (absent index.html).
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> Return value is either a file object, or None (indicating an
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> error). In either case, the headers are sent, making the
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> interface the same as for send_head().
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">list&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">listdir&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">error&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send_error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">404&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;No permission to list directory&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">lambda&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">lower&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">BytesIO&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">displaypath&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cgi&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">escape&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">urllib&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parse&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">unquote&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">b&lt;/span>&lt;span class="s1">&amp;#39;&amp;lt;!DOCTYPE html PUBLIC &amp;#34;-//W3C//DTD HTML 3.2 Final//EN&amp;#34;&amp;gt;&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;html&amp;gt;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;lt;title&amp;gt;Directory listing for &lt;/span>&lt;span class="si">%s&lt;/span>&lt;span class="s2">&amp;lt;/title&amp;gt;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="n">displaypath&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">encode&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;body&amp;gt;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;lt;h2&amp;gt;Directory listing for &lt;/span>&lt;span class="si">%s&lt;/span>&lt;span class="s2">&amp;lt;/h2&amp;gt;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="n">displaypath&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">encode&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">b&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;hr&amp;gt;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">b&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;form ENCTYPE=&lt;/span>&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="s2">multipart/form-data&lt;/span>&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="s2"> method=&lt;/span>&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="s2">post&lt;/span>&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="s2">&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">b&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;input name=&lt;/span>&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="s2">file&lt;/span>&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="s2"> type=&lt;/span>&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="s2">file&lt;/span>&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="s2">/&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">b&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;input type=&lt;/span>&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="s2">submit&lt;/span>&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="s2"> value=&lt;/span>&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="s2">upload&lt;/span>&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="s2">/&amp;gt;&amp;lt;/form&amp;gt;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">b&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;hr&amp;gt;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;lt;ul&amp;gt;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">name&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">list&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">fullname&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">displayname&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">linkname&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Append / for directories or @ for symbolic links&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">isdir&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fullname&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">displayname&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">name&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s2">&amp;#34;/&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">linkname&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">name&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s2">&amp;#34;/&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">islink&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fullname&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">displayname&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">name&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s2">&amp;#34;@&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Note: a link to a directory displays with @ and links with /&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="s1">&amp;#39;&amp;lt;li&amp;gt;&amp;lt;a href=&amp;#34;&lt;/span>&lt;span class="si">%s&lt;/span>&lt;span class="s1">&amp;#34;&amp;gt;&lt;/span>&lt;span class="si">%s&lt;/span>&lt;span class="s1">&amp;lt;/a&amp;gt;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">%&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">urllib&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parse&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">quote&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">linkname&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">cgi&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">escape&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">displayname&lt;/span>&lt;span class="p">)))&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">encode&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">b&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;/ul&amp;gt;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;lt;hr&amp;gt;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;lt;/body&amp;gt;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;lt;/html&amp;gt;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">length&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">tell&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">seek&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send_response&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">200&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send_header&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Content-type&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;text/html&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send_header&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Content-Length&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">length&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">end_headers&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">f&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">translate_path&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">path&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;Translate a /-separated PATH to the local filename syntax.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> Components that mean special things to the local file system
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> (e.g. drive or directory names) are ignored. (XXX They should
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> probably be diagnosed.)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># abandon query parameters&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;?&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;#&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">posixpath&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">normpath&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">urllib&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parse&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">unquote&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">words&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;/&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">words&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">_f&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">_f&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">words&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">_f&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">getcwd&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">word&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">words&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">drive&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">word&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">splitdrive&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">word&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">head&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">word&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">word&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">word&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">curdir&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">pardir&lt;/span>&lt;span class="p">):&lt;/span> &lt;span class="k">continue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">word&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">path&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">copyfile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">source&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">outputfile&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;Copy all data between two file objects.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> The SOURCE argument is a file object open for reading
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> (or anything with a read() method) and the DESTINATION
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> argument is a file object open for writing (or
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> anything with a write() method).
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> The only reason for overriding this would be to change
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> the block size or perhaps to replace newlines by CRLF
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> -- note however that this the default server uses this
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> to copy binary data as well.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">shutil&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">copyfileobj&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">source&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">outputfile&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">guess_type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">path&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;Guess the type of a file.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> Argument is a PATH (a filename).
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> Return value is a string of the form type/subtype,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> usable for a MIME Content-type header.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> The default implementation looks the file&amp;#39;s extension
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> up in the table self.extensions_map, using application/octet-stream
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> as a default; however it would be permissible (if
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> slow) to look inside the data to make a better guess.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">base&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ext&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">posixpath&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">splitext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">ext&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">extensions_map&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">extensions_map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">ext&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ext&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ext&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">lower&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">ext&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">extensions_map&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">extensions_map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">ext&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">extensions_map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">mimetypes&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">inited&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">mimetypes&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">init&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1"># try to read system mime.types&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">extensions_map&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">mimetypes&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">types_map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">copy&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">extensions_map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">update&lt;/span>&lt;span class="p">({&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;application/octet-stream&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1"># Default&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;.py&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;text/plain&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;.c&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;text/plain&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;.h&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;text/plain&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">port&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">server_class&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">http&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">server&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">HTTPServer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">handler_class&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">SimpleHTTPRequestHandler&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">server_address&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">port&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">httpd&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">server_class&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">server_address&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">handler_class&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">httpd&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">serve_forever&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="vm">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="ow">or&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">isdigit&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Usage: &lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s1"> &amp;lt;port&amp;gt;&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>样子长这样, 多了个上传功能&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/blog/WechatIMG132.png" alt="贴图">&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>Kitsunebi Android 使用简介</title><link>https://blog.ferstar.org/post/kitsunebi-android/</link><guid isPermaLink="true">https://blog.ferstar.org/post/kitsunebi-android/</guid><pubDate>Wed, 12 Jun 2019 14:01:41 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>发现安卓上一个优秀的&lt;code>v2ray&lt;/code>客户端软件&lt;a href="https://withdewhua.space/2019/04/12/kitsunebi-android/">Kitsunebi&lt;/a>, 支持单独订阅规则+分应用代理, 真香, 不过使用过程中谷歌商店只能浏览不能下载, 研究了下发现需要把本机&lt;code>下载管理APP&lt;/code>也要加进分应用代理的&lt;code>白名单&lt;/code>里&lt;/p>
&lt;p>搭配&lt;code>神机规则&lt;/code>食用更佳&lt;/p>
&lt;p>&lt;a href="https://raw.githubusercontent.com/ConnersHua/Profiles/master/Kitsunebi/Pro.conf">https://raw.githubusercontent.com/ConnersHua/Profiles/master/Kitsunebi/Pro.conf&lt;/a>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>Pass Through the GFW with V2ray</title><link>https://blog.ferstar.org/post/pass_through_the_gfw_with_v2ray/</link><guid isPermaLink="true">https://blog.ferstar.org/post/pass_through_the_gfw_with_v2ray/</guid><pubDate>Mon, 10 Jun 2019 10:06:55 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>macOS长期不关机貌似时间会变慢, 跟梯子服务器时间差大于90s后就报错扑街, 所以需要更一下时间&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>&lt;code>sudo sntp -sS time.apple.com&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>或者干脆重启就正常了&lt;/p>
&lt;/blockquote>
&lt;p>这次功夫墙来的似乎比以往都猛一些, ss 彻底没法用了, 只好再整个梯子, 比如 v2ray&lt;/p>
&lt;p>托 docker 的福, 整个部署过程比较轻松写意, 不过因为家里移动宽带不给力的原因, 还得套个 cf 的 cdn 才能 ok&lt;/p>
&lt;p>这套即传说中的&lt;code>WebSocket+TLS+Web&lt;/code>三件套, 再加 &lt;code>cloudflare&lt;/code> CDN 护体, 基本上算是当前最强抗干扰的梯子配置了&lt;/p>
&lt;p>用法很简单:&lt;/p>
&lt;ol>
&lt;li>域名/vps你得有&lt;/li>
&lt;li>给vps装个docker&amp;amp;docker-compose&lt;/li>
&lt;li>下面的三个文件适当改下配置, 如端口/email/uuid等, 复制到同一目录下&lt;/li>
&lt;li>运行&lt;code>docker-compose up -d&lt;/code>&lt;/li>
&lt;li>套个 CDN 保护真实 IP 地址(此步可选)&lt;/li>
&lt;/ol>
&lt;p>&lt;code>docker-compose.yml&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;3&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">services&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">v2ray&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v2ray/official&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">./config.json:/etc/v2ray/config.json&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">expose&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;44222&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># if you need to change this you should change Caddyfile as well&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">caddy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">abiosoft/caddy&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">./Caddyfile:/etc/Caddyfile:ro&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">./caddyCertificates:/root/.caddy&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">environment&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">ACME_AGREE=true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;80:80&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;443:443&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>config.json&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;inbounds&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;listen&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;0.0.0.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;streamSettings&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;network&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ws&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;wsSettings&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;path&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/ray&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;security&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;none&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;settings&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;clients&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;id&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ef50ae52-3f24-4391-a67a-92cf5422f9ff&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;alterId&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">32&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;protocol&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;vmess&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;port&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">44222&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;outbounds&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;tag&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;direct&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;settings&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;protocol&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;freedom&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>Caddyfile&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">xxx.xxx.xxx &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> gzip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tls your_mail@qq.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># generated by uuid tools for WebSocket path&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy /ray v2ray:44222 &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> websocket
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> header_upstream -Origin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy / https://www.bing.com &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> transparent
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># write log to stdout for docker&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> log stdout
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> errors stdout
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/docker/">DOCKER</category></item><item><title>Mkhash Cannot Execute Binary File</title><link>https://blog.ferstar.org/post/mkhash-cannot-execute-binary-file/</link><guid isPermaLink="true">https://blog.ferstar.org/post/mkhash-cannot-execute-binary-file/</guid><pubDate>Thu, 20 Dec 2018 10:25:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>编译openwrt固件时碰到这么个问题, 记录下解决方案:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> scripts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gcc mkhash.c -o mkhash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mv mkhash ../staging_dir/host/bin/mkhash
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>原因就是&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ ./scripts/feeds update -a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ ./scripts/feeds install -a
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这两命令执行完&lt;code>mkhash&lt;/code>这个程序居然没有自动编译好, 原因就不深究了, 毕竟只是用用而已&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/openwrt/">OPENWRT</category></item><item><title>Completely Turn Off Amd Gpu on Mac Pro Early 2011</title><link>https://blog.ferstar.org/post/completely-turn-off-amd-gpu-on-mac-pro-early-2011/</link><guid isPermaLink="true">https://blog.ferstar.org/post/completely-turn-off-amd-gpu-on-mac-pro-early-2011/</guid><pubDate>Sun, 09 Dec 2018 16:57:37 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>手上的MacPro中了显卡门, 频繁花屏重启, 各种折腾后总算堪用, 完全禁掉了坑爹的AMD独显, 副作用是本子关上盖子屏幕就无法点亮(休眠是OK的,就是屏幕不亮, 重启才正常), 除了不再花屏卡死重启以外, 还有个额外的好处就是&lt;code>C&lt;/code>面右手掌托位置几乎不会发热, 所以完全可以把左边风扇转速调大, 右边保持默认, 兼顾静音+散热&lt;/p>
&lt;p>&lt;a href="https://gist.github.com/blackgate/17ac402e35d2f7e0f1c9708db3dc7a44">https://gist.github.com/blackgate/17ac402e35d2f7e0f1c9708db3dc7a44&lt;/a>&lt;/p>
&lt;p>hw: mac pro i7 15' early 2011(with the fucking AMD GPU inside)&lt;/p>
&lt;p>os: HighSierra 10.13.6 (17G4015)&lt;/p>
&lt;p>here are my final EFI file tree structure(extra efi files are come from Ubuntu 18.04 official ISO):&lt;/p>
&lt;pre tabindex="0">&lt;code>.
├── [ 512] EFI
│ ├── [ 512] APPLE
│ │ ├── [ 512] CACHES
│ │ │ └── [ 512] CAFEBEEF
│ │ └── [ 512] EXTENSIONS
│ │ └── [ 15M] Firmware.scap
│ └── [ 512] grub
│ ├── [1.1M] BOOTx64.EFI
│ └── [1.1M] grubx64.efi
└── [ 512] boot
└── [1.0K] grub
├── [2.3M] efi.img
├── [4.9K] font.pf2
├── [ 278] grub.cfg
├── [ 55] loopback.cfg
└── [ 12K] x86_64-efi
├── [ 15K] acpi.mod
├── [1.9K] adler32.mod
├── [ 22K] xxx.mod
&lt;/code>&lt;/pre>&lt;p>and my grub.cfg:&lt;/p>
&lt;pre tabindex="0">&lt;code>set timeout=10
menuentry &amp;#34;macOS with outb - Power Off AMD GPU at boot - lose brightness control HighSierra&amp;#34; {
outb 0x728 1
outb 0x710 2
outb 0x740 2
outb 0x750 0
exit
}
menuentry &amp;#34;macOS without outb - AMD GPU stay Power On at boot - with brightness control HighSierra&amp;#34; {
exit
}
&lt;/code>&lt;/pre>&lt;p>and follow &lt;a href="https://forums.macrumors.com/threads/disable-a-failed-amd-gpu-on-a-2011-macbook-pro-grub-solution.2087527/">this post steps&lt;/a> load the attached kext to prevent the GPU from waking up from sleep&lt;/p>
&lt;p>I also installed smcFanControl to lower the CPU temperature and use Brightness Slider to control screen light&lt;/p>
&lt;p>Unfortunately, when I close the lid and open again, the screen can't wake up unless reboot it.&lt;/p>
&lt;p>But, compared to the frequent crash and boot loops, the wake up issue is just little case which can be ignored.&lt;/p>
&lt;p>PS: I upload some useful software to Google disk&lt;/p>
&lt;p>&lt;a href="https://drive.google.com/drive/folders/1bURkW1n8ARDR4TsjcE08WJ2gCpAevubw?usp=sharing">https://drive.google.com/drive/folders/1bURkW1n8ARDR4TsjcE08WJ2gCpAevubw?usp=sharing&lt;/a>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>Remove Duplicates in Postgresql</title><link>https://blog.ferstar.org/post/remove-duplicates-in-postgresql/</link><guid isPermaLink="true">https://blog.ferstar.org/post/remove-duplicates-in-postgresql/</guid><pubDate>Sun, 09 Dec 2018 16:40:41 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">DELETE&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">des_table&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">IN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">des_table&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">dup_col&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">IN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">dup_col&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">des_table&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">GROUP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">BY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">dup_col&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">HAVING&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dup_col&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">AND&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">IN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">min&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">des_table&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">dup_col&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">IN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">dup_col&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">des_table&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">GROUP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">BY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">dup_col&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">HAVING&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dup_col&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>效果就是保留了重复记录&lt;code>dup_col&lt;/code>中&lt;code>id&lt;/code>最小的那个&lt;/p>
&lt;p>想到个更简单的&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">DELETE&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">dst_table&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">IN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">max&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">dst_table&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">GROUP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">BY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">dup_col&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category><category domain="https://blog.ferstar.org/tags/sql/">SQL</category></item><item><title>Import Csv to Postgresql With Duplicated Items Removed</title><link>https://blog.ferstar.org/post/import-csv-to-postgresql-with-duplicated-items-removed/</link><guid isPermaLink="true">https://blog.ferstar.org/post/import-csv-to-postgresql-with-duplicated-items-removed/</guid><pubDate>Sun, 09 Dec 2018 15:51:13 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>碰到个业务需求: 把一大坨&lt;code>csv&lt;/code>文件原样导入&lt;code>PostgreSQL&lt;/code>中, 于是速查官方文档, 手撸&lt;code>SQL&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">COPY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">des_table&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">age&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id_no&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;/path/to/src/csv&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DELIMITER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;,&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CSV&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HEADER&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然而可耻报错:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">ERROR: duplicate key value violates unique constraint &lt;span class="s2">&amp;#34;uq_des_table_id_no&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">key &lt;span class="o">(&lt;/span>id_no&lt;span class="o">)=(&lt;/span>3.141592653&lt;span class="o">)&lt;/span> already exists.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>原来是目标&lt;code>des_table&lt;/code>中&lt;code>id_no&lt;/code>是索引, &lt;code>csv&lt;/code>文件中有重复记录, 那么问题来了, 需要把重复的去掉, 两个思路, 要么写脚本提前把&lt;code>csv&lt;/code>过滤一遍, 要么直接用&lt;code>SQL&lt;/code>去排除重复, 看了下文件有两百多万行, 我选择用&lt;code>SQL&lt;/code>直撸&lt;/p>
&lt;p>Google一番, 基本思路就是先建个临时表, 然后把记录拷过去, 然后再把临时表中的记录拷到目标&lt;code>table&lt;/code>中, 利用&lt;code>PostgreSQL&lt;/code>新版本的一个特性&lt;code>ON CONFLICT DO NOTHING&lt;/code>即冲突啥也不做&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- 建临时表
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TEMP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tmp_table&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">des_table&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">WITH&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DATA&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- 数据导入临时表
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">COPY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tmp_table&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">age&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id_no&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;/path/to/src/csv&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DELIMITER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;,&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CSV&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">HEADER&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- 从临时表导入数据
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">INSERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INTO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">des_table&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">age&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id_no&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">age&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id_no&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tmp_table&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CONFLICT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOTHING&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- 导入完毕, 删掉tmp_table
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">DROP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tmp_table&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category><category domain="https://blog.ferstar.org/tags/sql/">SQL</category></item><item><title>Python Understanding Dict Copy Shallow or Deep</title><link>https://blog.ferstar.org/post/python-understanding-dict-copy-shallow-or-deep/</link><guid isPermaLink="true">https://blog.ferstar.org/post/python-understanding-dict-copy-shallow-or-deep/</guid><pubDate>Sat, 01 Dec 2018 17:31:03 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;ul>
&lt;li>**直接赋值：**其实就是对象的引用（别名）。&lt;/li>
&lt;li>**浅拷贝(copy)：**拷贝父对象，不会拷贝对象的内部的子对象。&lt;/li>
&lt;li>&lt;strong>深拷贝(deepcopy)：&lt;/strong> copy 模块的 deepcopy 方法，完全拷贝了父对象及其子对象。&lt;/li>
&lt;/ul>
&lt;p>比较二的拿一个嵌套很多层的&lt;code>dict&lt;/code>直接赋值, 结果悲剧了, 引发了一系列子对象比如&lt;code>list&lt;/code>内容各种异常, 使用&lt;code>deepcopy&lt;/code>后正常&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/blog/20181201173603.png" alt="贴图">&lt;/p>
&lt;p>悲剧就出在&lt;code>L&lt;/code>不停的被修改...&lt;/p>
&lt;p>&lt;a href="http://www.runoob.com/w3cnote/python-understanding-dict-copy-shallow-or-deep.html">http://www.runoob.com/w3cnote/python-understanding-dict-copy-shallow-or-deep.html&lt;/a>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>Ubuntu 18.04 set up Shadowsocks server with fail2ban</title><link>https://blog.ferstar.org/post/ubuntu-18.04-set-up-shadowsocks-server-with-fail2ban/</link><guid isPermaLink="true">https://blog.ferstar.org/post/ubuntu-18.04-set-up-shadowsocks-server-with-fail2ban/</guid><pubDate>Sat, 01 Dec 2018 13:33:45 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>Here I use Shadowsocks-libev for better performance&lt;/p>
&lt;/blockquote>
&lt;h1 id="shadowsocks-libevhttpsgithubcomshadowsocksshadowsocks-libev">&lt;a href="https://github.com/shadowsocks/shadowsocks-libev">Shadowsocks-libev&lt;/a>&lt;/h1>
&lt;p>Shadowsocks-libev is written in pure C and depends on libev.&lt;/p>
&lt;pre tabindex="0">&lt;code># install
sudo apt install shadowsocks-libev
sudo ufw allow 8389
# config
sudo tee /etc/shadowsocks-libev/config.json &amp;gt; /dev/null&amp;lt;&amp;lt;EOF
{
&amp;#34;server&amp;#34;:&amp;#34;0.0.0.0&amp;#34;,
&amp;#34;server_port&amp;#34;:8389,
&amp;#34;local_port&amp;#34;:1081,
&amp;#34;password&amp;#34;:&amp;#34;$(openssl rand -base64 12)&amp;#34;,
&amp;#34;timeout&amp;#34;:60,
&amp;#34;method&amp;#34;:&amp;#34;chacha20-ietf-poly1305&amp;#34;
}
EOF
# start
sudo systemctl restart shadowsocks-libev
sudo systemctl start shadowsocks-libev.service
sudo systemctl enable shadowsocks-libev.service
# check
sudo systemctl status shadowsocks-libev.service
&lt;/code>&lt;/pre>&lt;h2 id="problem">Problem&lt;/h2>
&lt;p>systemctl status shadowsocks-libev.service status shows following error:[2]&lt;/p>
&lt;blockquote>
&lt;p>This system doesn’t provide enough entropy to quickly generate high-quality random numbers. The service will not start until enough entropy has been collected.&lt;/p>
&lt;/blockquote>
&lt;h2 id="solution">Solution&lt;/h2>
&lt;pre tabindex="0">&lt;code>sudo apt-get install rng-tools
sudo rngd -r /dev/urandom
&lt;/code>&lt;/pre>&lt;h1 id="fail2banhttpsgithubcomfail2banfail2ban">&lt;a href="https://github.com/fail2ban/fail2ban">fail2ban&lt;/a>&lt;/h1>
&lt;p>There are also other options to secure the Shadowsocks Server[3]&lt;/p>
&lt;p>But since my server is only uesd by some acquaintances, I just care about brute force password cracking.&lt;/p>
&lt;h2 id="intro">Intro&lt;/h2>
&lt;p>fail2ban is used to ban IP addresses conducting too many failed login attempts.&lt;/p>
&lt;p>How fail2ban works?[4]
fail2ban use date pattern to capture and remove the date from log, and then use failregex to parse the log to get the IP. After that, fail2ban would update the firewall rule to block the IP addresses&lt;/p>
&lt;h2 id="log-file">log file&lt;/h2>
&lt;p>Both Shadowsocks and Shadowsocks-libev output log to /var/log/syslog, Shadowsocks also output some INFO and DEBUG level log to /var/log/shadowsocks.log&lt;/p>
&lt;p>Shadowsocks can customize log file location but Shadowsocks-libev cannot[5]&lt;/p>
&lt;p>I would use ufw rather than iptables to modify my firewall &lt;code>sudo vim /etc/fail2ban/jail.local&lt;/code>&lt;/p>
&lt;pre tabindex="0">&lt;code>[DEFAULT]
banaction = ufw
&lt;/code>&lt;/pre>&lt;h2 id="shadowsocks-libev">Shadowsocks-libev&lt;/h2>
&lt;h3 id="log-sample">log sample&lt;/h3>
&lt;pre tabindex="0">&lt;code>Aug 15 08:59:07 &amp;lt;hostname&amp;gt; ss-server[1382]: 2018-08-15 08:59:07 ERROR: failed to handshake with &amp;lt;HOST&amp;gt;: authentication error
&lt;/code>&lt;/pre>&lt;h3 id="create-filter">create filter&lt;/h3>
&lt;pre tabindex="0">&lt;code>sudo tee /etc/fail2ban/filter.d/shadowsocks-libev.conf &amp;gt; /dev/null &amp;lt;&amp;lt;EOF
[INCLUDES]
before = common.conf
[Definition]
_daemon = ss-server
failregex = ^\w+\s+\d+ \d+:\d+:\d+\s+%(__prefix_line)sERROR:\s+failed to handshake with &amp;lt;HOST&amp;gt;: authentication error$
ignoreregex =
datepattern = %%Y-%%m-%%d %%H:%%M:%%S
EOF
&lt;/code>&lt;/pre>&lt;p>&lt;strong>test&lt;/strong>
&lt;code>fail2ban-regex /var/log/syslog /etc/fail2ban/filter.d/shadowsocks-libev.conf --print-all-matched&lt;/code>&lt;/p>
&lt;h3 id="update-jail-config">update jail config&lt;/h3>
&lt;pre tabindex="0">&lt;code>sudo vim /etc/fail2ban/jail.local
[shadowsocks-libev]
enabled = true
filter = shadowsocks-libev
port = 8839
logpath = /var/log/syslog
maxretry = 3
findtime = 3600
bantime = 3600
&lt;/code>&lt;/pre>&lt;h2 id="start-fail2ban">start fail2ban&lt;/h2>
&lt;pre tabindex="0">&lt;code>sudo systemctl restart fail2ban
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
sudo systemctl status fail2ban
sudo fail2ban-client status shadowsocks
sudo fail2ban-client status shadowsocks-libev
&lt;/code>&lt;/pre>&lt;h1 id="notes">Notes&lt;/h1>
&lt;ul>
&lt;li>
&lt;p>use ufw rather than iptables to modify firewall, it would make life easier&lt;/p>
&lt;blockquote>
&lt;p>UFW (Uncomplicated Firewall) is a front-end for iptables and is particularly well-suited for host-based firewalls.&lt;a href="https://help.ubuntu.com/community/Firewall">https://help.ubuntu.com/community/Firewall&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Can't assign requested address&lt;/code>[11]
In config file, set the server_ip as 0.0.0.0&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h1 id="reference">Reference&lt;/h1>
&lt;p>[1] &lt;a href="https://novnan.github.io/Shadowsocks/setup-Shadowsocks-on-ubuntu-1604/">https://novnan.github.io/Shadowsocks/setup-Shadowsocks-on-ubuntu-1604/&lt;/a>&lt;/p>
&lt;p>[2] &lt;a href="https://www.linuxbabe.com/ubuntu/shadowsocks-libev-proxy-server-ubuntu-16-04-17-10">https://www.linuxbabe.com/ubuntu/shadowsocks-libev-proxy-server-ubuntu-16-04-17-10&lt;/a>&lt;/p>
&lt;p>[3] &lt;a href="https://github.com/shadowsocks/shadowsocks/wiki/Securing-Public-Shadowsocks-Server">https://github.com/shadowsocks/shadowsocks/wiki/Securing-Public-Shadowsocks-Server&lt;/a>&lt;/p>
&lt;p>[4] &lt;a href="https://github.com/fail2ban/fail2ban/issues/2201#issuecomment-413155557">https://github.com/fail2ban/fail2ban/issues/2201#issuecomment-413155557&lt;/a>&lt;/p>
&lt;p>[5] &lt;a href="https://github.com/shadowsocks/shadowsocks/issues/1242">https://github.com/shadowsocks/shadowsocks/issues/1242&lt;/a>&lt;/p>
&lt;p>[6] &lt;a href="https://fail2ban.readthedocs.io/en/latest/filters.html">https://fail2ban.readthedocs.io/en/latest/filters.html&lt;/a>&lt;/p>
&lt;p>[7] &lt;a href="https://www.fail2ban.org/wiki/index.php/MANUAL_0_8#Filters">https://www.fail2ban.org/wiki/index.php/MANUAL_0_8#Filters&lt;/a>&lt;/p>
&lt;p>[8] &lt;a href="https://github.com/coleturner/fail2ban-slack-action">https://github.com/coleturner/fail2ban-slack-action&lt;/a>&lt;/p>
&lt;p>[9] &lt;a href="https://api.slack.com/methods/chat.postMessage">https://api.slack.com/methods/chat.postMessage&lt;/a>&lt;/p>
&lt;p>[10] &lt;a href="https://api.slack.com/incoming-webhooks">https://api.slack.com/incoming-webhooks&lt;/a>&lt;/p>
&lt;p>[11] &lt;a href="https://github.com/shadowsocks/shadowsocks/issues/961">https://github.com/shadowsocks/shadowsocks/issues/961&lt;/a>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/ubuntu/">UBUNTU</category></item><item><title>Postgresql Jsonb Functions and Operators</title><link>https://blog.ferstar.org/post/postgresql-jsonb-functions-and-operators/</link><guid isPermaLink="true">https://blog.ferstar.org/post/postgresql-jsonb-functions-and-operators/</guid><pubDate>Fri, 30 Nov 2018 15:14:14 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>PG 对 json 的支持真是美如画&lt;/p>
&lt;p>&lt;a href="https://www.postgresql.org/docs/9.5/functions-json.html">https://www.postgresql.org/docs/9.5/functions-json.html&lt;/a>&lt;/p>
&lt;p>比如 hello 表有个 result 字段长这样&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;result&amp;#34;&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;items&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;warrants&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;convertiables&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;warrants&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;index&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>需要把&lt;code>index&lt;/code>大于&lt;code>0&lt;/code>的记录找出来&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hello&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">result&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;warrants&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">-&amp;gt;&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;index&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">::&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">INT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>爽的很啊&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category><category domain="https://blog.ferstar.org/tags/sql/">SQL</category></item><item><title>将图床从七牛云迁移到腾讯COS</title><link>https://blog.ferstar.org/post/move-pic-url-to-tencent-cos/</link><guid isPermaLink="true">https://blog.ferstar.org/post/move-pic-url-to-tencent-cos/</guid><pubDate>Fri, 30 Nov 2018 12:34:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>七牛云的免费域名现在有了生命周期, 才一个月有效期就会被收回, 所以是时候给博客图床挪个窝了&lt;/p>
&lt;p>看了下腾讯COS免费额度还不错, 嗯还带HTTPS, 真香, 速度迁移&lt;/p>
&lt;p>迁移过程参考这篇文章:&lt;/p>
&lt;p>&lt;a href="http://robotkang.cc/2018/11/pic/">http://robotkang.cc/2018/11/pic/&lt;/a>&lt;/p>
&lt;p>简单记录如下&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 1. 把原 bucket 中需要下载的内容清单用 qshell 拖下来&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">qshell listbucket &amp;lt;原 bucket&amp;gt; &lt;span class="p">|&lt;/span> grep -v &lt;span class="s1">&amp;#39;_log&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> awk &lt;span class="s2">&amp;#34;{print &lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s2">}&amp;#34;&lt;/span> &amp;gt; list.txt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 2. 新建一个 bucket 如 new, 然后内容转移到 new&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">qshell batchcopy &amp;lt;old&amp;gt; &amp;lt;new&amp;gt; -i list.txt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 3. 从 new 批量下载到本地&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">qshell qdownload batch_download.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># batch_download.conf 内容如下&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;dest_dir&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;/xxx/xxx/Downloads/qiniu&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;bucket&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;new&amp;#34;&lt;/span>, （新建的 bucket 的名称）
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;prefix&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;suffixes&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;cdn_domain&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;http://pgiolcvny.bkt.clouddn.com&amp;#34;&lt;/span>,（新建的 bucket 的测试域名）
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;referer&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;log_file&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;download.log&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;log_level&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;info&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;log_rotate&amp;#34;&lt;/span> : 1,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;log_stdout&amp;#34;&lt;/span> : &lt;span class="nb">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 4. 上传下载的文件到腾讯COS, 这个纯浏览器就能操作&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 5. 批量替换博文中七牛云链接为腾讯COS链接&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s1">&amp;#39;s#http://xxx.z0.glb.clouddn.com#https://blog-xxxx.cos.ap-chengdu.myqcloud.com#g&amp;#39;&lt;/span> *.md
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>大功告成~&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>利用MQTT远程唤醒内网电脑</title><link>https://blog.ferstar.org/post/use-mqtt-wol-on-openwrt/</link><guid isPermaLink="true">https://blog.ferstar.org/post/use-mqtt-wol-on-openwrt/</guid><pubDate>Thu, 09 Aug 2018 17:53:16 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>偶尔需要远程登录公司电脑处理一些事情，但老是开着机太费电，刚好手上有个VPS，还有个MTK7628方案的一个小路由，又刚好维护着个人订阅号一枚，然后又刚刚好看到度娘提供的天工物接入服务，所以一个点子诞生：给公众号发某个暗号(特殊数字啥的)完成远程开机任务。&lt;/p>
&lt;p>所以消息链路是这样的：&lt;/p>
&lt;ol start="0">
&lt;li>确认电脑主板支持wake on lan功能，并且同时在操作系统及BIOS中开启此功能，这是基本前提&lt;/li>
&lt;li>如果是Windows8及以上，需要关闭快速启动功能&lt;/li>
&lt;li>给公众号发暗号&lt;/li>
&lt;li>公众号捕获暗号，给天工物接入服务特定topic发布开机消息&lt;/li>
&lt;li>路由器MQTT客户端收到天工物接入服务转发的开机消息&lt;/li>
&lt;li>调用etherwake软件唤醒目标计算机&lt;/li>
&lt;/ol>
&lt;p>过程中用到的软件/组件：&lt;/p>
&lt;ol start="0">
&lt;li>&lt;a href="https://play.google.com/store/apps/details?id=net.routix.mqttdash">MQTT Dash&lt;/a> - 手机端发送消息给MQTT server&lt;/li>
&lt;li>&lt;a href="http://werobot.readthedocs.io/zh_CN/latest/">WeRoBot&lt;/a> - 一个微信公众号开发框架&lt;/li>
&lt;li>&lt;a href="https://iot.baidu.com">天工-物联网平台-物联网云-百度云&lt;/a> - 这里被用作MQTT Server&lt;/li>
&lt;li>&lt;a href="https://wiki.openwrt.org/doc/uci/etherwake">etherwake&lt;/a> - 网络唤醒软件&lt;/li>
&lt;li>mosquitto-client-nossl - MQTT客户端&lt;/li>
&lt;/ol>
&lt;p>天工物接入照着官方文档很好配，配好后写个脚本扔路由里(运行openwrt系统)跑起来&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">HOSTNAME&lt;/span>&lt;span class="o">=&lt;/span>office_pc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">HOST&lt;/span>&lt;span class="o">=&lt;/span>xxx.mqtt.iot.gz.baidubce.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">USER&lt;/span>&lt;span class="o">=&lt;/span>用户名
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">PASSWD&lt;/span>&lt;span class="o">=&lt;/span>天工物接入密钥
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">TOPIC&lt;/span>&lt;span class="o">=&lt;/span>wake_on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">TARGET&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;唤醒目标电脑网卡MAC地址&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">while&lt;/span> :
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 收到一次消息即退出接收，收不到消息就阻塞等待，所以这个死循环并不怎么耗CPU，并不需要设sleep时间&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">s&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>/usr/bin/mosquitto_sub -i &lt;span class="nv">$HOSTNAME&lt;/span> -h &lt;span class="nv">$HOST&lt;/span> -u &lt;span class="nv">$USER&lt;/span> -P &lt;span class="nv">$PASSWD&lt;/span> -t &lt;span class="nv">$TOPIC&lt;/span> -C 1&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">d&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>date +%Y-%m-%dT%H:%M:%S&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">s&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="nv">x&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;onx&amp;#39;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">d&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2"> GET &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">s&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2"> command, will wake on xps&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /usr/bin/etherwake -i &lt;span class="s2">&amp;#34;br-lan&amp;#34;&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">TARGET&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">d&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2"> GET &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">s&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2"> command, do nothing&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>写个死循环监听消息，用&lt;code>nohup&lt;/code>方式启动，扔进&lt;code>/etc/rc.local&lt;/code>里搞定自启动&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">/usr/bin/nohup /root/wake_on.sh &amp;gt; /root/wake_on.log &lt;span class="p">&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 写在exit 0之前&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">exit&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>公众号服务端消息发布脚本&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">HOSTNAME&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">do&lt;/span>-vps
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">HOST&lt;/span>&lt;span class="o">=&lt;/span>xxx.mqtt.iot.gz.baidubce.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">USER&lt;/span>&lt;span class="o">=&lt;/span>用户名
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">PASSWD&lt;/span>&lt;span class="o">=&lt;/span>天工物接入密钥
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">TOPIC&lt;/span>&lt;span class="o">=&lt;/span>wake_on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">MSG&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;on&amp;#34;&lt;/span> &lt;span class="c1"># 这个消息内容可以随便定制，与客户端判断逻辑一致即可&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/usr/bin/mosquitto_pub -i &lt;span class="nv">$HOSTNAME&lt;/span> -h &lt;span class="nv">$HOST&lt;/span> -u &lt;span class="nv">$USER&lt;/span> -P &lt;span class="nv">$PASSWD&lt;/span> -t &lt;span class="nv">$TOPIC&lt;/span> -m &lt;span class="nv">$MSG&lt;/span> &lt;span class="p">&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>改可执行权限，直接在WeRoBot中用&lt;code>subprocess&lt;/code>调用即可&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">subprocess&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">bash_command&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lst&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;&amp;#34;&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s1">&amp;#34;&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cli&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39; &amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">lst&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">proc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">subprocess&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cli&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">shell&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>最终目标达成，远程开机功能完美实现。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">root@GL-MT300N-V2:~# tail wake_on.log
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2018-08-09T17:48:51 GET on command, will wake on xps
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>数秒后电脑开机，自动启动teamviewer，可以开始愉快的远程工作了~&lt;/p>
&lt;p>PS：其实肯定还有别的解决方法，比如利用IFTTT、DDNS啥的，只要稍稍有点码力加折腾精神，很好搞定。&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>利用 IFTTT webhooks 服务给 Telegram 发送消息</title><link>https://blog.ferstar.org/post/ifttt-to-telegram/</link><guid isPermaLink="true">https://blog.ferstar.org/post/ifttt-to-telegram/</guid><pubDate>Fri, 20 Jul 2018 15:32:29 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>发现之前的&lt;a href="https://blog.ferstar.org/post/use-tasker-do-some-funny-things/#%E5%8F%AA%E5%9C%A8%E5%B7%A5%E4%BD%9C%E6%97%A5%E7%AD%BE%E5%88%B0">自动签到&lt;/a>方案还是不甚完美：签到成功与否没有消息通知。&lt;/p>
&lt;p>所以就想到用 IFTTT 结合 Telegram 来搞一搞这个签到反馈，实现的效果是这样的：&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/jpg/2018/7/4f0fbde53b682d2ac8b039096d178a4d.jpg" alt="签到完成">&lt;/p>
&lt;p>需要在 IFTTT 中开一个 applets&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/jpg/2018/7/b185adb9739049077f0b23f613974a04.jpg" alt="ifttt_sign">&lt;/p>
&lt;p>脚本加点新内容：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/system/bin/sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>&lt;span class="c1"># file: auto_login&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 具体坐标及延时请视自己手机而定，不要照搬&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查询当天是否为工作日&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 0 - 工作日，1 - 假日，2 - 节日&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">DAY&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>curl -s http://tool.bitefu.net/jiari/?d&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>date +%Y%m%d&lt;span class="k">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># webhook url&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">IFTTT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;https://maker.ifttt.com/trigger/sign_in_office/with/key/{your-key}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">send_msg&lt;span class="o">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -X POST -H &lt;span class="s2">&amp;#34;Content-Type: application/json&amp;#34;&lt;/span> -d &lt;span class="s1">&amp;#39;{&amp;#34;value1&amp;#34;: &amp;#34;&amp;#39;&lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s1">&amp;#39;&amp;#34;}&amp;#39;&lt;/span> &lt;span class="nv">$IFTTT&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">DAY&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="nv">x&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;x&amp;#39;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> send_msg &lt;span class="s2">&amp;#34;网络故障或节假日API不可用&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">elif&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">DAY&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="nv">x&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;0x&amp;#39;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 延时一秒再模拟滑动解锁&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sleep &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> adb shell input swipe &lt;span class="m">538&lt;/span> &lt;span class="m">1033&lt;/span> &lt;span class="m">555&lt;/span> &lt;span class="m">536&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 延时三秒再打开APP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sleep &lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> am start -n com.alibaba.android.rimet/com.alibaba.android.rimet.ui.activity.StartActivity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 视手机性能及网络影响，APP完全打开需要一定时间，所以延时最好多延几秒&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sleep &lt;span class="m">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 模拟点击签到按钮&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> adb shell input tap &lt;span class="m">133&lt;/span> &lt;span class="m">730&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sleep &lt;span class="m">5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> adb shell input tap &lt;span class="m">433&lt;/span> &lt;span class="m">830&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sleep &lt;span class="m">5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 完成点击后停止APP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> am force-stop com.alibaba.android.rimet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> send_msg &lt;span class="s2">&amp;#34;签到完成&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> send_msg &lt;span class="s2">&amp;#34;节假日不用签到&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">exit&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>搞定！&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/saas/">SaaS</category></item><item><title>Send Email When New Mailgun Messages Fail Delivery</title><link>https://blog.ferstar.org/post/send-email-when-new-mailgun-messages-fail-delivery/</link><guid isPermaLink="true">https://blog.ferstar.org/post/send-email-when-new-mailgun-messages-fail-delivery/</guid><pubDate>Fri, 20 Jul 2018 15:06:26 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>SaaS 服务用着就是舒服，更换 Mailgun 后邮件投送率大大提高，不过还是有漏网之鱼，比如网易企业邮箱，会标记垃圾邮件拒收，没办法必须给上个发送失败的通知了 。&lt;/p>
&lt;p>通过几个 SaaS 服务组合来完成这个需求：&lt;/p>
&lt;ol>
&lt;li>Mailgun webhook&lt;/li>
&lt;li>Zapier Zaps&lt;/li>
&lt;li>IFTTT webhook&lt;/li>
&lt;li>Telegram Group Message&lt;/li>
&lt;/ol>
&lt;p>最终效果是如果信件被拒收会受到一封电报消息，如图：&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/jpg/2018/7/908e33b33c9229b67fa7200786af69f2.jpg" alt="效果图">&lt;/p>
&lt;p>实施步骤：&lt;/p>
&lt;p>Mailgun Webhooks：&lt;a href="https://app.mailgun.com/app/webhooks">https://app.mailgun.com/app/webhooks&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/png/2018/7/4d2f5ed1c682031b72d72504c913578e.png" alt="mailgun">&lt;/p>
&lt;p>Zapier integrations：&lt;a href="https://zapier.com/apps/mailgun/integrations">https://zapier.com/apps/mailgun/integrations&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/png/2018/7/f1d1df86d861f83e307ae7cd6bc79c98.png" alt="zapier">&lt;/p>
&lt;p>IFTTT：&lt;a href="https://ifttt.com/maker_webhooks">https://ifttt.com/maker_webhooks&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/png/2018/7/01aeb6e3e7fdc6ae1a1efbbc3c69dacc.png" alt="ifttt">&lt;/p>
&lt;p>Telegram Bot：IFTTT&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/png/2018/7/8d6d50ca797209341f06396fa6e06961.png" alt="notification">&lt;/p>
&lt;p>美中不足的是 Zapier 免费版每月仅能触发100次，不过暂时也够了，被拒收的情况很少。&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/saas/">SaaS</category></item><item><title>Load() or ReadRDS()?</title><link>https://blog.ferstar.org/post/load-or-readrds/</link><guid isPermaLink="true">https://blog.ferstar.org/post/load-or-readrds/</guid><pubDate>Fri, 20 Jul 2018 14:40:19 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>最近做的项目，需要从用户手里拿到一个 R 对象文件，姑且叫 out.rdata，后台要从这个 out.rdata 中取出一个叫 fuck 的对象。原来一直是用&lt;code>load('out.rdata')&lt;/code>这种方式加载，没发现问题，直到昨天发现一个报错的记录：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">Error in load&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;out.rdata&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span> :
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> bad restore file magic number &lt;span class="o">(&lt;/span>file may be corrupted&lt;span class="o">)&lt;/span> -- no data loaded
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">In addition: Warning message:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">file ‘seurat.rdata’ has magic number &lt;span class="s1">&amp;#39;X&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Use of save versions prior to &lt;span class="m">2&lt;/span> is deprecated
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Execution halted
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>放狗一搜，发现这篇文章：&lt;/p>
&lt;p>&lt;a href="https://yihui.name/en/2017/12/save-vs-saverds/">https://yihui.name/en/2017/12/save-vs-saverds/&lt;/a>&lt;/p>
&lt;p>猜测可能用户是用&lt;code>saveRDS()&lt;/code>方法保存的数据，于是对应的，用&lt;code>readRDS()&lt;/code>加载就正常了。&lt;/p>
&lt;p>但谁知道用户爸爸哪天心情好又换&lt;code>save()&lt;/code>存咋办？&lt;/p>
&lt;p>所以需要做个判断：如果是&lt;code>save()&lt;/code>保存的数据，用&lt;code>load()&lt;/code>；如果是&lt;code>saveRDS()&lt;/code>保存的，则用&lt;code>readRDS()&lt;/code>。&lt;/p>
&lt;p>那么问题来了，怎么判断&lt;code>*.rdata&lt;/code>的保存方式方法？&lt;/p>
&lt;p>继续放狗，未果&lt;/p>
&lt;p>换思路，Try...Catch 之：先&lt;code>load()&lt;/code>扑街了再用&lt;code>readRDS()&lt;/code>，代码如下：&lt;/p>
&lt;p>R 的&lt;code>tryCatch&lt;/code>写起来好丑陋。。。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-R" data-lang="R">&lt;span class="line">&lt;span class="cl">&lt;span class="nf">library&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stringr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">loadFuck&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nf">function&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">out&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nf">tryCatch&lt;/span>&lt;span class="p">({&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 大佬建议用 attach&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">attach&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">$&lt;/span>&lt;span class="n">fuck&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span> &lt;span class="n">warning&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">function&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 这里扑街提示是 warning&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">return&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nf">readRDS&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span> &lt;span class="n">error&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">function&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 真扑街那没办法，停车报警&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">stop&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#39;cannot load R object&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span> &lt;span class="n">finally&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># attach 完了打扫现场&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">paste&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;file&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">fp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sep&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;:&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">detach&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">character.only&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">TRUE&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">return&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">out&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">fuck&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nf">loadFuck&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#39;out.rdata&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>搞定！&lt;/p>
&lt;p>贴个参考文章的好评论&lt;/p>
&lt;blockquote>
&lt;p>Great post! If you really want to use &lt;code>save()&lt;/code> and then want load it back, use &lt;code>attach()&lt;/code> instead of &lt;code>load()&lt;/code>. The former will warn you about overwriting. Also you can unload it with &lt;code>detach(&amp;quot;file:foo.RData&amp;quot;)&lt;/code>.&lt;/p>
&lt;/blockquote></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/r/">R</category></item><item><title>利用 Tasker 打造最强自动签到神器</title><link>https://blog.ferstar.org/post/use-tasker-do-some-funny-things/</link><guid isPermaLink="true">https://blog.ferstar.org/post/use-tasker-do-some-funny-things/</guid><pubDate>Mon, 09 Jul 2018 13:39:42 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>本文不适合小白用户操作，搞机有风险，入坑须谨慎！&lt;/p>
&lt;/blockquote>
&lt;p>Android 上的 Tasker 绝对称得上是 Android 系统的神器之一， 可以完成很复杂多样的自定义任务。这里介绍一下利用他完成某 APP 自动签到的过程。&lt;/p>
&lt;h3 id="思路">思路&lt;/h3>
&lt;p>保证手机正常联网，通过USB调试做以下步骤：&lt;/p>
&lt;ol>
&lt;li>解锁屏幕进入桌面&lt;/li>
&lt;li>打开签到 APP&lt;/li>
&lt;li>模拟点击 APP 中签到按钮&lt;/li>
&lt;li>退出签到 APP&lt;/li>
&lt;li>锁屏&lt;/li>
&lt;/ol>
&lt;h3 id="准备">准备&lt;/h3>
&lt;ol>
&lt;li>能够安装 Magisk 的安卓手机一部&lt;/li>
&lt;li>安装 Magisk 模块：ADB &amp;amp; Fastboot for Android NDK，Busybox for Android NDK&lt;/li>
&lt;li>安装 APP：终端模拟器，RE文件管理器，Tasker，Secure Settings&lt;/li>
&lt;li>装有 adb tools 及 Git for Windows 的 PC 一台(用来计算模拟点击坐标)&lt;/li>
&lt;li>打开手机 USB 调试模式，并允许通过 USB 调试模拟点击&lt;/li>
&lt;li>&lt;strong>保证Tasker，Secure Settings后台常驻&lt;/strong> -- 非常重要！！！&lt;/li>
&lt;/ol>
&lt;h3 id="唤醒屏幕">唤醒屏幕&lt;/h3>
&lt;p>在进行模拟点击前，必须保证手机屏幕是唤醒状态，不然点了也没用。网上很多人说的采用&lt;code>adb shell input keyevent 26&lt;/code>这种方法只有在亮屏时有用，相当于按下一次电源键，但熄屏状态并不起作用，所以我采用另一种办法：通过Tasker调用Secure Settings唤醒屏幕。&lt;/p>
&lt;p>具体做法是&lt;/p>
&lt;ol>
&lt;li>打开Secure Settings然后 &lt;code>enable System+ Modul&lt;/code>&lt;/li>
&lt;li>打开Tasker -&amp;gt; 任务 -&amp;gt; 新建任务 -&amp;gt; 插件 -&amp;gt; Secure Settings -&amp;gt; 配置 -&amp;gt; Actions -&amp;gt; Wake Device&lt;/li>
&lt;li>&lt;strong>手机系统设置中找到设备管理器，激活 Secure Settings&lt;/strong>&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>测试：可以在 Tasker 中设定一个延时任务测试下，比如延时三秒后亮屏&lt;/p>
&lt;/blockquote>
&lt;h3 id="滑动解锁">滑动解锁&lt;/h3>
&lt;p>亮屏后默认是系统的锁屏界面，简单起见，我已经把手机解锁密码去掉，只剩下滑动锁。滑动解锁处理起来比较容易，&lt;code>adb shell input swipe x1 y1 x2 y2&lt;/code>即可，所以我们需要定起始和终止两个坐标点，来模拟滑动，继续往下看。&lt;/p>
&lt;h3 id="获得屏幕点击的位置坐标">获得屏幕点击的位置坐标&lt;/h3>
&lt;p>此方法比较土，但胜在只要有adb tools就能用，不需要别的东西。&lt;/p>
&lt;h4 id="计算比例">计算比例&lt;/h4>
&lt;p>通过命令&lt;code>adb shell getevent -p | grep -e &amp;quot;0035&amp;quot; -e &amp;quot;0036&amp;quot;&lt;/code>获得&lt;code>event&lt;/code>体系里宽和高&lt;/p>
&lt;p>我的手机输出如下信息：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="m">0035&lt;/span> : value 0, min 0, max 1080, fuzz 0, flat 0, resolution &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">0036&lt;/span> : value 0, min 0, max 2248, fuzz 0, flat 0, resolution &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>我们需要的就是其中的 max&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="m">0035&lt;/span> max &lt;span class="m">1080&lt;/span> 宽
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">0036&lt;/span> max &lt;span class="m">2248&lt;/span> 高
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>手机分辨率是已知的，我手机是：1080 x 2248&lt;/p>
&lt;p>计算比例：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">rateW&lt;/span> &lt;span class="o">=&lt;/span> 1080&lt;span class="o">(&lt;/span>手机屏幕的宽&lt;span class="o">)&lt;/span> / 1080&lt;span class="o">(&lt;/span>event里0035的max&lt;span class="o">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">rateH&lt;/span> &lt;span class="o">=&lt;/span> 1920&lt;span class="o">(&lt;/span>手机屏幕的高&lt;span class="o">)&lt;/span> / 2248&lt;span class="o">(&lt;/span>event里0036的max&lt;span class="o">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="计算点击位置坐标">计算点击位置坐标&lt;/h4>
&lt;p>执行命令&lt;code>adb shell getevent | grep -e &amp;quot;0035&amp;quot; -e &amp;quot;0036&amp;quot;&lt;/code>&lt;/p>
&lt;p>输出如下信息：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">/dev/input/event3: &lt;span class="m">0003&lt;/span> &lt;span class="m">0035&lt;/span> &lt;span class="m">00000430&lt;/span> width
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/dev/input/event3: &lt;span class="m">0003&lt;/span> &lt;span class="m">0036&lt;/span> 000005b1 height
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>把0035和0036后面的位置数据从16进制转化为10进制，祭出 Windows10 自带计算器，选程序员转换之得到十进制坐标为：(1072, 1457)&lt;/p>
&lt;p>这是在&lt;code>event&lt;/code>体系里的位置，将其转化为屏幕位置&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">screenW&lt;/span> &lt;span class="o">=&lt;/span> width*rateW &lt;span class="o">=&lt;/span> 1072*1 &lt;span class="o">=&lt;/span> &lt;span class="m">1072&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">screenH&lt;/span> &lt;span class="o">=&lt;/span> height*rateH &lt;span class="o">=&lt;/span> 1457*1 &lt;span class="o">=&lt;/span> &lt;span class="m">1457&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>所以得到刚才点击的屏幕坐标位置是(1072, 1457)&lt;/p>
&lt;h3 id="自己adb调试自己">自己adb调试自己&lt;/h3>
&lt;p>一般我们是在 PC 端利用 adb 调试安卓手机，但实际上安卓自己也可以调试自己，这样可以只用手机就完成模拟点击操作，不需要电脑的帮助。还记得准备工作要求的安装 ADB &amp;amp; Fastboot for Android NDK，Busybox for Android NDK 这个 Magisk 模块么？就是来干这个的。&lt;/p>
&lt;p>打开终端模拟器，输入代码：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">su &lt;span class="m">2000&lt;/span> -c &lt;span class="s1">&amp;#39;setprop service.adb.tcp.port 5555&amp;#39;&lt;/span> &lt;span class="c1"># 开启USB网络调试&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">su -c &lt;span class="s1">&amp;#39;stop adbd &amp;amp;&amp;amp; start adbd&amp;#39;&lt;/span> &lt;span class="c1"># 重启USB调试服务&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">adb connect localhost:5555 &lt;span class="c1"># 启动adb，接通本机5555端口&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>出来弹窗选择信任即可&lt;/p>
&lt;h3 id="打开签到-app">打开签到 APP&lt;/h3>
&lt;p>这一步你当然可以通过模拟点击来打开相应 APP 来进行后续的操作，但这要求你手机解锁开屏后不能有别的 APP 占据屏幕，否则点击就乱套。这里我采用的是&lt;code>am start -n ｛包(package)名｝/｛包名｝.{活动(activity)名称}&lt;/code>方法，APP 包名一般都能在对应的市场比如酷安应用详情中看到，钉钉的包名是&lt;code>com.alibaba.android.rimet &lt;/code>。那么如何知道 APP 的 activity 名称呢？继续往下看。&lt;/p>
&lt;h3 id="快速获取当前activity类名">快速获取当前Activity类名&lt;/h3>
&lt;p>据说有个叫&lt;code>re-sign.jar&lt;/code>的小工具可以干这个，但我这里总是报OOM的错，懒得深究，直接上 adb 敲如下命令&lt;/p>
&lt;p>&lt;code>adb shell dumpsys activity activities | findstr &amp;quot;应用包名&amp;quot; &lt;/code>，输入之后信息会有很多，过滤一下，主要找&lt;code>包名.&lt;/code>开头的，比如钉钉是&lt;code>com.alibaba.android.rimet.ui.activity.StartActivity&lt;/code>（版本不同可能会有差异，需要自己琢磨），找到后用如下命令启动 APP：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">am start -n com.alibaba.android.rimet/com.alibaba.android.rimet.ui.activity.StartActivity
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>打开 APP 后模拟点击完签到流程，最后退出&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">am force-stop com.alibaba.android.rimet
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="熄屏">熄屏&lt;/h3>
&lt;p>屏幕老亮着太费电，还是关了的好，有两种方法&lt;/p>
&lt;ol>
&lt;li>&lt;code>adb shell input keyevent 26&lt;/code> 相当于按电源键&lt;/li>
&lt;li>Tasker 调用 Secure Settings 插件，选择 Lock Device（步骤类似&lt;a href="https://blog.ferstar.org/post/use-tasker-do-some-funny-things/#%E5%94%A4%E9%86%92%E5%B1%8F%E5%B9%95">唤醒屏幕&lt;/a>）&lt;/li>
&lt;/ol>
&lt;h3 id="只在工作日签到">只在工作日签到&lt;/h3>
&lt;p>Tasker 自带的定时功能并不能满足这个需求，我们需要借助第三方 API 接口来判断当天是否为工作日，是工作日才签到。类似的第三方接口很多，有开发能力的机油甚至可以自己写，这里我用的是&lt;a href="http://tool.bitefu.net/jiari/">免费节假日API&lt;/a>提供的接口。&lt;/p>
&lt;p>整个自动签到脚本内容如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/system/bin/sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>&lt;span class="c1"># file: auto_login&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 具体坐标及延时请视自己手机而定，不要照搬&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查询当天是否为工作日&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 0 - 工作日，1 - 假日，2 - 节日&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">DAY&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>curl -s http://tool.bitefu.net/jiari/?d&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>date +%Y%m%d&lt;span class="k">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 只有工作日才签到&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">DAY&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="nv">x&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;0x&amp;#39;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 延时一秒再模拟滑动解锁&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sleep &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> adb shell input swipe &lt;span class="m">538&lt;/span> &lt;span class="m">1033&lt;/span> &lt;span class="m">555&lt;/span> &lt;span class="m">536&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 延时三秒再打开APP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sleep &lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> am start -n com.alibaba.android.rimet/com.alibaba.android.rimet.ui.activity.StartActivity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 视手机性能及网络影响，APP完全打开需要一定时间，所以延时最好多延几秒&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sleep &lt;span class="m">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 模拟点击签到按钮&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> adb shell input tap &lt;span class="m">133&lt;/span> &lt;span class="m">730&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sleep &lt;span class="m">5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> adb shell input tap &lt;span class="m">433&lt;/span> &lt;span class="m">830&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sleep &lt;span class="m">5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 完成点击后停止APP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> am force-stop com.alibaba.android.rimet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">exit&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="all-in">ALL IN&lt;/h3>
&lt;p>使用 RE 管理器将上述&lt;code>auto_login&lt;/code>移动到&lt;code>/system/xbin/&lt;/code>目录下，改可执行权限。剩下的操作均在 Tasker 应用中完成：&lt;/p>
&lt;ol>
&lt;li>新建配置文件，时间选每天上下班时间，关联任务名字随便取&lt;/li>
&lt;li>唤醒屏幕前最好随机睡段时间（睡多久自己把控）&lt;/li>
&lt;li>唤醒屏幕&lt;/li>
&lt;li>调用&lt;code>auto_login&lt;/code>脚本完成签到流程&lt;/li>
&lt;li>锁屏&lt;/li>
&lt;/ol>
&lt;p>&lt;strong>懒人福利&lt;/strong>：Tasker 配置文件(复制保存为xml后缀文件，可直接在应用内导入还原)：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;span class="lnt">76
&lt;/span>&lt;span class="lnt">77
&lt;/span>&lt;span class="lnt">78
&lt;/span>&lt;span class="lnt">79
&lt;/span>&lt;span class="lnt">80
&lt;/span>&lt;span class="lnt">81
&lt;/span>&lt;span class="lnt">82
&lt;/span>&lt;span class="lnt">83
&lt;/span>&lt;span class="lnt">84
&lt;/span>&lt;span class="lnt">85
&lt;/span>&lt;span class="lnt">86
&lt;/span>&lt;span class="lnt">87
&lt;/span>&lt;span class="lnt">88
&lt;/span>&lt;span class="lnt">89
&lt;/span>&lt;span class="lnt">90
&lt;/span>&lt;span class="lnt">91
&lt;/span>&lt;span class="lnt">92
&lt;/span>&lt;span class="lnt">93
&lt;/span>&lt;span class="lnt">94
&lt;/span>&lt;span class="lnt">95
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;TaskerData&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="na">dvi=&lt;/span>&lt;span class="s">&amp;#34;1&amp;#34;&lt;/span> &lt;span class="na">tv=&lt;/span>&lt;span class="s">&amp;#34;5.0u7m&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Profile&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;prof8&amp;#34;&lt;/span> &lt;span class="na">ve=&lt;/span>&lt;span class="s">&amp;#34;2&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;cdate&amp;gt;&lt;/span>1531101968896&lt;span class="nt">&amp;lt;/cdate&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;edate&amp;gt;&lt;/span>1531122746414&lt;span class="nt">&amp;lt;/edate&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;id&amp;gt;&lt;/span>8&lt;span class="nt">&amp;lt;/id&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;mid0&amp;gt;&lt;/span>6&lt;span class="nt">&amp;lt;/mid0&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;nme&amp;gt;&lt;/span>上班&lt;span class="nt">&amp;lt;/nme&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Time&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;con0&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;fh&amp;gt;&lt;/span>8&lt;span class="nt">&amp;lt;/fh&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;fm&amp;gt;&lt;/span>16&lt;span class="nt">&amp;lt;/fm&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;th&amp;gt;&lt;/span>-1&lt;span class="nt">&amp;lt;/th&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;tm&amp;gt;&lt;/span>-1&lt;span class="nt">&amp;lt;/tm&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;/Time&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;/Profile&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Task&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;task6&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;cdate&amp;gt;&lt;/span>1531100883059&lt;span class="nt">&amp;lt;/cdate&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;edate&amp;gt;&lt;/span>1531122706060&lt;span class="nt">&amp;lt;/edate&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;id&amp;gt;&lt;/span>6&lt;span class="nt">&amp;lt;/id&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;nme&amp;gt;&lt;/span>自动流程&lt;span class="nt">&amp;lt;/nme&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;pri&amp;gt;&lt;/span>100&lt;span class="nt">&amp;lt;/pri&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Action&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;act0&amp;#34;&lt;/span> &lt;span class="na">ve=&lt;/span>&lt;span class="s">&amp;#34;7&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;code&amp;gt;&lt;/span>545&lt;span class="nt">&amp;lt;/code&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Str&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;arg0&amp;#34;&lt;/span> &lt;span class="na">ve=&lt;/span>&lt;span class="s">&amp;#34;3&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>%SLEEP_TIME&lt;span class="nt">&amp;lt;/Str&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Int&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;arg1&amp;#34;&lt;/span> &lt;span class="na">val=&lt;/span>&lt;span class="s">&amp;#34;3&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Int&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;arg2&amp;#34;&lt;/span> &lt;span class="na">val=&lt;/span>&lt;span class="s">&amp;#34;180&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;/Action&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Action&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;act1&amp;#34;&lt;/span> &lt;span class="na">ve=&lt;/span>&lt;span class="s">&amp;#34;7&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;code&amp;gt;&lt;/span>123&lt;span class="nt">&amp;lt;/code&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Str&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;arg0&amp;#34;&lt;/span> &lt;span class="na">ve=&lt;/span>&lt;span class="s">&amp;#34;3&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>sleep %SLEEP_TIME&lt;span class="nt">&amp;lt;/Str&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Int&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;arg1&amp;#34;&lt;/span> &lt;span class="na">val=&lt;/span>&lt;span class="s">&amp;#34;0&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Int&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;arg2&amp;#34;&lt;/span> &lt;span class="na">val=&lt;/span>&lt;span class="s">&amp;#34;1&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Str&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;arg3&amp;#34;&lt;/span> &lt;span class="na">ve=&lt;/span>&lt;span class="s">&amp;#34;3&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Str&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;arg4&amp;#34;&lt;/span> &lt;span class="na">ve=&lt;/span>&lt;span class="s">&amp;#34;3&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Str&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;arg5&amp;#34;&lt;/span> &lt;span class="na">ve=&lt;/span>&lt;span class="s">&amp;#34;3&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;ConditionList&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;if&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Condition&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;c0&amp;#34;&lt;/span> &lt;span class="na">ve=&lt;/span>&lt;span class="s">&amp;#34;3&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;lhs&amp;gt;&lt;/span>%SLEEP_TIME&lt;span class="nt">&amp;lt;/lhs&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;op&amp;gt;&lt;/span>12&lt;span class="nt">&amp;lt;/op&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;rhs&amp;gt;&amp;lt;/rhs&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;/Condition&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;/ConditionList&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;/Action&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Action&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;act2&amp;#34;&lt;/span> &lt;span class="na">ve=&lt;/span>&lt;span class="s">&amp;#34;7&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;code&amp;gt;&lt;/span>1563799945&lt;span class="nt">&amp;lt;/code&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Bundle&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;arg0&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Vals&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;val&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;com.intangibleobject.securesettings.plugin.extra.BLURB&amp;gt;&lt;/span>Screen &lt;span class="ni">&amp;amp;amp;&lt;/span> Keyboard Lights On
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1 Second&lt;span class="nt">&amp;lt;/com.intangibleobject.securesettings.plugin.extra.BLURB&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;com.intangibleobject.securesettings.plugin.extra.BLURB-type&amp;gt;&lt;/span>java.lang.String&lt;span class="nt">&amp;lt;/com.intangibleobject.securesettings.plugin.extra.BLURB-type&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;com.intangibleobject.securesettings.plugin.extra.SETTING&amp;gt;&lt;/span>wake_device&lt;span class="nt">&amp;lt;/com.intangibleobject.securesettings.plugin.extra.SETTING&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;com.intangibleobject.securesettings.plugin.extra.SETTING-type&amp;gt;&lt;/span>java.lang.String&lt;span class="nt">&amp;lt;/com.intangibleobject.securesettings.plugin.extra.SETTING-type&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;com.intangibleobject.securesettings.plugin.extra.WAKE_LOCK_DURATION&amp;gt;&lt;/span>1000&lt;span class="nt">&amp;lt;/com.intangibleobject.securesettings.plugin.extra.WAKE_LOCK_DURATION&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;com.intangibleobject.securesettings.plugin.extra.WAKE_LOCK_DURATION-type&amp;gt;&lt;/span>java.lang.Long&lt;span class="nt">&amp;lt;/com.intangibleobject.securesettings.plugin.extra.WAKE_LOCK_DURATION-type&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;com.intangibleobject.securesettings.plugin.extra.WAKE_LOCK_TYPE&amp;gt;&lt;/span>full&lt;span class="nt">&amp;lt;/com.intangibleobject.securesettings.plugin.extra.WAKE_LOCK_TYPE&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;com.intangibleobject.securesettings.plugin.extra.WAKE_LOCK_TYPE-type&amp;gt;&lt;/span>java.lang.String&lt;span class="nt">&amp;lt;/com.intangibleobject.securesettings.plugin.extra.WAKE_LOCK_TYPE-type&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;com.twofortyfouram.locale.intent.extra.BLURB&amp;gt;&lt;/span>Screen &lt;span class="ni">&amp;amp;amp;&lt;/span> Keyboard Lights On
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1 Second&lt;span class="nt">&amp;lt;/com.twofortyfouram.locale.intent.extra.BLURB&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;com.twofortyfouram.locale.intent.extra.BLURB-type&amp;gt;&lt;/span>java.lang.String&lt;span class="nt">&amp;lt;/com.twofortyfouram.locale.intent.extra.BLURB-type&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;net.dinglisch.android.tasker.subbundled&amp;gt;&lt;/span>true&lt;span class="nt">&amp;lt;/net.dinglisch.android.tasker.subbundled&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;net.dinglisch.android.tasker.subbundled-type&amp;gt;&lt;/span>java.lang.Boolean&lt;span class="nt">&amp;lt;/net.dinglisch.android.tasker.subbundled-type&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;/Vals&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;/Bundle&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Str&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;arg1&amp;#34;&lt;/span> &lt;span class="na">ve=&lt;/span>&lt;span class="s">&amp;#34;3&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>com.intangibleobject.securesettings.plugin&lt;span class="nt">&amp;lt;/Str&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Str&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;arg2&amp;#34;&lt;/span> &lt;span class="na">ve=&lt;/span>&lt;span class="s">&amp;#34;3&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>com.intangibleobject.securesettings.plugin.Activities.TabsActivity&lt;span class="nt">&amp;lt;/Str&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Int&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;arg3&amp;#34;&lt;/span> &lt;span class="na">val=&lt;/span>&lt;span class="s">&amp;#34;0&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;/Action&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Action&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;act3&amp;#34;&lt;/span> &lt;span class="na">ve=&lt;/span>&lt;span class="s">&amp;#34;7&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;code&amp;gt;&lt;/span>123&lt;span class="nt">&amp;lt;/code&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Str&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;arg0&amp;#34;&lt;/span> &lt;span class="na">ve=&lt;/span>&lt;span class="s">&amp;#34;3&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>auto_login&lt;span class="nt">&amp;lt;/Str&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Int&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;arg1&amp;#34;&lt;/span> &lt;span class="na">val=&lt;/span>&lt;span class="s">&amp;#34;0&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Int&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;arg2&amp;#34;&lt;/span> &lt;span class="na">val=&lt;/span>&lt;span class="s">&amp;#34;1&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Str&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;arg3&amp;#34;&lt;/span> &lt;span class="na">ve=&lt;/span>&lt;span class="s">&amp;#34;3&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Str&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;arg4&amp;#34;&lt;/span> &lt;span class="na">ve=&lt;/span>&lt;span class="s">&amp;#34;3&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Str&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;arg5&amp;#34;&lt;/span> &lt;span class="na">ve=&lt;/span>&lt;span class="s">&amp;#34;3&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;/Action&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Action&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;act4&amp;#34;&lt;/span> &lt;span class="na">ve=&lt;/span>&lt;span class="s">&amp;#34;7&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;code&amp;gt;&lt;/span>1563799945&lt;span class="nt">&amp;lt;/code&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Bundle&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;arg0&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Vals&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;val&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;com.intangibleobject.securesettings.plugin.extra.BLURB&amp;gt;&lt;/span>Lock Device&lt;span class="nt">&amp;lt;/com.intangibleobject.securesettings.plugin.extra.BLURB&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;com.intangibleobject.securesettings.plugin.extra.BLURB-type&amp;gt;&lt;/span>java.lang.String&lt;span class="nt">&amp;lt;/com.intangibleobject.securesettings.plugin.extra.BLURB-type&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;com.intangibleobject.securesettings.plugin.extra.SETTING&amp;gt;&lt;/span>force_lock&lt;span class="nt">&amp;lt;/com.intangibleobject.securesettings.plugin.extra.SETTING&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;com.intangibleobject.securesettings.plugin.extra.SETTING-type&amp;gt;&lt;/span>java.lang.String&lt;span class="nt">&amp;lt;/com.intangibleobject.securesettings.plugin.extra.SETTING-type&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;com.twofortyfouram.locale.intent.extra.BLURB&amp;gt;&lt;/span>Lock Device&lt;span class="nt">&amp;lt;/com.twofortyfouram.locale.intent.extra.BLURB&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;com.twofortyfouram.locale.intent.extra.BLURB-type&amp;gt;&lt;/span>java.lang.String&lt;span class="nt">&amp;lt;/com.twofortyfouram.locale.intent.extra.BLURB-type&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;net.dinglisch.android.tasker.subbundled&amp;gt;&lt;/span>true&lt;span class="nt">&amp;lt;/net.dinglisch.android.tasker.subbundled&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;net.dinglisch.android.tasker.subbundled-type&amp;gt;&lt;/span>java.lang.Boolean&lt;span class="nt">&amp;lt;/net.dinglisch.android.tasker.subbundled-type&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;/Vals&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;/Bundle&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Str&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;arg1&amp;#34;&lt;/span> &lt;span class="na">ve=&lt;/span>&lt;span class="s">&amp;#34;3&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>com.intangibleobject.securesettings.plugin&lt;span class="nt">&amp;lt;/Str&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Str&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;arg2&amp;#34;&lt;/span> &lt;span class="na">ve=&lt;/span>&lt;span class="s">&amp;#34;3&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>com.intangibleobject.securesettings.plugin.Activities.TabsActivity&lt;span class="nt">&amp;lt;/Str&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;Int&lt;/span> &lt;span class="na">sr=&lt;/span>&lt;span class="s">&amp;#34;arg3&amp;#34;&lt;/span> &lt;span class="na">val=&lt;/span>&lt;span class="s">&amp;#34;0&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;/Action&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;/Task&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;/TaskerData&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="参考">参考&lt;/h3>
&lt;ol>
&lt;li>&lt;a href="https://android.stackexchange.com/questions/142533/run-adb-command-inside-the-terminal-emulator-or-programmatically-without-root">Run adb command inside the terminal emulator or programmatically without root&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.csdn.net/wugang8023/article/details/39941659">使用工具re-sign.jar获取android的包名和主类名&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.csdn.net/u012041204/article/details/53957664">Android使用ADB启动应用程序&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://tool.bitefu.net/jiari/">免费节假日API&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.csdn.net/android_cmos/article/details/73382573">Android快速获取当前Activity类名的三种方法&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.csdn.net/liu_zhen_wei/article/details/12559277">Android adb shell 获得点击屏幕的位置坐标&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://tasker.joaoapps.com/guides.html">Tasker FAQ&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://forum.xda-developers.com/apps/magisk">Magisk - The Universal Systemless Interface, to create an altered mask of the system without changing the system itself.&lt;/a>&lt;/li>
&lt;/ol></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/android/">Android</category></item><item><title>修复升级BIOS导致grub意外丢失的问题</title><link>https://blog.ferstar.org/post/grub2-rescue/</link><guid isPermaLink="true">https://blog.ferstar.org/post/grub2-rescue/</guid><pubDate>Mon, 02 Jul 2018 17:43:32 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>给老本子（x220）升 BIOS 后不知为何直接 Grub 给搞挂了，怎一个蛋疼了得。所幸折腾一通安全找回，记录下过程：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 先看看/分区对不对&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">grub&amp;gt; &lt;span class="nb">echo&lt;/span> &lt;span class="nv">$root&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hd1, gpt2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 没毛病，是第二块盘的第二个分区&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 看看磁盘分区状况&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 双硬盘，hd0装的Windows10，hd1装的ubuntu 16.04&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">grub&amp;gt; ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>hd0&lt;span class="o">)&lt;/span> &lt;span class="o">(&lt;/span>hd0, gpt7&lt;span class="o">)&lt;/span> ... &lt;span class="o">(&lt;/span>hd1, gpt2&lt;span class="o">)&lt;/span> &lt;span class="o">(&lt;/span>hd1, gpt1&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 看看grub路径&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">grub&amp;gt; &lt;span class="nb">echo&lt;/span> &lt;span class="nv">$prefix&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 居然是空的，这样肯定没法加载normal模块&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 所以下一步就是设定这个 prefix 路径&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">grub&amp;gt; &lt;span class="nb">set&lt;/span> &lt;span class="nv">prefix&lt;/span>&lt;span class="o">=(&lt;/span>hd1,gpt2&lt;span class="o">)&lt;/span>/@/boot/grub
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># tab 补全这里是可以用的，很方便&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 设定完以后加载 normal 模块&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">grub&amp;gt; insmod normal
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 没报错，加载成功，接下来就启动 grub 菜单&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">grub&amp;gt; normal
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>先进 Ubuntu，打开 terminal 重新安装一下 grub&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">sudo grub-install /dev/sdb1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重启即恢复正常。&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>Add Delete Button in Django-tables2</title><link>https://blog.ferstar.org/post/add-delete-button-in-django-tables2/</link><guid isPermaLink="true">https://blog.ferstar.org/post/add-delete-button-in-django-tables2/</guid><pubDate>Fri, 29 Jun 2018 11:09:59 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>这是用 &lt;a href="https://django-tables2.readthedocs.io/en/latest/">django-tables2&lt;/a> 的另一个坑：如何给每行条目添加删除功能？&lt;/p>
&lt;p>还是直接上解决方案：在&lt;code>tables.py&lt;/code>加一列，用来放删除按钮，本来是打算直接给&lt;code>href&lt;/code>加个&lt;code>DELETE&lt;/code>的&lt;code>method&lt;/code>，然而发现&lt;code>HTML5&lt;/code>并不支持这样做，没办法只好捏造一个&lt;code>form&lt;/code>表单来做这事情了。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># samples/tables.py&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">django_tables2&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="nn">tables&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">.models&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">Sample&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">SampleTable&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tables&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Table&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 塞一个form进去，POST方法，加一个隐藏输入，命名为_method，通过这货的值来冒充DELETE方法&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 实际上还是一个POST请求，不过干的是DELETE的事情&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">delete&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tables&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">TemplateColumn&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;&amp;lt;form action=&amp;#34;/samples/{{record.id}}/&amp;#34; method=&amp;#34;post&amp;#34;&amp;gt;{&lt;/span>&lt;span class="si">% c&lt;/span>&lt;span class="s1">srf_token %}&amp;lt;input type=&amp;#34;hidden&amp;#34; name=&amp;#34;_method&amp;#34; value=&amp;#34;delete&amp;#34;&amp;gt;&amp;lt;button data-toggle=&amp;#34;tooltip&amp;#34; title=&amp;#34;Please note that deletion cannot be undone&amp;#34; type=&amp;#34;submit&amp;#34; class=&amp;#34;btn btn-danger btn-xs&amp;#34;&amp;gt;delete&amp;lt;/button&amp;gt;&amp;lt;/form&amp;gt;&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">orderable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">False&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">verbose_name&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">class&lt;/span> &lt;span class="nc">Meta&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">model&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Sample&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">fields&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;name&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;...&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;delete&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;...&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># 这里控制要显示的字段&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">template_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;django_tables2/bootstrap.html&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>DELETE&lt;/code>方法有了，自然需要搞个路由&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># samples/urls.py&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">django.urls&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">path&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">.&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">views&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">app_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;samples&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">urlpatterns&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">path&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">views&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;index&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">path&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;&amp;lt;uuid:sample_id&amp;gt;/&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">views&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">detail&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;detail&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>视图部分：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># samples/views.py&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 略去各种 import&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">index&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 各种验证（是否登录、合法）后，返回当前用户真正可以看到的数据（未标记为归档的部分）&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">render&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;samples/index.html&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">locals&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">detail&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sample_id&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">method&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;POST&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 找不到不处理&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sample&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Sample&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">objects&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">id&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">sample_id&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">HttpResponse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">status&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">404&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">data&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">POST&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">method&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">data&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;_method&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">lower&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">method&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;delete&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sample&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">has_archived&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">True&lt;/span> &lt;span class="c1"># 只添加归档标记，真的删除是不可能的，万一有用呢&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sample&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">save&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">redirect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;samples:index&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>效果如图：&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/jpg/2018/6/45e42b6a890cafda88510a096f8cf526.jpg" alt="add-delete-button">&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/django/">DJANGO</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>Add Bootstrap Tooltips in django-tables2</title><link>https://blog.ferstar.org/post/bootstrap-tooltips/</link><guid isPermaLink="true">https://blog.ferstar.org/post/bootstrap-tooltips/</guid><pubDate>Fri, 29 Jun 2018 10:06:55 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>最近用 Django 写一个内部项目，选用 &lt;a href="https://django-tables2.readthedocs.io/en/latest/">django-tables2&lt;/a> 做数据库表单页面展示非常方便，不过再方便，踩坑也是必不可少的。其中遇到的一个问题是有的列表内文字不能写太多，但需要给出比较详细的提示（鼠标悬停即显示详细提示内容）。虽然直接给加&lt;code>title&lt;/code>就行，但原生效果略丑，我需要跟 Bootstrap 主题样式一致，所以需要额外的一点工作。&lt;/p>
&lt;p>直接上解决方案：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># samples/tables.py&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">django_tables2&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="nn">tables&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">.models&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">Sample&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">SampleTable&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tables&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Table&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 添加报告链接&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 这个链接是根据样本完成状态与否自动生成&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 加个data-toggle的属性，将title内容变成提示框&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">report&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tables&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">TemplateColumn&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;{&lt;/span>&lt;span class="si">% i&lt;/span>&lt;span class="s1">f record.has_completed %}&amp;lt;a data-toggle=&amp;#34;tooltip&amp;#34; title=&amp;#34;It will take a few seconds to load the data, please be patient&amp;#34; href=&amp;#34;/samples/{{record.id}}/&amp;#34; target=&amp;#34;_blank&amp;#34;&amp;gt;Result link&amp;lt;/a&amp;gt; {&lt;/span>&lt;span class="si">% e&lt;/span>&lt;span class="s1">lse %}&amp;lt;i class=&amp;#34;fa fa-ellipsis-h&amp;#34;&amp;gt;&amp;lt;/i&amp;gt;{&lt;/span>&lt;span class="si">% e&lt;/span>&lt;span class="s1">ndif %}&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">verbose_name&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;View Result&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1"># 这个可以控制显示的列名，默认是数据库对应字段名&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">orderable&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">False&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># 拒绝排序&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">class&lt;/span> &lt;span class="nc">Meta&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">model&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Sample&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">fields&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;name&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;...&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;report&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;...&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># 这里控制要显示的字段&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">template_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;django_tables2/bootstrap.html&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>模板要加个自定义 js 的 block&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-html" data-lang="html">&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;lt;!-- templates/base.html --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&amp;lt;!DOCTYPE html&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">html&lt;/span> &lt;span class="na">lang&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;en-US&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">body&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {% block js %}{% endblock %}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">body&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">html&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>对应app(samples)的模板文件&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-html" data-lang="html">&lt;span class="line">&lt;span class="cl">{% extends &amp;#39;base.html&amp;#39; %}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">{% load staticfiles %}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">{% block title %}我爱北京天安门{% endblock %}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">{% load render_table from django_tables2 %}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">{% block content %}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">div&lt;/span> &lt;span class="na">class&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;container-fluid&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {% render_table table %}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">{% endblock %}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">{% block js %}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">script&lt;/span> &lt;span class="na">src&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;{% static &amp;#39;samples/js/index.js&amp;#39; %}&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&amp;lt;/&lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">{% endblock %}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在当前app(samples)目录下新建&lt;code>static/samples/js&lt;/code>目录，写入自定义js&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-javascript" data-lang="javascript">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// samples/static/samples/js/index.js
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">$&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">document&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">ready&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">function&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">$&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;[data-toggle=&amp;#34;tooltip&amp;#34;]&amp;#39;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">tooltip&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>效果如图：&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/jpg/2018/6/5c72ddc40df1977100b2b6b6440df9dd.jpg" alt="tooltips">&lt;/p>
&lt;p>咦，怎么还能加按钮？这个下回再说~&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/django/">DJANGO</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/bootstrap/">BOOTSTRAP</category></item><item><title>Epson Lq 630 Communicate Error</title><link>https://blog.ferstar.org/post/epson-lq-630-communicate-error/</link><guid isPermaLink="true">https://blog.ferstar.org/post/epson-lq-630-communicate-error/</guid><pubDate>Wed, 27 Jun 2018 17:28:52 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>早上去财务报销，出纳小妹针式打印机罢工，报了这么个错&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/png/2018/6/10241202527c1740882410421210ac11.png" alt="printer-error">&lt;/p>
&lt;p>于是顺手解决了下。&lt;/p>
&lt;ol>
&lt;li>
&lt;p>怀疑线缆问题，关机，重插拔线缆，开机，未果；&lt;/p>
&lt;/li>
&lt;li>
&lt;p>怀疑驱动问题，删除打印机驱动，重装，扑街；&lt;/p>
&lt;/li>
&lt;li>
&lt;p>怀疑 Windows 打印服务队列出问题，清空重置之，搞定。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">@echo&lt;/span> &lt;span class="n">off&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo &lt;/span>&lt;span class="n">Stopping&lt;/span> &lt;span class="n">print&lt;/span> &lt;span class="n">spooler&lt;/span>&lt;span class="p">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">echo&lt;/span>&lt;span class="p">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">net&lt;/span> &lt;span class="n">stop&lt;/span> &lt;span class="n">spooler&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo &lt;/span>&lt;span class="n">deleting&lt;/span> &lt;span class="n">temp&lt;/span> &lt;span class="n">files&lt;/span>&lt;span class="p">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">echo&lt;/span>&lt;span class="p">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">del &lt;/span>&lt;span class="k">%&lt;/span>&lt;span class="n">windir&lt;/span>&lt;span class="p">%\&lt;/span>&lt;span class="n">system32&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">spool&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">printers&lt;/span>&lt;span class="p">\*.*&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">q&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo &lt;/span>&lt;span class="n">Starting&lt;/span> &lt;span class="n">print&lt;/span> &lt;span class="n">spooler&lt;/span>&lt;span class="p">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">echo&lt;/span>&lt;span class="p">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">net&lt;/span> &lt;span class="nb">start &lt;/span>&lt;span class="n">spooler&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ol>
&lt;p>以上内容复制粘贴进新建文档中保存，重命名为任意以&lt;code>bat&lt;/code>为后缀的文件双击运行即可（Windows7及以上系统需要右键以管理员权限运行）&lt;/p>
&lt;p>打完单据，潇洒转身走人，深藏功与名~&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/windows/">WINDOWS</category></item><item><title>Django Development With Docker Compose and Machine</title><link>https://blog.ferstar.org/post/django-development-with-docker-compose-and-machine/</link><guid isPermaLink="true">https://blog.ferstar.org/post/django-development-with-docker-compose-and-machine/</guid><pubDate>Fri, 15 Jun 2018 14:53:16 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>这篇文章算是对近期将 Django Project 封装到 Docker Container 中的经验总结。&lt;/p>
&lt;p>灵感思路取自这篇文章：&lt;/p>
&lt;p>&lt;a href="https://realpython.com/django-development-with-docker-compose-and-machine/">https://realpython.com/django-development-with-docker-compose-and-machine/&lt;/a>&lt;/p>
&lt;p>但是又略有不同：主要是根据项目需要，把文章中的 nginx container 替换为了 Caddy container，方便做全站 HTTPS 加密；另外，也对用 PyCharm 开发调试封装在 Docker Container 中的 Django 应用做了一些探索实践。&lt;/p>
&lt;p>整个示例代码：https://github.com/ferstar/dockerizing-django&lt;/p>
&lt;h2 id="安装-docker-相关">安装 Docker 相关&lt;/h2>
&lt;p>我开发机是 Windows 平台，平时比较常用 VirtualBox，所以安装的是 &lt;a href="https://www.docker.com/products/docker-toolbox">Docker Toolbox&lt;/a> ，没有使用 Windows 自带的 Hyper-V 虚拟化方式。具体安装步骤很简单，根据官方说明一路 Next 即可。&lt;/p>
&lt;p>装好后看下输出：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ docker-machine version
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker-machine.exe version 0.14.0, build 89b8332
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ docker-compose version
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker-compose version 1.20.1, build 5d8c71b2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker-py version: 3.1.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">CPython version: 3.6.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">OpenSSL version: OpenSSL 1.0.2k &lt;span class="m">26&lt;/span> Jan &lt;span class="m">2017&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>你可能会遇到如下错误提示：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">exec: &lt;span class="s2">&amp;#34;docker-credential-wincred&amp;#34;&lt;/span>: executable file not found in %PATH%, out: &lt;span class="sb">``&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>解决方法是去 &lt;a href="https://github.com/docker/docker-credential-helpers/releases">https://github.com/docker/docker-credential-helpers/releases&lt;/a> 下载这货 &lt;strong>docker-credential-wincred-v0.6.0-amd64.zip&lt;/strong>，解压&lt;code>docker-credential-wincred.exe&lt;/code>到 Docker Toolbox 的目录下，一般是&lt;code>C:\Program Files\Docker Toolbox\&lt;/code> ，就 OK 了。&lt;/p>
&lt;p>接下来克隆我的示例代码&lt;/p>
&lt;p>&lt;code>git clone https://github.com/ferstar/dockerizing-django.git&lt;/code>&lt;/p>
&lt;p>整个目录结构应该是这样：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">│ .env
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ .gitignore
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ docker-compose.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ production.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ README.md
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├─caddy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ access.log
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ Caddyfile
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ Caddyfile_tls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">└─web
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │ Dockerfile
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │ manage.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │ requirements.txt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ├─docker_django
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │ │ settings.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │ │ urls.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │ │ wsgi.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │ │ __init__.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │ │
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │ └─apps
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │ │ __init__.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │ │
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │ └─todo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │ │ admin.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │ │ models.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │ │ tests.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │ │ urls.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │ │ views.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │ │ __init__.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │ │
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │ └─templates
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │ home.html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │ _base.html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ├─static
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │ main.css
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> └─tests
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> test_env_settings.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> __init__.py
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="在-pycharm-中开发调试">在 PyCharm 中开发调试&lt;/h2>
&lt;ol>
&lt;li>打开代码目录 - &lt;code>File -&amp;gt; Open -&amp;gt; dockerizing-django&lt;/code>&lt;/li>
&lt;li>配置 Docker - &lt;code>File -&amp;gt; Settings -&amp;gt; Build, Execution, Deployment -&amp;gt; Docker -&amp;gt; Tool[docker-machine, docker-compose]&lt;/code>&lt;/li>
&lt;li>配置 Project Interpreter - &lt;code>File -&amp;gt; Settings -&amp;gt; Project dockerizing-django -&amp;gt; Project Interpreter -&amp;gt; Add -&amp;gt; Docker Compose -&amp;gt; Service: web -&amp;gt; OK&lt;/code>&lt;/li>
&lt;li>配置 Build Docker Image - &lt;code>Run -&amp;gt; Edit Configurations -&amp;gt; + -&amp;gt; Docker -&amp;gt; Docker Compose -&amp;gt; Service(s): web -&amp;gt; OK&lt;/code>&lt;/li>
&lt;li>配置 RUN Configurations - &lt;code>Run -&amp;gt; Edit Configurations -&amp;gt; + -&amp;gt; Host: 0.0.0.0 -&amp;gt; OK&lt;/code>&lt;/li>
&lt;li>初始化数据库 - &lt;code>docker-compose run --no-deps --rm web python manage.py migrate&lt;/code>&lt;/li>
&lt;li>静态文件整理 - &lt;code>docker-compose run --no-deps --rm web python manage.py collectstatic&lt;/code>&lt;/li>
&lt;li>Build &amp;amp;&amp;amp; Run~ have fun!&lt;/li>
&lt;/ol>
&lt;p>没图貌似不行，配图见我的专栏文章 &lt;a href="https://zhuanlan.zhihu.com/p/38133078">https://zhuanlan.zhihu.com/p/38133078&lt;/a>&lt;/p>
&lt;p>&lt;em>生产环境配置只需要指明使用 production.yml 即 &lt;code>docker-compose -f production.yml xxx&lt;/code>&lt;/em>&lt;/p>
&lt;p>PS：项目中还用到了 RabbitMQ 管理队列服务，大概贴下 docker-compose.yml 内容（示例代码中没有涉及到）&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nn">...&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">rabbitmq&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">restart&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">always&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rabbitmq:3-management&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">container_name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">scs_rabbitmq&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">hostname&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rabbitmq&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">environment&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">RABBITMQ_ERLANG_COOKIE&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;WOWOWOWOWWOWOWOW&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">RABBITMQ_DEFAULT_USER&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;rabbitmq&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">RABBITMQ_DEFAULT_PASS&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;helloworld&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">RABBITMQ_DEFAULT_VHOST&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="m">15672&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="m">15672&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="m">5672&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="m">5672&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">rabbitmq:/var/lib/rabbitmq&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nn">...&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/docker/">DOCKER</category></item><item><title>Could Not Refresh Skeletons for Remote Interpreter</title><link>https://blog.ferstar.org/post/could-not-refresh-skeletons-for-remote-interpreter/</link><guid isPermaLink="true">https://blog.ferstar.org/post/could-not-refresh-skeletons-for-remote-interpreter/</guid><pubDate>Fri, 15 Jun 2018 09:50:15 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>不小心踢掉插线板，电脑非正常关机，重启后配好的 PyCharm + Docker + Django 开发环境居然起不来了，报错信息如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">Couldn&lt;span class="err">&amp;#39;&lt;/span>t refresh skeletons &lt;span class="k">for&lt;/span> remote interpreter
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> failed to run generator3.py &lt;span class="k">for&lt;/span> docker-compose://&lt;span class="o">[&lt;/span>C:&lt;span class="se">\U&lt;/span>sers&lt;span class="se">\s&lt;/span>cs_web&lt;span class="se">\s&lt;/span>cs_web&lt;span class="se">\d&lt;/span>ocker-compose.yml&lt;span class="o">]&lt;/span>:web/python, &lt;span class="nb">exit&lt;/span> code 1, stderr:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -----
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Starting scs_caddy ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Starting scs_caddy ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Starting scs_rabbitmq ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Starting scs_rabbitmq ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Starting scs_redis ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Starting scsweb_pycharm_helpers_1 ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Starting scs_redis ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Starting scs_pg ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Starting scs_pg ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Starting scsweb_pycharm_helpers_1 ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ERROR: &lt;span class="k">for&lt;/span> scsweb_pycharm_helpers_1 Cannot start service pycharm_helpers: network 6680faccddd938e1aca07de048da67ec918d1f44c34212c7fb28fa058cffd93d not found
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ERROR: &lt;span class="k">for&lt;/span> pycharm_helpers Cannot start service pycharm_helpers: network 6680faccddd938e1aca07de048da67ec918d1f44c34212c7fb28fa058cffd93d not found
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Encountered errors &lt;span class="k">while&lt;/span> bringing up the project.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -----
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>大意是找不到 pycharm_helpers 的 network，照例 Google 之，有人提供了解决思路：&lt;/p>
&lt;p>via -&amp;gt; &lt;a href="https://stackoverflow.com/a/49864937">https://stackoverflow.com/a/49864937&lt;/a>&lt;/p>
&lt;p>不过他说的可能环境变量配置有变动我这里并没有，所以就试试把所有 Container 干掉，结果果然有效。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 当然，只干掉有问题的 scsweb_pycharm_helpers_1 这个 container 就 OK，我懒得多查一步，直接全干掉&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker rm -f &lt;span class="k">$(&lt;/span>docker ps -a -q&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>回到 PyCharm 运行项目，嗯，一切正常了&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">Creating scs_redis ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Creating scs_pg ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Creating scsweb_pycharm_helpers_1 ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Creating scs_caddy ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Creating scs_rabbitmq ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Creating scs_web ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Attaching to scs_web
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">scs_web &lt;span class="p">|&lt;/span> Performing system checks...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">scs_web &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">scs_web &lt;span class="p">|&lt;/span> System check identified no issues &lt;span class="o">(&lt;/span>&lt;span class="m">0&lt;/span> silenced&lt;span class="o">)&lt;/span>.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">scs_web &lt;span class="p">|&lt;/span> June 15, &lt;span class="m">2018&lt;/span> - 09:48:24
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/docker/">DOCKER</category><category domain="https://blog.ferstar.org/tags/windows/">WINDOWS</category></item><item><title>利用docker-compose备份、还原volume数据</title><link>https://blog.ferstar.org/post/use-docker-compose-backup-or-restore-your-volume-data/</link><guid isPermaLink="true">https://blog.ferstar.org/post/use-docker-compose-backup-or-restore-your-volume-data/</guid><pubDate>Thu, 14 Jun 2018 15:17:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>先说说实际情况，最近做的项目跑在 AWS 的 EC2 上面，林林总总依赖好几个服务；实际开发却是用的 Windows10（没办法，一堆非Windows不可的软件要用），还好有 Docker 这神器。&lt;/p>
&lt;p>有个 PostgreSQL 的容器资料开始是挂在名叫 pgdata 的一个 volume 上面，为方便本机调试我修改了 docker-compose.yml 的部分内容，实际的 volume 变成了 scsweb_pgdata&lt;/p>
&lt;p>这就面临一个问题，原来 pgdata 的数据怎么迁移到新的 scsweb_pgdata 上来？&lt;/p>
&lt;p>可以参考我这里的例子去&lt;a href="https://github.com/ferstar/dockerizing-django">迁移 pg 数据库&lt;/a>，但感觉太麻烦，觉得应该有更简单的方式。&lt;/p>
&lt;p>自然求助万能的 Google 希望能够有 volume clone 的神奇命令搞定，然而目前 docker volume 支持的指令只有&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ docker volume
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Usage: docker volume COMMAND
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Manage volumes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Options:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Commands:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> create Create a volume
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> inspect Display detailed information on one or more volumes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ls List volumes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> prune Remove all unused &lt;span class="nb">local&lt;/span> volumes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> rm Remove one or more volumes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Run &lt;span class="s1">&amp;#39;docker volume COMMAND --help&amp;#39;&lt;/span> &lt;span class="k">for&lt;/span> more information on a command.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这么几个，完全不够用。还好发现有好心人弄了个脚本&lt;/p>
&lt;p>via -&amp;gt; &lt;a href="https://loomchild.net/2017/03/26/backup-restore-docker-named-volumes/">https://loomchild.net/2017/03/26/backup-restore-docker-named-volumes/&lt;/a>&lt;/p>
&lt;p>满心欢喜去照抄进终端，然后来了个大大的错误：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ docker run -it -v scsweb_pgdata:/volume -v ./db:/backup alpine &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>&amp;gt; sh -c &lt;span class="s2">&amp;#34;rm -rf /volume/* /volume/..?* /volume/.[!.]* ; tar -C /volume/ -xjf /backup/pgdata.tar.bz2&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">C:&lt;span class="se">\P&lt;/span>rogram Files&lt;span class="se">\D&lt;/span>ocker Toolbox&lt;span class="se">\d&lt;/span>ocker.exe: Error response from daemon: create .&lt;span class="se">\d&lt;/span>b&lt;span class="p">;&lt;/span>C: &lt;span class="s2">&amp;#34;.\\db;C&amp;#34;&lt;/span> includes invalid characters &lt;span class="k">for&lt;/span> a &lt;span class="nb">local&lt;/span> volume name, only &lt;span class="s2">&amp;#34;[a-zA-Z0-9][a-zA-Z0-9_.-]&amp;#34;&lt;/span> are allowed. If you intended to pass a host directory, use absolute path.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">See &lt;span class="s1">&amp;#39;C:\Program Files\Docker Toolbox\docker.exe run --help&amp;#39;&lt;/span>.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>同样的命令在 Linux 系统是没有任何问题的，为了短平快解决问题，我并没有过于深究这个原因，而是曲线救国的方案，利用 docker-compose 来搞&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># filename: docker-compose.yml&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">backup&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">alpine&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">./db:/backup&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">pgdata:/volume&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tar -cjf /backup/pgdata.tar.bz2 -C /volume ./&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">restore&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">alpine&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">./db:/backup&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">scsweb_pgdata:/volume&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sh -c &amp;#34;rm -rf /volume/* /volume/..?* /volume/.[!.]* ; tar -C /volume/ -xjf /backup/pgdata.tar.bz2&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>原理很简单，就是把要备份的 volume 和存放备份的目录，比如我这里是用的当前目录下 db 目录挂载到一起，然后用 tar 命令打包。&lt;/p>
&lt;p>使用方法：&lt;/p>
&lt;ol>
&lt;li>备份 - &lt;code>docker-compose run --rm backup&lt;/code>&lt;/li>
&lt;li>还原 - &lt;code>docker-compose run --rm restore&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>PS：自行替换对应文件名&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/docker/">DOCKER</category></item><item><title>解决Windows资源保护找到损坏文件但无法修复的问题</title><link>https://blog.ferstar.org/post/%E8%A7%A3%E5%86%B3windows%E8%B5%84%E6%BA%90%E4%BF%9D%E6%8A%A4%E6%89%BE%E5%88%B0%E6%8D%9F%E5%9D%8F%E6%96%87%E4%BB%B6%E4%BD%86%E6%97%A0%E6%B3%95%E4%BF%AE%E5%A4%8D%E7%9A%84%E9%97%AE%E9%A2%98/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E8%A7%A3%E5%86%B3windows%E8%B5%84%E6%BA%90%E4%BF%9D%E6%8A%A4%E6%89%BE%E5%88%B0%E6%8D%9F%E5%9D%8F%E6%96%87%E4%BB%B6%E4%BD%86%E6%97%A0%E6%B3%95%E4%BF%AE%E5%A4%8D%E7%9A%84%E9%97%AE%E9%A2%98/</guid><pubDate>Fri, 11 May 2018 13:04:37 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>昨天更新Windows10 5月累计补丁，早上发现蓝牙耳机无法连接，折腾驱动神马的未果，怀疑是系统文件受损导致，Google一番，官方推荐&lt;code>sfc /scannow&lt;/code>验证系统并修复受损文件，但得到的提示如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">开始系统扫描&lt;/span>&lt;span class="err">。&lt;/span>&lt;span class="n">此过程将需要一些时间&lt;/span>&lt;span class="err">。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">开始系统扫描的验证阶段&lt;/span>&lt;span class="err">。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">验证&lt;/span> &lt;span class="mf">100&lt;/span>&lt;span class="p">%&lt;/span> &lt;span class="n">已完成&lt;/span>&lt;span class="err">。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Windows&lt;/span> &lt;span class="n">资源保护找到了损坏文件但无法修复&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">其中某些文件&lt;/span>&lt;span class="err">。&lt;/span>&lt;span class="n">CBS&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Log&lt;/span> &lt;span class="n">windir&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Logs&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">CBS&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">CBS&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">log&lt;/span> &lt;span class="n">中有详细信息&lt;/span>&lt;span class="err">。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">例如&lt;/span> &lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Windows&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Logs&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">CBS&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">CBS&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">log&lt;/span>&lt;span class="err">。&lt;/span>&lt;span class="n">请注意&lt;/span>&lt;span class="err">，&lt;/span>&lt;span class="n">在脱机服务方案中&lt;/span>&lt;span class="err">，&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">当前不支持日志记录&lt;/span>&lt;span class="err">。&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>意思是找到受损文件，但是&lt;code>sfc&lt;/code>命令无法修复，然后找到了这篇文章&lt;/p>
&lt;p>&lt;a href="https://wangye.org/blog/archives/1081">https://wangye.org/blog/archives/1081&lt;/a>&lt;/p>
&lt;p>照做后恢复正常。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">WINDOWS&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">system32&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>&lt;span class="n">findstr&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">C:&lt;/span>&lt;span class="s2">&amp;#34;[SR] Cannot repair member file&amp;#34;&lt;/span> &lt;span class="k">%&lt;/span>&lt;span class="n">windir&lt;/span>&lt;span class="p">%\&lt;/span>&lt;span class="n">logs&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">cbs&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">cbs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">log&lt;/span> &lt;span class="p">&amp;gt;&lt;/span>&lt;span class="s2">&amp;#34;%userprofile%\Desktop\sfcdetails.txt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">WINDOWS&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">system32&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>&lt;span class="n">DISM&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">Online&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="nb">Cleanup-image&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">Scanhealth&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">部署映像服务和管理工具&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">版本&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="mf">10.0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">16299&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">15&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">映像版本&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="mf">10.0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">16299&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">431&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">[==========================&lt;/span>&lt;span class="mf">100.0&lt;/span>&lt;span class="p">%==========================]&lt;/span> &lt;span class="n">可以修复组件存储&lt;/span>&lt;span class="err">。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">操作成功完成&lt;/span>&lt;span class="err">。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">WINDOWS&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">system32&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>&lt;span class="n">DISM&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">Online&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="nb">Cleanup-image&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">Restorehealth&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">部署映像服务和管理工具&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">版本&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="mf">10.0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">16299&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">15&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">映像版本&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="mf">10.0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">16299&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">431&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">[==========================&lt;/span>&lt;span class="mf">100.0&lt;/span>&lt;span class="p">%==========================]&lt;/span> &lt;span class="n">还原操作已成功完成&lt;/span>&lt;span class="err">。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">操作成功完成&lt;/span>&lt;span class="err">。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">WINDOWS&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">system32&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>&lt;span class="n">Sfc&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">scannow&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">开始系统扫描&lt;/span>&lt;span class="err">。&lt;/span>&lt;span class="n">此过程将需要一些时间&lt;/span>&lt;span class="err">。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">开始系统扫描的验证阶段&lt;/span>&lt;span class="err">。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">验证&lt;/span> &lt;span class="mf">100&lt;/span>&lt;span class="p">%&lt;/span> &lt;span class="n">已完成&lt;/span>&lt;span class="err">。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Windows&lt;/span> &lt;span class="n">资源保护找到了损坏文件并成功修复了它们&lt;/span>&lt;span class="err">。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">CBS&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Log&lt;/span> &lt;span class="n">windir&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Logs&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">CBS&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">CBS&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">log&lt;/span> &lt;span class="n">中有详细信息&lt;/span>&lt;span class="err">。&lt;/span>&lt;span class="n">例如&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Windows&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Logs&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">CBS&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">CBS&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">log&lt;/span>&lt;span class="err">。&lt;/span>&lt;span class="n">请注意&lt;/span>&lt;span class="err">，&lt;/span>&lt;span class="n">在脱机服务方案中&lt;/span>&lt;span class="err">，&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">当前不支持日志记录&lt;/span>&lt;span class="err">。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">系统文件修复更改在下次重新启动之后生效&lt;/span>&lt;span class="err">。&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/windows/">WINDOWS</category></item><item><title>Resolve Google Scholar With IPv6 Only</title><link>https://blog.ferstar.org/post/resolve-google-scholar-with-ipv6-only/</link><guid isPermaLink="true">https://blog.ferstar.org/post/resolve-google-scholar-with-ipv6-only/</guid><pubDate>Thu, 08 Mar 2018 09:49:42 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>Google Scholar blocked most of DigitalOcean VPS IP(IPv4), so you should
use IPv6 to access Google Scholar instead.&lt;/p>
&lt;p>via: &lt;a href="https://github.com/shadowsocks/shadowsocks-libev/issues/113">https://github.com/shadowsocks/shadowsocks-libev/issues/113&lt;/a>&lt;/p>
&lt;p>Here is my solution&lt;/p>
&lt;blockquote>
&lt;p>make sure your vps has right ipv6 access&lt;/p>
&lt;p>OS: Ubuntu 16.04.3 LTS (GNU/Linux 4.12.2-041202-generic x86_64)&lt;/p>
&lt;p>ss version: shadowsocks-libev 3.1.3&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>vi /etc/default/shadowsocks-libev&lt;/li>
&lt;/ul>
&lt;pre tabindex="0">&lt;code>...
# add &amp;#39;-6&amp;#39; to resovle hostname to IPv6 address first
DAEMON_ARGS=&amp;#34;-u -6&amp;#34;
...
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>vi /etc/shadowsocks-libev/config.json&lt;/li>
&lt;/ul>
&lt;pre tabindex="0">&lt;code>...
&amp;#34;dns_ipv6&amp;#34;: true
...
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>vi /etc/hosts&lt;/li>
&lt;/ul>
&lt;pre tabindex="0">&lt;code>...
## Scholar
## type &amp;#39;host google.com&amp;#39; to get the correct ipv6 address
## for me it&amp;#39;s &amp;#39;2607:f8b0:4005:804::200e&amp;#39;
2607:f8b0:4005:804::200e scholar.google.cn
2607:f8b0:4005:804::200e scholar.google.com.hk
2607:f8b0:4005:804::200e scholar.google.com
2607:f8b0:4005:804::200e scholar.l.google.com
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>&lt;code>systemctl restart shadowsocks-libev&lt;/code>&lt;/li>
&lt;/ul></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>Django2.0 踩坑记</title><link>https://blog.ferstar.org/post/django-logs/</link><guid isPermaLink="true">https://blog.ferstar.org/post/django-logs/</guid><pubDate>Mon, 26 Feb 2018 09:01:41 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;h2 id="坑一-2_0w001-your-url-pattern--has">坑一：?: (2_0.W001) Your URL pattern '^ has...&lt;/h2>
&lt;p>因为是新项目，没有历史包袱，所以直接上了 Django 2.0 的方案，于是照着老司机经验教程爬就掉到了这个坑，全提示是：&lt;/p>
&lt;pre tabindex="0">&lt;code>WARNINGS:
?: (2_0.W001) Your URL pattern &amp;#39;^$&amp;#39; has a route that contains &amp;#39;(?P&amp;lt;&amp;#39;, begins with a &amp;#39;^&amp;#39;, or ends with a &amp;#39;$&amp;#39;. This was likely an oversight when migrating to django.urls.path().
&lt;/code>&lt;/pre>&lt;p>解决很简单，Google 大法&lt;/p>
&lt;p>&lt;a href="https://stackoverflow.com/a/47661654">https://stackoverflow.com/a/47661654&lt;/a>&lt;/p>
&lt;p>抄一下原答案：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">The new path&lt;span class="o">()&lt;/span> syntax in Django 2.0 does not use regular expressions. You want something like:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">path&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;&amp;lt;int:album_id&amp;gt;/&amp;#39;&lt;/span>, views.detail, &lt;span class="nv">name&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;detail&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">If you want to use a regular expression, you can use re_path&lt;span class="o">()&lt;/span>.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">re_path&lt;span class="o">(&lt;/span>r&lt;span class="s1">&amp;#39;^(?P&amp;lt;album_id&amp;gt;[0-9])/$&amp;#39;&lt;/span>, views.detail, &lt;span class="nv">name&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;detail&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">The old url&lt;span class="o">()&lt;/span> still works and is now an &lt;span class="nb">alias&lt;/span> to re_path, but it is likely to be deprecated in future.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">url&lt;span class="o">(&lt;/span>r&lt;span class="s1">&amp;#39;^(?P&amp;lt;album_id&amp;gt;[0-9])/$&amp;#39;&lt;/span>, views.detail, &lt;span class="nv">name&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;detail&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>,
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>意思是新的 path() 方法不认正则表达式，如果在 urls 中想用正则，需要用 re_path()，旧的 url() 方法在 Django 2.0 中依然支持，等同于 re_path()，未来可能会 deprecated，所以就用 re_path() 吧&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/django/">DJANGO</category></item><item><title>Fsck Error on Boot Dev Sda7 Unexpected Inconsistency Run Fsck Manually</title><link>https://blog.ferstar.org/post/fsck-error-on-boot-dev-sda6-unexpected-inconsistency-run-fsck-manually/</link><guid isPermaLink="true">https://blog.ferstar.org/post/fsck-error-on-boot-dev-sda6-unexpected-inconsistency-run-fsck-manually/</guid><pubDate>Mon, 26 Feb 2018 08:53:37 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>台式机一直双系统跑 Windows10 和 Ubuntu 16.04，昨天单位意外断电，悲剧的事情发生了，Ubuntu 无法启动，failsafe 启动看 log 显示 &lt;code>/dev/sda7：UNEXPECTED INCONSISTENCY;RUN fsck MANUALLY&lt;/code>，顺手 Google 一番，找到解决办法，记录下：&lt;/p>
&lt;p>via &lt;a href="https://askubuntu.com/questions/697190/fsck-error-on-boot-dev-sda6-unexpected-inconsistency-run-fsck-manually">https://askubuntu.com/questions/697190/fsck-error-on-boot-dev-sda6-unexpected-inconsistency-run-fsck-manually&lt;/a>&lt;/p>
&lt;p>基本上就是在&lt;code>initramfs&lt;/code>命令行敲如下命令即可搞定&lt;/p>
&lt;p>&lt;code>fsck -sy /dev/sda2&lt;/code>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/ubuntu/">UBUNTU</category></item><item><title>国内优秀npm镜像推荐及使用</title><link>https://blog.ferstar.org/post/cnpm/</link><guid isPermaLink="true">https://blog.ferstar.org/post/cnpm/</guid><pubDate>Sat, 24 Feb 2018 15:52:27 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>转载自: &lt;a href="http://riny.net/2014/cnpm/">http://riny.net/2014/cnpm/&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>&lt;code>npm&lt;/code>全称&lt;code>Node Package Manager&lt;/code>，是node.js的模块依赖管理工具。由于&lt;code>npm&lt;/code>的源在国外，所以国内用户使用起来各种不方便。下面整理出了一部分国内优秀的&lt;code>npm&lt;/code>镜像资源，国内用户可以选择使用。&lt;/p>
&lt;h2 id="国内优秀npm镜像">国内优秀npm镜像&lt;/h2>
&lt;h3 id="淘宝npm镜像">淘宝npm镜像&lt;/h3>
&lt;ul>
&lt;li>搜索地址：&lt;a href="http://npm.taobao.org/">http://npm.taobao.org/&lt;/a>&lt;/li>
&lt;li>registry地址：&lt;a href="http://registry.npm.taobao.org/">http://registry.npm.taobao.org/&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="cnpmjs镜像">cnpmjs镜像&lt;/h3>
&lt;ul>
&lt;li>搜索地址：&lt;a href="http://cnpmjs.org/">http://cnpmjs.org/&lt;/a>&lt;/li>
&lt;li>registry地址：&lt;a href="http://r.cnpmjs.org/">http://r.cnpmjs.org/&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="如何使用">如何使用&lt;/h2>
&lt;p>有很多方法来配置&lt;code>npm&lt;/code>的registry地址，下面根据不同情境列出几种比较常用的方法。以淘宝&lt;code>npm&lt;/code>镜像举例：&lt;/p>
&lt;h3 id="1临时使用">1.临时使用&lt;/h3>
&lt;pre tabindex="0">&lt;code>npm --registry https://registry.npm.taobao.org install express
&lt;/code>&lt;/pre>&lt;h3 id="2持久使用">2.持久使用&lt;/h3>
&lt;pre tabindex="0">&lt;code>npm config set registry https://registry.npm.taobao.org
// 配置后可通过下面方式来验证是否成功
npm config get registry
// 或
npm info express
&lt;/code>&lt;/pre>&lt;h3 id="3通过cnpm使用">3.通过&lt;code>cnpm&lt;/code>使用&lt;/h3>
&lt;pre tabindex="0">&lt;code>npm install -g cnpm --registry=https://registry.npm.taobao.org
// 使用
cnpm install express
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/nodejs/">NODEJS</category></item><item><title>Install Node.JS 8 LTS on CentOS 7, Debian 8 and Ubuntu 16</title><link>https://blog.ferstar.org/post/how-to-install-node.js-8-lts-on-centos-7-debian-8-and-ubuntu-16/</link><guid isPermaLink="true">https://blog.ferstar.org/post/how-to-install-node.js-8-lts-on-centos-7-debian-8-and-ubuntu-16/</guid><pubDate>Sat, 24 Feb 2018 15:06:46 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;h2 id="what-is-nodejs">What is Node.js?&lt;/h2>
&lt;p>Node.js is an open source, cross-platform runtime environment for developing server-side and networking applications. Node.js applications are written in JavaScript and can be run within the Node.js runtime on OS X, Microsoft Windows, and Linux. Node.js also provides a rich library of various JavaScript modules which simplifies the development of web applications using Node.js to a great extent.&lt;/p>
&lt;h2 id="what-is-npm">What is NPM?&lt;/h2>
&lt;p>NPM, short for Node Package Manager, is two things: first and foremost, it is an online repository for the publishing of open-source Node.js projects. second, it is a command-line utility for interacting with the said repository that aids in package installation, version management, and dependency management. Plenty of Node.js libraries and applications are published on NPM, and much more are added every day.&lt;/p>
&lt;p>We are assuming that you have root permission, otherwise, you may start commands with “sudo”.&lt;/p>
&lt;p>&lt;img src="https://www.hugeserver.com/kb/wp-content/uploads/2017/11/Java-9-The-Advanced-Java-SE-9-Platform-its-Dynamic-Features.jpg" alt="img">&lt;/p>
&lt;h2 id="install-nodejs-and-npm">Install Node.js and NPM&lt;/h2>
&lt;p>If you want to install Node.js 8 and NPM 5 you have to install them via RPM/DEB packages.&lt;/p>
&lt;h3 id="on-debian-8-and-ubuntu-16">On Debian 8 and Ubuntu 16&lt;/h3>
&lt;p>Execute following commands one by one to install Node.JS 8 on Debian and Ubuntu:&lt;/p>
&lt;pre tabindex="0">&lt;code>apt-get update
apt-get install curl sudo
curl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash -
&lt;/code>&lt;/pre>&lt;p>Now you can install Node.js and NPM easily by typing:&lt;/p>
&lt;pre tabindex="0">&lt;code>apt-get install nodejs
&lt;/code>&lt;/pre>&lt;p>You can check the version of your Node.js and NPM with:&lt;/p>
&lt;pre tabindex="0">&lt;code>nodejs -v
v8.9.0
npm -v
5.5.1
&lt;/code>&lt;/pre>&lt;h3 id="on-centos-7">On CentOS 7&lt;/h3>
&lt;p>Issue the following commands to install Node.JS and NPM on your CentOS:&lt;/p>
&lt;pre tabindex="0">&lt;code>curl -sL https://rpm.nodesource.com/setup_8.x | bash -
yum install nodejs
&lt;/code>&lt;/pre>&lt;p>It’s done, check the version of Node.js and NPM:&lt;/p>
&lt;pre tabindex="0">&lt;code>nodejs -v
v8.9.0
npm -v
5.5.1
&lt;/code>&lt;/pre>&lt;p>via &lt;a href="https://www.hugeserver.com/kb/install-nodejs8-centos7-debian8-ubuntu16/">https://www.hugeserver.com/kb/install-nodejs8-centos7-debian8-ubuntu16/&lt;/a>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/nodejs/">NODEJS</category></item><item><title>Start VirtualBox VM in Headless Mode</title><link>https://blog.ferstar.org/post/start-virtualbox-vm-in-headless-mode/</link><guid isPermaLink="true">https://blog.ferstar.org/post/start-virtualbox-vm-in-headless-mode/</guid><pubDate>Sat, 24 Feb 2018 10:16:30 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>It is fairly common in web development to run code in a virtual machine (VM) so that you can mirror your production environment. However, using a &lt;em>GUIless&lt;/em> operating system through VirtualBox’s GUI window is a terrible experience. Fortunately VirtualBox provides an easy way of starting a VM using their command line tool &lt;code>VBoxManage&lt;/code> in a &lt;em>headless&lt;/em> mode.&lt;/p>
&lt;pre tabindex="0">&lt;code># List virtual machines
VBoxManage list vms
&amp;#34;MyVM&amp;#34; {e4b0c92c-4301-4a7d-8af8-fe02fed00451}
# Start VM in headless mode
VBoxManage startvm MyVM --type headless
# Power off VM
VBoxManage controlvm MyVM poweroff
&lt;/code>&lt;/pre>&lt;p>Once the virtual machine has started you can connect to it over SSH and use it as you would any server operating system.&lt;/p>
&lt;p>via &lt;a href="https://schier.co/blog/2013/03/13/start-virtualbox-vm-in-headless-mode.html">https://schier.co/blog/2013/03/13/start-virtualbox-vm-in-headless-mode.html&lt;/a>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>联想Newifi mini Y1三网接入配置</title><link>https://blog.ferstar.org/post/diy_on_newifi_mini/</link><guid isPermaLink="true">https://blog.ferstar.org/post/diy_on_newifi_mini/</guid><pubDate>Thu, 01 Feb 2018 13:40:26 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>不得不说这款路由真是神器，可玩性很高&lt;/p>
&lt;/blockquote>
&lt;h2 id="三种接入">三种接入&lt;/h2>
&lt;ol>
&lt;li>有线WAN口接上级路由，网关跃点30&lt;/li>
&lt;li>2.4G无线中继上级AP，网关跃点20&lt;/li>
&lt;li>USB 4G网卡接入联通4G网络，网关跃点10&lt;/li>
&lt;/ol>
&lt;h2 id="固件">固件&lt;/h2>
&lt;p>LEDE官网的固件识别不出USB，于是继续使用OPENWRT&lt;/p>
&lt;p>&lt;a href="http://downloads.openwrt.org/chaos_calmer/15.05/ramips/mt7620/openwrt-15.05-ramips-mt7620-Lenovo-y1-squashfs-sysupgrade.bin">http://downloads.openwrt.org/chaos_calmer/15.05/ramips/mt7620/openwrt-15.05-ramips-mt7620-Lenovo-y1-squashfs-sysupgrade.bin&lt;/a>&lt;/p>
&lt;p>捅菊花安装后没有5G驱动，需要装一下&lt;/p>
&lt;p>&lt;code>opkg update &amp;amp;&amp;amp; opkg install kmod-mt76&lt;/code>&lt;/p>
&lt;h2 id="zte-mf823网卡驱动">ZTE MF823网卡驱动&lt;/h2>
&lt;p>&lt;code>opkg install kmod-scsi-core kmod-usb-storage kmod-usb-net-cdc-ether kmod-usb-net&lt;/code>&lt;/p>
&lt;p>直接会认出&lt;code>usb0&lt;/code>网卡，正常联网&lt;/p>
&lt;h2 id="测试">测试&lt;/h2>
&lt;p>只要有一条链路能够正常联网，路由下的设备就可以上网，非常稳定。&lt;/p>
&lt;p>根据跃点设置，流量优先级3&amp;gt;2&amp;gt;1，USB网卡优先级最高。&lt;/p>
&lt;blockquote>
&lt;p>如果需要多线均衡负载，则可以考虑安装&lt;code>mwan3&lt;/code>进行设置，我这里没有需求，所以略去不谈。&lt;/p>
&lt;/blockquote>
&lt;h2 id="参考">参考&lt;/h2>
&lt;p>&lt;a href="https://www.tbdproductions.com.au/telstra4gzte823/">Guide to ZTE MF 823 USB dongles with OpenWrt and Gargoyle Routers&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://linuxtoy.org/archives/install-openwrt-on-newifi-mini.html">Newifi Mini 安装 OpenWrt&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://gist.github.com/bjoern-r/1345e8a17f4acf41006330e688af1441">HOWTO use a Huawei E3372 on OpenWRT&lt;/a>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/openwrt/">OPENWRT</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>缩小Virtualbox动态磁盘大小</title><link>https://blog.ferstar.org/post/reduce-virtualbox-disk-usage/</link><guid isPermaLink="true">https://blog.ferstar.org/post/reduce-virtualbox-disk-usage/</guid><pubDate>Wed, 24 Jan 2018 10:13:56 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>Virtualbox运行一段时间后，虚拟硬盘会变的越来越大，但是虚拟机内部却没有这么多的文件。我的Windows XP虚拟机内部文件总大小只有4G多，但是虚拟硬盘文件已经达到8G。然而老夫256G SSD空间已所剩无几，急需榨取点空余磁盘。&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/png/2018/1/6b5172ee4fcf22a80042057d3e0ca121.png" alt="整理前">&lt;/p>
&lt;h2 id="方法">方法&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>虚拟机系统进行碎片整理操作。&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/png/2018/1/664e171e2bc1fa0a1eed90b41e1d7296.png" alt="虚拟机磁盘实际占用">&lt;/p>
&lt;/li>
&lt;li>
&lt;p>使用&lt;code>sdelete&lt;/code>将零写入虚拟机内的空白空间。&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/png/2018/1/733c94e308fca306fffa17eb6ca5c7b0.png" alt="清零">&lt;/p>
&lt;/li>
&lt;li>
&lt;p>在主机操作系统使用&lt;code>VBoxManage&lt;/code>命令压缩&lt;code>vdi&lt;/code>格式的虚拟磁盘文件。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># VBoxManage.exe及虚拟磁盘文件路径需要自行查找确认&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">$&lt;/span> &lt;span class="s2">&amp;#34;C:\Program Files\Oracle\VirtualBox\VBoxManage.exe&amp;#34;&lt;/span> &lt;span class="n">modifyhd&lt;/span> &lt;span class="n">xp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">vdi&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">-compact&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mf">0&lt;/span>&lt;span class="p">%..&lt;/span>&lt;span class="mf">.10&lt;/span>&lt;span class="p">%..&lt;/span>&lt;span class="mf">.20&lt;/span>&lt;span class="p">%..&lt;/span>&lt;span class="mf">.30&lt;/span>&lt;span class="p">%..&lt;/span>&lt;span class="mf">.40&lt;/span>&lt;span class="p">%..&lt;/span>&lt;span class="mf">.50&lt;/span>&lt;span class="p">%..&lt;/span>&lt;span class="mf">.60&lt;/span>&lt;span class="p">%..&lt;/span>&lt;span class="mf">.70&lt;/span>&lt;span class="p">%..&lt;/span>&lt;span class="mf">.80&lt;/span>&lt;span class="p">%..&lt;/span>&lt;span class="mf">.90&lt;/span>&lt;span class="p">%..&lt;/span>&lt;span class="mf">.100&lt;/span>&lt;span class="p">%&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>大功告成，检查一下成果，缩了近一半，well done！&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/png/2018/1/6ea2db3d177e33321c927bb4b339b8bd.png" alt="整理后">&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="参考资料">参考资料&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>&lt;a href="https://docs.microsoft.com/zh-cn/sysinternals/downloads/sdelete">SDelete v2.0&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://www.helplib.com/Linux/article_13911">如何缩小VirtualBox虚拟机并释放磁盘空间&lt;/a>&lt;/p>
&lt;/li>
&lt;/ul></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/windows/">WINDOWS</category><category domain="https://blog.ferstar.org/tags/virtualbox/">VIRTUALBOX</category></item><item><title>命令行下载进度条</title><link>https://blog.ferstar.org/post/download-progressbar/</link><guid isPermaLink="true">https://blog.ferstar.org/post/download-progressbar/</guid><pubDate>Mon, 22 Jan 2018 15:36:41 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>之前写的SciHub Spider需要有下载进度提示功能，于是就撸了发，基本上是东拼西凑大法。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">ProgressBar&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 下载进度条&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">title&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">count&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">run_status&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">fin_status&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">total&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mf">100.0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">unit&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sep&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;/&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">chunk_size&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mf">1.0&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">super&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ProgressBar&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="fm">__init__&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">info&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;[&lt;/span>&lt;span class="si">%s&lt;/span>&lt;span class="s2">...] &lt;/span>&lt;span class="si">%s&lt;/span>&lt;span class="s2"> &lt;/span>&lt;span class="si">%.2f&lt;/span>&lt;span class="s2"> &lt;/span>&lt;span class="si">%s&lt;/span>&lt;span class="s2"> &lt;/span>&lt;span class="si">%s&lt;/span>&lt;span class="s2"> &lt;/span>&lt;span class="si">%.2f&lt;/span>&lt;span class="s2"> &lt;/span>&lt;span class="si">%s&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">title&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">title&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">count&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">total&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">total&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">chunk_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">chunk_size&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">status&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">run_status&lt;/span> &lt;span class="ow">or&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fin_status&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fin_status&lt;/span> &lt;span class="ow">or&lt;/span> &lt;span class="s2">&amp;#34; &amp;#34;&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">status&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">unit&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">unit&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sep&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sep&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">__get_info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">_info&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">info&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">title&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">status&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">count&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">chunk_size&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">unit&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sep&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">total&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">chunk_size&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">unit&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">_info&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">refresh&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">count&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">status&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">count&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">count&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">status&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">status&lt;/span> &lt;span class="ow">or&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">status&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">end_str&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\r&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">count&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">total&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">end_str&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">status&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">status&lt;/span> &lt;span class="ow">or&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fin_status&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">__get_info&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="n">end&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">end_str&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>写个下载函数试试效果：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">requests&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">contextlib&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">closing&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">download&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">url&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">with&lt;/span> &lt;span class="n">closing&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">requests&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;GET&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">url&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">stream&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">verify&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">False&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">response&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">chunk_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1024&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">content_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">headers&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;content-length&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">progress&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ProgressBar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">total&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">content_size&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">unit&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;KB&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">chunk_size&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">chunk_size&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">run_status&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;downloading&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">fin_status&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;download completed&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;wb&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">fh&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">data&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">response&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">iter_content&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">chunk_size&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">chunk_size&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">fh&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">progress&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">refresh&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">download&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;http://localhost:8000/test.rar&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;test&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>终端输出（懒得上动图了）：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">C:&lt;span class="se">\U&lt;/span>sers&lt;span class="se">\f&lt;/span>er_s&lt;span class="se">\A&lt;/span>naconda3&lt;span class="se">\e&lt;/span>nvs&lt;span class="se">\p&lt;/span>y36&lt;span class="se">\p&lt;/span>ython.exe D:/backup/scihub_spider/xxx.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>test...&lt;span class="o">]&lt;/span> download completed 23968.74 KB / 23968.74 KB
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>缩短xfrp客户端断线重连时间</title><link>https://blog.ferstar.org/post/check-online-clients-port-on-xfrps/</link><guid isPermaLink="true">https://blog.ferstar.org/post/check-online-clients-port-on-xfrps/</guid><pubDate>Fri, 19 Jan 2018 15:25:16 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>试用一段时间xfrp以后发现这货不是很稳定，容易任性断开，重连的时间不定，可能是秒级，也可能是分钟级甚至小时级，实在不能忍，于是迫切希望能够想个法子缩短这个断线重连的问题。&lt;/p>
&lt;p>于是简单想了一个思路：&lt;/p>
&lt;blockquote>
&lt;p>因为云主机不太可能任性开放端口，所以常规端口扫描的方法并不可行&lt;/p>
&lt;/blockquote>
&lt;ol>
&lt;li>客户端先检测自己能否正常上网&lt;/li>
&lt;li>确定上网OK后，客户端向xfrps的api发起请求查看返回的端口号&lt;/li>
&lt;li>根据返回端口号来判断是否重启xfrpc强制重连xfrps服务&lt;/li>
&lt;/ol>
&lt;p>但实际发现xfrps自带的api有个bug，即使是客户端断开连接，依然返回原来的端口号，这就比较扯，于是给原项目提了个Issues：&lt;a href="https://github.com/KunTengRom/xfrps/issues/4">设备断开后调用api依然可以获取remote port&lt;/a>，在得到原项目解决方案之前，只能自己简单撸个api来完成检测端口的任务曲线救国。&lt;/p>
&lt;p>Python Flask甩起来：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="ch">#!/usr/bin/env python3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># coding=utf-8&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">json&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">socket&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">requests&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">flask&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">Flask&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">jsonify&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">app&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Flask&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="vm">__name__&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">get_port&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sn&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 利用原api获取设备占用端口&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">url&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;http://127.0.0.1:7500/api/port/tcp/getport/&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sn&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">r&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">requests&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;GET&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">url&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">r&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">text&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">port&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">json&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">loads&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;port&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">port&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">pass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">is_used&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ip&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">port&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">is_used&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">False&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">s&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">socket&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">socket&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">socket&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">AF_INET&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">socket&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">SOCK_STREAM&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">bind&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">ip&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">port&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span> &lt;span class="n">socket&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">error&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#print(e)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">is_used&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">True&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">finally&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">is_used&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@app.route&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;/api/port/tcp/getport/&amp;lt;sn&amp;gt;&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">is_online&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sn&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">port&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">get_port&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sn&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 当xfrps端口在线且该端口确实有占用才能确定该客户端在线,其他均为设备断开&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">port&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">is_used&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;127.0.0.1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">port&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">jsonify&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="s2">&amp;#34;code&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;msg&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;port&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">port&lt;/span>&lt;span class="p">}),&lt;/span> &lt;span class="mi">200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">jsonify&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="s2">&amp;#34;code&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;msg&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;can not get port by its runid&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;port&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">}),&lt;/span> &lt;span class="mi">200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="vm">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># app.debug = True&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">app&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">host&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;0.0.0.0&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>测试&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 客户端在线,返回端口号&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl http://host:5000/api/port/tcp/getport/2076932757AC
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;code&amp;#34;&lt;/span>: 0,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;msg&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;port&amp;#34;&lt;/span>: &lt;span class="m">62058&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 不在线返回0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl http://host:5000/api/port/tcp/getport/2076932757A
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;code&amp;#34;&lt;/span>: 1,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;msg&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;can not get port by its runid&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;port&amp;#34;&lt;/span>: &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>客户端搞个shell脚本检测&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">PROG_NAME&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;xfrpc&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">PROG_UCI_CONF&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$PROG_NAME&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">PROG_COMMAND&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>which &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$PROG_NAME&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">JQ_NAME&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;jq&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">JQ_COMMAND&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>which &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$JQ_NAME&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">PROG_INITD&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;/etc/init.d/&lt;/span>&lt;span class="nv">$PROG_NAME&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 拿到remote server地址&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">SERVER_ADDR&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>&lt;span class="nv">$UCI&lt;/span> get &lt;span class="nv">$PROG_UCI_CONF&lt;/span>.common.server_addr&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">REMOTE_PORT_API&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">SERVER_ADDR&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">:5000/api/port/tcp/getport&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">GENERATE_204&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;http://g.cn/generate_204&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">RUN_ID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>&lt;span class="nv">$PROG_COMMAND&lt;/span> -r &lt;span class="p">|&lt;/span> cut -d &lt;span class="s2">&amp;#34;:&amp;#34;&lt;/span> -f2&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> -z &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$JQ_COMMAND&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;error: &lt;/span>&lt;span class="nv">$JQ_NAME&lt;/span>&lt;span class="s2"> not found!&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">get_remote_port&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">PORT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>curl --connect-timeout &lt;span class="m">3&lt;/span> -m &lt;span class="m">3&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$REMOTE_PORT_API&lt;/span>&lt;span class="s2">/&lt;/span>&lt;span class="nv">$RUN_ID&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> 2&amp;gt;/dev/null &lt;span class="p">|&lt;/span> &lt;span class="nv">$JQ_COMMAND&lt;/span> &lt;span class="s1">&amp;#39;.port&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="nv">$PORT&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">CODE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>curl --connect-timeout &lt;span class="m">3&lt;/span> -m &lt;span class="m">3&lt;/span> -sk &lt;span class="nv">$GENERATE_204&lt;/span> -w &lt;span class="s1">&amp;#39;%{http_code}&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$CODE&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;204&amp;#34;&lt;/span>x &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Network ok, check xfrps remote port...&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">PORT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>get_remote_port&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$PORT&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">x&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;0&amp;#34;&lt;/span>x &lt;span class="o">]&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="k">$(&lt;/span>&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">PORT&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> grep -E -q &lt;span class="s1">&amp;#39;^[0-9]{4,}$&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;xfrps remote port not available, reconnect...&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$PROG_INITD&lt;/span> restart
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Got remote port:&lt;/span>&lt;span class="nv">$PORT&lt;/span>&lt;span class="s2">, do nothing.&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Network down, no need to run xfrpc, stop it.&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$PROG_INITD&lt;/span> stop
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>扔crontab任务计划，每五分钟检测一次&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># crontab -e&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">*/5 * * * * /root/check_xfrpc.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重启crontab生效&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">/etc/init.d/cron restart
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>查看log有无是否调用成功&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># logread | grep check_xfrpc&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Fri Jan &lt;span class="m">19&lt;/span> 16:10:01 &lt;span class="m">2018&lt;/span> cron.info crond&lt;span class="o">[&lt;/span>2056&lt;span class="o">]&lt;/span>: crond: USER root pid &lt;span class="m">15405&lt;/span> cmd /root/check_xfrpc.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/openwrt/">OPENWRT</category><category domain="https://blog.ferstar.org/tags/xfrp/">XFRP</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>给自己打包的应用增加数字签名</title><link>https://blog.ferstar.org/post/autosigin-windows-apps/</link><guid isPermaLink="true">https://blog.ferstar.org/post/autosigin-windows-apps/</guid><pubDate>Tue, 16 Jan 2018 11:59:35 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>先前写的scihub spider软件打包后window10安装提示”Windows已保护你的电脑，SmartScreen筛选器已阻止启动一个未识别的应用“，虽然大家都知道这是我写的，人畜无害，点更多信息，就会显示”仍要运行“，也不是不能安装，但始终感觉不爽。搜了下发现是应用缺少数字签名导致，所以下载了微软官方的SignTool，完美解决问题。&lt;/p>
&lt;p>附签名过程信息：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">D:&lt;span class="se">\b&lt;/span>ackup&lt;span class="se">\s&lt;/span>etup&amp;gt;signtool.exe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SignTool Error: A required parameter is missing.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Usage: signtool &amp;lt;command&amp;gt; &lt;span class="o">[&lt;/span>options&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Valid commands:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sign -- Sign files using an embedded signature.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> timestamp -- Timestamp previously-signed files.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> verify -- Verify embedded or catalog signatures.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> catdb -- Modify a catalog database.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> remove -- Reduce the size of an embedded signed file.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">For &lt;span class="nb">help&lt;/span> on a specific command, enter &lt;span class="s2">&amp;#34;signtool &amp;lt;command&amp;gt; /?&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">D:&lt;span class="se">\b&lt;/span>ackup&lt;span class="se">\s&lt;/span>etup&amp;gt;signtool.exe sign /a SciHub-Spider-update-1.6.6.exe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Done Adding Additional Store
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Successfully signed: SciHub-Spider-update-1.6.6.exe
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>安装程序签名后属性一栏会多出”数字签名“的标签，perfect！&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/windows/">WINDOWS</category><category domain="https://blog.ferstar.org/tags/scihub/">SCIHUB</category></item><item><title>Deploy Xfrp on Openwrt</title><link>https://blog.ferstar.org/post/deploy-xfrp-on-openwrt/</link><guid isPermaLink="true">https://blog.ferstar.org/post/deploy-xfrp-on-openwrt/</guid><pubDate>Wed, 03 Jan 2018 15:53:30 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>原生的frp对路由器来说还是略显笨重，于是有好人用C实现了一遍，叫&lt;a href="https://github.com/KunTengRom/xfrps">xfrps&lt;/a>，对比之下go实现的frp显然臃肿太多，负担不起。&lt;/p>
&lt;p>&lt;img src="http://p2.cdn.img9.top/ipfs/QmTkn9DSCbf6Tk5nenGaBon2FTNne8aeL6gcyDcCuMYHYu?2.png" alt="负载">&lt;/p>
&lt;p>部署过程中有个坑，xfrpc依赖的libevent2版本太高，路由器固件自带的版本显然没法满足，所以只好自己编译，makefile早有好心人写好，抄抄改改轻松把libevent2版本艹到2.1.6，需要ipk的可以去我的&lt;a href="https://github.com/ferstar/openwrt-libevent21">GitHub-openwrt-libevent21&lt;/a>自取。&lt;/p>
&lt;p>附交叉编译ipk简单步骤：&lt;/p>
&lt;ol>
&lt;li>下载对应芯片平台的SDK,我的是联想newifi mini &lt;a href="http://downloads.openwrt.org/barrier_breaker/14.07/ramips/mt7620a/OpenWrt-SDK-ramips-for-linux-x86_64-gcc-4.8-linaro_uClibc-0.9.33.2.tar.bz2">mt7620a&lt;/a>&lt;/li>
&lt;li>下载&lt;a href="http://downloads.openwrt.org.cn/PandoraBox/PandoraBox-Toolchain-ralink-for-mipsel_24kec%2Bdsp-gcc-4.8-linaro_uClibc-0.9.33.2.tar.bz2">PandoraBox Toolchain&lt;/a>&lt;/li>
&lt;li>配置交叉编译环境变量(假设我将以上SDK及Toolchain都解压到~/pbox目录)&lt;/li>
&lt;/ol>
&lt;pre tabindex="0">&lt;code>PATH=$PATH:~/pbox/toolchain-mipsel_24kec+dsp_gcc-4.8-linaro_uClibc-0.9.33.2/bin
export PATH
STAGING_DIR=~/pbox
export STAGING_DIR
&lt;/code>&lt;/pre>&lt;ol start="4">
&lt;li>将本Repository中的Makefile放到SDK根目录package目录下,如&lt;code>package/libevent21&lt;/code>&lt;/li>
&lt;li>在SDK根目录运行&lt;code>make package/libevent21/install V=s&lt;/code>&lt;/li>
&lt;li>不出意外的话&lt;code>ipk&lt;/code>会在&lt;code>bin/ramips/packages/base&lt;/code>目录下&lt;/li>
&lt;li>将所需的&lt;code>ipk&lt;/code>上传到路由器安装即可&lt;/li>
&lt;/ol>
&lt;p>PS:安装ipk需要加点东西&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># vi /etc/opkg.conf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">arch all &lt;span class="m">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">arch ralink &lt;span class="m">200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">arch ramips &lt;span class="m">300&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">arch ramips_24kec &lt;span class="m">400&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/openwrt/">OPENWRT</category><category domain="https://blog.ferstar.org/tags/xfrp/">XFRP</category></item><item><title>Deploy frp on Openwrt</title><link>https://blog.ferstar.org/post/deploy-frp-on-openwrt/</link><guid isPermaLink="true">https://blog.ferstar.org/post/deploy-frp-on-openwrt/</guid><pubDate>Tue, 02 Jan 2018 17:47:52 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>老家的路由偶尔会出状况，为了出门在外能够方便控制调试，找到&lt;a href="https://github.com/fatedier/frp">frp&lt;/a>这个神器。&lt;/p>
&lt;ol>
&lt;li>
&lt;p>服务端配置参考官方说明，需要注意的是要在VPS中配置防火墙开放相应端口&lt;/p>
&lt;/li>
&lt;li>
&lt;p>客户端选择对应芯片方案的二进制，家里网络不稳，所以使用&lt;code>protocol = kcp&lt;/code>协议&lt;/p>
&lt;/li>
&lt;li>
&lt;p>后台运行使用&lt;code>screen&lt;/code>：&lt;code>screen -dmS frps frps -c frps_full.ini&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>路由器开机运行，修改/etc/rc.local&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">sleep &lt;span class="m">30&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">screen -dmS frpc /root/frpc -c /root/frpc.ini
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">exit&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ol>
&lt;p>在家里的路由器和邻居路由器各部署一个，互为灾备(之前做了无线中继及互访配置，只要有一个在线，就可以控制另外一个)。回单位后测试表现良好。&lt;/p>
&lt;p>frps自建了http监控，可以方便地查看路由在线状态。&lt;/p>
&lt;p>&lt;img src="http://p0.cdn.img9.top/ipfs/QmdhpZUNtTsuJt26GwWZ7uX6vYfwDAyUzooQMp6gg7RL36?0.png" alt="设备在线状态">&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/openwrt/">OPENWRT</category><category domain="https://blog.ferstar.org/tags/frp/">FRP</category></item><item><title>OpenWRT配置双线叠加(有线拨号+无线中继)及负载均衡</title><link>https://blog.ferstar.org/post/openwrt-dual-wan-settings/</link><guid isPermaLink="true">https://blog.ferstar.org/post/openwrt-dual-wan-settings/</guid><pubDate>Tue, 02 Jan 2018 16:57:37 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>路由: Newifi mini&lt;/p>
&lt;p>固件: PandoraBox r1024&lt;/p>
&lt;p>无线: 电信20Mbps&lt;/p>
&lt;p>有线: 广电10Mbps&lt;/p>
&lt;/blockquote>
&lt;ol>
&lt;li>正常拨号，&lt;strong>网关跃点设为40&lt;/strong>&lt;/li>
&lt;li>虚拟WAN接口创建两个虚拟WAN口，&lt;strong>选中断线自动重拨，最低在线接口数设为1&lt;/strong>&lt;/li>
&lt;li>无线配置界面点搜索，选中需要中继的无线信号，&lt;strong>新建接口名称命名为“VWAN2”&lt;/strong>&lt;/li>
&lt;li>负载均衡策略选balance&lt;/li>
&lt;/ol>
&lt;p>放几张图&lt;/p>
&lt;p>&lt;img src="http://p2.cdn.img9.top/ipfs/QmZVHaLUjNAkhXRAXfe4GQWzu3yBj9ePryk4AipqjboimU?2.png" alt="无线概况">&lt;/p>
&lt;p>&lt;img src="http://p3.cdn.img9.top/ipfs/QmZ4rJrfHmHuMRK8g76gVhbfLJpGWPCdebwrTa9wy11CLQ?3.png" alt="接口">&lt;/p>
&lt;p>&lt;img src="http://p0.cdn.img9.top/ipfs/QmcZEqU4wtMNz6e7KRfANvrovDjLksHJ6yRcFUyMBuMkZS?0.png" alt="负载均衡配置">&lt;/p>
&lt;p>用speedtest测速显示上传下载带宽均提升了一倍多~well done！&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/openwrt/">OPENWRT</category></item><item><title>OpenWRT下配置仅交换加AP模式</title><link>https://blog.ferstar.org/post/set-openwrt-as-swich-ap/</link><guid isPermaLink="true">https://blog.ferstar.org/post/set-openwrt-as-swich-ap/</guid><pubDate>Tue, 02 Jan 2018 16:28:46 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>元旦放假回老家，邻居叫帮忙整整家庭网络。由于电信已经升级了百兆光纤，所以原来的newifi mini肯定是跑不动了，测试了下5G撑死跑到70Mbps。于是试了试邻居才淘的TP TL-WDR6300，一番测试除了几无可玩性以外，其他完胜newifi mini，百兆宽带基本能跑满，只好淘汰当AP扩展使了，农村地方大，一个AP很难满足全方位覆盖。&lt;/p>
&lt;p>重刷了PandoraBox固件，进luci配置界面--&amp;gt;网络--&amp;gt;接口--&amp;gt;LAN--&amp;gt;禁用DHCP服务器即可将其变为AP+交换机模式&lt;/p>
&lt;p>为了让这种模式下该路由可以正常联网，需要指定上级路由为网关，并设置合适的DNS服务器，如图&lt;/p>
&lt;p>&lt;img src="http://p2.cdn.img9.top/ipfs/QmS7CiFMnjH6pAQSuzeBsZroeCRSvc7KeSqF9hzQbZFXom?2.png" alt="LAN配置">&lt;/p>
&lt;p>另外，newifi mini只有3个RJ45物理接口（2LAN+1WAN），为了多出一个LAN，接下来需要把WAN当LAN口使，配置很简单，如图，就是划分VLAN&lt;/p>
&lt;p>&lt;img src="http://p2.cdn.img9.top/ipfs/QmYdiUW19WWZ2dMH8BoC4V6Z7YPsnHBXzwQUSv3zW3STF6?2.png" alt="VLAN配置图">&lt;/p>
&lt;p>“端口4”即WAN口，VLAN ID 1选择“不关联”，VLAN ID 2选择“关”，这样LAN1/LAN2/WAN口就都相当于LAN口了。&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/openwrt/">OPENWRT</category></item><item><title>Ubuntu 16.04变更时区设定</title><link>https://blog.ferstar.org/post/ubuntu-16-04-change-timezone-setting/</link><guid isPermaLink="true">https://blog.ferstar.org/post/ubuntu-16-04-change-timezone-setting/</guid><pubDate>Tue, 02 Jan 2018 15:58:08 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>以前常用&lt;strong>timedatectl&lt;/strong>，先取得timezone列表&lt;/p>
&lt;p>&lt;code>timedatectl list-timezones&lt;/code>&lt;/p>
&lt;p>然而列表很长，所以&lt;code>grep&lt;/code>下&lt;/p>
&lt;p>&lt;code>timedatectl list-timezones | grep Asia&lt;/code>&lt;/p>
&lt;p>找到希望的区域设定即可&lt;/p>
&lt;p>&lt;code>timedatectl set-timezone Asia/Hong_Kong&lt;/code>&lt;/p>
&lt;p>设定好后可以用timedatectl命令检查时区设定是否正确&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># timedatectl &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Local time: Tue 2018-01-02 16:06:52 CST
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Universal time: Tue 2018-01-02 08:06:52 UTC
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> RTC time: Tue 2018-01-02 08:06:52
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Time zone: Asia/Chongqing &lt;span class="o">(&lt;/span>CST, +0800&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Network &lt;span class="nb">time&lt;/span> on: yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NTP synchronized: yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> RTC in &lt;span class="nb">local&lt;/span> TZ: no
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>以上是Linux通用方法，有没有简单点的呢？还真有&lt;/p>
&lt;p>&lt;code>dpkg-reconfigure tzdata&lt;/code>&lt;/p>
&lt;p>巨简单&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/ubuntu/">UBUNTU</category></item><item><title>Crack the Password on an Excel VBA Project</title><link>https://blog.ferstar.org/post/crack-the-password-on-an-excel-vba-project/</link><guid isPermaLink="true">https://blog.ferstar.org/post/crack-the-password-on-an-excel-vba-project/</guid><pubDate>Thu, 21 Dec 2017 09:18:47 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>昨天拿到一个xlsm文件，模板写的有点问题，打算修改下凑合用，然而发现工程有密码保护，于是Google一番，发现这个回答挺靠谱，完美解决：&lt;/p>
&lt;p>&lt;a href="https://stackoverflow.com/a/31073075/6001263">https://stackoverflow.com/a/31073075/6001263&lt;/a>&lt;/p>
&lt;p>粘一下步骤：&lt;/p>
&lt;ol>
&lt;li>Change the extension of the &lt;code>.xlsm&lt;/code> file to &lt;code>.zip&lt;/code>.&lt;/li>
&lt;li>Open the .zip file (with WinZip or WinRar etc) and go to the xl folder.&lt;/li>
&lt;li>Extract the &lt;code>vbaProject.bin&lt;/code> file and open it in a Hex Editor.&lt;/li>
&lt;li>Search for &lt;code>DPB&lt;/code> and replace with &lt;code>DPx&lt;/code> and save the file.&lt;/li>
&lt;li>Replace the old &lt;code>vbaProject.bin&lt;/code> file with this new on in the zipped file.&lt;/li>
&lt;li>Change the file extension back to &lt;code>.xlsm&lt;/code>.&lt;/li>
&lt;li>Open workbook skip through the warning messages.&lt;/li>
&lt;li>Open up Visual Basic inside Excel.&lt;/li>
&lt;li>Go to Tools &amp;gt; VBAProject Properties &amp;gt; Protection Tab.&lt;/li>
&lt;li>Put in a new password and save the &lt;code>.xlsm&lt;/code> file.&lt;/li>
&lt;li>Close and re open and your new password will work.&lt;/li>
&lt;/ol></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/office/">OFFICE</category><category domain="https://blog.ferstar.org/tags/vba/">VBA</category></item><item><title>从Bitcron迁移到Hugo</title><link>https://blog.ferstar.org/post/%E4%BB%8Ebitcron%E8%BF%81%E7%A7%BB%E5%88%B0hugo/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E4%BB%8Ebitcron%E8%BF%81%E7%A7%BB%E5%88%B0hugo/</guid><pubDate>Tue, 12 Dec 2017 17:08:07 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>跟随老大的&lt;a href="https://tech.crandom.com/post/2017/switch-to-hugo/">脚步&lt;/a>，拥抱hugo，拥抱CI。&lt;/p>
&lt;/blockquote>
&lt;h2 id="caddy--hugo-with-docker">Caddy &amp;amp;&amp;amp; Hugo with Docker&lt;/h2>
&lt;p>安装Docker什么的暂且不表，基本都是拿来主义。&lt;/p>
&lt;p>&lt;code>docker run -d -p 2015:2015 muninn/hugo-caddy&lt;/code>&lt;/p>
&lt;p>docker会自动把这个镜像拖下来。&lt;/p>
&lt;h2 id="github托管hugo站点">GitHub托管Hugo站点&lt;/h2>
&lt;p>按照Hugo官网手册把站点搞起，然后托管到GitHub上&lt;/p>
&lt;p>&lt;a href="https://github.com/ferstar/blog">https://github.com/ferstar/blog&lt;/a>&lt;/p>
&lt;h2 id="vps端caddy配置">VPS端Caddy配置&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">mkdir ~/.caddy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vi ~/.caddy/Caddyfile
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 这货配置文件比Nginx简约太多。。。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">blog.ferstar.org &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> root /www/public
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> timeouts 10m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> gzip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tls fer_star@qq.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tls &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> protocols tls1.0 tls1.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># sync the repo and then gen public site&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> git &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> repo &lt;span class="o">{&lt;/span>&lt;span class="nv">$REPO&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> path ../src
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> hook /webhook
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> args --recurse-submodules
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">then&lt;/span> hugo --destination&lt;span class="o">=&lt;/span>/www/public
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># write log to stdout for docker&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> log stdout
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> errors stdout
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ferstar.org &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> redir https://blog.ferstar.org
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="docker-compose配置">docker-compose配置&lt;/h2>
&lt;p>用Docker自然少不了这货，配个适用于自己站点的&lt;code>docker-compose.yml&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">version: &lt;span class="s1">&amp;#39;2&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">services:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> hugo:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> image: muninn/hugo-caddy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> volumes:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - /root/.caddy/Caddyfile:/etc/Caddyfile
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - /root/.caddy:/root/.caddy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ports:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - 80:80
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - 443:443
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> environment:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - &lt;span class="nv">REPO&lt;/span>&lt;span class="o">=&lt;/span>github.com/ferstar/blog
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> restart: unless-stopped
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>因为要用&lt;code>Let's Encrypt&lt;/code>的证书给网站上小绿锁，所以需要把&lt;code>80&lt;/code>和&lt;code>443&lt;/code>端口交给Caddy，另外需要指定存放认证的路径。&lt;/p>
&lt;h2 id="持续集成github-webhooks">持续集成(GitHub Webhooks)&lt;/h2>
&lt;p>所谓&lt;code>CI&lt;/code>在这里就是利用GitHub的Webhooks服务，每次接受推送&lt;code>push&lt;/code>（貌似还可以指定别的事件类型）事件时，给VPS站点发一个&lt;code>POST&lt;/code>通知，然后VPS收到通知后会自动执行拉取GitHub指定分支内容，然后Hugo自动生成静态页面，最后重启Caddy服务，整个过程如丝顺滑~&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/png/2017/12/405b246b70f9de2c4bd98c93afaaa007.png" alt="微信截图_20171226164109">&lt;/p>
&lt;h2 id="转换旧文章">转换旧文章&lt;/h2>
&lt;p>原来的水文都是在Bitcron写的，文件头信息格式不太一样，于是写脚本转换了下。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;span class="lnt">76
&lt;/span>&lt;span class="lnt">77
&lt;/span>&lt;span class="lnt">78
&lt;/span>&lt;span class="lnt">79
&lt;/span>&lt;span class="lnt">80
&lt;/span>&lt;span class="lnt">81
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">os&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">sys&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">chardet.universaldetector&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">UniversalDetector&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Usage: &lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2"> source_dir dest_dir&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">src_dir&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">new_dir&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">exists&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">new_dir&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">mkdir&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">new_dir&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">detect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">detector&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">UniversalDetector&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;rb&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">fh&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">line&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">fh&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">detector&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">feed&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">line&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">detector&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">done&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="k">break&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">detector&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">detector&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;encoding&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">get_files&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dp&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">root&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">dirs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">files&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">walk&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dp&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nb">map&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">lambda&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">files&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">convert_article&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">file_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">basename&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;.&amp;#39;&lt;/span>&lt;span class="p">)[:&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">new_fp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">new_dir&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file_name&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s2">&amp;#34;.md&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">encoding&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">detect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">tags_line&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">status&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;draft&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;r&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">encoding&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">encoding&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">fh&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># hexo header metadata&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="kc">True&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">line&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fh&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">readline&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">line&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">startswith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;---&amp;#34;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="kc">True&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">line&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fh&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">readline&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">line&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">startswith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;---&amp;#34;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">line&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">startswith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;date&amp;#34;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">_date&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;T&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">line&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strip&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34; &amp;#34;&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">_date&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">16&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">date_line&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">_date&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s1">&amp;#39;:00+08:00&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">date_line&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">_date&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s1">&amp;#39;+08:00&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">line&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">startswith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;title&amp;#34;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">title_line&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">line&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strip&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">replace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&amp;#39;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">replace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;&amp;#34;&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;:&amp;#39;&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strip&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">title_line&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">startswith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;&amp;#34;&amp;#39;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">title_line&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">title_line&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">replace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;&amp;#34;&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">line&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">startswith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;status&amp;#39;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">status&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">line&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strip&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39; &amp;#39;&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">line&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">startswith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;tags&amp;#39;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">tags_line&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">line&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strip&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">replace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&amp;#39;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">replace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39; &amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;:&amp;#39;&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;,&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">upper&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">status&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;draft&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">new_fp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;w&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">encoding&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;utf-8&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">out&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># bitcron header metadata&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;---&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;title: &amp;#34;&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s1">&amp;#34;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">title_line&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;date: &amp;#34;&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s1">&amp;#34;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">date_line&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">tags_line&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;tags: &lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tags_line&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;tags: [&amp;#39;OTHERS&amp;#39;]&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;comments: true&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;---&lt;/span>&lt;span class="se">\n\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># copy the rest lines&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">line&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fh&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">readline&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">line&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">line&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">list&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">map&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">convert_article&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">get_files&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">src_dir&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="配置站点favicon">配置站点favicon&lt;/h2>
&lt;p>用的主题貌似没有favicon，而且缺了个&lt;code>apple-touch-icon-144-precomposed.png&lt;/code>的静态资源，想来应该是把&lt;code>favicon.ico&lt;/code>一起塞到&lt;code>static&lt;/code>目录下，试了下果然ok。&lt;/p>
&lt;p>&lt;a href="https://stackoverflow.com/questions/42043648/where-do-i-put-my-favicon-with-hugo">Where do I put my favicon with Hugo&lt;/a>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/hugo/">HUGO</category></item><item><title>Shell处理文件名中的空格</title><link>https://blog.ferstar.org/post/%E5%A4%84%E7%90%86%E6%96%87%E4%BB%B6%E5%90%8D%E4%B8%AD%E7%9A%84%E7%A9%BA%E6%A0%BC/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E5%A4%84%E7%90%86%E6%96%87%E4%BB%B6%E5%90%8D%E4%B8%AD%E7%9A%84%E7%A9%BA%E6%A0%BC/</guid><pubDate>Tue, 12 Dec 2017 16:47:36 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>文件命名中加空格是很正常的事情，但这种命名方式给Linux命令行工具和Shell带来了困扰，因为大多数命令中，都是默认以空格做为值与值之间的分隔符，而不是做为文件名的一部分。&lt;/p>
&lt;p>我在最近迁移博客的过程中就踩到这个坑，先看脚本：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> i in &lt;span class="k">$(&lt;/span>ls *.md&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">line&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>egrep -n &lt;span class="s2">&amp;#34;^---&amp;#34;&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">i&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> tail -n &lt;span class="m">1&lt;/span> &lt;span class="p">|&lt;/span> awk -F: &lt;span class="s1">&amp;#39;{print $1-1}&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">line&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">d&amp;#34;&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">i&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>我希望把当前目录下所有&lt;code>md&lt;/code>文档的最后一个以&lt;code>---&lt;/code>开头的前一行删掉（这一行是空行）&lt;/p>
&lt;p>然而执行结果如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">egrep: cluster自带wp管理密码.md: No such file or directory
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed: can&lt;span class="s1">&amp;#39;t read cluster自带wp管理密码.md: No such file or directory
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">egrep: 用: No such file or directory
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">sed: can&amp;#39;&lt;/span>t &lt;span class="nb">read&lt;/span> 用: No such file or directory
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">egrep: openpyxl: No such file or directory
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed: can&lt;span class="err">&amp;#39;&lt;/span>t &lt;span class="nb">read&lt;/span> openpyxl: No such file or directory
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>出问题的都是命名中带空格的文件&lt;/p>
&lt;p>那怎么处理这些带空格的文件呢？一个终极的解决办法就是设置IFS（the Internal Field Separator），不要用空格做为IFS，选择其他的符号。先来看看man page：&lt;/p>
&lt;blockquote>
&lt;p>IFS: The Internal Field Separator that is used for word splitting after expansion and to split lines into words with the read built-in command. The default value is “&lt;space>&lt;tab>&lt;new-line>”.&lt;/p>
&lt;/blockquote>
&lt;p>所以只需要在批处理的脚本前加一行&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">IFS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>&lt;span class="nb">echo&lt;/span> -en &lt;span class="s2">&amp;#34;\n\b&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>搞定~&lt;/p>
&lt;p>参考：&lt;/p>
&lt;ol>
&lt;li>&lt;a href="http://www.linuxjournal.com/article/10954">Work the shell － Dealing with Spaces in Filenames&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://www.cyberciti.biz/tips/handling-filenames-with-spaces-in-bash.html">BASH SHELL：For Loop File Names With Spaces&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://www.cnblogs.com/cocowool/archive/2013/01/15/2861904.html">SHELL技巧：处理文件名中的那些空格&lt;/a>&lt;/li>
&lt;/ol></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/shell/">SHELL</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>Sci-Hub Spider</title><link>https://blog.ferstar.org/post/scihub_spider/</link><guid isPermaLink="true">https://blog.ferstar.org/post/scihub_spider/</guid><pubDate>Tue, 12 Dec 2017 15:22:02 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>元宵节把SciHub Spider搬到了个人订阅号上，从此无视终端随心查看文档&lt;/p>
&lt;p>微信推文链接：&lt;a href="https://mp.weixin.qq.com/s/RulEtKY2L0iChQEq5ZSmJQ">https://mp.weixin.qq.com/s/RulEtKY2L0iChQEq5ZSmJQ&lt;/a>&lt;/p>
&lt;hr>
&lt;h2 id="更新信息">更新信息&lt;/h2>
&lt;blockquote>
&lt;p>一般只有遇到闪退bug或者scihub主站更新需要重新适配我才会更新软件，不会太频繁，一切以维护可用性为先，大家放心。&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>请注意由于SciHub网站更新，所以旧版本(1.6.2以前)都可能会无法正常解析到文献下载地址且大概率出现闪退，请更新新版。&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>软件自1.6.4开始使用自费服务提供软件更新，希望觉得好用的同学打赏一二，以cover服务器流量费用，谢谢！&lt;a href="https://blog.ferstar.org/post/scihub_spider/#%E6%B1%82%E6%8D%90%E8%B5%A0">打赏链接&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>软件只要检测到更新就会自动下载更新包到桌面，大家只需双击安装即可（macOS用户解压直接可运行），不安装更新软件将无法继续使用。&lt;/p>
&lt;/blockquote>
&lt;p>下载地址:&lt;/p>
&lt;blockquote>
&lt;p>又用回百度云了, 囧&lt;/p>
&lt;/blockquote>
&lt;ol>
&lt;li>Windows: &lt;a href="https://pan.baidu.com/s/1mmVZ13eMFWrhpDPYP2SN3w">SciHub-Spider-update-latest&lt;/a>&lt;/li>
&lt;/ol>
&lt;p>&lt;del>2. macOS(解压直接运行就可以): &lt;a href="http://p2f3k7a9w.bkt.clouddn.com/mac/SciHub-Spider-update-1.6.6.zip">SciHub-Spider-update-1.6.6&lt;/a>&lt;/del>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;span class="lnt">76
&lt;/span>&lt;span class="lnt">77
&lt;/span>&lt;span class="lnt">78
&lt;/span>&lt;span class="lnt">79
&lt;/span>&lt;span class="lnt">80
&lt;/span>&lt;span class="lnt">81
&lt;/span>&lt;span class="lnt">82
&lt;/span>&lt;span class="lnt">83
&lt;/span>&lt;span class="lnt">84
&lt;/span>&lt;span class="lnt">85
&lt;/span>&lt;span class="lnt">86
&lt;/span>&lt;span class="lnt">87
&lt;/span>&lt;span class="lnt">88
&lt;/span>&lt;span class="lnt">89
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">2018/08/27 1.7.1:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1. 更新正则匹配规则以适配scihub网站更新
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2. 七牛云测试域名到期，更换MQTT服务来检测更新
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3. 正则匹配规则支持热更新
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">4. 公众号增加邮件发送文献镜像下载地址功能
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2018/07/25 1.7.0:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1. 修复网页重定向导致无法正常检索的问题
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2018/05/03 1.6.9:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1. 更新正则匹配规则以适配scihub网站更新
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2018/03/27 1.6.8:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1. 删掉几个不稳定的镜像节点
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2. 修复偶尔下载失败造成的闪退问题
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3. 移除不必要的静态资源
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2018/03/02 SciHub Spider WeChat Bot:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1. 微信版闪亮登场,不再需要安装任何东西，关注即可
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">https://mp.weixin.qq.com/s/RulEtKY2L0iChQEq5ZSmJQ#opennewwindow
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2018/02/16 1.6.7:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1. 去掉一个被ban掉的scihub镜像检测网站
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2. 二维码求红包变为了福利链接，偷偷的别声张哈
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3. 修复下载目标内容为空时程序闪退的问题
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2018/01/16 1.6.6:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1. 修复scihub抽风引起的闪退问题
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2. macOS版本继续发布
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3. 增加应用签名,Windows10安装不再报应用未知的警告了
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2018/01/15 1.6.5:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1. 修复CDN缓存导致更新检测失败的问题
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2. 修复scihub网址列表为空时的报错问题
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3. 安装包增加英文引导语言,避免有些区域语言配置有问题的系统报错
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">4. 验证打赏码md5值
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2018/01/12 1.6.4:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1. 原网盘分享莫名被禁,故增加程序自动更新功能,弃用百度&lt;span class="o">(&lt;/span>使用七牛云存储服务&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2. 如果觉得微信赞赏码烦人,可以去程序根目录把wechat.jpg图片删除即可
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3. 精力有限,不再提供免安装程序
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">4. macOS版本暂缓,可能要等下周
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2018/01/11 1.6.3:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1. 适配SciHub网站更新
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2. 增加了一个SciHub可用性检测站点
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3. 增加微信赞赏码&lt;span class="o">(&lt;/span>更新不易,请多多支持&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2017/12/20 1.6.2:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1. 隐去scihub可用网站信息
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2. 修复macOS模块引用的一个小bug
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2017/12/19 1.6.1:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1. 修复文章标题包含特殊字符时程序闪退的问题
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2. 修复检测scihub站点可用性时可能引起的闪退问题
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3. 未检测到合法ID不再清空用户剪贴板内容
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">4. 增加从真实下载地址解析文章标题功能,如解析到则用作保存文件名,否则使用DOI代替
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5. 延长检测可用scihub站点扫描超时时间&lt;span class="o">(&lt;/span>应对龟速网络&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">6. 考虑系统兼容性增加64位专版，使用优先级“*支持xp”&amp;gt;“*免安装版不支持xp”&amp;gt;“*64位专版免安装”，如果都有问题，请反馈留言
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2017/12/18 1.6:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1. 新增SciHub镜像站点可用性检测
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2. 重写爬虫逻辑,提升文献下载能力
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3. 改名改图标
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">4. 精简不必要的组件包,缩小安装包体积
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5. 移除微信二维码捐赠图片
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">6. 提供安装板和免安装版两种选择
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2017/12/14 1.5:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1. 兼容xp系统，完成Windows全平台支持
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2. 首版安装版
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3. 缩减程序体积
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2017/12/14 1.4:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1. 兼容32位系统，xp依然不支持
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2. 禁止ssl验证
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3. 取消ssl禁用警告信息
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2017/12/14 1.3:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1. 修复bug
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2. 支持Windows &lt;span class="m">7&lt;/span> 64位
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3. 增加PMID/PMCID/Manuscript ID转换DOI支持
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2017/12/14 1.0-1.2:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1. 初版，单文件，仅支持Windows10 x64位系统
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2. 修复bug
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2017/11/11:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1. 简单脚本, 仅在朋友圈传播
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;hr>
&lt;p>众所周知，因为版权问题，科研神器&lt;code>SciHub&lt;/code>近来并不稳定，频繁更换域名。为了方便单位科研同学，上周用Python写了SCI文献下载器，并在朋友圈发布，反响颇佳。周末又重新理了一遍逻辑，现在论文下载能力应该是得到了进一步增强。&lt;/p>
&lt;p>工具原理很简单，主要利用了爬虫技术（老司机可以直接自己撸一个也没啥问题，纯体力活）。&lt;/p>
&lt;p>程序首先会检测更新，发现新版本则自动下载到桌面，需要手动安装。&lt;/p>
&lt;p>接着爬取目前可用的&lt;code>Sci-Hub&lt;/code>站点。&lt;/p>
&lt;p>然后会以验证&lt;code>http.headers&lt;/code>的方式（一般网站的headers大小仅仅几百个字节，所以并不会对服务器造成什么压力）去探测&lt;code>Sci-Hub&lt;/code>可用站点在本地网络的连通性，保留本地确定可连的站点。&lt;/p>
&lt;p>然后就开始检测用户剪贴板内容，如发现纯数字的PMID或者合法的DOI（通常以10.开头）就会自动去检索。&lt;/p>
&lt;p>PMID/PMCID/Manuscript ID/DOI ID转换是通过爬取&lt;code>NCBI&lt;/code>主站获得。也就是说如果在&lt;code>NCBI&lt;/code>上找不到对应DOI的文章是不会下载的，这种情况就需要你自己想办法找到文章的DOI号，再尝试让程序检索下载。&lt;/p>
&lt;p>拿到DOI号后即开始检索文献真实下载地址，优先从&lt;a href="http://libgen.io">libgen.io&lt;/a>爬取，爬取失败再去&lt;code>sci-hub&lt;/code>目前可用的镜像站点爬取。所以其实这里是从两个源头去下载，libgen服务比较稳定，&lt;code>Sci-Hub&lt;/code>相对不太稳。&lt;/p>
&lt;p>爬取成功则将文章保存在用户桌面。&lt;/p>
&lt;p>&lt;del>免安装版使用&lt;a href="http://www.pyinstaller.org/">PyInstaller&lt;/a>制作，只支持Windows7以上系统。&lt;/del>(不再提供免安装版)&lt;/p>
&lt;p>安装版使用&lt;a href="https://anthony-tuininga.github.io/cx_Freeze/">cx_Freeze&lt;/a>（打包）&lt;a href="http://www.jrsoftware.org/isinfo.php">Inno Setup - JRSoftware&lt;/a>（安装）制作，支持Windows XP系统，因为少了解压过程，不会产生系统垃圾，同时打开速度比安装版要快很多，推荐使用。&lt;/p>
&lt;h2 id="使用方法">使用方法&lt;/h2>
&lt;p>只需打开软件，复制要下载文章的PMID/PMCID/Manuscript ID/DOI等任一ID，程序可以自动从复制内容中解析出ID信息进行检索，找到文章即下载到桌面。&lt;/p>
&lt;p>PS：打开软件和复制ID无先后顺序，你可以先打开软件再复制ID或者先复制ID再打开软件。&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>请注意，并不是所有的文章都可以下载的到！！！&lt;/strong>&lt;/p>
&lt;p>&lt;strong>Please note that not all papers can be downloaded successfully!!!&lt;/strong>&lt;/p>
&lt;p>&lt;strong>考虑到可能引起的资源滥用，暂不开源&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;h2 id="下载地址百度网盘已作废">下载地址(百度网盘已作废)&lt;/h2>
&lt;p>&lt;del>&lt;a href="http://p2f3k7a9w.bkt.clouddn.com/exe/SciHub-Spider-update-1.6.4.exe?v=1234">SciHub-Spider-update-1.6.4&lt;/a>&lt;/del>&lt;/p>
&lt;p>&lt;del>链接:https://pan.baidu.com/s/1boAEC4f&lt;/del>&lt;/p>
&lt;p>&lt;del>密码:dz4y&lt;/del>&lt;/p>
&lt;h2 id="求捐赠">求捐赠&lt;/h2>
&lt;p>&lt;del>PayPal: &lt;a href="https://www.paypal.me/ferstar">https://www.paypal.me/ferstar&lt;/a>&lt;/del>&lt;/p>
&lt;p>由于使用自费服务提供软件更新，所以希望觉得好用的同学打赏一二，以cover服务器流量费用，谢谢！&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/png/2017/12/3d1e449bc01bae28f85b1675bd769b7a.png" alt="未命名_meitu_0">&lt;/p>
&lt;h2 id="程序运行信息">程序运行信息：&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl"> ________________
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">|&lt;/span> Sci-Hub Spider &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ----------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="se">\ &lt;/span> ^__^
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="se">\ &lt;/span> &lt;span class="o">(&lt;/span>oo&lt;span class="o">)&lt;/span>&lt;span class="se">\_&lt;/span>______
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">(&lt;/span>__&lt;span class="o">)&lt;/span>&lt;span class="se">\ &lt;/span> &lt;span class="o">)&lt;/span>&lt;span class="se">\/\-&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">||&lt;/span>----w &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">||&lt;/span> &lt;span class="o">||&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> written by ferstar with love
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">USAGE: copy a DOI or any content that contains a valid DOI and &lt;span class="nb">wait&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BTW: PMID/PMCID/Manuscript ID also supported but not recommended
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Please note that not all papers can be downloaded successfully
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BLOG: https://blog.ferstar.org/post/scihub_spider
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Check the new version of SciHub Spider
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Already the latest version, no need to update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Fetching available sci-hub mirrors
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sci-Hub mirror list updated
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I need to check &lt;span class="k">if&lt;/span> scihub is available locally
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">It may take a few seconds, please &lt;span class="nb">wait&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">check site status &lt;span class="s2">&amp;#34;https://sci-hub***&amp;#34;&lt;/span>...ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">check site status &lt;span class="s2">&amp;#34;https://sci-hub***&amp;#34;&lt;/span>...ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">check site status &lt;span class="s2">&amp;#34;https://sci-hub***&amp;#34;&lt;/span>...ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">check site status &lt;span class="s2">&amp;#34;https://sci-hub***&amp;#34;&lt;/span>...ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">check site status &lt;span class="s2">&amp;#34;https://sci-hub***&amp;#34;&lt;/span>...ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">check site status &lt;span class="s2">&amp;#34;https://sci-hub***&amp;#34;&lt;/span>...ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">check site status &lt;span class="s2">&amp;#34;https://sci-hub***&amp;#34;&lt;/span>...ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ID detected: 29245169, need convert to DOI...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DOI converted: 10.1055/s-0043-122232, fetching...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">try to fetch on &lt;span class="s2">&amp;#34;libgen.***&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Paper found, will download
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Paper title: &lt;span class="o">[&lt;/span>Fehler und Schwchen ...&lt;span class="o">]&lt;/span> found
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>Fehler und Schwchen ...&lt;span class="o">]&lt;/span> download completed 220.59 KB / 220.59 KB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>Fehler und Schwchen ...&lt;span class="o">]&lt;/span> has been saved on you Desktop
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Press enter key to &lt;span class="k">continue&lt;/span> or click the close button to &lt;span class="nb">exit&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="反馈">反馈&lt;/h2>
&lt;p>欢迎加我微信反馈问题!&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/scihub/">SCIHUB</category></item><item><title>解决Windows10移动热点无法设置的问题</title><link>https://blog.ferstar.org/post/%E8%A7%A3%E5%86%B3windows10%E7%A7%BB%E5%8A%A8%E7%83%AD%E7%82%B9%E6%97%A0%E6%B3%95%E8%AE%BE%E7%BD%AE%E7%9A%84%E9%97%AE%E9%A2%98/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E8%A7%A3%E5%86%B3windows10%E7%A7%BB%E5%8A%A8%E7%83%AD%E7%82%B9%E6%97%A0%E6%B3%95%E8%AE%BE%E7%BD%AE%E7%9A%84%E9%97%AE%E9%A2%98/</guid><pubDate>Tue, 12 Dec 2017 14:36:21 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>工作电脑升级网卡驱动后发现移动热点无法打开，于是小看了下配置，貌似是默认配置变了，再改回之——也就是换成&lt;code>Mixed Mode&lt;/code>就欧了。&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/png/2017/12/9f9cd359b7c75953fc06daa7a06587a8.png" alt="微信截图_20171212144034">&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/windows/">WINDOWS</category></item><item><title>SSR被恶意扫描时需要做的事情</title><link>https://blog.ferstar.org/post/ssr%E8%A2%AB%E6%81%B6%E6%84%8F%E6%89%AB%E6%8F%8F%E6%97%B6%E9%9C%80%E8%A6%81%E5%81%9A%E7%9A%84%E4%BA%8B%E6%83%85/</link><guid isPermaLink="true">https://blog.ferstar.org/post/ssr%E8%A2%AB%E6%81%B6%E6%84%8F%E6%89%AB%E6%8F%8F%E6%97%B6%E9%9C%80%E8%A6%81%E5%81%9A%E7%9A%84%E4%BA%8B%E6%83%85/</guid><pubDate>Thu, 07 Sep 2017 14:18:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>直接装一个&lt;code>fail2ban&lt;/code>搞定，不用整下面这些虚的了。&lt;/p>
&lt;hr>
&lt;p>两月前买了个DO5刀的VPS，建了个SSR方便自己爬墙，早上发现连接有点问题，就登录看了下，系统负载正常，不过SSR log显示有不明IP在恶意扫描SSR端口，所以需要着手block掉这些垃圾IP&lt;/p>
&lt;ol>
&lt;li>
&lt;p>查log&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">less /var/log/shadowsocksr.log
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2017-09-06 14:10:03 ERROR tcprelay.py:1093 can not parse header when handling connection from ::ffff:203.94.12.157:64531
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2017-09-06 14:10:03 WARNING common.py:238 unsupported addrtype 69, maybe wrong password or encryption method
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2017-09-06 14:10:03 WARNING tcprelay.py:521 Protocol ERROR, TCP ogn data 474554202f20485454502f312e310d0a0d0a from ::ffff:203.94.12.157:18833 via port &lt;span class="m">443&lt;/span> by UID &lt;span class="m">443&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2017-09-06 14:10:03 ERROR tcprelay.py:1093 can not parse header when handling connection from ::ffff:203.94.12.157:18833
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2017-09-06 14:10:05 WARNING common.py:238 unsupported addrtype 69, maybe wrong password or encryption method
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2017-09-06 14:10:05 WARNING tcprelay.py:521 Protocol ERROR, TCP ogn data 474554202f20485454502f312e310d0a0d0a from ::ffff:203.94.12.157:18915 via port &lt;span class="m">443&lt;/span> by UID &lt;span class="m">443&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2017-09-06 14:10:05 ERROR tcprelay.py:1093 can not parse header when handling connection from ::ffff:203.94.12.157:18915
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2017-09-06 14:11:14 WARNING common.py:238 unsupported addrtype 69, maybe wrong password or encryption method
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2017-09-06 14:11:14 WARNING tcprelay.py:521 Protocol ERROR, TCP ogn data 474554202f20485454502f312e310d0a0d0a from ::ffff:203.94.12.157:32581 via port &lt;span class="m">443&lt;/span> by UID &lt;span class="m">443&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如上，可以看到类似&lt;code>203.94.12.157&lt;/code>这个IP在疯狂的连接，下一步需要把这些IP挑出来&lt;/p>
&lt;/li>
&lt;li>
&lt;p>筛选IP&lt;/p>
&lt;blockquote>
&lt;p>筛选出所有试错的IP，存储到&lt;code>ip_list.txt&lt;/code>文件中&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">grep &lt;span class="s1">&amp;#39;can not parse header&amp;#39;&lt;/span> /var/log/shadowsocksr.log &lt;span class="p">|&lt;/span> awk -F: &lt;span class="s1">&amp;#39;{print $(NF - 1)}&amp;#39;&lt;/span> &amp;gt; ip_list.txt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>查询恶意IP归属地并计数排序&lt;/p>
&lt;p>之前写过&lt;a href="https://blog.ferstar.org/post/%E6%9F%A5%E8%AF%A2%E6%9C%80%E8%BF%91%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AF%86%E7%A0%81%E7%9A%84ip%E5%BD%92%E5%B1%9E%E5%9C%B0/">查询最近暴力破解服务器密码的IP归属地&lt;/a>的脚本，所以直接拿过来用，跑一跑&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>ip&lt;/th>
&lt;th>count&lt;/th>
&lt;th>country&lt;/th>
&lt;th>isp&lt;/th>
&lt;th>area&lt;/th>
&lt;th>region&lt;/th>
&lt;th>city&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>203.94.12.157&lt;/td>
&lt;td>10564&lt;/td>
&lt;td>中国&lt;/td>
&lt;td>电信&lt;/td>
&lt;td>华东&lt;/td>
&lt;td>上海市&lt;/td>
&lt;td>上海市&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>183.131.67.233&lt;/td>
&lt;td>1757&lt;/td>
&lt;td>中国&lt;/td>
&lt;td>电信&lt;/td>
&lt;td>华东&lt;/td>
&lt;td>浙江省&lt;/td>
&lt;td>金华市&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>118.193.31.222&lt;/td>
&lt;td>311&lt;/td>
&lt;td>中国&lt;/td>
&lt;td>&lt;/td>
&lt;td>华中&lt;/td>
&lt;td>河南省&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>50.123.186.209&lt;/td>
&lt;td>123&lt;/td>
&lt;td>美国&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>可以看到扫描次数在三位数以上的IP有4个&lt;/p>
&lt;/li>
&lt;li>
&lt;p>iptables ban之&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">iptables -I INPUT -s 203.94.0.0/16 -j DROP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -I INPUT -s 183.131.0.0/16 -j DROP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -I INPUT -s 118.193.0.0/16 -j DROP
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>iptables的常见用法&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">linux下使用iptables封ip段的一些常见命令：
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">封单个IP的命令是：
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -I INPUT -s 211.1.0.0 -j DROP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">封IP段的命令是：
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -I INPUT -s 211.1.0.0/16 -j DROP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -I INPUT -s 211.2.0.0/16 -j DROP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -I INPUT -s 211.3.0.0/16 -j DROP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">封整个段的命令是：
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -I INPUT -s 211.0.0.0/8 -j DROP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">封几个段的命令是：
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -I INPUT -s 61.37.80.0/24 -j DROP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -I INPUT -s 61.37.81.0/24 -j DROP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">解封的话：
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -D INPUT -s IP地址 -j REJECT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -F 全清掉了
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">如果想开机就自动封锁某个IP，那就编辑/etc/sysconfig/iptables文件，添加一行
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-I INPUT -s IP地址 -j DROP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">然后执行/etc/init.d/iptables restart重启iptables
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>​&lt;/p>
&lt;/li>
&lt;/ol></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/iptables/">IPTABLES</category></item><item><title>啃一啃SICP</title><link>https://blog.ferstar.org/post/%E5%95%83%E4%B8%80%E5%95%83sicp/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E5%95%83%E4%B8%80%E5%95%83sicp/</guid><pubDate>Fri, 25 Aug 2017 13:13:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;h2 id="中文or原版">中文or原版?&lt;/h2>
&lt;p>中文翻译质量一般, 甚至有些练习题连题干都没翻译全, 所以建议慢慢啃原版&lt;/p>
&lt;p>这个网站提供制作精美的电子书版本&lt;/p>
&lt;p>&lt;a href="https://sicpebook.wordpress.com/">https://sicpebook.wordpress.com/&lt;/a>&lt;/p>
&lt;p>我在百度云存了一份, 方便你我他&lt;/p>
&lt;blockquote>
&lt;p>链接: &lt;a href="https://pan.baidu.com/s/1geUJpRH">https://pan.baidu.com/s/1geUJpRH&lt;/a> 密码: ebck&lt;/p>
&lt;/blockquote>
&lt;p>&lt;strong>How to get Scheme&lt;/strong>: via &lt;a href="http://www.gnu.org/software/mit-scheme/">http://www.gnu.org/software/mit-scheme/&lt;/a>&lt;/p>
&lt;p>MIT Scheme用着不是很爽, 于是有了下面的折腾&lt;/p>
&lt;h2 id="配置sublime3">配置sublime3&lt;/h2>
&lt;p>via &lt;a href="http://www.sublimetext.com/3">http://www.sublimetext.com/3&lt;/a>&lt;/p>
&lt;h3 id="注册信息">注册信息&lt;/h3>
&lt;blockquote>
&lt;p>v3126、v3124、v3124、v3114、 v3103可用&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">—– BEGIN LICENSE —–
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Ryan Clark
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Single User License
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">EA7E-812479
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2158A7DE B690A7A3 8EC04710 006A5EEB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">34E77CA3 9C82C81F 0DB6371B 79704E6F
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">93F36655 B031503A 03257CCC 01B20F60
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">D304FA8D B1B4F0AF 8A76C7BA 0FA94D55
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">56D46BCE 5237A341 CD837F30 4D60772D
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">349B1179 A996F826 90CDB73C 24D41245
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">FD032C30 AD5E7241 4EAA66ED 167D91FB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">55896B16 EA125C81 F550AF6B A6820916
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">—— END LICENSE ——
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="安装插件">安装插件&lt;/h3>
&lt;p>按Ctrl+`调出console，输入&lt;/p>
&lt;p>&lt;code>import urllib.request,os; pf = 'Package Control.sublime-package'; ipp = sublime.installed_packages_path(); urllib.request.install_opener( urllib.request.build_opener( urllib.request.ProxyHandler()) ); open(os.path.join(ipp, pf), 'wb').write(urllib.request.urlopen( 'http://sublime.wbond.net/' + pf.replace(' ','%20')).read())&lt;/code>&lt;/p>
&lt;p>重启Sublime Text 3，如果在Perferences-&amp;gt;package settings中看到package control这一项，则安装成功。按下Ctrl+Shift+P调出命令面板输入install 调出 Install Package 选项并回车，然后在列表中选中要安装的插件。&lt;/p>
&lt;h3 id="折腾scheme插件">折腾Scheme插件&lt;/h3>
&lt;p>via &lt;a href="https://notechsolution.github.io/2017/01/03/How-To-Config-SublimeREPL-for-Scheme/">How To Config SublimeREPL for Scheme&lt;/a>&lt;/p>
&lt;ol>
&lt;li>Install LISP scheme interpreter - &lt;a href="http://people.csail.mit.edu/jaffer/SCM.html">SCM&lt;/a>. there are several interpreter for scheme - DrRacket, MIT-Scheme. but SCM may be the easist one to integrate with Sublime.&lt;/li>
&lt;li>Add scm bin folder into your system path. e.g.&lt;code>set PATH = %PATH%; C:\Program Files (x86)\scm\&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>then verify it using command line&lt;/p>
&lt;pre tabindex="0">&lt;code>C:\Users\Administrator&amp;gt;scm
SCM version 5f2, Copyright (C) 1990-2006 Free Software Foundation.
SCM comes with ABSOLUTELY NO WARRANTY; for details type (terms).
This is free software, and you are welcome to redistribute it
under certain conditions; type (terms) for details.
;loading C:\Program Files (x86)\slib\require
;done loading C:\Program Files (x86)\slib\require.scm
;loading C:\Program Files (x86)\scm\Transcen
;done loading C:\Program Files (x86)\scm\Transcen.scm
&lt;/code>&lt;/pre>&lt;h3 id="repl-installation-in-sublime-text-3">REPL installation in Sublime Text 3&lt;/h3>
&lt;ol>
&lt;li>
&lt;p>Open the package installation of Sublime Text, if not install yet, plz try Tools -&amp;gt; Install Package Control&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Install Package “Scheme”&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Install Package “SublimeREPL”&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Then, open Preferences -&amp;gt; Browse Packages -&amp;gt; SublimeREPL -&amp;gt; config -&amp;gt; Scheme -&amp;gt; Main.sublime-menu, edit the section with the “id”: “repl_scheme” :&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;#34;windows&amp;#34;: [&amp;#34;scm&amp;#34;, &amp;#34;-f&amp;#34;, &amp;#34;$file_basename&amp;#34;]}
&lt;/code>&lt;/pre>&lt;/li>
&lt;li>
&lt;p>Save and restart Sublime Text, choose the target file, Open Tools -&amp;gt; Build System, you may find “Scheme” is auto selected. if not, plz choose “Scheme”&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Try build/run the file via Tools -&amp;gt; Build&lt;/p>
&lt;/li>
&lt;li>
&lt;p>If you meet error like &lt;strong>“File Not Find”, [“gsi”,”-:d-“,”your-file-path”]&lt;/strong>, it may be caused that your configuration are override by Scheme package. then you may go to C:\Users\Adminstrator\AppData\Roaming\Sublime Text 3\Installed Packages, find the scheme package “Scheme.sublime-package”, unzip it and modify the startup command line in the file “Scheme.sublime-build”, change it to :&lt;/p>
&lt;/li>
&lt;/ol>
&lt;pre tabindex="0">&lt;code>{
&amp;#34;cmd&amp;#34;: [&amp;#34;scm&amp;#34;, &amp;#34;-f&amp;#34;, &amp;#34;$file&amp;#34;],
&amp;#34;file_regex&amp;#34;: &amp;#34;^[ ]*File \&amp;#34;(...*?)\&amp;#34;, line ([0-9]*)&amp;#34;,
&amp;#34;selector&amp;#34;: &amp;#34;source.scheme&amp;#34;
}
&lt;/code>&lt;/pre>&lt;h2 id="转向drracket">转向DrRacket&lt;/h2>
&lt;p>&lt;a href="http://www.neilvandyke.org/racket/sicp/">SICP Support for DrRacket&lt;/a>&lt;/p>
&lt;p>总结起来就两步:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>下载安装DrRacket&lt;/p>
&lt;/li>
&lt;li>
&lt;h3 id="lang-planet-neilsicp">&lt;code>#lang planet neil/sicp&lt;/code>&lt;/h3>
&lt;/li>
&lt;/ol>
&lt;p>然后就可以愉快的练习&lt;code>SICP&lt;/code>了&lt;/p>
&lt;h2 id="习题解答记录">习题解答记录&lt;/h2>
&lt;h3 id="11">1.1&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lisp" data-lang="lisp">&lt;span class="line">&lt;span class="cl">&lt;span class="mi">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nf">+&lt;/span> &lt;span class="mi">5&lt;/span> &lt;span class="mi">3&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nf">-&lt;/span> &lt;span class="mi">9&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nf">/&lt;/span> &lt;span class="mi">6&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nf">+&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">*&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">-&lt;/span> &lt;span class="mi">4&lt;/span> &lt;span class="mi">6&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="nv">a&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="nv">b&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">+&lt;/span> &lt;span class="nv">a&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nf">+&lt;/span> &lt;span class="nv">a&lt;/span> &lt;span class="nv">b&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">*&lt;/span> &lt;span class="nv">a&lt;/span> &lt;span class="nv">b&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nf">=&lt;/span> &lt;span class="nv">a&lt;/span> &lt;span class="nv">b&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">and&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="nv">b&lt;/span> &lt;span class="nv">a&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">&amp;lt;&lt;/span> &lt;span class="nv">b&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">*&lt;/span> &lt;span class="nv">a&lt;/span> &lt;span class="nv">b&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">b&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">a&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">cond&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="nf">=&lt;/span> &lt;span class="nv">a&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="mi">6&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">((&lt;/span>&lt;span class="nf">=&lt;/span> &lt;span class="nv">b&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">+&lt;/span> &lt;span class="mi">6&lt;/span> &lt;span class="mi">7&lt;/span> &lt;span class="nv">a&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">else&lt;/span> &lt;span class="mi">25&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nf">+&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="nv">b&lt;/span> &lt;span class="nv">a&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nv">b&lt;/span> &lt;span class="nv">a&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nf">*&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">cond&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="nv">a&lt;/span> &lt;span class="nv">b&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nv">a&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">((&lt;/span>&lt;span class="nf">&amp;lt;&lt;/span> &lt;span class="nv">a&lt;/span> &lt;span class="nv">b&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nv">b&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">else&lt;/span> &lt;span class="mi">-1&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nf">+&lt;/span> &lt;span class="nv">a&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 解释器依次输入即可&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="12">1.2&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lisp" data-lang="lisp">&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nf">/&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">+&lt;/span> &lt;span class="mi">5&lt;/span> &lt;span class="mi">4&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nf">-&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nf">-&lt;/span> &lt;span class="mi">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nf">+&lt;/span> &lt;span class="mi">6&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nf">/&lt;/span> &lt;span class="mi">4&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">)))))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nf">*&lt;/span> &lt;span class="mi">3&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">-&lt;/span> &lt;span class="mi">6&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">-&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; -246.66666666666667e-3 or -37/150&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="13">1.3&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lisp" data-lang="lisp">&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">ex1.3&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="nv">y&lt;/span> &lt;span class="nv">z&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">sum&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">sqr&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">first&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="nv">y&lt;/span> &lt;span class="nv">z&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">sqr&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">second&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="nv">y&lt;/span> &lt;span class="nv">z&lt;/span>&lt;span class="p">))))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; max No.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">first&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="nv">y&lt;/span> &lt;span class="nv">z&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nb">cond&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="nb">and&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">&amp;gt;=&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="nv">y&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">&amp;gt;=&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="nv">z&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">((&lt;/span>&lt;span class="nb">and&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">&amp;gt;=&lt;/span> &lt;span class="nv">y&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">&amp;gt;=&lt;/span> &lt;span class="nv">y&lt;/span> &lt;span class="nv">z&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="nv">y&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">else&lt;/span> &lt;span class="nv">z&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; second No.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">second&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="nv">y&lt;/span> &lt;span class="nv">z&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nb">cond&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="nb">or&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">and&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">&amp;lt;=&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="nv">y&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">&amp;gt;=&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="nv">z&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nb">and&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">&amp;gt;=&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="nv">y&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">&amp;lt;=&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="nv">z&lt;/span>&lt;span class="p">)))&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">((&lt;/span>&lt;span class="nb">or&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">and&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">&amp;lt;=&lt;/span> &lt;span class="nv">y&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">&amp;gt;=&lt;/span> &lt;span class="nv">y&lt;/span> &lt;span class="nv">z&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nb">and&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">&amp;gt;=&lt;/span> &lt;span class="nv">y&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">&amp;lt;=&lt;/span> &lt;span class="nv">y&lt;/span> &lt;span class="nv">z&lt;/span>&lt;span class="p">)))&lt;/span> &lt;span class="nv">y&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">else&lt;/span> &lt;span class="nv">z&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; squares&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">sqr&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nf">*&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; sum&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">sum&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="nv">y&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nf">+&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="nv">y&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">ex1.3&lt;/span> &lt;span class="mi">3&lt;/span> &lt;span class="mi">4&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="mi">41&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="14">1.4&lt;/h3>
&lt;p>高阶函数的例子:&lt;/p>
&lt;p>在&lt;code>if&lt;/code>判断部分, 根据&lt;code>b&lt;/code>的值确定返回&lt;code>+&lt;/code>还是&lt;code>-&lt;/code>, 当&lt;code>b &amp;gt; 0&lt;/code>时返回&lt;code>+&lt;/code>, 其余返回&lt;code>-&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lisp" data-lang="lisp">&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">a-plus-abs-a-b&lt;/span> &lt;span class="nv">a&lt;/span> &lt;span class="nv">b&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">((&lt;/span>&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="nv">b&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">+&lt;/span> &lt;span class="nf">-&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nv">a&lt;/span> &lt;span class="nv">b&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">a-plus-abs-a-b&lt;/span> &lt;span class="mi">4&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mi">5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">a-plus-abs-a-b&lt;/span> &lt;span class="mi">4&lt;/span> &lt;span class="mi">-1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mi">5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">a-plus-abs-a-b&lt;/span> &lt;span class="mi">4&lt;/span> &lt;span class="mi">-4&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mi">8&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="15">1.5&lt;/h3>
&lt;ol>
&lt;li>应用序: 先求值参数而后应用&lt;/li>
&lt;li>正则序: 完全展开而后规约&lt;/li>
&lt;/ol>
&lt;p>&lt;code>(define (p) (p))&lt;/code>中不论解释器使用何种求值方式, 调用&lt;code>(p)&lt;/code>肯定进入无限循环, 函数&lt;code>p&lt;/code>会不断调用自身&lt;/p>
&lt;p>在应用序中所有被传入的实际参数都会被立即求值, 因此执行&lt;code>(define (test x y) (if (= x 0) 0 y))&lt;/code>时, 实际参数&lt;code>0&lt;/code>和&lt;code>p&lt;/code>都会被立即求值, 而对&lt;code>p&lt;/code>求值则会使采用应用序求值模式的解释器进入无限循环&lt;/p>
&lt;p>不过在正则序中, 传入的实际参数只有在用到的时候才会被求值, 类似&lt;code>Python&lt;/code>中的惰性求值, 所以运行&lt;code>(test 0 (p)&lt;/code>时, &lt;code>if&lt;/code>返回值为&lt;code>#t&lt;/code>, 而这个值又作为&lt;code>test&lt;/code>函数的值被返回, 即在正则序求值中, 调用&lt;code>(p)&lt;/code>从始至终都没有被执行, 所以不会产生无限循环, 并且会正常返回&lt;code>0&lt;/code>, 也就说明该解释器使用的是正则序求值模式&lt;/p>
&lt;blockquote>
&lt;p>形参和实参:&lt;/p>
&lt;p>对于一个函数来说, 他接受的参数的局部名称被称为形式参数. 而电泳函数时传入的表达式, 被称为实际参数.&lt;/p>
&lt;p>通常人们说的参数一般是指形参&lt;/p>
&lt;/blockquote>
&lt;h3 id="117-采用牛顿法求平方根">1.1.7 采用牛顿法求平方根&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lisp" data-lang="lisp">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 绝对值计算&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">abs&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">-&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 平均值计算&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">average&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="nv">y&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nf">/&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">+&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="nv">y&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 取猜测值 (y x / y) / 2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">improve&lt;/span> &lt;span class="nv">guess&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">average&lt;/span> &lt;span class="nv">guess&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">/&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="nv">guess&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 结果是否足够好?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 猜测值平方后误差小于 0.001 即可认为足够好, 返回真&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">good-enough?&lt;/span> &lt;span class="nv">guess&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nf">&amp;lt;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">abs&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">-&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">square&lt;/span> &lt;span class="nv">guess&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="mf">0.001&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 求平方&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">square&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">*&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 求平方根(迭代)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">sqrt-iter&lt;/span> &lt;span class="nv">guess&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">good-enough?&lt;/span> &lt;span class="nv">guess&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">guess&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">sqrt-iter&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">improve&lt;/span> &lt;span class="nv">guess&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; partial func(给定初始值为1.0)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; MIT Scheme区分精确的整数和十进制数值, 两个整数的商是一个有理式而不是十进制数&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">sqrt&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">sqrt-iter&lt;/span> &lt;span class="mf">1.0&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">sqrt&lt;/span> &lt;span class="mi">16&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mf">4.000000636692939&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">sqrt&lt;/span> &lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mf">11.313708502161349&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">sqrt&lt;/span> &lt;span class="mi">256&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mf">16.00000352670594&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="16">1.6&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lisp" data-lang="lisp">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; Alyssa的new-if定义&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">new-if&lt;/span> &lt;span class="nv">predicate&lt;/span> &lt;span class="nv">then-clause&lt;/span> &lt;span class="nv">else-clause&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nb">cond&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">predicate&lt;/span> &lt;span class="nv">then-clause&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">else&lt;/span> &lt;span class="nv">else-clause&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 重写求平方根过程&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">sqrt-iter&lt;/span> &lt;span class="nv">guess&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">new-if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">good-enough?&lt;/span> &lt;span class="nv">guess&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">guess&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">sqrt-iter&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">improve&lt;/span> &lt;span class="nv">guess&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 这里可能碰到如下错误&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; define-values: assignment disallowed; cannot re-define a constant constant: sqrt-iter&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 解决方法 Choose Language --&amp;gt; uncheck Enforce constant definitions.&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/png/2017/8/0dcfe8c59dfe42ca08ae8b2d945c9447.png" alt="微信截图_20170825141550">&lt;/p>
&lt;p>重写&lt;code>sqrt&lt;/code>后运行会报错:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">The evaluation thread is no longer running, so no evaluation can take place &lt;span class="k">until&lt;/span> the next execution.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">The program ran out of memory.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>出错原因就在新定义的&lt;code>new-if&lt;/code>函数只是一个普通函数, 根据解释器使用的应用序求值规则, 每个函数的实际参数在传入的时候都会被求值, 所以调用&lt;code>new-if&lt;/code>函数时, 不论条件是真是假, 两个分支都会执行求值, 所以很快会突破解释器最大递归深度, 报OOM错误&lt;/p>
&lt;h3 id="17">1.7&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lisp" data-lang="lisp">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 对于特别小的数, sqrt函数并不能计算出正确的答案, 对于特别大的数, sqrt会陷入死循环&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 绝对值计算&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">abs&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">-&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 平均值计算&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">average&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="nv">y&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nf">/&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">+&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="nv">y&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 取猜测值 (y x / y) / 2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">improve&lt;/span> &lt;span class="nv">guess&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">average&lt;/span> &lt;span class="nv">guess&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">/&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="nv">guess&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 结果是否足够好?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 下次猜测值变化低于百分之一时认为足够好, 返回真&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">good-enough?&lt;/span> &lt;span class="nv">old&lt;/span> &lt;span class="nv">new&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="mf">0.01&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nf">/&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">abs&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">-&lt;/span> &lt;span class="nv">new&lt;/span> &lt;span class="nv">old&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="nv">old&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 求平方&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">square&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">*&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 求平方根(迭代)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">sqrt-iter&lt;/span> &lt;span class="nv">guess&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">good-enough?&lt;/span> &lt;span class="nv">guess&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">improve&lt;/span> &lt;span class="nv">guess&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">improve&lt;/span> &lt;span class="nv">guess&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">sqrt-iter&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">improve&lt;/span> &lt;span class="nv">guess&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; partial func(给定初始值为1.0)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; MIT Scheme区分精确的整数和十进制数值, 两个整数的商是一个有理式而不是十进制数&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">sqrt&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">sqrt-iter&lt;/span> &lt;span class="mf">1.0&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="18">1.8&lt;/h3>
&lt;p>只需要重写&lt;code>improve&lt;/code>函数即可&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lisp" data-lang="lisp">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 其中guess相当于近似值公式中的y&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">improve&lt;/span> &lt;span class="nv">guess&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nf">/&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">+&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">/&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">square&lt;/span> &lt;span class="nv">guess&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">*&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="nv">guess&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 其他判断都不需要改, sqrt已经成了求立方根的函数&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">sqrt&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mf">2.000004911675504&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">sqrt&lt;/span> &lt;span class="mi">27&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mf">3.0000005410641766&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">sqrt&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">*&lt;/span> &lt;span class="mi">8&lt;/span> &lt;span class="mi">8&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mf">8.0005181503155&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="118-内部定义和块结构">1.1.8 内部定义和块结构&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lisp" data-lang="lisp">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 过程抽象为黑盒操作&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 外部调用只关心sqrt即可&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 块结构思想&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">sqrt&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">good-enough?&lt;/span> &lt;span class="nv">old&lt;/span> &lt;span class="nv">new&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="mf">0.01&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nf">/&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">abs&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">-&lt;/span> &lt;span class="nv">new&lt;/span> &lt;span class="nv">old&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="nv">old&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">improve&lt;/span> &lt;span class="nv">guess&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">average&lt;/span> &lt;span class="nv">guess&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">/&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="nv">guess&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">sqrt-iter&lt;/span> &lt;span class="nv">guess&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">good-enough?&lt;/span> &lt;span class="nv">guess&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">improve&lt;/span> &lt;span class="nv">guess&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">improve&lt;/span> &lt;span class="nv">guess&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">sqrt-iter&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">improve&lt;/span> &lt;span class="nv">guess&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">sqrt-iter&lt;/span> &lt;span class="mf">1.0&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">sqrt&lt;/span> &lt;span class="mi">9&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mf">3.00009155413138&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="121-线性的递归和迭代">1.2.1 线性的递归和迭代&lt;/h3>
&lt;blockquote>
&lt;p>若这个函数在&lt;strong>尾&lt;/strong>位置调用本身（或是一个&lt;strong>尾&lt;/strong>调用本身的其他函数等等），则称这种情况为&lt;strong>尾递归&lt;/strong>，是&lt;strong>递归&lt;/strong>的一种特殊情形。 &lt;strong>尾&lt;/strong>调用不一定是&lt;strong>递归&lt;/strong>调用，但是&lt;strong>尾递归&lt;/strong>特别有用，也比较容易实现。 &lt;strong>尾&lt;/strong>调用的重要性在于它可以不在调用栈上面添加一个新的堆栈帧——而是更新它，如同迭代一般。&lt;/p>
&lt;p>via &lt;a href="https://www.google.com.hk/url?sa=t&amp;amp;rct=j&amp;amp;q=&amp;amp;esrc=s&amp;amp;source=web&amp;amp;cd=2&amp;amp;cad=rja&amp;amp;uact=8&amp;amp;ved=0ahUKEwiW6Ivo8fHVAhUE2WMKHUXWDPUQFggoMAE&amp;amp;url=https%3A%2F%2Fzh.wikipedia.org%2Fzh-hans%2F%25E5%25B0%25BE%25E8%25B0%2583%25E7%2594%25A8&amp;amp;usg=AFQjCNF0r7nIoHwoQOH1yqSWtk-TDDSX1w">尾调用- 维基百科，自由的百科全书&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lisp" data-lang="lisp">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 阶乘&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; fact(n) = n * fact(n - 1)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 线性递归过程&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">factorial&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">=&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nf">*&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">factorial&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">-&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)))))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 重构 1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; fact(n) = 1 * 2 * 3 ... * (n - 1) * n&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; product &amp;lt;-- counter * product&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; counter &amp;lt;-- counter + 1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 线性迭代过程&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">factorial&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">fact-iter&lt;/span> &lt;span class="nv">product&lt;/span> &lt;span class="nv">counter&lt;/span> &lt;span class="nv">max-count&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="nv">counter&lt;/span> &lt;span class="nv">max-count&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">product&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">fact-iter&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">*&lt;/span> &lt;span class="nv">counter&lt;/span> &lt;span class="nv">product&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nf">+&lt;/span> &lt;span class="nv">counter&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">max-count&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">fact-iter&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="nv">x&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 重构 2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; fact(n) = n * (n - 1) * ... * 3 * 2 * 1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; p初始值为1, 首次迭代保存n, 第二次迭代保存n * (n - 1), 直到n = 1, 此时p即n!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">factorial&lt;/span> &lt;span class="nv">n&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">fact-iter&lt;/span> &lt;span class="nv">p&lt;/span> &lt;span class="nv">n&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">=&lt;/span> &lt;span class="nv">n&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">p&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">fact-iter&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">*&lt;/span> &lt;span class="nv">p&lt;/span> &lt;span class="nv">n&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">-&lt;/span> &lt;span class="nv">n&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">))))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">fact-iter&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="nv">n&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="19">1.9&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lisp" data-lang="lisp">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 线性递归过程&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">plus&lt;/span> &lt;span class="nv">a&lt;/span> &lt;span class="nv">b&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">=&lt;/span> &lt;span class="nv">a&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">b&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">inc&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">plus&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">dec&lt;/span> &lt;span class="nv">a&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nv">b&lt;/span>&lt;span class="p">))))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">plus&lt;/span> &lt;span class="mi">4&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">inc&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">plus&lt;/span> &lt;span class="mi">3&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">inc&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">inc&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">plus&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">inc&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">inc&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">inc&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">plus&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">))))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">inc&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">inc&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">inc&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">inc&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">plus&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">)))))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">inc&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">inc&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">inc&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">inc&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">))))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">inc&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">inc&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">inc&lt;/span> &lt;span class="mi">6&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">inc&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">inc&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">inc&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mi">9&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 从计算过程明显可以看到伸展和收缩两个阶段, 且伸展阶段所需要的额外存储量和计算所需的步数都与参数a正相关&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 是一个线性递归计算过程(recursive)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 线性迭代过程&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">plus&lt;/span> &lt;span class="nv">a&lt;/span> &lt;span class="nv">b&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">=&lt;/span> &lt;span class="nv">a&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">b&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">plus&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">dec&lt;/span> &lt;span class="nv">a&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">inc&lt;/span> &lt;span class="nv">b&lt;/span>&lt;span class="p">))))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">plus&lt;/span> &lt;span class="mi">4&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">plus&lt;/span> &lt;span class="mi">3&lt;/span> &lt;span class="mi">6&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">plus&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">plus&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">plus&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">9&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mi">9&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 计算过程仅适用敞亮存储空间, 且计算步骤与参数a正相关, 说明是一个线性迭代计算过程(iterative)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="110">1.10&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lisp" data-lang="lisp">&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">A&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="nv">y&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nb">cond&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="nf">=&lt;/span> &lt;span class="nv">y&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">((&lt;/span>&lt;span class="nf">=&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">*&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="nv">y&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">((&lt;/span>&lt;span class="nf">=&lt;/span> &lt;span class="nv">y&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">else&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">A&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">-&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">A&lt;/span> &lt;span class="nv">x&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">-&lt;/span> &lt;span class="nv">y&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">))))))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>见 &lt;a href="http://sicp.readthedocs.io/en/latest/chp1/10.html">http://sicp.readthedocs.io/en/latest/chp1/10.html&lt;/a>&lt;/p>
&lt;h3 id="122-树形递归">1.2.2 树形递归&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lisp" data-lang="lisp">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 斐波那契数列&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 树形递归&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">fib&lt;/span> &lt;span class="nv">n&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nb">cond&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="nf">=&lt;/span> &lt;span class="nv">n&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">((&lt;/span>&lt;span class="nf">=&lt;/span> &lt;span class="nv">n&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">else&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">+&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">fib&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">-&lt;/span> &lt;span class="nv">n&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">fib&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">-&lt;/span> &lt;span class="nv">n&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">))))))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 线性迭代&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">fib&lt;/span> &lt;span class="nv">n&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">fib-iter&lt;/span> &lt;span class="nv">a&lt;/span> &lt;span class="nv">b&lt;/span> &lt;span class="nf">count&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">=&lt;/span> &lt;span class="nf">count&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">a&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">fib-iter&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">+&lt;/span> &lt;span class="nv">a&lt;/span> &lt;span class="nv">b&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nv">a&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">-&lt;/span> &lt;span class="nf">count&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">))))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">fib-iter&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="nv">n&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="换零钱方式的统计">换零钱方式的统计&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lisp" data-lang="lisp">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 兑换零钱方法&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">count-change&lt;/span> &lt;span class="nv">amount&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">cc&lt;/span> &lt;span class="nv">amount&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 可用的硬币种数作为输入, 返回第一种硬币币值(从大到小排列)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">first-denomination&lt;/span> &lt;span class="nv">kinds-of-coins&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nb">cond&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="nf">=&lt;/span> &lt;span class="nv">kinds-of-coins&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">((&lt;/span>&lt;span class="nf">=&lt;/span> &lt;span class="nv">kinds-of-coins&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">((&lt;/span>&lt;span class="nf">=&lt;/span> &lt;span class="nv">kinds-of-coins&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">((&lt;/span>&lt;span class="nf">=&lt;/span> &lt;span class="nv">kinds-of-coins&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="mi">25&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">((&lt;/span>&lt;span class="nf">=&lt;/span> &lt;span class="nv">kinds-of-coins&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="mi">50&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 计算&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">cc&lt;/span> &lt;span class="nv">amount&lt;/span> &lt;span class="nv">kinds-of-coins&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nb">cond&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="nf">=&lt;/span> &lt;span class="nv">amount&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">((&lt;/span>&lt;span class="nb">or&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">&amp;lt;&lt;/span> &lt;span class="nv">amount&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">=&lt;/span> &lt;span class="nv">kinds-of-coins&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">else&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">+&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">cc&lt;/span> &lt;span class="nv">amount&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nf">-&lt;/span> &lt;span class="nv">kinds-of-coins&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">cc&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">-&lt;/span> &lt;span class="nv">amount&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">first-denomination&lt;/span> &lt;span class="nv">kinds-of-coins&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">kinds-of-coins&lt;/span>&lt;span class="p">)))))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">count-change&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mi">292&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="111">1.11&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lisp" data-lang="lisp">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 线性递归&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">f&lt;/span> &lt;span class="nv">n&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">&amp;lt;&lt;/span> &lt;span class="nv">n&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">n&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nf">+&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">f&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">-&lt;/span> &lt;span class="nv">n&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">f&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">-&lt;/span> &lt;span class="nv">n&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">f&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">-&lt;/span> &lt;span class="nv">n&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)))))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 线性迭代&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; 初始条件: f(0) = 0, f(1) = 1, f(2) = 2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; i = (n - 1): f(n - 3) = a, f(n - 2) = b, f(n - 1) = c&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; i = n: f(n - 2) = b, f(n - 1) = c, f(n) = 3a + 2b + c&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">f&lt;/span> &lt;span class="nv">n&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">f-iter&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="nv">n&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">f-iter&lt;/span> &lt;span class="nv">a&lt;/span> &lt;span class="nv">b&lt;/span> &lt;span class="nv">c&lt;/span> &lt;span class="nv">n&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nb">cond&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="nf">&amp;lt;&lt;/span> &lt;span class="nv">n&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nv">n&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">; 负数&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">((&lt;/span>&lt;span class="nf">=&lt;/span> &lt;span class="nv">n&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nv">a&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">((&lt;/span>&lt;span class="nf">=&lt;/span> &lt;span class="nv">n&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nv">b&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">((&lt;/span>&lt;span class="nf">=&lt;/span> &lt;span class="nv">n&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nv">c&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">else&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">f-iter&lt;/span> &lt;span class="nv">b&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">c&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nf">+&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">*&lt;/span> &lt;span class="nv">a&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">*&lt;/span> &lt;span class="nv">b&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nv">c&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nf">-&lt;/span> &lt;span class="nv">n&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)))))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">;; test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">f&lt;/span> &lt;span class="mi">-1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mi">-1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">f&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">f&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">f&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">f&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mi">4&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">&amp;gt;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">f&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">; 线性递归会卡死&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mi">11937765839880230562825561449279733086&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="112-帕斯卡三角形">1.12 帕斯卡三角形&lt;/h3>
&lt;p>中文版翻译有误, 应该是给出帕斯卡三角形任意元素的计算方法&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">row:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">0&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">1&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">2&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">3&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">3&lt;/span> &lt;span class="m">3&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">4&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">4&lt;/span> &lt;span class="m">6&lt;/span> &lt;span class="m">4&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">5&lt;/span> . . . . . .
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">col: &lt;span class="m">0&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">3&lt;/span> &lt;span class="m">4&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如果使用p(r, c)来代表r行c列上元素的值, 可以得出三个性质:&lt;/p>
&lt;ol>
&lt;li>p(r, c) = p(r - 1, c - 1) + p(r -1, c) 即每个元素的值都由左上和右上元素的和组成&lt;/li>
&lt;li>p(r, 0) or p(x, x) = 1 即最左边元素(c = 0)或最右边元素(r = c)值为1&lt;/li>
&lt;li>列数不能多于行数&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lisp" data-lang="lisp">&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nv">define&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">pascal&lt;/span> &lt;span class="nv">row&lt;/span> &lt;span class="nv">col&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nb">cond&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="nf">&amp;lt;&lt;/span> &lt;span class="nv">row&lt;/span> &lt;span class="nv">col&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">display&lt;/span> &lt;span class="s">&amp;#34;invalid row col values&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">((&lt;/span>&lt;span class="nb">or&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">=&lt;/span> &lt;span class="nv">col&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">=&lt;/span> &lt;span class="nv">row&lt;/span> &lt;span class="nv">col&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">else&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">+&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">pascal&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">-&lt;/span> &lt;span class="nv">row&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">-&lt;/span> &lt;span class="nv">col&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nv">pascal&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">-&lt;/span> &lt;span class="nv">row&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nv">col&lt;/span>&lt;span class="p">)))))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="113-原题翻译有误-需要看英文原版">1.13 原题翻译有误, 需要看英文原版&lt;/h3>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/png/2017/8/3ef5b133b00aef6adfb60e74d7f5a73a.png" alt="微信截图_20170827172527">&lt;/p>
&lt;p>这个原题翻译有问题, 需要看英文原版&lt;/p>
&lt;h3 id="114-增长的阶">1.14 增长的阶&lt;/h3>
&lt;blockquote>
&lt;p>绘制(count-change 11)在展开时的过程, 只手撸了部分...&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/jpg/2017/9/43c93eba6fcc96cc9bc9212f1b1f333a.jpg" alt="微信图片_20170905114253">&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/sicp/">SICP</category><category domain="https://blog.ferstar.org/tags/lisp/">LISP</category><category domain="https://blog.ferstar.org/tags/scheme/">SCHEME</category><category domain="https://blog.ferstar.org/tags/sublime/">SUBLIME</category></item><item><title>在Markdown中优雅的插入图片</title><link>https://blog.ferstar.org/post/%E5%9C%A8markdown%E4%B8%AD%E4%BC%98%E9%9B%85%E7%9A%84%E6%8F%92%E5%85%A5%E5%9B%BE%E7%89%87/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E5%9C%A8markdown%E4%B8%AD%E4%BC%98%E9%9B%85%E7%9A%84%E6%8F%92%E5%85%A5%E5%9B%BE%E7%89%87/</guid><pubDate>Thu, 24 Aug 2017 17:32:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>基本上御用md编辑器就是Typora了, 表格编辑简直不要太赞, 图片插入也是极其的方便. 那么如何优雅的在MD中插入图片呢?&lt;/p>
&lt;p>抄抄改改整了个利用七牛云做图床的脚本, 用起来还是蛮方便的说&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;span class="lnt">76
&lt;/span>&lt;span class="lnt">77
&lt;/span>&lt;span class="lnt">78
&lt;/span>&lt;span class="lnt">79
&lt;/span>&lt;span class="lnt">80
&lt;/span>&lt;span class="lnt">81
&lt;/span>&lt;span class="lnt">82
&lt;/span>&lt;span class="lnt">83
&lt;/span>&lt;span class="lnt">84
&lt;/span>&lt;span class="lnt">85
&lt;/span>&lt;span class="lnt">86
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="ch">#!/usr/bin/env python3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">configparser&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">datetime&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">hashlib&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">os&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">platform&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">sys&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">time&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">urllib&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">mimetypes&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">MimeTypes&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">pyperclip&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">qiniu&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">watchdog.events&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">PatternMatchingEventHandler&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">watchdog.observers&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">Observer&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">config&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">configparser&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ConfigParser&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">dirname&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">abspath&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="vm">__file__&lt;/span>&lt;span class="p">)),&lt;/span> &lt;span class="s1">&amp;#39;qiniu.cfg&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">bucket&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;config&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;bucket&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ak&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;config&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;accessKey&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">sk&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;config&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;secretKey&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">path_to_watch&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;config&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;path_to_watch&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">fallback&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;.&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">addr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;config&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;addr&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">style&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;config&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;style&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">fallback&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># 图片样式&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">mime&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">MimeTypes&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">now&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">MyHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">PatternMatchingEventHandler&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">patterns&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;*.jpeg&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;*.jpg&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;*.png&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;*.bmp&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;*.gif&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;*.tiff&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;*.tar.gz&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;*.zip&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ignore_directories&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">True&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">case_sensitive&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">False&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">on_created&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">event&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 不知为何新建文件会触发两次通知事件, 于是偷懒加了计数器, 达到只传一次的目的&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">count&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">go&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">event&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">src_path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">count&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">go&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># watchdog太过灵敏, 需要设定一点延时, 不然文件还未写入磁盘就开始后续操作会报permission deny的错误&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">0.5&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">remote_key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">generate_key&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># 生成远端存储别名&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">upload&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">remote_key&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># 上传&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">src&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;![&amp;#39;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">name&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s1">&amp;#39;]&amp;#39;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s1">&amp;#39;(&amp;#39;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">addr&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">remote_key&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">style&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s1">&amp;#39;)&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">set_clipboard&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">src&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># 整理md图片链接格式到剪贴板&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">set_clipboard&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pyperclip&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">copy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pyperclip&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">paste&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">upload&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">uploadname&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">auth&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">qiniu&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Auth&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ak&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sk&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">token&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">auth&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">upload_token&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">bucket&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">qiniu&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">put_file&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">token&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">uploadname&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">fp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">mime_type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">mime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">guess_type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">generate_key&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ext&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">splitext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">basename&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;rb&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">fh&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">md5&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">hashlib&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">md5&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fh&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">hexdigest&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># remote url: filetype/year/month/md5.filetype&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">remote&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ext&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:]&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s1">&amp;#39;/&amp;#39;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">year&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s1">&amp;#39;/&amp;#39;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">month&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s1">&amp;#39;/&amp;#39;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">md5&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">ext&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">remote&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="vm">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;__main__&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="n">path_to_watch&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">event_handler&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">MyHandler&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">observer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Observer&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">observer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">schedule&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">event_handler&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">observer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">start&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="kc">True&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span> &lt;span class="ne">KeyboardInterrupt&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">observer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">stop&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">finally&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;总共上传了&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">个文件&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">event_handler&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">count&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">observer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>workflow: 运行脚本(监控指定文件夹) --&amp;gt; 截图或者复制图片到监控文件夹 --&amp;gt; 直接在MD正文粘贴即可&lt;/p>
&lt;p>via: &lt;a href="https://github.com/ferstar/qiniu4blog">https://github.com/ferstar/qiniu4blog&lt;/a>&lt;/p>
&lt;p>运行效果:&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/gif/2017/8/63b52237c9d43f5fc544a430b2b46846.gif" alt="test">&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/markdown/">MARKDOWN</category></item><item><title>random.org的随机数调用api</title><link>https://blog.ferstar.org/post/random/</link><guid isPermaLink="true">https://blog.ferstar.org/post/random/</guid><pubDate>Thu, 27 Jul 2017 17:41:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>via: &lt;a href="https://api.random.org/json-rpc/1/basic">https://api.random.org/json-rpc/1/basic&lt;/a>&lt;/p>
&lt;p>这货号称是真随机, 看起来好屌的样子&lt;/p>
&lt;p>API 使用一般都是两步&lt;/p>
&lt;ol>
&lt;li>
&lt;p>申请&lt;code>key&lt;/code>&lt;/p>
&lt;p>点右上角那个&lt;code>Get Beta Key&lt;/code>即可, 需要填个邮箱接收&lt;code>key&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>调&lt;code>HTTP request&lt;/code>参数&lt;/p>
&lt;p>直接放码&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">requests&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">json&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">url&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;https://api.random.org/json-rpc/1/invoke&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">payload&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;jsonrpc&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;2.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;method&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;generateIntegers&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;params&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;apiKey&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;4125d851-2fed-41c6-8fb4-9aa8ccb20bd7&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1"># key&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;n&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1"># 希望获取多少个随机数&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;min&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1"># 随机数从何开始&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;max&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">150&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1"># 从何结束&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;replacement&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">True&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;base&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="c1"># 进制&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;id&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">18289&lt;/span> &lt;span class="c1"># 暂时目测5位随机数&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">headers&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;content-type&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;application/json&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;cache-control&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;no-cache&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">response&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">requests&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;POST&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">url&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">data&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">dumps&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">payload&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">headers&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">headers&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">json&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">loads&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">text&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>得到的正确响应大概是这样:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;jsonrpc&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;2.0&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;result&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;random&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;data&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 108,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 125,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 133,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 149,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 112,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 101,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 123,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 101,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 103,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">135&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;completionTime&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;2017-07-27 09:49:04Z&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;bitsUsed&amp;#34;&lt;/span>: 57,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;bitsLeft&amp;#34;&lt;/span>: 22138,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;requestsLeft&amp;#34;&lt;/span>: 988,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;advisoryDelay&amp;#34;&lt;/span>: &lt;span class="m">210&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;id&amp;#34;&lt;/span>: &lt;span class="m">18289&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>具体异常直接看官网文档&lt;/p>
&lt;/li>
&lt;/ol></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/random/">RANDOM</category></item><item><title>python统计并绘制频率分布直方图</title><link>https://blog.ferstar.org/post/python%E7%BB%9F%E8%AE%A1%E5%B9%B6%E7%BB%98%E5%88%B6%E9%A2%91%E7%8E%87%E5%88%86%E5%B8%83%E7%9B%B4%E6%96%B9%E5%9B%BE/</link><guid isPermaLink="true">https://blog.ferstar.org/post/python%E7%BB%9F%E8%AE%A1%E5%B9%B6%E7%BB%98%E5%88%B6%E9%A2%91%E7%8E%87%E5%88%86%E5%B8%83%E7%9B%B4%E6%96%B9%E5%9B%BE/</guid><pubDate>Thu, 27 Jul 2017 15:30:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>为了统计xx数据分布情况, 需要从&lt;code>csv&lt;/code>文件中读出数据, 转换成&lt;code>int&lt;/code>后绘制出频率直方图&lt;/p>
&lt;p>代码如下&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">matplotlib.mlab&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="nn">mlab&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">matplotlib.pyplot&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="nn">plt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">numpy&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="nn">np&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">lst&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;123.csv&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;r&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">encoding&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;utf8&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">fh&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">line&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fh&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">readline&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">line&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="k">break&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lst&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">line&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strip&lt;/span>&lt;span class="p">()))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">pass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">mu&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">np&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">mean&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">lst&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># 样本均值&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">sigma&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">np&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">lst&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># 样本标准差&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">num_bins&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">50&lt;/span> &lt;span class="c1"># 区间数量(实际样本值是从100到150, 所以分成50份)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">bins&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">patches&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">hist&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">lst&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">num_bins&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">normed&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">facecolor&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;blue&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">alpha&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mf">0.5&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 添加一个理想的正态分布拟合曲线&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">mlab&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">normpdf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">bins&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">mu&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sigma&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">plot&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">bins&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;r--&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">xlabel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Values&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ylabel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Probability&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">title&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">r&lt;/span>&lt;span class="s1">&amp;#39;$\mu=&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s1">$, $\sigma=&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s1">$&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">round&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">mu&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nb">round&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sigma&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">subplots_adjust&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">left&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mf">0.15&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">show&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>实际在&lt;code>jupyter-notebook&lt;/code>中, 上述代码输出并未内嵌, 而是新弹出了一个窗口绘图&lt;/p>
&lt;p>&lt;img src="~/15-43-38.jpg" alt="">&lt;/p>
&lt;p>我们希望能够将图标内嵌到&lt;code>notebook&lt;/code>的网页当中, 所以需要额外的操作&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">%&lt;/span>&lt;span class="n">matplotlib&lt;/span> &lt;span class="n">inline&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">IPython.display&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">HTML&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这样就可以了&lt;/p>
&lt;p>&lt;img src="~/15-44-12.jpg" alt="">&lt;/p>
&lt;h2 id="参考">参考&lt;/h2>
&lt;ol>
&lt;li>&lt;a href="http://blog.csdn.net/u013571243/article/details/48998619">hist的使用&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://blog.csdn.net/baidu_31508279/article/details/52329688">python统计并绘制频率分布直方图&lt;/a>&lt;/li>
&lt;/ol></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>fix an anki plugin bugs which was called Syntax Highlighting for Code</title><link>https://blog.ferstar.org/post/fix-an-anki-plugin-bugs-which-was-called-syntax-highlighting-for-code/</link><guid isPermaLink="true">https://blog.ferstar.org/post/fix-an-anki-plugin-bugs-which-was-called-syntax-highlighting-for-code/</guid><pubDate>Wed, 26 Jul 2017 18:03:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>最近折腾&lt;code>anki&lt;/code>神器, 发现用来记忆零散知识点非常管用, 于是自己制作了一些&lt;code>Python&lt;/code>学习过程中的问题卡片, 然而默认模板渲染代码效果很差, 非常不方便, &lt;code>Google&lt;/code>一番后发现了这个插件&lt;a href="https://ankiweb.net/shared/info/1463041493">Syntax Highlighting for Code&lt;/a>, 代码年久失修, 使用过程中有点小毛病, 就顺手修复了下.&lt;/p>
&lt;p>主要毛病有两个:&lt;/p>
&lt;ol>
&lt;li>模块导入错误 ImportError: No module named pygments&lt;/li>
&lt;li>行号显示/代码居中样式自定义option不起作用&lt;/li>
&lt;/ol>
&lt;p>代码及修复细节请移步&lt;code>gist&lt;/code>: &lt;a href="https://gist.github.com/ferstar/61dbec4e74bcc725172ec46e546c65e1">code_highlight_addon.py&lt;/a>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/anki/">ANKI</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>Python中的单例模式</title><link>https://blog.ferstar.org/post/python%E4%B8%AD%E7%9A%84%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/</link><guid isPermaLink="true">https://blog.ferstar.org/post/python%E4%B8%AD%E7%9A%84%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/</guid><pubDate>Mon, 24 Jul 2017 17:56:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>转自: &lt;a href="http://funhacks.net/2017/01/17/singleton/">Python 中的单例模式&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;h1 id="单例模式">单例模式&lt;/h1>
&lt;p>&lt;strong>单例模式（Singleton Pattern）&lt;strong>是一种常用的软件设计模式，该模式的主要目的是确保&lt;/strong>某一个类只有一个实例存在&lt;/strong>。当你希望在整个系统中，某个类只能出现一个实例时，单例对象就能派上用场。&lt;/p>
&lt;p>比如，某个服务器程序的配置信息存放在一个文件中，客户端通过一个 AppConfig 的类来读取配置文件的信息。如果在程序运行期间，有很多地方都需要使用配置文件的内容，也就是说，很多地方都需要创建 AppConfig 对象的实例，这就导致系统中存在多个 AppConfig 的实例对象，而这样会严重浪费内存资源，尤其是在配置文件内容很多的情况下。事实上，类似 AppConfig 这样的类，我们希望在程序运行期间只存在一个实例对象。&lt;/p>
&lt;p>在 Python 中，我们可以用多种方法来实现单例模式：&lt;/p>
&lt;ul>
&lt;li>使用模块&lt;/li>
&lt;li>使用 &lt;code>__new__&lt;/code>&lt;/li>
&lt;li>使用装饰器（decorator）&lt;/li>
&lt;li>使用元类（metaclass）&lt;/li>
&lt;/ul>
&lt;h1 id="使用模块">使用模块&lt;/h1>
&lt;p>其实，&lt;strong>Python 的模块就是天然的单例模式&lt;/strong>，因为模块在第一次导入时，会生成 &lt;code>.pyc&lt;/code> 文件，当第二次导入时，就会直接加载 &lt;code>.pyc&lt;/code> 文件，而不会再次执行模块代码。因此，我们只需把相关的函数和数据定义在一个模块中，就可以获得一个单例对象了。如果我们真的想要一个单例类，可以考虑这样做：&lt;/p>
&lt;pre tabindex="0">&lt;code># mysingleton.py
class My_Singleton(object):
def foo(self):
pass
my_singleton = My_Singleton()
&lt;/code>&lt;/pre>&lt;p>将上面的代码保存在文件 &lt;code>mysingleton.py&lt;/code> 中，然后这样使用：&lt;/p>
&lt;pre tabindex="0">&lt;code>from mysingleton import my_singleton
my_singleton.foo()
&lt;/code>&lt;/pre>&lt;h1 id="使用-__new__">使用 &lt;code>__new__&lt;/code>&lt;/h1>
&lt;p>为了使类只能出现一个实例，我们可以使用 &lt;code>__new__&lt;/code> 来控制实例的创建过程，代码如下：&lt;/p>
&lt;pre tabindex="0">&lt;code>class Singleton(object):
_instance = None
def __new__(cls, *args, **kw):
if not cls._instance:
cls._instance = super(Singleton, cls).__new__(cls, *args, **kw)
return cls._instance
class MyClass(Singleton):
a = 1
&lt;/code>&lt;/pre>&lt;p>在上面的代码中，我们将类的实例和一个类变量 &lt;code>_instance&lt;/code> 关联起来，如果 &lt;code>cls._instance&lt;/code> 为 None 则创建实例，否则直接返回 &lt;code>cls._instance&lt;/code>。&lt;/p>
&lt;p>执行情况如下：&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; one = MyClass()
&amp;gt;&amp;gt;&amp;gt; two = MyClass()
&amp;gt;&amp;gt;&amp;gt; one == two
True
&amp;gt;&amp;gt;&amp;gt; one is two
True
&amp;gt;&amp;gt;&amp;gt; id(one), id(two)
(4303862608, 4303862608)
&lt;/code>&lt;/pre>&lt;h1 id="使用装饰器">使用装饰器&lt;/h1>
&lt;p>我们知道，装饰器（decorator）可以动态地修改一个类或函数的功能。这里，我们也可以使用装饰器来装饰某个类，使其只能生成一个实例，代码如下：&lt;/p>
&lt;pre tabindex="0">&lt;code>from functools import wraps
def singleton(cls):
instances = {}
@wraps(cls)
def getinstance(*args, **kw):
if cls not in instances:
instances[cls] = cls(*args, **kw)
return instances[cls]
return getinstance
@singleton
class MyClass(object):
a = 1
&lt;/code>&lt;/pre>&lt;p>在上面，我们定义了一个装饰器 &lt;code>singleton&lt;/code>，它返回了一个内部函数 &lt;code>getinstance&lt;/code>，该函数会判断某个类是否在字典 &lt;code>instances&lt;/code> 中，如果不存在，则会将 &lt;code>cls&lt;/code> 作为 key，&lt;code>cls(*args, **kw)&lt;/code> 作为 value 存到 &lt;code>instances&lt;/code> 中，否则，直接返回 &lt;code>instances[cls]&lt;/code>。&lt;/p>
&lt;h1 id="使用-metaclass">使用 metaclass&lt;/h1>
&lt;p>元类（metaclass）可以控制类的创建过程，它主要做三件事：&lt;/p>
&lt;ul>
&lt;li>拦截类的创建&lt;/li>
&lt;li>修改类的定义&lt;/li>
&lt;li>返回修改后的类&lt;/li>
&lt;/ul>
&lt;p>使用元类实现单例模式的代码如下：&lt;/p>
&lt;pre tabindex="0">&lt;code>class Singleton(type):
_instances = {}
def __call__(cls, *args, **kwargs):
if cls not in cls._instances:
cls._instances[cls] = super(Singleton, cls).__call__(*args, **kwargs)
return cls._instances[cls]
# Python2
class MyClass(object):
__metaclass__ = Singleton
# Python3
# class MyClass(metaclass=Singleton):
# pass
&lt;/code>&lt;/pre>&lt;h1 id="官网的例子httpswikipythonorgmoinpythondecoratorlibrarysingleton">官网的&lt;a href="https://wiki.python.org/moin/PythonDecoratorLibrary#Singleton">例子&lt;/a>&lt;/h1>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">singleton&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">cls&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">instance&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">cls&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">instance&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="fm">__call__&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">lambda&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">instance&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">instance&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Sample use&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@singleton&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Highlander&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Of course you can have any attributes or methods you like.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Highlander&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="n">Highlander&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="n">Highlander&lt;/span> &lt;span class="c1">#=&amp;gt; True&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">id&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Highlander&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">id&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Highlander&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">#=&amp;gt; True&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Highlander&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">Highlander&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">100&lt;/span> &lt;span class="c1">#=&amp;gt; True&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Highlander&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">50&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Highlander&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">Highlander&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">50&lt;/span> &lt;span class="c1">#=&amp;gt; True&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="小结">小结&lt;/h1>
&lt;ul>
&lt;li>Python 的模块是天然的单例模式，这在大部分情况下应该是够用的，当然，我们也可以使用装饰器、元类等方法&lt;/li>
&lt;/ul>
&lt;h1 id="参考资料">参考资料&lt;/h1>
&lt;ul>
&lt;li>&lt;a href="http://stackoverflow.com/questions/6760685/creating-a-singleton-in-python">Creating a singleton in Python - Stack Overflow&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://coolshell.cn/articles/265.html">深入浅出单实例Singleton设计模式 | 酷 壳&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://stackoverflow.com/questions/674304/pythons-use-of-new-and-init">design patterns - Python’s use of &lt;strong>new&lt;/strong> and &lt;strong>init&lt;/strong>? - Stack Overflow&lt;/a>&lt;/li>
&lt;/ul></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>HTTP协议简介</title><link>https://blog.ferstar.org/post/http%E5%8D%8F%E8%AE%AE%E7%AE%80%E4%BB%8B/</link><guid isPermaLink="true">https://blog.ferstar.org/post/http%E5%8D%8F%E8%AE%AE%E7%AE%80%E4%BB%8B/</guid><pubDate>Mon, 24 Jul 2017 17:54:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>转自: &lt;a href="http://funhacks.net/2017/03/01/http/">HTTP 协议简介&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>&lt;strong>HTTP&lt;/strong> (HyperText Transfer Protocol, 超文本传输协议)是互联网上应用最为广泛的一种网络协议，它是基于 &lt;a href="https://zh.wikipedia.org/wiki/%E4%BC%A0%E8%BE%93%E6%8E%A7%E5%88%B6%E5%8D%8F%E8%AE%AE">TCP&lt;/a> 的&lt;strong>应用层&lt;/strong>协议，简单地说就是客户端和服务器进行通信的一种规则，它的模式非常简单，就是&lt;strong>客户端发起请求，服务器响应请求&lt;/strong>，如下图所示：&lt;/p>
&lt;p>&lt;a href="https://ofaatpail.qnssl.com/2016-11-29-http.png-480">&lt;img src="https://ofaatpail.qnssl.com/2016-11-29-http.png-480" alt="img">&lt;/a>&lt;/p>
&lt;p>HTTP 最早于 1991 年发布，是 0.9 版，不过目前该版本已不再用。HTTP 目前在使用的版本主要有：&lt;/p>
&lt;ul>
&lt;li>HTTP/1.0，于 1996 年 5 月发布，引入了多种功能，至今仍在使用当中。&lt;/li>
&lt;li>HTTP/1.1，于 1997 年 1 月发布，持久连接被默认采用，是目前最流行的版本。&lt;/li>
&lt;li>HTTP/2 ，于 2015 年 5 月发布，引入了服务器推送等多种功能，是目前最新的版本。&lt;/li>
&lt;/ul>
&lt;h1 id="http-请求">HTTP 请求&lt;/h1>
&lt;p>HTTP 请求由三部分组成：&lt;/p>
&lt;ul>
&lt;li>&lt;strong>请求行&lt;/strong>：包含请求方法、请求地址和 HTTP 协议版本&lt;/li>
&lt;li>&lt;strong>消息报头&lt;/strong>：包含一系列的键值对&lt;/li>
&lt;li>&lt;strong>请求正文（可选）&lt;/strong>：注意和消息报头之间有一个空行&lt;/li>
&lt;/ul>
&lt;p>如图所示：&lt;/p>
&lt;p>&lt;a href="https://ooo.0o0.ooo/2016/12/05/58456e61d5d47.png">&lt;img src="https://ooo.0o0.ooo/2016/12/05/58456e61d5d47.png" alt="img">&lt;/a>&lt;/p>
&lt;p>下面是一个 HTTP GET 请求的例子：&lt;/p>
&lt;pre tabindex="0">&lt;code>GET / HTTP/1.1
Host: httpbin.org
Connection: keep-alive
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2840.98 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Encoding: gzip, deflate, sdch, br
Accept-Language: zh-CN,zh;q=0.8,en;q=0.6,zh-TW;q=0.4
Cookie: _ga=GA1.2.475070272.1480418329; _gat=1
&lt;/code>&lt;/pre>&lt;p>上面的第一行就是一个&lt;strong>请求行&lt;/strong>：&lt;/p>
&lt;pre tabindex="0">&lt;code>GET / HTTP/1.1
&lt;/code>&lt;/pre>&lt;p>其中，&lt;code>GET&lt;/code> 是请求方法，表示从服务器获取资源；&lt;code>/&lt;/code> 是一个请求地址；&lt;code>HTTP/1.1&lt;/code> 表明 HTTP 的版本是 1.1。&lt;/p>
&lt;p>请求行后面的一系列键值对就是&lt;strong>消息报头&lt;/strong>：&lt;/p>
&lt;pre tabindex="0">&lt;code>Host: httpbin.org
Connection: keep-alive
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2840.98 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Encoding: gzip, deflate, sdch, br
Accept-Language: zh-CN,zh;q=0.8,en;q=0.6,zh-TW;q=0.4
Cookie: _ga=GA1.2.475034215.1480418329; _gat=1
&lt;/code>&lt;/pre>&lt;p>其中：&lt;/p>
&lt;ul>
&lt;li>Host 是请求报头域，用于指定被请求资源的 Internet 主机和端口号，它通常从 HTTP URL 中提取出来；&lt;/li>
&lt;li>Connection 表示连接状态，keep-alive 表示该连接是持久连接（persistent connection），即 TCP 连接默认不关闭，可以被多个请求复用，如果客户端和服务器发现对方有一段时间没有活动，就可以主动关闭连接；&lt;/li>
&lt;li>Cache-Control 用于指定缓存指令，它的值有 no-cache, no-store, max-age 等，&lt;code>max-age=秒&lt;/code>表示资源在本地缓存多少秒；&lt;/li>
&lt;li>User-Agent 用于标识请求者的一些信息，比如浏览器类型和版本，操作系统等；&lt;/li>
&lt;li>Accept 用于指定客户端希望接受哪些类型的信息，比如 text/html, image/gif 等；&lt;/li>
&lt;li>Accept-Encoding 用于指定可接受的内容编码；&lt;/li>
&lt;li>Accept-Language 用于指定可接受的自然语言；&lt;/li>
&lt;li>Cookie 用于维护状态，可做用户认证，服务器检验等，它是浏览器储存在用户电脑上的文本片段；&lt;/li>
&lt;/ul>
&lt;h2 id="http-请求方法">HTTP 请求方法&lt;/h2>
&lt;p>HTTP 通过不同的请求方法以多种方式来操作指定的资源，常用的请求方法如下表：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>方法&lt;/th>
&lt;th>描述&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>GET&lt;/td>
&lt;td>从服务器获取指定（请求地址）的资源的信息，它通常只用于读取数据，就像数据库查询一样，不会对资源进行修改。&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>POST&lt;/td>
&lt;td>向指定资源提交数据（比如提交表单，上传文件），请求服务器进行处理。数据被包含在请求正文中，这个请求可能会创建新的资源或更新现有的资源。&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>PUT&lt;/td>
&lt;td>通过指定资源的唯一标识（在服务器上的具体存放位置），请求服务器创建或更新资源。&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>DELETE&lt;/td>
&lt;td>请求服务器删除指定资源。&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>HEAD&lt;/td>
&lt;td>与 GET 方法类似，从服务器获取资源信息，和 GET 方法不同的是，HEAD 不含有呈现数据，仅仅是 HTTP 头信息。HEAD 的好处在于，使用这个方法可以在不必传输全部内容的情况下，就可以获得资源的元信息（或元数据）。&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>OPTIONS&lt;/td>
&lt;td>该方法可使服务器传回资源所支持的所有 HTTP 请求方法。&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="再议-post-和-put">再议 POST 和 PUT&lt;/h2>
&lt;p>注意到，POST 和 PUT 都可用于创建或更新资源，然而，它们之间还是有比较大的区别：&lt;/p>
&lt;ul>
&lt;li>POST 所对应的 URI 并非创建的资源本身，而是资源的接收者，资源本身的存放位置由服务器决定；而 PUT 所对应的 URI 是要创建或更新的资源本身，它指明了具体的存放位置&lt;/li>
&lt;/ul>
&lt;p>比如，往某个站点添加一篇文章，如果&lt;strong>使用 POST 来创建资源&lt;/strong>，可类似这样：&lt;/p>
&lt;pre tabindex="0">&lt;code>POST /articles HTTP/1.1
{
&amp;#34;author&amp;#34;: &amp;#34;ethan&amp;#34;,
&amp;#34;title&amp;#34;: &amp;#34;hello world&amp;#34;,
&amp;#34;content&amp;#34;: &amp;#34;hello world&amp;#34;
}
&lt;/code>&lt;/pre>&lt;p>在上面，POST 对应的 URI 是 &lt;code>/articles&lt;/code>，它是资源的接收者，而非资源的标识，如果资源被成功创建，服务器可以返回 &lt;code>201 Created&lt;/code> 状态以及新建资源的位置，比如：&lt;/p>
&lt;pre tabindex="0">&lt;code>HTTP/1.1 201 Created
Location: /articles/abcdef123
&lt;/code>&lt;/pre>&lt;p>我们如果知道新建资源的标识符，可以&lt;strong>使用 PUT 来创建资源&lt;/strong>，比如：&lt;/p>
&lt;pre tabindex="0">&lt;code>PUT /articles/abcdef234 HTTP/1.1
{
&amp;#34;author&amp;#34;: &amp;#34;peter&amp;#34;,
&amp;#34;title&amp;#34;: &amp;#34;hello world&amp;#34;,
&amp;#34;content&amp;#34;: &amp;#34;hello world&amp;#34;
}
&lt;/code>&lt;/pre>&lt;p>在上面，PUT 对应的 URI 是 &lt;code>/articles/abcdef234&lt;/code>，它指明了资源的存放位置，如果资源被成功创建，服务器可以返回 &lt;code>201 Created&lt;/code> 状态以及新建资源的位置，比如：&lt;/p>
&lt;pre tabindex="0">&lt;code>HTTP/1.1 201 Created
Location: /articles/abcdef234
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>使用 PUT 更新某一资源，需要更新资源的全部属性；而使用 POST，可以更新全部或一部分值&lt;/li>
&lt;/ul>
&lt;p>比如使用 PUT 更新地址为 &lt;code>/articles/abcdef234&lt;/code> 的文章的标题，我们需要发送所有值：&lt;/p>
&lt;pre tabindex="0">&lt;code>PUT /articles/abcdef234 HTTP/1.1
{
&amp;#34;author&amp;#34;: &amp;#34;peter&amp;#34;,
&amp;#34;title&amp;#34;: &amp;#34;hello python&amp;#34;,
&amp;#34;content&amp;#34;: &amp;#34;hello world&amp;#34;
}
&lt;/code>&lt;/pre>&lt;p>而使用 POST，可以更新某个域的值：&lt;/p>
&lt;pre tabindex="0">&lt;code>POST /articles/abcdef234 HTTP/1.1
{
&amp;#34;title&amp;#34;: &amp;#34;hello python&amp;#34;
}
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>POST 是不幂等的，PUT 是幂等的，这是一个很重要的区别&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>HTTP 方法的幂等性是指一次和多次请求某一个资源应该具有同样的&lt;strong>副作用&lt;/strong>，注意这里是副作用，而不是返回结果。&lt;/p>
&lt;/blockquote>
&lt;p>&lt;strong>GET&lt;/strong> 方法用于获取资源，不会改变资源的状态，不论调用一次还是多次都没有副作用，因此它是幂等的；&lt;strong>DELETE&lt;/strong> 方法用于删除资源，有副作用，但调用一次或多次都是删除同个资源，产生的副作用是相同的，因此也是幂等的；&lt;strong>POST&lt;/strong> 是不幂等的，因为两次相同的 POST 请求会在服务器创建两份资源，它们具有不同的 URI；&lt;strong>PUT&lt;/strong> 是幂等的，对同一 URI 进行多次 PUT 的副作用和一次 PUT 是相同的。&lt;/p>
&lt;h1 id="http-响应">HTTP 响应&lt;/h1>
&lt;p>HTTP 响应与 HTTP 请求相似，由三部分组成：&lt;/p>
&lt;ul>
&lt;li>&lt;strong>状态行&lt;/strong>：包含 HTTP 协议版本、状态码和状态描述，以空格分隔&lt;/li>
&lt;li>&lt;strong>响应头&lt;/strong>：即消息报头，包含一系列的键值对&lt;/li>
&lt;li>&lt;strong>响应正文&lt;/strong>：返回内容，注意和响应头之间有一个空行&lt;/li>
&lt;/ul>
&lt;p>如图所示：&lt;/p>
&lt;p>&lt;a href="https://ooo.0o0.ooo/2016/12/05/58456e62d49d6.png">&lt;img src="https://ooo.0o0.ooo/2016/12/05/58456e62d49d6.png" alt="img">&lt;/a>&lt;/p>
&lt;p>下面是一个 HTTP GET 请求的响应结果：&lt;/p>
&lt;pre tabindex="0">&lt;code>HTTP/1.1 200 OK
Server: nginx
Date: Tue, 29 Nov 2016 13:08:38 GMT
Content-Type: application/json
Content-Length: 203
Connection: close
Access-Control-Allow-Origin: *
Access-Control-Allow-Credentials: true
{
&amp;#34;args&amp;#34;: {},
&amp;#34;headers&amp;#34;: {
&amp;#34;Host&amp;#34;: &amp;#34;httpbin.org&amp;#34;,
&amp;#34;User-Agent&amp;#34;: &amp;#34;Paw/2.3.1 (Macintosh; OS X/10.11.3) GCDHTTPRequest&amp;#34;
},
&amp;#34;origin&amp;#34;: &amp;#34;13.75.42.240&amp;#34;,
&amp;#34;url&amp;#34;: &amp;#34;https://httpbin.org/get&amp;#34;
}
&lt;/code>&lt;/pre>&lt;p>上面的第一行就是一个&lt;strong>状态行&lt;/strong>：&lt;/p>
&lt;pre tabindex="0">&lt;code>HTTP/1.1 200 OK
&lt;/code>&lt;/pre>&lt;p>其中，&lt;code>200&lt;/code> 是状态码，表示客户端请求成功，&lt;code>OK&lt;/code> 是相应的状态描述。&lt;/p>
&lt;p>状态码是一个三位的数字，常见的状态码有以下几类：&lt;/p>
&lt;blockquote>
&lt;p>关于状态码七牛云的文档写的很棒：&lt;a href="https://developer.qiniu.com/fusion/kb/1425/the-http-status-code-books">HTTP状态码大全&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>1XX 消息 – 请求已被服务接收，继续处理&lt;/li>
&lt;li>2XX 成功 – 请求已成功被服务器接收、理解、并接受
&lt;ul>
&lt;li>200 OK&lt;/li>
&lt;li>201 Created 已创建&lt;/li>
&lt;li>202 Accepted 接收&lt;/li>
&lt;li>203 Non-Authoritative Information 非认证信息&lt;/li>
&lt;li>204 No Content 无内容&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>3XX 重定向 – 需要后续操作才能完成这一请求
&lt;ul>
&lt;li>301 Moved Permanently 请求永久重定向&lt;/li>
&lt;li>302 Moved Temporarily 请求临时重定向&lt;/li>
&lt;li>304 Not Modified 文件未修改，可以直接使用缓存的文件&lt;/li>
&lt;li>305 Use Proxy 使用代理&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>4XX 请求错误 – 请求含有词法错误或者无法被执行
&lt;ul>
&lt;li>400 Bad Request 由于客户端请求有语法错误，不能被服务器所理解&lt;/li>
&lt;li>401 Unauthorized 请求未经授权。这个状态代码必须和WWW-Authenticate报头域一起使用&lt;/li>
&lt;li>403 Forbidden 服务器收到请求，但是拒绝提供服务。服务器通常会在响应正文中给出不提供服务的原因&lt;/li>
&lt;li>404 Not Found 请求的资源不存在，例如，输入了错误的URL&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>5XX 服务器错误 – 服务器在处理某个正确请求时发生错误
&lt;ul>
&lt;li>500 Internal Server Error 服务器发生不可预期的错误，导致无法完成客户端的请求&lt;/li>
&lt;li>503 Service Unavailable 服务器当前不能够处理客户端的请求，在一段时间之后，服务器可能会恢复正常&lt;/li>
&lt;li>504 Gateway Time-out 网关超时&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>状态行后面的一系列键值对就是消息报头，即响应头：&lt;/p>
&lt;pre tabindex="0">&lt;code>Server: nginx
Date: Tue, 29 Nov 2016 13:08:38 GMT
Content-Type: application/json
Content-Length: 203
Connection: close
Access-Control-Allow-Origin: *
Access-Control-Allow-Credentials: true
&lt;/code>&lt;/pre>&lt;p>其中：&lt;/p>
&lt;ul>
&lt;li>Server 包含了服务器用来处理请求的软件信息，跟请求报头域 User-Agent 相对应；&lt;/li>
&lt;li>Content-Type 用于指定发送给接收者（比如浏览器）的响应正文的媒体类型，比如 text/html, text/css, image/png, image/jpeg, video/mp4, application/pdf, application/json 等；&lt;/li>
&lt;li>Content-Length 指明本次回应的数据长度；&lt;/li>
&lt;/ul>
&lt;h1 id="http-特点">HTTP 特点&lt;/h1>
&lt;ul>
&lt;li>客户端/服务器模式&lt;/li>
&lt;li>简单快速：客户端向服务器请求服务时，通过传送请求方法、请求地址和数据体（可选）即可&lt;/li>
&lt;li>灵活：允许传输任意类型的数据对象，通过 Content-Type 标识&lt;/li>
&lt;li>无状态：对事物处理没记忆能力&lt;/li>
&lt;/ul>
&lt;h1 id="小结">小结&lt;/h1>
&lt;ul>
&lt;li>HTTP 是在网络上传输 HTML 的协议，用于浏览器和服务器的通信，默认使用 80 端口。&lt;/li>
&lt;li>URL 地址用于定位资源，HTTP 中的 GET, POST, PUT, DELETE 用于操作资源，比如查询，增加，更新等。&lt;/li>
&lt;li>GET, PUT, DELETE 是幂等的，POST 是不幂等的。&lt;/li>
&lt;li>POST VS PUT
&lt;ul>
&lt;li>使用 PUT 创建资源需要提供资源的唯一标识（具体存放位置），POST 不需要，POST 的数据存放位置由服务器自己决定&lt;/li>
&lt;li>使用 PUT 更新某一资源，需要更新资源的全部属性；而使用 POST，可以更新全部或一部分值&lt;/li>
&lt;li>POST 是不幂等的，PUT 是幂等的，这是一个很重要的区别&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>GET 可提交的数据量受到 URL 长度的限制，HTTP 协议规范没有对 URL 长度进行限制，这个限制是特定的浏览器及服务器对它的限制。&lt;/li>
&lt;li>理论上讲，POST 是没有大小限制的，HTTP 协议规范也没有进行大小限制，出于安全考虑，服务器软件在实现时会做一定限制。&lt;/li>
&lt;/ul>
&lt;h1 id="参考资料">参考资料&lt;/h1>
&lt;ul>
&lt;li>&lt;a href="https://zh.wikipedia.org/wiki/%E8%B6%85%E6%96%87%E6%9C%AC%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE#HTTP.2F1.1">超文本传输协议 - 维基百科，自由的百科全书&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://www.ruanyifeng.com/blog/2016/08/http.html">HTTP 协议入门 - 阮一峰的网络日志&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://coolshell.cn/articles/4787.html">HTTP幂等性概念和应用 | 酷 壳 - CoolShell.cn&lt;/a>&lt;/li>
&lt;/ul></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/http/">HTTP</category></item><item><title>高效的itertools模块</title><link>https://blog.ferstar.org/post/%E9%AB%98%E6%95%88%E7%9A%84itertools%E6%A8%A1%E5%9D%97/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E9%AB%98%E6%95%88%E7%9A%84itertools%E6%A8%A1%E5%9D%97/</guid><pubDate>Mon, 24 Jul 2017 17:52:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>转自: &lt;a href="http://funhacks.net/2017/02/13/itertools/">高效的itertools模块&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>我们知道，迭代器的特点是：&lt;strong>惰性求值&lt;/strong>（Lazy evaluation），即只有当迭代至某个值时，它才会被计算，这个特点使得迭代器特别适合于遍历大文件或无限集合等，因为我们不用一次性将它们存储在内存中。&lt;/p>
&lt;p>Python 内置的 itertools 模块包含了一系列用来产生不同类型迭代器的函数或类，这些函数的返回都是一个迭代器，我们可以通过 for 循环来遍历取值，也可以使用 &lt;code>next()&lt;/code> 来取值。&lt;/p>
&lt;p>itertools 模块提供的迭代器函数有以下几种类型：&lt;/p>
&lt;ul>
&lt;li>无限迭代器：生成一个无限序列，比如自然数序列 &lt;code>1, 2, 3, 4, ...&lt;/code>；&lt;/li>
&lt;li>有限迭代器：接收一个或多个序列（sequence）作为参数，进行组合、分组和过滤等；&lt;/li>
&lt;li>组合生成器：序列的排列、组合，求序列的笛卡儿积等；&lt;/li>
&lt;/ul>
&lt;h1 id="无限迭代器">无限迭代器&lt;/h1>
&lt;p>itertools 模块提供了三个函数（事实上，它们是类）用于生成一个无限序列迭代器：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>count(firstval=0, step=1)&lt;/p>
&lt;p>创建一个从 firstval (默认值为 0) 开始，以 step (默认值为 1) 为步长的的无限整数迭代器&lt;/p>
&lt;/li>
&lt;li>
&lt;p>cycle(iterable)&lt;/p>
&lt;p>对 iterable 中的元素反复执行循环，返回迭代器&lt;/p>
&lt;/li>
&lt;li>
&lt;p>repeat(object [,times]&lt;/p>
&lt;p>反复生成 object，如果给定 times，则重复次数为 times，否则为无限&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>下面，让我们看看一些例子。&lt;/p>
&lt;h2 id="count">count&lt;/h2>
&lt;p>&lt;code>count()&lt;/code> 接收两个参数，第一个参数指定开始值，默认为 0，第二个参数指定步长，默认为 1：&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; import itertools
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; nums = itertools.count()
&amp;gt;&amp;gt;&amp;gt; for i in nums:
... if i &amp;gt; 6:
... break
... print i
...
0
1
2
3
4
5
6
&amp;gt;&amp;gt;&amp;gt; nums = itertools.count(10, 2) # 指定开始值和步长
&amp;gt;&amp;gt;&amp;gt; for i in nums:
... if i &amp;gt; 20:
... break
... print i
...
10
12
14
16
18
20
&lt;/code>&lt;/pre>&lt;h2 id="cycle">cycle&lt;/h2>
&lt;p>&lt;code>cycle()&lt;/code> 用于对 iterable 中的元素反复执行循环：&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; import itertools
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; cycle_strings = itertools.cycle(&amp;#39;ABC&amp;#39;)
&amp;gt;&amp;gt;&amp;gt; i = 1
&amp;gt;&amp;gt;&amp;gt; for string in cycle_strings:
... if i == 10:
... break
... print i, string
... i += 1
...
1 A
2 B
3 C
4 A
5 B
6 C
7 A
8 B
9 C
&lt;/code>&lt;/pre>&lt;h2 id="repeat">repeat&lt;/h2>
&lt;p>&lt;code>repeat()&lt;/code> 用于反复生成一个 object：&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; import itertools
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; for item in itertools.repeat(&amp;#39;hello world&amp;#39;, 3):
... print item
...
hello world
hello world
hello world
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; for item in itertools.repeat([1, 2, 3, 4], 3):
... print item
...
[1, 2, 3, 4]
[1, 2, 3, 4]
[1, 2, 3, 4]
&lt;/code>&lt;/pre>&lt;h1 id="有限迭代器">有限迭代器&lt;/h1>
&lt;p>itertools 模块提供了多个函数（类），接收一个或多个迭代对象作为参数，对它们进行组合、分组和过滤等：&lt;/p>
&lt;ul>
&lt;li>chain()&lt;/li>
&lt;li>compress()&lt;/li>
&lt;li>dropwhile()&lt;/li>
&lt;li>groupby()&lt;/li>
&lt;li>ifilter()&lt;/li>
&lt;li>ifilterfalse()&lt;/li>
&lt;li>islice()&lt;/li>
&lt;li>imap()&lt;/li>
&lt;li>starmap()&lt;/li>
&lt;li>tee()&lt;/li>
&lt;li>takewhile()&lt;/li>
&lt;li>izip()&lt;/li>
&lt;li>izip_longest()&lt;/li>
&lt;/ul>
&lt;h2 id="chain">chain&lt;/h2>
&lt;p>&lt;code>chain&lt;/code> 的使用形式如下：&lt;/p>
&lt;pre tabindex="0">&lt;code>chain(iterable1, iterable2, iterable3, ...)
&lt;/code>&lt;/pre>&lt;p>&lt;code>chain&lt;/code> 接收多个可迭代对象作为参数，将它们『连接』起来，作为一个新的迭代器返回。&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; from itertools import chain
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; for item in chain([1, 2, 3], [&amp;#39;a&amp;#39;, &amp;#39;b&amp;#39;, &amp;#39;c&amp;#39;]):
... print item
...
1
2
3
a
b
c
&lt;/code>&lt;/pre>&lt;p>&lt;code>chain&lt;/code> 还有一个常见的用法：&lt;/p>
&lt;pre tabindex="0">&lt;code>chain.from_iterable(iterable)
&lt;/code>&lt;/pre>&lt;p>接收一个可迭代对象作为参数，返回一个迭代器：&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; from itertools import chain
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; string = chain.from_iterable(&amp;#39;ABCD&amp;#39;)
&amp;gt;&amp;gt;&amp;gt; string.next()
&amp;#39;A&amp;#39;
&lt;/code>&lt;/pre>&lt;h2 id="compress">compress&lt;/h2>
&lt;p>&lt;code>compress&lt;/code> 的使用形式如下：&lt;/p>
&lt;pre tabindex="0">&lt;code>compress(data, selectors)
&lt;/code>&lt;/pre>&lt;p>&lt;code>compress&lt;/code> 可用于对数据进行筛选，当 selectors 的某个元素为 true 时，则保留 data 对应位置的元素，否则去除：&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; from itertools import compress
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; list(compress(&amp;#39;ABCDEF&amp;#39;, [1, 1, 0, 1, 0, 1]))
[&amp;#39;A&amp;#39;, &amp;#39;B&amp;#39;, &amp;#39;D&amp;#39;, &amp;#39;F&amp;#39;]
&amp;gt;&amp;gt;&amp;gt; list(compress(&amp;#39;ABCDEF&amp;#39;, [1, 1, 0, 1]))
[&amp;#39;A&amp;#39;, &amp;#39;B&amp;#39;, &amp;#39;D&amp;#39;]
&amp;gt;&amp;gt;&amp;gt; list(compress(&amp;#39;ABCDEF&amp;#39;, [True, False, True]))
[&amp;#39;A&amp;#39;, &amp;#39;C&amp;#39;]
&lt;/code>&lt;/pre>&lt;h2 id="dropwhile">dropwhile&lt;/h2>
&lt;p>&lt;code>dropwhile&lt;/code> 的使用形式如下：&lt;/p>
&lt;pre tabindex="0">&lt;code>dropwhile(predicate, iterable)
&lt;/code>&lt;/pre>&lt;p>其中，predicate 是函数，iterable 是可迭代对象。对于 iterable 中的元素，如果 predicate(item) 为 true，则丢弃该元素，否则返回该项及所有后续项。&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; from itertools import dropwhile
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; list(dropwhile(lambda x: x &amp;lt; 5, [1, 3, 6, 2, 1]))
[6, 2, 1]
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; list(dropwhile(lambda x: x &amp;gt; 3, [2, 1, 6, 5, 4]))
[2, 1, 6, 5, 4]
&lt;/code>&lt;/pre>&lt;h2 id="groupby">groupby&lt;/h2>
&lt;p>&lt;code>groupby&lt;/code> 用于对序列进行分组，它的使用形式如下：&lt;/p>
&lt;pre tabindex="0">&lt;code>groupby(iterable[, keyfunc])
&lt;/code>&lt;/pre>&lt;p>其中，iterable 是一个可迭代对象，keyfunc 是分组函数，用于对 iterable 的连续项进行分组，如果不指定，则默认对 iterable 中的连续相同项进行分组，返回一个 &lt;code>(key, sub-iterator)&lt;/code> 的迭代器。&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; from itertools import groupby
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; for key, value_iter in groupby(&amp;#39;aaabbbaaccd&amp;#39;):
... print key, &amp;#39;:&amp;#39;, list(value_iter)
...
a : [&amp;#39;a&amp;#39;, &amp;#39;a&amp;#39;, &amp;#39;a&amp;#39;]
b : [&amp;#39;b&amp;#39;, &amp;#39;b&amp;#39;, &amp;#39;b&amp;#39;]
a : [&amp;#39;a&amp;#39;, &amp;#39;a&amp;#39;]
c : [&amp;#39;c&amp;#39;, &amp;#39;c&amp;#39;]
d : [&amp;#39;d&amp;#39;]
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; data = [&amp;#39;a&amp;#39;, &amp;#39;bb&amp;#39;, &amp;#39;ccc&amp;#39;, &amp;#39;dd&amp;#39;, &amp;#39;eee&amp;#39;, &amp;#39;f&amp;#39;]
&amp;gt;&amp;gt;&amp;gt; for key, value_iter in groupby(data, len): # 使用 len 函数作为分组函数
... print key, &amp;#39;:&amp;#39;, list(value_iter)
...
1 : [&amp;#39;a&amp;#39;]
2 : [&amp;#39;bb&amp;#39;]
3 : [&amp;#39;ccc&amp;#39;]
2 : [&amp;#39;dd&amp;#39;]
3 : [&amp;#39;eee&amp;#39;]
1 : [&amp;#39;f&amp;#39;]
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; data = [&amp;#39;a&amp;#39;, &amp;#39;bb&amp;#39;, &amp;#39;cc&amp;#39;, &amp;#39;ddd&amp;#39;, &amp;#39;eee&amp;#39;, &amp;#39;f&amp;#39;]
&amp;gt;&amp;gt;&amp;gt; for key, value_iter in groupby(data, len):
... print key, &amp;#39;:&amp;#39;, list(value_iter)
...
1 : [&amp;#39;a&amp;#39;]
2 : [&amp;#39;bb&amp;#39;, &amp;#39;cc&amp;#39;]
3 : [&amp;#39;ddd&amp;#39;, &amp;#39;eee&amp;#39;]
1 : [&amp;#39;f&amp;#39;]
&lt;/code>&lt;/pre>&lt;h2 id="ifilter">ifilter&lt;/h2>
&lt;p>&lt;code>ifilter&lt;/code> 的使用形式如下：&lt;/p>
&lt;pre tabindex="0">&lt;code>ifilter(function or None, sequence)
&lt;/code>&lt;/pre>&lt;p>将 iterable 中 function(item) 为 True 的元素组成一个迭代器返回，如果 function 是 None，则返回 iterable 中所有计算为 True 的项。&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; from itertools import ifilter
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; list(ifilter(lambda x: x &amp;lt; 6, range(10)))
[0, 1, 2, 3, 4, 5]
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; list(ifilter(None, [0, 1, 2, 0, 3, 4]))
[1, 2, 3, 4]
&lt;/code>&lt;/pre>&lt;p>&lt;code>ifilterfalse&lt;/code> 的使用形式和 &lt;code>ifilter&lt;/code> 类似，它将 iterable 中 function(item) 为 False 的元素组成一个迭代器返回，如果 function 是 None，则返回 iterable 中所有计算为 False 的项。&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; from itertools import ifilterfalse
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; list(ifilterfalse(lambda x: x &amp;lt; 6, range(10)))
[6, 7, 8, 9]
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; list(ifilter(None, [0, 1, 2, 0, 3, 4]))
[0, 0]
&lt;/code>&lt;/pre>&lt;h2 id="islice">islice&lt;/h2>
&lt;p>&lt;code>islice&lt;/code> 是切片选择，它的使用形式如下：&lt;/p>
&lt;pre tabindex="0">&lt;code>islice(iterable, [start,] stop [, step])
&lt;/code>&lt;/pre>&lt;p>其中，iterable 是可迭代对象，start 是开始索引，stop 是结束索引，step 是步长，start 和 step 可选。&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; from itertools import count, islice
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; list(islice([10, 6, 2, 8, 1, 3, 9], 5))
[10, 6, 2, 8, 1]
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; list(islice(count(), 6))
[0, 1, 2, 3, 4, 5]
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; list(islice(count(), 3, 10))
[3, 4, 5, 6, 7, 8, 9]
&amp;gt;&amp;gt;&amp;gt; list(islice(count(), 3, 10 ,2))
[3, 5, 7, 9]
&lt;/code>&lt;/pre>&lt;h2 id="imap">imap&lt;/h2>
&lt;p>&lt;code>imap&lt;/code> 类似 &lt;code>map&lt;/code> 操作，它的使用形式如下：&lt;/p>
&lt;pre tabindex="0">&lt;code>imap(func, iter1, iter2, iter3, ...)
&lt;/code>&lt;/pre>&lt;p>&lt;code>imap&lt;/code> 返回一个迭代器，元素为 &lt;code>func(i1, i2, i3, ...)&lt;/code>，&lt;code>i1&lt;/code>，&lt;code>i2&lt;/code> 等分别来源于 &lt;code>iter&lt;/code>, &lt;code>iter2&lt;/code>。&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; from itertools import imap
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; imap(str, [1, 2, 3, 4])
&amp;lt;itertools.imap object at 0x10556d050&amp;gt;
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; list(imap(str, [1, 2, 3, 4]))
[&amp;#39;1&amp;#39;, &amp;#39;2&amp;#39;, &amp;#39;3&amp;#39;, &amp;#39;4&amp;#39;]
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; list(imap(pow, [2, 3, 10], [4, 2, 3]))
[16, 9, 1000]
&lt;/code>&lt;/pre>&lt;h2 id="tee">tee&lt;/h2>
&lt;p>&lt;code>tee&lt;/code> 的使用形式如下：&lt;/p>
&lt;pre tabindex="0">&lt;code>tee(iterable [,n])
&lt;/code>&lt;/pre>&lt;p>&lt;code>tee&lt;/code> 用于从 iterable 创建 n 个独立的迭代器，以元组的形式返回，n 的默认值是 2。&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; from itertools import tee
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; tee(&amp;#39;abcd&amp;#39;) # n 默认为 2，创建两个独立的迭代器
(&amp;lt;itertools.tee object at 0x1049957e8&amp;gt;, &amp;lt;itertools.tee object at 0x104995878&amp;gt;)
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; iter1, iter2 = tee(&amp;#39;abcde&amp;#39;)
&amp;gt;&amp;gt;&amp;gt; list(iter1)
[&amp;#39;a&amp;#39;, &amp;#39;b&amp;#39;, &amp;#39;c&amp;#39;, &amp;#39;d&amp;#39;, &amp;#39;e&amp;#39;]
&amp;gt;&amp;gt;&amp;gt; list(iter2)
[&amp;#39;a&amp;#39;, &amp;#39;b&amp;#39;, &amp;#39;c&amp;#39;, &amp;#39;d&amp;#39;, &amp;#39;e&amp;#39;]
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; tee(&amp;#39;abc&amp;#39;, 3) # 创建三个独立的迭代器
(&amp;lt;itertools.tee object at 0x104995998&amp;gt;, &amp;lt;itertools.tee object at 0x1049959e0&amp;gt;, &amp;lt;itertools.tee object at 0x104995a28&amp;gt;)
&lt;/code>&lt;/pre>&lt;h2 id="takewhile">takewhile&lt;/h2>
&lt;p>&lt;code>takewhile&lt;/code> 的使用形式如下：&lt;/p>
&lt;pre tabindex="0">&lt;code>takewhile(predicate, iterable)
&lt;/code>&lt;/pre>&lt;p>其中，predicate 是函数，iterable 是可迭代对象。对于 iterable 中的元素，如果 predicate(item) 为 true，则保留该元素，只要 predicate(item) 为 false，则立即停止迭代。&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; from itertools import takewhile
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; list(takewhile(lambda x: x &amp;lt; 5, [1, 3, 6, 2, 1]))
[1, 3]
&amp;gt;&amp;gt;&amp;gt; list(takewhile(lambda x: x &amp;gt; 3, [2, 1, 6, 5, 4]))
[]
&lt;/code>&lt;/pre>&lt;h2 id="izip">izip&lt;/h2>
&lt;p>&lt;code>izip&lt;/code> 用于将多个可迭代对象&lt;strong>对应位置&lt;/strong>的元素作为一个元组，将所有元组『组成』一个迭代器，并返回。它的使用形式如下：&lt;/p>
&lt;pre tabindex="0">&lt;code>izip(iter1, iter2, ..., iterN)
&lt;/code>&lt;/pre>&lt;p>如果某个可迭代对象不再生成值，则迭代停止。&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; from itertools import izip
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; for item in izip(&amp;#39;ABCD&amp;#39;, &amp;#39;xy&amp;#39;):
... print item
...
(&amp;#39;A&amp;#39;, &amp;#39;x&amp;#39;)
(&amp;#39;B&amp;#39;, &amp;#39;y&amp;#39;)
&amp;gt;&amp;gt;&amp;gt; for item in izip([1, 2, 3], [&amp;#39;a&amp;#39;, &amp;#39;b&amp;#39;, &amp;#39;c&amp;#39;, &amp;#39;d&amp;#39;, &amp;#39;e&amp;#39;]):
... print item
...
(1, &amp;#39;a&amp;#39;)
(2, &amp;#39;b&amp;#39;)
(3, &amp;#39;c&amp;#39;)
&lt;/code>&lt;/pre>&lt;p>&lt;code>izip_longest&lt;/code> 跟 &lt;code>izip&lt;/code> 类似，但迭代过程会持续到所有可迭代对象的元素都被迭代完。它的形式如下：&lt;/p>
&lt;pre tabindex="0">&lt;code>izip_longest(iter1, iter2, ..., iterN, [fillvalue=None])
&lt;/code>&lt;/pre>&lt;p>如果有指定 fillvalue，则会用其填充缺失的值，否则为 None。&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; from itertools import izip_longest
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; for item in izip_longest(&amp;#39;ABCD&amp;#39;, &amp;#39;xy&amp;#39;):
... print item
...
(&amp;#39;A&amp;#39;, &amp;#39;x&amp;#39;)
(&amp;#39;B&amp;#39;, &amp;#39;y&amp;#39;)
(&amp;#39;C&amp;#39;, None)
(&amp;#39;D&amp;#39;, None)
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; for item in izip_longest(&amp;#39;ABCD&amp;#39;, &amp;#39;xy&amp;#39;, fillvalue=&amp;#39;-&amp;#39;):
... print item
...
(&amp;#39;A&amp;#39;, &amp;#39;x&amp;#39;)
(&amp;#39;B&amp;#39;, &amp;#39;y&amp;#39;)
(&amp;#39;C&amp;#39;, &amp;#39;-&amp;#39;)
(&amp;#39;D&amp;#39;, &amp;#39;-&amp;#39;)
&lt;/code>&lt;/pre>&lt;h1 id="组合生成器">组合生成器&lt;/h1>
&lt;p>itertools 模块还提供了多个组合生成器函数，用于求序列的排列、组合等：&lt;/p>
&lt;ul>
&lt;li>product&lt;/li>
&lt;li>permutations&lt;/li>
&lt;li>combinations&lt;/li>
&lt;li>combinations_with_replacement&lt;/li>
&lt;/ul>
&lt;h2 id="product">product&lt;/h2>
&lt;p>&lt;code>product&lt;/code> 用于求多个可迭代对象的笛卡尔积，它跟嵌套的 for 循环等价。它的一般使用形式如下：&lt;/p>
&lt;pre tabindex="0">&lt;code>product(iter1, iter2, ... iterN, [repeat=1])
&lt;/code>&lt;/pre>&lt;p>其中，repeat 是一个关键字参数，用于指定重复生成序列的次数，&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; from itertools import product
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; for item in product(&amp;#39;ABCD&amp;#39;, &amp;#39;xy&amp;#39;):
... print item
...
(&amp;#39;A&amp;#39;, &amp;#39;x&amp;#39;)
(&amp;#39;A&amp;#39;, &amp;#39;y&amp;#39;)
(&amp;#39;B&amp;#39;, &amp;#39;x&amp;#39;)
(&amp;#39;B&amp;#39;, &amp;#39;y&amp;#39;)
(&amp;#39;C&amp;#39;, &amp;#39;x&amp;#39;)
(&amp;#39;C&amp;#39;, &amp;#39;y&amp;#39;)
(&amp;#39;D&amp;#39;, &amp;#39;x&amp;#39;)
(&amp;#39;D&amp;#39;, &amp;#39;y&amp;#39;)
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; list(product(&amp;#39;ab&amp;#39;, range(3)))
[(&amp;#39;a&amp;#39;, 0), (&amp;#39;a&amp;#39;, 1), (&amp;#39;a&amp;#39;, 2), (&amp;#39;b&amp;#39;, 0), (&amp;#39;b&amp;#39;, 1), (&amp;#39;b&amp;#39;, 2)]
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; list(product((0,1), (0,1), (0,1)))
[(0, 0, 0), (0, 0, 1), (0, 1, 0), (0, 1, 1), (1, 0, 0), (1, 0, 1), (1, 1, 0), (1, 1, 1)]
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; list(product(&amp;#39;ABC&amp;#39;, repeat=2))
[(&amp;#39;A&amp;#39;, &amp;#39;A&amp;#39;), (&amp;#39;A&amp;#39;, &amp;#39;B&amp;#39;), (&amp;#39;A&amp;#39;, &amp;#39;C&amp;#39;), (&amp;#39;B&amp;#39;, &amp;#39;A&amp;#39;), (&amp;#39;B&amp;#39;, &amp;#39;B&amp;#39;), (&amp;#39;B&amp;#39;, &amp;#39;C&amp;#39;), (&amp;#39;C&amp;#39;, &amp;#39;A&amp;#39;), (&amp;#39;C&amp;#39;, &amp;#39;B&amp;#39;), (&amp;#39;C&amp;#39;, &amp;#39;C&amp;#39;)]
&amp;gt;&amp;gt;&amp;gt;
&lt;/code>&lt;/pre>&lt;h2 id="permutations">permutations&lt;/h2>
&lt;p>&lt;code>permutations&lt;/code> 用于生成一个排列，它的一般使用形式如下：&lt;/p>
&lt;pre tabindex="0">&lt;code>permutations(iterable[, r])
&lt;/code>&lt;/pre>&lt;p>其中，r 指定生成排列的元素的长度，如果不指定，则默认为可迭代对象的元素长度。&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; from itertools import permutations
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; permutations(&amp;#39;ABC&amp;#39;, 2)
&amp;lt;itertools.permutations object at 0x1074d9c50&amp;gt;
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; list(permutations(&amp;#39;ABC&amp;#39;, 2))
[(&amp;#39;A&amp;#39;, &amp;#39;B&amp;#39;), (&amp;#39;A&amp;#39;, &amp;#39;C&amp;#39;), (&amp;#39;B&amp;#39;, &amp;#39;A&amp;#39;), (&amp;#39;B&amp;#39;, &amp;#39;C&amp;#39;), (&amp;#39;C&amp;#39;, &amp;#39;A&amp;#39;), (&amp;#39;C&amp;#39;, &amp;#39;B&amp;#39;)]
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; list(permutations(&amp;#39;ABC&amp;#39;))
[(&amp;#39;A&amp;#39;, &amp;#39;B&amp;#39;, &amp;#39;C&amp;#39;), (&amp;#39;A&amp;#39;, &amp;#39;C&amp;#39;, &amp;#39;B&amp;#39;), (&amp;#39;B&amp;#39;, &amp;#39;A&amp;#39;, &amp;#39;C&amp;#39;), (&amp;#39;B&amp;#39;, &amp;#39;C&amp;#39;, &amp;#39;A&amp;#39;), (&amp;#39;C&amp;#39;, &amp;#39;A&amp;#39;, &amp;#39;B&amp;#39;), (&amp;#39;C&amp;#39;, &amp;#39;B&amp;#39;, &amp;#39;A&amp;#39;)]
&amp;gt;&amp;gt;&amp;gt;
&lt;/code>&lt;/pre>&lt;h2 id="combinations">combinations&lt;/h2>
&lt;p>&lt;code>combinations&lt;/code> 用于求序列的组合，它的使用形式如下：&lt;/p>
&lt;pre tabindex="0">&lt;code>combinations(iterable, r)
&lt;/code>&lt;/pre>&lt;p>其中，r 指定生成组合的元素的长度。&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; from itertools import combinations
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; list(combinations(&amp;#39;ABC&amp;#39;, 2))
[(&amp;#39;A&amp;#39;, &amp;#39;B&amp;#39;), (&amp;#39;A&amp;#39;, &amp;#39;C&amp;#39;), (&amp;#39;B&amp;#39;, &amp;#39;C&amp;#39;)]
&lt;/code>&lt;/pre>&lt;p>&lt;code>combinations_with_replacement&lt;/code> 和 &lt;code>combinations&lt;/code> 类似，但它生成的组合包含自身元素。&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; from itertools import combinations_with_replacement
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; list(combinations_with_replacement(&amp;#39;ABC&amp;#39;, 2))
[(&amp;#39;A&amp;#39;, &amp;#39;A&amp;#39;), (&amp;#39;A&amp;#39;, &amp;#39;B&amp;#39;), (&amp;#39;A&amp;#39;, &amp;#39;C&amp;#39;), (&amp;#39;B&amp;#39;, &amp;#39;B&amp;#39;), (&amp;#39;B&amp;#39;, &amp;#39;C&amp;#39;), (&amp;#39;C&amp;#39;, &amp;#39;C&amp;#39;)]
&lt;/code>&lt;/pre>&lt;h1 id="小结">小结&lt;/h1>
&lt;ul>
&lt;li>itertools 模块提供了很多用于产生多种类型迭代器的函数，它们的返回值不是 list，而是迭代器。&lt;/li>
&lt;/ul>
&lt;h1 id="参考链接">参考链接&lt;/h1>
&lt;ul>
&lt;li>&lt;a href="https://docs.python.org/2/library/itertools.html">itertools — Functions creating iterators for efficient looping&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://pymotw.com/2/itertools/">itertools – Iterator functions for efficient looping - Python Module of the Week&lt;/a>&lt;/li>
&lt;/ul></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>使用XPath解析HTML文档</title><link>https://blog.ferstar.org/post/%E4%BD%BF%E7%94%A8xpath%E8%A7%A3%E6%9E%90html%E6%96%87%E6%A1%A3/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E4%BD%BF%E7%94%A8xpath%E8%A7%A3%E6%9E%90html%E6%96%87%E6%A1%A3/</guid><pubDate>Mon, 24 Jul 2017 17:48:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>转自: &lt;a href="http://funhacks.net/2016/05/08/%E4%BD%BF%E7%94%A8XPath%E8%A7%A3%E6%9E%90HTML%E6%96%87%E6%A1%A3/">使用 XPath 解析 HTML 文档&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;h1 id="xpath-简介">XPath 简介&lt;/h1>
&lt;p>&lt;a href="https://www.w3.org/TR/xpath/">XPath&lt;/a> 的全称是 XML Path Language，即 XML 路径语言，它是一种在结构化文档（比如 XML 和 HTML 文档）中定位信息的语言，关于 XPath 的介绍可以参考 &lt;a href="https://www.w3.org/TR/xpath/%E3%80%82">https://www.w3.org/TR/xpath/。&lt;/a>&lt;/p>
&lt;h1 id="语法">语法&lt;/h1>
&lt;h2 id="html-实例文档">HTML 实例文档&lt;/h2>
&lt;p>后面我们将以下面的 HTML 文档介绍 XPath 的使用。&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;lt;html&amp;gt;
&amp;lt;head&amp;gt;
&amp;lt;base href=&amp;#39;http://example.com/&amp;#39; /&amp;gt;
&amp;lt;title&amp;gt;Example website&amp;lt;/title&amp;gt;
&amp;lt;/head&amp;gt;
&amp;lt;body&amp;gt;
&amp;lt;div id=&amp;#39;images&amp;#39;&amp;gt;
&amp;lt;a href=&amp;#39;image1.html&amp;#39;&amp;gt;Name: My image 1 &amp;lt;br/&amp;gt;&amp;lt;img src=&amp;#39;image1_thumb.jpg&amp;#39;/&amp;gt;&amp;lt;/a&amp;gt;
&amp;lt;a href=&amp;#39;image2.html&amp;#39;&amp;gt;Name: My image 2 &amp;lt;br/&amp;gt;&amp;lt;img src=&amp;#39;image2_thumb.jpg&amp;#39;/&amp;gt;&amp;lt;/a&amp;gt;
&amp;lt;a href=&amp;#39;image3.html&amp;#39;&amp;gt;Name: My image 3 &amp;lt;br/&amp;gt;&amp;lt;img src=&amp;#39;image3_thumb.jpg&amp;#39;/&amp;gt;&amp;lt;/a&amp;gt;
&amp;lt;a href=&amp;#39;image4.html&amp;#39;&amp;gt;Name: My image 4 &amp;lt;br/&amp;gt;&amp;lt;img src=&amp;#39;image4_thumb.jpg&amp;#39;/&amp;gt;&amp;lt;/a&amp;gt;
&amp;lt;a&amp;gt;Name: My image 5 &amp;lt;br/&amp;gt;&amp;lt;img src=&amp;#39;image5_thumb.jpg&amp;#39;/&amp;gt;&amp;lt;/a&amp;gt;
&amp;lt;/div&amp;gt;
&amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;
&lt;/code>&lt;/pre>&lt;h2 id="选取节点">选取节点&lt;/h2>
&lt;p>下表是 XPath 常用的语法，实例对应的是上面的 HTML 文档。&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>表达式&lt;/th>
&lt;th>描述&lt;/th>
&lt;th>实例&lt;/th>
&lt;th>结果&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>nodename&lt;/td>
&lt;td>选取此节点的所有子节点&lt;/td>
&lt;td>body&lt;/td>
&lt;td>选取 body 元素的所有子节点&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>/&lt;/td>
&lt;td>从根节点选取&lt;/td>
&lt;td>/html&lt;/td>
&lt;td>选取根元素 html&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>//&lt;/td>
&lt;td>匹配选择的当前节点，不考虑位置&lt;/td>
&lt;td>//img&lt;/td>
&lt;td>选取所有 img 元素，而不管它们在文档的位置&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>.&lt;/td>
&lt;td>选取当前节点&lt;/td>
&lt;td>./img&lt;/td>
&lt;td>选取当前节点下的 img 节点&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>..&lt;/td>
&lt;td>选取当前节点的父节点&lt;/td>
&lt;td>../img&lt;/td>
&lt;td>选取当前节点的父节点下的 title&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>@&lt;/td>
&lt;td>选取属性&lt;/td>
&lt;td>//a[@href=”image1.html”]&lt;/td>
&lt;td>选取所有 href 属性为 “image1.html” 的 a 节点&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>//a/@href&lt;/td>
&lt;td>获取所有 a 节点的 href 属性的值&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="谓语">谓语&lt;/h2>
&lt;blockquote>
&lt;p>谓语用来查找某个特定的节点或者包含某个指定的值的节点，谓语嵌在方括号中。&lt;/p>
&lt;/blockquote>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>路径表达式&lt;/th>
&lt;th>结果&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>//body//a[1]&lt;/td>
&lt;td>选取属于 body 子元素的第一个 a 元素&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>//body//a[last()]&lt;/td>
&lt;td>选取属于 body 子元素的最好一个 a 元素&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>//a[@href]&lt;/td>
&lt;td>选取所有拥有名为 href 的属性的 a 元素&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>//a[@href=’image2.html’]&lt;/td>
&lt;td>选取所有 href 属性等于 “image2.html” 的 a 元素&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h1 id="在-python-中使用">在 Python 中使用&lt;/h1>
&lt;p>在 &lt;code>python&lt;/code> 中使用 &lt;code>XPath&lt;/code> 需要安装相应的库，这里推荐使用 &lt;a href="http://lxml.de/">lxml&lt;/a> 库。&lt;/p>
&lt;p>代码示例：&lt;/p>
&lt;pre tabindex="0">&lt;code># -*- coding: utf-8 -*-
from lxml import etree
html = &amp;#34;&amp;#34;&amp;#34;
&amp;lt;html&amp;gt;
&amp;lt;head&amp;gt;
&amp;lt;base href=&amp;#39;http://example.com/&amp;#39; /&amp;gt;
&amp;lt;title&amp;gt;Example website&amp;lt;/title&amp;gt;
&amp;lt;/head&amp;gt;
&amp;lt;body&amp;gt;
&amp;lt;div id=&amp;#39;images&amp;#39;&amp;gt;
&amp;lt;a href=&amp;#39;image1.html&amp;#39;&amp;gt;Name: My image 1 &amp;lt;br/&amp;gt;&amp;lt;img src=&amp;#39;image1_thumb.jpg&amp;#39;/&amp;gt;&amp;lt;/a&amp;gt;
&amp;lt;a href=&amp;#39;image2.html&amp;#39;&amp;gt;Name: My image 2 &amp;lt;br/&amp;gt;&amp;lt;img src=&amp;#39;image2_thumb.jpg&amp;#39;/&amp;gt;&amp;lt;/a&amp;gt;
&amp;lt;a href=&amp;#39;image3.html&amp;#39;&amp;gt;Name: My image 3 &amp;lt;br/&amp;gt;&amp;lt;img src=&amp;#39;image3_thumb.jpg&amp;#39;/&amp;gt;&amp;lt;/a&amp;gt;
&amp;lt;a href=&amp;#39;image4.html&amp;#39;&amp;gt;Name: My image 4 &amp;lt;br/&amp;gt;&amp;lt;img src=&amp;#39;image4_thumb.jpg&amp;#39;/&amp;gt;&amp;lt;/a&amp;gt;
&amp;lt;a&amp;gt;Name: My image 5 &amp;lt;br/&amp;gt;&amp;lt;img src=&amp;#39;image5_thumb.jpg&amp;#39;/&amp;gt;&amp;lt;/a&amp;gt;
&amp;lt;/div&amp;gt;
&amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;
&amp;#34;&amp;#34;&amp;#34;
page_source = etree.HTML(html.decode(&amp;#39;utf-8&amp;#39;))
title = page_source.xpath(&amp;#34;//title/text()&amp;#34;)
all_href = page_source.xpath(&amp;#34;//a/@href&amp;#34;)
a_image1_text = page_source.xpath(&amp;#34;//body//a[1]/text()&amp;#34;)
a_image1_src = page_source.xpath(&amp;#34;//a[@href=&amp;#39;image1.html&amp;#39;]/img/@src&amp;#34;)
a_image3_href = page_source.xpath(&amp;#34;//a[contains(@href, &amp;#39;3&amp;#39;)]/@href&amp;#34;)
a_last = page_source.xpath(&amp;#34;//body//a[last()]/img/@src&amp;#34;)
all_img_src = page_source.xpath(&amp;#34;//img/@src&amp;#34;)
print &amp;#34;Title&amp;#34;, title
print &amp;#34;all href&amp;#34;, all_href
print &amp;#34;a_image1_text&amp;#34;, a_image1_text
print &amp;#34;a_image1_src&amp;#34;, a_image1_src
print &amp;#39;a_image3_href&amp;#39;, a_image3_href
print &amp;#34;a_last&amp;#34;, a_last
print &amp;#34;all_img_src&amp;#34;, all_img_src
&lt;/code>&lt;/pre>&lt;p>输出结果如下：&lt;/p>
&lt;pre tabindex="0">&lt;code>Title [&amp;#39;Example website&amp;#39;]
all href [&amp;#39;image1.html&amp;#39;, &amp;#39;image2.html&amp;#39;, &amp;#39;image3.html&amp;#39;, &amp;#39;image4.html&amp;#39;]
a_image1_text [&amp;#39;Name: My image 1 &amp;#39;]
a_image1_src [&amp;#39;image1_thumb.jpg&amp;#39;]
a_image3_href [&amp;#39;image3.html&amp;#39;]
a_last [&amp;#39;image5_thumb.jpg&amp;#39;]
all_img_src [&amp;#39;image1_thumb.jpg&amp;#39;, &amp;#39;image2_thumb.jpg&amp;#39;, &amp;#39;image3_thumb.jpg&amp;#39;, &amp;#39;image4_thumb.jpg&amp;#39;, &amp;#39;image5_thumb.jpg&amp;#39;]
&lt;/code>&lt;/pre>&lt;p>要注意的是，如果 xpath() 找到了匹配的数据，返回的结果是一个数组，不管是一个还是多个，比如结果中的 &lt;code>Title&lt;/code>。&lt;/p>
&lt;h1 id="参考资料">参考资料&lt;/h1>
&lt;ul>
&lt;li>&lt;a href="https://www.websiteplanet.com/blog/html-guide-beginners/">Basic HTML Codes for Beginners(thanks @Abby)&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.w3.org/TR/xpath/">XML Path Language (XPath)&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://lxml.de/">lxml - Processing XML and HTML with Python&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://www.w3school.com.cn/xpath/xpath_syntax.asp">XPath 语法&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://www.w3school.com.cn/xpath/xpath_functions.asp">XPath、XQuery 以及 XSLT 函数&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://astraylinux.com/2014/08/21/server-xpath-pick-html/">xpath提取HTML // Astray Linux&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://scrapy-chs.readthedocs.io/zh_CN/1.0/topics/selectors.html">选择器(Selectors) — Scrapy 1.0.5 文档&lt;/a>&lt;/li>
&lt;/ul></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/xpath/">XPATH</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/html/">HTML</category></item><item><title>python中使用eval和ast.literal_eval的区别</title><link>https://blog.ferstar.org/post/python%E4%B8%AD%E4%BD%BF%E7%94%A8eval%E5%92%8Cast/</link><guid isPermaLink="true">https://blog.ferstar.org/post/python%E4%B8%AD%E4%BD%BF%E7%94%A8eval%E5%92%8Cast/</guid><pubDate>Mon, 24 Jul 2017 17:41:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>转自: &lt;a href="http://blog.csdn.net/yisuowushinian/article/details/45644299">python中使用eval() 和 ast.literal_eval()的区别&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>eval函数在python中做数据类型的转换还是很有用的。它的作用就是把数据还原成它本身或者是能够转化成的数据类型。&lt;/p>
&lt;p>那么eval和ast.literal_val的区别是什么呢？&lt;/p>
&lt;p>eval在做计算前并不知道需要转化的内容是不是合法的（安全的）python数据类型。只是在调用函数的时候去计算。如果被计算的内容不是合法的python类型就会抛出异常。&lt;/p>
&lt;p>ast.literal则会判断需要计算的内容计算后是不是合法的python类型，如果是则进行运算，否则就不进行运算。&lt;/p>
&lt;p>------------------------------引用自stackoverflow--------------------------------&lt;/p>
&lt;p>&lt;code>datamap = eval(raw_input('Provide some data here: ')&lt;/code> means that you actually evaluate the code before you deem it to be unsafe or not. It evaluates the code as soon as the function is called. See also &lt;a href="http://nedbatchelder.com/blog/201206/eval_really_is_dangerous.html">the dangers of &lt;code>eval&lt;/code>&lt;/a>.&lt;/p>
&lt;p>&lt;code>ast.literal_eval&lt;/code> raises an exception if the input isn't a valid Python datatype, so the code won't be executed if it's not.&lt;/p>
&lt;p>Use &lt;code>ast.literal_eval&lt;/code> whenever you need &lt;code>eval&lt;/code>. If you have Python expressions as an input that you want to evaluate, you shouldn't (have them).&lt;/p>
&lt;p>嗯, 就是建议无脑用&lt;code>ast.literal_eval&lt;/code>代替&lt;code>eval&lt;/code>就欧了&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>Python 如何将字符串转为字典</title><link>https://blog.ferstar.org/post/python-%E5%A6%82%E4%BD%95%E5%B0%86%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BD%AC%E4%B8%BA%E5%AD%97%E5%85%B8/</link><guid isPermaLink="true">https://blog.ferstar.org/post/python-%E5%A6%82%E4%BD%95%E5%B0%86%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BD%AC%E4%B8%BA%E5%AD%97%E5%85%B8/</guid><pubDate>Mon, 24 Jul 2017 16:40:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>转自: &lt;a href="http://funhacks.net/2016/04/24/python_%E5%B0%86%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BD%AC%E4%B8%BA%E5%AD%97%E5%85%B8/">Python 如何将字符串转为字典&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;h1 id="引言">引言&lt;/h1>
&lt;p>在工作中遇到一个小问题，需要将一个 &lt;code>python&lt;/code> 的字符串转为字典，比如字符串：&lt;/p>
&lt;pre tabindex="0">&lt;code>user_info = &amp;#39;{&amp;#34;name&amp;#34; : &amp;#34;john&amp;#34;, &amp;#34;gender&amp;#34; : &amp;#34;male&amp;#34;, &amp;#34;age&amp;#34;: 28}&amp;#39;
&lt;/code>&lt;/pre>&lt;p>我们想把它转为下面的字典：&lt;/p>
&lt;pre tabindex="0">&lt;code>user_dict = {&amp;#34;name&amp;#34; : &amp;#34;john&amp;#34;, &amp;#34;gender&amp;#34; : &amp;#34;male&amp;#34;, &amp;#34;age&amp;#34;: 28}
&lt;/code>&lt;/pre>&lt;p>有以下几种方法：&lt;/p>
&lt;h1 id="通过-json-来转换">通过 json 来转换&lt;/h1>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; import json
&amp;gt;&amp;gt;&amp;gt; user_info= &amp;#39;{&amp;#34;name&amp;#34; : &amp;#34;john&amp;#34;, &amp;#34;gender&amp;#34; : &amp;#34;male&amp;#34;, &amp;#34;age&amp;#34;: 28}&amp;#39;
&amp;gt;&amp;gt;&amp;gt; user_dict = json.loads(user_info)
&amp;gt;&amp;gt;&amp;gt; user_dict
{u&amp;#39;gender&amp;#39;: u&amp;#39;male&amp;#39;, u&amp;#39;age&amp;#39;: 28, u&amp;#39;name&amp;#39;: u&amp;#39;john&amp;#39;}
&lt;/code>&lt;/pre>&lt;p>但是使用 &lt;code>json&lt;/code> 进行转换存在一个潜在的问题。&lt;/p>
&lt;p>由于 &lt;code>json&lt;/code> 语法规定 &lt;strong>数组或对象之中的字符串必须使用双引号，不能使用单引号&lt;/strong> (&lt;a href="http://json.org/">官网&lt;/a>上有一段描述是 “A string is a sequence of zero or more Unicode characters, wrapped in double quotes, using backslash escapes” )，因此下面的转换是错误的：&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; import json
&amp;gt;&amp;gt;&amp;gt; user_info = &amp;#34;{&amp;#39;name&amp;#39; : &amp;#39;john&amp;#39;, &amp;#39;gender&amp;#39; : &amp;#39;male&amp;#39;, &amp;#39;age&amp;#39;: 28}&amp;#34;
# 由于字符串使用单引号，会导致运行出错
&amp;gt;&amp;gt;&amp;gt; user_dict = json.loads(user_info)
Traceback (most recent call last):
File &amp;#34;&amp;lt;stdin&amp;gt;&amp;#34;, line 1, in &amp;lt;module&amp;gt;
File &amp;#34;/usr/local/Cellar/python/2.7.11/Frameworks/Python.framework/Versions/2.7/lib/python2.7/json/__init__.py&amp;#34;, line 339, in loads
return _default_decoder.decode(s)
File &amp;#34;/usr/local/Cellar/python/2.7.11/Frameworks/Python.framework/Versions/2.7/lib/python2.7/json/decoder.py&amp;#34;, line 364, in decode
obj, end = self.raw_decode(s, idx=_w(s, 0).end())
File &amp;#34;/usr/local/Cellar/python/2.7.11/Frameworks/Python.framework/Versions/2.7/lib/python2.7/json/decoder.py&amp;#34;, line 380, in raw_decode
obj, end = self.scan_once(s, idx)
ValueError: Expecting property name: line 1 column 2 (char 1)
&lt;/code>&lt;/pre>&lt;h1 id="通过-eval">通过 eval&lt;/h1>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; user_info = &amp;#39;{&amp;#34;name&amp;#34; : &amp;#34;john&amp;#34;, &amp;#34;gender&amp;#34; : &amp;#34;male&amp;#34;, &amp;#34;age&amp;#34;: 28}&amp;#39;
&amp;gt;&amp;gt;&amp;gt; user_dict = eval(user_info)
&amp;gt;&amp;gt;&amp;gt; user_dict
{&amp;#39;gender&amp;#39;: &amp;#39;male&amp;#39;, &amp;#39;age&amp;#39;: 28, &amp;#39;name&amp;#39;: &amp;#39;john&amp;#39;}
&amp;gt;&amp;gt;&amp;gt; user_info = &amp;#34;{&amp;#39;name&amp;#39; : &amp;#39;john&amp;#39;, &amp;#39;gender&amp;#39; : &amp;#39;male&amp;#39;, &amp;#39;age&amp;#39;: 28}&amp;#34;
&amp;gt;&amp;gt;&amp;gt; user_dict = eval(user_info)
&amp;gt;&amp;gt;&amp;gt; user_dict
{&amp;#39;gender&amp;#39;: &amp;#39;male&amp;#39;, &amp;#39;age&amp;#39;: 28, &amp;#39;name&amp;#39;: &amp;#39;john&amp;#39;}
&lt;/code>&lt;/pre>&lt;p>通过 &lt;code>eval&lt;/code> 进行转换就不存在上面使用 &lt;code>json&lt;/code> 进行转换的问题。但是，使用 &lt;code>eval&lt;/code> 却存在&lt;code>安全性的问题&lt;/code>，比如下面的例子:&lt;/p>
&lt;pre tabindex="0">&lt;code># 让用户输入 `user_info`
&amp;gt;&amp;gt;&amp;gt; user_info = raw_input(&amp;#39;input user info: &amp;#39;)
# 输入 {&amp;#34;name&amp;#34; : &amp;#34;john&amp;#34;, &amp;#34;gender&amp;#34; : &amp;#34;male&amp;#34;, &amp;#34;age&amp;#34;: 28}，没问题
&amp;gt;&amp;gt;&amp;gt; user_dict = eval(user_info)
# 输入 __import__(&amp;#39;os&amp;#39;).system(&amp;#39;dir&amp;#39;)，user_dict 会列出当前的目录文件！
# 再输入一些删除命令，则可以把整个目录清空了！
&amp;gt;&amp;gt;&amp;gt; user_dict = eval(user_info)
&lt;/code>&lt;/pre>&lt;h1 id="通过-literal_eval">通过 literal_eval&lt;/h1>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; import ast
&amp;gt;&amp;gt;&amp;gt; user = &amp;#39;{&amp;#34;name&amp;#34; : &amp;#34;john&amp;#34;, &amp;#34;gender&amp;#34; : &amp;#34;male&amp;#34;, &amp;#34;age&amp;#34;: 28}&amp;#39;
&amp;gt;&amp;gt;&amp;gt; user_dict = ast.literal_eval(user)
&amp;gt;&amp;gt;&amp;gt; user_dict
{&amp;#39;gender&amp;#39;: &amp;#39;male&amp;#39;, &amp;#39;age&amp;#39;: 28, &amp;#39;name&amp;#39;: &amp;#39;john&amp;#39;}
user_info = &amp;#34;{&amp;#39;name&amp;#39; : &amp;#39;john&amp;#39;, &amp;#39;gender&amp;#39; : &amp;#39;male&amp;#39;, &amp;#39;age&amp;#39;: 28}&amp;#34;
&amp;gt;&amp;gt;&amp;gt; user_dict = ast.literal_eval(user)
&amp;gt;&amp;gt;&amp;gt; user_dict
{&amp;#39;gender&amp;#39;: &amp;#39;male&amp;#39;, &amp;#39;age&amp;#39;: 28, &amp;#39;name&amp;#39;: &amp;#39;john&amp;#39;}
&lt;/code>&lt;/pre>&lt;p>使用 &lt;code>ast.literal_eval&lt;/code> 进行转换既不存在使用 &lt;code>json&lt;/code> 进行转换的问题，也不存在使用 &lt;code>eval&lt;/code> 进行转换的 &lt;code>安全性问题&lt;/code>，因此推荐使用 &lt;code>ast.literal_eval&lt;/code>。&lt;/p>
&lt;h1 id="参考资料">参考资料&lt;/h1>
&lt;ul>
&lt;li>&lt;a href="http://json.org/">JSON&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://stackoverflow.com/questions/4162642/python-single-vs-double-quotes-in-json">python: single vs double quotes in JSON - Stack Overflow&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://stackoverflow.com/questions/15197673/using-pythons-eval-vs-ast-literal-eval">Using python’s eval() vs. ast.literal_eval()? - Stack Overflow&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://javascript.ruanyifeng.com/stdlib/json.html">JSON对象 – JavaScript 标准参考教程（alpha）&lt;/a>&lt;/li>
&lt;/ul></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/json/">JSON</category></item><item><title>mongoengine 基本使用</title><link>https://blog.ferstar.org/post/mongoengine-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/</link><guid isPermaLink="true">https://blog.ferstar.org/post/mongoengine-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/</guid><pubDate>Mon, 24 Jul 2017 16:16:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>转自 &lt;a href="http://funhacks.net/2016/04/03/mongoengine_%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/">mongoengine 基本使用&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>&lt;a href="http://funhacks.net/2016/03/26/pymongo%20%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/">上一篇博文&lt;/a>介绍了 &lt;code>pymongo&lt;/code>的基本使用，本文则介绍 &lt;a href="http://mongoengine.org/">mongoengine&lt;/a> 的基本使用，&lt;code>mongoengine&lt;/code> 底层使用的是&lt;code>pymongo&lt;/code> 库。&lt;/p>
&lt;p>本文所使用的 &lt;code>mongoengine&lt;/code> 版本是 0.10.6。&lt;/p>
&lt;h1 id="定义文档模式">定义文档模式&lt;/h1>
&lt;p>与&lt;code>pymongo&lt;/code>不同的是，使用&lt;code>mongoengine&lt;/code>需要先定义文档模式，比如，我们定义一个&lt;code>Student&lt;/code>的文档：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-Python" data-lang="Python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Student&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">DynamicDocument&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">meta&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;collection&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;student&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;strict&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">False&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">stu_id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">IntField&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">age&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">IntField&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">StringField&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">gender&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">StringField&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="基本操作">基本操作&lt;/h1>
&lt;p>下面的代码主要介绍了 &lt;code>mongoengine&lt;/code> 的基本操作: 插入数据，更新数据，查找数据，删除数据。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-Python" data-lang="Python">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># -*- coding: utf-8 -*-&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># mongoengine==0.10.6&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">mongoengine&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="o">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 定义文档模式&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Student&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">DynamicDocument&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">meta&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;collection&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;student&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;strict&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">False&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">stu_id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">IntField&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">age&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">IntField&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">StringField&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">gender&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">StringField&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">insert_data&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34; 插入数据 &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 一种方法&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">peter&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Student&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">peter&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">stu_id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">101&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">peter&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;Peter&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">peter&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">gender&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;male&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">peter&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">save&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 另一种方法&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">john&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Student&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stu_id&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">102&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;John Smith&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">gender&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;male&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">save&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">update_data&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34; 更新数据 &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 年龄,注意用双下划线&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Student&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">objects&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stu_id&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">101&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">update_one&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">set__age&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">23&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Student&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">objects&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stu_id&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">102&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">update_one&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">set__age&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">26&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 新增联系方式&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">peter_contact&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">dict&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">phone&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;13238985676&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">email&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;peter@example.com&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">john_contact&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">dict&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">phone&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;18034567890&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">email&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;john@example.com&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># peter&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Student&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">objects&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stu_id&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">101&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">update_one&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">set__contact&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">peter_contact&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">upsert&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># john&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Student&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">objects&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stu_id&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">102&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">update_one&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">set__contact&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">john_contact&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">upsert&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">search_data&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34; 查找数据 &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 查找全部&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">result_all&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Student&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">objects&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">all&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s2">&amp;#34;count of all records is : &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">result_all&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 查找 stu_id 为 101 的学生&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">result_1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Student&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">objects&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stu_id&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">101&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">first&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s2">&amp;#34;result_1.name is : &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">result_1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s2">&amp;#34;result_1.gender is : &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">result_1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">gender&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 查找性别为男, 手机号为 18034567890, 注意用双下划线&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">result_2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Student&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">objects&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">gender&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;male&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">contact__phone&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;18034567890&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">first&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s2">&amp;#34;result_2.name is : &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">result_2&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 查找年龄大于 25, 注意用双下划线&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">result_3&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Student&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">objects&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">age__gt&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">25&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">all&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">element&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">result_3&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="n">element&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">delete_data&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34; 删除数据 &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 删除 stu_id 为 101 的联系方式, 注意用双下划线&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Student&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">objects&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">stu_id&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">101&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">update&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">unset__contact&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="vm">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 连接数据库 &amp;#39;people&amp;#39;, 没有则创建&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">connect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;people&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">host&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;127.0.0.1&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">port&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">27017&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">insert_data&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">update_data&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">search_data&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">delete_data&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="常用查询操作符">常用查询操作符&lt;/h2>
&lt;ul>
&lt;li>gt 大于，如 &lt;code>Student.objects(age__gt=18)&lt;/code>&lt;/li>
&lt;li>gte 大于等于&lt;/li>
&lt;li>ne 不等于&lt;/li>
&lt;li>lt 小于&lt;/li>
&lt;li>lte 小于等于&lt;/li>
&lt;li>mod 取模&lt;/li>
&lt;li>not 取反，用在其他操作符前面，如 &lt;code>Student.objects(age__not__mod=5)&lt;/code>&lt;/li>
&lt;li>in 值在列表中，如 &lt;code>Blog.objects(authors__in=[peter, john])&lt;/code>&lt;/li>
&lt;li>nin 值不在列表中&lt;/li>
&lt;li>all 与列表的值相同，如 &lt;code>Blog.objects(authors__all=[peter, john])&lt;/code>&lt;/li>
&lt;li>size 数组的大小&lt;/li>
&lt;li>exists 字段是否存在，如 &lt;code>Student.objects(age__exists=1)&lt;/code>&lt;/li>
&lt;/ul>
&lt;h2 id="高级查询">高级查询&lt;/h2>
&lt;p>有时我们需要进行 &lt;code>与查询&lt;/code> 和 &lt;code>或查询&lt;/code>，也就是对多个条件进行查询，这时可以使用 &lt;a href="http://docs.mongoengine.org/guide/querying.html">MongoEngine 的 Q 类 (Q class)&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-Python" data-lang="Python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">mongoengine.queryset.visitor&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">Q&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查找性别为男, 且手机号为 18034567890 的记录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Student&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">objects&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Q&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">gender&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;male&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">Q&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">contact__phone&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;18034567890&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查找性别为男, 或者手机号为 18034567890 的记录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Student&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">objects&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Q&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">gender&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;male&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">Q&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">contact__phone&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;18034567890&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查找性别为男, 且手机号为 18034567890 的记录 或者 性别为女的记录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Student&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">objects&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">Q&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">gender&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;male&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">Q&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">contact__phone&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;18034567890&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">Q&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">gender&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;female&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="常用更新操作符">常用更新操作符&lt;/h2>
&lt;p>这里我们以一个 &lt;code>Blog&lt;/code> 的文档为例，定义如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-Python" data-lang="Python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Blog&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Document&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">title&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">StringField&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">authors&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ListField&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">content&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">StringField&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>&lt;code>set&lt;/code> 设置某个值，如 &lt;code>Blog.objects(id=...).update_one(set__title='my first blog')&lt;/code>&lt;/li>
&lt;li>&lt;code>unset&lt;/code> 删除某个值&lt;/li>
&lt;li>&lt;code>push&lt;/code> 将某个值添加到列表中，如 &lt;code>Blog.objects(id=...).update_one(push__authors='john')&lt;/code>&lt;/li>
&lt;li>&lt;code>push_all&lt;/code> 将某些值添加到列表中&lt;/li>
&lt;li>&lt;code>pull&lt;/code> 将某个值从列表移除，如 &lt;code>Blog.objects(id=...).update_one(pull__authors='john')&lt;/code>&lt;/li>
&lt;li>&lt;code>pull_all&lt;/code> 将某些值从列表移除&lt;/li>
&lt;li>&lt;code>add_to_set&lt;/code> 当某个值不在列表中的时候，将其添加到列表，如果存在则不添加，如
&lt;code>Blog.objects(id=...).update_one(add_to_set__authors='john')&lt;/code>&lt;/li>
&lt;/ul>
&lt;h1 id="连接多个数据库">连接多个数据库&lt;/h1>
&lt;p>假设有两个数据库 &lt;code>people&lt;/code> 和 &lt;code>course&lt;/code>，定义如下的两个文档模式：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-Python" data-lang="Python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Student&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">DynamicDocument&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">meta&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;db_alias&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;people-db&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;collection&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;student&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;strict&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">False&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">stu_id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">IntField&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">age&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">IntField&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">StringField&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">gender&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">StringField&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-Python" data-lang="Python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Math&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">DynamicDocument&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">meta&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;db_alias&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;course-db&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;collection&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;math&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;strict&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">False&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">math_id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">IntField&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">math_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">StringField&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">teacher&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">StringField&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如果要连接这两个数据库，可以这么使用：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-Python" data-lang="Python">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># -*- coding: utf-8 -*-&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="vm">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 连接数据库 people&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">register_connection&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;people-db&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;people&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 连接数据库 course&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">register_connection&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;course-db&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;course&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">math_records&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Math&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">objects&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">all&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">student_records&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Student&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">objects&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">all&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="参考资料">参考资料&lt;/h1>
&lt;ul>
&lt;li>&lt;a href="http://docs.mongoengine.org/tutorial.html">MongoEngine&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://docs.mongoengine.org/guide/querying.html">MongoEngine 查询&lt;/a>&lt;/li>
&lt;/ul></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/mongoengine/">MONGOENGINE</category></item><item><title>pymongo 基本使用</title><link>https://blog.ferstar.org/post/pymongo-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/</link><guid isPermaLink="true">https://blog.ferstar.org/post/pymongo-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/</guid><pubDate>Mon, 24 Jul 2017 16:11:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>转自&lt;a href="http://funhacks.net/2016/03/26/pymongo%20%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/">pymongo 基本使用&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>&lt;a href="https://api.mongodb.org/python/current/tutorial.html">pymongo&lt;/a> 是在 &lt;code>python&lt;/code> 中操作 &lt;code>mongodb&lt;/code> 的一个包，使用方法跟 &lt;code>mongodb&lt;/code> 的 &lt;code>shell&lt;/code> 命令行类似。本文使用的&lt;code>pymongo&lt;/code> 版本是 &lt;code>3.2.1&lt;/code>。&lt;/p>
&lt;h1 id="连接数据库">连接数据库&lt;/h1>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># -*- coding: utf-8 -*-&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># pymongo 版本 3.2.1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">re&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">pymongo&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">MongoClient&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">bson.objectid&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">ObjectId&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">con_mongo&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;连接数据库&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 建立连接&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">MongoClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">host&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;127.0.0.1&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">port&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">27017&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">client&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="插入数据">插入数据&lt;/h1>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">insert_data&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;插入数据
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :return:
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">con_mongo&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 文档数据&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">record_list&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">dict1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;lucy&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;sex&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;female&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;job&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Nurse&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;age&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">23&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">dict2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;peter&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;sex&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;male&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;job&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Teacher&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;age&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">22&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">dict3&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Jay&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;sex&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;male&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;job&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Engineer&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;age&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">28&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">dict4&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;layr&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;sex&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;male&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;job&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Engineer&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;age&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">29&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">record_list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dict1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">record_list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dict2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">record_list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dict3&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">record_list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dict4&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># insert data to db:test/collection: user&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">insert_many&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">record_list&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="更新数据">更新数据&lt;/h1>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-Python" data-lang="Python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">update_data&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;更新数据
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :return:
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">con_mongo&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 更新 lucy 的年龄&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">new_age&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;age&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">25&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">update_one&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="s1">&amp;#39;name&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;lucy&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;$set&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">new_age&lt;/span>&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">update_one&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="s1">&amp;#39;name&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;lucy&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;$set&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;age&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">26&lt;/span>&lt;span class="p">}})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 所有记录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">record&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">find&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 添加国家信息&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">coutry_info&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;country&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;China&amp;#39;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 每条记录都添加&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">item&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">record&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">_id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ObjectId&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;_id&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">update_one&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="s1">&amp;#39;_id&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">_id&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;$set&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">coutry_info&lt;/span>&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 新的记录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">new_record&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;john&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;sex&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;male&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;job&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Student&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">new_record2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Tom&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;job&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Hacker&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 使用 upsert(update+insert), 根据条件判断有无记录，有的话就更新记录，没有的话就插入一条记录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">update_one&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="s1">&amp;#39;job&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;Student&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;$set&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">new_record&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="n">upsert&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">False&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">update_one&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="s1">&amp;#39;job&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;Student&amp;#39;&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;$set&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">new_record2&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="n">upsert&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="查找数据">查找数据&lt;/h1>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-Python" data-lang="Python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">search_data&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34; search data
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :return:
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">con_mongo&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 年龄大于 25 且小于 30 且不等于 29&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">age_res&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">find&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="s2">&amp;#34;age&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;$gt&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">25&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;$lt&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">30&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;$ne&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">29&lt;/span>&lt;span class="p">}})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">item&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">age_res&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">age&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">item&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;age&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s2">&amp;#34;expected age info: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">age&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pattern_string1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;^l&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pattern_string2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;r$&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">regx1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">re&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">compile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pattern_string1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">re&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">IGNORECASE&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">regx2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">re&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">compile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pattern_string2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">re&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">IGNORECASE&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">regx_list&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">regx1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">regx2&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># name 以 &amp;#39;l&amp;#39; 开头且以 &amp;#39;r&amp;#39; 结尾&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">res_and&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">find&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;$all&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">regx_list&lt;/span>&lt;span class="p">}})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">item&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">res_and&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">item&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;name&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s2">&amp;#34;name that begins with &amp;#39;l&amp;#39; and ends with &amp;#39;r&amp;#39; are &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># name 以 &amp;#39;l&amp;#39; 开头或以 &amp;#39;r&amp;#39; 结尾&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">res_or&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">find&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;$in&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">regx_list&lt;/span>&lt;span class="p">}})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">item&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">res_or&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">item&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;name&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s2">&amp;#34;name that begins with &amp;#39;l&amp;#39; or ends with &amp;#39;r&amp;#39; are &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># name 以 &amp;#39;l&amp;#39; 开头或以 &amp;#39;r&amp;#39; 结尾 -- 第 2 种方法&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pattern_strings&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;^l&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;r$&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pattern_string&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;|&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pattern_strings&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">regx&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">re&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">compile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pattern_string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">re&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">IGNORECASE&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">res&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">find&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">regx&lt;/span>&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">item&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">res&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">item&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;name&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s2">&amp;#34;name that begins with &amp;#39;l&amp;#39; or ends with &amp;#39;r&amp;#39; are &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">name&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="查询常用语句">查询常用语句&lt;/h2>
&lt;ul>
&lt;li>比较运算&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-Python" data-lang="Python">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 年龄大于 20&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">db&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">collection&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">find&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="s2">&amp;#34;age&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;$gt&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">20&lt;/span>&lt;span class="p">}})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 年龄小于 20&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">db&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">collection&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">find&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="s2">&amp;#34;age&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;$lt&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">20&lt;/span>&lt;span class="p">}})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 年龄大于等于 20&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">db&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">collection&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">find&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="s2">&amp;#34;age&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;$gte&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">20&lt;/span>&lt;span class="p">}})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 年龄小于等于 20&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">db&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">collection&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">find&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="s2">&amp;#34;age&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;$lte&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">20&lt;/span>&lt;span class="p">}})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 年龄大于 20 且 小于 30 且不等于 25&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">db&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">collection&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">find&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="s2">&amp;#34;age&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;$gt&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">20&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;$lt&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">30&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;$ne&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">25&lt;/span>&lt;span class="p">}})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>&lt;code>$exists&lt;/code> 字段是否存在&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-Python" data-lang="Python">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># name 字段存在或不存在&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">db&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">collection&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">find&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="s1">&amp;#39;name&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;$exists&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">True&lt;/span>&lt;span class="p">}})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">db&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">collection&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">find&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="s1">&amp;#39;name&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;$exists&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">False&lt;/span>&lt;span class="p">}})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>&lt;code>$or&lt;/code> 查询&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-Python" data-lang="Python">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查找 a=1 或 b=2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">db&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">collection&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">find&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="s1">&amp;#39;$or&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[{&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">b&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">}]})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>&lt;code>$in&lt;/code> 查询&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-Python" data-lang="Python">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># a 属于 [1,2,3]中的任何一个&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">db&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">collection&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">find&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;$in&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">]}})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># a 不属于 [1,2,3]中的任何一个&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">db&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">collection&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">find&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;$nin&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">]}})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>&lt;code>$all&lt;/code> 查询&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-Python" data-lang="Python">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 全部属于&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">db&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">collection&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">find&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;$all&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">]}})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="reference">Reference&lt;/h1>
&lt;ol>
&lt;li>&lt;a href="https://api.mongodb.org/python/current/tutorial.html">PyMongo 3.2.2 documentation&lt;/a>&lt;/li>
&lt;/ol></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/pymongo/">PYMONGO</category></item><item><title>Python时间戳处理</title><link>https://blog.ferstar.org/post/python%E6%97%B6%E9%97%B4%E6%88%B3%E5%A4%84%E7%90%86/</link><guid isPermaLink="true">https://blog.ferstar.org/post/python%E6%97%B6%E9%97%B4%E6%88%B3%E5%A4%84%E7%90%86/</guid><pubDate>Mon, 24 Jul 2017 16:05:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>转自 &lt;a href="http://funhacks.net/2016/03/19/python%20%E6%97%B6%E9%97%B4%E6%88%B3%E5%A4%84%E7%90%86/">python 时间戳处理&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;h1 id="1-python-时间戳处理">1. python 时间戳处理&lt;/h1>
&lt;p>&lt;a href="http://funhacks.net/2015/04/29/Unix-timestamp/">Unix 时间戳&lt;/a>根据精度的不同，有 10 位（秒级），13 位（毫秒级），16 位（微妙级）和 19 位（纳秒级）。在 python 中，我们可以将一个整数的时间戳转换为字符串格式，如 &lt;code>'2016-02-25 20:21:04'&lt;/code>，也可以将其转换为 python 中的&lt;a href="https://docs.python.org/2/library/datetime.html">datetime&lt;/a> 格式。反之，也可以将整数的时间戳转换为字符串格式和 datetime 格式。用图展示如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl"> +------------+
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">|&lt;/span> timestamp &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +----&amp;gt;&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>&amp;lt;-----+
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">|&lt;/span> +------------+ &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> v v
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">+------------+ +------------+
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">|&lt;/span> datetime &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> string &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>&amp;lt;----------&amp;gt;&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">+------------+ +------------+
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>要注意的是，由于每个时区都有自己的本地时间（北京在东八区），因此也产生了世界标准时间（UTC, Universal Time Coordinated）。所以，在将一个时间戳转换为普通时间（比如 2016-01-01 12:00:00）时，要注意是要本地时区的时间还是世界时间等。&lt;/p>
&lt;h1 id="2-local-time-北京时间">2. local time (北京时间)&lt;/h1>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># -*- coding: utf-8 -*-&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">time&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">datetime&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">datetime&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">timestamp_to_strtime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">timestamp&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;将 13 位整数的毫秒时间戳转化成本地普通时间 (字符串格式)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :param timestamp: 13 位整数的毫秒时间戳 (1456402864242)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :return: 返回字符串格式 &lt;/span>&lt;span class="si">{str}&lt;/span>&lt;span class="s2">&amp;#39;2016-02-25 20:21:04.242000&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">local_str_time&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fromtimestamp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">timestamp&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mf">1000.0&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strftime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;%Y-%m-&lt;/span>&lt;span class="si">%d&lt;/span>&lt;span class="s1"> %H:%M:%S.&lt;/span>&lt;span class="si">%f&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">local_str_time&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">timestamp_to_datetime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">timestamp&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;将 13 位整数的毫秒时间戳转化成本地普通时间 (datetime 格式)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :param timestamp: 13 位整数的毫秒时间戳 (1456402864242)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :return: 返回 datetime 格式 &lt;/span>&lt;span class="si">{datetime}&lt;/span>&lt;span class="s2">2016-02-25 20:21:04.242000
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">local_dt_time&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fromtimestamp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">timestamp&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mf">1000.0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">local_dt_time&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">datetime_to_strtime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">datetime_obj&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;将 datetime 格式的时间 (含毫秒) 转为字符串格式
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :param datetime_obj: &lt;/span>&lt;span class="si">{datetime}&lt;/span>&lt;span class="s2">2016-02-25 20:21:04.242000
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :return: &lt;/span>&lt;span class="si">{str}&lt;/span>&lt;span class="s2">&amp;#39;2016-02-25 20:21:04.242&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">local_str_time&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">datetime_obj&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strftime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;%Y-%m-&lt;/span>&lt;span class="si">%d&lt;/span>&lt;span class="s2"> %H:%M:%S.&lt;/span>&lt;span class="si">%f&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">local_str_time&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">datetime_to_timestamp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">datetime_obj&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;将本地(local) datetime 格式的时间 (含毫秒) 转为毫秒时间戳
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :param datetime_obj: &lt;/span>&lt;span class="si">{datetime}&lt;/span>&lt;span class="s2">2016-02-25 20:21:04.242000
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :return: 13 位的毫秒时间戳 1456402864242
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">local_timestamp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">long&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">mktime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">datetime_obj&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">timetuple&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mf">1000.0&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">datetime_obj&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">microsecond&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mf">1000.0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">local_timestamp&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">strtime_to_datetime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">timestr&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;将字符串格式的时间 (含毫秒) 转为 datetiem 格式
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :param timestr: &lt;/span>&lt;span class="si">{str}&lt;/span>&lt;span class="s2">&amp;#39;2016-02-25 20:21:04.242&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :return: &lt;/span>&lt;span class="si">{datetime}&lt;/span>&lt;span class="s2">2016-02-25 20:21:04.242000
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">local_datetime&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strptime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">timestr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;%Y-%m-&lt;/span>&lt;span class="si">%d&lt;/span>&lt;span class="s2"> %H:%M:%S.&lt;/span>&lt;span class="si">%f&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">local_datetime&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">strtime_to_timestamp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">local_timestr&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;将本地时间 (字符串格式，含毫秒) 转为 13 位整数的毫秒时间戳
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :param local_timestr: &lt;/span>&lt;span class="si">{str}&lt;/span>&lt;span class="s2">&amp;#39;2016-02-25 20:21:04.242&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :return: 1456402864242
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">local_datetime&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">strtime_to_datetime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">local_timestr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">timestamp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">datetime_to_timestamp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">local_datetime&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">timestamp&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">current_datetime&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;返回本地当前时间, 包含datetime 格式, 字符串格式, 时间戳格式
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :return: (datetime 格式, 字符串格式, 时间戳格式)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 当前时间：datetime 格式&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">local_datetime_now&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 当前时间：字符串格式&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">local_strtime_now&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">datetime_to_strtime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">local_datetime_now&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 当前时间：时间戳格式 13位整数&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">local_timestamp_now&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">datetime_to_timestamp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">local_datetime_now&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">local_datetime_now&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">local_strtime_now&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">local_timestamp_now&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="vm">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">time_str&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;2016-02-25 20:21:04.242&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">timestamp1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">strtime_to_timestamp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">time_str&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">datetime1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">strtime_to_datetime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">time_str&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">time_str2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">datetime_to_strtime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">datetime1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">timestamp2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">datetime_to_timestamp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">datetime1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">datetime3&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">timestamp_to_datetime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">timestamp2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">time_str3&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">timestamp_to_strtime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">timestamp2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">current_time&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">current_datetime&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s1">&amp;#39;timestamp1: &amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">timestamp1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s1">&amp;#39;datetime1: &amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">datetime1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s1">&amp;#39;time_str2: &amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">time_str2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s1">&amp;#39;timestamp2: &amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">timestamp2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s1">&amp;#39;datetime3: &amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">datetime3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s1">&amp;#39;time_str3: &amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">time_str3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s1">&amp;#39;current_time: &amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">current_time&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 输出&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">timestamp1: &lt;span class="m">1456402864242&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">datetime1: 2016-02-25 20:21:04.242000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">time_str2: 2016-02-25 20:21:04.242000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">timestamp2: &lt;span class="m">1456402864242&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">datetime3: 2016-02-25 20:21:04.242000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">time_str3: 2016-02-25 20:21:04.242000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">current_time: &lt;span class="o">(&lt;/span>datetime.datetime&lt;span class="o">(&lt;/span>2016, 3, 19, 14, 11, 4, 901903&lt;span class="o">)&lt;/span>, &lt;span class="s1">&amp;#39;2016-03-19 14:11:04.901903&amp;#39;&lt;/span>, 1458367864901L&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="3-utc-time">3. utc time&lt;/h1>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># -*- coding: utf-8 -*-&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">calendar&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">datetime&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">datetime&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">timestamp_to_utc_strtime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">timestamp&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;将 13 位整数的毫秒时间戳转化成 utc 时间 (字符串格式，含毫秒)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :param timestamp: 13 位整数的毫秒时间戳 (1456402864242)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :return: 返回字符串格式 &lt;/span>&lt;span class="si">{str}&lt;/span>&lt;span class="s2">&amp;#39;2016-02-25 12:21:04.242000&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">utc_str_time&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">utcfromtimestamp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">timestamp&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mf">1000.0&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strftime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;%Y-%m-&lt;/span>&lt;span class="si">%d&lt;/span>&lt;span class="s1"> %H:%M:%S.&lt;/span>&lt;span class="si">%f&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">utc_str_time&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">timestamp_to_utc_datetime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">timestamp&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;将 13 位整数的毫秒时间戳转化成 utc 时间 (datetime 格式)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :param timestamp: 13 位整数的时间戳 (1456402864242)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :return: 返回 datetime 格式 &lt;/span>&lt;span class="si">{datetime}&lt;/span>&lt;span class="s2">2016-02-25 12:21:04.242000
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">utc_dt_time&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">utcfromtimestamp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">timestamp&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mf">1000.0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">utc_dt_time&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">utc_datetime_to_timestamp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">utc_datetime&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;将 utc 时间 (datetime 格式) 转为 utc 时间戳
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :param utc_datetime: &lt;/span>&lt;span class="si">{datetime}&lt;/span>&lt;span class="s2">2016-02-25 20:21:04.242000
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :return: 13位 的毫秒时间戳 1456431664242
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">utc_timestamp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">long&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">calendar&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">timegm&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">utc_datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">timetuple&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mf">1000.0&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">utc_datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">microsecond&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mf">1000.0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">utc_timestamp&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">datetime_to_strtime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">datetime_obj&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;将 datetime 格式的时间 (含毫秒) 转为字符串格式
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :param datetime_obj: &lt;/span>&lt;span class="si">{datetime}&lt;/span>&lt;span class="s2">2016-02-25 20:21:04.242000
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :return: &lt;/span>&lt;span class="si">{str}&lt;/span>&lt;span class="s2">&amp;#39;2016-02-25 20:21:04.242&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">local_str_time&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">datetime_obj&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strftime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;%Y-%m-&lt;/span>&lt;span class="si">%d&lt;/span>&lt;span class="s2"> %H:%M:%S.&lt;/span>&lt;span class="si">%f&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">local_str_time&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">strtime_to_datetime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">timestr&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;将字符串格式的时间 (含毫秒) 转为 datetiem 格式
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :param timestr: &lt;/span>&lt;span class="si">{str}&lt;/span>&lt;span class="s2">&amp;#39;2016-02-25 20:21:04.242&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :return: &lt;/span>&lt;span class="si">{datetime}&lt;/span>&lt;span class="s2">2016-02-25 20:21:04.242000
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">local_datetime&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strptime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">timestr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;%Y-%m-&lt;/span>&lt;span class="si">%d&lt;/span>&lt;span class="s2"> %H:%M:%S.&lt;/span>&lt;span class="si">%f&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">local_datetime&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">utc_strtime_to_timestamp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">utc_timestr&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;将 utc 时间 (字符串格式) 转为 13 位的时间戳
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :param utc_timestr: &lt;/span>&lt;span class="si">{str}&lt;/span>&lt;span class="s2">&amp;#39;2016-02-25 20:21:04.242&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :return: 1456431664242
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 先将字符串的格式转为 datetime 格式&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">utc_datetime&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">strtime_to_datetime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">utc_timestr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 再将 datetime 格式的时间转为时间戳&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">timestamp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">utc_datetime_to_timestamp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">utc_datetime&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">timestamp&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">utc_current_datetime&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;返回 utc 当前时间, datetime 格式, 字符串格式, 时间戳格式
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :return: (datetime 格式, 字符串格式, 时间戳格式)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># utc 当前时间: datetime 格式&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">utc_datetime_now&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">utcnow&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># utc 当前时间: 字符串格式&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">utc_strtime_now&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">datetime_to_strtime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">utc_datetime_now&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># utc 当前时间: 时间戳格式 13位整数&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">utc_timestamp_now&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">utc_datetime_to_timestamp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">utc_datetime_now&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">utc_datetime_now&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">utc_strtime_now&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">utc_timestamp_now&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="vm">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">time_str&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;2016-02-25 20:21:04.242&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 1456431664242&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">timestamp1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">utc_strtime_to_timestamp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">time_str&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">datetime1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">strtime_to_datetime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">time_str&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">time_str2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">datetime_to_strtime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">datetime1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">timestamp2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">utc_datetime_to_timestamp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">datetime1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">datetime3&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">timestamp_to_utc_datetime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">timestamp2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">time_str3&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">timestamp_to_utc_strtime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">timestamp2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">utc_current_time&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">utc_current_datetime&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s1">&amp;#39;timestamp1: &amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">timestamp1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s1">&amp;#39;datetime1: &amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">datetime1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s1">&amp;#39;time_str2: &amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">time_str2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s1">&amp;#39;timestamp2: &amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">timestamp2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s1">&amp;#39;datetime3: &amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">datetime3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s1">&amp;#39;time_str3: &amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">time_str3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s1">&amp;#39;utc_current_time: &amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">utc_current_time&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 输出&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">timestamp1: &lt;span class="m">1456431664242&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">datetime1: 2016-02-25 20:21:04.242000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">time_str2: 2016-02-25 20:21:04.242000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">timestamp2: &lt;span class="m">1456431664242&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">datetime3: 2016-02-25 20:21:04.242000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">time_str3: 2016-02-25 20:21:04.242000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">utc_current_time: &lt;span class="o">(&lt;/span>datetime.datetime&lt;span class="o">(&lt;/span>2016, 3, 19, 7, 7, 2, 217055&lt;span class="o">)&lt;/span>, &lt;span class="s1">&amp;#39;2016-03-19 07:07:02.217055&amp;#39;&lt;/span>, 1458371222217L&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="4-参考资料">4. 参考资料&lt;/h1>
&lt;ul>
&lt;li>&lt;a href="http://www.saltycrane.com/blog/2008/11/python-datetime-time-conversions/">python-datetime-time-conversions&lt;/a>&lt;/li>
&lt;/ul></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>deploy ssr on digitalocean vps</title><link>https://blog.ferstar.org/post/deploy-ssr-on-digitalocean-vps/</link><guid isPermaLink="true">https://blog.ferstar.org/post/deploy-ssr-on-digitalocean-vps/</guid><pubDate>Wed, 19 Jul 2017 16:22:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>感觉买的&lt;code>ss&lt;/code>账号越来越慢, 刚好本月到期, 就干脆撸个DO账号自己搭, 就选那个&lt;code>5$&lt;/code>的配置, 挺划算的.&lt;/p>
&lt;p>发现网上很多好人&lt;a href="https://github.com/iMeiji/shadowsocks_install/wiki/shadowsocksR-%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85">写好的脚本&lt;/a>, 随便拿一个开撸&lt;/p>
&lt;h2 id="一键ssr">一键ssr&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">wget --no-check-certificate https://raw.githubusercontent.com/iMeiji/shadowsocks_install/master/shadowsocksR.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">chmod +x shadowsocksR.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">./shadowsocksR.sh 2&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">1&lt;/span> &lt;span class="p">|&lt;/span> tee shadowsocksR.log
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="一键bbr">一键bbr&lt;/h2>
&lt;p>&lt;a href="https://ferstar.org/post/root/Debian/Ubuntu%20TCP%20BBR%20%E6%94%B9%E8%BF%9B%E7%89%88/%E5%A2%9E%E5%BC%BA%E7%89%88">Debian/Ubuntu TCP BBR 改进版/增强版&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">wget --no-check-certificate -qO &lt;span class="s1">&amp;#39;BBR.sh&amp;#39;&lt;/span> &lt;span class="s1">&amp;#39;https://moeclub.org/attachment/LinuxShell/BBR.sh&amp;#39;&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> chmod a+x BBR.sh &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> bash BBR.sh -f
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 上命令执行完后会自动重启&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">wget --no-check-certificate -qO &lt;span class="s1">&amp;#39;BBR.sh&amp;#39;&lt;/span> &lt;span class="s1">&amp;#39;https://moeclub.org/attachment/LinuxShell/BBR.sh&amp;#39;&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> chmod a+x BBR.sh &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> bash BBR.sh -f
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="完整代码">完整代码&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$EUID&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> -ne &lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Error,This script must be run as root! &amp;#34;&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> &lt;span class="nv">$#&lt;/span> -gt &lt;span class="s1">&amp;#39;1&amp;#39;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;-f&amp;#39;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nv">tmpKernelVer&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$2&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nv">tmpKernelVer&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> -z &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>dpkg -l &lt;span class="p">|&lt;/span>grep &lt;span class="s1">&amp;#39;grub-&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Not found grub.&amp;#34;&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">which make &amp;gt;/dev/null 2&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> &lt;span class="nv">$?&lt;/span> -ne &lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Install make...&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">DEBIAN_FRONTEND&lt;/span>&lt;span class="o">=&lt;/span>noninteractive apt-get install -y -qq make &amp;gt;/dev/null 2&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">which make &amp;gt;/dev/null 2&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> &lt;span class="nv">$?&lt;/span> -ne &lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Error! Install make. &amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">which awk &amp;gt;/dev/null 2&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> &lt;span class="nv">$?&lt;/span> -ne &lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Install awk...&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">DEBIAN_FRONTEND&lt;/span>&lt;span class="o">=&lt;/span>noninteractive apt-get install -y -qq gawk &amp;gt;/dev/null 2&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">which awk &amp;gt;/dev/null 2&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> &lt;span class="nv">$?&lt;/span> -ne &lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Error! Install awk. &amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">which gcc &amp;gt;/dev/null 2&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> &lt;span class="nv">$?&lt;/span> -ne &lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Install gcc...&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">DEBIAN_FRONTEND&lt;/span>&lt;span class="o">=&lt;/span>noninteractive apt-get install -y -qq gcc &amp;gt;/dev/null 2&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">which gcc &amp;gt;/dev/null 2&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> &lt;span class="nv">$?&lt;/span> -ne &lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Error! Install gcc. &amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Please &amp;#39;apt-get update&amp;#39; and try again! &amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">GCCVER&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>readlink &lt;span class="sb">`&lt;/span>which gcc&lt;span class="sb">`&lt;/span> &lt;span class="p">|&lt;/span>grep -o &lt;span class="s1">&amp;#39;[0-9].*&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">GCCVER1&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>&lt;span class="nb">echo&lt;/span> &lt;span class="nv">$GCCVER&lt;/span> &lt;span class="p">|&lt;/span>awk -F. &lt;span class="s1">&amp;#39;{print $1}&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">GCCVER2&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>&lt;span class="nb">echo&lt;/span> &lt;span class="nv">$GCCVER&lt;/span> &lt;span class="p">|&lt;/span>awk -F. &lt;span class="s1">&amp;#39;{print $2}&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$GCCVER1&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> -gt &lt;span class="s1">&amp;#39;4&amp;#39;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nv">CheckGCC&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nv">CheckGCC&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;1&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$CheckGCC&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;1&amp;#39;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">[&lt;/span> -n &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$GCCVER2&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$GCCVER2&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> -ge &lt;span class="s1">&amp;#39;9&amp;#39;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nv">CheckGCC&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$CheckGCC&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;1&amp;#39;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;The gcc version require gcc-4.9 or higher. &amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;You can try apt-get install -y gcc-4.9 or apt-get install -y gcc-6&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Please upgrade it manually! &amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">KernelVer&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">KernelBitVer&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">MainURL&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;http://kernel.ubuntu.com/~kernel-ppa/mainline&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> -n &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$tmpKernelVer&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">wget -qO /dev/null &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$MainURL&lt;/span>&lt;span class="s2">/&lt;/span>&lt;span class="nv">$tmpKernelVer&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> &lt;span class="nv">$?&lt;/span> -ne &lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;Please input a vaild kernel version! exp: v4.11.9.&amp;#39;&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">KernelVer&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$tmpKernelVer&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> -z &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$tmpKernelVer&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">KernelVerBIG&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>wget -qO- &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$MainURL&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span>awk -F &lt;span class="s1">&amp;#39;/&amp;#34;&amp;gt;|href=&amp;#34;&amp;#39;&lt;/span> &lt;span class="s1">&amp;#39;{print $2}&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span>sed &lt;span class="s1">&amp;#39;/rc/d;/^$/d&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span>tail -n1&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> -n &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$KernelVerBIG&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nv">KernelVer&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>wget -qO- &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$MainURL&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span>awk -F &lt;span class="s1">&amp;#39;/&amp;#34;&amp;gt;|href=&amp;#34;&amp;#39;&lt;/span> &lt;span class="s1">&amp;#39;{print $2}&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span>sed &lt;span class="s1">&amp;#39;/rc/d;/^$/d&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span>grep &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">KernelVerBIG&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span>sort -n &lt;span class="p">|&lt;/span>tail -n1&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> -z &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$KernelVer&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;Error,Get Kernel fail! &amp;#39;&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">ReleaseURL&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>&lt;span class="nb">echo&lt;/span> -n &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$MainURL&lt;/span>&lt;span class="s2">/&lt;/span>&lt;span class="nv">$KernelVer&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">KernelBit&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>getconf LONG_BIT&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$KernelBit&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;32&amp;#39;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nv">KernelBitVer&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;i386&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$KernelBit&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;64&amp;#39;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nv">KernelBitVer&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;amd64&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> -z &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$KernelBitVer&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Error! &amp;#34;&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">HeadersFile&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>wget -qO- &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$ReleaseURL&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span>awk -F &lt;span class="s1">&amp;#39;&amp;#34;&amp;gt;|href=&amp;#34;&amp;#39;&lt;/span> &lt;span class="s1">&amp;#39;/generic.*.deb/{print $2}&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span>grep &lt;span class="s1">&amp;#39;headers&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span>grep &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$KernelBitVer&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span>head -n1&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> -n &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$HeadersFile&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nv">HeadersAll&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$HeadersFile&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span>sed &lt;span class="s1">&amp;#39;s/-generic//g;s/_&amp;#39;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">KernelBitVer&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;.deb/_all.deb/g&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> -z &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$HeadersAll&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Error! Get Linux Headers for All.&amp;#34;&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$HeadersFile&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> grep -q &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>uname -r&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> &lt;span class="nv">$?&lt;/span> -ne &lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Error! Header not be matched by Linux Kernel.&amp;#34;&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> -ne &lt;span class="s2">&amp;#34;Download Kernel Headers for All\n\t&lt;/span>&lt;span class="nv">$HeadersAll&lt;/span>&lt;span class="s2">\n&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">wget -qO &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$HeadersAll&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$ReleaseURL&lt;/span>&lt;span class="s2">/&lt;/span>&lt;span class="nv">$HeadersAll&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> -ne &lt;span class="s2">&amp;#34;Install Kernel Headers for All\n\t&lt;/span>&lt;span class="nv">$HeadersAll&lt;/span>&lt;span class="s2">\n&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dpkg -i &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$HeadersAll&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &amp;gt;/dev/null 2&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> -ne &lt;span class="s2">&amp;#34;Download Kernel Headers\n\t&lt;/span>&lt;span class="nv">$HeadersFile&lt;/span>&lt;span class="s2">\n&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">wget -qO &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$HeadersFile&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$ReleaseURL&lt;/span>&lt;span class="s2">/&lt;/span>&lt;span class="nv">$HeadersFile&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> -ne &lt;span class="s2">&amp;#34;Install Kernel Headers\n\t&lt;/span>&lt;span class="nv">$HeadersFile&lt;/span>&lt;span class="s2">\n&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dpkg -i &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$HeadersFile&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &amp;gt;/dev/null 2&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> -ne &lt;span class="s2">&amp;#34;Download BBR POWERED Source code\n&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> -e ./tmp &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> rm -rf ./tmp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkdir -p ./tmp &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nb">cd&lt;/span> ./tmp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> &lt;span class="nv">$?&lt;/span> -eq &lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">wget --no-check-certificate -qO- &lt;span class="s1">&amp;#39;https://moeclub.org/attachment/LinuxSoftware/bbr/tcp_bbr_powered.c.deb&amp;#39;&lt;/span> &amp;gt;./tcp_bbr_powered.c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;obj-m:=tcp_bbr_powered.o&amp;#39;&lt;/span> &amp;gt;./Makefile
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">make -s -C /lib/modules/&lt;span class="k">$(&lt;/span>uname -r&lt;span class="k">)&lt;/span>/build &lt;span class="nv">M&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="sb">`&lt;/span>&lt;span class="nb">pwd&lt;/span>&lt;span class="sb">`&lt;/span> modules &lt;span class="nv">CC&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="sb">`&lt;/span>which gcc&lt;span class="sb">`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Loading TCP BBR POWERED...&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> -f ./tcp_bbr_powered.ko &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">[&lt;/span> -f /lib/modules/&lt;span class="k">$(&lt;/span>uname -r&lt;span class="k">)&lt;/span>/modules.dep &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp -rf ./tcp_bbr_powered.ko /lib/modules/&lt;span class="k">$(&lt;/span>uname -r&lt;span class="k">)&lt;/span>/kernel/net/ipv4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">depmod -a &amp;gt;/dev/null 2&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">modprobe tcp_bbr_powered
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> ! -f /etc/sysctl.conf &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> touch /etc/sysctl.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s1">&amp;#39;/net.core.default_qdisc.*/d&amp;#39;&lt;/span> /etc/sysctl.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s1">&amp;#39;/net.ipv4.tcp_congestion_control.*/d&amp;#39;&lt;/span> /etc/sysctl.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;net.core.default_qdisc = fq&amp;#34;&lt;/span> &amp;gt;&amp;gt;/etc/sysctl.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;net.ipv4.tcp_congestion_control = bbr_powered&amp;#34;&lt;/span> &amp;gt;&amp;gt;/etc/sysctl.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lsmod &lt;span class="p">|&lt;/span>grep -q &lt;span class="s1">&amp;#39;bbr_powered&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> &lt;span class="nv">$?&lt;/span> -eq &lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sysctl -p &amp;gt;/dev/null 2&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Finish! &amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">exit&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Error, Loading BBR POWERED.&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="改配置">改配置&lt;/h2>
&lt;p>&lt;code>vi /etc/shadowsocks.json&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;server&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;0.0.0.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;server_ipv6&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;::&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;server_port&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">443&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1"># 常用端口据说比较稳&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;local_address&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;127.0.0.1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;local_port&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">1080&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;password&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;passwd&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;timeout&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">120&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;method&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;chacha20&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1"># chacha20据说比较快&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;protocol&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;origin&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;protocol_param&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;obfs&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;plain&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;obfs_param&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;redirect&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;dns_ipv6&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">false&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;fast_open&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">true&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1"># 开了这个据说也比较快&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;workers&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="防火墙开端口">防火墙开端口&lt;/h2>
&lt;p>这个可以在DO控制面板上编辑防火墙规则, 添加&lt;code>ssr&lt;/code>端口(我用的&lt;code>443&lt;/code>)&lt;/p>
&lt;h2 id="客户端">客户端&lt;/h2>
&lt;p>&lt;a href="https://github.com/shadowsocksr/shadowsocksr-csharp/releases">https://github.com/shadowsocksr/shadowsocksr-csharp/releases&lt;/a>&lt;/p>
&lt;h2 id="测试">测试&lt;/h2>
&lt;p>一般都是开油管跑&lt;code>1080p&lt;/code>, 试了下, 能稳定在&lt;code>20Mbps&lt;/code>, 延迟&lt;code>200ms&lt;/code>左右, 表现还是蛮不错的, 比之前买的&lt;code>ss&lt;/code>账号快多了(应该是树大招风, 被干扰的原因)&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/vps/">VPS</category><category domain="https://blog.ferstar.org/tags/ssr/">SSR</category><category domain="https://blog.ferstar.org/tags/ubuntu/">UBUNTU</category></item><item><title>搭建kms服务器</title><link>https://blog.ferstar.org/post/%E6%90%AD%E5%BB%BAkms%E6%9C%8D%E5%8A%A1%E5%99%A8/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E6%90%AD%E5%BB%BAkms%E6%9C%8D%E5%8A%A1%E5%99%A8/</guid><pubDate>Wed, 19 Jul 2017 16:07:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>在digitalocean开了个vps, 于是就想着搭建这么一个东西, 方便激活&lt;/p>
&lt;h2 id="服务器配置">服务器配置&lt;/h2>
&lt;ol>
&lt;li>
&lt;p>从https://github.com/Wind4/vlmcsd releases页面下载binary包&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>vlmcsdmulti-x64-glibc&lt;/code>移动到&lt;code>/usr/local/bin&lt;/code>目录&lt;/p>
&lt;/li>
&lt;li>
&lt;p>改下名字--&amp;gt; &lt;code>vlmcsd&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>自启动&lt;code>vlmcsd -l /var/log/vlmcsd.log&lt;/code>扔到&lt;code>/etc/rc.local&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>控制面板防火墙放开&lt;code>1688&lt;/code>端口&lt;/p>
&lt;/li>
&lt;li>
&lt;p>看一下日志&lt;code>tailf /var/log/vlmcsd.log&lt;/code>&lt;/p>
&lt;pre tabindex="0">&lt;code>2017-07-19 07:47:28: Listening on [::]:1688
2017-07-19 07:47:28: Listening on 0.0.0.0:1688
2017-07-19 07:47:28: vlmcsd 1111, built 2017-06-17 00:53:13 UTC started successfully
&lt;/code>&lt;/pre>&lt;p>​&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="激活配置">激活配置&lt;/h2>
&lt;h3 id="windows">Windows:&lt;/h3>
&lt;p>以管理员身份打开命令提示符,然执行下列命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd &lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">d&lt;/span> &lt;span class="s2">&amp;#34;%SystemRoot%\system32&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">slmgr&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">skms&lt;/span> &lt;span class="n">kms&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">xxx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">com&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">slmgr&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">ato&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">slmgr&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">xpr&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="office">Office:&lt;/h3>
&lt;p>以管理员身份打开命令提示符,进入软件安装目录,然后执行下列命令:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># 以Office 2016为例:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">进入32位版本安装目录&lt;/span>&lt;span class="err">：&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd &lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">d&lt;/span> &lt;span class="s2">&amp;#34;%ProgramFiles(x86)%\Microsoft Office\Office16&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># 进入64位版本安装目录:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd &lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">d&lt;/span> &lt;span class="s2">&amp;#34;%ProgramFiles%\Microsoft Office\Office16&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># 然后执行下列命令:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cscript&lt;/span> &lt;span class="n">ospp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">vbs&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">sethst&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">kms&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ferstar&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">org&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cscript&lt;/span> &lt;span class="n">ospp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">vbs&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">act&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cscript&lt;/span> &lt;span class="n">ospp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">vbs&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">dstatus&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>通过以上步骤就可以免费激活你的Windows系统和Office软件.
如果激活失败或输入过其他密钥,请先替换为&lt;a href="https://technet.microsoft.com/en-us/library/jj612867.aspx">微软官方密钥&lt;/a>
以安装政府版密钥为例(Ent G 400 Years):
&lt;code>slmgr /ipk YYVX9-NTFWV-6MDM3-9PT4T-4M68B&lt;/code>&lt;/p>
&lt;h3 id="注意">注意&lt;/h3>
&lt;ol>
&lt;li>KMS方式激活的有效期只有180天.&lt;/li>
&lt;li>每隔一段时间系统会自动KMS服务器请求续期.&lt;/li>
&lt;/ol></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/kms/">KMS</category><category domain="https://blog.ferstar.org/tags/windows/">WINDOWS</category><category domain="https://blog.ferstar.org/tags/office/">OFFICE</category><category domain="https://blog.ferstar.org/tags/ubuntu/">UBUNTU</category></item><item><title>优雅处理Python list问题</title><link>https://blog.ferstar.org/post/%E4%BC%98%E9%9B%85%E5%A4%84%E7%90%86python-list%E9%97%AE%E9%A2%98/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E4%BC%98%E9%9B%85%E5%A4%84%E7%90%86python-list%E9%97%AE%E9%A2%98/</guid><pubDate>Wed, 19 Jul 2017 10:29:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>贴一个在&lt;a href="https://segmentfault.com/q/1010000010242056/a-1020000010249040">segmentfault&lt;/a>的回答, 问题是这样的:&lt;/p>
&lt;p>有一个&lt;code>list&lt;/code>, 是有&lt;code>list&lt;/code>嵌套与&lt;code>Str&lt;/code>的混合的&lt;code>list&lt;/code>, 如何能优雅的处理成一个简单的&lt;code>list&lt;/code>?&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># example:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">tmp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">[&lt;/span>&lt;span class="s1">&amp;#39;0-0&amp;#39;&lt;/span>, &lt;span class="o">[&lt;/span>&lt;span class="s1">&amp;#39;0-1-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-1-5&amp;#39;&lt;/span>&lt;span class="o">]&lt;/span>, &lt;span class="o">[&lt;/span>&lt;span class="s1">&amp;#39;0-2-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-2-1&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-2-2&amp;#39;&lt;/span>&lt;span class="o">]&lt;/span>, &lt;span class="o">[&lt;/span>&lt;span class="s1">&amp;#39;3-1-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;3-1-1&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;3-1-2&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;3-1-3&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;3-1-4&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;3-1-5&amp;#39;&lt;/span>&lt;span class="o">]&lt;/span>, &lt;span class="s1">&amp;#39;4-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;4-1&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;5-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;5-1&amp;#39;&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># to:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">des&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">[&lt;/span>&lt;span class="s1">&amp;#39;0-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-1-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-1-5&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-2-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-2-1&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-2-2&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;3-1-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;3-1-1&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;3-1-2&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;3-1-3&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;3-1-4&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;3-1-5&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;4-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;4-1&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;5-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;5-1&amp;#39;&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>有一些要求:&lt;/p>
&lt;ol>
&lt;li>实际问题是很大量的数, 如何&lt;strong>不增加额外list&lt;/strong>的情况下处理? (需要内存控制)&lt;/li>
&lt;li>维度已知, &lt;strong>二维&lt;/strong>&lt;/li>
&lt;li>若维度增加, 应该如何处理?&lt;/li>
&lt;/ol>
&lt;h2 id="别人的实现办法">别人的实现办法&lt;/h2>
&lt;p>有人提供了一个&lt;code>package&lt;/code>可以轻松实现&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">compiler.ast&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">flatten&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">des&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">flatten&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tmp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="递归办法">递归办法&lt;/h2>
&lt;p>我自己手搓了一个递归也可以搞定, 支持任意维度, 与之前处理过的一个问题类似: &lt;a href="https://ferstar.org/post/root/dui-ren-yi-shen-du-ren-yi-xing-shi-de-listqian-tao-qiu-ping-jun">对任意深度任意形式的list嵌套求平均&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">list_exp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">lst&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">_lst&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">lst&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">list&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">_lst&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">_lst&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">list_exp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">_lst&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>测试结果&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 二维&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">tmp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">[&lt;/span>&lt;span class="s1">&amp;#39;0-0&amp;#39;&lt;/span>, &lt;span class="o">[&lt;/span>&lt;span class="s1">&amp;#39;0-1-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-1-5&amp;#39;&lt;/span>&lt;span class="o">]&lt;/span>, &lt;span class="o">[&lt;/span>&lt;span class="s1">&amp;#39;0-2-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-2-1&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-2-2&amp;#39;&lt;/span>&lt;span class="o">]&lt;/span>, &lt;span class="o">[&lt;/span>&lt;span class="s1">&amp;#39;3-1-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;3-1-1&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;3-1-2&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;3-1-3&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;3-1-4&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;3-1-5&amp;#39;&lt;/span>&lt;span class="o">]&lt;/span>, &lt;span class="s1">&amp;#39;4-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;4-1&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;5-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;5-1&amp;#39;&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">print&lt;span class="o">(&lt;/span>lst_ext&lt;span class="o">(&lt;/span>tmp&lt;span class="o">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>&lt;span class="s1">&amp;#39;0-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-1-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-1-5&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-2-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-2-1&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-2-2&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;3-1-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;3-1-1&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;3-1-2&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;3-1-3&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;3-1-4&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;3-1-5&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;4-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;4-1&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;5-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;5-1&amp;#39;&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># N维&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">tmp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">[&lt;/span>&lt;span class="s1">&amp;#39;0-0&amp;#39;&lt;/span>, &lt;span class="o">[&lt;/span>&lt;span class="s1">&amp;#39;0-1-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-1-5&amp;#39;&lt;/span>, &lt;span class="o">[&lt;/span>&lt;span class="s1">&amp;#39;0-1-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-1-5&amp;#39;&lt;/span>&lt;span class="o">]&lt;/span>, &lt;span class="o">[&lt;/span>&lt;span class="s1">&amp;#39;0-0&amp;#39;&lt;/span>, &lt;span class="o">[&lt;/span>&lt;span class="s1">&amp;#39;0-1-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-1-5&amp;#39;&lt;/span>, &lt;span class="o">[&lt;/span>&lt;span class="s1">&amp;#39;0-1-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-1-5&amp;#39;&lt;/span>&lt;span class="o">]]]]]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">print&lt;span class="o">(&lt;/span>lst_ext&lt;span class="o">(&lt;/span>tmp&lt;span class="o">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>&lt;span class="s1">&amp;#39;0-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-1-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-1-5&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-1-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-1-5&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-1-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-1-5&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-1-0&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;0-1-5&amp;#39;&lt;/span>&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="生成器办法">生成器办法&lt;/h2>
&lt;p>发现递归还是不可避免的增加了额外的&lt;code>list&lt;/code>, 而且数据量大了以后, 内存占用似乎也不占优, 所以是时候搬出&lt;code>generator&lt;/code>大法了.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">collections&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># python3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">py3&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">iterable&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">el&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">iterable&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">el&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">el&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">collections&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Iterable&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">yield from&lt;/span> &lt;span class="n">list_exp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">el&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">yield&lt;/span> &lt;span class="n">el&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># python2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">py2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">iterable&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">el&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">iterable&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">el&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">basestring&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">el&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">collections&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Iterable&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">subel&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">el&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">yield&lt;/span> &lt;span class="n">subel&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">yield&lt;/span> &lt;span class="n">el&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>果然是一切有&lt;code>for&lt;/code>的地方都可以上&lt;code>yield&lt;/code>的节奏~&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>mongodb对类型为list的字段值进行统计</title><link>https://blog.ferstar.org/post/mongodb%E5%AF%B9%E7%B1%BB%E5%9E%8B%E4%B8%BAlist%E7%9A%84%E5%AD%97%E6%AE%B5%E5%80%BC%E8%BF%9B%E8%A1%8C%E7%BB%9F%E8%AE%A1/</link><guid isPermaLink="true">https://blog.ferstar.org/post/mongodb%E5%AF%B9%E7%B1%BB%E5%9E%8B%E4%B8%BAlist%E7%9A%84%E5%AD%97%E6%AE%B5%E5%80%BC%E8%BF%9B%E8%A1%8C%E7%BB%9F%E8%AE%A1/</guid><pubDate>Tue, 18 Jul 2017 09:27:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>mongodb中有一个字段为list类型, 经常有个需求就是要对list内的元素进行计数统计, 所以记录下此种问题的解决方法(如果是用pymongo来测试, 务必要用双引号把操作符包起来如: &amp;quot;$set&amp;quot;)&lt;/p>
&lt;p>先新建一个数据源例子&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="n">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getCollection&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;test&amp;#39;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="k">insert&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="err">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;tags&amp;#39;&lt;/span>&lt;span class="p">:[&lt;/span>&lt;span class="s1">&amp;#39;a&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;b&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;d&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="err">}&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="err">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;tags&amp;#39;&lt;/span>&lt;span class="p">:[&lt;/span>&lt;span class="s1">&amp;#39;a&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;d&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="err">}&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="err">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;tags&amp;#39;&lt;/span>&lt;span class="p">:[&lt;/span>&lt;span class="s1">&amp;#39;b&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;d&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="err">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">])&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>我们期望的结果是能够统计tags标签中的元素个数, 比如类似这样的结果&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/* 1 */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="err">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;_id&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;count&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="err">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/* 2 */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="err">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;_id&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;b&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;count&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="err">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/* 3 */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="err">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;_id&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;a&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;count&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="err">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>SQL&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="n">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getCollection&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;test&amp;#39;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="k">aggregate&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="err">{$&lt;/span>&lt;span class="n">unwind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;$tags&amp;#34;&lt;/span>&lt;span class="err">}&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="err">{$&lt;/span>&lt;span class="k">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">{&lt;/span>&lt;span class="n">_id&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;$tags&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">count&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">{$&lt;/span>&lt;span class="k">sum&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="err">}}}&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">]);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>你可能想把&amp;quot;_id&amp;quot;这个key替换成别的什么名字, 比如&amp;quot;name&amp;quot;, 只需要给上面的SQL加一条&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="n">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getCollection&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;test&amp;#39;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="k">aggregate&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="err">{$&lt;/span>&lt;span class="n">unwind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;$tags&amp;#34;&lt;/span>&lt;span class="err">}&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="err">{$&lt;/span>&lt;span class="k">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">{&lt;/span>&lt;span class="n">_id&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;$tags&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">count&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">{$&lt;/span>&lt;span class="k">sum&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="err">}}}&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="err">{$&lt;/span>&lt;span class="n">project&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">{&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;$_id&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">count&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;$count&amp;#34;&lt;/span>&lt;span class="err">}}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">])&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>于是得到了如下的结果&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/* 1 */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="err">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;_id&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;count&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="err">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/* 2 */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="err">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;_id&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;b&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;b&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;count&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="err">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/* 3 */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="err">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;_id&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;a&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;a&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;count&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="err">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>那个&amp;quot;_id&amp;quot;太讨厌, 去掉行不行? 当然行&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="n">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getCollection&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;test&amp;#39;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="k">aggregate&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="err">{$&lt;/span>&lt;span class="n">unwind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;$tags&amp;#34;&lt;/span>&lt;span class="err">}&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="err">{$&lt;/span>&lt;span class="k">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">{&lt;/span>&lt;span class="n">_id&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;$tags&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">count&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">{$&lt;/span>&lt;span class="k">sum&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="err">}}}&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="err">{$&lt;/span>&lt;span class="n">project&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">{&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;$_id&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">count&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;$count&amp;#34;&lt;/span>&lt;span class="err">}&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">_id&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="err">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">])&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>所以最终的结果长这样&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/* 1 */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="err">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;count&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="err">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/* 2 */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="err">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;b&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;count&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="err">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cm">/* 3 */&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="err">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;a&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;count&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="err">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如果还想要更屌的操作, 这几个操作符可以好好查文档看看&lt;/p>
&lt;p>&lt;code>$unwind&lt;/code>, &lt;code>$group&lt;/code>, &lt;code>$project&lt;/code>&lt;/p>
&lt;p>&lt;a href="https://docs.mongodb.com/manual/reference/operator/aggregation/unwind/">https://docs.mongodb.com/manual/reference/operator/aggregation/unwind/&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://docs.mongodb.com/manual/reference/operator/aggregation/group/">https://docs.mongodb.com/manual/reference/operator/aggregation/group/&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://docs.mongodb.com/manual/reference/operator/aggregation/project/">https://docs.mongodb.com/manual/reference/operator/aggregation/project/&lt;/a>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/mongodb/">MONGODB</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>从检测结果数据库统计基因频率工具</title><link>https://blog.ferstar.org/post/%E4%BB%8E%E6%A3%80%E6%B5%8B%E7%BB%93%E6%9E%9C%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BB%9F%E8%AE%A1%E5%9F%BA%E5%9B%A0%E9%A2%91%E7%8E%87%E5%B7%A5%E5%85%B7/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E4%BB%8E%E6%A3%80%E6%B5%8B%E7%BB%93%E6%9E%9C%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BB%9F%E8%AE%A1%E5%9F%BA%E5%9B%A0%E9%A2%91%E7%8E%87%E5%B7%A5%E5%85%B7/</guid><pubDate>Mon, 17 Jul 2017 15:23:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>接上篇, 解决数据录入问题后, 就可以着手做查询计算的逻辑. 做法很简单, 就是从mongodb中调出非空的统计结果, 将统计结果分类计算.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;span class="lnt">107
&lt;/span>&lt;span class="lnt">108
&lt;/span>&lt;span class="lnt">109
&lt;/span>&lt;span class="lnt">110
&lt;/span>&lt;span class="lnt">111
&lt;/span>&lt;span class="lnt">112
&lt;/span>&lt;span class="lnt">113
&lt;/span>&lt;span class="lnt">114
&lt;/span>&lt;span class="lnt">115
&lt;/span>&lt;span class="lnt">116
&lt;/span>&lt;span class="lnt">117
&lt;/span>&lt;span class="lnt">118
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">functools&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">os&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">sys&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">time&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">pandas&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="nn">pd&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">pymongo&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">MongoClient&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">calc_rs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rs_no&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">snp_info&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;snp&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">rs_no&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;gg&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;g&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;total&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;hits&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">MongoClient&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">db&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">collection&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">db&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">snp_info&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">snp_info&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;total&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">collection&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cursor&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">collection&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">find&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="n">rs_no&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s2">&amp;#34;$ne&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">}},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">rs_no&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">counts&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cursor&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">counts&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">snp_info&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;hits&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">counts&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2"> not found.&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rs_no&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lst&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">list&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">map&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">lambda&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">rs_no&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">cursor&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">lst&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">gg&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">snp_info&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;gg&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">gg&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">gg&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">gg&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">g_str&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">lst&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">g_str&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">snp_info&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;g&amp;#34;&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">g_str&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">snp_info&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">calc_sp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sp&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">MongoClient&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">db&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">collection&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">db&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">snp_info&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cursor&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">collection&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">find_one&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="s2">&amp;#34;Sample_ID&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">sp&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s2">&amp;#34;_id&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">cursor&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2"> not found.&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sp&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">k&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">v&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">k&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">v&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">cursor&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">items&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">v&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">usage&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Usage: python &lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2"> &amp;lt;snp_no | sample_id&amp;gt;&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">basename&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">query_item&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">st&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">lower&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;-&amp;#34;&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="mi">30&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">st&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">startswith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;rs&amp;#34;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">snp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">calc_rs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">st&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;RS No.&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">snp&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;snp&amp;#34;&lt;/span>&lt;span class="p">]))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;TOTAL&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">snp&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;total&amp;#34;&lt;/span>&lt;span class="p">]))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">hits&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">snp&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;hits&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;HITS&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hits&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;基因型&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s2">计数&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s2">频率&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">gg&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">snp&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;gg&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">gg&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">%&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">gg&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="nb">round&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">100&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">gg&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">hits&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;基因&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s2">计数&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s2">频率&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">g&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">snp&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;g&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">g&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">%&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">g&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="nb">round&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">100&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mf">0.5&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">g&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">hits&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="s2">&amp;#34;D&amp;#34;&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">g&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;字母D表示单个碱基缺失&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="n">st&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">startswith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;bm&amp;#34;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sn&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">st&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">upper&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sample&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">calc_sp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sn&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">df&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">pd&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">DataFrame&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">from_dict&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">sample&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="n">orient&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;index&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">df&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">df&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">reindex_axis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">sorted&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">df&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">columns&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">axis&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">df&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">to_csv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">.csv&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sn&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">index&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;信息已写入: &lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">.csv&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sn&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">usage&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">time_it&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">func&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nd">@functools.wraps&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">func&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">wrapper&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">kwargs&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">t1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rt&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">kwargs&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;计算用时: &lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">s&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">round&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">t1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">rt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">wrapper&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@time_it&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">list&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">map&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">query_item&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:])))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="vm">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;__main__&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">usage&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">main&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>初步实现了输入一个或者多个rs号计算对应基因/型频率的功能, 另外亦可接受Sample_ID输入, 输出对应Sample_ID的检测信息&lt;/p>
&lt;p>测试样例:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">python query.py rs12526453
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">------------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">RS No. rs12526453
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">TOTAL &lt;span class="m">7272&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">HITS &lt;span class="m">161&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">基因型 计数 频率
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">CC &lt;span class="m">155&lt;/span> 96.27%
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">CG &lt;span class="m">6&lt;/span> 3.73%
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">基因 计数 频率
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">G &lt;span class="m">6&lt;/span> 1.86%
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">C &lt;span class="m">316&lt;/span> 98.14%
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">计算用时: 0.52s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/mongdodb/">MONGDODB</category><category domain="https://blog.ferstar.org/tags/bio/">BIO</category></item><item><title>pymongo批量插入操作</title><link>https://blog.ferstar.org/post/pymongo%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5%E6%93%8D%E4%BD%9C/</link><guid isPermaLink="true">https://blog.ferstar.org/post/pymongo%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5%E6%93%8D%E4%BD%9C/</guid><pubDate>Mon, 17 Jul 2017 15:07:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>向数据库新增大量数据是经常性的需求, pymongo 支持 &lt;a href="http://api.mongodb.com/python/current/api/pymongo/collection.html#pymongo.collection.Collection.insert_many">insert_many&lt;/a>. 然而主键是我们自定义的, 并非默认&amp;quot;_id&amp;quot;, 这样批量插入, 并且实现更新记录的目的就有点困难.&lt;/p>
&lt;blockquote>
&lt;p>insert_many用法&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">insert_many&lt;span class="o">(&lt;/span>documents, &lt;span class="nv">ordered&lt;/span>&lt;span class="o">=&lt;/span>True, &lt;span class="nv">bypass_document_validation&lt;/span>&lt;span class="o">=&lt;/span>False&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/blockquote>
&lt;p>这个方法只能用来插入集合中不存在的记录, 并不会对已有的数据进行更新, 如果插入重复数据, 便会报错&lt;/p>
&lt;p>搜索一番后发现万能的sf早有解决方法, 使用&lt;a href="http://api.mongodb.org/python/current/api/pymongo/bulk.html">Bulk Operations API&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://stackoverflow.com/questions/31375606/is-there-a-way-to-skip-over-existing-ids-for-insert-many-in-pymongo-3-0">Is there a way to skip over existing _id's for insert_many in Pymongo 3.0?&lt;/a>&lt;/p>
&lt;p>具体解决方法如下:&lt;/p>
&lt;p>&lt;em>源答案并不能在主键存在的情况下对数据进行更新&lt;/em>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">insert_many&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">collection&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">docs&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">update&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">docs&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># $set 的时候, 会更新数据, setOnInsert只插入不更新&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">update_key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;$set&amp;#34;&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">update&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="s2">&amp;#34;$setOnInsert&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">bulk&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">pymongo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">bulk&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">BulkOperationBuilder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">collection&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ordered&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">False&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">docs&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">index_name&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">bulk&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">find&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="n">index_name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">index_name&lt;/span>&lt;span class="p">]})&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">upsert&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">update_one&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="n">update_key&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">bulk&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">insert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">bulk&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">execute&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">result&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">modify_count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;nModified&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># 更新条目数&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">insert_count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;nUpserted&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;nInserted&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># 总插入条数&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>另有一方法是&lt;a href="http://api.mongodb.com/python/current/api/pymongo/collection.html#pymongo.collection.Collection.bulk_write">pymongo.collection.Collection.bulk_write&lt;/a>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/mongodb/">MONGODB</category><category domain="https://blog.ferstar.org/tags/bio/">BIO</category></item><item><title>pandas to mongodb</title><link>https://blog.ferstar.org/post/pandas-to-mongodb/</link><guid isPermaLink="true">https://blog.ferstar.org/post/pandas-to-mongodb/</guid><pubDate>Thu, 13 Jul 2017 13:02:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>最近项目需要, 把所有历史资料(Excel格式)汇总分析, 于是祭出pandas神器, 上万份Excel表格轻松搞定.&lt;/p>
&lt;p>先放一段Excel转入MongoDB的代码&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;span class="lnt">107
&lt;/span>&lt;span class="lnt">108
&lt;/span>&lt;span class="lnt">109
&lt;/span>&lt;span class="lnt">110
&lt;/span>&lt;span class="lnt">111
&lt;/span>&lt;span class="lnt">112
&lt;/span>&lt;span class="lnt">113
&lt;/span>&lt;span class="lnt">114
&lt;/span>&lt;span class="lnt">115
&lt;/span>&lt;span class="lnt">116
&lt;/span>&lt;span class="lnt">117
&lt;/span>&lt;span class="lnt">118
&lt;/span>&lt;span class="lnt">119
&lt;/span>&lt;span class="lnt">120
&lt;/span>&lt;span class="lnt">121
&lt;/span>&lt;span class="lnt">122
&lt;/span>&lt;span class="lnt">123
&lt;/span>&lt;span class="lnt">124
&lt;/span>&lt;span class="lnt">125
&lt;/span>&lt;span class="lnt">126
&lt;/span>&lt;span class="lnt">127
&lt;/span>&lt;span class="lnt">128
&lt;/span>&lt;span class="lnt">129
&lt;/span>&lt;span class="lnt">130
&lt;/span>&lt;span class="lnt">131
&lt;/span>&lt;span class="lnt">132
&lt;/span>&lt;span class="lnt">133
&lt;/span>&lt;span class="lnt">134
&lt;/span>&lt;span class="lnt">135
&lt;/span>&lt;span class="lnt">136
&lt;/span>&lt;span class="lnt">137
&lt;/span>&lt;span class="lnt">138
&lt;/span>&lt;span class="lnt">139
&lt;/span>&lt;span class="lnt">140
&lt;/span>&lt;span class="lnt">141
&lt;/span>&lt;span class="lnt">142
&lt;/span>&lt;span class="lnt">143
&lt;/span>&lt;span class="lnt">144
&lt;/span>&lt;span class="lnt">145
&lt;/span>&lt;span class="lnt">146
&lt;/span>&lt;span class="lnt">147
&lt;/span>&lt;span class="lnt">148
&lt;/span>&lt;span class="lnt">149
&lt;/span>&lt;span class="lnt">150
&lt;/span>&lt;span class="lnt">151
&lt;/span>&lt;span class="lnt">152
&lt;/span>&lt;span class="lnt">153
&lt;/span>&lt;span class="lnt">154
&lt;/span>&lt;span class="lnt">155
&lt;/span>&lt;span class="lnt">156
&lt;/span>&lt;span class="lnt">157
&lt;/span>&lt;span class="lnt">158
&lt;/span>&lt;span class="lnt">159
&lt;/span>&lt;span class="lnt">160
&lt;/span>&lt;span class="lnt">161
&lt;/span>&lt;span class="lnt">162
&lt;/span>&lt;span class="lnt">163
&lt;/span>&lt;span class="lnt">164
&lt;/span>&lt;span class="lnt">165
&lt;/span>&lt;span class="lnt">166
&lt;/span>&lt;span class="lnt">167
&lt;/span>&lt;span class="lnt">168
&lt;/span>&lt;span class="lnt">169
&lt;/span>&lt;span class="lnt">170
&lt;/span>&lt;span class="lnt">171
&lt;/span>&lt;span class="lnt">172
&lt;/span>&lt;span class="lnt">173
&lt;/span>&lt;span class="lnt">174
&lt;/span>&lt;span class="lnt">175
&lt;/span>&lt;span class="lnt">176
&lt;/span>&lt;span class="lnt">177
&lt;/span>&lt;span class="lnt">178
&lt;/span>&lt;span class="lnt">179
&lt;/span>&lt;span class="lnt">180
&lt;/span>&lt;span class="lnt">181
&lt;/span>&lt;span class="lnt">182
&lt;/span>&lt;span class="lnt">183
&lt;/span>&lt;span class="lnt">184
&lt;/span>&lt;span class="lnt">185
&lt;/span>&lt;span class="lnt">186
&lt;/span>&lt;span class="lnt">187
&lt;/span>&lt;span class="lnt">188
&lt;/span>&lt;span class="lnt">189
&lt;/span>&lt;span class="lnt">190
&lt;/span>&lt;span class="lnt">191
&lt;/span>&lt;span class="lnt">192
&lt;/span>&lt;span class="lnt">193
&lt;/span>&lt;span class="lnt">194
&lt;/span>&lt;span class="lnt">195
&lt;/span>&lt;span class="lnt">196
&lt;/span>&lt;span class="lnt">197
&lt;/span>&lt;span class="lnt">198
&lt;/span>&lt;span class="lnt">199
&lt;/span>&lt;span class="lnt">200
&lt;/span>&lt;span class="lnt">201
&lt;/span>&lt;span class="lnt">202
&lt;/span>&lt;span class="lnt">203
&lt;/span>&lt;span class="lnt">204
&lt;/span>&lt;span class="lnt">205
&lt;/span>&lt;span class="lnt">206
&lt;/span>&lt;span class="lnt">207
&lt;/span>&lt;span class="lnt">208
&lt;/span>&lt;span class="lnt">209
&lt;/span>&lt;span class="lnt">210
&lt;/span>&lt;span class="lnt">211
&lt;/span>&lt;span class="lnt">212
&lt;/span>&lt;span class="lnt">213
&lt;/span>&lt;span class="lnt">214
&lt;/span>&lt;span class="lnt">215
&lt;/span>&lt;span class="lnt">216
&lt;/span>&lt;span class="lnt">217
&lt;/span>&lt;span class="lnt">218
&lt;/span>&lt;span class="lnt">219
&lt;/span>&lt;span class="lnt">220
&lt;/span>&lt;span class="lnt">221
&lt;/span>&lt;span class="lnt">222
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">os&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">sys&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">time&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">functools&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">reduce&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">wraps&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">shutil&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">copy2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">pandas&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="nn">pd&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">pymongo&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">bson.json_util&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">loads&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">g_set&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;A&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;C&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;T&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;G&amp;#39;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">gg_set&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;AC&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;AG&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;AT&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;CG&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;CT&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;GT&amp;#39;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">summary&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;ok&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;skip&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;error&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;tmp&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">db_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;test&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">collection_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;snp_info&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">index_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;Sample_ID&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">bak_file&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ds&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;tmp&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ext&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;bak&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">rename&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">fn&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">basename&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">exists&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ds&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">mkdir&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ds&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 复制到临时目录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">copy2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ds&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">fn&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 原路径加.bak后缀名&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">rename&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rename&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">.&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ext&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">pick_rules&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 文件名中包含LH-R及LH-I的均为其他项目, 跳过不处理&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">fp_base&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">basename&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="s2">&amp;#34;LH-R&amp;#34;&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">fp_base&lt;/span> &lt;span class="ow">or&lt;/span> &lt;span class="s2">&amp;#34;LH-I&amp;#34;&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">fp_base&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">bak_file&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;skip&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">summary&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;skip&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s2">0&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s2">0&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s2">skip&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp_base&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">False&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="n">fp_base&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">startswith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;~&amp;#34;&lt;/span>&lt;span class="p">):&lt;/span> &lt;span class="c1"># 跳过office临时文件&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">bak_file&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">rename&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">False&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">summary&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;tmp&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s2">0&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s2">0&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s2">tmp&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp_base&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">False&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">True&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">get_files&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ext&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;xlsx&amp;#34;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> 获取目标目录下指定后缀名文件列表
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :param dp: 目标目录
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :param ext: 后缀名, 默认为xlsx
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :return: 指定后缀名文件路径列表
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 绝对路径中有空格的情况会有bug, 所以暂时还是用相对路径&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># abspath = os.path.abspath(dp)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lst&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">root&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">dirs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">files&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">walk&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dp&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">file&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">files&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">endswith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;.&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ext&lt;/span>&lt;span class="p">)):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lst&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">lst&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">xlsx2df&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sn&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;Sample_ID&amp;#34;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> 将xlsx内带有检测信息的结果转化为dataframe返回
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> 可以处理以下四种情况
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> 1. Sample_ID在首行, 紧接着是样本信息, 中间没有空行
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> 2. Sample_ID在首行, 紧接着两行首行为空, 第四行开始才是正常样本信息
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> 3. 1, 2两行首列为空, Sample_ID在第三行, 后面才是样本信息
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> 4. 没有Sample_ID, 首行首列为空, 紧接着就是样本信息
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :param fp: Excel文件路径
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :param sn: header name默认是Sample_ID
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :return: 整理后的dataframe
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">df&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">pd&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">read_excel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">header&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 添加header name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">is_format_ok&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">False&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">df&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">shape&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">_t&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">df&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">iloc&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">_t&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">sn&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Sample_ID在首行的情况(大多数情况)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">df&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">columns&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">df&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">iloc&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">values&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">df&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">df&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">iloc&lt;/span>&lt;span class="p">[(&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">):]&lt;/span> &lt;span class="c1"># 跳过Sample_ID行&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">is_format_ok&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">True&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">_t&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">startswith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;B&amp;#34;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 没有Sample_ID的情况(极少)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 以B开头即表示正常ID, 则取上一行内容为header name, 第一个应该是sn即Sample_ID&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">df&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">columns&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">sn&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">df&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">iloc&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">values&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">is_format_ok&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">True&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">is_format_ok&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 文件无法识别, 备份源文件并返回空df&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">:&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s2">0&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s2">0&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s2">error&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">basename&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">bak_file&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;error&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">summary&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;error&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">pd&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">DataFrame&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 删除Sample_ID为空的行&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">df&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">df&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">pd&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">notnull&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">df&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">sn&lt;/span>&lt;span class="p">])]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 删除空列&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">df&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">df&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">dropna&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">axis&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">how&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;all&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 删除重复rs号&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">df&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">df&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">loc&lt;/span>&lt;span class="p">[:,&lt;/span> &lt;span class="o">~&lt;/span>&lt;span class="n">df&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">columns&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">duplicated&lt;/span>&lt;span class="p">()]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rows&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">cols&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">df&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">shape&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rows&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">cols&lt;/span>&lt;span class="p">):&lt;/span> &lt;span class="c1"># 跳过第一列Sample_ID不作处理&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">v&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">df&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">iloc&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">v&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">v&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strip&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">upper&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1"># 去空格&amp;amp;转大写&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">v&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">g_set&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 纯合子加倍&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">df&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">iloc&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">v&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">v&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 杂合子排序&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">_v&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">sorted&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">v&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">df&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">iloc&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">_v&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">_v&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">gg_set&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="n">v&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;DEL&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 单个碱基缺失, 用DD表示&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">df&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">iloc&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;DD&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="s2">&amp;#34;.&amp;#34;&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">v&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 杂合缺失, 将DEL替换为D&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">_s&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">sorted&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">v&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;.&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">lambda&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">))[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c1"># 提取出单个碱基&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">df&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">iloc&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">sorted&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">_s&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;D&amp;#34;&lt;/span>&lt;span class="p">)))&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">_s&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">g_set&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 空值或者超长字符, 填Nan&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">df&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">iloc&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 非string值填Nan&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">df&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">iloc&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">summary&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;ok&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s2">ok&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">basename&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">rows&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">cols&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">df&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">insert_many&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">collection&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">docs&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">update&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">docs&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># $set 的时候, 会更新数据, setOnInsert只插入不更新&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">update_key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;$set&amp;#34;&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">update&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="s2">&amp;#34;$setOnInsert&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">bulk&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">pymongo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">bulk&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">BulkOperationBuilder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">collection&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ordered&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">False&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">docs&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">index_name&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">bulk&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">find&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="n">index_name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">index_name&lt;/span>&lt;span class="p">]})&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">upsert&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">update_one&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="n">update_key&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">bulk&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">insert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">bulk&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">execute&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">result&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">df2db&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">df&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 写入数据库&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">pymongo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">MongoClient&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">db&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">client&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">db_name&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">collection&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">db&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">collection_name&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">collection&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">index_information&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span> &lt;span class="n">pymongo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">errors&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">OperationFailure&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 索引Sample_ID&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">collection&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">create_index&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">index_name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">unique&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">data&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">loads&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">df&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">to_json&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">values&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rs&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">insert_many&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">collection&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">data&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># collection.insert_many(loads(df.T.to_json()).values())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;-&amp;#34;&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">30&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;summary(files):&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s2">ok:&lt;/span>&lt;span class="se">\t\t&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">summary&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;ok&amp;#39;&lt;/span>&lt;span class="p">]))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s2">error:&lt;/span>&lt;span class="se">\t\t&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">summary&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;error&amp;#39;&lt;/span>&lt;span class="p">]))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s2">tmp:&lt;/span>&lt;span class="se">\t\t&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">summary&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;tmp&amp;#39;&lt;/span>&lt;span class="p">]))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s2">skip:&lt;/span>&lt;span class="se">\t\t&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">summary&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;skip&amp;#39;&lt;/span>&lt;span class="p">]))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s2">total:&lt;/span>&lt;span class="se">\t\t&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">sum&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">summary&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">values&lt;/span>&lt;span class="p">())))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;-&amp;#34;&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">30&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;summary(samples):&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s2">update:&lt;/span>&lt;span class="se">\t\t&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rs&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;nModified&amp;#34;&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s2">insert:&lt;/span>&lt;span class="se">\t\t&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rs&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;nUpserted&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">rs&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;nInserted&amp;#34;&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s2">total:&lt;/span>&lt;span class="se">\t\t&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">collection&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">()))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">time_it&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">func&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nd">@wraps&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">func&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">wrapper&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">kwargs&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">t1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rt&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">kwargs&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;cost: &lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">s&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">round&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">t1&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">rt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">wrapper&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@time_it&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dp&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 读入Excel, 处理后合并输出到df&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">df&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">reduce&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">lambda&lt;/span> &lt;span class="n">df1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">df2&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">df1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">df2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ignore_index&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">map&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">xlsx2df&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">filter&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pick_rules&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">get_files&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 删除重复ID&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">df&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">df&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">drop_duplicates&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">subset&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;Sample_ID&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 删除空列&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">df&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">df&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">dropna&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">axis&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">how&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;all&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">df2db&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">df&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;-&amp;#34;&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">30&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;data importing complete!&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="vm">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;__main__&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Usage: &lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2"> &amp;lt;samples_dir&amp;gt;&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">basename&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>运行结果:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">------------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">summary&lt;span class="o">(&lt;/span>files&lt;span class="o">)&lt;/span>:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ok: &lt;span class="m">7&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> error: &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tmp: &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> skip: &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> total: &lt;span class="m">7&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">------------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">summary&lt;span class="o">(&lt;/span>samples&lt;span class="o">)&lt;/span>:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> update: &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> insert: &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> total: &lt;span class="m">7272&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">------------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">data importing complete!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cost: 1.26s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>杨辉三角和字符串转浮点数</title><link>https://blog.ferstar.org/post/%E6%9D%A8%E8%BE%89%E4%B8%89%E8%A7%92%E5%92%8C%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BD%AC%E6%B5%AE%E7%82%B9%E6%95%B0/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E6%9D%A8%E8%BE%89%E4%B8%89%E8%A7%92%E5%92%8C%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BD%AC%E6%B5%AE%E7%82%B9%E6%95%B0/</guid><pubDate>Mon, 10 Jul 2017 18:00:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;ol>
&lt;li>
&lt;p>杨辉三角&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">triangles&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">L&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">yield&lt;/span> &lt;span class="n">L&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">L&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">L&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">L&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">L&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">L&lt;/span>&lt;span class="p">))]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">n&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="n">t&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">triangles&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">t&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">n&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">n&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">n&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>输出&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>1&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>1, 1&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>1, 2, 1&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>1, 3, 3, 1&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>1, 4, 6, 4, 1&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>1, 5, 10, 10, 5, 1&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>1, 6, 15, 20, 15, 6, 1&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>1, 7, 21, 35, 35, 21, 7, 1&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>1, 8, 28, 56, 70, 56, 28, 8, 1&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>1, 9, 36, 84, 126, 126, 84, 36, 9, 1&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>​&lt;/p>
&lt;/li>
&lt;li>
&lt;p>字符串转浮点数&lt;/p>
&lt;p>&lt;a href="https://github.com/michaelliao/learn-python3/blob/master/samples/functional/do_reduce.py#L41">do_reduce.py&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">functools&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">reduce&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">str2float&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">s2n&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;1&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;2&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;3&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;4&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;5&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;6&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">6&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;7&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;8&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;9&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">9&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;.&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">}[&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">nums&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">list&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">map&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">s2n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">nums&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">dot_index&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">nums&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">nums&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">remove&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">dot_index&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">nums&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">reduce&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">lambda&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">map&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">lambda&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="o">**&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">dot_index&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">nums&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">nums&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>验证&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">print&lt;span class="o">(&lt;/span>str2float&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span>&lt;span class="o">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">print&lt;span class="o">(&lt;/span>str2float&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;123.456&amp;#39;&lt;/span>&lt;span class="o">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">print&lt;span class="o">(&lt;/span>str2float&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;123.45600&amp;#39;&lt;/span>&lt;span class="o">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">print&lt;span class="o">(&lt;/span>str2float&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;0.1234&amp;#39;&lt;/span>&lt;span class="o">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">print&lt;span class="o">(&lt;/span>str2float&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;.1234&amp;#39;&lt;/span>&lt;span class="o">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">print&lt;span class="o">(&lt;/span>str2float&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;120.0034&amp;#39;&lt;/span>&lt;span class="o">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>结果有点奇葩, 改日再看&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mf">123.456&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mf">123.456&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mf">0.12340000000000001&lt;/span> &lt;span class="c1"># 囧&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mf">0.12340000000000001&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mf">120.0034&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>​&lt;/p>
&lt;/li>
&lt;/ol></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>destroying old docker directories more safely</title><link>https://blog.ferstar.org/post/destroying-old-docker-directories-more-safely/</link><guid isPermaLink="true">https://blog.ferstar.org/post/destroying-old-docker-directories-more-safely/</guid><pubDate>Thu, 06 Jul 2017 11:51:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>清理docker lib目录时遇到如下的错误&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">rm: cannot remove &lt;span class="sb">`&lt;/span>895b070402bd7d26d9595e939422c598e8cc1f4ade1b34e2a9659138ffe3c5c9/lost+found&lt;span class="err">&amp;#39;&lt;/span>: Read-only file system
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>爬墙Google一番后找到如下解决脚本，实现原理就是批量卸载这些挂载点后再删除，要不嫌累一个个人肉卸载删除也可以~&lt;/p>
&lt;p>&lt;a href="https://github.com/moby/moby/blob/620339f166984540f15aadef2348646eee9a5b42/contrib/nuke-graph-directory.sh">&lt;strong>nuke-graph-directory.sh&lt;/strong>&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>&lt;span class="nb">set&lt;/span> -e
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">dir&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> -z &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$dir&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;This script is for destroying old /var/lib/docker directories more safely than&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39; &amp;#34;rm -rf&amp;#34;, which can cause data loss or other serious issues.&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;usage: &lt;/span>&lt;span class="nv">$0&lt;/span>&lt;span class="s2"> directory&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34; ie: &lt;/span>&lt;span class="nv">$0&lt;/span>&lt;span class="s2"> /var/lib/docker&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span> &amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>id -u&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> !&lt;span class="o">=&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">2&lt;/span> &lt;span class="s2">&amp;#34;error: &lt;/span>&lt;span class="nv">$0&lt;/span>&lt;span class="s2"> must be run as root&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> ! -d &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$dir&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">2&lt;/span> &lt;span class="s2">&amp;#34;error: &lt;/span>&lt;span class="nv">$dir&lt;/span>&lt;span class="s2"> is not a directory&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">dir&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>readlink -f &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$dir&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Nuking &lt;/span>&lt;span class="nv">$dir&lt;/span>&lt;span class="s2"> ...&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39; (if this is wrong, press Ctrl+C NOW!)&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span> &lt;span class="nb">set&lt;/span> -x&lt;span class="p">;&lt;/span> sleep &lt;span class="m">10&lt;/span> &lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dir_in_dir&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">inner&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">outer&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$2&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">inner&lt;/span>&lt;span class="p">#&lt;/span>&lt;span class="nv">$outer&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> !&lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$inner&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># let&amp;#39;s start by unmounting any submounts in $dir&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># (like -v /home:... for example - DON&amp;#39;T DELETE MY HOME DIRECTORY BRU!)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> mount in &lt;span class="k">$(&lt;/span>awk &lt;span class="s1">&amp;#39;{ print $5 }&amp;#39;&lt;/span> /proc/self/mountinfo&lt;span class="k">)&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">mount&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>readlink -f &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$mount&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nb">true&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> dir_in_dir &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$mount&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$dir&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">(&lt;/span> &lt;span class="nb">set&lt;/span> -x&lt;span class="p">;&lt;/span> umount -f &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$mount&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># now, let&amp;#39;s go destroy individual btrfs subvolumes, if any exist&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nb">command&lt;/span> -v btrfs &amp;gt; /dev/null 2&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>1&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">root&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>df &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$dir&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;NR&amp;gt;1 { print $NF }&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">root&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">root&lt;/span>&lt;span class="p">#/&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="c1"># if root is &amp;#34;/&amp;#34;, we want it to become &amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> subvol in &lt;span class="k">$(&lt;/span>btrfs subvolume list -o &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$root&lt;/span>&lt;span class="s2">/&amp;#34;&lt;/span> 2&amp;gt;/dev/null &lt;span class="p">|&lt;/span> awk -F&lt;span class="s1">&amp;#39; path &amp;#39;&lt;/span> &lt;span class="s1">&amp;#39;{ print $2 }&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> sort -r&lt;span class="k">)&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">subvolDir&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$root&lt;/span>&lt;span class="s2">/&lt;/span>&lt;span class="nv">$subvol&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> dir_in_dir &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$subvolDir&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$dir&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">(&lt;/span> &lt;span class="nb">set&lt;/span> -x&lt;span class="p">;&lt;/span> btrfs subvolume delete &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$subvolDir&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># finally, DESTROY ALL THINGS&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span> &lt;span class="nb">set&lt;/span> -x&lt;span class="p">;&lt;/span> rm -rf &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$dir&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/docker/">DOCKER</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/centos/">CENTOS</category></item><item><title>yum命令卡住无响应的解决办法</title><link>https://blog.ferstar.org/post/yum-hangs-without-an-error-message/</link><guid isPermaLink="true">https://blog.ferstar.org/post/yum-hangs-without-an-error-message/</guid><pubDate>Thu, 06 Jul 2017 11:33:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>一台CentOS服务器的yum无端卡住，Ctrl + C也干不掉，Google了一番找到这个解决方法很管用，记录一下&lt;/p>
&lt;p>via: &lt;a href="https://superuser.com/questions/384963/yum-hangs-and-wont-respond">yum hangs and won't respond&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">rm -f /var/lib/rpm/__*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rpm --rebuilddb -v -v
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">yum clean all
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>我用这几条命令就OK了，不管用的话继续往下看&lt;/p>
&lt;hr>
&lt;p>If that did not work, you can set a debug level, error level and timeout for yum in &lt;code>/etc/yum.conf&lt;/code>:&lt;/p>
&lt;pre tabindex="0">&lt;code>debuglevel=1
errorlevel=1
timeout=1
&lt;/code>&lt;/pre>&lt;p>The timeout is standard 30 seconds. So if a repository does not respond, the error takes 30 seconds to appear. Also try using yum without the plugins (like fastest mirror and priorities) with the option &lt;code>--noplugins&lt;/code>. Now starting yum again should give you more info faster. Test with:&lt;/p>
&lt;pre tabindex="0">&lt;code>yum --verbose --noplugins info
&lt;/code>&lt;/pre>&lt;p>You might get something like this:&lt;/p>
&lt;pre tabindex="0">&lt;code> Config time: 0.105
Yum Version: 3.2.22
Setting up Package Sacks
Loading mirror speeds from cached hostfile
* base: mirror.nl.leaseweb.net
* extras: mirror.nl.leaseweb.net
* ius: mirrors.ircam.fr
* rpmforge: mirror.nl.leaseweb.net
* updates: mirror.nl.leaseweb.net link-to-server-repository/repomd.xml: [Errno 4] IOError: urlopen error (97, &amp;#39;Address family not supported by protocol&amp;#39;)
Trying other mirror.
&lt;/code>&lt;/pre>&lt;p>This indicates no information can be received from the server. Try the URL that is displayed by yum (indicated above with link-to-server-repository) in your web browser. Copy&amp;amp;paste it from your yum response, not from this post! If you get a list, you know the repository is online.&lt;/p>
&lt;p>If you get an error in your browser, try removing that repository from &lt;code>/etc/yum.repos.d&lt;/code>. Try to fetch the list on your server with wget and paste the URL:&lt;/p>
&lt;pre tabindex="0">&lt;code>wget link-to-server-repository/repomd.xml
&lt;/code>&lt;/pre>&lt;p>If this generates a timeout, then there's a problem with your firewall or proxy settings. Try to disable your firewall.&lt;/p>
&lt;p>If you are running &lt;code>csf&lt;/code> (ConfigServer Security and Firewall) and &lt;code>lfd&lt;/code> you can disable csf with:&lt;/p>
&lt;pre tabindex="0">&lt;code>csf -x
&lt;/code>&lt;/pre>&lt;p>Try yum again and if it works, you'll have to reconfigure your &lt;code>csf&lt;/code>. Enable &lt;code>csf&lt;/code> again with:&lt;/p>
&lt;pre tabindex="0">&lt;code>csf -e
&lt;/code>&lt;/pre>&lt;p>And also check your proxy settings. You can also try to change the https in to http in the .repo files at &lt;code>/etc/yum.repos.d/&lt;/code>.&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/yum/">YUM</category><category domain="https://blog.ferstar.org/tags/centos/">CENTOS</category></item><item><title>HEXO文章迁移到Bitcron</title><link>https://blog.ferstar.org/post/hexo2bitcron/</link><guid isPermaLink="true">https://blog.ferstar.org/post/hexo2bitcron/</guid><pubDate>Mon, 03 Jul 2017 18:32:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>前半年都没怎么搭理HEXO博客，升级主题以后居然升挂了，刚好收到Farbox迁移到Bitcron的邮件通知，就打算直接把HEXO写的一些东东迁移过来，文章维护一份放在Dropbox里面就可以。
HEXO文章头几行跟Bitcron略有不同，我简单粗暴只保留 title 和 date 信息， 所以处理很简单，写个 Python 脚本就可以啦，下面是具体转换步骤&lt;/p>
&lt;h2 id="先统一转一下格式避免编码问题">先统一转一下格式，避免编码问题&lt;/h2>
&lt;blockquote>
&lt;p>有时候在win写有时候又在Linux写，所以这些文章的编码有可能是gbk，也有可能是utf-8，懒得一个个看，直接上&lt;code>dos2unix&lt;/code>这个小工具批量转&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># HEXO文章都在_posts文件夹内&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> i in &lt;span class="k">$(&lt;/span>ls _posts/*&lt;span class="k">)&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span> dos2unix -k -o &lt;span class="si">${&lt;/span>&lt;span class="nv">i&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="比较文章结构写脚本批量转换之">比较文章结构，写脚本批量转换之&lt;/h2>
&lt;p>hexo2bitcron.py&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">os&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">sys&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Usage: &lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2"> source_dir dest_dir&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">src_dir&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">new_dir&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">exists&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">new_dir&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">mkdir&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">new_dir&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">get_files&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dp&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">root&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">dirs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">files&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">walk&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dp&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nb">map&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">lambda&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">files&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">convert_article&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">new_fp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="n">new_dir&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">fp&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;r&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">fh&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">new_fp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;w&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">out&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># hexo header metadata&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">line&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fh&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">readline&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">line&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">startswith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;---&amp;#34;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">line&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">startswith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;title&amp;#34;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">title_line&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">line&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">line&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">startswith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;date&amp;#34;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">date_line&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">line&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># bitcron header metadata&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;---&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">date_line&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;status: public&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">title_line&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;---&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># copy the rest lines&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">line&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fh&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">readline&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">line&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">line&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">list&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">map&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">convert_article&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">get_files&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">src_dir&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>用法：&lt;code>python hexo2bitcron.py _posts bitcron&lt;/code>&lt;/p>
&lt;blockquote>
&lt;p>脚本在CentOS上测试通过:-)&lt;/p>
&lt;/blockquote></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/hexo/">HEXO</category><category domain="https://blog.ferstar.org/tags/bitcron/">BITCRON</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/windows/">WINDOWS</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>利用krona可视化处理QIIME结果</title><link>https://blog.ferstar.org/post/use-krona-to-deal-with-qiime-output-biom-result/</link><guid isPermaLink="true">https://blog.ferstar.org/post/use-krona-to-deal-with-qiime-output-biom-result/</guid><pubDate>Fri, 30 Jun 2017 14:29:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>这个需求的起因就是因为 QIIME 自带 &lt;code>plot_taxa_summary.py&lt;/code> 脚本生成的图表太难看, 所以就着手处理了一下&lt;/p>
&lt;/blockquote>
&lt;p>本来是想在&lt;code>biostar&lt;/code>上面找现成的轮子, 结果没找到, 只有自己做了.&lt;/p>
&lt;p>附上在&lt;a href="https://www.biostars.org/p/191933/#260267">biostar.org&lt;/a>上的回答内容&lt;/p>
&lt;blockquote>
&lt;p>Hi, hope this answer is not too late. :)&lt;/p>
&lt;/blockquote>
&lt;h2 id="convert-biom-to-tsv-format">convert biom to tsv format&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">biom convert -i single_sample.biom -o single_sample.tsv --to-tsv --table-type &lt;span class="s2">&amp;#34;OTU table&amp;#34;&lt;/span> --header-key taxonomy
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="remove-the-first-two-rows-with-comment">remove the first two rows with comment&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># take a look at single_sample.tsv&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ head single_sample.tsv
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Constructed from biom file&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#OTU ID H2O taxonomy&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">346085&lt;/span> 140.0 Bacteria&lt;span class="p">;&lt;/span> Proteobacteria&lt;span class="p">;&lt;/span> Alphaproteobacteria&lt;span class="p">;&lt;/span> Caulobacterales&lt;span class="p">;&lt;/span> Caulobacteraceae&lt;span class="p">;&lt;/span> Brevundimonas&lt;span class="p">;&lt;/span> Brevundimonas_bullata
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">10298&lt;/span> 2.0 Bacteria&lt;span class="p">;&lt;/span> Proteobacteria&lt;span class="p">;&lt;/span> Gammaproteobacteria&lt;span class="p">;&lt;/span> Enterobacteriales&lt;span class="p">;&lt;/span> Enterobacteriaceae&lt;span class="p">;&lt;/span> Photorhabdus&lt;span class="p">;&lt;/span> Photorhabdus_temperata
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">122823&lt;/span> 3.0 Bacteria&lt;span class="p">;&lt;/span> Proteobacteria&lt;span class="p">;&lt;/span> Betaproteobacteria&lt;span class="p">;&lt;/span> Burkholderiales&lt;span class="p">;&lt;/span> Oxalobacteraceae&lt;span class="p">;&lt;/span> Massilia&lt;span class="p">;&lt;/span> EF516371_s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">130468&lt;/span> 2.0 Bacteria&lt;span class="p">;&lt;/span> Proteobacteria&lt;span class="p">;&lt;/span> Alphaproteobacteria&lt;span class="p">;&lt;/span> Sphingomonadales&lt;span class="p">;&lt;/span> Sphingomonadaceae&lt;span class="p">;&lt;/span> Sphingopyxis&lt;span class="p">;&lt;/span> Sphingopyxis_witflariensis
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">139977&lt;/span> 38.0 Bacteria&lt;span class="p">;&lt;/span> Proteobacteria&lt;span class="p">;&lt;/span> Alphaproteobacteria&lt;span class="p">;&lt;/span> Sphingomonadales&lt;span class="p">;&lt;/span> Erythrobacteraceae&lt;span class="p">;&lt;/span> Erythrobacter&lt;span class="p">;&lt;/span> Erythrobacter_flavus
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">121751&lt;/span> 2.0 Bacteria&lt;span class="p">;&lt;/span> Firmicutes&lt;span class="p">;&lt;/span> Clostridia&lt;span class="p">;&lt;/span> Clostridiales&lt;span class="p">;&lt;/span> Lachnospiraceae&lt;span class="p">;&lt;/span> Catonella&lt;span class="p">;&lt;/span> JX096343_s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">96934&lt;/span> 10.0 Bacteria&lt;span class="p">;&lt;/span> Proteobacteria&lt;span class="p">;&lt;/span> Gammaproteobacteria&lt;span class="p">;&lt;/span> Pseudomonadales&lt;span class="p">;&lt;/span> Pseudomonadaceae&lt;span class="p">;&lt;/span> Pseudomonas&lt;span class="p">;&lt;/span> Pseudomonas_guguanensis
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">95181&lt;/span> 4.0 Bacteria&lt;span class="p">;&lt;/span> Proteobacteria&lt;span class="p">;&lt;/span> Gammaproteobacteria&lt;span class="p">;&lt;/span> Pseudomonadales&lt;span class="p">;&lt;/span> Moraxellaceae&lt;span class="p">;&lt;/span> Acinetobacter&lt;span class="p">;&lt;/span> Acinetobacter_radioresistens
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># remove the comments&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ egrep -v &lt;span class="s2">&amp;#34;^#&amp;#34;&lt;/span> single_sample.tsv &amp;gt; sample_no_comment.tsv
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="remove-the-first-column">remove the first column&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ cut sample_no_comment.tsv -f 2- &amp;gt; sample.tsv
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ head -n2 sample.tsv
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">140.0 Bacteria&lt;span class="p">;&lt;/span> Proteobacteria&lt;span class="p">;&lt;/span> Alphaproteobacteria&lt;span class="p">;&lt;/span> Caulobacterales&lt;span class="p">;&lt;/span> Caulobacteraceae&lt;span class="p">;&lt;/span> Brevundimonas&lt;span class="p">;&lt;/span> Brevundimonas_bullata
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2.0 Bacteria&lt;span class="p">;&lt;/span> Proteobacteria&lt;span class="p">;&lt;/span> Gammaproteobacteria&lt;span class="p">;&lt;/span> Enterobacteriales&lt;span class="p">;&lt;/span> Enterobacteriaceae&lt;span class="p">;&lt;/span> Photorhabdus&lt;span class="p">;&lt;/span> Photorhabdus_temperata
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="replace-the---with-t">replace the &amp;quot;; &amp;quot; with &amp;quot;\t&amp;quot;&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ sed -i &lt;span class="s1">&amp;#39;s/;\s*/\t/g&amp;#39;&lt;/span> sample.tsv
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ head -n2 sample.tsv
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">140.0 Bacteria Proteobacteria Alphaproteobacteria Caulobacterales Caulobacteraceae Brevundimonas Brevundimonas_bullata
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2.0 Bacteria Proteobacteria Gammaproteobacteria Enterobacteriales Enterobacteriaceae Photorhabdus Photorhabdus_temperata
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="now-we-can-make-a-pie-chart-with-ktimporttextone-of-the-krona-tools">now we can make a pie chart with ktImportText(One of the Krona tools)&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ ktImportText -n enjoy_your_life -o sample.krona.html sample.tsv
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="open-samplekronahtml-with-your-web-browser-youll-see-this">open sample.krona.html with your web browser, you'll see this&lt;/h2>
&lt;p>&lt;img src="https://preview.ibb.co/hLhkoQ/Krona_snapshot_enjoy_your_life.png" alt="Krona_snapshot_enjoy_your_life">&lt;/p>
&lt;h2 id="all-in-one-commandoptional">all in one command(optional)&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ awk -F &lt;span class="s1">&amp;#39;\t|;&amp;#39;&lt;/span> &lt;span class="s1">&amp;#39;BEGIN{OFS=&amp;#34;\t&amp;#34;} FNR &amp;gt; 2 {$1=&amp;#34;&amp;#34;; print $0}&amp;#39;&lt;/span> single_sample.tsv &lt;span class="p">|&lt;/span> cut -f 2- &amp;gt; sample.tsv
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>解决混合硬盘执行update-grub命令后Windows引导丢失的问题</title><link>https://blog.ferstar.org/post/%E8%A7%A3%E5%86%B3%E6%B7%B7%E5%90%88%E7%A1%AC%E7%9B%98%E6%89%A7%E8%A1%8Cupdate-grub%E5%91%BD%E4%BB%A4%E5%90%8Ewindows%E5%BC%95%E5%AF%BC%E4%B8%A2%E5%A4%B1%E7%9A%84%E9%97%AE%E9%A2%98/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E8%A7%A3%E5%86%B3%E6%B7%B7%E5%90%88%E7%A1%AC%E7%9B%98%E6%89%A7%E8%A1%8Cupdate-grub%E5%91%BD%E4%BB%A4%E5%90%8Ewindows%E5%BC%95%E5%AF%BC%E4%B8%A2%E5%A4%B1%E7%9A%84%E9%97%AE%E9%A2%98/</guid><pubDate>Tue, 27 Jun 2017 09:54:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>公司配的台式机是Dell xps8900，32G的SSD+2T的HDD，默认启用了intel的快速存储技术。前几日在HDD末端抠了个分区安装了Linux Mint 18，早上升级新内核执行&lt;code>update-grub&lt;/code>命令后发现Windows10引导丢失。查看磁盘信息发现有两个莫名其妙的RAID array条目，估计就是磁盘中还残留有Intel RSTe RAID信息导致Windows分区被隐藏起来了。OK，发现原因就开始解决问题。&lt;/p>
&lt;/blockquote>
&lt;ol>
&lt;li>
&lt;p>进BIOS同步一下RAID磁盘内容，或者在Windows10中暂时将RAID加速功能关闭，以免意外资料丢失&lt;/p>
&lt;/li>
&lt;li>
&lt;p>在Mint中执行如下命令就可以搞定了&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl"> sudo dmraid -rE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sudo os-prober
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sudo update-grub
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>附命令输出，可以看到已经识别到Windows boot manager&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">ferstar@XPS-8900 ~ $ sudo dmraid -rE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>sudo&lt;span class="o">]&lt;/span> password &lt;span class="k">for&lt;/span> ferstar:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Do you really want to erase &lt;span class="s2">&amp;#34;isw&amp;#34;&lt;/span> ondisk metadata on /dev/sdb ? &lt;span class="o">[&lt;/span>y/n&lt;span class="o">]&lt;/span> :y
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Do you really want to erase &lt;span class="s2">&amp;#34;isw&amp;#34;&lt;/span> ondisk metadata on /dev/sda ? &lt;span class="o">[&lt;/span>y/n&lt;span class="o">]&lt;/span> :y
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ferstar@XPS-8900 ~ $ sudo os-prober
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/dev/sda2@/EFI/Microsoft/Boot/bootmgfw.efi:Windows Boot Manager:Windows:efi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ferstar@XPS-8900 ~ $ sudo update-grub
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Generating grub configuration file ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Found Windows Boot Manager on /dev/sda2@/EFI/Microsoft/Boot/bootmgfw.efi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Found linux image: /boot/vmlinuz-4.4.0-81-generic
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Found initrd image: /boot/initrd.img-4.4.0-81-generic
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Found linux image: /boot/vmlinuz-4.4.0-53-generic
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Found initrd image: /boot/initrd.img-4.4.0-53-generic
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Adding boot menu entry &lt;span class="k">for&lt;/span> EFI firmware configuration
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>​&lt;/p>
&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>参考链接&lt;/p>
&lt;p>&lt;a href="https://www.linuxwolfpack.com/linux-wont-install-due-to-prvious-raid.php">https://www.linuxwolfpack.com/linux-wont-install-due-to-prvious-raid.php&lt;/a>&lt;/p>
&lt;/blockquote></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>混合硬盘开启Intel智能响应技术报0XA0070008的解决方法</title><link>https://blog.ferstar.org/post/%E6%B7%B7%E5%90%88%E7%A1%AC%E7%9B%98%E5%BC%80%E5%90%AFintel%E6%99%BA%E8%83%BD%E5%93%8D%E5%BA%94%E6%8A%80%E6%9C%AF%E6%8A%A50xa0070008%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E6%B7%B7%E5%90%88%E7%A1%AC%E7%9B%98%E5%BC%80%E5%90%AFintel%E6%99%BA%E8%83%BD%E5%93%8D%E5%BA%94%E6%8A%80%E6%9C%AF%E6%8A%A50xa0070008%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/</guid><pubDate>Mon, 26 Jun 2017 01:54:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>前几日给公司配的台式机xps8900装完Ubuntu后发现Intel智能响应技术没法开启，报0XA0070008的错误提示，于是去官网搜了下错误代码，发现是磁盘末端没有足够的未分配空间(&amp;gt;5MB)&lt;/p>
&lt;/blockquote>
&lt;p>via &lt;a href="http://www.intel.cn/content/www/cn/zh/support/memory-and-storage/intel-optane-memory/000024113.html">http://www.intel.cn/content/www/cn/zh/support/memory-and-storage/intel-optane-memory/000024113.html&lt;/a>&lt;/p>
&lt;p>其实在安装Ubuntu时也遇到安装镜像启动后找不到硬盘的状况，只需要进BIOS把硬盘模式暂时改为AHCI，装好Ubuntu后再改回RAID0即可，secure boot不需要管&lt;/p>
&lt;p>知道原因后解决方法很简单，就是给磁盘末端开辟个大于5MB的未分配空间即可&lt;/p>
&lt;p>于是找个空U盘，格式化成FAT32格式，把Ubuntu安装镜像全部解压扔到U盘根目录，重启开机选择从U盘启动，进入Ubuntu LiveCD后使用Gparted软件调整Ubuntu系统占的根分区，给磁盘末端分配大于5MB的未分配空间，然后重启到Windows，再开启Intel智能响应技术，发现就OK了&lt;/p>
&lt;p>&lt;img src="~/09-10-26.jpg" alt="">&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>编译Openwrt jq</title><link>https://blog.ferstar.org/post/%E7%BC%96%E8%AF%91openwrt-jq/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E7%BC%96%E8%AF%91openwrt-jq/</guid><pubDate>Tue, 20 Jun 2017 12:42:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>上文中提到我要在&lt;code>kk-sp3&lt;/code>上解析json发现自己拿shell正则来人肉挫实在不雅，于是搜了一番轮子，嗯，找到这个神器&lt;a href="https://stedolan.github.io/jq/">jq&lt;/a> 简直相见恨晚&lt;/p>
&lt;p>然而在路由器上没有现成的&lt;code>ipk&lt;/code>供使用, 所以只能自己撸一发了&lt;/p>
&lt;h2 id="1-下载-openwrt-sdk">1. 下载 openwrt SDK&lt;/h2>
&lt;p>&lt;code>kk-sp3&lt;/code>芯片是&lt;code>ar71xx&lt;/code>&lt;/p>
&lt;p>&lt;a href="https://downloads.openwrt.org/barrier_breaker/14.07/ar71xx/generic/OpenWrt-SDK-ar71xx-for-linux-x86_64-gcc-4.8-linaro_uClibc-0.9.33.2.tar.bz2">OpenWrt-SDK-ar71xx-for-linux-x86_64-gcc-4.8-linaro_uClibc-0.9.33.2.tar.bz2&lt;/a>&lt;/p>
&lt;p>解压之&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">tar jxf OpenWrt-SDK-ar71xx-for-linux-x86_64-gcc-4.8-linaro_uClibc-0.9.33.2.tar.bz2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mv OpenWrt-SDK-ar71xx-for-linux-x86_64-gcc-4.8-linaro_uClibc-0.9.33.2 sdk
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="2-一些依赖">2. 一些依赖&lt;/h2>
&lt;p>我用的是&lt;code>centOS&lt;/code>, 年代久远, 所以需要的依赖基本都满足, 个别不满足的看&lt;code>error log&lt;/code>也很容易搞定, 这里贴个&lt;code>ubuntu&lt;/code>的&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">apt-get update &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> apt-get install gcc g++ binutils patch bzip2 flex bison make autoconf gettext texinfo unzip sharutils libncurses5-dev ncurses-term zlib1g-dev gawk git ccache asciidoc
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="3-配置menuconfig">3. 配置menuconfig&lt;/h2>
&lt;p>好心人在&lt;code>github&lt;/code>上共享了一份&lt;code>openwrt&lt;/code>的&lt;code>feeds&lt;/code>配置, 其实就是个&lt;code>makefile&lt;/code>文件, 不客气的收下之&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">git clone https://github.com/ferstar/openwrt-myfeeds.git hello
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>把里面的&lt;code>jq&lt;/code>文件夹复制到&lt;code>sdk/package&lt;/code>目录下&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">cp -r hello/jq sdk/package
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>再把里面的&lt;code>jq-1.4.tar.gz&lt;/code>复制到&lt;code>sdk/dl&lt;/code>目录下&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">cp hello/jq-1.4.tar.gz sdk/dl
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>进入配置界面&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">make menuconfig
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>界面如下&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">.config - Linux Kernel Configuration
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> lqqqqqqqqqqqqqqqqqqqqqq Linux Kernel Configuration qqqqqqqqqqqqqqqqqqqqqqqk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> x Arrow keys navigate the menu. &amp;lt;Enter&amp;gt; selects submenus ---&amp;gt;. x
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> x Highlighted letters are hotkeys. Pressing &amp;lt;Y&amp;gt; includes, &amp;lt;N&amp;gt; excludes, x
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> x &amp;lt;M&amp;gt; modularizes features. Press &amp;lt;Esc&amp;gt;&amp;lt;Esc&amp;gt; to exit, &amp;lt;?&amp;gt; &lt;span class="k">for&lt;/span> Help, &amp;lt;/&amp;gt; x
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> x &lt;span class="k">for&lt;/span> Search. Legend: &lt;span class="o">[&lt;/span>*&lt;span class="o">]&lt;/span> built-in &lt;span class="o">[&lt;/span> &lt;span class="o">]&lt;/span> excluded &amp;lt;M&amp;gt; module &amp;lt; &amp;gt; x
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> x lqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqk x
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> x x &lt;span class="o">[&lt;/span>*&lt;span class="o">]&lt;/span> Image configuration ---&amp;gt; x x
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> x x Libraries ---&amp;gt; x x
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> x x Utilities ---&amp;gt; x x
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> x mqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqx x
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqu
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> x &amp;lt;Select&amp;gt; &amp;lt; Exit &amp;gt; &amp;lt; Help &amp;gt; &amp;lt; Save &amp;gt; &amp;lt; Load &amp;gt; x
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqj
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>空格选中&lt;code>jq&lt;/code>,然后&lt;code>tab&lt;/code>键切到&lt;code>Save&lt;/code>保存退出&lt;/p>
&lt;h2 id="4-编译之">4. 编译之&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">make package/jq/compile &lt;span class="nv">V&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">99&lt;/span> -j4
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="5-ipk在哪">5. ipk在哪?&lt;/h2>
&lt;blockquote>
&lt;p>ipk在此: sdk/bin/ar71xx/packages&lt;/p>
&lt;p>可能会有一点点编译错误, 不过最终ipk是成功编译完成的, 所以可以无视掉&lt;/p>
&lt;/blockquote>
&lt;h2 id="6-我是好人">6. 我是好人&lt;/h2>
&lt;p>嗯, 刚才给的那个&lt;code>github&lt;/code>repo中已经有我打包好的一个&lt;code>ipk&lt;/code>安装包&lt;/p>
&lt;p>随便怎么样上传到路由器/kk-sp3上就可以安装了&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">opkg install jq_1.4-1_ar71xx.ipk
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="7-测试一下">7. 测试一下&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">root@OpenWrt:~# jq . /www/switches.json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;switches&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;DisplayName&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;Switch 1&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;ip&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;192.168.137.115&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@OpenWrt:~# jq &lt;span class="s1">&amp;#39;.switches[0].ip&amp;#39;&lt;/span> /www/switches.json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;192.168.137.115&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@OpenWrt:~# jq -r &lt;span class="s1">&amp;#39;.switches[0].ip&amp;#39;&lt;/span> /www/switches.json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.137.115
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="8-一个改ip的脚本">8. 一个改IP的脚本&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>&lt;span class="c1"># 把我扔在cron中就可以了&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># crontab -e&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># */5 * * * * /root/change_ip.sh&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 五分钟检查一次, 别忘了加执行权限&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># by ferstar&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">PATH&lt;/span>&lt;span class="o">=&lt;/span>/usr/bin:/sbin:/bin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">SW_FILE&lt;/span>&lt;span class="o">=&lt;/span>/www/switches.json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">NOW_IP&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>ifconfig wlan0 &lt;span class="p">|&lt;/span> grep -Eo &lt;span class="s1">&amp;#39;[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> head -n 1&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">OLD_IP&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>jq -r &lt;span class="s1">&amp;#39;.switches[0].ip&amp;#39;&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">SW_FILE&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">NOW_IP&lt;/span>&lt;span class="si">}&lt;/span> !&lt;span class="o">=&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">OLD_IP&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;ip changes detected, I&amp;#39;ll update the &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">SW_FILE&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> jq --arg v &lt;span class="si">${&lt;/span>&lt;span class="nv">NOW_IP&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="s1">&amp;#39;.switches[0].ip=$v&amp;#39;&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">SW_FILE&lt;/span>&lt;span class="si">}&lt;/span> &amp;gt; /tmp/tmp.json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mv /tmp/tmp.json &lt;span class="si">${&lt;/span>&lt;span class="nv">SW_FILE&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;change ip from &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">OLD_IP&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2"> to &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">NOW_IP&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;nothing to be done&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>其中&lt;code>jq --arg v ${NOW_IP} '.switches[0].ip=$v' ${SW_FILE} &amp;gt; /tmp/tmp.json&lt;/code>这一步被坑的有点美, 特别记录下&lt;/p>
&lt;p>本来想简单把&lt;code>${NOW_IP}&lt;/code>变量值传进去, 结果每次都传的是&lt;code>${NOW_IP}&lt;/code>变量名, 求助&lt;code>Google&lt;/code>发现人家官网写的很清楚, 传参需要加&lt;code>--arg&lt;/code>参数, 吐血...&lt;/p>
&lt;blockquote>
&lt;p>&lt;code>--arg name value&lt;/code>:&lt;/p>
&lt;p>This option passes a value to the jq program as a predefined variable. If you run jq with &lt;code>--arg foo bar&lt;/code>, then &lt;code>$foo&lt;/code> is available in the program and has the value &lt;code>&amp;quot;bar&amp;quot;&lt;/code>. Note that &lt;code>value&lt;/code> will be treated as a string, so &lt;code>--arg foo 123&lt;/code> will bind &lt;code>$foo&lt;/code> to &lt;code>&amp;quot;123&amp;quot;&lt;/code>.&lt;/p>
&lt;p>Named arguments are also available to the jq program as &lt;code>$ARGS.named&lt;/code>.&lt;/p>
&lt;/blockquote>
&lt;p>via &lt;a href="https://stedolan.github.io/jq/manual">https://stedolan.github.io/jq/manual&lt;/a>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>Hacking Kankun Smart Wifi Plug</title><link>https://blog.ferstar.org/post/hacking-kankun-smart-wifi-plug/</link><guid isPermaLink="true">https://blog.ferstar.org/post/hacking-kankun-smart-wifi-plug/</guid><pubDate>Tue, 20 Jun 2017 11:13:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>闲鱼买了两kk-sp3插座，准备搭配&lt;code>shairport-sync&lt;/code>把吃灰的有线音箱用起来&lt;/p>
&lt;p>hack link：&lt;a href="http://www.anites.com/2015/01/hacking-kankun-smart-wifi-plug.html">http://www.anites.com/2015/01/hacking-kankun-smart-wifi-plug.html&lt;/a>
ssid：0K_SP3
管理IP：192.168.10.253
先telnet进去修改密码（telnet默认密码为空）&lt;/p>
&lt;h2 id="磁盘信息">磁盘信息：&lt;/h2>
&lt;pre tabindex="0">&lt;code>root@OpenWrt:~# df -h
Filesystem Size Used Available Use% Mounted on
rootfs 1.0M 296.0K 728.0K 29% /
/dev/root 2.0M 2.0M 0 100% /rom
tmpfs 14.2M 60.0K 14.1M 0% /tmp
/dev/mtdblock3 1.0M 296.0K 728.0K 29% /overlay
overlayfs:/overlay 1.0M 296.0K 728.0K 29% /
tmpfs 512.0K 0 512.0K 0% /dev
&lt;/code>&lt;/pre>&lt;h2 id="内存信息">内存信息：&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">root@OpenWrt:~# free
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> total used free shared buffers
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Mem: &lt;span class="m">29060&lt;/span> &lt;span class="m">20224&lt;/span> &lt;span class="m">8836&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">1736&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-/+ buffers: &lt;span class="m">18488&lt;/span> &lt;span class="m">10572&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Swap: &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="cpu信息">CPU信息：&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">root@OpenWrt:~# cat /proc/cpuinfo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">system &lt;span class="nb">type&lt;/span> : Atheros AR9330 rev &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">machine : TP-LINK TL-WR703N v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">processor : &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cpu model : MIPS 24Kc V7.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BogoMIPS : 265.42
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">wait&lt;/span> instruction : yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">microsecond timers : yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tlb_entries : &lt;span class="m">16&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">extra interrupt vector : yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hardware watchpoint : yes, count: 4, address/irw mask: &lt;span class="o">[&lt;/span>0x0000, 0x0ff8, 0x0ff8, 0x0ff8&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">isa : mips1 mips2 mips32r1 mips32r2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ASEs implemented : mips16
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">shadow register sets : &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kscratch registers : &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">core : &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">VCED exceptions : not available
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">VCEI exceptions : not available
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="开关">开关：&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">turn relay on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="m">1&lt;/span> &amp;gt; /sys/class/leds/tp-link:blue:relay/brightness
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">turn relay off
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="m">0&lt;/span> &amp;gt; /sys/class/leds/tp-link:blue:relay/brightness
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="网络配置">网络配置&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">root@OpenWrt:~# vi /etc/config/wireless
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">config wifi-device &lt;span class="s1">&amp;#39;radio0&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option &lt;span class="nb">type&lt;/span> &lt;span class="s1">&amp;#39;mac80211&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option channel &lt;span class="s1">&amp;#39;11&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option hwmode &lt;span class="s1">&amp;#39;11ng&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option path &lt;span class="s1">&amp;#39;platform/ar933x_wmac&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option htmode &lt;span class="s1">&amp;#39;HT20&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> list ht_capab &lt;span class="s1">&amp;#39;SHORT-GI-20&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> list ht_capab &lt;span class="s1">&amp;#39;SHORT-GI-40&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> list ht_capab &lt;span class="s1">&amp;#39;RX-STBC1&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> list ht_capab &lt;span class="s1">&amp;#39;DSSS_CCK-40&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option disabled &lt;span class="s1">&amp;#39;0&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option noscan &lt;span class="s1">&amp;#39;1&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">config wifi-iface
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option device &lt;span class="s1">&amp;#39;radio0&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option mode &lt;span class="s1">&amp;#39;sta&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option ssid &lt;span class="s1">&amp;#39;your ssid&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option encryption &lt;span class="s1">&amp;#39;psk2+ccmp&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option network &lt;span class="s1">&amp;#39;wwan&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option key &lt;span class="s1">&amp;#39;***&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@OpenWrt:~# vi /etc/config/network
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">config interface &lt;span class="s1">&amp;#39;loopback&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option ifname &lt;span class="s1">&amp;#39;lo&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option proto &lt;span class="s1">&amp;#39;static&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option ipaddr &lt;span class="s1">&amp;#39;127.0.0.1&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option netmask &lt;span class="s1">&amp;#39;255.0.0.0&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">config globals &lt;span class="s1">&amp;#39;globals&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option ula_prefix &lt;span class="s1">&amp;#39;fd12:b015:a426::/48&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">config interface &lt;span class="s1">&amp;#39;lan&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option ifname &lt;span class="s1">&amp;#39;eth0&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option &lt;span class="nb">type&lt;/span> &lt;span class="s1">&amp;#39;bridge&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option proto &lt;span class="s1">&amp;#39;static&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option ipaddr &lt;span class="s1">&amp;#39;192.168.10.253&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option netmask &lt;span class="s1">&amp;#39;255.255.255.0&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option ip6assign &lt;span class="s1">&amp;#39;60&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">config interface &lt;span class="s1">&amp;#39;wwan&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> option proto &lt;span class="s1">&amp;#39;dhcp&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="kankun-json">kankun-json&lt;/h2>
&lt;blockquote>
&lt;p>&lt;a href="https://github.com/homedash/kankun-json">https://github.com/homedash/kankun-json&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">安装opkg
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tar xz -C / -f /root/opkg-rc3.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">安装at
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">opkg update &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> opkg install at
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@OpenWrt:~# /etc/init.d/atd &lt;span class="nb">enable&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@OpenWrt:~# /etc/init.d/atd start
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="更改开关指示灯默认状态">更改开关指示灯默认状态&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">For the stock firmware, you can configure the LEDs to act on certain events. Blink blue with network traffic:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">uci &lt;span class="nb">set&lt;/span> system.@led&lt;span class="o">[&lt;/span>0&lt;span class="o">]&lt;/span>.name&lt;span class="o">=&lt;/span>wwan-link
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">uci &lt;span class="nb">set&lt;/span> system.@led&lt;span class="o">[&lt;/span>0&lt;span class="o">]&lt;/span>.trigger&lt;span class="o">=&lt;/span>netdev
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">uci &lt;span class="nb">set&lt;/span> system.@led&lt;span class="o">[&lt;/span>0&lt;span class="o">]&lt;/span>.dev&lt;span class="o">=&lt;/span>wlan0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">uci &lt;span class="nb">set&lt;/span> system.@led&lt;span class="o">[&lt;/span>0&lt;span class="o">]&lt;/span>.mode&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;link tx rx&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">uci commit system
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/etc/init.d/led restart
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">The relay is tied to the red LED, so setting the LED to default ON will make the relay ON after bootup:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">uci &lt;span class="nb">set&lt;/span> system.@led&lt;span class="o">[&lt;/span>1&lt;span class="o">]&lt;/span>.default&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">uci commit system
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/etc/init.d/led restart
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="国际友人写的一个安卓应用">国际友人写的一个安卓应用&lt;/h2>
&lt;blockquote>
&lt;p>&lt;a href="https://www.google.com/url?sa=t&amp;amp;rct=j&amp;amp;q=&amp;amp;esrc=s&amp;amp;source=web&amp;amp;cd=1&amp;amp;cad=rja&amp;amp;uact=8&amp;amp;ved=0ahUKEwi-g8rSmsvUAhVGxmMKHWXCDkYQFggqMAA&amp;amp;url=https%3A%2F%2Fplay.google.com%2Fstore%2Fapps%2Fdetails%3Fid%3Dcom.blogspot.choplabalagun.widgetkkforsmartplug%26hl%3Dzh_CN&amp;amp;usg=AFQjCNEWFeH6RMntaYElYJmR7TfNqm3MpQ&amp;amp;sig2=otU8wL_j5qDVNfU_PVtO3A">WidgetKK for SmartPlug &amp;amp; LIFX &lt;/a>&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">Current Features:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-Voice Commands, Integrated with Google Now.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-HomeScreen Widgets &lt;span class="k">for&lt;/span> Lollipop and Marshmellow. &lt;span class="o">(&lt;/span>They should work now&lt;span class="o">)&lt;/span> &lt;span class="o">(&lt;/span>6/13/2015&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-System Alarm Clock Integration.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-WIFI Triggers &lt;span class="o">(&lt;/span>6/7/2015&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-SSH Integration &lt;span class="o">(&lt;/span>6/13/2015&lt;span class="o">)&lt;/span> &lt;span class="o">(&lt;/span>Bug fixes 7/8/2015&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-DIMMER option &lt;span class="k">for&lt;/span> KK version 2. .&lt;span class="o">(&lt;/span>6/13/2015&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-Android Wear Integration &lt;span class="o">(&lt;/span>voice commands and wifi triggers&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-You can send custom SSH commands.&lt;span class="o">(&lt;/span>7/8/2015&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-You can deploy the JSON script from the app to any KK plug.&lt;span class="o">(&lt;/span>7/8/2015&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-AutoReboot script &lt;span class="o">(&lt;/span>pings a specific IP, &lt;span class="k">if&lt;/span> not available the plug will reboot&lt;span class="o">)&lt;/span> useful to ping router.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-Follow Me Script &lt;span class="o">(&lt;/span>pings a specific IP, &lt;span class="k">if&lt;/span> not available the plug will shutdown&lt;span class="o">)&lt;/span> useful to autoshutdown when you leave the house&lt;span class="o">(&lt;/span>Using the your phone IP&lt;span class="o">)&lt;/span>.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-Floating Widget to access the KK&lt;span class="err">&amp;#39;&lt;/span>s.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-Install OPKG bins into your KK.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-Deploy micropython bins into your KK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-LIFX Bulbs integration with all triggers &lt;span class="o">(&lt;/span>08/Oct/2016&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-WOL integration with all Triggers &lt;span class="o">(&lt;/span>09/16/2016&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>安装 kankun-json 很方便&lt;/p>
&lt;h2 id="自动更改插座ip地址脚本">自动更改插座IP地址脚本&lt;/h2>
&lt;p>&lt;a href="https://gist.github.com/ferstar/6ebad5e70e17a9f4c05dabed7bf79d7b">https://gist.github.com/ferstar/6ebad5e70e17a9f4c05dabed7bf79d7b&lt;/a>&lt;/p>
&lt;p>插座IP发生改变后会自动将kankun-json插件配置文件更新为当前IP&lt;/p>
&lt;blockquote>
&lt;p>其中json解析用到了jq，关于这个神器的编译稍后再说明&lt;/p>
&lt;/blockquote></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/openwrt/">OPENWRT</category><category domain="https://blog.ferstar.org/tags/shell/">SHELL</category></item><item><title>Shell正则表达式</title><link>https://blog.ferstar.org/post/shell%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/</link><guid isPermaLink="true">https://blog.ferstar.org/post/shell%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/</guid><pubDate>Tue, 13 Jun 2017 10:27:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>转自: &lt;a href="http://man.linuxde.net/docs/shell_regex.html">http://man.linuxde.net/docs/shell_regex.html&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;h2 id="正则表达式的分类">正则表达式的分类&lt;/h2>
&lt;ol>
&lt;li>基本的正则表达式（Basic Regular Expression 又叫Basic RegEx 简称BREs）&lt;/li>
&lt;li>扩展的正则表达式（Extended Regular Expression 又叫Extended RegEx 简称EREs）&lt;/li>
&lt;li>Perl的正则表达式（Perl Regular Expression 又叫Perl RegEx 简称PREs）&lt;/li>
&lt;/ol>
&lt;h2 id="基本组成部分">基本组成部分&lt;/h2>
&lt;p>正则表达式的基本组成部分。&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:center">正则表达式&lt;/th>
&lt;th style="text-align:left">描述&lt;/th>
&lt;th style="text-align:left">示例&lt;/th>
&lt;th style="text-align:center">Basic RegEx&lt;/th>
&lt;th style="text-align:center">Extended RegEx&lt;/th>
&lt;th style="text-align:center">Python RegEx&lt;/th>
&lt;th style="text-align:center">Perl RegEx&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:center">\&lt;/td>
&lt;td style="text-align:left">转义符，将特殊字符进行转义，忽略其特殊意义&lt;/td>
&lt;td style="text-align:left">a\.b匹配a.b，但不能匹配ajb，.被转义为特殊意义&lt;/td>
&lt;td style="text-align:center">\&lt;/td>
&lt;td style="text-align:center">\&lt;/td>
&lt;td style="text-align:center">\&lt;/td>
&lt;td style="text-align:center">\&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">^&lt;/td>
&lt;td style="text-align:left">匹配行首，awk中，^则是匹配字符串的开始&lt;/td>
&lt;td style="text-align:left">^tux匹配以tux开头的行&lt;/td>
&lt;td style="text-align:center">^&lt;/td>
&lt;td style="text-align:center">^&lt;/td>
&lt;td style="text-align:center">^&lt;/td>
&lt;td style="text-align:center">^&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">$&lt;/td>
&lt;td style="text-align:left">匹配行尾，awk中，$则是匹配字符串的结尾&lt;/td>
&lt;td style="text-align:left">tux$匹配以tux结尾的行&lt;/td>
&lt;td style="text-align:center">$&lt;/td>
&lt;td style="text-align:center">$&lt;/td>
&lt;td style="text-align:center">$&lt;/td>
&lt;td style="text-align:center">$&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">.&lt;/td>
&lt;td style="text-align:left">匹配除换行符\n之外的任意单个字符，awk则中可以&lt;/td>
&lt;td style="text-align:left">ab.匹配abc或bad，不可匹配abcd或abde，只能匹配单字符&lt;/td>
&lt;td style="text-align:center">.&lt;/td>
&lt;td style="text-align:center">.&lt;/td>
&lt;td style="text-align:center">.&lt;/td>
&lt;td style="text-align:center">.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">[]&lt;/td>
&lt;td style="text-align:left">匹配包含在[字符]之中的任意一个字符&lt;/td>
&lt;td style="text-align:left">coo[kl]可以匹配cook或cool&lt;/td>
&lt;td style="text-align:center">[]&lt;/td>
&lt;td style="text-align:center">[]&lt;/td>
&lt;td style="text-align:center">[]&lt;/td>
&lt;td style="text-align:center">[]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">[^]&lt;/td>
&lt;td style="text-align:left">匹配[^字符]之外的任意一个字符&lt;/td>
&lt;td style="text-align:left">123[^45]不可以匹配1234或1235，1236、1237都可以&lt;/td>
&lt;td style="text-align:center">[^]&lt;/td>
&lt;td style="text-align:center">[^]&lt;/td>
&lt;td style="text-align:center">[^]&lt;/td>
&lt;td style="text-align:center">[^]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">[-]&lt;/td>
&lt;td style="text-align:left">匹配[]中指定范围内的任意一个字符，要写成递增&lt;/td>
&lt;td style="text-align:left">[0-9]可以匹配1、2或3等其中任意一个数字&lt;/td>
&lt;td style="text-align:center">[-]&lt;/td>
&lt;td style="text-align:center">[-]&lt;/td>
&lt;td style="text-align:center">[-]&lt;/td>
&lt;td style="text-align:center">[-]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">?&lt;/td>
&lt;td style="text-align:left">匹配之前的项1次或者0次&lt;/td>
&lt;td style="text-align:left">colou?r可以匹配color或者colour，不能匹配colouur&lt;/td>
&lt;td style="text-align:center">不支持&lt;/td>
&lt;td style="text-align:center">?&lt;/td>
&lt;td style="text-align:center">?&lt;/td>
&lt;td style="text-align:center">?&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">+&lt;/td>
&lt;td style="text-align:left">匹配之前的项1次或者多次&lt;/td>
&lt;td style="text-align:left">sa-6+匹配sa-6、sa-666，不能匹配sa-&lt;/td>
&lt;td style="text-align:center">不支持&lt;/td>
&lt;td style="text-align:center">+&lt;/td>
&lt;td style="text-align:center">+&lt;/td>
&lt;td style="text-align:center">+&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">*&lt;/td>
&lt;td style="text-align:left">匹配之前的项0次或者多次&lt;/td>
&lt;td style="text-align:left">co*l匹配cl、col、cool、coool等&lt;/td>
&lt;td style="text-align:center">*&lt;/td>
&lt;td style="text-align:center">*&lt;/td>
&lt;td style="text-align:center">*&lt;/td>
&lt;td style="text-align:center">*&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">()&lt;/td>
&lt;td style="text-align:left">匹配表达式，创建一个用于匹配的子串&lt;/td>
&lt;td style="text-align:left">ma(tri)+匹配matritri&lt;/td>
&lt;td style="text-align:center">不支持&lt;/td>
&lt;td style="text-align:center">()&lt;/td>
&lt;td style="text-align:center">()&lt;/td>
&lt;td style="text-align:center">()&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">{n}&lt;/td>
&lt;td style="text-align:left">匹配之前的项n次，n是可以为0的正整数&lt;/td>
&lt;td style="text-align:left">[0-9]{3}匹配任意一个三位数，可以扩展为[0-9][0-9][0-9]&lt;/td>
&lt;td style="text-align:center">不支持&lt;/td>
&lt;td style="text-align:center">{n}&lt;/td>
&lt;td style="text-align:center">{n}&lt;/td>
&lt;td style="text-align:center">{n}&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">{n,}&lt;/td>
&lt;td style="text-align:left">之前的项至少需要匹配n次&lt;/td>
&lt;td style="text-align:left">[0-9]{2,}匹配任意一个两位数或更多位数&lt;/td>
&lt;td style="text-align:center">不支持&lt;/td>
&lt;td style="text-align:center">{n,}&lt;/td>
&lt;td style="text-align:center">{n,}&lt;/td>
&lt;td style="text-align:center">{n,}&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">{n,m}&lt;/td>
&lt;td style="text-align:left">指定之前的项至少匹配n次，最多匹配m次，n&amp;lt;=m&lt;/td>
&lt;td style="text-align:left">[0-9]{2,5}匹配从两位数到五位数之间的任意一个数字&lt;/td>
&lt;td style="text-align:center">不支持&lt;/td>
&lt;td style="text-align:center">{n,m}&lt;/td>
&lt;td style="text-align:center">{n,m}&lt;/td>
&lt;td style="text-align:center">{n,m}&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">｜&lt;/td>
&lt;td style="text-align:left">交替匹配｜两边的任意一项&lt;/td>
&lt;td style="text-align:left">ab(c｜d)匹配abc或abd&lt;/td>
&lt;td style="text-align:center">不支持&lt;/td>
&lt;td style="text-align:center">｜&lt;/td>
&lt;td style="text-align:center">｜&lt;/td>
&lt;td style="text-align:center">｜&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="posix字符类">POSIX字符类&lt;/h2>
&lt;p>POSIX字符类是一个形如**[:...:]**的特殊元序列（meta sequence），他可以用于匹配特定的字符范围。&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:center">正则表达式&lt;/th>
&lt;th>描述&lt;/th>
&lt;th style="text-align:left">示例&lt;/th>
&lt;th style="text-align:center">Basic RegEx&lt;/th>
&lt;th style="text-align:center">Extended RegEx&lt;/th>
&lt;th style="text-align:center">Python RegEx&lt;/th>
&lt;th style="text-align:center">Perl RegEx&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:center">[:alnum:]&lt;/td>
&lt;td>匹配任意一个字母或数字字符&lt;/td>
&lt;td style="text-align:left">[[:alnum:]]+&lt;/td>
&lt;td style="text-align:center">[:alnum:]&lt;/td>
&lt;td style="text-align:center">[:alnum:]&lt;/td>
&lt;td style="text-align:center">[:alnum:]&lt;/td>
&lt;td style="text-align:center">[:alnum:]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">[:alpha:]&lt;/td>
&lt;td>匹配任意一个字母字符（包括大小写字母）&lt;/td>
&lt;td style="text-align:left">[[:alpha:]]{4}&lt;/td>
&lt;td style="text-align:center">[:alpha:]&lt;/td>
&lt;td style="text-align:center">[:alpha:]&lt;/td>
&lt;td style="text-align:center">[:alpha:]&lt;/td>
&lt;td style="text-align:center">[:alpha:]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">[:blank:]&lt;/td>
&lt;td>空格与制表符（横向和纵向）&lt;/td>
&lt;td style="text-align:left">[[:blank:]]*&lt;/td>
&lt;td style="text-align:center">[:blank:]&lt;/td>
&lt;td style="text-align:center">[:blank:]&lt;/td>
&lt;td style="text-align:center">[:blank:]&lt;/td>
&lt;td style="text-align:center">[:blank:]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">[:digit:]&lt;/td>
&lt;td>匹配任意一个数字字符&lt;/td>
&lt;td style="text-align:left">[[:digit:]]?&lt;/td>
&lt;td style="text-align:center">[:digit:]&lt;/td>
&lt;td style="text-align:center">[:digit:]&lt;/td>
&lt;td style="text-align:center">[:digit:]&lt;/td>
&lt;td style="text-align:center">[:digit:]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">[:lower:]&lt;/td>
&lt;td>匹配小写字母&lt;/td>
&lt;td style="text-align:left">[[:lower:]]{5,}&lt;/td>
&lt;td style="text-align:center">[:lower:]&lt;/td>
&lt;td style="text-align:center">[:lower:]&lt;/td>
&lt;td style="text-align:center">[:lower:]&lt;/td>
&lt;td style="text-align:center">[:lower:]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">[:upper:]&lt;/td>
&lt;td>匹配大写字母&lt;/td>
&lt;td style="text-align:left">([[:upper:]]+)?&lt;/td>
&lt;td style="text-align:center">[:upper:]&lt;/td>
&lt;td style="text-align:center">[:upper:]&lt;/td>
&lt;td style="text-align:center">[:upper:]&lt;/td>
&lt;td style="text-align:center">[:upper:]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">[:punct:]&lt;/td>
&lt;td>匹配标点符号&lt;/td>
&lt;td style="text-align:left">[[:punct:]]&lt;/td>
&lt;td style="text-align:center">[:punct:]&lt;/td>
&lt;td style="text-align:center">[:punct:]&lt;/td>
&lt;td style="text-align:center">[:punct:]&lt;/td>
&lt;td style="text-align:center">[:punct:]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">[:space:]&lt;/td>
&lt;td>匹配一个包括换行符、回车等在内的所有空白符&lt;/td>
&lt;td style="text-align:left">[[:space:]]+&lt;/td>
&lt;td style="text-align:center">[:space:]&lt;/td>
&lt;td style="text-align:center">[:space:]&lt;/td>
&lt;td style="text-align:center">[:space:]&lt;/td>
&lt;td style="text-align:center">[:space:]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">[:graph:]&lt;/td>
&lt;td>匹配任何一个可以看得见的且可以打印的字符&lt;/td>
&lt;td style="text-align:left">[[:graph:]]&lt;/td>
&lt;td style="text-align:center">[:graph:]&lt;/td>
&lt;td style="text-align:center">[:graph:]&lt;/td>
&lt;td style="text-align:center">[:graph:]&lt;/td>
&lt;td style="text-align:center">[:graph:]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">[:xdigit:]&lt;/td>
&lt;td>任何一个十六进制数（即：0-9，a-f，A-F）&lt;/td>
&lt;td style="text-align:left">[[:xdigit:]]+&lt;/td>
&lt;td style="text-align:center">[:xdigit:]&lt;/td>
&lt;td style="text-align:center">[:xdigit:]&lt;/td>
&lt;td style="text-align:center">[:xdigit:]&lt;/td>
&lt;td style="text-align:center">[:xdigit:]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">[:cntrl:]&lt;/td>
&lt;td>任何一个控制字符（&lt;a href="http://zh.wikipedia.org/zh/ASCII">ASCII&lt;/a>字符集中的前32个字符)&lt;/td>
&lt;td style="text-align:left">[[:cntrl:]]&lt;/td>
&lt;td style="text-align:center">[:cntrl:]&lt;/td>
&lt;td style="text-align:center">[:cntrl:]&lt;/td>
&lt;td style="text-align:center">[:cntrl:]&lt;/td>
&lt;td style="text-align:center">[:cntrl:]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">[:print:]&lt;/td>
&lt;td>任何一个可以打印的字符&lt;/td>
&lt;td style="text-align:left">[[:print:]]&lt;/td>
&lt;td style="text-align:center">[:print:]&lt;/td>
&lt;td style="text-align:center">[:print:]&lt;/td>
&lt;td style="text-align:center">[:print:]&lt;/td>
&lt;td style="text-align:center">[:print:]&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="元字符">元字符&lt;/h2>
&lt;p>元字符（meta character）是一种Perl风格的正则表达式，只有一部分文本处理工具支持它，并不是所有的文本处理工具都支持。&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:center">正则表达式&lt;/th>
&lt;th style="text-align:left">描述&lt;/th>
&lt;th style="text-align:left">示例&lt;/th>
&lt;th style="text-align:center">Basic RegEx&lt;/th>
&lt;th style="text-align:center">Extended RegEx&lt;/th>
&lt;th style="text-align:center">Python RegEx&lt;/th>
&lt;th style="text-align:center">Perl RegEx&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:center">\b&lt;/td>
&lt;td style="text-align:left">单词边界&lt;/td>
&lt;td style="text-align:left">\bcool\b 匹配cool，不匹配coolant&lt;/td>
&lt;td style="text-align:center">\b&lt;/td>
&lt;td style="text-align:center">\b&lt;/td>
&lt;td style="text-align:center">\b&lt;/td>
&lt;td style="text-align:center">\b&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">\B&lt;/td>
&lt;td style="text-align:left">非单词边界&lt;/td>
&lt;td style="text-align:left">cool\B 匹配coolant，不匹配cool&lt;/td>
&lt;td style="text-align:center">\B&lt;/td>
&lt;td style="text-align:center">\B&lt;/td>
&lt;td style="text-align:center">\B&lt;/td>
&lt;td style="text-align:center">\B&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">\d&lt;/td>
&lt;td style="text-align:left">单个数字字符&lt;/td>
&lt;td style="text-align:left">b\db 匹配b2b，不匹配bcb&lt;/td>
&lt;td style="text-align:center">不支持&lt;/td>
&lt;td style="text-align:center">不支持&lt;/td>
&lt;td style="text-align:center">\d&lt;/td>
&lt;td style="text-align:center">\d&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">\D&lt;/td>
&lt;td style="text-align:left">单个非数字字符&lt;/td>
&lt;td style="text-align:left">b\Db 匹配bcb，不匹配b2b&lt;/td>
&lt;td style="text-align:center">不支持&lt;/td>
&lt;td style="text-align:center">不支持&lt;/td>
&lt;td style="text-align:center">\D&lt;/td>
&lt;td style="text-align:center">\D&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">\w&lt;/td>
&lt;td style="text-align:left">单个单词字符（字母、数字与_）&lt;/td>
&lt;td style="text-align:left">\w 匹配1或a，不匹配&amp;amp;&lt;/td>
&lt;td style="text-align:center">\w&lt;/td>
&lt;td style="text-align:center">\w&lt;/td>
&lt;td style="text-align:center">\w&lt;/td>
&lt;td style="text-align:center">\w&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">\W&lt;/td>
&lt;td style="text-align:left">单个非单词字符&lt;/td>
&lt;td style="text-align:left">\W 匹配&amp;amp;，不匹配1或a&lt;/td>
&lt;td style="text-align:center">\W&lt;/td>
&lt;td style="text-align:center">\W&lt;/td>
&lt;td style="text-align:center">\W&lt;/td>
&lt;td style="text-align:center">\W&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">\n&lt;/td>
&lt;td style="text-align:left">换行符&lt;/td>
&lt;td style="text-align:left">\n 匹配一个新行&lt;/td>
&lt;td style="text-align:center">不支持&lt;/td>
&lt;td style="text-align:center">不支持&lt;/td>
&lt;td style="text-align:center">\n&lt;/td>
&lt;td style="text-align:center">\n&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">\s&lt;/td>
&lt;td style="text-align:left">单个空白字符&lt;/td>
&lt;td style="text-align:left">x\sx 匹配x x，不匹配xx&lt;/td>
&lt;td style="text-align:center">不支持&lt;/td>
&lt;td style="text-align:center">不支持&lt;/td>
&lt;td style="text-align:center">\s&lt;/td>
&lt;td style="text-align:center">\s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">\S&lt;/td>
&lt;td style="text-align:left">单个非空白字符&lt;/td>
&lt;td style="text-align:left">x\S\x 匹配xkx，不匹配xx&lt;/td>
&lt;td style="text-align:center">不支持&lt;/td>
&lt;td style="text-align:center">不支持&lt;/td>
&lt;td style="text-align:center">\S&lt;/td>
&lt;td style="text-align:center">\S&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">\r&lt;/td>
&lt;td style="text-align:left">回车&lt;/td>
&lt;td style="text-align:left">\r 匹配回车&lt;/td>
&lt;td style="text-align:center">不支持&lt;/td>
&lt;td style="text-align:center">不支持&lt;/td>
&lt;td style="text-align:center">\r&lt;/td>
&lt;td style="text-align:center">\r&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">\t&lt;/td>
&lt;td style="text-align:left">横向制表符&lt;/td>
&lt;td style="text-align:left">\t 匹配一个横向制表符&lt;/td>
&lt;td style="text-align:center">不支持&lt;/td>
&lt;td style="text-align:center">不支持&lt;/td>
&lt;td style="text-align:center">\t&lt;/td>
&lt;td style="text-align:center">\t&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">\v&lt;/td>
&lt;td style="text-align:left">垂直制表符&lt;/td>
&lt;td style="text-align:left">\v 匹配一个垂直制表符&lt;/td>
&lt;td style="text-align:center">不支持&lt;/td>
&lt;td style="text-align:center">不支持&lt;/td>
&lt;td style="text-align:center">\v&lt;/td>
&lt;td style="text-align:center">\v&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">\f&lt;/td>
&lt;td style="text-align:left">换页符&lt;/td>
&lt;td style="text-align:left">\f 匹配一个换页符&lt;/td>
&lt;td style="text-align:center">不支持&lt;/td>
&lt;td style="text-align:center">不支持&lt;/td>
&lt;td style="text-align:center">\f&lt;/td>
&lt;td style="text-align:center">\f&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="扩展阅读">扩展阅读&lt;/h2>
&lt;ol>
&lt;li>&lt;a href="https://deerchao.net/tutorials/regex/regex.htm">正则表达式30分钟入门教程&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://regex101.com/">正则表达式在线测试&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://pymotw.com/3/re/">Python Regular Expressions&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://deerchao.net/tools/regester/index.htm">正则表达式测试工具&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://deerchao.net/tutorials/regex/common.htm">常用正则表达式&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://zh.wikipedia.org/wiki/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F">维基百科-正则表达式&lt;/a>&lt;/li>
&lt;/ol></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>查询最近暴力破解服务器密码的IP归属地</title><link>https://blog.ferstar.org/post/%E6%9F%A5%E8%AF%A2%E6%9C%80%E8%BF%91%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AF%86%E7%A0%81%E7%9A%84ip%E5%BD%92%E5%B1%9E%E5%9C%B0/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E6%9F%A5%E8%AF%A2%E6%9C%80%E8%BF%91%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AF%86%E7%A0%81%E7%9A%84ip%E5%BD%92%E5%B1%9E%E5%9C%B0/</guid><pubDate>Mon, 12 Jun 2017 14:33:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>查询最近暴力破解服务器密码的IP归属地&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">cat /var/log/secure &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;/Failed/ {print $(NF-3)}&amp;#39;&lt;/span> &amp;gt; ip_list.txt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后查询&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">python ip_query.py -i ip_list.txt -o out.csv
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>就是利用淘宝IP地址查询API挨个把IP地址归属地查询一遍，结果放在&lt;code>csv&lt;/code>文件中，&lt;code>Excel&lt;/code>打开长这样&lt;/p>
&lt;p>&lt;img src="~/14-41-30.jpg" alt="">&lt;/p>
&lt;blockquote>
&lt;p>附: &lt;a href="https://github.com/ferstar/learnote/tree/master/%E6%89%B9%E9%87%8F%E6%9F%A5%E8%AF%A2IP%E5%BD%92%E5%B1%9E%E5%9C%B0%E8%84%9A%E6%9C%AC">ip_query.py&lt;/a>&lt;/p>
&lt;/blockquote></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/shell/">SHELL</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>Downloading Data On Demand By Using SRA-tool from NCBI DataBase</title><link>https://blog.ferstar.org/post/downloading-data-on-demand-by-using-sra-tool-from-ncbi-database/</link><guid isPermaLink="true">https://blog.ferstar.org/post/downloading-data-on-demand-by-using-sra-tool-from-ncbi-database/</guid><pubDate>Fri, 09 Jun 2017 14:25:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>vi &lt;a href="https://github.com/ncbi/sra-tools/wiki/Download-On-Demand">https://github.com/ncbi/sra-tools/wiki/Download-On-Demand&lt;/a>&lt;/p>
&lt;p>The majority of &lt;strong>sra-tools&lt;/strong> have the ability to locate and download data from the NCBI SRA on-demand, removing the need for a separate download step, and most importantly downloading only the data that are required. This feature can reduce the bandwidth, storage, and time taken to perform tasks that use less than 100% of the data contained in a run.&lt;/p>
&lt;p>&lt;strong>sra-tools&lt;/strong> utilize &lt;a href="https://github.com/ncbi/ncbi-vdb/wiki/Name-Resolution-Process">&lt;strong>VDB&lt;/strong> name resolution&lt;/a>, enabling them to accept simple accessions as parameters instead of filesystem paths. The &lt;strong>VDB&lt;/strong> name resolver will generate &lt;em>URLs&lt;/em> into the NCBI SRA for any object not found locally, allowing the object to be opened and retrieved over &lt;em>https&lt;/em>.&lt;/p>
&lt;hr>
&lt;h4 id="example-1---download-then-convert">Example 1 - Download Then Convert&lt;/h4>
&lt;pre tabindex="0">&lt;code>$ prefetch SRR000001
2016-12-01T15:51:52 prefetch.2.8.0: 1) Downloading &amp;#39;SRR000001&amp;#39;...
2016-12-01T15:51:52 prefetch.2.8.0: Downloading via http...
2016-12-01T15:52:22 prefetch.2.8.0: 1) &amp;#39;SRR000001&amp;#39; was downloaded successfully
&lt;/code>&lt;/pre>&lt;p>This demonstrates using &lt;code>prefetch&lt;/code> to download a run, in this case over &lt;em>https&lt;/em>. &lt;em>[NB - the tool still states that it is using &lt;strong>http&lt;/strong> even though it may be using &lt;strong>https&lt;/strong>. This is a cosmetic defect and will be fixed in the next release.]&lt;/em> For higher throughput, &lt;strong>Aspera&lt;/strong> downloads can be used if installed on your system.&lt;/p>
&lt;p>The actual file has been downloaded to a cache area in your filesystem:&lt;/p>
&lt;pre tabindex="0">&lt;code>$ srapath SRR000001
/home/you/ncbi/public/sra/SRR000001.sra
&lt;/code>&lt;/pre>&lt;p>The run file is compressed, occupying about 311M on disk:&lt;/p>
&lt;pre tabindex="0">&lt;code>$ ls -l /home/you/ncbi/public/sra/SRR000001.sra
-rw-rw-r-- 1 you you 325788509 2014-11-19 16:45 /home/you/ncbi/public/sra/SRR000001.sra
&lt;/code>&lt;/pre>&lt;p>Now convert to fastq &lt;em>(NOTE - runs downloaded with prefetch are now located by accession)&lt;/em>:&lt;/p>
&lt;pre tabindex="0">&lt;code>$ sff-dump SRR000001
Read 470985 spots for SRR000001
Written 470985 spots for SRR000001
&lt;/code>&lt;/pre>&lt;p>This run contains 454 data with signals. Here it is in SFF format (about 746M):&lt;/p>
&lt;pre tabindex="0">&lt;code>$ ls -l SRR000001.sff
-rw-rw-r-- 1 you you 782054672 2014-11-19 16:59 SRR000001.sff
&lt;/code>&lt;/pre>&lt;p>In this example, the run was first downloaded using &lt;code>prefetch&lt;/code> and stored in the user's public cache. Next, the run was converted into SFF, passing only the simple accession as an argument, but all data were read from cache.&lt;/p>
&lt;hr>
&lt;h4 id="example-2---directly-convert">Example 2 - Directly Convert&lt;/h4>
&lt;pre tabindex="0">&lt;code>$ cache-mgr --report
-----------------------------------
0 cached file(s)
1 complete file(s)
325,788,509 bytes in cached files
325,788,509 bytes used in cached files
0 lock files
&lt;/code>&lt;/pre>&lt;p>Here, we've checked the contents of our cache. It tells us that there are no &lt;em>partially&lt;/em> cached files, 1 complete file &lt;em>(our SRR000001.sra from example 1)&lt;/em>, and the corresponding bytes. The file was completely downloaded by &lt;code>prefetch&lt;/code>.&lt;/p>
&lt;p>Let's clear the cache entirely:&lt;/p>
&lt;pre tabindex="0">&lt;code>$ cache-mgr --clear
-----------------------------------
1 files removed
0 directories removed
325,788,509 bytes removed
&lt;/code>&lt;/pre>&lt;p>Now, we can run &lt;code>fastq-dump&lt;/code> on the accession without prior download. To verify that the run will be found remotely, we can use &lt;code>srapath&lt;/code> to tell us where the &lt;strong>complete&lt;/strong> object is located:&lt;/p>
&lt;pre tabindex="0">&lt;code>$ srapath SRR000001
https://sra-download.ncbi.nlm.nih.gov/srapub/SRR000001
&lt;/code>&lt;/pre>&lt;p>We see that the path is now remote. Let's convert on-the-fly:&lt;/p>
&lt;pre tabindex="0">&lt;code>$ fastq-dump SRR000001
Read 470985 spots for SRR000001
Written 470985 spots for SRR000001
&lt;/code>&lt;/pre>&lt;p>Looking at the &lt;em>fastq&lt;/em> file, we can see it is complete:&lt;/p>
&lt;pre tabindex="0">&lt;code>$ ls -l SRR000001.fastq
-rw-rw-r-- 1 you you 301196578 2014-11-19 17:17 SRR000001.fastq
$ wc -l SRR000001.fastq
1883940 SRR000001.fastq
$ expr 1883940 / 4
470985
&lt;/code>&lt;/pre>&lt;p>Notice that the fastq is slightly &lt;em>smaller&lt;/em> than the original SRA file. This is due to the fact that this SRA file also carries 454 &lt;strong>signal&lt;/strong> and &lt;strong>clipping&lt;/strong> data, as well as inlined &lt;strong>linker&lt;/strong> sequences that are not used by fastq. &lt;em>(This is true for all data submitted as SFF.)&lt;/em>&lt;/p>
&lt;p>Let's look again at the cache contents:&lt;/p>
&lt;pre tabindex="0">&lt;code>$ cache-mgr --report
-----------------------------------
1 cached file(s)
0 complete file(s)
325,788,832 bytes in cached files
121,351,760 bytes used in cached files
0 lock files
&lt;/code>&lt;/pre>&lt;p>The report tells us that there is 1 &lt;em>partially&lt;/em> cached file, and no complete files. This is because &lt;code>fastq-dump&lt;/code> only needs read &lt;strong>names&lt;/strong>, read &lt;strong>sequences&lt;/strong>, and &lt;strong>qualities&lt;/strong>. In this case, the amount of data cached is shown as 121,351,760 bytes, instead of the full 325,788,832 contained in the original SRR.&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/bio/">BIO</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>Win10 总有一个好像命令行窗口的弹窗一闪而过，怎么找到到底是什么问题？</title><link>https://blog.ferstar.org/post/win10-%E6%80%BB%E6%9C%89%E4%B8%80%E4%B8%AA%E5%A5%BD%E5%83%8F%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%AA%97%E5%8F%A3%E7%9A%84%E5%BC%B9%E7%AA%97%E4%B8%80%E9%97%AA%E8%80%8C%E8%BF%87%E6%80%8E%E4%B9%88%E6%89%BE%E5%88%B0%E5%88%B0%E5%BA%95%E6%98%AF%E4%BB%80%E4%B9%88%E9%97%AE%E9%A2%98/</link><guid isPermaLink="true">https://blog.ferstar.org/post/win10-%E6%80%BB%E6%9C%89%E4%B8%80%E4%B8%AA%E5%A5%BD%E5%83%8F%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%AA%97%E5%8F%A3%E7%9A%84%E5%BC%B9%E7%AA%97%E4%B8%80%E9%97%AA%E8%80%8C%E8%BF%87%E6%80%8E%E4%B9%88%E6%89%BE%E5%88%B0%E5%88%B0%E5%BA%95%E6%98%AF%E4%BB%80%E4%B9%88%E9%97%AE%E9%A2%98/</guid><pubDate>Fri, 09 Jun 2017 13:08:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>这是一个来自知乎的问题，不幸的是我貌似也遇到了，有个黑框一闪而逝，非常讨厌，原来是office的锅，必须得干掉之
&lt;a href="https://www.zhihu.com/question/38346620/answer/174871168">https://www.zhihu.com/question/38346620/answer/174871168&lt;/a>
巨硬论坛也有类似的解决方案
&lt;a href="https://answers.microsoft.com/en-us/msoffice/forum/msoffice_officeinsider-mso_win10/officebackgroundtaskhandlerregistration-flashes-a/2600497e-78e4-41a1-9040-461cd2c3ea13">https://answers.microsoft.com/en-us/msoffice/forum/msoffice_officeinsider-mso_win10/officebackgroundtaskhandlerregistration-flashes-a/2600497e-78e4-41a1-9040-461cd2c3ea13&lt;/a>
解决方法如图，很简单，更改运行用户账户为&lt;code>System&lt;/code>即可
&lt;img src="~/13-11-11.jpg" alt="">&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>使用conda安装qiime</title><link>https://blog.ferstar.org/post/%E4%BD%BF%E7%94%A8conda%E5%AE%89%E8%A3%85qiime/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E4%BD%BF%E7%94%A8conda%E5%AE%89%E8%A3%85qiime/</guid><pubDate>Sat, 27 May 2017 09:06:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>跟着官网安装说明做即可,注意装好conda后最好更换一下conda和pip源，不然网速会让你抓狂的
via &lt;a href="http://qiime.org/install/install.html">http://qiime.org/install/install.html&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">System &lt;span class="nv">information&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==================&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Platform: linux2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Python version: 2.7.13 &lt;span class="p">|&lt;/span>Continuum Analytics, Inc.&lt;span class="p">|&lt;/span> &lt;span class="o">(&lt;/span>default, Dec &lt;span class="m">20&lt;/span> 2016, 23:09:15&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>GCC 4.4.7 &lt;span class="m">20120313&lt;/span> &lt;span class="o">(&lt;/span>Red Hat 4.4.7-1&lt;span class="o">)]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Python executable: /home/ferstar/anaconda3/envs/qiime/bin/python
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">QIIME default reference &lt;span class="nv">information&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">===================================&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">For details on what files are used as QIIME&lt;span class="err">&amp;#39;&lt;/span>s default references, see here:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> https://github.com/biocore/qiime-default-reference/releases/tag/0.1.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dependency &lt;span class="nv">versions&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">===================&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> QIIME library version: 1.9.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> QIIME script version: 1.9.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">qiime-default-reference version: 0.1.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> NumPy version: 1.10.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> SciPy version: 0.17.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pandas version: 0.18.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> matplotlib version: 1.4.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> biom-format version: 2.1.5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> h5py version: Not installed. &lt;span class="c1"># 这个不能装&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> qcli version: 0.1.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pyqi version: 0.3.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> scikit-bio version: 0.2.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> PyNAST version: 1.2.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Emperor version: 0.9.51
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> burrito version: 0.9.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> burrito-fillings version: 0.1.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sortmerna version: SortMeRNA version 2.0, 29/11/2014
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sumaclust version: SUMACLUST Version 1.0.00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> swarm version: Swarm 1.2.19 &lt;span class="o">[&lt;/span>Apr &lt;span class="m">12&lt;/span> &lt;span class="m">2017&lt;/span> 17:30:22&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> gdata: Installed.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">QIIME config &lt;span class="nv">values&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">===================&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">For definitions of these settings and to learn how to configure QIIME, see here:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> http://qiime.org/install/qiime_config.html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> http://qiime.org/tutorials/parallel_qiime.html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> blastmat_dir: None
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pick_otus_reference_seqs_fp: /home/ferstar/anaconda3/envs/qiime/lib/python2.7/site-packages/qiime_default_reference/gg_13_8_otus/rep_set/97_otus.fasta
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sc_queue: all.q
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> topiaryexplorer_project_dir: None
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pynast_template_alignment_fp: /home/ferstar/anaconda3/envs/qiime/lib/python2.7/site-packages/qiime_default_reference/gg_13_8_otus/rep_set_aligned/85_otus.pynast.fasta
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> cluster_jobs_fp: start_parallel_jobs.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pynast_template_alignment_blastdb: None
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">assign_taxonomy_reference_seqs_fp: /home/ferstar/anaconda3/envs/qiime/lib/python2.7/site-packages/qiime_default_reference/gg_13_8_otus/rep_set/97_otus.fasta
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> torque_queue: friendlyq
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> jobs_to_start: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> slurm_time: None
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> denoiser_min_per_core: &lt;span class="m">50&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">assign_taxonomy_id_to_taxonomy_fp: /home/ferstar/anaconda3/envs/qiime/lib/python2.7/site-packages/qiime_default_reference/gg_13_8_otus/taxonomy/97_otu_taxonomy.txt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> temp_dir: /tmp/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> slurm_memory: None
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> slurm_queue: None
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> blastall_fp: blastall
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> seconds_to_sleep: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">QIIME base install &lt;span class="nb">test&lt;/span> &lt;span class="nv">results&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">===============================&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">.........
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">----------------------------------------------------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Ran &lt;span class="m">9&lt;/span> tests in 0.022s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">OK
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="关于ssh终端如何使用matplotlib画图的问题">关于ssh终端如何使用matplotlib画图的问题&lt;/h2>
&lt;p>via &lt;a href="http://stackoverflow.com/questions/2801882/generating-a-png-with-matplotlib-when-display-is-undefined">http://stackoverflow.com/questions/2801882/generating-a-png-with-matplotlib-when-display-is-undefined&lt;/a>
方法有很多, 由于我是管理员, 所以选择一个全局的方案, 如下:&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; import matplotlib
&amp;gt;&amp;gt;&amp;gt; matplotlib.matplotlib_fname()
u&amp;#39;/prodata/miniconda2/envs/qiime/lib/python2.7/site-packages/matplotlib/mpl-data/matplotlibrc&amp;#39;
&lt;/code>&lt;/pre>&lt;p>打开这个文件, 把backend改成agg即可, 首字母a不区分大小写&lt;/p>
&lt;h2 id="更换清华大学conda源">更换清华大学conda源&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ vi ~/.condarc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">channels:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - bioconda
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - r
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - defaults
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - conda-forge
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">show_channel_urls: &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="更换阿里pip源">更换阿里pip源&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ mkdir ~/.pip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ vi ~/.pip/pip.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>global&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">trusted-host &lt;span class="o">=&lt;/span> mirrors.aliyun.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">index-url &lt;span class="o">=&lt;/span> http://mirrors.aliyun.com/pypi/simple
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>farbox搬家记</title><link>https://blog.ferstar.org/post/farbox%E6%90%AC%E5%AE%B6%E8%AE%B0/</link><guid isPermaLink="true">https://blog.ferstar.org/post/farbox%E6%90%AC%E5%AE%B6%E8%AE%B0/</guid><pubDate>Mon, 22 May 2017 14:08:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>前几天收到farbox的邮件，说由于dropbox api的停摆，farbox造了个bitcron的东东来替代，去官博看了下跟farbox感觉并无太大差别，依旧延续了我喜欢的小清新风格，所以照着博客说明迁移了下。&lt;/p>
&lt;h2 id="迁移到-bitcron-吧">迁移到 Bitcron 吧&lt;/h2>
&lt;p>考虑到 Dropbox API 停摆之后的问题 (主要是新的文章、图片将无法再通过 Dropbox 更新)，我们建议迁移到 Bitcron。
Bitcron 除了长得更好看、更快之外，还有很多非常强大的功能，而且后续 (网站) 更新内容跟 FarBox 一样，通过 Dropbox 同步，几近可以忽略 Bitcron 的存在。
至于更强大的功能，除了 自动 HTTPS、DailyNote、一个网站多个微信绑定 等琐碎的功能外，还有曾经 FarBox 存在的几个试验性质的 App (比如一页小站)，已经完全产品化为 SmartPage，效果非常惊艳。
我们简单地总结了下 Bitcron 一些特别的功能 (未来仍然会不断更新)，可以访问https://features.bitcron.com 具体了解。&lt;/p>
&lt;h2 id="如何迁移">如何迁移？&lt;/h2>
&lt;p>Bitcron 不会对外开放注册的，需要邀请才可以，没什么变故的话，未来也是如此。
所以，在迁移到 Bitcron 的过程中，注册账户时，务必使用自己 FarBox 的账户邮箱、并且通过这个 URL &lt;a href="https://bitcron.com/login?by_farbox=true">https://bitcron.com/login?by_farbox=true&lt;/a> 进行注册，不然系统会提醒需要邀请才能继续。
另外， Bitcron 注册成功后，会自动从 FarBox 上合并账户余额到 Bitcron 上 (不会影响 FarBox 上的数据和使用)。
具体数据如何迁移，请参考这个页面 &lt;a href="https://faq.bitcron.com/read/move-from-farbox#toc_1">https://faq.bitcron.com/read/move-from-farbox#toc_1&lt;/a>&lt;/p>
&lt;h2 id="小改farbox-editor">小改farbox editor&lt;/h2>
&lt;p>迁移后发现farbox editor用不了，在dropbox应用文件夹下单独建立的是Farbox文件夹，所以就想到用软链接解决问题，linux下so easy，Windows下也好整&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">C:&lt;span class="se">\U&lt;/span>sers&lt;span class="se">\f&lt;/span>er_s&lt;span class="se">\D&lt;/span>ropbox&lt;span class="se">\应&lt;/span>用&amp;gt;mklink
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">创建符号链接。
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">MKLINK &lt;span class="o">[[&lt;/span>/D&lt;span class="o">]&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="o">[&lt;/span>/H&lt;span class="o">]&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="o">[&lt;/span>/J&lt;span class="o">]]&lt;/span> Link Target
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /D 创建目录符号链接。默认为文件
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 符号链接。
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /H 创建硬链接而非符号链接。
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /J 创建目录联接。
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Link 指定新的符号链接名称。
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Target 指定新链接引用的路径
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">(&lt;/span>相对或绝对&lt;span class="o">)&lt;/span>。
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">C:&lt;span class="se">\U&lt;/span>sers&lt;span class="se">\f&lt;/span>er_s&lt;span class="se">\D&lt;/span>ropbox&lt;span class="se">\应&lt;/span>用&amp;gt;mklink /J Farbox Bitcron
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">为 Farbox &amp;lt;&amp;lt;&lt;span class="o">===&lt;/span>&amp;gt;&amp;gt; Bitcron 创建的联接
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>嗯，farbox editor又可以愉快的玩耍了&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/windows/">WINDOWS</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/farbox/">FARBOX</category><category domain="https://blog.ferstar.org/tags/bitcron/">BITCRON</category></item><item><title>百度在线翻译demo for Python3</title><link>https://blog.ferstar.org/post/%E7%99%BE%E5%BA%A6%E5%9C%A8%E7%BA%BF%E7%BF%BB%E8%AF%91demo-for-python3/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E7%99%BE%E5%BA%A6%E5%9C%A8%E7%BA%BF%E7%BF%BB%E8%AF%91demo-for-python3/</guid><pubDate>Sun, 01 Jan 2017 13:56:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>百度提供的demo是Python2，在Python3上各种报错，于是小改了下，凑合能用
via &lt;a href="http://api.fanyi.baidu.com/api/trans/product/apidoc">http://api.fanyi.baidu.com/api/trans/product/apidoc&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># /usr/bin/env python&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># coding=&amp;#39;utf8&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">http.client&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">json&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">random&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">hashlib&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">md5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">urllib.parse&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">quote&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">appid&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;20151113000005349&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">secretKey&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;osubCEzlGjzvw8qdQc41&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">myurl&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;/api/trans/vip/translate&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">q&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;Long time no see&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">fromLang&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;en&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">toLang&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;zh&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">salt&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">random&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">randint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">32768&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">65536&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">sign&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">appid&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">q&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">salt&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">secretKey&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">m1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">md5&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">m1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">update&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sign&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">encode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">encoding&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;utf-8&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">sign&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">m1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">hexdigest&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">myurl&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">myurl&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s1">&amp;#39;?appid=&amp;#39;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">appid&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s1">&amp;#39;&amp;amp;q=&amp;#39;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">quote&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">q&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s1">&amp;#39;&amp;amp;from=&amp;#39;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">fromLang&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s1">&amp;#39;&amp;amp;to=&amp;#39;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">toLang&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s1">&amp;#39;&amp;amp;salt=&amp;#39;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">salt&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s1">&amp;#39;&amp;amp;sign=&amp;#39;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">sign&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># httpClient = http.client.HTTPConnection(&amp;#39;api.fanyi.baidu.com&amp;#39;)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">httpClient&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">http&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">HTTPSConnection&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;fanyi-api.baidu.com&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">httpClient&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;GET&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">myurl&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># response是HTTPResponse对象&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">response&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">httpClient&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">getresponse&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">json&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">loads&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">encoding&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;utf-8&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;trans_result&amp;#39;&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="s1">&amp;#39;dst&amp;#39;&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">except&lt;/span> &lt;span class="ne">Exception&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">finally&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">httpClient&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">httpClient&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>打印结果：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">{&lt;/span>&lt;span class="s1">&amp;#39;from&amp;#39;&lt;/span>: &lt;span class="s1">&amp;#39;en&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;to&amp;#39;&lt;/span>: &lt;span class="s1">&amp;#39;zh&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;trans_result&amp;#39;&lt;/span>: &lt;span class="o">[{&lt;/span>&lt;span class="s1">&amp;#39;src&amp;#39;&lt;/span>: &lt;span class="s1">&amp;#39;Long time no see&amp;#39;&lt;/span>, &lt;span class="s1">&amp;#39;dst&amp;#39;&lt;/span>: &lt;span class="s1">&amp;#39;好久不见&amp;#39;&lt;/span>&lt;span class="o">}]}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">好久不见
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>Python 3.x控制台输入密码的方法总结</title><link>https://blog.ferstar.org/post/python-3/</link><guid isPermaLink="true">https://blog.ferstar.org/post/python-3/</guid><pubDate>Wed, 28 Dec 2016 09:34:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>昨天撸了个公司OA消息提醒工具, 发现让人在控制台输入密码不给隐藏是一件很羞耻的事情, 于是就诞生了这个需求&lt;/p>
&lt;blockquote>
&lt;p>输入密码时回显*号&lt;/p>
&lt;/blockquote>
&lt;p>Google 大法后, 发现这位仁兄已经提前帮我实现了, 甚是开心&lt;/p>
&lt;p>&lt;a href="http://www.programgo.com/article/48653077853/">http://www.programgo.com/article/48653077853/&lt;/a>&lt;/p>
&lt;p>原理大概就是&lt;code>接受一个字符输入后光标立马回退, 显示*号占位, 依次类推&lt;/code>&lt;/p>
&lt;p>放码如下:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">msvcrt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">pwd_input&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;输入密码替换为星号
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :return: 字符串形式密码
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">chars&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="kc">True&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">new_char&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">msvcrt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">getch&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">encoding&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;utf-8&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nb">input&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;你很可能不是在cmd命令行下运行，密码输入将不能隐藏:&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">new_char&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="se">\r\n&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="c1"># 如果是换行，则输入结束&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="n">new_char&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="se">\b&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="c1"># 如果是退格，则删除密码末尾一位并且删除一个星号&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">chars&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">del&lt;/span> &lt;span class="n">chars&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">msvcrt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">putch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="se">\b&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">encode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">encoding&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;utf-8&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="c1"># 光标回退一格&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">msvcrt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">putch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39; &amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">encode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">encoding&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;utf-8&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="c1"># 输出一个空格覆盖原来的星号&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">msvcrt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">putch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="se">\b&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">encode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">encoding&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;utf-8&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="c1"># 光标回退一格准备接受新的输入&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">chars&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">new_char&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">msvcrt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">putch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;*&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">encode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">encoding&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;utf-8&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="c1"># 显示为星号&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">chars&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;请输入密码：&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">pwd&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">pwd_input&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">密码是：&lt;/span>&lt;span class="si">{0}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pwd&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">input&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;按回车键退出&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Linux下可以用getpass.getpass() 缺点是不回显任何内容, 不知道的还以为没有输入进去呢&lt;/p>
&lt;p>所以类似的Linux下可使用termios, 在windows下要用msvcrt代替termios&lt;/p>
&lt;p>人生苦短, 必须Python啊!&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/windows/">WINDOWS</category></item><item><title>爬一个上古OA系统记录</title><link>https://blog.ferstar.org/post/%E7%88%AC%E4%B8%80%E4%B8%AA%E4%B8%8A%E5%8F%A4oa%E7%B3%BB%E7%BB%9F%E8%AE%B0%E5%BD%95/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E7%88%AC%E4%B8%80%E4%B8%AA%E4%B8%8A%E5%8F%A4oa%E7%B3%BB%E7%BB%9F%E8%AE%B0%E5%BD%95/</guid><pubDate>Fri, 23 Dec 2016 09:51:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>对, 是的, 就是我司的OA系统, 界面浓浓的上世纪90年代风格, 响应也很慢, 所以一般除了看通知和月底交报表以外几乎不会打开这货, 但是公司通知确实是在这上面分发的, 所以就萌生了写个脚本定时检查通知, 有新通知给我发邮件提醒&lt;/p>
&lt;p>也就是一个爬虫的情形, 所以兴高采烈开始用Python撸&lt;/p>
&lt;h2 id="1-找登录接口及新消息接口">1. 找登录接口及新消息接口&lt;/h2>
&lt;blockquote>
&lt;p>这一步没什么好说的, 用 Chrome 或者 Firefox 的开发者工具 Network 选项找&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>
&lt;p>登录接口&lt;/p>
&lt;p>URL: &lt;code>http://&amp;lt;我司官网url&amp;gt;/logincheck.php&lt;/code>&lt;/p>
&lt;p>POST 表单内容: &lt;code>UNAME=用户名&amp;amp;PASSWORD=密码&lt;/code>&lt;/p>
&lt;p>编码: &lt;code>charset=gb2312&lt;/code>&lt;/p>
&lt;p>Content-Type: &lt;code>application/x-www-form-urlencoded&lt;/code>&lt;/p>
&lt;p>得到cookie格式: response headers 里面 &lt;code>Set-Cookie&lt;/code>字段值拼起来&lt;/p>
&lt;/li>
&lt;li>
&lt;p>新消息接口&lt;/p>
&lt;p>URL: &lt;code>http://&amp;lt;我司官网url&amp;gt;/attachment/new_sms/&amp;lt;userid&amp;gt;.sms?now=&amp;lt;timestamp&amp;gt;&lt;/code>&lt;/p>
&lt;p>方法: 当然是带着&lt;code>cookie&lt;/code>的&lt;code>GET&lt;/code>&lt;/p>
&lt;p>cookie: &lt;code>PHPSESSID=&amp;lt;模拟登录后拿到&amp;gt;; USER_NAME_COOKIE=&amp;lt;用户名全拼&amp;gt;; OA_USER_ID=&amp;lt;用户名全拼&amp;gt;; SID_&amp;lt;员工编号, 目前三位数, 也是模拟登录后才能拿到&amp;gt;=&amp;lt;这个不知道什么鬼, 反正模拟登录后也能拿到&amp;gt;; UI_COOKIE=0&lt;/code>&lt;/p>
&lt;p>返回值: 新消息为1 / 无新消息为0 &lt;string>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="2-拿-cookie">2. 拿 cookie&lt;/h2>
&lt;p>自然是模拟登录才能拿到了, 比较奇葩的是这货只有&lt;code>curl&lt;/code>才能解析到正确的响应, 其他用&lt;code>requests&lt;/code>或者&lt;code>http.client&lt;/code>构造&lt;code>POST&lt;/code>都无法拿到正确的&lt;code>cookie&lt;/code>信息, 所以用&lt;code>pycurl&lt;/code>解决, 放码:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Cookies&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">url&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;我司URL&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">username&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;用户名&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">password&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;密码&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">status&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">None&lt;/span> &lt;span class="c1"># 存status code, 正确回应是302&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cookies&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span> &lt;span class="c1"># 存各种cookie项&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">user_id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">_body&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">buf&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># drop body info&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;nul&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;w&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">fh&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="c1"># 执行perform函数后总是返回烦人的body内容, 我只要header信息, 所以这部分body直接扔掉, linux 系统 nul 要换成 /dev/null&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">buf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">fh&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">_store&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">buf&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">buf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">bytes&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">buf&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">buf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;gb2312&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">buf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">startswith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;HTTP/1.1&amp;#39;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 获取HTTP Status Code&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">status&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">buf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39; &amp;#39;&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="n">buf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">startswith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Set-Cookie:&amp;#39;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 获取 Cookie&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">item&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">buf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strip&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;: &amp;#39;&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;;&amp;#39;&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cookies&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">item&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">startswith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;SID_&amp;#39;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 从 Cookie 中截取 user_id&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">user_id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">item&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;=&amp;#34;&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;_&amp;#39;&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">post_data&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;UNAME&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">username&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;PASSWORD&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">password&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Form data must be provided already urlencoded.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">post_fields&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">urlencode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">post_data&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">c&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">pycurl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Curl&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">c&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">URL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;http://&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s1">/logincheck.php&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">url&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">c&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">WRITEFUNCTION&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_body&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># save header info&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">c&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">HEADERFUNCTION&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_store&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Sets request method to POST,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Content-Type header to application/x-www-form-urlencoded&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># and data to send in request body.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">c&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">POSTFIELDS&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">post_fields&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">c&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">perform&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">c&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后就是调用上面这货拿 cookie 了&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">ck&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Cookies&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ck&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">username&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;xxx&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ck&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">password&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;xxx&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ck&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cookie&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;; &amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ck&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cookies&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># cookie = PHPSESSID=67244df787460089c92def22b99e8cb1; USER_NAME_COOKIE=xxx; OA_USER_ID=xxx; SID_110=32e00603; UI_COOKIE=0&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="3-检测新消息">3. 检测新消息&lt;/h2>
&lt;p>拿到 cookie 后就可以从消息接口 GET 信息了, &lt;code>pycurl&lt;/code>还是难用, 这次用自带的&lt;code>http.client&lt;/code>来做&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">check_sms&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">user_id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">cookie&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">conn&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">http&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">HTTPConnection&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">host&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">headers&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;user-agent&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.102 Safari/537.36&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;accept&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;*/*&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;accept-encoding&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;gzip, deflate, sdch&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;accept-language&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;zh-CN,zh;q=0.8&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;cookie&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">cookie&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">conn&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;GET&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;/attachment/new_sms/&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">.sms?now=&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">user_id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">()),&lt;/span> &lt;span class="n">headers&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">headers&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">res&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">conn&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">getresponse&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">data&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">res&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">data&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;gb2312&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>返回值为1即有新消息, 0表示没有新消息&lt;/p>
&lt;blockquote>
&lt;p>PS: 比较奇葩的是走到这一步忽然才发现这个新消息接口不用cookie也可以查询, 也就是根本匿名都可以访问, 顿时有种吃了苍蝇的感觉, 好比是好不容易撬掉门锁以后忽然发现这门即使上锁也能打开的...&lt;/p>
&lt;/blockquote>
&lt;h2 id="4-有新消息发邮件">4. 有新消息发邮件&lt;/h2>
&lt;p>这一步写个循环定时检测消息即可&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Mail&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">is_send&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">False&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">mail_addr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">password&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">send&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">is_send&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="c1"># 已经发过邮件就不再发送&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 第三方 SMTP 服务&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">mail_host&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;smtp.163.com&amp;#34;&lt;/span> &lt;span class="c1"># SMTP服务器&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">mail_user&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34; &amp;#34;&lt;/span> &lt;span class="c1"># 用户名&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">mail_pass&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34; &amp;#34;&lt;/span> &lt;span class="c1"># 密码&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sender&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39; &amp;#39;&lt;/span> &lt;span class="c1"># 发件人邮箱(最好写全, 不然会失败)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">receivers&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39; &amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c1"># 接收邮件，可设置为你的QQ邮箱或者其他邮箱&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">content&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;OA有新消息, 请注意查收&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">title&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;OA有新消息, 请注意查收&amp;#39;&lt;/span> &lt;span class="c1"># 邮件主题&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">message&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">MIMEText&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">content&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;plain&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;utf-8&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># 内容, 格式, 编码&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">message&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;From&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sender&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">message&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;To&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">receivers&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">message&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;Subject&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">title&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">smtpObj&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">smtplib&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">SMTP_SSL&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">mail_host&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">465&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># 启用SSL发信, 端口一般是465&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">smtpObj&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">login&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">mail_user&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">mail_pass&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># 登录验证&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">smtpObj&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sendmail&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sender&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">receivers&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">message&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">as_string&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="c1"># 发送&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;mail has been send successfully.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span> &lt;span class="n">smtplib&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">SMTPException&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">mail&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Mail&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">check_sms&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ck&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">user_id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">cookie&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="s2">&amp;#34;0&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">mail&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1"># 有新消息, 发邮件&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">mail&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">is_send&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">True&lt;/span> &lt;span class="c1"># 证明邮件已发&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">mail&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">is_send&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">False&lt;/span> &lt;span class="c1"># 无新消息, 恢复未发邮件状态&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">5&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">60&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># sleep 5min&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">except&lt;/span> &lt;span class="ne">KeyboardInterrupt&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Ctrl + C pressed, will exit.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">exit&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="5-pyinstaller-打包">5. pyinstaller 打包&lt;/h2>
&lt;p>这部分在之前的文章&lt;a href="http://0ne.farbox.com/post/python/pythonda-bao-gong-ju-pyinstallershi-yong-ji-lu">Python打包工具Pyinstaller使用记录&lt;/a>有提到, 照着撸即可&lt;/p>
&lt;p>&lt;code>pyinstaller -F -c check_sms.py&lt;/code>&lt;/p>
&lt;h2 id="6-其他包装">6. 其他包装&lt;/h2>
&lt;p>把参数写死不是个好事情, 所以又弄了下配置文件, 把用户名/密码/OA地址都写到配置文件里&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">configparser&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cf&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">configparser&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ConfigParser&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">conf_file&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="n">cf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;main&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;send_to&amp;#34;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">mail&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send_to&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;main&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;send_to&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">mail&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send_to&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">input&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;请输入你的邮箱地址: &amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strip&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;main&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;send_to&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">mail&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send_to&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">conf_file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;w&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="c1"># 写入配置文件&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后发现如果明文保存密码似乎也是不好的, 于是再上个君子协定&lt;code>base64&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">base64&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="n">cf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;main&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;password&amp;#34;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ck&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">password&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">base64&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">b64decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">bytes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;main&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;password&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s1">&amp;#39;utf8&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;utf8&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;请输入OA密码: &amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ck&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">password&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">pwd_input&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;main&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;password&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">base64&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">b64encode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">bytes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ck&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">password&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;utf8&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;utf8&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">conf_file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;w&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="7-成果">7. 成果&lt;/h2>
&lt;p>嗯, 终于可以不用担心那个垃圾的OA漏消息了,我很满意
&lt;img src="~/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20161228093640.png" alt="">&lt;/p>
&lt;h2 id="8-放码">8. 放码&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;span class="lnt">107
&lt;/span>&lt;span class="lnt">108
&lt;/span>&lt;span class="lnt">109
&lt;/span>&lt;span class="lnt">110
&lt;/span>&lt;span class="lnt">111
&lt;/span>&lt;span class="lnt">112
&lt;/span>&lt;span class="lnt">113
&lt;/span>&lt;span class="lnt">114
&lt;/span>&lt;span class="lnt">115
&lt;/span>&lt;span class="lnt">116
&lt;/span>&lt;span class="lnt">117
&lt;/span>&lt;span class="lnt">118
&lt;/span>&lt;span class="lnt">119
&lt;/span>&lt;span class="lnt">120
&lt;/span>&lt;span class="lnt">121
&lt;/span>&lt;span class="lnt">122
&lt;/span>&lt;span class="lnt">123
&lt;/span>&lt;span class="lnt">124
&lt;/span>&lt;span class="lnt">125
&lt;/span>&lt;span class="lnt">126
&lt;/span>&lt;span class="lnt">127
&lt;/span>&lt;span class="lnt">128
&lt;/span>&lt;span class="lnt">129
&lt;/span>&lt;span class="lnt">130
&lt;/span>&lt;span class="lnt">131
&lt;/span>&lt;span class="lnt">132
&lt;/span>&lt;span class="lnt">133
&lt;/span>&lt;span class="lnt">134
&lt;/span>&lt;span class="lnt">135
&lt;/span>&lt;span class="lnt">136
&lt;/span>&lt;span class="lnt">137
&lt;/span>&lt;span class="lnt">138
&lt;/span>&lt;span class="lnt">139
&lt;/span>&lt;span class="lnt">140
&lt;/span>&lt;span class="lnt">141
&lt;/span>&lt;span class="lnt">142
&lt;/span>&lt;span class="lnt">143
&lt;/span>&lt;span class="lnt">144
&lt;/span>&lt;span class="lnt">145
&lt;/span>&lt;span class="lnt">146
&lt;/span>&lt;span class="lnt">147
&lt;/span>&lt;span class="lnt">148
&lt;/span>&lt;span class="lnt">149
&lt;/span>&lt;span class="lnt">150
&lt;/span>&lt;span class="lnt">151
&lt;/span>&lt;span class="lnt">152
&lt;/span>&lt;span class="lnt">153
&lt;/span>&lt;span class="lnt">154
&lt;/span>&lt;span class="lnt">155
&lt;/span>&lt;span class="lnt">156
&lt;/span>&lt;span class="lnt">157
&lt;/span>&lt;span class="lnt">158
&lt;/span>&lt;span class="lnt">159
&lt;/span>&lt;span class="lnt">160
&lt;/span>&lt;span class="lnt">161
&lt;/span>&lt;span class="lnt">162
&lt;/span>&lt;span class="lnt">163
&lt;/span>&lt;span class="lnt">164
&lt;/span>&lt;span class="lnt">165
&lt;/span>&lt;span class="lnt">166
&lt;/span>&lt;span class="lnt">167
&lt;/span>&lt;span class="lnt">168
&lt;/span>&lt;span class="lnt">169
&lt;/span>&lt;span class="lnt">170
&lt;/span>&lt;span class="lnt">171
&lt;/span>&lt;span class="lnt">172
&lt;/span>&lt;span class="lnt">173
&lt;/span>&lt;span class="lnt">174
&lt;/span>&lt;span class="lnt">175
&lt;/span>&lt;span class="lnt">176
&lt;/span>&lt;span class="lnt">177
&lt;/span>&lt;span class="lnt">178
&lt;/span>&lt;span class="lnt">179
&lt;/span>&lt;span class="lnt">180
&lt;/span>&lt;span class="lnt">181
&lt;/span>&lt;span class="lnt">182
&lt;/span>&lt;span class="lnt">183
&lt;/span>&lt;span class="lnt">184
&lt;/span>&lt;span class="lnt">185
&lt;/span>&lt;span class="lnt">186
&lt;/span>&lt;span class="lnt">187
&lt;/span>&lt;span class="lnt">188
&lt;/span>&lt;span class="lnt">189
&lt;/span>&lt;span class="lnt">190
&lt;/span>&lt;span class="lnt">191
&lt;/span>&lt;span class="lnt">192
&lt;/span>&lt;span class="lnt">193
&lt;/span>&lt;span class="lnt">194
&lt;/span>&lt;span class="lnt">195
&lt;/span>&lt;span class="lnt">196
&lt;/span>&lt;span class="lnt">197
&lt;/span>&lt;span class="lnt">198
&lt;/span>&lt;span class="lnt">199
&lt;/span>&lt;span class="lnt">200
&lt;/span>&lt;span class="lnt">201
&lt;/span>&lt;span class="lnt">202
&lt;/span>&lt;span class="lnt">203
&lt;/span>&lt;span class="lnt">204
&lt;/span>&lt;span class="lnt">205
&lt;/span>&lt;span class="lnt">206
&lt;/span>&lt;span class="lnt">207
&lt;/span>&lt;span class="lnt">208
&lt;/span>&lt;span class="lnt">209
&lt;/span>&lt;span class="lnt">210
&lt;/span>&lt;span class="lnt">211
&lt;/span>&lt;span class="lnt">212
&lt;/span>&lt;span class="lnt">213
&lt;/span>&lt;span class="lnt">214
&lt;/span>&lt;span class="lnt">215
&lt;/span>&lt;span class="lnt">216
&lt;/span>&lt;span class="lnt">217
&lt;/span>&lt;span class="lnt">218
&lt;/span>&lt;span class="lnt">219
&lt;/span>&lt;span class="lnt">220
&lt;/span>&lt;span class="lnt">221
&lt;/span>&lt;span class="lnt">222
&lt;/span>&lt;span class="lnt">223
&lt;/span>&lt;span class="lnt">224
&lt;/span>&lt;span class="lnt">225
&lt;/span>&lt;span class="lnt">226
&lt;/span>&lt;span class="lnt">227
&lt;/span>&lt;span class="lnt">228
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">base64&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">configparser&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">http.client&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">msvcrt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">os&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">pycurl&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">smtplib&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">time&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">email.mime.text&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">MIMEText&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">urllib.parse&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">urlencode&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Cookies&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">url&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">username&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">password&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">status&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cookies&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">user_id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">_body&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">buf&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># drop body info&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;nul&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;w&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">fh&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">buf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">fh&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">_store&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">buf&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">buf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">bytes&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">buf&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">buf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;gb2312&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">buf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">startswith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;HTTP/1.1&amp;#39;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 获取HTTP Status Code&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">status&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">buf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39; &amp;#39;&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="n">buf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">startswith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Set-Cookie:&amp;#39;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 获取 Cookie&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">item&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">buf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strip&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;: &amp;#39;&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;;&amp;#39;&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cookies&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">item&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">startswith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;SID_&amp;#39;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 从 Cookie 中截取 user_id&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">user_id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">item&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;=&amp;#34;&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;_&amp;#39;&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">post_data&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;UNAME&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">username&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;PASSWORD&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">password&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Form data must be provided already urlencoded.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">post_fields&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">urlencode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">post_data&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">c&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">pycurl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Curl&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">c&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">URL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;http://&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s1">/logincheck.php&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">url&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">c&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">WRITEFUNCTION&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_body&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># save header info&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">c&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">HEADERFUNCTION&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_store&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Sets request method to POST,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Content-Type header to application/x-www-form-urlencoded&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># and data to send in request body.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">c&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">POSTFIELDS&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">post_fields&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">c&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">perform&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">c&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Mail&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">is_send&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">False&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send_to&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">host&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">send&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">is_send&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 第三方 SMTP 服务&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">mail_host&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;smtp.126.com&amp;#34;&lt;/span> &lt;span class="c1"># SMTP服务器&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">mail_user&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;xxx&amp;#34;&lt;/span> &lt;span class="c1"># 用户名&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">mail_pass&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;xxx&amp;#34;&lt;/span> &lt;span class="c1"># 密码&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sender&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;xxx@126.com&amp;#39;&lt;/span> &lt;span class="c1"># 发件人邮箱(最好写全, 不然会失败)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">title&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;OA有新消息, 请注意查收&amp;#39;&lt;/span> &lt;span class="c1"># 邮件主题&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">content&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;点我直达: http://&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s1"> &lt;/span>&lt;span class="se">\n\n&lt;/span>&lt;span class="s1">有问题可以在云之家@贾大空&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">host&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">message&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">MIMEText&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">content&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;plain&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;utf-8&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># 内容, 格式, 编码&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">message&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;From&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sender&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">message&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;To&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send_to&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">message&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;Subject&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">title&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">smtpObj&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">smtplib&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">SMTP_SSL&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">mail_host&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">465&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># 启用SSL发信, 端口一般是465&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">smtpObj&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">login&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">mail_user&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">mail_pass&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># 登录验证&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">smtpObj&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sendmail&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sender&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send_to&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">message&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">as_string&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="c1"># 发送&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">is_send&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">True&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;检测到新消息, 邮件通知已发送&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span> &lt;span class="n">smtplib&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">SMTPException&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;通知邮件发送失败, 五分钟后再试&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">pwd_input&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;输入密码替换为星号
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :return: 字符串形式密码
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">chars&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="kc">True&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">new_char&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">msvcrt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">getch&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">encoding&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;utf-8&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nb">input&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;你很可能不是在cmd命令行下运行，密码输入将不能隐藏:&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">new_char&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="se">\r\n&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="c1"># 如果是换行，则输入结束&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="n">new_char&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="se">\b&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="c1"># 如果是退格，则删除密码末尾一位并且删除一个星号&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">chars&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">del&lt;/span> &lt;span class="n">chars&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">msvcrt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">putch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="se">\b&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">encode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">encoding&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;utf-8&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="c1"># 光标回退一格&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">msvcrt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">putch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39; &amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">encode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">encoding&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;utf-8&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="c1"># 输出一个空格覆盖原来的星号&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">msvcrt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">putch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="se">\b&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">encode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">encoding&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;utf-8&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="c1"># 光标回退一格准备接受新的输入&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">chars&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">new_char&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">msvcrt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">putch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;*&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">encode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">encoding&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;utf-8&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="c1"># 显示为星号&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">chars&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">check_sms&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">host&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">user_id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">cookie&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">conn&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">http&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">HTTPConnection&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">host&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">headers&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;user-agent&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.102 Safari/537.36&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;accept&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;*/*&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;accept-encoding&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;gzip, deflate, sdch&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;accept-language&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;zh-CN,zh;q=0.8&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;cookie&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">cookie&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">conn&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;GET&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;/attachment/new_sms/&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">.sms?now=&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">user_id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">()),&lt;/span> &lt;span class="n">headers&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">headers&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span> &lt;span class="ne">ConnectionRefusedError&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;查询动作被服务器拒绝&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="s2">&amp;#34;0&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span> &lt;span class="ne">TimeoutError&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;服务器超时&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="s2">&amp;#34;0&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">res&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">conn&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">getresponse&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">data&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">res&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">data&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;gb2312&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">read_settings&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">mail&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ck&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">cf&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">cf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;main&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;send_to&amp;#34;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">mail&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send_to&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;main&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;send_to&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">mail&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send_to&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">input&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;请输入你的邮箱地址: &amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strip&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;main&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;send_to&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">mail&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send_to&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">cf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;main&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;host&amp;#34;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ck&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">url&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;main&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;host&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ck&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">url&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">input&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;请输入OA地址(不要带&amp;#34;http://:&amp;#34;): &amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strip&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;main&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;host&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ck&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">url&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">cf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;main&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;username&amp;#34;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ck&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">username&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;main&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;username&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ck&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">username&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">input&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;请输入OA用户名: &amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strip&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;main&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;username&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ck&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">username&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">cf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;main&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;password&amp;#34;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ck&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">password&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">base64&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">b64decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">bytes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;main&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;password&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s1">&amp;#39;utf8&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;utf8&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;请输入OA密码: &amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ck&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">password&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">pwd_input&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;main&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;password&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">base64&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">b64encode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">bytes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ck&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">password&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;utf8&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;utf8&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">conf_file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;w&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cf&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">configparser&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ConfigParser&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">conf_file&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">mail&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Mail&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ck&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Cookies&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">read_settings&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">mail&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ck&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">cf&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">mail&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">host&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ck&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">url&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ck&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1"># 获取登录信息&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">ck&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">status&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;302&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="c1"># 登录成功获得的正确响应&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;用户名或密码有误, 请重新输入&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 登录失败, 清空用户名/密码, 并要求充填&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;main&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;username&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cf&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;main&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;password&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">read_settings&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">mail&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ck&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">cf&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cookie&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;; &amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ck&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cookies&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># 拼接cookie&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;开始检测, 将此窗口最小化即可&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">check_sms&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ck&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">url&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ck&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">user_id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">cookie&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="s2">&amp;#34;0&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">mail&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">mail&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">is_send&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">False&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">5&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">60&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># sleep 5min&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span> &lt;span class="ne">KeyboardInterrupt&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;检测到按键中断, 程序将退出&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="vm">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;__main__&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">conf_file&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;oa_check.ini&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">conf_info&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;[main]
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">; OA网址, 注意不需要开头的http://哦
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">host = xxx.com
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">username =
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">password =
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">; 你要接收提醒的邮箱, 如qq邮箱 hello@qq.com
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">send_to =
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">exists&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">conf_file&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">conf_file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;w&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">fh&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">fh&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">conf_info&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> _______________
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;lt; OA消息提醒工具 &amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> ---------------
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> \ ^__^
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> \ (oo)\_______
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> (__)\ )\/&lt;/span>&lt;span class="se">\\&lt;/span>&lt;span class="s2">-
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> ||----w |
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> || ||&amp;#34;&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2"> by ferstar&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;设置好邮箱/用户名/密码后, 如果OA系统有新通知时&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;你设置的邮箱会收到一封来自xxx@126.com的邮件提醒&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">main&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>Python打包工具Pyinstaller使用记录</title><link>https://blog.ferstar.org/post/python%E6%89%93%E5%8C%85%E5%B7%A5%E5%85%B7pyinstaller%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/</link><guid isPermaLink="true">https://blog.ferstar.org/post/python%E6%89%93%E5%8C%85%E5%B7%A5%E5%85%B7pyinstaller%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/</guid><pubDate>Wed, 21 Dec 2016 16:23:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>有时候要把写的一些脚本分发给实验组的同学使用, 所以就需要将其打包成exe可执行文件，这个时候 Pyinstaller 就可以派上用场了(py2exe已死, 勿念)&lt;/p>
&lt;h2 id="1-安装anaconda3">1. 安装Anaconda3&lt;/h2>
&lt;p>感慨一下这玩意实在太好用了, 谁用谁知道, 各种依赖分分钟&lt;code>conda install xxx&lt;/code>搞定&lt;/p>
&lt;p>官网: &lt;a href="https://www.continuum.io/downloads">https://www.continuum.io/downloads&lt;/a>&lt;/p>
&lt;p>我用 Python 3 x64 位&lt;/p>
&lt;h2 id="2-创建虚拟环境">2. 创建虚拟环境&lt;/h2>
&lt;p>一路傻瓜next到底安装好Anaconda3后, 随便起一个cmd窗口, 比如我要建一个名为&lt;code>hello&lt;/code>的虚拟Python运行环境&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">E:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Users&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>&lt;span class="n">conda&lt;/span> &lt;span class="n">create&lt;/span> &lt;span class="n">-n&lt;/span> &lt;span class="n">hello&lt;/span> &lt;span class="n">python&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mf">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Fetching&lt;/span> &lt;span class="n">package&lt;/span> &lt;span class="n">metadata&lt;/span> &lt;span class="p">.........&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Solving&lt;/span> &lt;span class="n">package&lt;/span> &lt;span class="n">specifications&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="p">..........&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Package&lt;/span> &lt;span class="n">plan&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">installation&lt;/span> &lt;span class="k">in&lt;/span> &lt;span class="n">environment&lt;/span> &lt;span class="n">E:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Users&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">ferstar&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Anaconda3&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">envs&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">hel&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">lo&lt;/span>&lt;span class="err">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">The&lt;/span> &lt;span class="n">following&lt;/span> &lt;span class="n">NEW&lt;/span> &lt;span class="n">packages&lt;/span> &lt;span class="n">will&lt;/span> &lt;span class="n">be&lt;/span> &lt;span class="n">INSTALLED&lt;/span>&lt;span class="err">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pip&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="mf">9.0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mf">1&lt;/span>&lt;span class="n">-py35_1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">python&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="mf">3.5&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mf">2&lt;/span>&lt;span class="p">-&lt;/span>&lt;span class="mf">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">setuptools&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="mf">27.2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mf">0&lt;/span>&lt;span class="n">-py35_1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">vs2015_runtime&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="mf">14.0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mf">25123&lt;/span>&lt;span class="p">-&lt;/span>&lt;span class="mf">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">wheel&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="mf">0.29&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mf">0&lt;/span>&lt;span class="n">-py35_0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Proceed&lt;/span> &lt;span class="p">([&lt;/span>&lt;span class="no">y&lt;/span>&lt;span class="p">]/&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="p">)?&lt;/span> &lt;span class="n">y&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Linking&lt;/span> &lt;span class="n">packages&lt;/span> &lt;span class="p">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span> &lt;span class="n">COMPLETE&lt;/span> &lt;span class="p">]|&lt;/span>&lt;span class="c">##################################################| 100%&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># To activate this environment, use:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># &amp;gt; activate hello&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># To deactivate this environment, use:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># &amp;gt; deactivate hello&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># * for power-users using bash, you must source&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">#&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>对就这么简单, &lt;code>activate hello&lt;/code>即可切换到刚建立的&lt;code>hello&lt;/code>虚拟运行环境&lt;/p>
&lt;h2 id="3-下载upx">3. 下载upx&lt;/h2>
&lt;p>这货是给生成的&lt;code>exe&lt;/code>文件加壳的, 可以有效减小生成二进制文件的大小&lt;/p>
&lt;p>基友之家链接: &lt;a href="https://github.com/upx/upx">https://github.com/upx/upx&lt;/a>&lt;/p>
&lt;p>下完解压后把&lt;code>upx.exe&lt;/code>和&lt;code>upx.1&lt;/code>扔到你要打包的脚本比如&lt;code>hello.py&lt;/code>同目录下(pyinstaller默认会调用此程序进行加壳)&lt;/p>
&lt;h2 id="4-安装及使用">4. 安装及使用&lt;/h2>
&lt;p>切换到建好的&lt;code>hello&lt;/code>虚拟运行环境后, 安装&lt;code>pyinstaller&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="n">hello&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">E:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Users&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">hello&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>&lt;span class="n">pip&lt;/span> &lt;span class="n">install&lt;/span> &lt;span class="n">pyinstaller&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Collecting&lt;/span> &lt;span class="n">pyinstaller&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Requirement&lt;/span> &lt;span class="n">already&lt;/span> &lt;span class="n">satisfied&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="n">setuptools&lt;/span> &lt;span class="k">in&lt;/span> &lt;span class="n">e:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">users&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">ferstar&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">anaconda3&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">envs&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">hel&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">lo&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="nb">site-packages&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">setuptools&lt;/span>&lt;span class="p">-&lt;/span>&lt;span class="mf">27.2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mf">0&lt;/span>&lt;span class="n">-py3&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">5&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">egg&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">from&lt;/span> &lt;span class="n">pyinstaller&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Collecting&lt;/span> &lt;span class="n">pefile&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">from&lt;/span> &lt;span class="n">pyinstaller&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Collecting&lt;/span> &lt;span class="n">future&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">from&lt;/span> &lt;span class="n">pefile&lt;/span>&lt;span class="p">-&amp;gt;&lt;/span>&lt;span class="n">pyinstaller&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Installing&lt;/span> &lt;span class="n">collected&lt;/span> &lt;span class="n">packages&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="n">future&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pefile&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pyinstaller&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Successfully&lt;/span> &lt;span class="n">installed&lt;/span> &lt;span class="n">future&lt;/span>&lt;span class="p">-&lt;/span>&lt;span class="mf">0.16&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">0&lt;/span> &lt;span class="n">pefile&lt;/span>&lt;span class="p">-&lt;/span>&lt;span class="mf">2016.3&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">28&lt;/span> &lt;span class="n">pyinstaller&lt;/span>&lt;span class="p">-&lt;/span>&lt;span class="mf">3.2&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>举个栗子, 我们要封装的脚本叫&lt;code>hello.py&lt;/code>, 内容如下&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;hello world!&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">input&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;press enter to quit&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>装完先用一发&lt;code>pyinstaller -F -c hello.py&lt;/code>发现报错&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">Traceback&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">most&lt;/span> &lt;span class="n">recent&lt;/span> &lt;span class="n">call&lt;/span> &lt;span class="n">last&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">File&lt;/span> &lt;span class="s2">&amp;#34;e:\users\ferstar\anaconda3\envs\hello\lib\runpy.py&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">line&lt;/span> &lt;span class="mf">184&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">in&lt;/span> &lt;span class="n">_run_m&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">odule_as_main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;__main__&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">mod_spec&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">File&lt;/span> &lt;span class="s2">&amp;#34;e:\users\ferstar\anaconda3\envs\hello\lib\runpy.py&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">line&lt;/span> &lt;span class="mf">85&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">in&lt;/span> &lt;span class="n">_run_co&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">de&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">exec&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">code&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">run_globals&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">File&lt;/span> &lt;span class="s2">&amp;#34;E:\Users\ferstar\Anaconda3\envs\hello\Scripts\pyinstaller.exe\__main__.p
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">y&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">line&lt;/span> &lt;span class="mf">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">in&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="n">module&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">File&lt;/span> &lt;span class="s2">&amp;#34;e:\users\ferstar\anaconda3\envs\hello\lib\site-packages\PyInstaller\__ma
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">in__.py&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">line&lt;/span> &lt;span class="mf">21&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">in&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="n">module&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">import&lt;/span> &lt;span class="n">PyInstaller&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">building&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">build_main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">File&lt;/span> &lt;span class="s2">&amp;#34;e:\users\ferstar\anaconda3\envs\hello\lib\site-packages\PyInstaller\buil
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">ding\build_main.py&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">line&lt;/span> &lt;span class="mf">32&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">in&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="n">module&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">from&lt;/span> &lt;span class="p">..&lt;/span>&lt;span class="n">depend&lt;/span> &lt;span class="n">import&lt;/span> &lt;span class="n">bindepend&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">File&lt;/span> &lt;span class="s2">&amp;#34;e:\users\ferstar\anaconda3\envs\hello\lib\site-packages\PyInstaller\depe
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">nd\bindepend.py&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">line&lt;/span> &lt;span class="mf">38&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">in&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="n">module&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">from&lt;/span> &lt;span class="p">..&lt;/span>&lt;span class="n">utils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">win32&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">winmanifest&lt;/span> &lt;span class="n">import&lt;/span> &lt;span class="n">RT_MANIFEST&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">File&lt;/span> &lt;span class="s2">&amp;#34;e:\users\ferstar\anaconda3\envs\hello\lib\site-packages\PyInstaller\util
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">s\win32\winmanifest.py&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">line&lt;/span> &lt;span class="mf">97&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">in&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="n">module&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">from&lt;/span> &lt;span class="n">PyInstaller&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">utils&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">win32&lt;/span> &lt;span class="n">import&lt;/span> &lt;span class="n">winresource&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">File&lt;/span> &lt;span class="s2">&amp;#34;e:\users\ferstar\anaconda3\envs\hello\lib\site-packages\PyInstaller\util
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">s\win32\winresource.py&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">line&lt;/span> &lt;span class="mf">20&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">in&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="n">module&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">import&lt;/span> &lt;span class="n">pywintypes&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ImportError&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="n">No&lt;/span> &lt;span class="n">module&lt;/span> &lt;span class="n">named&lt;/span> &lt;span class="s1">&amp;#39;pywintypes&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>嗯, 大概是缺&lt;code>pywin32&lt;/code>这么个东西, Google 后找到替代品 &lt;code>pypiwin32&lt;/code>装之&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="n">hello&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">E:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Users&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">hello&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>&lt;span class="n">pip&lt;/span> &lt;span class="n">install&lt;/span> &lt;span class="n">pypiwin32&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Collecting&lt;/span> &lt;span class="n">pypiwin32&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Using&lt;/span> &lt;span class="n">cached&lt;/span> &lt;span class="n">pypiwin32&lt;/span>&lt;span class="p">-&lt;/span>&lt;span class="mf">219&lt;/span>&lt;span class="n">-cp35-none-win_amd64&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">whl&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Installing&lt;/span> &lt;span class="n">collected&lt;/span> &lt;span class="n">packages&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="n">pypiwin32&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Successfully&lt;/span> &lt;span class="n">installed&lt;/span> &lt;span class="n">pypiwin32&lt;/span>&lt;span class="p">-&lt;/span>&lt;span class="mf">219&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>再跑一发&lt;code>pyinstaller -F -c hello.py&lt;/code>成功, 打包好的&lt;code>exe&lt;/code>在当前目录下的&lt;code>dist&lt;/code>目录, 运行看一下效果&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="n">hello&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">E:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Users&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">hello&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>&lt;span class="n">dist&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">hello&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">hello&lt;/span> &lt;span class="n">world&lt;/span>&lt;span class="p">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">press&lt;/span> &lt;span class="n">enter&lt;/span> &lt;span class="n">to&lt;/span> &lt;span class="n">quit&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后发现生成的&lt;code>exe&lt;/code>默认图标很丑, 所以换一换, 只需要补上&lt;code>-i icon.ico&lt;/code>参数即可&lt;code>icon.ico&lt;/code>就是自定义的图标&lt;/p>
&lt;p>再然后听说你担心三脚猫代码被人看穿怎么办? 不用怕, 再补上&lt;code>--key xxx&lt;/code>参数即可&lt;code>xxx&lt;/code>可以换为任意字符&lt;/p>
&lt;p>其他更过参数欢迎使用&lt;code>pyinstaller -h&lt;/code>查询&lt;/p>
&lt;h2 id="5-部署">5. 部署&lt;/h2>
&lt;blockquote>
&lt;p>呃, 其实就是拉到小伙伴的电脑上跑一跑喽&lt;/p>
&lt;/blockquote>
&lt;p>发现报错:
&lt;em>无法定位程序输入点ucrtbase.terminate于动态链接库api-ms-win-crt-runtime-|1-1-0.dll&lt;/em>&lt;/p>
&lt;p>于是又Google之, 发现是微软常用运行库没有安装, 随便搜个合集安装包安装之, 基本都是 VC++ 那些组件&lt;/p>
&lt;p>装完后正常运行!&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>用Python将Excel转换为PDF</title><link>https://blog.ferstar.org/post/%E7%94%A8python%E5%B0%86excel%E8%BD%AC%E6%8D%A2%E4%B8%BApdf/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E7%94%A8python%E5%B0%86excel%E8%BD%AC%E6%8D%A2%E4%B8%BApdf/</guid><pubDate>Tue, 20 Dec 2016 17:01:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>有一堆Excel需要转成PDF, 所以启动 copy from stackoverflow 大法&lt;/p>
&lt;p>via &lt;a href="http://stackoverflow.com/questions/20854840/xlsx-and-xlslatest-versions-to-pdf-using-python">http://stackoverflow.com/questions/20854840/xlsx-and-xlslatest-versions-to-pdf-using-python&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">win32com&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">client&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">xlApp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Dispatch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Excel.Application&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">books&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">xlApp&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Workbooks&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;C:&lt;/span>&lt;span class="se">\\&lt;/span>&lt;span class="s1">excel&lt;/span>&lt;span class="se">\\&lt;/span>&lt;span class="s1">trial.xls&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ws&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">books&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Worksheets&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ws&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Visible&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ws&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ExportAsFixedFormat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;C:&lt;/span>&lt;span class="se">\\&lt;/span>&lt;span class="s1">excel&lt;/span>&lt;span class="se">\\&lt;/span>&lt;span class="s1">trial.pdf&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>把上段东东塞到一个函数里, 然后用&lt;code>os.walk&lt;/code>遍历&lt;code>*.xlsx&lt;/code>, 另外也可以加上&lt;code>multiprocessing.dummy&lt;/code>跑多线程装装逼, 哈哈&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/pdf/">PDF</category><category domain="https://blog.ferstar.org/tags/excel/">EXCEL</category></item><item><title>用 openpyxl 处理 xlsx 文件</title><link>https://blog.ferstar.org/post/%E7%94%A8-openpyxl-%E5%A4%84%E7%90%86-xlsx-%E6%96%87%E4%BB%B6/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E7%94%A8-openpyxl-%E5%A4%84%E7%90%86-xlsx-%E6%96%87%E4%BB%B6/</guid><pubDate>Tue, 20 Dec 2016 16:36:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>&lt;code>openpyxl&lt;/code> 是一个用来处理 excel 文件的 python 代码库, 安装什么略过不提, 只说一个简单操作的例子&lt;/p>
&lt;ol>
&lt;li>
&lt;p>例子&lt;/p>
&lt;p>有这么一个表&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>高压/低压(实验组)&lt;/th>
&lt;th>高压/低压(对照组)&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>156/99&lt;/td>
&lt;td>110/70&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>124/83&lt;/td>
&lt;td>119/71&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>103/78&lt;/td>
&lt;td>100/60&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>150/100&lt;/td>
&lt;td>114/78&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>150/100&lt;/td>
&lt;td>109/74&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>100/76&lt;/td>
&lt;td>112/65&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>130/90&lt;/td>
&lt;td>130/77&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>174/105&lt;/td>
&lt;td>121/72&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>109/85&lt;/td>
&lt;td>129/84&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>140/100&lt;/td>
&lt;td>128/80&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>120/80&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>122/73&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>120/70&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>107/80&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>110/70&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>115/73&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>110/61&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>127/80&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>110/70&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>108/79&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>114/78&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>118/71&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>需要把高压低压分开两列来整, 手动写要累死狗, 上万的数据, 于是祭出Python大法&lt;/p>
&lt;/li>
&lt;li>
&lt;p>烂码&lt;/p>
&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">re&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">openpyxl&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">file&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;工作簿2.xlsx&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">wb&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">openpyxl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">load_workbook&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ws&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">wb&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get_sheet_by_name&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Sheet1&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rows&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ws&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">max_row&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cols&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ws&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">max_column&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">p&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">re&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">compile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;[0-9]+/[0-9]+&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="n">row&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">rows&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">col&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">cols&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">v&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ws&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cell&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">column&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">col&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">re&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">p&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">v&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lst&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">v&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ws&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cell&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">column&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">col&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">cols&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">lst&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">i&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ws&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cell&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">column&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">col&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">cols&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">lst&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">i&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ws&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">wb&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get_sheet_by_name&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Sheet2&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="n">row&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">rows&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">col&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">cols&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">v&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ws&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cell&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">column&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">col&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">re&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">p&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">v&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lst&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">v&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ws&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cell&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">column&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">col&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">cols&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">lst&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">i&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ws&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cell&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">column&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">col&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">cols&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">lst&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="n">re&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">re&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">compile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;[0-9+/.+]&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">v&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">lst&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">v&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># print(lst)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ws&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cell&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">column&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">col&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">cols&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">lst&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">i&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ws&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cell&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">column&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">col&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">cols&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">lst&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="n">v&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;未记录&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ws&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cell&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">column&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">col&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">cols&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;未记录&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">i&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ws&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cell&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">column&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">col&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">cols&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;未记录&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">i&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">wb&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">save&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;test.xlsx&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>享受生活即可&lt;/p>
&lt;p>结果长这样&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>高压/低压(实验组)&lt;/th>
&lt;th>高压/低压(对照组)&lt;/th>
&lt;th>高压(实验)&lt;/th>
&lt;th>低压(实验)&lt;/th>
&lt;th>高压(对照)&lt;/th>
&lt;th>低压(对照)&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>156/99&lt;/td>
&lt;td>110/70&lt;/td>
&lt;td>156&lt;/td>
&lt;td>99&lt;/td>
&lt;td>110&lt;/td>
&lt;td>70&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>124/83&lt;/td>
&lt;td>119/71&lt;/td>
&lt;td>124&lt;/td>
&lt;td>83&lt;/td>
&lt;td>119&lt;/td>
&lt;td>71&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>103/78&lt;/td>
&lt;td>100/60&lt;/td>
&lt;td>103&lt;/td>
&lt;td>78&lt;/td>
&lt;td>100&lt;/td>
&lt;td>60&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>150/100&lt;/td>
&lt;td>114/78&lt;/td>
&lt;td>150&lt;/td>
&lt;td>100&lt;/td>
&lt;td>114&lt;/td>
&lt;td>78&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>150/100&lt;/td>
&lt;td>109/74&lt;/td>
&lt;td>150&lt;/td>
&lt;td>100&lt;/td>
&lt;td>109&lt;/td>
&lt;td>74&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>100/76&lt;/td>
&lt;td>112/65&lt;/td>
&lt;td>100&lt;/td>
&lt;td>76&lt;/td>
&lt;td>112&lt;/td>
&lt;td>65&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>130/90&lt;/td>
&lt;td>130/77&lt;/td>
&lt;td>130&lt;/td>
&lt;td>90&lt;/td>
&lt;td>130&lt;/td>
&lt;td>77&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>174/105&lt;/td>
&lt;td>121/72&lt;/td>
&lt;td>174&lt;/td>
&lt;td>105&lt;/td>
&lt;td>121&lt;/td>
&lt;td>72&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>109/85&lt;/td>
&lt;td>129/84&lt;/td>
&lt;td>109&lt;/td>
&lt;td>85&lt;/td>
&lt;td>129&lt;/td>
&lt;td>84&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>140/100&lt;/td>
&lt;td>128/80&lt;/td>
&lt;td>140&lt;/td>
&lt;td>100&lt;/td>
&lt;td>128&lt;/td>
&lt;td>80&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>120/80&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>120&lt;/td>
&lt;td>80&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>122/73&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>122&lt;/td>
&lt;td>73&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>120/70&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>120&lt;/td>
&lt;td>70&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>107/80&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>107&lt;/td>
&lt;td>80&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>110/70&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>110&lt;/td>
&lt;td>70&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>115/73&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>115&lt;/td>
&lt;td>73&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>110/61&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>110&lt;/td>
&lt;td>61&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>127/80&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>127&lt;/td>
&lt;td>80&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td>110/70&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>110&lt;/td>
&lt;td>70&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>利用python-docx更新word中的表格内容</title><link>https://blog.ferstar.org/post/%E5%88%A9%E7%94%A8python-docx%E6%9B%B4%E6%96%B0word%E4%B8%AD%E7%9A%84%E8%A1%A8%E6%A0%BC%E5%86%85%E5%AE%B9/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E5%88%A9%E7%94%A8python-docx%E6%9B%B4%E6%96%B0word%E4%B8%AD%E7%9A%84%E8%A1%A8%E6%A0%BC%E5%86%85%E5%AE%B9/</guid><pubDate>Tue, 06 Dec 2016 17:02:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>收到实验组小妹妹一个需求, 希望把一个巨大word文档中所有表格里的所有一位小数随机添加一位数变成两位小数, 从学术角度我开始是拒绝的, 但是, 妹子需求哪有不满足的道理, so...&lt;/p>
&lt;p>记录下我解决这个问题的流程:&lt;/p>
&lt;ol>
&lt;li>听取妹子需求, 然后大概评估这个活应该可以用&lt;code>Python&lt;/code>来做&lt;/li>
&lt;li>需求准确归纳: 给所有文档中表格内一位小数后加一位随机数使之变成两位小数&lt;/li>
&lt;li>商量一个deadline: 因为没做过, 不能打包票, 所以暂定第二天上班给结果&lt;/li>
&lt;li>拿到原始数据开始找轮子撸&lt;/li>
&lt;li>Google 找到 python-docx 这个 package 可以做这件事&lt;/li>
&lt;li>问题分解&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>解析 docx&lt;/li>
&lt;li>遍历所有表格
&lt;ul>
&lt;li>正则匹配一位小数&lt;/li>
&lt;li>生成随机小数补位&lt;/li>
&lt;li>保存&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;ol start="7">
&lt;li>交给妹子, 收获膝盖&lt;/li>
&lt;/ol>
&lt;h2 id="放码">放码&lt;/h2>
&lt;blockquote>
&lt;p>找到靠谱轮子就是爽, 几行代码解决战斗, 十分钟完成任务&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">random&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">re&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">docx&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">Document&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 源文件 test.docx&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">doc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Document&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;test.docx&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 正则匹配所有一位小数&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">p&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">re&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">compile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;^[0-9]+\.[0-9]&lt;/span>&lt;span class="si">{1}&lt;/span>&lt;span class="s2">$&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 遍历所有表格&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="n">table&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">doc&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">tables&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">row&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">table&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rows&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">cell&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">row&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cells&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">re&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">search&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">p&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">cell&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">text&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 匹配小数并在后面补齐一位小数&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cell&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">text&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">random&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">randint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">9&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">doc&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">save&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;test_update.docx&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/word/">WORD</category></item><item><title>Windows路由表配置_双网卡同时上公司内外网</title><link>https://blog.ferstar.org/post/windows%E8%B7%AF%E7%94%B1%E8%A1%A8%E9%85%8D%E7%BD%AE_%E5%8F%8C%E7%BD%91%E5%8D%A1%E5%90%8C%E6%97%B6%E4%B8%8A%E5%85%AC%E5%8F%B8%E5%86%85%E5%A4%96%E7%BD%91/</link><guid isPermaLink="true">https://blog.ferstar.org/post/windows%E8%B7%AF%E7%94%B1%E8%A1%A8%E9%85%8D%E7%BD%AE_%E5%8F%8C%E7%BD%91%E5%8D%A1%E5%90%8C%E6%97%B6%E4%B8%8A%E5%85%AC%E5%8F%B8%E5%86%85%E5%A4%96%E7%BD%91/</guid><pubDate>Mon, 21 Nov 2016 10:00:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;h2 id="网络环境">网络环境&lt;/h2>
&lt;blockquote>
&lt;p>有线: 能连公司内网, 不能连接Internet&lt;/p>
&lt;p>无线: 可以连Internet, 不能连公司内网, 默认网关为 192.168.10.1&lt;/p>
&lt;/blockquote>
&lt;h2 id="目的">目的&lt;/h2>
&lt;blockquote>
&lt;p>内网外网各走各道, 各找各妈&lt;/p>
&lt;/blockquote>
&lt;h2 id="配置">配置&lt;/h2>
&lt;pre tabindex="0">&lt;code>:删除默认设置
route delete 0.0.0.0
:外网路由，全走无线
route add 0.0.0.0 mask 0.0.0.0 192.168.0.1 if 13 -p
:公司内网集中在192.168.100.0/24 192.168.0.0/24网段，增两条路由
route add 192.168.100.0 mask 255.255.0.0 192.168.100.1 if 15 -p
route add 192.168.0.0 mask 255.255.0.0 192.168.100.1 if 15 -p
&lt;/code>&lt;/pre>&lt;h2 id="测试">测试&lt;/h2>
&lt;p>配置效果如下:&lt;/p>
&lt;p>&lt;code>route print 4&lt;/code>&lt;/p>
&lt;pre tabindex="0">&lt;code>永久路由:
网络地址 网络掩码 网关地址 跃点数
192.168.100.0 255.255.0.0 192.168.100.1 1
0.0.0.0 0.0.0.0 192.168.10.1 1
192.168.0.0 255.255.0.0 192.168.100.1 1
&lt;/code>&lt;/pre>&lt;p>ping之&lt;/p>
&lt;pre tabindex="0">&lt;code>C:\Users\ferstar&amp;gt;ping 192.168.10.12
正在 Ping 192.168.10.12 具有 32 字节的数据:
来自 192.168.10.12 的回复: 字节=32 时间=9ms TTL=128
来自 192.168.10.12 的回复: 字节=32 时间=5ms TTL=128
来自 192.168.10.12 的回复: 字节=32 时间=10ms TTL=128
来自 192.168.10.12 的回复: 字节=32 时间=3ms TTL=128
192.168.10.12 的 Ping 统计信息:
数据包: 已发送 = 4，已接收 = 4，丢失 = 0 (0% 丢失)，
往返行程的估计时间(以毫秒为单位):
最短 = 3ms，最长 = 10ms，平均 = 6ms
C:\Users\ferstar&amp;gt;ping 192.168.100.1
正在 Ping 192.168.100.1 具有 32 字节的数据:
来自 192.168.100.1 的回复: 字节=32 时间&amp;lt;1ms TTL=128
来自 192.168.100.1 的回复: 字节=32 时间&amp;lt;1ms TTL=128
来自 192.168.100.1 的回复: 字节=32 时间&amp;lt;1ms TTL=128
来自 192.168.100.1 的回复: 字节=32 时间&amp;lt;1ms TTL=128
192.168.100.1 的 Ping 统计信息:
数据包: 已发送 = 4，已接收 = 4，丢失 = 0 (0% 丢失)，
往返行程的估计时间(以毫秒为单位):
最短 = 0ms，最长 = 0ms，平均 = 0ms
C:\Users\ferstar&amp;gt;ping www.baidu.com
正在 Ping www.a.shifen.com [220.181.112.244] 具有 32 字节的数据:
来自 220.181.112.244 的回复: 字节=32 时间=33ms TTL=51
来自 220.181.112.244 的回复: 字节=32 时间=32ms TTL=51
来自 220.181.112.244 的回复: 字节=32 时间=29ms TTL=51
来自 220.181.112.244 的回复: 字节=32 时间=28ms TTL=51
220.181.112.244 的 Ping 统计信息:
数据包: 已发送 = 4，已接收 = 4，丢失 = 0 (0% 丢失)，
往返行程的估计时间(以毫秒为单位):
最短 = 28ms，最长 = 33ms，平均 = 30ms
&lt;/code>&lt;/pre>&lt;h2 id="bonus">bonus&lt;/h2>
&lt;pre tabindex="0">&lt;code>route print: 打印当前的路由表
route delete：删除一条路由
route add: 增加一条路由, 如果最后加上 –p 选项，表示永久增加静态路由，重启后不会失效
route change: 更改一条路由
&lt;/code>&lt;/pre>&lt;p>via &lt;a href="http://www.jianshu.com/p/711c14991a4f">http://www.jianshu.com/p/711c14991a4f&lt;/a>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>x220安装黑苹果记录</title><link>https://blog.ferstar.org/post/x220%E5%AE%89%E8%A3%85%E9%BB%91%E8%8B%B9%E6%9E%9C%E8%AE%B0%E5%BD%95/</link><guid isPermaLink="true">https://blog.ferstar.org/post/x220%E5%AE%89%E8%A3%85%E9%BB%91%E8%8B%B9%E6%9E%9C%E8%AE%B0%E5%BD%95/</guid><pubDate>Wed, 26 Oct 2016 16:50:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>via &lt;a href="http://x220.mcdonnelltech.com/">http://x220.mcdonnelltech.com/&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>主要步骤根据以上链接完成, 其中有些环节略有差异, 记录如下&lt;/p>
&lt;ol>
&lt;li>
&lt;p>BIOS设置中&lt;code>UEFI/Legacy Boot &lt;/code>不需要设置成&lt;code>Both&lt;/code>, 我设置&lt;code>UEFI Only&lt;/code>也可以, 没有问题&lt;/p>
&lt;/li>
&lt;li>
&lt;p>下载&lt;code>Install macOS Sierra app&lt;/code>要挑网友制作好带&lt;code>EFI&lt;/code>分区的&lt;/p>
&lt;/li>
&lt;li>
&lt;p>恢复镜像工具&lt;code>TransMac&lt;/code>最好不要用破解版, 使用官方最版, 反正可以试用&lt;/p>
&lt;/li>
&lt;li>
&lt;p>安装过程会重启两次, 每次都要借用制作好的安装U盘启动&lt;/p>
&lt;/li>
&lt;li>
&lt;p>安装完成后, 进BIOS会出现macOS的Boot Manager, 默认用这个没法启动的, 需要把macOS所在分区设为启动盘&lt;/p>
&lt;/li>
&lt;li>
&lt;p>x220自带无线网卡无解, 可以用随身WiFi替代&lt;/p>
&lt;/li>
&lt;li>
&lt;p>进入Mac系统安装系统升级包时先从网页下载最新版iTunes安装后再更新系统补丁, 否则会出现验证错误&lt;/p>
&lt;/li>
&lt;li>
&lt;p>当插入随身WiFi时系统无法正常睡眠, 拔掉后正常, 可休可唤醒&lt;/p>
&lt;/li>
&lt;li>
&lt;p>更新完系统补丁后, 静音/音量-/音量+三键功能正常&lt;/p>
&lt;/li>
&lt;li>
&lt;p>按键映射有点变化&lt;/p>
&lt;/li>
&lt;/ol>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>&lt;/th>
&lt;th style="text-align:center">Windows 10&lt;/th>
&lt;th style="text-align:center">macOS&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;em>PrtSc&lt;/em>&lt;/td>
&lt;td style="text-align:center">截屏&lt;/td>
&lt;td style="text-align:center">触摸板开关&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;em>ScrLk&lt;/em> / &lt;em>Pause&lt;/em>&lt;/td>
&lt;td style="text-align:center">&lt;/td>
&lt;td style="text-align:center">LCD亮度- / +&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;em>Insert&lt;/em>&lt;/td>
&lt;td style="text-align:center">&lt;/td>
&lt;td style="text-align:center">弹出光驱 / USB扩展坞&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;em>Windows&lt;/em>&lt;/td>
&lt;td style="text-align:center">&lt;/td>
&lt;td style="text-align:center">Option&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;em>Alt&lt;/em>&lt;/td>
&lt;td style="text-align:center">&lt;/td>
&lt;td style="text-align:center">Command&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;em>ThinkVantage&lt;/em>&lt;/td>
&lt;td style="text-align:center">没什么卵用&lt;/td>
&lt;td style="text-align:center">调节CPU风扇转速&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;ol start="11">
&lt;li>CapsLock键间歇性失灵&lt;/li>
&lt;li>静音键无作用&lt;/li>
&lt;/ol></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>x220改装后使用win10的问题</title><link>https://blog.ferstar.org/post/x220%E6%94%B9%E8%A3%85%E5%90%8E%E4%BD%BF%E7%94%A8win10%E7%9A%84%E9%97%AE%E9%A2%98/</link><guid isPermaLink="true">https://blog.ferstar.org/post/x220%E6%94%B9%E8%A3%85%E5%90%8E%E4%BD%BF%E7%94%A8win10%E7%9A%84%E9%97%AE%E9%A2%98/</guid><pubDate>Tue, 25 Oct 2016 10:05:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>前段时间给小黑刷了BIOS, 据说1847MHz频率的条子都可以支持, 所以就加了两根1600的上去, 16G内存虎虎生威, 又从某宝购入蓝牙模块, USB3.0不露头扩展卡, 算上原来就已经加装好的固态硬盘, 基本上算是武装到了牙齿&lt;/p>
&lt;p>然而升级win10 14951后发现机器无法正常睡眠, 直接睡死, 甚至连关机都不能, 以为是系统问题, 滚回原来14931问题依旧, 着实蛋疼, BIOS设置也重新恢复了一遍, 也不奏效, 崩溃之际发现N久前插进去的SD卡貌似在磁盘管理中看不到了, 拔出来重插格式化, 呃, 发现电脑居然神奇的正常了~&lt;/p>
&lt;p>真是坑爹~&lt;/p>
&lt;ul>
&lt;li>笔记本不能正常睡眠怎么办, 拔卡&lt;/li>
&lt;li>笔记本睡眠唤醒后USB3.0扩展卡失灵怎么办, 进BIOS把express card power management策略disable掉即可&lt;/li>
&lt;/ul></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>批量删除iOS短信记录</title><link>https://blog.ferstar.org/post/how-to-delete-all-old-messages-from-iphone-and-save-storage-space/</link><guid isPermaLink="true">https://blog.ferstar.org/post/how-to-delete-all-old-messages-from-iphone-and-save-storage-space/</guid><pubDate>Mon, 24 Oct 2016 16:47:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>手机用久了塞满各种垃圾短信, 想全部删除时发现坑爹的iOS只能一个一个点选, 蛋疼无比, 找半天只找到这么一个曲线救国的办法
via &lt;a href="http://www.macworld.co.uk/how-to/iphone/how-delete-all-old-messages-from-iphone-3644462/">http://www.macworld.co.uk/how-to/iphone/how-delete-all-old-messages-from-iphone-3644462/&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>设置 &amp;gt;&amp;gt; 信息 &amp;gt;&amp;gt; 保留信息 &amp;gt;&amp;gt; 30天
然后再手动删除30天以内的, 真是麻烦, 想来乔老爷子设计之初也没考虑到天朝垃圾短信如此泛滥吧~&lt;/p>
&lt;/blockquote></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>Directionality of DNA Strands</title><link>https://blog.ferstar.org/post/detour-directionality-of-dna-strands/</link><guid isPermaLink="true">https://blog.ferstar.org/post/detour-directionality-of-dna-strands/</guid><pubDate>Thu, 20 Oct 2016 09:58:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>The sugar component of a nucleotide has a ring of five carbon atoms, which are labeled as 1’, 2’, 3’, 4’, and 5’ in the figure on the right. The 5’ atom is joined onto the phosphate group in the nucleotide and eventually to the 3’ end of the neighboring nucleotide. The 3’ atom is joined onto another neighboring nucleotide in the nucleic acid chain. As a result, we call the two ends of the nucleotide the 5’-end and the 3’-end (pronounced “five prime end” and ”three prime end”, respectively).&lt;/p>
&lt;p>&lt;img src="~/09-59-50.jpg" alt="">&lt;/p>
&lt;p>When we zoom out to the level of the double helix, we can see in the figure below that any DNA fragment is oriented with a 3’ atom on one end and a 5’ atom on the other end. As a standard, a DNA strand is always read in the 5' → 3' direction. Note that the orientations run opposite to each other in complementary strands.&lt;/p>
&lt;p>&lt;img src="~/10-00-01.jpg" alt="">&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>更改iTunes Store国家或地区</title><link>https://blog.ferstar.org/post/%E6%9B%B4%E6%94%B9itunes-store%E5%9B%BD%E5%AE%B6%E6%88%96%E5%9C%B0%E5%8C%BA/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E6%9B%B4%E6%94%B9itunes-store%E5%9B%BD%E5%AE%B6%E6%88%96%E5%9C%B0%E5%8C%BA/</guid><pubDate>Wed, 19 Oct 2016 12:42:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>不小心点击了一个美区商店的app链接, 结果发现手机商店被跳转到美区转不回来&lt;/p>
&lt;p>以下是换回步骤&lt;/p>
&lt;p>点“设置”&amp;gt;“iTunes Store 与 App Store”&amp;gt; 点击Apple ID &amp;gt; 输入密码 &amp;gt; 提示你的账号仅限xxx地区使用 &amp;gt; 点击确认即可切回&lt;/p>
&lt;p>via &lt;a href="https://support.apple.com/zh-cn/HT201389">https://support.apple.com/zh-cn/HT201389&lt;/a>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>数字尾巴淘机记</title><link>https://blog.ferstar.org/post/%E6%95%B0%E5%AD%97%E5%B0%BE%E5%B7%B4%E6%B7%98%E6%9C%BA%E8%AE%B0/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E6%95%B0%E5%AD%97%E5%B0%BE%E5%B7%B4%E6%B7%98%E6%9C%BA%E8%AE%B0/</guid><pubDate>Wed, 19 Oct 2016 10:56:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>前段时间手机又摔了个角, 实在惨不忍睹, 急需换机, 放眼望去安卓一片巨屏手机实非我所愿, 只能选&lt;code>5se&lt;/code>, 秉承坚决不浪费的原则, 还是准备去数字尾巴淘个好成色的二手, 然而好成色又好价的机子总是被别人秒, 略蛋疼, 所以就整了这么个脚本, 刷到&lt;code>se&lt;/code>字样的卖机贴就给我发邮件提醒&lt;/p>
&lt;pre tabindex="0">&lt;code># !/usr/bin/python
# -*- coding: UTF-8 -*-
import re
import requests
import smtplib
from email.mime.text import MIMEText
def check():
url = &amp;#34;http://trade.dgtle.com/dgtle_module.php?mod=trade&amp;amp;typeid=109&amp;#34;
req = requests.get(url)
text = req.text
pattern = re.compile(&amp;#39;class=&amp;#34;tradetitle&amp;#34; title=&amp;#34;.*&amp;#34;&amp;#39;)
lst = [i.split(&amp;#34;title=&amp;#34;)[-1].strip(&amp;#39;&amp;#34;&amp;#39;).lower().split(&amp;#39;&amp;#34;&amp;#39;)[0] for i in re.findall(pattern, text)]
p = re.compile(&amp;#39;se|6s|6sp&amp;#39;)
for i in lst:
if re.search(p, i):
send_mail(i, url)
break
def send_mail(title, content):
mail_host = &amp;#34;smtp.163.com&amp;#34; # 设置服务器
mail_user = &amp;#34;&amp;#34; # 用户名
mail_pass = &amp;#34;&amp;#34; # 密码
sender = &amp;#39;fer_star@163.com&amp;#39;
receivers = [&amp;#39;fer_star@qq.com&amp;#39;] # 接收邮件，可设置为你的QQ邮箱或者其他邮箱
message = MIMEText(content, &amp;#39;plain&amp;#39;, &amp;#39;utf-8&amp;#39;)
message[&amp;#39;From&amp;#39;] = &amp;#34;{}&amp;#34;.format(sender)
message[&amp;#39;To&amp;#39;] = &amp;#34;,&amp;#34;.join(receivers)
message[&amp;#39;Subject&amp;#39;] = title
try:
smtpObj = smtplib.SMTP_SSL(mail_host, 465)
smtpObj.login(mail_user, mail_pass)
smtpObj.sendmail(sender, receivers, message.as_string())
print(&amp;#34;mail has been send successfully.&amp;#34;)
except smtplib.SMTPException as e:
print(e)
if __name__ == &amp;#34;__main__&amp;#34;:
check()
&lt;/code>&lt;/pre>&lt;p>效果如图(5se不好匹配, 就取了6s做关键字, 权当演示):&lt;/p>
&lt;p>&lt;img src="~/11-06-59.jpg" alt="">
比较悲剧的是秒到一个玫瑰金的5se, 咳咳, 不套全黑壳简直不敢掏出来~太娘了&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>Google Search Tips &amp; Tricks</title><link>https://blog.ferstar.org/post/google-search-tips-tricks/</link><guid isPermaLink="true">https://blog.ferstar.org/post/google-search-tips-tricks/</guid><pubDate>Mon, 17 Oct 2016 16:48:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>谷歌搜索的一些特殊技巧:
from &lt;a href="http://www.cte.hawaii.edu/Googly/aGoogleaday_TipsAndTricks.pdf">http://www.cte.hawaii.edu/Googly/aGoogleaday_TipsAndTricks.pdf&lt;/a>&lt;/p>
&lt;p>基本上常用的有:&lt;/p>
&lt;ol>
&lt;li>site:
&lt;code>hello site: www.baidu.com&lt;/code>&lt;/li>
&lt;li>filetype:
&lt;code>思想汇报 filetype: doc&lt;/code>&lt;/li>
&lt;li>双引号&lt;/li>
&lt;li>搜索工具(按语言/时间/结果排序) 如图:
&lt;img src="~/17-07-42.jpg" alt="">&lt;/li>
&lt;li>Google按图搜索(找源图必备)&lt;/li>
&lt;/ol></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>更改rocks cluster自带wordpress管理密码</title><link>https://blog.ferstar.org/post/%E6%9B%B4%E6%94%B9rocks-cluster%E8%87%AA%E5%B8%A6wp%E7%AE%A1%E7%90%86%E5%AF%86%E7%A0%81/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E6%9B%B4%E6%94%B9rocks-cluster%E8%87%AA%E5%B8%A6wp%E7%AE%A1%E7%90%86%E5%AF%86%E7%A0%81/</guid><pubDate>Wed, 28 Sep 2016 08:51:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>安装这个集群系统后默认是自带了这么个东西, 当然要利用起来, 然而发现貌似超管密码不知道, 查官方文档似乎有人问但鲜有人回答的. 所以只能自己撸了, 思路就是找个数据库管理软件连上集群自带MySQL数据库wordpress, 修改管理员admin的密码即可&lt;/p>
&lt;h3 id="1-找wordpress配置文件得到数据库配置参数">1. 找wordpress配置文件得到数据库配置参数&lt;/h3>
&lt;pre tabindex="0">&lt;code># 集群上这个文件的位置在/var/www/html/wordpress/wp-config.php
// ** MySQL settings - You can get this info from your web host ** //
/** The name of the database for WordPress */
define(&amp;#39;DB_NAME&amp;#39;, &amp;#39;wordpress&amp;#39;);
/** MySQL database username */
define(&amp;#39;DB_USER&amp;#39;, &amp;#39;wordpress&amp;#39;);
/** MySQL database password */
define(&amp;#39;DB_PASSWORD&amp;#39;,&amp;#39;QqgsNY9lJ4IvqN7n&amp;#39;);
/** MySQL hostname */
define(&amp;#39;DB_HOST&amp;#39;, &amp;#39;localhost:/var/opt/rocks/mysql/mysql.sock&amp;#39;);
/** Database Charset to use in creating database tables. */
define(&amp;#39;DB_CHARSET&amp;#39;, &amp;#39;utf8&amp;#39;);
/** The Database Collate type. Don&amp;#39;t change this if in doubt. */
define(&amp;#39;DB_COLLATE&amp;#39;, &amp;#39;&amp;#39;);
&lt;/code>&lt;/pre>&lt;h3 id="2-拿到数据库密码后-找个数据库管理软件">2. 拿到数据库密码后, 找个数据库管理软件&lt;/h3>
&lt;blockquote>
&lt;p>当然你要是用命令行撸那也是可以, 跪拜大神! 我等懒人还是用现成的工具比较合适
我用的软件叫&lt;code>Navicat Premium&lt;/code>, 用14天免费试用版即可
安装完成后新建一个MySQL连接, 因为集群MySQL默认禁止非本机访问, 所以用ssh隧道方式连接&lt;/p>
&lt;/blockquote>
&lt;pre tabindex="0">&lt;code>[常规]
连接名: cluster
主机名: localhost
端口: 40000
用户名: wordpress
密码: QqgsNY9lJ4IvqN7n
[SSH]
...
都是ssh的套路
...
&lt;/code>&lt;/pre>&lt;p>连接成功后数据库长这样&lt;/p>
&lt;p>&lt;img src="~/09-56-37.jpg" alt="">
在&lt;a href="http://pajhome.org.uk/crypt/md5/">http://pajhome.org.uk/crypt/md5/&lt;/a>这个网站转换一下你需要更改的密码, 将加密后的字符串填写到user_pass这一栏即可&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>对任意深度任意形式的list嵌套求平均</title><link>https://blog.ferstar.org/post/%E5%AF%B9%E4%BB%BB%E6%84%8F%E6%B7%B1%E5%BA%A6%E4%BB%BB%E6%84%8F%E5%BD%A2%E5%BC%8F%E7%9A%84list%E5%B5%8C%E5%A5%97%E6%B1%82%E5%B9%B3%E5%9D%87/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E5%AF%B9%E4%BB%BB%E6%84%8F%E6%B7%B1%E5%BA%A6%E4%BB%BB%E6%84%8F%E5%BD%A2%E5%BC%8F%E7%9A%84list%E5%B5%8C%E5%A5%97%E6%B1%82%E5%B9%B3%E5%9D%87/</guid><pubDate>Wed, 07 Sep 2016 14:30:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>&lt;a href="http://www.newsmth.net/nForum/#!article/Python/134174">水木论坛&lt;/a>看到的这个问题, 觉得有意思, 就写了下&lt;/p>
&lt;p>如&lt;code>L = [1, [2, [3, 4], 5], 6, [7, 8]]&lt;/code>这个 list
求平均值, 用到了递归&lt;/p>
&lt;pre tabindex="0">&lt;code>def get_avg(L):
count=0
def scantree(L):
nonlocal count
total = 0
for x in L:
if not isinstance(x, list):
total += x
count += 1
else:
total += scantree(x)
return total
return scantree(L) / count
L = [1, [2, [3, 4], 5], 6, [7, 8]]
print(get_avg(L))
&lt;/code>&lt;/pre>&lt;p>采用&lt;code>generator&lt;/code>重写一下上面的代码&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">collections&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">get_item&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">iterable&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">el&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">iterable&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">el&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="nb">isinstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">el&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">collections&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Iterable&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">yield from&lt;/span> &lt;span class="n">list_exp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">el&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">yield&lt;/span> &lt;span class="n">el&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>测试&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">L&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">6&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">7&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">]]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">sum&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">get_item&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">L&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">count&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">sum&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">i&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">sum&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 4.5&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>安全升级CentOS自带系统组件coreutils的方法</title><link>https://blog.ferstar.org/post/%E5%AE%89%E5%85%A8%E5%8D%87%E7%BA%A7centos%E8%87%AA%E5%B8%A6%E7%B3%BB%E7%BB%9F%E7%BB%84%E4%BB%B6coreutils%E7%9A%84%E6%96%B9%E6%B3%95/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E5%AE%89%E5%85%A8%E5%8D%87%E7%BA%A7centos%E8%87%AA%E5%B8%A6%E7%B3%BB%E7%BB%9F%E7%BB%84%E4%BB%B6coreutils%E7%9A%84%E6%96%B9%E6%B3%95/</guid><pubDate>Sun, 04 Sep 2016 15:28:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>集群系统版本比较低, CentOS 6.6, 自带的一些比如&lt;code>sort&lt;/code>命令, 不支持&lt;code>parallel&lt;/code>参数, 所以需要小升级一下&lt;/p>
&lt;pre tabindex="0">&lt;code>#!/bin/sh
wget http://ftp.gnu.org/gnu/coreutils/coreutils-8.25.tar.xz
tar xfv coreutils-8.25.tar.xz
cd coreutils-8.25
FORCE_UNSAFE_CONFIGURE=1 ./configure \
--prefix=/usr \
--libexecdir=/usr/lib \
--enable-no-install-program=kill,uptime
make -j48
make install
yes | mv -v /usr/bin/{cat,chgrp,chmod,chown,cp,date,dd,df,echo,head,sleep,nice,false,ln,ls,mkdir,mknod,mv,pwd,rm,rmdir,stty,sync,true,uname,test,[} /bin
yes | mv -v /usr/bin/chroot /usr/sbin
yes | mv -v /usr/share/man/man1/chroot.1 /usr/share/man/man8/chroot.8
sed -i s/\&amp;#34;1\&amp;#34;/\&amp;#34;8\&amp;#34;/1 /usr/share/man/man8/chroot.8
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>Python控制windows10自动关机</title><link>https://blog.ferstar.org/post/python%E6%8E%A7%E5%88%B6windows10%E8%87%AA%E5%8A%A8%E5%85%B3%E6%9C%BA/</link><guid isPermaLink="true">https://blog.ferstar.org/post/python%E6%8E%A7%E5%88%B6windows10%E8%87%AA%E5%8A%A8%E5%85%B3%E6%9C%BA/</guid><pubDate>Thu, 01 Sep 2016 08:51:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>看到&lt;code>segmentfault&lt;/code>的这个问题, 就花了点时间解决了下, 感叹&lt;code>python&lt;/code>的轮子真多, 真好用
via &lt;a href="https://segmentfault.com/q/1010000006782616">https://segmentfault.com/q/1010000006782616&lt;/a>
以下是我的答案:&lt;/p>
&lt;pre tabindex="0">&lt;code># coding=utf8
import os
import threading
import time
import pyHook # 在http://www.lfd.uci.edu/~gohlke/pythonlibs/#pyhook这里下载, 用pip安装
import pythoncom # 在https://sourceforge.net/projects/pywin32/files/pywin32/Build%20220/这里下载安装
last_time = time.time()
flag = False
def shut_down():
while 1:
time.sleep(1)
new_time = time.time()
# print(&amp;#34;new time: {}&amp;#34;.format(new_time))
if new_time - last_time &amp;gt; 1800: # 30分钟无按键响应就关机
os.system(&amp;#34;shutdown /s /t 1&amp;#34;) # 1秒后关机
def OnMouseEvent(event):
global last_time
last_time = time.time()
# print(&amp;#34;old time: {}&amp;#34;.format(last_time))
return True
def OnKeyboardEvent(event):
global last_time, flag
if not flag and str(event.Key) == &amp;#39;Space&amp;#39;: # 按下空格键启动子线程计时
t = threading.Thread(target=shut_down)
t.setDaemon(True) # 设定主线程结束时自动杀掉子线程
t.start()
flag = True
last_time = time.time()
# print(&amp;#34;old time: {}&amp;#34;.format(last_time))
if str(event.Key) == &amp;#39;Escape&amp;#39;: # 按下ESC退出程序
exit()
# print(event.Key)
return True
def main():
# create the hook mananger
hm = pyHook.HookManager()
# register two callbacks
hm.MouseAllButtonsDown = OnMouseEvent
hm.KeyDown = OnKeyboardEvent
# hook into the mouse and keyboard events
hm.HookMouse()
hm.HookKeyboard()
pythoncom.PumpMessages()
if __name__ == &amp;#34;__main__&amp;#34;:
main()
&lt;/code>&lt;/pre>&lt;p>64位windows10, python2.7.11测试通过, 料想python3应该也ok
本来打算定时任务做主线程, 子线程监听鼠标键盘事件, 结果发现这个&lt;code>pyHook&lt;/code>监听时就阻塞了, 主线程根本起不来, 所以换成主线程监听鼠标事件, 子线程做定时关机逻辑&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>grub引导修复</title><link>https://blog.ferstar.org/post/grub%E5%BC%95%E5%AF%BC%E4%BF%AE%E5%A4%8D/</link><guid isPermaLink="true">https://blog.ferstar.org/post/grub%E5%BC%95%E5%AF%BC%E4%BF%AE%E5%A4%8D/</guid><pubDate>Wed, 31 Aug 2016 10:24:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>很久很久前写的一个折腾记录, 现在启动都差不多是&lt;code>GPT+UEFI&lt;/code>的模式了, 以下纯做纪念&lt;/p>
&lt;/blockquote>
&lt;p>安装完 ubuntu 之后，若再安装 windows xp 作业系统到其它的 partition 就会破坏掉原本 MBR 中的 GRUB，导致从此以后只能开机进 XP，没办法再多重开机了。其实那只是 MBR 中的 GRUB 启动区被 windows xp 安装程式给盖掉了，整个完整的 GRUB 并没有消失，拿出 ubuntu 光碟即可救回来。&lt;/p>
&lt;ol>
&lt;li>用 ubuntu 光碟开机后，执行 sudo grub&lt;/li>
&lt;li>输入 find /boot/grub/stage1 指令找出当初存放 /boot/grub/stage1 的地方在什么 partition，有时候可能会找不到，如果有印象当初安装时这个 /boot/grub/ 的目录摆在什么地方的话，那也没有关系。&lt;/li>
&lt;li>输入 root (hd0,0) 指令，表示当初 /boot/grub/ 的目录摆在 /dev/hda1&lt;/li>
&lt;li>输入 setup (hd0) 指令，表示将 GRUB 的启动器重新写到 /dev/hda 磁碟的 MBR 上。&lt;/li>
&lt;li>输入 quit 指令可以离开 grub 的设定程式，重新开机后即可看到 GRUB 原来的多重开机选单。
用LIVECD进入系统&lt;/li>
&lt;/ol>
&lt;p>打开终端,输入&lt;/p>
&lt;p>sudo grub
grub&amp;gt; root (hd0,*)
grub&amp;gt; setup (hd0)&lt;/p>
&lt;ul>
&lt;li>为你已经安装ubuntu系统的根所在区&lt;/li>
&lt;/ul>
&lt;p>如果您不确定 * ，您可以打开 gpart 分区编辑器软件查看&lt;/p>
&lt;p>系统 System -&amp;gt; 系统管理 Administrator -&amp;gt; gpart&lt;/p>
&lt;p>记下 /dev/sda*&lt;/p>
&lt;p>因为 grub 中 0 表示第一个区， 1 表示第二个区，所以把 * - 1 差就是真正的 *&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>NGS解放生产力工具--Miniconda&amp;Bioconda</title><link>https://blog.ferstar.org/post/ngs%E8%A7%A3%E6%94%BE%E7%94%9F%E4%BA%A7%E5%8A%9B%E5%B7%A5%E5%85%B7--minicondabioconda/</link><guid isPermaLink="true">https://blog.ferstar.org/post/ngs%E8%A7%A3%E6%94%BE%E7%94%9F%E4%BA%A7%E5%8A%9B%E5%B7%A5%E5%85%B7--minicondabioconda/</guid><pubDate>Wed, 31 Aug 2016 09:37:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>状态不甚了了的情行下多逛&lt;code>github&lt;/code>似乎更容易转角遇到&amp;quot;神器&amp;quot;--Miniconda&lt;/p>
&lt;p>via &lt;a href="http://conda.pydata.org/miniconda.html">http://conda.pydata.org/miniconda.html&lt;/a>&lt;/p>
&lt;p>按照manual安装很轻松&lt;/p>
&lt;p>安装完成后, 再看这个神器: bioconda&lt;/p>
&lt;p>via &lt;a href="https://bioconda.github.io/index.html">https://bioconda.github.io/index.html&lt;/a>&lt;/p>
&lt;p>几条简单的命令, 照做, 于是, 发现曾经被坑爹的各种源码编译包折腾半死的软件都可以像这样一键安装搞定:&lt;/p>
&lt;pre tabindex="0">&lt;code>conda install abyss
&lt;/code>&lt;/pre>&lt;p>是的没错, 就这么一句, 依赖, 编译全搞定, 以下为输出&lt;/p>
&lt;pre tabindex="0">&lt;code>Using Anaconda Cloud api site https://api.anaconda.org
Fetching package metadata ...........
Solving package specifications: ..........
Package plan for installation in environment /prodata/miniconda2/envs/qiime:
The following packages will be downloaded:
package | build
---------------------------|-----------------
abyss-1.9.0 | boost1.60_1 21.3 MB bioconda
The following NEW packages will be INSTALLED:
abyss: 1.9.0-boost1.60_1 bioconda
Proceed ([y]/n)? y
Fetching packages ...
abyss-1.9.0-bo 100% |########################################| Time: 0:01:19 281.70 kB/s
Extracting packages ...
[ COMPLETE ]|###########################################################| 100%
Linking packages ...
[ COMPLETE ]|###########################################################| 100
&lt;/code>&lt;/pre>&lt;p>如果创建&lt;code>myenv&lt;/code>环境时指定的是&lt;code>none-root&lt;/code>路径, 基本上就完全独立于&lt;code>host&lt;/code>系统, 而且无需&lt;code>root&lt;/code>权限(这个特性简直天然为cluster而生), 配置好&lt;code>env&lt;/code>以后完全开箱即用, 缺啥&lt;code>conda install xxx&lt;/code>, 自动解决依赖, 热泪盈眶......&lt;/p>
&lt;p>于是曾经被认为超级难装的&lt;code>Qiime&lt;/code>, &lt;code>SURPI&lt;/code>等只需要对着依赖表敲&lt;code>conda install xxx&lt;/code>即可&lt;/p>
&lt;p>呃, 脱坑的感觉真好!&lt;/p>
&lt;p>&lt;code>source activate qiime&lt;/code>&lt;/p>
&lt;p>conda大法好!&lt;/p>
&lt;h2 id="注意">注意&lt;/h2>
&lt;p>因为墙的存在, 访问 Anaconda 下载 packages 速度很慢, 所幸有清华大学做了镜像&lt;/p>
&lt;p>使用方法很简单, 两句话&lt;/p>
&lt;pre tabindex="0">&lt;code>conda config --add channels &amp;#39;https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/&amp;#39;
conda config --set show_channel_urls yes
&lt;/code>&lt;/pre>&lt;blockquote>
&lt;p>如果是 Windows 系统, 需要把第一行的 url 两边单引号去掉&lt;/p>
&lt;/blockquote>
&lt;p>Anaconda 安装包可以到 &lt;a href="https://mirrors.tuna.tsinghua.edu.cn/anaconda/archive/">https://mirrors.tuna.tsinghua.edu.cn/anaconda/archive/&lt;/a>下载&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>两文本取交集</title><link>https://blog.ferstar.org/post/%E4%B8%A4%E6%96%87%E6%9C%AC%E5%8F%96%E4%BA%A4%E9%9B%86/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E4%B8%A4%E6%96%87%E6%9C%AC%E5%8F%96%E4%BA%A4%E9%9B%86/</guid><pubDate>Tue, 23 Aug 2016 18:37:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>近期又接触到pandas, 简直相见恨晚&lt;/p>
&lt;pre tabindex="0">&lt;code>import pandas as pd
df1 = pd.read_excel(&amp;#34;aa.xlsx&amp;#34;)
df2 = pd.read_excel(&amp;#34;bb.xlsx&amp;#34;)
up1 = df1.loc[df1[&amp;#39;regulated&amp;#39;] == &amp;#34;up&amp;#34;] # 筛选出regulated列为up的行
up1.dropna(subset=[&amp;#39;gene&amp;#39;], inplace=True) # 删除gene为空的行
up2 = df2.loc[df2[&amp;#39;regulated&amp;#39;] == &amp;#34;up&amp;#34;]
up2.dropna(subset=[&amp;#39;gene&amp;#39;], inplace=True)
down1 = df1.loc[df1[&amp;#39;regulated&amp;#39;] == &amp;#34;down&amp;#34;]
down1.dropna(subset=[&amp;#39;gene&amp;#39;], inplace=True)
down2 = df2.loc[df2[&amp;#39;regulated&amp;#39;] == &amp;#34;down&amp;#34;]
down2.dropna(subset=[&amp;#39;gene&amp;#39;], inplace=True)
up12 = up1.loc[up1[&amp;#39;gene&amp;#39;].isin(up2[&amp;#39;gene&amp;#39;])].drop_duplicates([&amp;#39;gene&amp;#39;]).sort_values(by=&amp;#39;gene&amp;#39;) # 去重排序
up12.to_excel(&amp;#34;upa.xlsx&amp;#34;, index=False)
up21 = up2.loc[up2[&amp;#39;gene&amp;#39;].isin(up1[&amp;#39;gene&amp;#39;])].drop_duplicates([&amp;#39;gene&amp;#39;]).sort_values(by=&amp;#39;gene&amp;#39;)
up21.to_excel(&amp;#34;upb.xlsx&amp;#34;, index=False)
down12 = down1.loc[down1[&amp;#39;gene&amp;#39;].isin(down2[&amp;#39;gene&amp;#39;])].drop_duplicates([&amp;#39;gene&amp;#39;]).sort_values(by=&amp;#39;gene&amp;#39;)
down12.to_excel(&amp;#34;downa.xlsx&amp;#34;, index=False)
down21 = down2.loc[down2[&amp;#39;gene&amp;#39;].isin(down1[&amp;#39;gene&amp;#39;])].drop_duplicates([&amp;#39;gene&amp;#39;]).sort_values(by=&amp;#39;gene&amp;#39;)
down21.to_excel(&amp;#34;downb.xlsx&amp;#34;, index=False)
&lt;/code>&lt;/pre>&lt;p>简直神器~&lt;/p>
&lt;hr>
&lt;p>额, python做这个真心效果大赞!
aa.txt 和 bb.txt 中间有一列内容有交集, 需要把这个交集和差集提出来&lt;/p>
&lt;pre tabindex="0">&lt;code>with open(&amp;#34;aa.txt&amp;#34;) as f1, open(&amp;#34;bb.txt&amp;#34;) as f2:
a_dict = {}
for line in f1.readlines():
_lst = line.strip().split(&amp;#34;@&amp;#34;)
if _lst[1] and _lst[1] != &amp;#34;gene&amp;#34;:
a_dict[_lst[1]] = line
b_dict = {}
for line in f2.readlines():
_lst = line.strip().split(&amp;#34;@&amp;#34;)
if _lst[1] and _lst[1] != &amp;#34;gene&amp;#34;:
b_dict[_lst[1]] = line
new_dict = dict((i, a_dict[i]) for i in a_dict if i in b_dict)
with open(&amp;#34;12.csv&amp;#34;, &amp;#34;w&amp;#34;) as fh:
fh.write(
&amp;#34;\tgene\t#ID\tT01_Count\tT02_Count\tT01_FPKM\tT02_FPKM\tFDR\tlog2FC\tregulated\tCOG_class\tCOG_class_annotation\tGO_annotation\tKEGG_annotation\tSwissprot_annotation\tnr_annotation\n&amp;#34;)
for key in new_dict:
fh.write(new_dict[key].replace(&amp;#34;@&amp;#34;, &amp;#34;\t&amp;#34;))
new_dict = dict((i, a_dict[i]) for i in a_dict if i not in b_dict)
with open(&amp;#34;12_diff.csv&amp;#34;, &amp;#34;w&amp;#34;) as fh:
fh.write(
&amp;#34;\tgene\t#ID\tT01_Count\tT02_Count\tT01_FPKM\tT02_FPKM\tFDR\tlog2FC\tregulated\tCOG_class\tCOG_class_annotation\tGO_annotation\tKEGG_annotation\tSwissprot_annotation\tnr_annotation\n&amp;#34;)
for key in new_dict:
fh.write(new_dict[key].replace(&amp;#34;@&amp;#34;, &amp;#34;\t&amp;#34;))
new_dict = dict((i, b_dict[i]) for i in a_dict if i in b_dict)
with open(&amp;#34;13.csv&amp;#34;, &amp;#34;w&amp;#34;) as fh:
fh.write(
&amp;#34;\tgene\t#ID\tT01_Count\tT03_Count\tT01_FPKM\tT03_FPKM\tFDR\tlog2FC\tregulated\tCOG_class\tCOG_class_annotation\tGO_annotation\tKEGG_annotation\tSwissprot_annotation\tnr_annotation\n&amp;#34;)
for key in new_dict:
fh.write(new_dict[key].replace(&amp;#34;@&amp;#34;, &amp;#34;\t&amp;#34;))
new_dict = dict((i, b_dict[i]) for i in b_dict if i not in a_dict)
with open(&amp;#34;13_diff.csv&amp;#34;, &amp;#34;w&amp;#34;) as fh:
fh.write(
&amp;#34;\tgene\t#ID\tT01_Count\tT03_Count\tT01_FPKM\tT03_FPKM\tFDR\tlog2FC\tregulated\tCOG_class\tCOG_class_annotation\tGO_annotation\tKEGG_annotation\tSwissprot_annotation\tnr_annotation\n&amp;#34;)
for key in new_dict:
fh.write(new_dict[key].replace(&amp;#34;@&amp;#34;, &amp;#34;\t&amp;#34;))
&lt;/code>&lt;/pre>&lt;p>基本上就是先解析到需要比较的这一列, 已此列值为key, 每整行为value, 所以这两个文件可以分别建两个字典, 然后取字典key的交集, 输出value写入结果文件~&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>Installation of Bash on Windows is just a few clicks</title><link>https://blog.ferstar.org/post/installation-of-bash-on-windows-is-just-a-few-clicks/</link><guid isPermaLink="true">https://blog.ferstar.org/post/installation-of-bash-on-windows-is-just-a-few-clicks/</guid><pubDate>Fri, 19 Aug 2016 10:11:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>N久之前就用过一次Windows10的bash, 不过效果惨不忍睹, bug百出, 遂放弃. 然而最近手痒, 想看看这货有啥进展.
这是安装教程
msdn blog via &lt;a href="https://msdn.microsoft.com/commandline/wsl/install_guide">https://msdn.microsoft.com/commandline/wsl/install_guide&lt;/a>
坑爹, 非得是逼着开发者给他当系统测试小白鼠才给装&lt;/p>
&lt;pre tabindex="0">&lt;code>Windows PowerShell
版权所有 (C) 2016 Microsoft Corporation。保留所有权利。
PS C:\WINDOWS\system32&amp;gt; Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-Subsystem-Linux
Path :
Online : True
RestartNeeded : False
PS C:\WINDOWS\system32&amp;gt; bash
-- Beta 版功能 --
这将在 Windows 上安装由 Canonical 分发的 Ubuntu，
根据其条款的授权参见此链接:
https://aka.ms/uowterms
键入“y”继续: y
正在从 Windows 应用商店下载... 26%
&lt;/code>&lt;/pre>&lt;p>这个速度, 巨硬商店下载速度还是很不给力的说~&lt;/p>
&lt;h2 id="卸载保平安">卸载保平安&lt;/h2>
&lt;pre tabindex="0">&lt;code>PS C:\WINDOWS\system32&amp;gt; lxrun /uninstall /full
这将在 Windows 中卸载 Ubuntu。
这将删除 Ubuntu 环境以及任何修改、新应用程序和用户数据。
键入“y”继续: y
正在卸载...
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>segmentfault答题之-字典生成的一个问题</title><link>https://blog.ferstar.org/post/segmentfault%E7%AD%94%E9%A2%98%E4%B9%8B-%E5%AD%97%E5%85%B8%E7%94%9F%E6%88%90%E7%9A%84%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98/</link><guid isPermaLink="true">https://blog.ferstar.org/post/segmentfault%E7%AD%94%E9%A2%98%E4%B9%8B-%E5%AD%97%E5%85%B8%E7%94%9F%E6%88%90%E7%9A%84%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98/</guid><pubDate>Fri, 19 Aug 2016 10:00:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>via &lt;a href="https://segmentfault.com/q/1010000006624056/a-1020000006628560">https://segmentfault.com/q/1010000006624056/a-1020000006628560&lt;/a>&lt;/p>
&lt;p>一个函数, 作用是按区切割列表&lt;/p>
&lt;pre tabindex="0">&lt;code>def generate_index(n, step=1):
for i in range(0, n, step):
yield (i, i + step) if i + step &amp;lt; n else (i, None)
&lt;/code>&lt;/pre>&lt;p>简单使用
&lt;code>list(generate_index(20, 5))&lt;/code>&lt;/p>
&lt;pre tabindex="0">&lt;code>[(0, 5), (5, 10), (10, 15), (15, None)]
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>Shell变量的定义、删除变量、只读变量、变量类型</title><link>https://blog.ferstar.org/post/shell%E5%8F%98%E9%87%8F%E7%9A%84%E5%AE%9A%E4%B9%89%E5%88%A0%E9%99%A4%E5%8F%98%E9%87%8F%E5%8F%AA%E8%AF%BB%E5%8F%98%E9%87%8F%E5%8F%98%E9%87%8F%E7%B1%BB%E5%9E%8B/</link><guid isPermaLink="true">https://blog.ferstar.org/post/shell%E5%8F%98%E9%87%8F%E7%9A%84%E5%AE%9A%E4%B9%89%E5%88%A0%E9%99%A4%E5%8F%98%E9%87%8F%E5%8F%AA%E8%AF%BB%E5%8F%98%E9%87%8F%E5%8F%98%E9%87%8F%E7%B1%BB%E5%9E%8B/</guid><pubDate>Fri, 12 Aug 2016 09:08:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>via &lt;a href="http://c.biancheng.net/cpp/view/6999.html">http://c.biancheng.net/cpp/view/6999.html&lt;/a>&lt;/p>
&lt;p>其中使用一个定义过的变量有两种方法:&lt;/p>
&lt;pre tabindex="0">&lt;code>your_name=&amp;#34;mozhiyan&amp;#34;
echo $your_name
echo ${your_name}
&lt;/code>&lt;/pre>&lt;p>变量名外的花括号可选, 花括号的作用是帮助解释器识别变量的边界, 比如下面这种情况&lt;/p>
&lt;pre tabindex="0">&lt;code>for skill in Ada Coffe Action Java
do
echo &amp;#34;I am good at ${skill}Script&amp;#34;
done
&lt;/code>&lt;/pre>&lt;p>如果不给skill变量加花括号，写成&lt;code>echo &amp;quot;I am good at $skillScript&amp;quot;&lt;/code>，解释器就会把&lt;code>$skillScript&lt;/code>当成一个变量（其值为空），代码执行结果就不是我们期望的样子了。
嗯, 这个坑我也是踩中才觉得蛋疼, 所以有必要记录下
&lt;strong>一定要给所有变量加上花括号，这是个好的编程习惯&lt;/strong>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>产生任意长度随机字符串</title><link>https://blog.ferstar.org/post/%E4%BA%A7%E7%94%9F%E4%BB%BB%E6%84%8F%E9%95%BF%E5%BA%A6%E9%9A%8F%E6%9C%BA%E5%AD%97%E7%AC%A6%E4%B8%B2/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E4%BA%A7%E7%94%9F%E4%BB%BB%E6%84%8F%E9%95%BF%E5%BA%A6%E9%9A%8F%E6%9C%BA%E5%AD%97%E7%AC%A6%E4%B8%B2/</guid><pubDate>Thu, 11 Aug 2016 09:04:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>从&lt;code>stackoverflow&lt;/code>扒的, 比较常用的一个功能&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">random&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">id_generator&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">8&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">chars&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">string&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ascii_letters&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">string&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">digits&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">random&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">choice&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">chars&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">_&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">id_generator&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>群晖NAS折腾杂记</title><link>https://blog.ferstar.org/post/%E7%BE%A4%E6%99%96nas%E6%8A%98%E8%85%BE%E6%9D%82%E8%AE%B0/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E7%BE%A4%E6%99%96nas%E6%8A%98%E8%85%BE%E6%9D%82%E8%AE%B0/</guid><pubDate>Thu, 04 Aug 2016 14:49:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;ol>
&lt;li>捅菊花可以重置&lt;code>admin&lt;/code>管理密码为空, 数据不受影响, 这个赞
&lt;ul>
&lt;li>当然怕熊孩子乱捅的话, 这个功能是可以关闭的, 在哪呢? 不可说~&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>搭配新的&lt;code>Btrfs&lt;/code>文件系统可以做到秒级&lt;code>snapshot&lt;/code>, 数据无忧&lt;/li>
&lt;li>&lt;code>Cloud Sync&lt;/code>支持在线存储提供商丰富&lt;/li>
&lt;li>&lt;code>QuickConnecter&lt;/code>配置简单&lt;/li>
&lt;li>丰富的扩展组件资源, 比如&lt;code>Git&lt;/code>等&lt;/li>
&lt;/ol></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>比较两台centos已安装程序的异同</title><link>https://blog.ferstar.org/post/%E6%AF%94%E8%BE%83%E4%B8%A4%E5%8F%B0centos%E5%B7%B2%E5%AE%89%E8%A3%85%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%BC%82%E5%90%8C/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E6%AF%94%E8%BE%83%E4%B8%A4%E5%8F%B0centos%E5%B7%B2%E5%AE%89%E8%A3%85%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%BC%82%E5%90%8C/</guid><pubDate>Wed, 03 Aug 2016 15:56:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>嗯, 一台计算节点硬件故障终于修好, 是时候把这货加入集群了, 然而比较悲催的是集群已经运行很久, 上面新安装了啥软件包我自己也记不清, 所以就需要挑一个正常运行的节点把上面已安装的程序找出来, 然后把新加入的节点默认安装的软件也列出来, 最后两者取差集即可得到需要在新节点上额外安装的程序列表, 机智如我...&lt;/p>
&lt;h2 id="第一步-找出目标机器已经安装的软件包列表">第一步 找出目标机器已经安装的软件包列表&lt;/h2>
&lt;pre tabindex="0">&lt;code>yum list installed | awk &amp;#39;{print $1}&amp;#39; | grep -v &amp;#34;^@&amp;#34; | grep &amp;#34;^[^0-9]&amp;#34; | awk -F. &amp;#39;{print $1}&amp;#39;
&lt;/code>&lt;/pre>&lt;p>稍微解释下, 先列出已安装的软件列表, 然后简单修饰下输出, 因为我们只关心程序包名, 至于版本, 架构, 描述什么的统统不要, 所以就有了这么长的一个管道命令
假设新机为new, 旧机为old, 用以上命令分别在new old上执行, 输出结果分别保存为new.lst和old.lst&lt;/p>
&lt;h2 id="第二步-取新旧软件包列表的差集">第二步 取新旧软件包列表的差集&lt;/h2>
&lt;p>其实就是找出old.lst里面有而new.lst里没有的, 这时候需要上 Python 大法&lt;/p>
&lt;pre tabindex="0">&lt;code># 取差集
with open(&amp;#34;new.lst&amp;#34;, &amp;#34;r&amp;#34;) as n, open(&amp;#34;old.lst&amp;#34;, &amp;#34;r&amp;#34;) as o:
new_lst = [i.strip() for i in n]
old_lst = [i.strip() for i in o]
lst = list(set(old_lst) - set(new_lst))
# 输出结果, 空格分隔, 方便第三步处理
with open(&amp;#34;packages.lst&amp;#34;, &amp;#34;w&amp;#34;) as f:
map(lambda x:f.write(x + &amp;#34; &amp;#34;), lst)
&lt;/code>&lt;/pre>&lt;h2 id="第三步-在新节点上安装差集软件列表">第三步 在新节点上安装差集软件列表&lt;/h2>
&lt;pre tabindex="0">&lt;code>yum install $(cat packages.lst)
&lt;/code>&lt;/pre>&lt;h2 id="第四步-扫尾">第四步 扫尾&lt;/h2>
&lt;p>不出意外肯定有部分是repo list里面没有的, 这些数量比较少, 可以自己人肉安装解决
比如, bcl2fastq2就需要人肉安装&lt;/p>
&lt;blockquote>
&lt;p>也许有更优雅的解决方案, 不过目前这个方法比较简单粗暴, 对我来说可操作&lt;/p>
&lt;/blockquote></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>在python中执行shell命令</title><link>https://blog.ferstar.org/post/%E5%9C%A8python%E4%B8%AD%E6%89%A7%E8%A1%8Cshell%E5%91%BD%E4%BB%A4/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E5%9C%A8python%E4%B8%AD%E6%89%A7%E8%A1%8Cshell%E5%91%BD%E4%BB%A4/</guid><pubDate>Tue, 02 Aug 2016 11:59:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>via &lt;a href="https://github.com/amoffat/sh">https://github.com/amoffat/sh&lt;/a>
就这么个东东
安装也很简单&lt;code>pip install sh&lt;/code>就ok
当然如果host系统过老, python版本低于2.6, 那就需要pyenv之类的工具创建虚拟python运行环境, 比如我用&lt;code>conda&lt;/code>
&lt;code>conda -n pysh python=3.4 sh&lt;/code>
很方便的说
然后顺路玩玩&lt;/p>
&lt;pre tabindex="0">&lt;code>&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>模拟xorg视窗环境的神器Xvfb</title><link>https://blog.ferstar.org/post/%E6%A8%A1%E6%8B%9Fxorg%E8%A7%86%E7%AA%97%E7%8E%AF%E5%A2%83%E7%9A%84%E7%A5%9E%E5%99%A8xvfb/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E6%A8%A1%E6%8B%9Fxorg%E8%A7%86%E7%AA%97%E7%8E%AF%E5%A2%83%E7%9A%84%E7%A5%9E%E5%99%A8xvfb/</guid><pubDate>Wed, 27 Jul 2016 09:27:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>via &lt;a href="http://www.puritys.me/docs-blog/article-262-%E5%AE%89%E8%A3%9D-XVFB-%E5%81%9A-Selenium-%E6%B8%AC%E8%A9%A6.html">http://www.puritys.me/docs-blog/article-262-%E5%AE%89%E8%A3%9D-XVFB-%E5%81%9A-Selenium-%E6%B8%AC%E8%A9%A6.html&lt;/a>
常在终端走, 差点忘了有的程序是要X视窗环境才能跑的, 所以这就是这个玩意的价值所在, 安装很简单, centos下
&lt;code>yum install xorg-x11-server-Xvfb&lt;/code>
然后就可以愉快的玩耍了
运行需要X视窗环境的程序前先把他开启, 用完再kill掉, 嗯, 很完美&lt;/p>
&lt;pre tabindex="0">&lt;code>...
source activate my_root
Xvfb :99 &amp;amp; # 指定视窗编号为99
xvfb_pid=$! # 记下进程pid
export DISPLAY=:99 # 指定程序输出视窗编号, 对应上面99
ete3 view -t outTree.v3 -i outTree.pdf
kill -9 $xvfb_pid # 用完kill掉
tar cf outTree.tar.bz2 --use-compress-prog=pbzip2 outTree.pdf
bypy upload outTree.tar.bz2
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>好看的Xshell配色方案(转)</title><link>https://blog.ferstar.org/post/%E5%A5%BD%E7%9C%8B%E7%9A%84xshell%E9%85%8D%E8%89%B2%E6%96%B9%E6%A1%88%E8%BD%AC/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E5%A5%BD%E7%9C%8B%E7%9A%84xshell%E9%85%8D%E8%89%B2%E6%96%B9%E6%A1%88%E8%BD%AC/</guid><pubDate>Mon, 25 Jul 2016 13:43:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>xshell的默认配色风格真的不敢恭维，用久了，眼睛疼，网上搜了一圈，找到了个不错的配色方案，我把放在这里，省的以后再找，还可以凑篇文章，hia hia
额, 其实好像这个配色有点混淆绿色的感觉, 现在很多命令如ls输出自带配色方案, 可执行文件会标绿色, 用这个配色方案似乎绿色无法区分, 所以, 灵活选用吧&lt;/p>
&lt;pre tabindex="0">&lt;code>[Solarized Dark]
text(bold)=839496
magenta(bold)=6c71c4
text=839496
white(bold)=fdf6e3
green=859900
red(bold)=cb4b16
green(bold)=586e75
black(bold)=073642
red=dc322f
blue=268bd2
black=002b36
blue(bold)=839496
yellow(bold)=657b83
cyan(bold)=93a1a1
yellow=b58900
magenta=dd3682
background=042028
white=eee8d5
cyan=2aa198
[Names]
count=1
name0=Solarized Dark
&lt;/code>&lt;/pre>&lt;p>新建solarized-dark.xcs，copy上面内容，然后 右键 &amp;gt; Color Schemes &amp;gt; Import即可, 贴张效果图&lt;/p>
&lt;p>&lt;img src="~/xshell%E9%85%8D%E8%89%B2.png" alt="">&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>工欲善其事,必先利其器</title><link>https://blog.ferstar.org/post/%E5%B7%A5%E6%AC%B2%E5%96%84%E5%85%B6%E4%BA%8B%E5%BF%85%E5%85%88%E5%88%A9%E5%85%B6%E5%99%A8/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E5%B7%A5%E6%AC%B2%E5%96%84%E5%85%B6%E4%BA%8B%E5%BF%85%E5%85%88%E5%88%A9%E5%85%B6%E5%99%A8/</guid><pubDate>Fri, 22 Jul 2016 13:14:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>大概罗列下常用的东西, 备忘性质, 并不会写具体怎么怎么用. 二八定律, 这些工具功能的百分之二十足以支撑平时百分之八十甚至更多的使用需求&lt;/p>
&lt;h2 id="字体">字体&lt;/h2>
&lt;ol>
&lt;li>YaHei Consolas Hybrid - 雅黑 Consolas合体&lt;/li>
&lt;li>SourceCodePro&lt;/li>
&lt;li>MacType - 全局字体显示效果微调
后来发现这东西其实并没有什么卵用, 屏幕垃圾的话, 怎么调字体都是虚的, 换显示器才是王道&lt;/li>
&lt;/ol>
&lt;h2 id="编辑器">编辑器&lt;/h2>
&lt;h3 id="vim">VIM&lt;/h3>
&lt;p>对这玩意一直心存敬畏,一般只在服务器改参数时用, 或者实在环境恶劣, 只有一个terminal的情形下使用, 所幸这种环境不常遇到, 当然遇到了也不虚&lt;/p>
&lt;h3 id="notepad">Notepad++&lt;/h3>
&lt;p>常用配置可以利用&amp;quot;设置-&amp;gt;首选项-&amp;gt;云端&amp;quot;把路径设置到dropbox自定目录下面, 保持配置同步, 另外需要把白底配色换掉, 一直看白底黑字眼睛要爆炸
作为一个python党, 一定要注意两个设置, 一个是把tab键用4个空格代替, 一个是编码UTF-8&lt;/p>
&lt;h3 id="sublime-text-3">Sublime Text 3&lt;/h3>
&lt;p>本来是想用Atom来着,不过那货实在是太慢, 所以还是用这个啦
插件的话, 装完这个爸爸辈的 Package Control 其他随便 install, 很方便&lt;/p>
&lt;h3 id="pycharm">pycharm&lt;/h3>
&lt;h2 id="内容记录">内容记录&lt;/h2>
&lt;h3 id="farbox--dropbox-合体">Farbox &amp;amp;&amp;amp; dropbox 合体&lt;/h3>
&lt;h3 id="hexo--github-pages">Hexo + Github Pages&lt;/h3>
&lt;h3 id="为知笔记">为知笔记&lt;/h3>
&lt;h2 id="terminal">terminal&lt;/h2>
&lt;h3 id="xshell--xftp">xshell &amp;amp;&amp;amp; xftp&lt;/h3>
&lt;p>除了要好好撸一个舒服的配色方案以外似乎没有什么好说的&lt;/p>
&lt;h3 id="winscp--putty">winscp &amp;amp;&amp;amp; putty&lt;/h3>
&lt;p>上学捣鼓路由器(openwrt)那会用的组合, 自觉不比上面的组合弱多少&lt;/p>
&lt;h3 id="gnome-terminal">gnome terminal&lt;/h3>
&lt;p>多数linux发行版自带, 也需要稍微改下配色方案&lt;/p>
&lt;h2 id="浏览器">浏览器&lt;/h2>
&lt;h3 id="chrome">chrome&lt;/h3>
&lt;h3 id="马甲360极速">马甲360极速&lt;/h3>
&lt;h2 id="gtd">GTD&lt;/h2>
&lt;h3 id="滴答清单">滴答清单?&lt;/h3>
&lt;h3 id="ios备忘录">iOS备忘录&lt;/h3>
&lt;h2 id="工作流">工作流&lt;/h2>
&lt;h3 id="tower">tower&lt;/h3>
&lt;h3 id="零信原瀑布">零信(原瀑布)&lt;/h3>
&lt;h3 id="石墨文档">石墨文档&lt;/h3>
&lt;h3 id="github--coding">github &amp;amp;&amp;amp; coding&lt;/h3>
&lt;h2 id="爬墙">爬墙&lt;/h2>
&lt;h3 id="ss">ss&lt;/h3>
&lt;h3 id="goagent">goagent&lt;/h3>
&lt;h2 id="书单">书单&lt;/h2>
&lt;h3 id="shell脚本学习指南">shell脚本学习指南&lt;/h3>
&lt;h3 id="python手册">python手册&lt;/h3>
&lt;h3 id="heading">&lt;/h3></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>install mothur on centos 6.6</title><link>https://blog.ferstar.org/post/install-mothur-on-centos-6/</link><guid isPermaLink="true">https://blog.ferstar.org/post/install-mothur-on-centos-6/</guid><pubDate>Tue, 19 Jul 2016 17:03:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>以下皆为历史, 开始拥抱&lt;code>conda&lt;/code>
&lt;a href="http://0ne.farbox.com/post/ngs/ngsjie-fang-sheng-chan-li-gong-ju-miniconda-bioconda">NGS解放生产力工具--Miniconda&amp;amp;Bioconda&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>这玩意最新版依赖的g++库版本太高, 升级贼麻烦, 所以退而求其次, 找个略旧的版本build from source吧&lt;/p>
&lt;p>&lt;code>wget https://codeload.github.com/mothur/mothur/tar.gz/v1.35.0 -O mothur.zip&lt;/code>&lt;/p>
&lt;p>下载后解压, 先make, 出错, 什么arch不对云云
所以查看下makefile, 发现这个makefile写的蛮有爱, 按照机器需求小改如下&lt;/p>
&lt;pre tabindex="0">&lt;code>ifeq ($(strip $(64BIT_VERSION)),yes)
#if you are using centos uncomment the following lines
CXX = g++
#if you are a mac user use the following line
#TARGET_ARCH += -arch x86_64
#if you using cygwin to build Windows the following line
#CXX = x86_64-w64-mingw32-g++
#CC = x86_64-w64-mingw32-g++
#FORTAN_COMPILER = x86_64-w64-mingw32-gfortran
#TARGET_ARCH += -m64 -static
#if you are a linux user use the following line
CXXFLAGS += -mtune=native -march=native
CXXFLAGS += -DBIT_VERSION
FORTRAN_FLAGS = -m64
endif
&lt;/code>&lt;/pre>&lt;p>改完保存, make -j12, 成功生成二进制文件mothur和uchime, 随便拖到哪里都可以用了, 当然必须是要指定PATH的&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>qsub scripts</title><link>https://blog.ferstar.org/post/qsub-scripts/</link><guid isPermaLink="true">https://blog.ferstar.org/post/qsub-scripts/</guid><pubDate>Fri, 15 Jul 2016 09:30:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>via &lt;a href="https://github.com/kundajelab/training_camp/wiki/1.2:-Shell-scripts-and-job-submission">https://github.com/kundajelab/training_camp/wiki/1.2:-Shell-scripts-and-job-submission&lt;/a>
一个例子&lt;code>sample_script.job&lt;/code>&lt;/p>
&lt;pre tabindex="0">&lt;code>#!/bin/bash
# pass all environment variables to the job (environment variables are like settings specific to your login session; you often want to pass these settings to the job so that the commands will behave the same way they do when you type them into your login session).
#$ -V
# name of your job
#$ -N jobname
# send an email when the job ends or aborts
#$ -m ea
# whom to email
#$ -M youremail@stanford.edu
# Execute the job in the current working directory (you also usually want this option set)
#$ -cwd
# specifies the file to write the output that would (in the absence of qsub) would be printed to the screen (technically &amp;#34;stdout&amp;#34; or &amp;#34;standard output&amp;#34;)
#$ -o /path/to/jobname.stdout
# specifies the file to write error messages to (in the absence of qsub, these would also be printed to the screen; technically &amp;#34;stderr&amp;#34; or &amp;#34;standard error&amp;#34;)
#$ -e /path/to/jobname.stderr
# verify options and abort if there is an error
#$ -w e
#$ -S /bin/bash
[your job commands go here]
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>批量转换bam到fastq</title><link>https://blog.ferstar.org/post/%E6%89%B9%E9%87%8F%E8%BD%AC%E6%8D%A2bam%E5%88%B0fastq/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E6%89%B9%E9%87%8F%E8%BD%AC%E6%8D%A2bam%E5%88%B0fastq/</guid><pubDate>Thu, 14 Jul 2016 19:47:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>额, 果然不能闭门造车啊, 摊上事先找轮子, 实在找不到再造也不迟
现成的轮子在此
&lt;a href="http://rpm.pbone.net/index.php3/stat/4/idpl/23502611/dir/centos_6/com/tophat-2.0.6-6.1.i686.rpm.html">http://rpm.pbone.net/index.php3/stat/4/idpl/23502611/dir/centos_6/com/tophat-2.0.6-6.1.i686.rpm.html&lt;/a>
中间有个软件叫&lt;code>bam2fastx&lt;/code>&lt;/p>
&lt;p>&lt;code>bam2fastq.py&lt;/code>作用就是批量转换指定目录下面所有bam格式到fastq格式, 如果有的话
需要系统提前预置&lt;code>samtools&lt;/code>软件
via &lt;a href="http://www.htslib.org/">http://www.htslib.org/&lt;/a>&lt;/p>
&lt;pre tabindex="0">&lt;code>#!/usr/bin/env python
import getopt
import os
import subprocess
import sys
from multiprocessing.dummy import Pool as ThreadPool
def usage(argv):
print(&amp;#34;Usage: %s -i &amp;lt;bam_dir&amp;gt;&amp;#34; % argv)
print(&amp;#34;*.fastq files will in ./fastq.&amp;#34;)
def bam_lst(bam_dir):
if os.path.exists(bam_dir):
lst = []
for root, dirs, files in os.walk(bam_dir):
for file in files:
if file.endswith(&amp;#34;.bam&amp;#34;):
lst.append(os.path.join(root, file))
else:
print(&amp;#34;The directory (%s) you just entered doesn&amp;#39;t exist.&amp;#34; % bam_dir)
sys.exit(2)
if lst:
return lst
else:
print(&amp;#34;No *.sam file found in \&amp;#34;%s\&amp;#34;&amp;#34; % bam_dir)
sys.exit(2)
def bam2fastq(ifile):
file_name = ifile.split(&amp;#34;.&amp;#34;)[0].split(&amp;#34;/&amp;#34;)[1]
subprocess.call(&amp;#34;samtools fastq %s &amp;gt; fastq/%s.fastq&amp;#34; % (ifile, file_name), shell=True)
return None
def main(argv):
input_dir = &amp;#34;&amp;#34;
try:
opts, args = getopt.getopt(argv[1:], &amp;#34;hi:&amp;#34;, [&amp;#34;ifile=&amp;#34;, ])
except getopt.GetoptError:
usage(argv[0])
sys.exit(2)
for opt, arg in opts:
if opt in (&amp;#34;-i&amp;#34;, &amp;#34;--ifile&amp;#34;):
input_dir = arg
elif opt == &amp;#34;-h&amp;#34;:
usage(argv[0])
sys.exit()
files = bam_lst(input_dir)
if not os.path.exists(&amp;#34;fastq&amp;#34;):
os.makedirs(&amp;#34;fastq&amp;#34;)
print(&amp;#34;Start converting...&amp;#34;)
pool = ThreadPool()
pool.map(bam2fastq, files)
pool.close()
pool.join()
print(&amp;#34;All done!&amp;#34;)
if __name__ == &amp;#34;__main__&amp;#34;:
main(sys.argv)
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>parallel-meta</title><link>https://blog.ferstar.org/post/parallel-meta/</link><guid isPermaLink="true">https://blog.ferstar.org/post/parallel-meta/</guid><pubDate>Thu, 14 Jul 2016 11:16:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>vi &lt;a href="http://www.computationalbioenergy.org/parallel-meta.html">http://www.computationalbioenergy.org/parallel-meta.html&lt;/a>
需要R依赖, 然而Base源里面没有,只能从别处安装
当然万事都可以从源码上, 但是这样太麻烦
作为一个懒人, 需要用一种优雅的方式来安装
&lt;code>yum install epel-release&lt;/code>
装完此包后还要启用epel
&lt;code>vi /etc/yum.repos.d/epel.repo&lt;/code>
把enable=0改成1, 保存退出, 就可以使用yum大法了
&lt;code>yum install R&lt;/code>&lt;/p>
&lt;p>环境变量很重要&lt;/p>
&lt;pre tabindex="0">&lt;code>Configure the environment variables
export ParallelMETA=Path to Parallel-META
export PATH=”$PATH:$ParallelMETA/bin”
Rscript parallel-meta/Rscript/PM_Config.R
&lt;/code>&lt;/pre>&lt;p>测试用例&lt;/p>
&lt;pre tabindex="0">&lt;code>20
|-- meta.txt
|-- seq
| |-- S9066B.fa
| |-- S9066I.fa
| |-- S9138B.fa
| |-- S9138I.fa
| |-- S9155B.fa
| |-- S9155I.fa
| |-- S9170B.fa
| |-- S9170I.fa
| |-- S9182B.fa
| |-- S9182I.fa
| |-- S9202B.fa
| |-- S9202I.fa
| |-- S9296B.fa
| |-- S9296I.fa
| |-- S9307B.fa
| |-- S9307I.fa
| |-- S9320B.fa
| |-- S9320I.fa
| |-- S9412B.fa
| `-- S9412I.fa
`-- seq.list
&lt;/code>&lt;/pre>&lt;p>一条龙命令
&lt;code>pipeline -i seq.list -m meta.txt&lt;/code>
不指定输出目录默认是&lt;code>default_out&lt;/code>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>awk的一次具体应用</title><link>https://blog.ferstar.org/post/awk%E7%9A%84%E4%B8%80%E6%AC%A1%E5%85%B7%E4%BD%93%E5%BA%94%E7%94%A8/</link><guid isPermaLink="true">https://blog.ferstar.org/post/awk%E7%9A%84%E4%B8%80%E6%AC%A1%E5%85%B7%E4%BD%93%E5%BA%94%E7%94%A8/</guid><pubDate>Wed, 13 Jul 2016 17:31:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;h2 id="源文件">源文件&lt;/h2>
&lt;h3 id="1-classificationtxt">1. classification.txt&lt;/h3>
&lt;pre tabindex="0">&lt;code>#Sequence_Id Database_OTU FLAG MAPQ Classification
OLK8A:00020:00034 536000 0 1 Bacteria; Actinobacteria; Actinobacteria; Actinomycetales; Actinomycetaceae; Candidatus Ancillula; Unclassified; otu_536000
OLK8A:00025:00021 196980 0 1 Bacteria; Firmicutes; Clostridia; Clostridiales; Unclassified; otu_196980
OLK8A:00015:00043 940035 16 1 Bacteria; Proteobacteria; Gammaproteobacteria; Oceanospirillales; Alcanivoracaceae; Alcanivorax; Unclassified; otu_940035
OLK8A:00008:00025 223895 16 1 Bacteria; Firmicutes; Clostridia; Clostridiales; Lachnospiraceae; Coprococcus; Unclassified; otu_223895
OLK8A:00019:00023 9665 16 1 Bacteria; Proteobacteria; Gammaproteobacteria; Enterobacteriales; Enterobacteriaceae; Unclassified; otu_9665
OLK8A:00025:00016 1109247 16 1 Bacteria; Proteobacteria; Gammaproteobacteria; Enterobacteriales; Enterobacteriaceae; Unclassified; otu_1109247
OLK8A:00048:00028 289261 16 1 Bacteria; Proteobacteria; Gammaproteobacteria; Enterobacteriales; Enterobacteriaceae; Unclassified; otu_289261
...
&lt;/code>&lt;/pre>&lt;h3 id="2-ljfasta">2. LJ.fasta&lt;/h3>
&lt;pre tabindex="0">&lt;code>&amp;gt;OLK8A:00004:00009
ACTGAGACACGGTCCAGACTCCTACGGGAGGCAGCAGTGGGGGAATATTGGACAATGGGGGAACCCTGATCCAGCCATGCCGCGTGTGTGAAGAAGGCCTTTTGGTTGTAAAGCACTTTAAGCGAGGAGGAGGCTACCGAGATTAATACTCTTGGATAGTGGACGTTACTCGCAGAATAAGCACCGGCTAACTCTGTGCCAGCAGCCGCGGTAATAC
&amp;gt;OLK8A:00004:00023
GGCGGACGGGTGAGTAATGTCTGGGAAACTGCCTGATGGAGGGGGATAACTACTGGAAACGGTAGCTAATACCGCATAACGTCGCAAGACCAAAGAGGGGGACCTTCGGGCCTCTTGCCATCGGATGTGCCCAGATGGGATTAGCTAGTAGGTGGGGTAACGGCTCACCTAGGCGACGTCCCTAGCTGGTCTGAGAGGATGACCAGCCACACTGGAACTGAGACACGGTCCAGACTCCTACGGGAGGCAGC
&amp;gt;OLK8A:00004:00026
CGATTACTAGCGACTCCGACTTCATGGAGTCGAGTTGCAGACTCCAATCCGGACTACGATAGATTTTCTGGGATTGGCTCCCGCTCACGCGTTGGCTTCCCTCTGTATCTACCATTGTAGCACCGTGTGTAGCCCTGGTCATAAAGGCCATCGATGACTTGACGTCATCCCCACCTTCCTCCGGTTTGTCACCGGCGGTCTCCTTA
...
&lt;/code>&lt;/pre>&lt;h2 id="要求">要求&lt;/h2>
&lt;p>classification.txt数据是对LJ.fasta样本数据的分析结果, 其中Classification列表示所标记序列对应的菌种, 但是有可能并没有识别到种, 只识别到属或者更粗放的结果. 所以问题来了: 把样本数据中只定到属未定到具体种的序列提取出来&lt;/p>
&lt;h2 id="解决方案">解决方案&lt;/h2>
&lt;h3 id="1-先取出只分出属未分出种的序列编号">1. 先取出只分出属未分出种的序列编号&lt;/h3>
&lt;p>&lt;code>awk -F &amp;quot;;&amp;quot; '{print $1 $6}' classification.txt | grep &amp;quot;Unclassified&amp;quot; | awk '{print $1}' &amp;gt; genus.txt&lt;/code>&lt;/p>
&lt;h3 id="2-然后逐一遍历genustxt找出具体sequence_id及其碱基序列">2. 然后逐一遍历&lt;code>genus.txt&lt;/code>找出具体&lt;code>Sequence_Id&lt;/code>及其碱基序列&lt;/h3>
&lt;pre tabindex="0">&lt;code>for i in $(cat genus.txt)
do
line=$(grep -n $i LJ.fasta | awk -F: &amp;#39;{print $1}&amp;#39;)
awk &amp;#39;NR==&amp;#39;&amp;#34;$line&amp;#34;&amp;#39;&amp;#39; LJ.fasta &amp;gt;&amp;gt; /tmp/out.fasta
awk &amp;#39;NR==&amp;#39;&amp;#34;$(($line + 1))&amp;#34;&amp;#39;&amp;#39; LJ.fasta &amp;gt;&amp;gt; /tmp/out.fasta
done
&lt;/code>&lt;/pre>&lt;h3 id="3-验证后写成脚本执行然后等待结果即可">3. 验证后写成脚本执行然后等待结果即可&lt;/h3>
&lt;h2 id="并行加速">并行加速&lt;/h2>
&lt;p>上述脚本虽然可以解决问题, 但是运行效率实在太低, 大概每秒能处理不到100行的样子, 实际数据有近百万行, 等搞完黄花菜都凉了, 所以需要改进一下, 最好能让多核跑起来, 也就是传说中的并行化处理, 所以shell看来是不行了, 不熟, 然后愉快的开始python大法&lt;/p>
&lt;pre tabindex="0">&lt;code>#!/usr/bin/env python
import subprocess
from multiprocessing import Pool
def get_unclassified_rows(item):
handle = subprocess.Popen(&amp;#34;grep -n %s YL.fasta | awk -F: &amp;#39;{print $1}&amp;#39;&amp;#34; % item, stdout=subprocess.PIPE, shell=True)
line = int(handle.stdout.read().strip())
handle = subprocess.Popen(&amp;#34;awk &amp;#39;NR&amp;gt;={0}&amp;amp;&amp;amp;NR&amp;lt;={1}&amp;#39; YL.fasta&amp;#34;.format(line, line + 1), stdout=subprocess.PIPE, shell=True)
with open(&amp;#34;YL_unclassified.fasta&amp;#34;, &amp;#34;a&amp;#34;) as fh:
fh.write(handle.stdout.read())
def main():
with open(&amp;#34;genus.txt&amp;#34;, &amp;#34;r&amp;#34;) as fh:
lst = [i.strip() for i in fh]
pool = Pool()
pool.map(get_unclassified_rows, lst)
pool.close()
pool.join()
if __name__ == &amp;#34;__main__&amp;#34;:
main()
&lt;/code>&lt;/pre>&lt;p>主要就是用到了&lt;code>pool.map()&lt;/code>这个东西, 效果很赞, 本来需要3小时甚至更久的的任务缩短到几分钟就欧了&lt;/p>
&lt;pre tabindex="0">&lt;code># 找出指定内容的具体列数
sed &amp;#39;s/\t/:/g&amp;#39; XJ-C-16.NT.snap.matched.fl.Bacteria.annotated.noRibo.annotated.species.counttable | awk -F: &amp;#39;
NR==1{for(i=1;i&amp;lt;=NF;++i); if($i==&amp;#34;bar#AGGCAGAA+ATAGAGAG&amp;#34;); num=i-1}
{print $num}&amp;#39;
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>Enabling Public Web Access to Your Frontend</title><link>https://blog.ferstar.org/post/enabling-public-web-access-to-your-frontend/</link><guid isPermaLink="true">https://blog.ferstar.org/post/enabling-public-web-access-to-your-frontend/</guid><pubDate>Fri, 08 Jul 2016 11:31:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>via &lt;a href="http://central6.rocksclusters.org/roll-documentation/base/6.2/enable-www.html">http://central6.rocksclusters.org/roll-documentation/base/6.2/enable-www.html&lt;/a>&lt;/p>
&lt;p>iptables是个好东西, 想要计算节点访问外网, 不能关闭&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>memtester</title><link>https://blog.ferstar.org/post/memtester/</link><guid isPermaLink="true">https://blog.ferstar.org/post/memtester/</guid><pubDate>Thu, 07 Jul 2016 10:02:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>via &lt;a href="http://pyropus.ca/software/memtester/">http://pyropus.ca/software/memtester/&lt;/a>&lt;/p>
&lt;p>很好的一个内存测试工具, 姑且试试看&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>How to remove snapd from Ubuntu 16.04 (Xenial Xerus)</title><link>https://blog.ferstar.org/post/how-to-remove-snapd-from-ubuntu-16/</link><guid isPermaLink="true">https://blog.ferstar.org/post/how-to-remove-snapd-from-ubuntu-16/</guid><pubDate>Wed, 06 Jul 2016 11:02:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>via &lt;a href="https://www.howtoinstall.co/en/ubuntu/xenial/snapd?action=remove">https://www.howtoinstall.co/en/ubuntu/xenial/snapd?action=remove&lt;/a>
Uninstall snapd
To remove just snapd package itself from Ubuntu 16.04 (Xenial Xerus) execute on terminal:&lt;/p>
&lt;p>sudo apt-get remove snapd
Uninstall snapd and it's dependent packages
To remove the snapd package and any other dependant package which are no longer needed from Ubuntu Xenial.&lt;/p>
&lt;p>sudo apt-get remove --auto-remove snapd
Purging snapd
If you also want to delete configuration and/or data files of snapd from Ubuntu Xenial then this will work:&lt;/p>
&lt;p>sudo apt-get purge snapd
To delete configuration and/or data files of snapd and it's dependencies from Ubuntu Xenial then execute:&lt;/p>
&lt;p>sudo apt-get purge --auto-remove snapd&lt;/p>
&lt;p>为什么要删呢, 因为跟surpi用到的snap版本冲突, 所以只能牺牲这个我并不会用到的软件了&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>程序员如何快速上手一个自己不太熟悉的新项目？有什么技巧？</title><link>https://blog.ferstar.org/post/%E7%A8%8B%E5%BA%8F%E5%91%98%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E4%B8%80%E4%B8%AA%E8%87%AA%E5%B7%B1%E4%B8%8D%E5%A4%AA%E7%86%9F%E6%82%89%E7%9A%84%E6%96%B0%E9%A1%B9%E7%9B%AE%E6%9C%89%E4%BB%80%E4%B9%88%E6%8A%80%E5%B7%A7/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E7%A8%8B%E5%BA%8F%E5%91%98%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E4%B8%80%E4%B8%AA%E8%87%AA%E5%B7%B1%E4%B8%8D%E5%A4%AA%E7%86%9F%E6%82%89%E7%9A%84%E6%96%B0%E9%A1%B9%E7%9B%AE%E6%9C%89%E4%BB%80%E4%B9%88%E6%8A%80%E5%B7%A7/</guid><pubDate>Tue, 05 Jul 2016 13:51:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>作者：Jim Jin
链接：https://www.zhihu.com/question/38865497/answer/108163546
来源：知乎
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。&lt;/p>
&lt;p>不知道你有没有经历过一个五年或者更长工作年限的开发人员半路加入团队的情况，可能第一两个星期他会问一些业务或者技术问题，不过一两个月他就可能在指导那些初级开发人员了。&lt;/p>
&lt;p>什么原因呢？因为他已经从过往经验里面总结出来一些套路了。&lt;/p>
&lt;p>那么套路是什么呢？&lt;/p>
&lt;ol>
&lt;li>
&lt;p>绝大部分业务系统，不管他后端是oracle、mysql、nosql还是内存数据库，也不管他前端是web、h5、winform、android还是ios，它的核心功能都是由增删改查组成然后通过通信、运算和人机交互串起来的，系统的复杂度主要体现在系统规模、性能、稳定性、业务流程、通信等方面。（部分工具类、基础架构类系统可能不一样）&lt;/p>
&lt;/li>
&lt;li>
&lt;p>绝大部份系统，不管是基于Java、.NET、C++还是Nodejs技术，都是遵循某种或几种设计模式分层进行开发的，最最常见的也就是MVC了。其他请参考一下设计模式教程。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>那么怎么快速熟悉新的项目呢？同样也是套路。&lt;/p>
&lt;ol>
&lt;li>
&lt;p>先搞清楚新的系统是搞什么的，就问简单几个问题，谁在用这个系统？用这个系统做什么？然后自己根据这些问题去文档找答案。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>弄清楚系统是怎么分层、分模块的，每层、每个模块都用到了什么技术和框架，之间是怎么通信的。有架构设计文档的话学习一下最好，没用过的技术先查查资料知道个大概。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>把开发环境搭起来，通过几个典型的功能弄清楚系统里面增删改查、通信、用户交互是怎么实现的。最简单的方法是根据系统的分层，先从前端到数据库把代码疏通一下，搞不清楚的话打开debug模式一步一步走一下。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>经过上面三个步骤基本上就可以改几个bug和照葫芦画瓢做个功能了。后面重点关注那些没用过的技术和组件：先搞清它的目的、背景、实现原理和功能列表，再照着文档做几个demo，平常工作时把它的文档建个快捷方式，随手查询学习一下。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>平常开发过程中如果遇到问题首先要相信：
1）绝大部分自己遇到的问题很多人已经遇到过并且解决了 。
2）绝大部分自己遇到的问题在当前系统里面已经有了答案。
3）绝大部分自己遇到的问题在你用的框架和组件里面都有现成的解决方案。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>对于规模比较大的系统或者系统集合，其实你平时工作接触到的也就是其中的一个系统或者模块，先把自己接触的部分搞定就行了。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>对于老系统，首先建议看一下我另外一个回答：在感觉项目代码的构架不行的时候,你们会怎么办? - Jim Jin 的回答
1）老系统其实满是宝藏，里面有很多你可以借鉴和学习的东西。
2）老系统也满是坑，一个看起来毫不悬念的代码改了以后可能会引发地震。
3）很多你看着不爽的代码其实都是有道理的。
4） 不要在老系统里面继续挖坑。
5）看不懂的代码不要动。
6）在你力所能及的范围内让老系统变的更美好。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>上面这个套路应该符合百分之七八十的项目，题主可以试试看。&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>Use multiple CPU Cores with your Linux commands</title><link>https://blog.ferstar.org/post/use-multiple-cpu-cores-with-your-linux-commands/</link><guid isPermaLink="true">https://blog.ferstar.org/post/use-multiple-cpu-cores-with-your-linux-commands/</guid><pubDate>Mon, 04 Jul 2016 18:17:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>via &lt;a href="http://www.rankfocus.com/use-cpu-cores-linux-commands/">http://www.rankfocus.com/use-cpu-cores-linux-commands/&lt;/a>&lt;/p>
&lt;p>bzip2确实有速度提升, 不过别的因为磁盘IO瓶颈所以实际花费时间甚至更长, 不太好用. 不过如果是处理多个文件, 确实好用&lt;/p>
&lt;h2 id="sed">sed&lt;/h2>
&lt;pre tabindex="0">&lt;code>sed &amp;#34;s/\(&amp;gt;gi|[0-9]*|\).*/\1/g&amp;#34; $fasta_file_to_index &amp;gt; $prefix.nt
# 并行后
cat $fasta_file_to_index | parallel -q --pipe sed &amp;#39;s/\(&amp;gt;gi|[0-9]*|\).*/\1/g&amp;#39; &amp;gt; $prefix.nt
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>Troubleshooting issues with SURPI pipeline for pathogen identification from</title><link>https://blog.ferstar.org/post/troubleshooting-issues-with-surpi-pipeline-for-pathogen-identification-from-complex-metagenomic-ngs-data/</link><guid isPermaLink="true">https://blog.ferstar.org/post/troubleshooting-issues-with-surpi-pipeline-for-pathogen-identification-from-complex-metagenomic-ngs-data/</guid><pubDate>Fri, 01 Jul 2016 16:56:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>from &lt;a href="https://www.biostars.org/p/118719/">https://www.biostars.org/p/118719/&lt;/a>
SURPI is a pipeline to find out the pathogens from clinical metagenomics samples. It is tested only on Ubuntu and it assumes many things about your installation. I recently installed in on CentOS. These are few key points you need to take care before running the pipeline.&lt;/p>
&lt;blockquote>
&lt;p>The taxonomy_lookup.pl program, at line 84 has sort --parallel=$cores, where you may need to remove --parallel=$cores option, if the sort utility on you machine does not support --parallel option&lt;/p>
&lt;/blockquote>
&lt;p>很明显, 老夫的rhel6.5自带sort是并没有支持并行的选项的, 老外删除这个参数显然是下下策, 我的办法是升升升, 然后发现还是好人多啊, 这里有个安全无痛升级系统自带软件的教程&lt;/p>
&lt;p>&lt;a href="http://duntuk.com/how-upgrade-coreutils-latest-version-source">http://duntuk.com/how-upgrade-coreutils-latest-version-source&lt;/a>&lt;/p>
&lt;p>嗯, 然而发现sort还是原来的sort, 好吧, 那就改一下taxonomy_lookup.pl里面的对应路径, bingo!&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>How to upgrade coreutils to latest version without breaking anything.(from</title><link>https://blog.ferstar.org/post/how-to-upgrade-coreutils-to-latest-version-from-source/</link><guid isPermaLink="true">https://blog.ferstar.org/post/how-to-upgrade-coreutils-to-latest-version-from-source/</guid><pubDate>Fri, 01 Jul 2016 11:29:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>很蛋疼的问题, 联想x6的机器太挑系统, 今天换了个rhel6.5似乎略稳定, 在更换了centos的源以后, 发现自带的yum软件包还是太老, sort命令还是不支持parallel选项, 没办法只有build from source这条路走了, 以下是过程&lt;/p>
&lt;p>The base of these instructions was derived from the excellent LinuxFromScratch.org (link is external)--which basically shows you how to safely upgrade your coreutils.&lt;/p>
&lt;p>Here we go....&lt;/p>
&lt;p>Download the latest version from here: &lt;a href="http://ftp.gnu.org/gnu/coreutils/">http://ftp.gnu.org/gnu/coreutils/&lt;/a> (link is external)&lt;/p>
&lt;pre tabindex="0">&lt;code>cd /usr/local/src
wget http://ftp.gnu.org/gnu/coreutils/coreutils-8.22.tar.xz
tar xfv coreutils-8.22.tar.xz
cd coreutils-8.22
&lt;/code>&lt;/pre>&lt;p>This is key. We make sure to put everything in /usr/bin instead of /bin. -- i.e. so we don't run into compile problems if some of the coreutils are being used&lt;/p>
&lt;pre tabindex="0">&lt;code>FORCE_UNSAFE_CONFIGURE=1 ./configure \
--prefix=/usr \
--libexecdir=/usr/lib \
--enable-no-install-program=kill,uptime
make
make install
&lt;/code>&lt;/pre>&lt;p>Now we move what we installed in /usr/bin to /bin overwritting the old coreutils with new.&lt;/p>
&lt;pre tabindex="0">&lt;code>yes | mv -v /usr/bin/{cat,chgrp,chmod,chown,cp,date,dd,df,echo,head,sleep,nice,false,ln,ls,mkdir,mknod,mv,pwd,rm,rmdir,stty,sync,true,uname,test,[} /bin
yes | mv -v /usr/bin/chroot /usr/sbin
yes | mv -v /usr/share/man/man1/chroot.1 /usr/share/man/man8/chroot.8
sed -i s/\&amp;#34;1\&amp;#34;/\&amp;#34;8\&amp;#34;/1 /usr/share/man/man8/chroot.8
&lt;/code>&lt;/pre>&lt;p>装完后发现其实 sort 还是原来的sort 新的在/usr/bin下面, 没办法, 只好人肉改下调用sort命令的路径了&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>change rhel 6.5 yum to centos</title><link>https://blog.ferstar.org/post/change-rhel-6/</link><guid isPermaLink="true">https://blog.ferstar.org/post/change-rhel-6/</guid><pubDate>Fri, 01 Jul 2016 11:28:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;pre tabindex="0">&lt;code># 卸载yum
rpm -aq | grep yum|xargs rpm -e --nodeps
# 下载依赖
wget http://mirrors.163.com/centos/6/os/x86_64/Packages/yum-metadata-parser-1.1.2-16.el6.x86_64.rpm
wget http://mirrors.163.com/centos/6/os/x86_64/Packages/yum-3.2.29-73.el6.centos.noarch.rpm
wget http://mirrors.163.com/centos/6/os/x86_64/Packages/yum-plugin-fastestmirror-1.1.30-37.el6.noarch.rpm
wget http://mirrors.163.com/centos/6/os/x86_64/Packages/python-urlgrabber-3.9.1-11.el6.noarch.rpm
wget http://mirrors.163.com/centos/6/os/x86_64/Packages/python-iniparse-0.3.1-2.1.el6.noarch.rpm
# 安装
rpm -ivh python-iniparse-0.3.1-2.1.el6.noarch.rpm
rpm -ivh python-urlgrabber-3.9.1-11.el6.noarch.rpm --force
rpm -ivh yum-metadata-parser-1.1.2-16.el6.x86_64.rpm
rpm -ivh yum-3.2.29-73.el6.centos.noarch.rpm yum-plugin-fastestmirror-1.1.30-37.el6.noarch.rpm
# 换源
mv /etc/yum.repos.d/rhel-source.repo /etc/yum.repos.d/rhel-source.repo.bak
wget http://mirrors.163.com/.help/CentOS6-Base-163.repo -O /etc/yum.repos.d/CentOS6-Base-163.repo
sed -i &amp;#34;s;\$releasever;6;g&amp;#34; /etc/yum.repos.d/CentOS6-Base-163.repo
yum makecache
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>Adding Applications to Compute Nodes</title><link>https://blog.ferstar.org/post/adding-applications-to-compute-nodes/</link><guid isPermaLink="true">https://blog.ferstar.org/post/adding-applications-to-compute-nodes/</guid><pubDate>Mon, 20 Jun 2016 13:18:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>两种方法&lt;/p>
&lt;h2 id="1-将要共享的二进制应用程序放在nfs存储-指定全局搜索path即可">1. 将要共享的二进制应用程序放在NFS存储, 指定全局搜索PATH即可&lt;/h2>
&lt;h2 id="2-rocks-cluster-60以后有一个专门的目录可以共享应用程序-shareapps">2. rocks cluster 6.0以后有一个专门的目录可以共享应用程序 /share/apps&lt;/h2>
&lt;p>官方手册原文如下, 基本上也是利用NFS存储来达到共享的目的&lt;/p>
&lt;pre tabindex="0">&lt;code>If you have code you’d like to share among the compute nodes, but your code isn’t in an RPM (or in a roll), then
this procedure describes how you can share it with NFS.
On the frontend, go to the directory /share/apps.
# cd /share/apps
Then add the files you’d like to share within this directory.
All files will also be available on the compute nodes under: /share/apps. For example:
# cd /share/apps
# touch myapp
# ssh compute-0-0
# cd /share/apps
# ls
myapp
&lt;/code>&lt;/pre>&lt;blockquote>
&lt;p>以上注意要合理分配权限, 避免普通用户无法运行程序的尴尬
同时计算节点的存储部分也应该放在NFS存储位置&lt;/p>
&lt;/blockquote></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>Python 性能优化的 20 条建议</title><link>https://blog.ferstar.org/post/python-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E7%9A%84-20-%E6%9D%A1%E5%BB%BA%E8%AE%AE/</link><guid isPermaLink="true">https://blog.ferstar.org/post/python-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E7%9A%84-20-%E6%9D%A1%E5%BB%BA%E8%AE%AE/</guid><pubDate>Sat, 18 Jun 2016 22:40:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;ol>
&lt;li>优化算法时间复杂度&lt;/li>
&lt;/ol>
&lt;p>算法的时间复杂度对程序的执行效率影响最大，在Python中可以通过选择合适的数据结构来优化时间复杂度，如list和set查找某一个元素的时间复杂度分别是O(n)和O(1)。不同的场景有不同的优化方式，总得来说，一般有分治，分支界限，贪心，动态规划等思想。&lt;/p>
&lt;ol start="2">
&lt;li>减少冗余数据&lt;/li>
&lt;/ol>
&lt;p>如用上三角或下三角的方式去保存一个大的对称矩阵。在0元素占大多数的矩阵里使用稀疏矩阵表示。&lt;/p>
&lt;ol start="3">
&lt;li>合理使用copy与deepcopy&lt;/li>
&lt;/ol>
&lt;p>对于dict和list等数据结构的对象，直接赋值使用的是引用的方式。而有些情况下需要复制整个对象，这时可以使用copy包里的copy和deepcopy，这两个函数的不同之处在于后者是递归复制的。效率也不一样：（以下程序在ipython中运行）&lt;/p>
&lt;blockquote>
&lt;p>import copy
a = range(100000)
%timeit -n 10 copy.copy(a) # 运行10次 copy.copy(a)&lt;/p>
&lt;p>%timeit -n 10 copy.deepcopy(a)&lt;/p>
&lt;p>10 loops, best of 3: 1.55 ms per loop
10 loops, best of 3: 151 ms per loop&lt;/p>
&lt;/blockquote>
&lt;p>timeit后面的-n表示运行的次数，后两行对应的是两个timeit的输出，下同。由此可见后者慢一个数量级。&lt;/p>
&lt;ol start="4">
&lt;li>使用dict或set查找元素&lt;/li>
&lt;/ol>
&lt;p>python dict和set都是使用hash表来实现(类似c++11标准库中unordered_map)，查找元素的时间复杂度是O(1)&lt;/p>
&lt;blockquote>
&lt;p>a = range(1000)
s = set(a)
d = dict((i,1) for i in a)
%timeit -n 10000 100 in d&lt;/p>
&lt;p>%timeit -n 10000 100 in s&lt;/p>
&lt;p>10000 loops, best of 3: 43.5 ns per loop
10000 loops, best of 3: 49.6 ns per loop&lt;/p>
&lt;/blockquote>
&lt;p>dict的效率略高(占用的空间也多一些)。&lt;/p>
&lt;ol start="5">
&lt;li>合理使用生成器（generator）和yield&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>%timeit -n 100 a = (i for i in range(100000))&lt;/p>
&lt;p>%timeit -n 100 b = [i for i in range(100000)]&lt;/p>
&lt;p>100 loops, best of 3: 1.54 ms per loop
100 loops, best of 3: 4.56 ms per loop&lt;/p>
&lt;/blockquote>
&lt;p>使用()得到的是一个generator对象，所需要的内存空间与列表的大小无关，所以效率会高一些。在具体应用上，比如set(i for i in range(100000))会比set([i for i in range(100000)])快。&lt;/p>
&lt;p>但是对于需要循环遍历的情况：&lt;/p>
&lt;blockquote>
&lt;p>%timeit -n 10 for x in (i for i in range(100000)): pass&lt;/p>
&lt;p>%timeit -n 10 for x in [i for i in range(100000)]: pass&lt;/p>
&lt;p>10 loops, best of 3: 6.51 ms per loop
10 loops, best of 3: 5.54 ms per loop&lt;/p>
&lt;/blockquote>
&lt;p>后者的效率反而更高，但是如果循环里有break,用generator的好处是显而易见的。yield也是用于创建generator：&lt;/p>
&lt;blockquote>
&lt;p>def yield_func(ls):
for i in ls:
yield i+1&lt;/p>
&lt;p>def not_yield_func(ls):
return [i+1 for i in ls]&lt;/p>
&lt;p>ls = range(1000000)
%timeit -n 10 for i in yield_func(ls):pass&lt;/p>
&lt;p>%timeit -n 10 for i in not_yield_func(ls):pass&lt;/p>
&lt;p>10 loops, best of 3: 63.8 ms per loop
10 loops, best of 3: 62.9 ms per loop&lt;/p>
&lt;/blockquote>
&lt;p>对于内存不是非常大的list，可以直接返回一个list，但是可读性yield更佳(人个喜好)。&lt;/p>
&lt;p>python2.x内置generator功能的有xrange函数、itertools包等。&lt;/p>
&lt;ol start="6">
&lt;li>优化循环&lt;/li>
&lt;/ol>
&lt;p>循环之外能做的事不要放在循环内，比如下面的优化可以快一倍：&lt;/p>
&lt;blockquote>
&lt;p>a = range(10000)
size_a = len(a)
%timeit -n 1000 for i in a: k = len(a)&lt;/p>
&lt;p>%timeit -n 1000 for i in a: k = size_a&lt;/p>
&lt;p>1000 loops, best of 3: 569 µs per loop
1000 loops, best of 3: 256 µs per loop&lt;/p>
&lt;/blockquote>
&lt;ol start="7">
&lt;li>优化包含多个判断表达式的顺序&lt;/li>
&lt;/ol>
&lt;p>对于and，应该把满足条件少的放在前面，对于or，把满足条件多的放在前面。如：&lt;/p>
&lt;blockquote>
&lt;p>a = range(2000)&lt;br>
%timeit -n 100 [i for i in a if 10 &amp;lt; i &amp;lt; 20 or 1000 &amp;lt; i &amp;lt; 2000]&lt;/p>
&lt;p>%timeit -n 100 [i for i in a if 1000 &amp;lt; i &amp;lt; 2000 or 100 &amp;lt; i &amp;lt; 20]&lt;/p>
&lt;p>%timeit -n 100 [i for i in a if i % 2 == 0 and i &amp;gt; 1900]&lt;/p>
&lt;p>%timeit -n 100 [i for i in a if i &amp;gt; 1900 and i % 2 == 0]&lt;/p>
&lt;p>100 loops, best of 3: 287 µs per loop
100 loops, best of 3: 214 µs per loop
100 loops, best of 3: 128 µs per loop
100 loops, best of 3: 56.1 µs per loop&lt;/p>
&lt;/blockquote>
&lt;ol start="8">
&lt;li>使用join合并迭代器中的字符串&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>In [1]: %%timeit
...: s = ''
...: for i in a:
...: s += i
...:
10000 loops, best of 3: 59.8 µs per loop&lt;/p>
&lt;p>In [2]: %%timeit
s = ''.join(a)
...:
100000 loops, best of 3: 11.8 µs per loop&lt;/p>
&lt;/blockquote>
&lt;p>join对于累加的方式，有大约5倍的提升。&lt;/p>
&lt;ol start="9">
&lt;li>选择合适的格式化字符方式&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>s1, s2 = 'ax', 'bx'
%timeit -n 100000 'abc%s%s' % (s1, s2)&lt;/p>
&lt;p>%timeit -n 100000 'abc{0}{1}'.format(s1, s2)&lt;/p>
&lt;p>%timeit -n 100000 'abc' + s1 + s2&lt;/p>
&lt;p>100000 loops, best of 3: 183 ns per loop
100000 loops, best of 3: 169 ns per loop
100000 loops, best of 3: 103 ns per loop&lt;/p>
&lt;/blockquote>
&lt;p>三种情况中，%的方式是最慢的，但是三者的差距并不大（都非常快）。(个人觉得%的可读性最好)&lt;/p>
&lt;ol start="10">
&lt;li>不借助中间变量交换两个变量的值&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>In [3]: %%timeit -n 10000
a,b=1,2
....: c=a;a=b;b=c;
....:
10000 loops, best of 3: 172 ns per loop&lt;/p>
&lt;p>In [4]: %%timeit -n 10000
a,b=1,2
a,b=b,a
....:
10000 loops, best of 3: 86 ns per loop&lt;/p>
&lt;/blockquote>
&lt;p>使用a,b=b,a而不是c=a;a=b;b=c;来交换a,b的值，可以快1倍以上。&lt;/p>
&lt;ol start="11">
&lt;li>使用if is&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>a = range(10000)
%timeit -n 100 [i for i in a if i == True]&lt;/p>
&lt;p>%timeit -n 100 [i for i in a if i is True]&lt;/p>
&lt;p>100 loops, best of 3: 531 µs per loop
100 loops, best of 3: 362 µs per loop&lt;/p>
&lt;/blockquote>
&lt;p>使用 if is True 比 if == True 将近快一倍。&lt;/p>
&lt;ol start="12">
&lt;li>使用级联比较x &amp;lt; y &amp;lt; z&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>x, y, z = 1,2,3
%timeit -n 1000000 if x &amp;lt; y &amp;lt; z:pass&lt;/p>
&lt;p>%timeit -n 1000000 if x &amp;lt; y and y &amp;lt; z:pass&lt;/p>
&lt;p>1000000 loops, best of 3: 101 ns per loop
1000000 loops, best of 3: 121 ns per loop&lt;/p>
&lt;/blockquote>
&lt;p>x &amp;lt; y &amp;lt; z效率略高，而且可读性更好。&lt;/p>
&lt;ol start="13">
&lt;li>while 1 比 while True 更快&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>def while_1():
n = 100000
while 1:
n -= 1
if n &amp;lt;= 0: break
def while_true():
n = 100000
while True:
n -= 1
if n &amp;lt;= 0: break&lt;/p>
&lt;p>m, n = 1000000, 1000000
%timeit -n 100 while_1()&lt;/p>
&lt;p>%timeit -n 100 while_true()&lt;/p>
&lt;p>100 loops, best of 3: 3.69 ms per loop
100 loops, best of 3: 5.61 ms per loop&lt;/p>
&lt;/blockquote>
&lt;p>while 1 比 while true快很多，原因是在python2.x中，True是一个全局变量，而非关键字。&lt;/p>
&lt;ol start="14">
&lt;li>使用**而不是pow&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>%timeit -n 10000 c = pow(2,20)&lt;/p>
&lt;p>%timeit -n 10000 c = 2**20&lt;/p>
&lt;p>10000 loops, best of 3: 284 ns per loop
10000 loops, best of 3: 16.9 ns per loop&lt;/p>
&lt;/blockquote>
&lt;p>**就是快10倍以上！&lt;/p>
&lt;ol start="15">
&lt;li>使用 cProfile, cStringIO 和 cPickle等用c实现相同功能（分别对应profile, StringIO, pickle）的包&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>import cPickle
import pickle
a = range(10000)
%timeit -n 100 x = cPickle.dumps(a)&lt;/p>
&lt;p>%timeit -n 100 x = pickle.dumps(a)&lt;/p>
&lt;p>100 loops, best of 3: 1.58 ms per loop
100 loops, best of 3: 17 ms per loop&lt;/p>
&lt;/blockquote>
&lt;p>由c实现的包，速度快10倍以上！&lt;/p>
&lt;ol start="16">
&lt;li>使用最佳的反序列化方式&lt;/li>
&lt;/ol>
&lt;p>下面比较了eval, cPickle, json方式三种对相应字符串反序列化的效率：&lt;/p>
&lt;blockquote>
&lt;p>import json
import cPickle
a = range(10000)
s1 = str(a)
s2 = cPickle.dumps(a)
s3 = json.dumps(a)
%timeit -n 100 x = eval(s1)&lt;/p>
&lt;p>%timeit -n 100 x = cPickle.loads(s2)&lt;/p>
&lt;p>%timeit -n 100 x = json.loads(s3)&lt;/p>
&lt;p>100 loops, best of 3: 16.8 ms per loop
100 loops, best of 3: 2.02 ms per loop
100 loops, best of 3: 798 µs per loop&lt;/p>
&lt;/blockquote>
&lt;p>可见json比cPickle快近3倍，比eval快20多倍。&lt;/p>
&lt;ol start="17">
&lt;li>使用C扩展(Extension)&lt;/li>
&lt;/ol>
&lt;p>目前主要有CPython(python最常见的实现的方式)原生API, ctypes,Cython，cffi三种方式，它们的作用是使得Python程序可以调用由C编译成的动态链接库，其特点分别是：&lt;/p>
&lt;p>&lt;strong>CPython原生API&lt;/strong>: 通过引入Python.h头文件，对应的C程序中可以直接使用Python的数据结构。实现过程相对繁琐，但是有比较大的适用范围。&lt;/p>
&lt;p>&lt;strong>ctypes&lt;/strong>: 通常用于封装(wrap)C程序，让纯Python程序调用动态链接库（Windows中的dll或Unix中的so文件）中的函数。如果想要在python中使用已经有C类库，使用ctypes是很好的选择，有一些基准测试下，python2+ctypes是性能最好的方式。&lt;/p>
&lt;p>&lt;strong>Cython&lt;/strong>: Cython是CPython的超集，用于简化编写C扩展的过程。Cython的优点是语法简洁，可以很好地兼容numpy等包含大量C扩展的库。Cython的使得场景一般是针对项目中某个算法或过程的优化。在某些测试中，可以有几百倍的性能提升。&lt;/p>
&lt;p>&lt;strong>cffi&lt;/strong>: cffi的就是ctypes在pypy（详见下文）中的实现，同进也兼容CPython。cffi提供了在python使用C类库的方式，可以直接在python代码中编写C代码，同时支持链接到已有的C类库。&lt;/p>
&lt;p>使用这些优化方式一般是针对已有项目性能瓶颈模块的优化，可以在少量改动原有项目的情况下大幅度地提高整个程序的运行效率。&lt;/p>
&lt;ol start="18">
&lt;li>并行编程&lt;/li>
&lt;/ol>
&lt;p>因为GIL的存在，Python很难充分利用多核CPU的优势。但是，可以通过内置的模块multiprocessing实现下面几种并行模式：&lt;/p>
&lt;p>&lt;strong>多进程&lt;/strong>：对于CPU密集型的程序，可以使用multiprocessing的Process,Pool等封装好的类，通过多进程的方式实现并行计算。但是因为进程中的通信成本比较大，对于进程之间需要大量数据交互的程序效率未必有大的提高。&lt;/p>
&lt;p>&lt;strong>多线程&lt;/strong>：对于IO密集型的程序，multiprocessing.dummy模块使用multiprocessing的接口封装threading，使得多线程编程也变得非常轻松(比如可以使用Pool的map接口，简洁高效)。&lt;/p>
&lt;p>&lt;strong>分布式&lt;/strong>：multiprocessing中的Managers类提供了可以在不同进程之共享数据的方式，可以在此基础上开发出分布式的程序。&lt;/p>
&lt;p>不同的业务场景可以选择其中的一种或几种的组合实现程序性能的优化。&lt;/p>
&lt;ol start="19">
&lt;li>终级大杀器：PyPy&lt;/li>
&lt;/ol>
&lt;p>PyPy是用RPython(CPython的子集)实现的Python，根据官网的基准测试数据，它比CPython实现的Python要快6倍以上。快的原因是使用了Just-in-Time(JIT)编译器，即动态编译器，与静态编译器(如gcc,javac等)不同，它是利用程序运行的过程的数据进行优化。由于历史原因，目前pypy中还保留着GIL，不过正在进行的STM项目试图将PyPy变成没有GIL的Python。&lt;/p>
&lt;p>如果python程序中含有C扩展(非cffi的方式)，JIT的优化效果会大打折扣，甚至比CPython慢（比Numpy）。所以在PyPy中最好用纯Python或使用cffi扩展。&lt;/p>
&lt;p>随着STM，Numpy等项目的完善，相信PyPy将会替代CPython。&lt;/p>
&lt;ol start="20">
&lt;li>使用性能分析工具&lt;/li>
&lt;/ol>
&lt;p>除了上面在ipython使用到的timeit模块，还有cProfile。cProfile的使用方式也非常简单： python -m cProfile filename.py，filename.py 是要运行程序的文件名，可以在标准输出中看到每一个函数被调用的次数和运行的时间，从而找到程序的性能瓶颈，然后可以有针对性地优化。&lt;/p>
&lt;p>参考&lt;/p>
&lt;p>[1] &lt;a href="http://www.ibm.com/developerworks/cn/linux/l-cn-python-optim/">http://www.ibm.com/developerworks/cn/linux/l-cn-python-optim/&lt;/a>&lt;/p>
&lt;p>[2] &lt;a href="http://maxburstein.com/blog/speeding-up-your-python-code/">http://maxburstein.com/blog/speeding-up-your-python-code/&lt;/a>&lt;/p>
&lt;p>【今日微信公号推荐↓】&lt;/p>
&lt;p>&lt;img src="http://mmbiz.qpic.cn/mmbiz/2A8tXicCG8ylB4qOBicNwopK7cT7vYIbeDC7CIbV0EzSgDRsOj6tpIVot6DqtV3QTG8Sia0NMKPlhNMAcd3fMfRfA/640?wx_fmt=png" alt="">&lt;/p>
&lt;p>更多推荐请看**《&lt;strong>&lt;a href="http://mp.weixin.qq.com/s?__biz=MzA4MjEyNTA5Mw==&amp;amp;mid=403723638&amp;amp;idx=1&amp;amp;sn=9598231e035bfdd3b21013b582ff2a4f&amp;amp;scene=21#wechat_redirect">值得关注的技术和设计公众号&lt;/a>&lt;/strong>》**&lt;/p>
&lt;p>其中推荐了包括&lt;strong>技术&lt;/strong>、&lt;strong>设计&lt;/strong>、**极客 **和 &lt;strong>IT相亲&lt;/strong>相关的热门公众号。技术涵盖：Python、Web前端、Java、安卓、iOS、PHP、C/C++、.NET、Linux、数据库、运维、大数据、算法、IT职场等。点击《&lt;a href="http://mp.weixin.qq.com/s?__biz=MzA4MjEyNTA5Mw==&amp;amp;mid=403723638&amp;amp;idx=1&amp;amp;sn=9598231e035bfdd3b21013b582ff2a4f&amp;amp;scene=21#wechat_redirect">值得关注的技术和设计公众号&lt;/a>》，发现精彩！&lt;/p>
&lt;p>&lt;img src="http://mmbiz.qpic.cn/mmbiz/fhujzoQe7TqETVZ7q8icbOVSVuxnXjGOCibqiadNIwA5P7wy2Eg2AwgTSRrlmicfCWxS0HuRlU8R8acan87XhFZMKQ/640?wx_fmt=png" alt="">&lt;/p>
&lt;p>&lt;a href="http://mp.weixin.qq.com/s?__biz=MzA4MjEyNTA5Mw==&amp;amp;mid=2652563769&amp;amp;idx=2&amp;amp;sn=474b3303f93eb6441aaf59e3a8465b44&amp;amp;scene=1&amp;amp;srcid=06189oq8ImgQ3eJhOb0o4Dvl#rd">Source From Python 性能优化的 20 条建议&lt;/a>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>加速下载NCBI数据库</title><link>https://blog.ferstar.org/post/%E5%8A%A0%E9%80%9F%E4%B8%8B%E8%BD%BDncbi%E6%95%B0%E6%8D%AE%E5%BA%93/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E5%8A%A0%E9%80%9F%E4%B8%8B%E8%BD%BDncbi%E6%95%B0%E6%8D%AE%E5%BA%93/</guid><pubDate>Sat, 18 Jun 2016 10:50:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>直接放烂码
利用了两个工具 ascp 和 axel&lt;/p>
&lt;pre tabindex="0">&lt;code>#!/bin/bash
#
# download_SURPI_data.sh
#
# This program will download the data files necessary to construct SURPI reference data.
# It verifies the md5sum if available.
#
# Chiu Laboratory
# University of California, San Francisco
# January, 2014
#
# Copyright (C) 2014 Scot Federman - All Rights Reserved
# SURPI has been released under a modified BSD license.
# Please see license file for details.
# Last revised 7/2/2014
scriptname=${0##*/}
bold=$(tput bold)
normal=$(tput sgr0)
green=&amp;#39;\e[0;32m&amp;#39;
red=&amp;#39;\e[0;31m&amp;#39;
endColor=&amp;#39;\e[0m&amp;#39;
DATE=$(date +%m%d%Y)
destination_dir=&amp;#34;NCBI_$DATE&amp;#34;
curated_dir=&amp;#34;curated_$DATE&amp;#34;
while getopts &amp;#34;:hd:c:&amp;#34; option; do
case &amp;#34;${option}&amp;#34; in
h) HELP=1;;
d) destination_dir=${OPTARG};;
c) curated_dir=${OPTARG};;
:) echo &amp;#34;Option -$OPTARG requires an argument.&amp;#34; &amp;gt;&amp;amp;2
exit 1
;;
esac
done
if [[ ${HELP-} -eq 1 ]]
then
cat &amp;lt;&amp;lt;USAGE
${bold}$scriptname${normal}
This program will download necessary files from NCBI for use with SURPI.
${bold}Command Line Switches:${normal}
-h Show this help
-d Specify directory to create for downloaded data
(optional. If unsupplied, will default to NCBI_[current date] )
-c Specify directory to create for curated data
(optional. If unsupplied, will default to curated_[current date] )
${bold}Usage:${normal}
$scriptname -d NCBI_07022014
USAGE
exit
fi
NCBI=&amp;#34;ftp-private.ncbi.nlm.nih.gov&amp;#34;
chiulab_dir=&amp;#34;http://chiulab.ucsf.edu/SURPI/databases&amp;#34;
FASTA_dir=&amp;#34;/blast/db/FASTA/&amp;#34;
TAXONOMY_dir=&amp;#34;/pub/taxonomy/&amp;#34;
nt=&amp;#34;nt.gz&amp;#34;
nt_md5=&amp;#34;nt.gz.md5&amp;#34;
nr=&amp;#34;nr.gz&amp;#34;
nr_md5=&amp;#34;nr.gz.md5&amp;#34;
taxdump=&amp;#34;taxdump.tar.gz&amp;#34;
taxdump_md5=&amp;#34;taxdump.tar.gz.md5&amp;#34;
#These files do not have md5 (as of 6/2014)
gi_taxid_nucl=&amp;#34;gi_taxid_nucl.dmp.gz&amp;#34;
gi_taxid_prot=&amp;#34;gi_taxid_prot.dmp.gz&amp;#34;
download_file ()
{
destination_folder=$1
remote_dir=$2
file=$3
type=$4
md5=$5
if [ $type != &amp;#34;ncbi&amp;#34; ]; then
( cd $destination_folder ; axel -n 10 &amp;#34;$remote_dir/$file&amp;#34; )
else
( cd $destination_folder ; ascp -l 100m -T -i ~/.aspera/connect/etc/asperaweb_id_dsa.openssh --user anonftp --mode recv --host $remote_dir $file . )
fi
if [[ $md5 ]]
then
( cd $destination_folder ; curl -O &amp;#34;$remote_dir/$md5&amp;#34; )
( cd $destination_folder ; md5sum -c --status &amp;#34;$md5&amp;#34; )
if [ $? -ne 0 ]; then
echo -e &amp;#34;${red}md5check of $file: failed.${endColor}&amp;#34;
exit
else
echo -e &amp;#34;${green}md5sum of $file: OK${endColor}&amp;#34;
fi
fi
}
#
## Download NCBI data
#
if [ ! -d &amp;#34;$destination_dir&amp;#34; ]; then
mkdir &amp;#34;$destination_dir&amp;#34;
fi
if [ ! -f &amp;#34;$destination_dir/$nt&amp;#34; ]; then
echo -e &amp;#34;$(date)\t$scriptname\tDownloading $nt&amp;#34;
download_file &amp;#34;$destination_dir&amp;#34; &amp;#34;$NCBI&amp;#34; &amp;#34;$FASTA_dir$nt&amp;#34; &amp;#34;ncbi&amp;#34; &amp;#34;$nt_md5&amp;#34;
else
echo -e &amp;#34;$(date)\t$scriptname\t$nt already present.&amp;#34;
fi
if [ ! -f &amp;#34;$destination_dir/$nr&amp;#34; ]; then
echo -e &amp;#34;$(date)\t$scriptname\tDownloading $nr&amp;#34;
download_file &amp;#34;$destination_dir&amp;#34; &amp;#34;$NCBI&amp;#34; &amp;#34;$FASTA_dir$nr&amp;#34; &amp;#34;ncbi&amp;#34; &amp;#34;$nr_md5&amp;#34;
else
echo -e &amp;#34;$(date)\t$scriptname\t$nr already present.&amp;#34;
fi
if [ ! -f &amp;#34;$destination_dir/$taxdump&amp;#34; ]; then
echo -e &amp;#34;$(date)\t$scriptname\tDownloading $taxdump&amp;#34;
download_file &amp;#34;$destination_dir&amp;#34; &amp;#34;$NCBI&amp;#34; &amp;#34;$TAXONOMY_dir$taxdump&amp;#34; &amp;#34;ncbi&amp;#34; &amp;#34;$taxdump_md5&amp;#34;
else
echo -e &amp;#34;$(date)\t$scriptname\t$taxdump already present.&amp;#34;
fi
if [ ! -f &amp;#34;$destination_dir/$gi_taxid_nucl&amp;#34; ]; then
echo -e &amp;#34;$(date)\t$scriptname\tDownloading $gi_taxid_nucl&amp;#34;
download_file &amp;#34;$destination_dir&amp;#34; &amp;#34;$NCBI&amp;#34; &amp;#34;$TAXONOMY_dir$gi_taxid_nucl&amp;#34; &amp;#34;ncbi&amp;#34;
else
echo -e &amp;#34;$(date)\t$scriptname\t$gi_taxid_nucl already present.&amp;#34;
fi
if [ ! -f &amp;#34;$destination_dir/$gi_taxid_prot&amp;#34; ]; then
echo -e &amp;#34;$(date)\t$scriptname\tDownloading $gi_taxid_prot&amp;#34;
download_file &amp;#34;$destination_dir&amp;#34; &amp;#34;$NCBI&amp;#34; &amp;#34;$TAXONOMY_dir$gi_taxid_prot&amp;#34; &amp;#34;ncbi&amp;#34;
else
echo -e &amp;#34;$(date)\t$scriptname\t$gi_taxid_prot already present.&amp;#34;
fi
#
## Download Chiulab curated data
#
declare -a download_list=( &amp;#34;Bacterial_Refseq_05172012.CLEAN.LenFiltered.uniq.fa.gz&amp;#34; \
&amp;#34;hg19_rRNA_mito_Hsapiens_rna.fa.gz&amp;#34; \
&amp;#34;rapsearch_viral_aa_130628_db_v2.12.fasta.gz&amp;#34; \
&amp;#34;viruses-5-2012_trimmedgi-MOD_addedgi.fa.gz&amp;#34; \
&amp;#34;18s_rRNA_gene_not_partial.fa.gz&amp;#34; &amp;#34;23s.fa.gz&amp;#34; \
&amp;#34;28s_rRNA_gene_NOT_partial_18s_spacer_5.8s.fa.gz&amp;#34; \
&amp;#34;rdp_typed_iso_goodq_9210seqs.fa.gz&amp;#34;)
if [ ! -d &amp;#34;$curated_dir&amp;#34; ]; then
mkdir &amp;#34;$curated_dir&amp;#34;
fi
for download in &amp;#34;${download_list[@]}&amp;#34;
do
if [ ! -f &amp;#34;$curated_dir/$download&amp;#34; ]; then
echo -e &amp;#34;$(date)\t$scriptname\tDownloading $download&amp;#34;
download_file &amp;#34;$curated_dir&amp;#34; &amp;#34;$chiulab_dir&amp;#34; &amp;#34;$download&amp;#34; &amp;#34;chiulab&amp;#34; &amp;#34;$download.md5&amp;#34;
else
echo -e &amp;#34;$(date)\t$scriptname\t$download already present.&amp;#34;
fi
done
echo -e &amp;#34;$(date)\t$scriptname\t${green}Download complete.${endColor}&amp;#34;
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>优化sqlite3数据插入性能</title><link>https://blog.ferstar.org/post/%E4%BC%98%E5%8C%96sqlite3%E6%80%A7%E8%83%BD/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E4%BC%98%E5%8C%96sqlite3%E6%80%A7%E8%83%BD/</guid><pubDate>Sat, 18 Jun 2016 08:45:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>需要序列化个略大的文本文件到数据库
关键的几个点&lt;/p>
&lt;ul>
&lt;li>用executemany代替execute&lt;/li>
&lt;li>开启此参数 PRAGMA synchronous = OFF&lt;/li>
&lt;li>放垃圾码&lt;/li>
&lt;/ul>
&lt;pre tabindex="0">&lt;code>import os
import sqlite3
import time
def exeTime(func):
def newFunc(*args, **args2):
t0 = time.time()
print &amp;#34;@%s, {%s} start&amp;#34; % (time.strftime(&amp;#34;%X&amp;#34;, time.localtime()), func.__name__)
back = func(*args, **args2)
print &amp;#34;@%s, {%s} end&amp;#34; % (time.strftime(&amp;#34;%X&amp;#34;, time.localtime()), func.__name__)
print &amp;#34;@%.3fs taken for {%s}&amp;#34; % (time.time() - t0, func.__name__)
return back
return newFunc
@exeTime
def func():
# Create names_nodes_scientific.db
print (&amp;#34;Creating names_nodes_scientific.db...&amp;#34;)
conn = sqlite3.connect(&amp;#39;names_nodes_scientific.db&amp;#39;)
c = conn.cursor()
c.execute(&amp;#34;CREATE TABLE names (taxid INTEGER PRIMARY KEY, name TEXT)&amp;#34;)
c.execute(&amp;#34;PRAGMA synchronous = OFF&amp;#34;)
c.execute(&amp;#34;BEGIN TRANSACTION&amp;#34;)
with open(&amp;#39;test.dmp&amp;#39;, &amp;#39;r&amp;#39;) as map_file:
lst = []
for line in map_file:
line = line.split(&amp;#34;|&amp;#34;)
taxid = line[0].strip()
name = line[1].strip()
lst.append((taxid, name))
c.executemany(&amp;#34;INSERT INTO names VALUES (?,?)&amp;#34;, lst)
conn.commit()
conn.close()
class Main(object):
def __init__(self):
pass
if __name__ == &amp;#39;__main__&amp;#39;:
os.remove(&amp;#34;names_nodes_scientific.db&amp;#34;)
func()
&lt;/code>&lt;/pre>&lt;p>截取80兆左右的文件做测试, 测试结果比优化前时间缩短了一半(12s降低到5.48s), 下一步考虑利用linux tmpfs的特性&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>VPN on rocks cluster</title><link>https://blog.ferstar.org/post/vpn-on-rocks-cluster/</link><guid isPermaLink="true">https://blog.ferstar.org/post/vpn-on-rocks-cluster/</guid><pubDate>Sat, 18 Jun 2016 03:38:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;h2 id="安装相关软件包">安装相关软件包&lt;/h2>
&lt;pre tabindex="0">&lt;code>yum install ppp pptp pptp-setup
Setting up Install Process
Resolving Dependencies
--&amp;gt; Running transaction check
---&amp;gt; Package ppp.x86_64 0:2.4.5-5.el6 will be updated
---&amp;gt; Package ppp.x86_64 0:2.4.5-10.el6 will be an update
---&amp;gt; Package pptp.x86_64 0:1.7.2-8.1.el6 will be installed
---&amp;gt; Package pptp-setup.x86_64 0:1.7.2-8.1.el6 will be installed
--&amp;gt; Finished Dependency Resolution
Dependencies Resolved
==============================================================================
Package Arch Version Repository Size
==============================================================================
Installing:
pptp x86_64 1.7.2-8.1.el6 base 62 k
pptp-setup x86_64 1.7.2-8.1.el6 base 12 k
Updating:
ppp x86_64 2.4.5-10.el6 base 328 k
Transaction Summary
==============================================================================
Install 2 Package(s)
Upgrade 1 Package(s)
Total download size: 402 k
Downloading Packages:
(1/3): ppp-2.4.5-10.el6.x86_64.rpm | 328 kB 00:00
(2/3): pptp-1.7.2-8.1.el6.x86_64.rpm | 62 kB 00:00
(3/3): pptp-setup-1.7.2-8.1.el6.x86_64.rpm | 12 kB 00:00
------------------------------------------------------------------------------
Total 328 kB/s | 402 kB 00:01
Running rpm_check_debug
Running Transaction Test
Transaction Test Succeeded
Running Transaction
Updating : ppp-2.4.5-10.el6.x86_64 1/4
Installing : pptp-1.7.2-8.1.el6.x86_64 2/4
Installing : pptp-setup-1.7.2-8.1.el6.x86_64 3/4
Cleanup : ppp-2.4.5-5.el6.x86_64 4/4
Verifying : ppp-2.4.5-10.el6.x86_64 1/4
Verifying : pptp-1.7.2-8.1.el6.x86_64 2/4
Verifying : pptp-setup-1.7.2-8.1.el6.x86_64 3/4
Verifying : ppp-2.4.5-5.el6.x86_64 4/4
Installed:
pptp.x86_64 0:1.7.2-8.1.el6 pptp-setup.x86_64 0:1.7.2-8.1.el6
Updated:
ppp.x86_64 0:2.4.5-10.el6
Complete!
&lt;/code>&lt;/pre>&lt;h2 id="创建vpn拨号">创建vpn拨号&lt;/h2>
&lt;p>&lt;code>pptpsetup --create aws --server xxx --user xxx --password xxx --encrypt -start&lt;/code>&lt;/p>
&lt;h2 id="具体见我的知乎回答">具体见我的知乎回答&lt;/h2>
&lt;p>&lt;a href="https://www.zhihu.com/question/31220460/answer/103939079">https://www.zhihu.com/question/31220460/answer/103939079&lt;/a>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>build abyss on rocks cluster6</title><link>https://blog.ferstar.org/post/build-abyss-on-rocks-cluster6/</link><guid isPermaLink="true">https://blog.ferstar.org/post/build-abyss-on-rocks-cluster6/</guid><pubDate>Sat, 18 Jun 2016 03:13:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>比较麻烦的是集群需要用到ABYSS-P, 如果不指定--with-mpi参数的话, 这玩意是不会生成的.
记录下编译过程&lt;/p>
&lt;pre tabindex="0">&lt;code># http://www.bcgsc.ca/platform/bioinfo/software/abyss
install_folder=&amp;#34;/prodata/ngs&amp;#34;
bin_folder=&amp;#34;$install_folder/bin&amp;#34;
CWD=$(pwd)
#Download ABySS
wget &amp;#34;http://www.bcgsc.ca/platform/bioinfo/software/abyss/releases/1.3.5/abyss-1.3.5.tar.gz&amp;#34;
tar xvfz abyss-1.3.5.tar.gz
wget https://github.com/sparsehash/sparsehash/archive/sparsehash-2.0.3.tar.gz
tar xvzf sparsehash-sparsehash-2.0.3.tar.gz
cd sparsehash-sparsehash-2.0.3
./configure --prefix=$install_folder
make -j12
make install
cd $CWD
#Set up Boost Dependency
cd abyss-1.3.5
wget &amp;#34;http://downloads.sourceforge.net/project/boost/boost/1.50.0/boost_1_50_0.tar.bz2&amp;#34;
tar jxf boost_1_50_0.tar.bz2
ln -s boost_1_50_0/boost boost
# Configure ABySS
./configure --with-mpi=/opt/openmpi CPPFLAGS=-I/prodata/ngs/include --prefix=$install_folder
make -j12
make install
cd $CWD
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>Change name of Compute node</title><link>https://blog.ferstar.org/post/change-name-of-compute-node/</link><guid isPermaLink="true">https://blog.ferstar.org/post/change-name-of-compute-node/</guid><pubDate>Fri, 17 Jun 2016 05:26:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>look at the following commands:&lt;/p>
&lt;p>rocks set host name
rocks set host rank
rocks set host rack
rocks set host interface name&lt;/p>
&lt;p>e.g. to change the name of compute-0-0 to compute-10-13&lt;/p>
&lt;pre tabindex="0">&lt;code># rocks set host name compute-0-0 compute-10-13
# rocks set host rank compute-10-13 13
# rocks set host rack compute-10-13 10
# rocks set host interface name compute-10-13 eth0 compute-10-13
# rocks sync config
# rocks sync host network compute-10-13
# rocks run host compute-10-13 &amp;#34;shutdown -r now&amp;#34;
rocks run host &amp;#34;service rocks-grub off&amp;#34;
rocks run host &amp;#34;service rocks-grub stop&amp;#34;
rocks run host &amp;#34;shutdown -r now&amp;#34;
# 重启所有计算节点
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>Rocks Cluster安装后需要做的一些事情</title><link>https://blog.ferstar.org/post/rocks-cluster%E5%AE%89%E8%A3%85%E5%90%8E%E9%9C%80%E8%A6%81%E5%81%9A%E7%9A%84%E4%B8%80%E4%BA%9B%E4%BA%8B%E6%83%85/</link><guid isPermaLink="true">https://blog.ferstar.org/post/rocks-cluster%E5%AE%89%E8%A3%85%E5%90%8E%E9%9C%80%E8%A6%81%E5%81%9A%E7%9A%84%E4%B8%80%E4%BA%9B%E4%BA%8B%E6%83%85/</guid><pubDate>Fri, 17 Jun 2016 04:51:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;h2 id="改iptables让计算节点可以通过控制节点访问公网">改iptables让计算节点可以通过控制节点访问公网&lt;/h2>
&lt;p>&lt;a href="https://linuxcluster.wordpress.com/2012/03/17/using-iptables-to-allow-compute-nodes-to-access-public-network/">https://linuxcluster.wordpress.com/2012/03/17/using-iptables-to-allow-compute-nodes-to-access-public-network/&lt;/a>&lt;/p>
&lt;p>vi /etc/sysconfig/iptables&lt;/p>
&lt;pre tabindex="0">&lt;code># Generated by iptables-save v1.4.7 on Wed Jul 13 20:34:33 2016
*filter
:INPUT ACCEPT [585:127452]
:FORWARD DROP [52:1945]
:OUTPUT ACCEPT [611:187699]
-A INPUT -i eth4 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 1194 -m comment --comment &amp;#34;openvpn&amp;#34; -j ACCEPT
-A FORWARD -i eth4 -j ACCEPT
-A FORWARD -i eth3 -o eth4 -m state --state RELATED,ESTABLISHED -j ACCEPT
COMMIT
# Completed on Wed Jul 13 20:34:33 2016
# Generated by iptables-save v1.4.7 on Wed Jul 13 20:34:33 2016
*nat
:PREROUTING ACCEPT [3186:115409]
:POSTROUTING ACCEPT [45:15680]
:OUTPUT ACCEPT [46:15756]
-A POSTROUTING -o eth3 -j MASQUERADE
-A POSTROUTING -s 10.8.0.0/24 -j MASQUERADE
-A POSTROUTING -o eth3 -j MASQUERADE
COMMIT
# Completed on Wed Jul 13 20:34:33 2016
&lt;/code>&lt;/pre>&lt;p>保存后执行&lt;code>service iptables restart&lt;/code>即可&lt;/p>
&lt;p>另外需要修改控制节点&lt;code>/etc/resolv.conf&lt;/code>添加一组公共域名解析的DNS&lt;/p>
&lt;pre tabindex="0">&lt;code>search local hpc.org
nameserver 127.0.0.1
nameserver 114.114.114.114
&lt;/code>&lt;/pre>&lt;p>此时计算节点应该可以通过控制节点自由访问公网&lt;/p>
&lt;h2 id="改dns">改DNS&lt;/h2>
&lt;h2 id="挂nfs">挂NFS&lt;/h2>
&lt;h2 id="配path">配PATH&lt;/h2>
&lt;h2 id="分账户">分账户&lt;/h2>
&lt;h2 id="禁止重启自动安装">禁止重启自动安装&lt;/h2>
&lt;pre tabindex="0">&lt;code>/etc/init.d/rocks-grub stop
chkconfig rocks-grub off
&lt;/code>&lt;/pre>&lt;h2 id="脚本">脚本&lt;/h2>
&lt;pre tabindex="0">&lt;code>#!/bin/bash
# @ferstar
# github.com
# mount nfs storage
mkdir /prodata
mkdir /resdata
chmod 1755 /prodata
chmod 1755 /resdata
mount -t nfs 10.1.1.1:/prodata /prodata
mount -t nfs 10.1.1.1:/resdata /resdata
echo &amp;#34;10.1.1.1:/prodata /prodata nfs defaults 0 0&amp;#34; &amp;gt;&amp;gt; /etc/fstab
echo &amp;#34;10.1.1.1:/resdata /resdata nfs defaults 0 0&amp;#34; &amp;gt;&amp;gt; /etc/fstab
# set path
echo &amp;#34;ngs=/prodata/ngs&amp;#34; &amp;gt;&amp;gt; /etc/bashrc
echo &amp;#34;export ParallelMETA=\$ngs/parallel-meta&amp;#34; &amp;gt;&amp;gt; /etc/bashrc
echo &amp;#34;export PATH=\$PATH:\$ngs/ncbi-blast/bin:\$ngs/bin:\$ngs/MUMmer:\$ngs/surpi:\$ngs/sratoolkit/bin:\$ngs/parallel-meta/bin:/prodata/miniconda2/bin&amp;#34; &amp;gt;&amp;gt; /etc/bashrc
# change dns server
echo &amp;#34;nameserver 223.5.5.5&amp;#34; &amp;gt;&amp;gt; /etc/resolv.conf
echo &amp;#34;nameserver 114.114.114.114&amp;#34; &amp;gt;&amp;gt; /etc/resolv.conf
# disable the rocks-gurb service
/etc/init.d/rocks-grub stop
chkconfig rocks-grub off
&lt;/code>&lt;/pre>&lt;h2 id="禁用计算节点冷启动自动重装功能">禁用计算节点冷启动自动重装功能&lt;/h2>
&lt;p>这个功能太蛋疼，计算节点一旦意外关机就会自动重装。。。&lt;/p>
&lt;pre tabindex="0">&lt;code>
# cd /export/rocks/install
# cp rocks-dist/x86_64/build/nodes/auto-kickstart.xml \
site-profiles/6.2/nodes/replace-auto-kickstart.xml
# vi site-profiles/6.2/nodes/replace-auto-kickstart.xml
# remove this line
&amp;lt;package&amp;gt;rocks-boot-auto&amp;lt;package&amp;gt;
# cd /export/rocks/install/
# rocks create distro
# 重装计算节点
# /opt/gridengine/examples/jobs/sge-reinstall.sh
&lt;/code>&lt;/pre>&lt;pre tabindex="0">&lt;code>yum install boost-openmpi-devel sqlite-devel expat-devel perl-core openssl-perl openssl-devel coreutils csh python-devel ghostscript python-matplotlib perl-Time-HiRes
cpanm Statistics::Descriptive &amp;amp;&amp;amp; cpanm XML::Parser &amp;amp;&amp;amp; cpanm DBI &amp;amp;&amp;amp; cpanm DBD::SQLite &amp;amp;&amp;amp; cpanm Net::OAuth &amp;amp;&amp;amp; cpanm Net::Twitter::Lite::WithAPIv1_1
&lt;/code>&lt;/pre>&lt;h2 id="启动步骤">启动步骤：&lt;/h2>
&lt;p>先启动控制节点，待控制节点完全启动后再启动计算节点&lt;/p>
&lt;h2 id="关机步骤">关机步骤：&lt;/h2>
&lt;p>先关计算节点，&lt;code>cluster-fork /sbin/shutdown -h now&lt;/code>，然后关闭控制节点&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>rocks cluster6.2修改DNS</title><link>https://blog.ferstar.org/post/centos6%E4%BF%AE%E6%94%B9dns/</link><guid isPermaLink="true">https://blog.ferstar.org/post/centos6%E4%BF%AE%E6%94%B9dns/</guid><pubDate>Fri, 17 Jun 2016 04:46:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;ul>
&lt;li>OS Rocks Cluster 6.2&lt;/li>
&lt;li>/etc/resolv.conf&lt;/li>
&lt;li>原有的不能注释&lt;/li>
&lt;li>只能在下面追加&lt;/li>
&lt;li>不然会出现普通用户ssh连接需要密码的情况&lt;/li>
&lt;li>目前原因不知&lt;/li>
&lt;li>百度 180.76.76.76&lt;/li>
&lt;li>阿里 223.5.5.5/223.6.6.6&lt;/li>
&lt;li>腾讯 119.29.29.29&lt;/li>
&lt;li>114 114.114.114.114&lt;/li>
&lt;li>改完保存&lt;/li>
&lt;li>不需要重启network服务, 即时生效&lt;/li>
&lt;/ul></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>解决ssh终端CentOS后中文显示乱码</title><link>https://blog.ferstar.org/post/%E8%A7%A3%E5%86%B3ssh%E7%BB%88%E7%AB%AFcentos%E5%90%8E%E4%B8%AD%E6%96%87%E6%98%BE%E7%A4%BA%E4%B9%B1%E7%A0%81/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E8%A7%A3%E5%86%B3ssh%E7%BB%88%E7%AB%AFcentos%E5%90%8E%E4%B8%AD%E6%96%87%E6%98%BE%E7%A4%BA%E4%B9%B1%E7%A0%81/</guid><pubDate>Fri, 17 Jun 2016 03:30:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>先装中文语言支持
&lt;code>yum -y groupinstall chinese-support&lt;/code>
然后编辑
&lt;code>/etc/sysconfig/i18n&lt;/code>
&lt;code>LANG=&amp;quot;en_US.UTF-8&amp;quot;&lt;/code>
有人说要改成&lt;code>zh_CN.UTF-8&lt;/code>我觉得并不需要, 我只希望能显示中文即可, 又不需要系统软件的help都是中文, 太别扭
source一下
&lt;code>source /etc/sysconfig/i18n&lt;/code>
完成~
如果SSH终端还是乱码,那么需要对终端软件的编码进行配置
统一选择UTF8即可~&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>install boost on centos6</title><link>https://blog.ferstar.org/post/install-boost-on-centos6/</link><guid isPermaLink="true">https://blog.ferstar.org/post/install-boost-on-centos6/</guid><pubDate>Fri, 17 Jun 2016 01:16:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>替换阿里云镜像
&lt;a href="http://mirrors.aliyun.com/help/centos">http://mirrors.aliyun.com/help/centos&lt;/a>
&lt;code>yum install boost&lt;/code>
安装完成&lt;/p>
&lt;pre tabindex="0">&lt;code>Installed:
boost.x86_64 0:1.41.0-28.el6
Dependency Installed:
boost-date-time.x86_64 0:1.41.0-28.el6
boost-filesystem.x86_64 0:1.41.0-28.el6
boost-graph.x86_64 0:1.41.0-28.el6
boost-iostreams.x86_64 0:1.41.0-28.el6
boost-program-options.x86_64 0:1.41.0-28.el6
boost-python.x86_64 0:1.41.0-28.el6
boost-regex.x86_64 0:1.41.0-28.el6
boost-serialization.x86_64 0:1.41.0-28.el6
boost-signals.x86_64 0:1.41.0-28.el6
boost-system.x86_64 0:1.41.0-28.el6
boost-test.x86_64 0:1.41.0-28.el6
boost-thread.x86_64 0:1.41.0-28.el6
boost-wave.x86_64 0:1.41.0-28.el6
libicu.x86_64 0:4.2.1-14.el6
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>build snap-aligner from source</title><link>https://blog.ferstar.org/post/build-snap-aligner-from-source/</link><guid isPermaLink="true">https://blog.ferstar.org/post/build-snap-aligner-from-source/</guid><pubDate>Thu, 16 Jun 2016 05:27:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>运行网上现成的binary程序总是 报这么个错:
&lt;code>snap-aligner index nt COMP_SNAP -locationSize 8 -t48&lt;/code>&lt;/p>
&lt;pre tabindex="0">&lt;code>Computed bias table in 222s
Allocating memory for hash tables...terminate called after throwing an instance of &amp;#39;std::bad_alloc&amp;#39;
what(): std::bad_alloc
Aborted
&lt;/code>&lt;/pre>&lt;p>似乎是个内存泄漏的错误, 然而老夫内存大大滴, 1TB, Google一番发现原来如果内存碎片过多, 即使内存够用, 也有可能出现无法分配的情况。没的说，只能重新编译咯&lt;/p>
&lt;pre tabindex="0">&lt;code>git clone https://github.com/amplab/snap.git
# 发现需要 g++ &amp;gt; 4.6 zlib 1.2.8
# 苦逼的集群系统组件都太老......
&lt;/code>&lt;/pre>&lt;h2 id="build-g-from-source">build g++ from source&lt;/h2>
&lt;p>看了下源码体积, 想想还是找找好心人打包好的rpm包比较现实
&lt;a href="http://superuser.com/questions/381160/how-to-install-gcc-4-7-x-4-8-x-on-centos">http://superuser.com/questions/381160/how-to-install-gcc-4-7-x-4-8-x-on-centos&lt;/a>
然而身在天朝直连这个http://people.centos.org鸟网似乎很悲剧, 自带yum升级总是下载失败, 好吧, 只能挂代理先把需要的东西下载下来然后再传到集群然后再手动安装...
&lt;a href="http://people.centos.org/tru/devtools-1.1/6/x86_64/RPMS/">http://people.centos.org/tru/devtools-1.1/6/x86_64/RPMS/&lt;/a>
东西都在上面的那个网址, 发动ctrl+f大法下载, 总共需要这么5个包&lt;/p>
&lt;pre tabindex="0">&lt;code>devtoolset-1.1-gcc-4.7.2-5.el6.x86_64.rpm
devtoolset-1.1-gcc-c4.7.2-5.el6.x86_64.rpm
devtoolset-1.1-libstdc++-devel-4.7.2-5.el6.x86_64.rpm
devtoolset-1.1-runtime-1-13.el6.noarch.rpm
scl-utils-build-20120927-2.el6_4.6.centos.x86_64.rpm
&lt;/code>&lt;/pre>&lt;p>折腾完安装
&lt;code>yum install *.rpm&lt;/code>
然后需要配置编译环境变量(系统默认的不敢动)&lt;/p>
&lt;pre tabindex="0">&lt;code>export CC=/opt/centos/devtoolset-1.1/root/usr/bin/gcc
export CPP=/opt/centos/devtoolset-1.1/root/usr/bin/cpp
export CXX=/opt/centos/devtoolset-1.1/root/usr/bin/c++
&lt;/code>&lt;/pre>&lt;h2 id="build-zlib-from-source">build zlib from source&lt;/h2>
&lt;p>这个似乎没多大必要&lt;/p>
&lt;pre tabindex="0">&lt;code>wget http://zlib.net/zlib-1.2.8.tar.gz
tar xvzf zlib-1.2.8.tar.gz
cd zlib-1.2.8
./configure --prefix=/prodata/ngs
make -j12 &amp;amp;&amp;amp; make install
&lt;/code>&lt;/pre>&lt;h2 id="开心的make-snap">开心的make snap&lt;/h2>
&lt;pre tabindex="0">&lt;code>make
mv snap-aligner /prodata/ngs/bin/
&lt;/code>&lt;/pre>&lt;h2 id="测试">测试&lt;/h2>
&lt;p>&lt;code>nohup snap-aligner index nt COMP_SNAP -locationSize 8 -t48 &amp;gt; test.log &amp;amp;&lt;/code>&lt;/p>
&lt;h2 id="扑街">扑街&lt;/h2>
&lt;pre tabindex="0">&lt;code>Allocating memory for hash tables...terminate called after throwing an instance of &amp;#39;std::bad_alloc&amp;#39;
what(): std::bad_allocstd::bad_alloc
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>build htop from source</title><link>https://blog.ferstar.org/post/build-htop-from-source/</link><guid isPermaLink="true">https://blog.ferstar.org/post/build-htop-from-source/</guid><pubDate>Thu, 16 Jun 2016 03:58:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;pre tabindex="0">&lt;code>mkdir -p /prodata/tmp
cd /prodata/tmp
wget http://hisham.hm/htop/releases/1.0.3/htop-1.0.3.tar.gz
tar -xvf htop-1.0.3.tar.gz
cd htop-1.0.3
./configure --prefix=/prodata/ngs
make -j12
make install
&lt;/code>&lt;/pre>&lt;p>运行良好&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>update glibc on rocks cluster 6.2</title><link>https://blog.ferstar.org/post/update-glibc-on-rocks-cluster-6/</link><guid isPermaLink="true">https://blog.ferstar.org/post/update-glibc-on-rocks-cluster-6/</guid><pubDate>Thu, 16 Jun 2016 02:49:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>运行snap-aligner提示需要glibc 2.14, 然而集群系统自带版本是2.12, 所以需要升级, 考虑到系统稳定性, 决定找个别的地方编译升级之&lt;/p>
&lt;pre tabindex="0">&lt;code>snap-aligner: /lib64/libc.so.6: version `GLIBC_2.14&amp;#39; not found (required by snap-aligner)
&lt;/code>&lt;/pre>&lt;h2 id="下载">下载&lt;/h2>
&lt;p>&lt;code>wget http://ftp.gnu.org/gnu/glibc/glibc-2.14.tar.gz&lt;/code>&lt;/p>
&lt;h2 id="编译">编译&lt;/h2>
&lt;pre tabindex="0">&lt;code>tar -zxvf glibc-2.14.tar.gz
cd glibc-2.14
mkdir build
cd build
../configure --prefix=/prodata/ngs/glibc-2.14
make -j12
make install
&lt;/code>&lt;/pre>&lt;h2 id="错误处理">错误处理&lt;/h2>
&lt;ol>
&lt;li>缺&lt;code>ld.so.conf&lt;/code>&lt;/li>
&lt;/ol>
&lt;pre tabindex="0">&lt;code>/prodata/tmp/glibc-2.14/build/elf/ldconfig: Can&amp;#39;t open configuration file /prodata/ngs/glibc-2.14/etc/ld.so.conf: No such file or directory
&lt;/code>&lt;/pre>&lt;p>找找看系统里面有没有&lt;code>find / -type f -iname &amp;quot;ld.so.conf&amp;quot;&lt;/code>
嗯, 很好, 系统里面有, 搬过去&lt;code>cp /etc/ld.so.conf /prodata/ngs/glibc-2.14/etc/ld.so.conf&lt;/code>
然后再&lt;code>make install&lt;/code>搞定&lt;/p>
&lt;h2 id="指定动态库的查找路径">指定动态库的查找路径&lt;/h2>
&lt;p>方法一： export LD_LIBRARY_PATH=LD_LIBRARY_PATH:/XXX 但是登出后就失效
方法二： 修改~/.bashrc或~/.bash_profile或系统级别的/etc/profile&lt;/p>
&lt;ol>
&lt;li>在其中添加例如export PATH=/opt/ActiveP/lib:$LD_LIBRARY_PATH&lt;/li>
&lt;li>source .bashrc (Source命令也称为“点命令”，也就是一个点符号（.）。source命令通常用于重新执行刚修改的初始化文件，使之立即生效，而不必注销并重新登录)
方法三：这个没有修改LD_LIBRARY_PATH但是效果是一样的实现动态库的查找，&lt;/li>
&lt;li>/etc/ld.so.conf下面加一行/usr/local/lib&lt;/li>
&lt;li>保存过后ldconfig一下（ldconfig 命令的用途,主要是在默认搜寻目录(/lib和/usr/lib)以及动态库配置文件/etc/ld.so.conf内所列的目录下,搜索出可共享的动态链接库(格式如前介绍,lib*.so*),进而创建出动态装入程序(ld.so)所需的连接和缓存文件.缓存文件默认为/etc/ld.so.cache,此文件保存已排好序的动态链接库名字列表.）
在rocks cluster 6.2的实际情况是方法三并无效果, 所以采用了方法二
具体做法:&lt;/li>
&lt;/ol>
&lt;pre tabindex="0">&lt;code>vi ~/.bashrc
# 加一行
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/prodata/ngs/glibc-2.14/lib
# 保存退出
source ~/.bashrc
&lt;/code>&lt;/pre>&lt;h2 id="正常运行">正常运行&lt;/h2>
&lt;p>&lt;code>snap-aligner&lt;/code>&lt;/p>
&lt;pre tabindex="0">&lt;code>Welcome to SNAP version 1.0beta.18.
Usage: snap &amp;lt;command&amp;gt; [&amp;lt;options&amp;gt;]
Commands:
index build a genome index
single align single-end reads
paired align paired-end reads
daemon run in daemon mode--accept commands remotely
Type a command without arguments to see its help.
&lt;/code>&lt;/pre>&lt;h2 id="奇怪的错误">奇怪的错误&lt;/h2>
&lt;p>&lt;code>snap-aligner index nt COMP_SNAP -locationSize 8 -t48&lt;/code>&lt;/p>
&lt;pre tabindex="0">&lt;code>Computed bias table in 222s
Allocating memory for hash tables...terminate called after throwing an instance of &amp;#39;std::bad_alloc&amp;#39;
what(): std::bad_alloc
Aborted
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>install RAPSearch2 on ubuntu 16.04</title><link>https://blog.ferstar.org/post/install-rapsearch2-on-ubuntu-16/</link><guid isPermaLink="true">https://blog.ferstar.org/post/install-rapsearch2-on-ubuntu-16/</guid><pubDate>Wed, 15 Jun 2016 19:23:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>要被3850x6这个破机子折腾疯了, biolinux8也就是ubuntu14.04装在上面不停的crash, 查log也没什么头绪, 基本就是什么hardware not ready 之类无营养的提示, boss说装个高版本的试试, 于是果断上16.04, 安装过程很美好, 完美识别了显卡驱动, 换句人话说就是可以自适应分辨率了, 好激动,&lt;img src="~/19-41-19.jpg" alt="">
于是开始安装&lt;code>surpi&lt;/code>的pipeline, 然后噩梦从&lt;code>RAPSearch2&lt;/code>开始...&lt;/p>
&lt;h2 id="报了这么个错">报了这么个错&lt;/h2>
&lt;pre tabindex="0">&lt;code>rm -f .o rapsearch prerapsearch
g++ -c -O3 -w HashSearch.cpp -o HashSearch.o -I ./
g++ -c -O3 -w BlastStat.cpp -o BlastStat.o -I ./
g++ -c -O3 -w Seg.cpp -o Seg.o -I ./
g++ -c -O3 -w mergeUnit.cpp -o mergeUnit.o -I ./
g++ -O3 -w -o rapsearch main.cpp HashSearch.o BlastStat.o Seg.o mergeUnit.o -I ./ -L ./ -lboost_serialization -lpthread -lboost_thread -lboost_system -lboost_chrono -lrt
ld: library not found for -lrt
collect2: ld returned 1 exit status
make: *** [rapsearch] Error 1
mv: rename Src/rapsearch to bin/rapsearch: No such file or directory
mv: rename Src/prerapsearch to bin/prerapsearch: No such file or directory
&lt;/code>&lt;/pre>&lt;h2 id="蛋疼3小时">蛋疼3小时&lt;/h2>
&lt;p>...各种找方案...&lt;/p>
&lt;h2 id="找到方案">找到方案&lt;/h2>
&lt;pre tabindex="0">&lt;code>wget --no-check-certificate &amp;#34;https://github.com/zhaoyanswill/RAPSearch2/archive/master.zip&amp;#34; -O RAPSearch2-master.zip
unzip RAPSearch2-master.zip
cd RAPSearch2-master
# 我本来在辛苦的手动编译着boost, 守着跳动的终端, 忽然灵光一现
# 找找看这玩意在系统里面有没有
# find / -type f -iname &amp;#34;libboost_system.a&amp;#34; 2&amp;gt;&amp;gt;/dev/null
# 果然有, 好激动, 死马当活马医
# 立马把RAPSearch2这货需要的几个静态链接库全扣过来
cp /usr/lib/x86_64-linux-gnu/libboost_system.a .
cp /usr/lib/x86_64-linux-gnu/libboost_chrono.a .
cp /usr/lib/x86_64-linux-gnu/libboost_serialization.a .
cp /usr/lib/x86_64-linux-gnu/libboost_thread.a .
# 见证奇迹的时刻
# 终于通过了
./install
&lt;/code>&lt;/pre>&lt;h2 id="the-end">THE END&lt;/h2>
&lt;p>此刻脑海里浮现出这么一副画面: 上学时百思不得其解的一道题, 忍不住一翻答案:&amp;quot;我靠, 怎么这么简单, 我TM怎么没想到! 啊啊啊...&amp;quot;
卒~&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>install ubuntu 16.04 on 3850x6 server</title><link>https://blog.ferstar.org/post/install-ubuntu-16/</link><guid isPermaLink="true">https://blog.ferstar.org/post/install-ubuntu-16/</guid><pubDate>Wed, 15 Jun 2016 14:52:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>这破机子开机自检一大堆, 得等好久, 完了按F12选择DVD驱动器启动&lt;/p>
&lt;p>安装过程没什么好讲的, 一路next&lt;/p>
&lt;h2 id="配置固定ip">配置固定IP&lt;/h2>
&lt;p>&lt;code>sudo vi /etc/network/interfaces&lt;/code>
网卡名称比较奇葩, 不再是&lt;code>ethx&lt;/code>&lt;/p>
&lt;pre tabindex="0">&lt;code># This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).
source /etc/network/interfaces.d/*
# The loopback network interface
auto lo
iface lo inet loopback
# The primary network interface
auto ens9f3
#iface ens9f3 inet dhcp
iface ens9f3 inet static
address 192.168.100.99
netmask 255.255.255.0
broadcast 192.168.100.255
network 192.168.100.0
gateway 192.168.100.1
&lt;/code>&lt;/pre>&lt;h2 id="挂载nfs">挂载nfs&lt;/h2>
&lt;p>&lt;code>sudo apt-get install nfs-common -y&lt;/code>
&lt;code>sudo systemctl start nfs-utils.service&lt;/code>
&lt;code>sudo systemctl enable nfs-utils.service&lt;/code>
&lt;code>sudo mkdir -p /media/ngs&lt;/code>
&lt;code>sudo chmod 777 /media/ngs&lt;/code>
&lt;code>sudo mount 192.168.100.98:/volume1/ngs /media/ngs&lt;/code>
开机挂载
&lt;code>sudo vi /etc/fstab&lt;/code>
增加内容
&lt;code>192.168.100.98:/volume1/ngs /media/ngs nfs defaults 0 0&lt;/code>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>fix surpi on biolinux8</title><link>https://blog.ferstar.org/post/fix-surpi-on-biolinux8-/</link><guid isPermaLink="true">https://blog.ferstar.org/post/fix-surpi-on-biolinux8-/</guid><pubDate>Mon, 13 Jun 2016 15:50:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>原有的部署脚本年久失修, 所以花了点时间修复下:&lt;/p>
&lt;ul>
&lt;li>pipeline:
surpi &lt;a href="https://github.com/ferstar/surpi">https://github.com/ferstar/surpi&lt;/a>&lt;/li>
&lt;li>what I have done:
&lt;a href="https://github.com/ferstar/surpi/commit/af6c8a830cb55444e82d973946c74548bef89c0f">https://github.com/ferstar/surpi/commit/af6c8a830cb55444e82d973946c74548bef89c0f&lt;/a>&lt;/li>
&lt;li>addition&lt;/li>
&lt;/ul>
&lt;ol>
&lt;li>SRA Toolkit
&lt;a href="http://www.ncbi.nlm.nih.gov/Traces/sra/sra.cgi?view=software">http://www.ncbi.nlm.nih.gov/Traces/sra/sra.cgi?view=software&lt;/a>&lt;/li>
&lt;li>aspera connect
A small test by using ascp&lt;/li>
&lt;/ol>
&lt;pre tabindex="0">&lt;code>ascp -T -i /home/ferstar/.aspera/connect/etc/asperaweb_id_dsa.openssh --host ftp-private.ncbi.nlm.nih.gov --user anonftp --mode recv /1GB ./
1GB 100% 1025MB 6.9Mb/s 08:18
Completed: 1049600K bytes transferred in 499 seconds
(17226K bits/sec), in 1 file.
&lt;/code>&lt;/pre>&lt;p>much more faster than traditional download tools such as curl and wget&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>python虚拟环境设置virtualenvwrapper</title><link>https://blog.ferstar.org/post/python%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83%E8%AE%BE%E7%BD%AE/</link><guid isPermaLink="true">https://blog.ferstar.org/post/python%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83%E8%AE%BE%E7%BD%AE/</guid><pubDate>Tue, 07 Jun 2016 11:42:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>神器级应用
文档在这里
&lt;a href="https://virtualenvwrapper.readthedocs.io/en/latest/">https://virtualenvwrapper.readthedocs.io/en/latest/&lt;/a>&lt;/p>
&lt;h2 id="简单使用">简单使用&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>创建虚拟环境管理目录&lt;/p>
&lt;pre tabindex="0">&lt;code>mkdir -p $HOME/.local/virtualenvs
&lt;/code>&lt;/pre>&lt;/li>
&lt;li>
&lt;p>在.bashrc中添加&lt;/p>
&lt;pre tabindex="0">&lt;code>export VIRTUALENV_USE_DISTRIBUTE=1 # 总是使用 pip/distribute
export WORKON_HOME=$HOME/.local/virtualenvs # 所有虚拟环境存储的目录
source $HOME/software/bin/virtualenvwrapper.sh
export PIP_VIRTUALENV_BASE=$WORKON_HOME
export PIP_RESPECT_VIRTUALENV=true
&lt;/code>&lt;/pre>&lt;/li>
&lt;li>
&lt;p>所有命令可以查看&lt;code>virtualenvwrapper --help&lt;/code>输出&lt;/p>
&lt;/li>
&lt;/ul></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>centos 6.x 升级python版本</title><link>https://blog.ferstar.org/post/centos-6/</link><guid isPermaLink="true">https://blog.ferstar.org/post/centos-6/</guid><pubDate>Tue, 07 Jun 2016 10:23:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>centos 6.x自带python版本是2.6.6, 实在太老, 需要稍微更新一下&lt;/p>
&lt;/blockquote>
&lt;h2 id="更新系统开发工具集">更新系统(开发工具集)&lt;/h2>
&lt;pre>&lt;code>yum -y update
yum groupinstall -y 'development tools'
&lt;/code>&lt;/pre>
&lt;h2 id="源码安装py2">源码安装py2&lt;/h2>
&lt;pre>&lt;code>wget https://www.python.org/ftp/python/2.7.11/Python-2.7.11.tar.xz
xz -d Python-2.7.11.tar.xz &amp;amp;&amp;amp; tar xvf Python-2.7.11.tar
&lt;/code>&lt;/pre>
&lt;h2 id="编译详情">编译详情&lt;/h2>
&lt;pre>&lt;code># 进入目录:
cd Python-2.7.11
# 运行配置 configure:
./configure --prefix=/home/ferstar/software
# 编译安装(机器有12个核心, 所以我加了-j12参数, 加速make过程):
make -j12
&lt;/code>&lt;/pre>
&lt;p>编译过程出现下面的错误&lt;/p>
&lt;blockquote>
&lt;p>Python build finished, but the necessary bits to build these modules were not found:
bsddb185 dl imageop sunaudiodev&lt;/p>
&lt;/blockquote>
&lt;p>Google一番发现这几个模块在centos上是不必要的, 所以可以忽略&lt;/p>
&lt;pre>&lt;code>make install
# 也可以使用 make altinstall命令安装, 这样在生成的python二进制文件末尾会带上版本号
# 环境变量
vi ~/.bashrc
export PATH=&amp;quot;$HOME/software:$PATH&amp;quot;
source ~/.bashrc
# 测试一下
python --version
# 正常显示
Python 2.7.11
&lt;/code>&lt;/pre>
&lt;h2 id="安装setuptools">安装setuptools&lt;/h2>
&lt;p>从这里下载源码
&lt;a href="https://pypi.python.org/pypi/setuptools#advanced-installation">https://pypi.python.org/pypi/setuptools#advanced-installation&lt;/a>&lt;/p>
&lt;pre>&lt;code>tar xvzf setuptools-22.0.5.tar.gz
cd setuptools-22.0.5
python setup.py install
&lt;/code>&lt;/pre>
&lt;h2 id="安装pip">安装pip&lt;/h2>
&lt;p>下载源码&lt;a href="https://pypi.python.org/pypi/pip">https://pypi.python.org/pypi/pip&lt;/a>&lt;/p>
&lt;pre>&lt;code>tar xvzf pip-8.1.2.tar.gz
cd pip-8.1.2
python setup.py install
&lt;/code>&lt;/pre>
&lt;h2 id="使用阿里镜像加速pip下载">使用阿里镜像加速pip下载&lt;/h2>
&lt;p>见&lt;a href="http://mirrors.aliyun.com/help/pypi">http://mirrors.aliyun.com/help/pypi&lt;/a>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>uefi 方式安装 Biolinux 时遇到的一个坑</title><link>https://blog.ferstar.org/post/the-grub-efi-amd64-signed-package-failed-to-install-into-target/</link><guid isPermaLink="true">https://blog.ferstar.org/post/the-grub-efi-amd64-signed-package-failed-to-install-into-target/</guid><pubDate>Thu, 26 May 2016 10:35:27 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>作为混迹 Linux 颇久的老司机一枚, 安装系统这种事情本不该是啥问题, 然而快安装完的时候出了个吐血的错误提示:&lt;/p>
&lt;blockquote>
&lt;p>the grub-efi-amd64-signed package failed to install into /target/. Without the GRUB bootloader the system will not load&lt;/p>
&lt;/blockquote>
&lt;p>真是囧到无极限啊, 直接连我 Windows 10 启动项也给干翻了. Google 发现这个问题在 12.04 时代是个 BUG, 但是我明明装的是 14.04.1(Biolinux 其实就是在 14.04 的基础上套了一堆生物信息学专用的软件包而已), 一定是哪里姿势不对, 一定是的&lt;/p>
&lt;p>于是仔细检查了一遍安装过程:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>BIOS 关闭 Security Boot&lt;/p>
&lt;/li>
&lt;li>
&lt;p>找一个 4G 多的U盘, 格式化为 FAT32 格式, 然后把 ISO 文件解压全复制进去&lt;/p>
&lt;/li>
&lt;li>
&lt;p>开机启动选择从U盘启动&lt;/p>
&lt;/li>
&lt;li>
&lt;p>选择 Try 但不 install&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>sudo umount -l /cdrom&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>一路 NEXT&lt;/p>
&lt;/li>
&lt;li>
&lt;p>EFI 分区使用 Windows 的就行, 网上说什么这个区放驱动啥的全是扯淡, 就几个引导文件, 不占地方, 给 100MB 够意思了, 不能再多&lt;/p>
&lt;/li>
&lt;li>
&lt;p>本来想图快, 所以全程断网安装(各种update包网速差的话等待时间很让人崩溃)&lt;/p>
&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>就是这个过程出了问题, ISO 里面带的 grub-efi* 相关的 package 不全, 需要联网下载, 我安装过程没有联网, 所以悲剧...&lt;/p>
&lt;/blockquote>
&lt;p>简直神坑啊, 坑我好久, 又是检查 ISO md5 又是查分区格式的, 不由得联想到曾经给某妹子远程解决电脑无法联网的问题, 折腾半天那头传来弱弱的一声: &amp;quot;不好意思, 电信发欠费提醒, 我们家网没费了...&amp;quot;&lt;/p>
&lt;p>卒~&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>键盘标准指法基准键位练习</title><link>https://blog.ferstar.org/post/correct-keyboard-finger-position/</link><guid isPermaLink="true">https://blog.ferstar.org/post/correct-keyboard-finger-position/</guid><pubDate>Sun, 31 Jan 2016 19:56:42 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>前几日入手的 HHKB 远没有想象中的那么好适应，归根结底是因为我一直以来的指法习惯是错误的——平时很少用到右手小指，所以贴几张关于正确指法的图，以作矫正。&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/png/2016/1/f875e5a03136a8680ceeccdab4274430.png" alt="标准指法基准键位示意图" title="标准指法基准键位示意图">&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/jpg/2016/1/9acd1f6ed08c3ce937814d4cfdda4137.jpg" alt="标准指法基准键位示意图2" title="标准指法基准键位示意图2">&lt;/p>
&lt;p>上面是普通键盘键位布局，而 HHKB 布局不同，如下：&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/jpg/2016/1/e37e7793e857fc0b71f60e83f321e4de.jpg" alt="HHKB Pro2 Layout Reference" title="HHKB Pro2 Layout Reference">&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/%E9%94%AE%E7%9B%98/">键盘</category></item><item><title>败入 HHKB 一把</title><link>https://blog.ferstar.org/post/new-year-gift-hhkb/</link><guid isPermaLink="true">https://blog.ferstar.org/post/new-year-gift-hhkb/</guid><pubDate>Sat, 30 Jan 2016 21:13:15 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>入手一把传说中的人生最后一把”机械“键盘：HHKB Pro2&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/jpg/2016/1/8c7235c9ee1ab8c61ddb67c746b7e64d.jpg" alt="HHKB" title="情怀键盘">&lt;/p>
&lt;p>键位略奇葩了点，不过熟悉了以后应该没啥问题，毕竟是 UNIX 键位的键盘，那么接下来就是缺个 Mac 了，然而买不起，也没必要。Ubuntu 用的飞起，暂不考虑。&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/%E9%94%AE%E7%9B%98/">键盘</category></item><item><title>Simiki-个人 wiki 搭建记录</title><link>https://blog.ferstar.org/post/personal-wiki-setup/</link><guid isPermaLink="true">https://blog.ferstar.org/post/personal-wiki-setup/</guid><pubDate>Sun, 24 Jan 2016 21:50:20 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;h2 id="simiki">Simiki&lt;/h2>
&lt;blockquote>
&lt;p>A simple wiki framework&lt;/p>
&lt;/blockquote>
&lt;p>官方的 &lt;a href="http://simiki.org/quickstart.html">Quick Start&lt;/a>
也有中文文档 &lt;a href="http://simiki.org/zh-docs/">http://simiki.org/zh-docs/&lt;/a>&lt;/p>
&lt;p>本来想在 Windows 系统上折腾，不过作者并不建议，而且我尝试后发觉实在好多坑，所以转向 Ubuntu 系统&lt;/p>
&lt;p>我用的是 Python 3.4.3，以下是大致操作记录&lt;/p>
&lt;ul>
&lt;li>
&lt;p>安装 simiki &lt;code>sudo pip3 install simiki&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>安装 ghp-import &lt;code>sudo pip3 install ghp-import&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>安装 fabric3 &lt;code>sudo pip3 install fabric3&lt;/code>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>不要用 fabric，并不支持 Python 3.x&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>
&lt;p>Github 新建一个&lt;code>repository&lt;/code>，假设名字叫 wiki&lt;/p>
&lt;/li>
&lt;li>
&lt;p>新建&lt;code>master&lt;/code>、&lt;code>gh-pages&lt;/code>两分支&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>clone&lt;/code>项目到本地目录，如 wiki&lt;/p>
&lt;/li>
&lt;li>
&lt;p>初始化 &lt;code>cd wiki &amp;amp;&amp;amp; simiki init&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>新建&lt;code>output&lt;/code>目录 &lt;code>mkdir output&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>域名绑定 新建&lt;code>CNAME&lt;/code>文件，内容为域名地址如：wiki.ferstar.org&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Generate &lt;code>simiki g&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Preview &lt;code>simiki p&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>发布内容到 Github &lt;code>fab cd&lt;/code>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>用我修改后的 &lt;a href="https://github.com/ferstar/wiki/blob/master/fabfile.py">fabfile.py&lt;/a> 替换原有才可以用上面的发布命令。
此指令作用类似&lt;code>hexo d -g&lt;/code>，将生成的静态页面内容推送到 Github Pages 分支&lt;code>gh-pages&lt;/code>，源文件配置等推送到 &lt;code>master&lt;/code>分支，以作备份。&lt;/p>
&lt;/blockquote></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/shell/">SHELL</category><category domain="https://blog.ferstar.org/tags/wiki/">WIKI</category></item><item><title>利器</title><link>https://blog.ferstar.org/post/liqi/</link><guid isPermaLink="true">https://blog.ferstar.org/post/liqi/</guid><pubDate>Thu, 21 Jan 2016 22:55:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;h2 id="介绍一下你自己和所做的工作">介绍一下你自己和所做的工作。&lt;/h2>
&lt;blockquote>
&lt;p>我是 ferstar，目前在一家生物技术公司工作，平时喜欢折腾操作系统及周边的东东&lt;/p>
&lt;/blockquote>
&lt;h2 id="你都在使用哪些硬件">你都在使用哪些硬件？&lt;/h2>
&lt;ol>
&lt;li>ThinkPad X220&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>X 系列最后一款沿用 IBM 经典键盘设计的机型，机身小巧，键盘手感上佳，便携性好。&lt;/p>
&lt;/blockquote>
&lt;p>出于对经典的（mei）情（qian）怀，这本子屏幕（IPS）、键盘、主板、内存（16 G）、硬盘（SSD + HDD）等都是我在淘宝单买所得，历时一月，总共花费不到 2000 ，拼装完毕后运行 Windows 10 跑的飞快，由衷感谢马老板。&lt;/p>
&lt;ol start="2">
&lt;li>&lt;del>iPhone 5c Verizon&lt;/del> iPhone 5se 国行 64 GB&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>5c退役给老娘当微信聊天器，于是入了“小钢炮”，手感还是不如5c，不过硬件水平跟6s相当，又是我习惯的尺寸，感觉挺好&lt;/p>
&lt;p>&lt;del>抛却逼格不谈，个人觉得 5c 的手感要比同期 5s 好些。万年 7.1.2 系统 + 越狱状态使用两年多，表现良好。&lt;/del>&lt;/p>
&lt;/blockquote>
&lt;ol start="3">
&lt;li>&lt;del>HTC ONE M8 Verizon&lt;/del> 红米4高配金&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>小钢炮升级系统后续航萎掉三分之一之多，于是在利器群法师安利下入此神机，续航简直不要太屌&lt;/p>
&lt;p>&lt;del>嗯，带 Version 明显是二手水货喽，我是看这货可以刷的包多如牛毛且价格也是跌到不能再跌的情况下入手，期间刷机无数，发现还是最初的 4.4.x 系统的续航表现要好些。&lt;/del>&lt;/p>
&lt;/blockquote>
&lt;ol start="4">
&lt;li>&lt;del>Kindle Paperwhite 2&lt;/del> Kindle乞丐版(白)&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>KPW2吃灰转卖后后悔，又入了一台。。。&lt;/p>
&lt;p>强迫自己看了些书，比如《最后一个匈奴》、《&lt;a href="https://www.amazon.cn/%E5%9B%BE%E4%B9%A6/dp/B016VW1I6U">《凤凰项目:一个IT运维的传奇故事》&lt;/a>》等&lt;/p>
&lt;p>&lt;del>日亚购得，这东西真是改变了我的阅读习惯，甚至莫名提升了视力水平——本来因为长期看手机姿势还有环境不健康的原因散光的左眼居然神奇的好了。&lt;/del>&lt;/p>
&lt;/blockquote>
&lt;ol start="5">
&lt;li>&lt;del>iPad mini 2&lt;/del> 三星SM-T900&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>买这个大板是打算看PDF的，然并卵，并没有看多少。。。&lt;/p>
&lt;p>&lt;del>某年参加某比赛所得奖品，刚开始还拿来看看 PDF，玩玩COC什么的，兴致一过基本长期吃灰，后来友情价转手。&lt;/del> 其实是扔给大侄子当玩具&lt;/p>
&lt;/blockquote>
&lt;ol start="6">
&lt;li>&lt;del>小米手环 1&lt;/del> 小米手环2&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>久坐提醒非常不错，配合安卓smart lock功能解锁手机非常方便&lt;/p>
&lt;p>&lt;del>来电或消息提醒很赞，还有支付宝绑定手环免密支付的功能不能再赞，剩下的就是这玩意检测睡眠简直就是一坨,完全测不准。&lt;/del>&lt;/p>
&lt;/blockquote>
&lt;ol start="7">
&lt;li>&lt;del>ASUS eeepc 1005HA&lt;/del> 已转卖&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>&lt;del>当年不知为何买的这货，现在孱弱到随便一个安卓机都可以把他秒到炸。卖也不值钱，于是我把他拆了，加装一块从闲鱼淘得的 4 口 PCI 网卡，摇身一变成软路由。现在出租屋充当流控路由中，功耗不到 5W，效果还不错，总算是物尽其用没有废掉。&lt;/del>&lt;/p>
&lt;/blockquote>
&lt;ol start="8">
&lt;li>&lt;del>派克威雅钢笔&lt;/del> 搬家丢失&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>&lt;del>这笔记得是三年级时舅舅送的，差不多快 20 年历史，本来以为搬家丢掉了，不曾想去年失而复得，清洗干净，上墨，书写依然流利，然而他主人的字却是烂到爆胎，不复以往。&lt;/del> 终于是丢了&lt;/p>
&lt;/blockquote>
&lt;ol start="9">
&lt;li>控客 WiFi 插座&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>配合newifi 1s路由刷openwrt固件，利用shariport-sync组建了局域网airport服务，把吃灰的有线音响整成无线也是成功的在GF面前装了下13&lt;/p>
&lt;p>&lt;del>这东西挺好用，电饭煲、热水器前面装一个，想开就开想关就关，节能环保。&lt;/del>&lt;/p>
&lt;/blockquote>
&lt;ol start="10">
&lt;li>Netgear R6300 V2&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>网件自家的固件向来垃圾，但这货换刷 Merlin 固件以后立马变身高富帅，无线信号强悍稳定，还有离线下载、时光机等功能加成，号称千元内最超值路由器。
&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/png/2016/1/7e0c7446d5939e02a19843170727cdc7.png" alt="梅林固件 web 配置界面一览" title="梅林固件 web 配置界面一览">&lt;/p>
&lt;/blockquote>
&lt;ol start="11">
&lt;li>折叠床&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>办公室午休必备，值得拥有！&lt;/p>
&lt;/blockquote>
&lt;ol start="12">
&lt;li>&lt;del>HHKB Pro2&lt;/del> 打算出掉&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>近乎无人不知无人不晓的码农神器，作为一个伪 VIM 党，着实垂涎好久。此前一直比较关注萌购上面的价格，然而后来对比了一下淘宝所谓奸商的价格其实并没有什么大的差别，于是果断剁手，速度比海淘快多了，不用苦等。到手试用两天，手感确实没得说，虽然键位略显奇葩，不过适应以后果然很酸爽。&lt;/p>
&lt;/blockquote>
&lt;ol start="13">
&lt;li>ikbc C-87 cherry 茶轴&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>工作关系IDE环境使用居多，所以HHKB没有F区总感觉怪怪的，于是在京东6.18剁了这货，手感还行，就是略重。。。&lt;/p>
&lt;/blockquote>
&lt;h2 id="软件呢">软件呢？&lt;/h2>
&lt;ol>
&lt;li>石墨&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>跟 Google Docs 差不多的功能，墙内用户无奈的选择，用来分享编辑文档还是很棒的&lt;/p>
&lt;/blockquote>
&lt;ol start="2">
&lt;li>瀑布IM&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>主打团队沟通，可以接入很多应用和服务，目前团队在用这个，虽然偶尔抽风，不过瑕不掩瑜，产品反馈回复很及时。&lt;/p>
&lt;/blockquote>
&lt;ol start="3">
&lt;li>Tower&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>团队项目协作工具，号称获得红杉资本领投，处于不缺钱状态。据说团队内部是采取远程办公的方式，真是令人羡慕。&lt;/p>
&lt;/blockquote>
&lt;ol start="4">
&lt;li>阻止运行 / 绿色守护&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>这两个放在一起说，安卓流氓全家桶系列毒瘤软件众多，谷歌没法治只能自己治，当然手机 ROOT 后这个组合的表现才会更强力，另外组织运行需要 ROOT 手机后额外安装 Xposed 框架才可以正常使用。&lt;/p>
&lt;/blockquote>
&lt;ol start="5">
&lt;li>锤子便签 / iOS 备忘&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>碎碎念或者灵光一现什么的都可以马上记下来并同步到云端，没有别的胡里花哨的功能。锤子还可以发长图到微博，方便快捷。&lt;/p>
&lt;/blockquote>
&lt;ol start="6">
&lt;li>为知笔记&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>弃印象的原因很简单，到现在都没有原生支持 Markdown，而为知笔记支持，同样付费用户的流量也是为知笔记要多得多。&lt;/p>
&lt;/blockquote>
&lt;ol start="7">
&lt;li>Pocket&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>稍后阅读，原来是配合印象使用的，现在弃印象转投为知笔记后这软件也很少用了。&lt;/p>
&lt;/blockquote>
&lt;ol start="8">
&lt;li>Print Pro&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>iOS 专属，类似安卓5.x以后才有的 Google 云打印，支持的打印机型号蛮多的。&lt;/p>
&lt;/blockquote>
&lt;ol start="9">
&lt;li>扫描全能王&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>当你需要复印资料而手头打印机没有复印功能的时候，这软件就可以发挥作用了，经过特殊处理出来的片子跟复印没啥大的区别，文案人士应急必备。&lt;/p>
&lt;/blockquote>
&lt;ol start="10">
&lt;li>Shadowsocks&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>社会主义好！&lt;/p>
&lt;/blockquote>
&lt;ol start="11">
&lt;li>随手记&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>用友旗下的一款产品，类似的记账软件很多，用这玩意虽然不会让钱变多，但至少可以知道自己把钱花哪里。&lt;/p>
&lt;/blockquote>
&lt;ol start="12">
&lt;li>洋葱&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>Google 验证器的马甲，用来提升账户密码安全很有必要。&lt;/p>
&lt;/blockquote>
&lt;ol start="13">
&lt;li>QQ同步助手&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>小马哥的这个软件还是很良心的，方便我等刷机狂魔备份恢复联系人资料。&lt;/p>
&lt;/blockquote>
&lt;ol start="14">
&lt;li>百度脑图&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>就是在线画思维导图的，我是零客户端倾向，能在浏览器里搞定的事情，坚决不下客户端，碰巧，虽然他是百 du 产品，但已满足我偶尔想画画脑图的骚包需求，何不一试？&lt;/p>
&lt;/blockquote>
&lt;ol start="15">
&lt;li>Xshell / Xftp / Xmanager三件套&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>可能是 Windows 平台上最好的一套虚拟终端（桌面）套装，虽然偶尔也会用下 WinSCP / PuTTY 的组合。&lt;/p>
&lt;/blockquote>
&lt;ol start="16">
&lt;li>BatchShell&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>一款基于SSH2的批量文件传输及命令执行工具，国人编写，好评甚多。&lt;/p>
&lt;/blockquote>
&lt;ol start="17">
&lt;li>LastPass&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>有人说他不安全，但我好像没受到什么影响，所以，继续用吧，谁叫年纪大了记不住密码呢。&lt;/p>
&lt;/blockquote>
&lt;h2 id="你最理想的工作环境是什么">你最理想的工作环境是什么？&lt;/h2>
&lt;blockquote>
&lt;p>有几个志同道合，最好还比自己技高一筹的优秀同事，有一个无烟无酒无太大杂音的工位，当然最重要的是要有网且够快，要是哪一天『柏林墙』倒掉那就更好了。&lt;/p>
&lt;/blockquote>
&lt;h2 id="你平时获得工作灵感的方式有哪些">你平时获得工作灵感的方式有哪些？&lt;/h2>
&lt;blockquote>
&lt;p>逛逛知乎、简书、微博、朋友圈什么的，痛饮几碗『鸡汤』，再拿张能写的纸，画画脑图，说不定灵感就会从天灵盖上喷出来。如果是周末，那就先睡，睡饱了才有力气干活。&lt;/p>
&lt;/blockquote>
&lt;h2 id="推荐一件生活中的利器给大家">推荐一件生活中的利器给大家。&lt;/h2>
&lt;blockquote>
&lt;p>『A4 纸 + 笔』再加 Kindle，每次静心阅读过后需要用最快的速度捕捉稍纵即逝的灵感，虽然大多数『然并卵』，但至少可以骄傲的说：『俺没让她从指尖溜走！』&lt;/p>
&lt;/blockquote>
&lt;h2 id="利器社群计划">利器社群计划&lt;/h2>
&lt;p>本文参与了「利器社群计划」，发现更多创造者和他们的工具：&lt;a href="http://liqi.io/community/">liqi.io&lt;/a>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/%E5%88%A9%E5%99%A8/">利器</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/%E7%94%B5%E8%84%91/">电脑</category><category domain="https://blog.ferstar.org/tags/%E6%89%8B%E6%9C%BA/">手机</category></item><item><title>Odroid ROS镜像封装记录</title><link>https://blog.ferstar.org/post/make-odroid-ros-img-with-swap-partition-support/</link><guid isPermaLink="true">https://blog.ferstar.org/post/make-odroid-ros-img-with-swap-partition-support/</guid><pubDate>Thu, 17 Dec 2015 13:58:38 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>棒子的这板子比树莓派2犀利了那么一点, 具体型号是&lt;code>odroid-XU4&lt;/code>&lt;/p>
&lt;h2 id="备份镜像">备份镜像&lt;/h2>
&lt;p>查看内存卡分区&lt;/p>
&lt;pre tabindex="0">&lt;code>df -h
Filesystem Size Used Avail Use% Mounted on
/dev/sdb2 14G 5.9G 7.7G 44% /media/ferstar/trusty
/dev/sdb1 129M 5.1M 124M 4% /media/ferstar/BOOT
&lt;/code>&lt;/pre>&lt;p>备份&lt;/p>
&lt;pre tabindex="0">&lt;code>sudo dd if=/dev/sdb of=~/odroid/o_ros.img
&lt;/code>&lt;/pre>&lt;p>md5&lt;/p>
&lt;pre tabindex="0">&lt;code>md5sum o_ros.img &amp;gt; o_ros.img.md5sum
&lt;/code>&lt;/pre>&lt;h2 id="修改分区">修改分区&lt;/h2>
&lt;p>均使用&lt;code>gparted&lt;/code>工具完成操作&lt;/p>
&lt;h3 id="添加swap">添加swap&lt;/h3>
&lt;p>&lt;code>sudo gparted /dev/sdb&lt;/code>如图&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/png/2015/12/c15a5e9d656e25f165fc8a59315d47e3.png" alt="分区概览">&lt;/p>
&lt;p>缩小根分区, 留2G给swap&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/png/2015/12/3175234083078b49ffed03ec3c09ab4f.png" alt="缩小根分区">&lt;/p>
&lt;p>建立swap分区&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/png/2015/12/dc42631e1bf2c7400011b39d72fad3cd.png" alt="建立swap分区">&lt;/p>
&lt;h3 id="更改根分区格式f2fs">更改根分区格式(f2fs)&lt;/h3>
&lt;p>同样操作, 动动鼠标而已, 只是gparted对f2fs支持不是很完美, 格式化完成后分区显示不正常
如图
&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/png/2015/12/54316ff659ae38fbf35ae530a38525d9.png" alt="整个分区细节">&lt;/p>
&lt;h3 id="恢复原分区内容">恢复原&lt;code>/&lt;/code>分区内容&lt;/h3>
&lt;p>挂载之前备份的镜像&lt;code>o_ros.img&lt;/code>&lt;/p>
&lt;p>检查镜像信息&lt;/p>
&lt;pre tabindex="0">&lt;code>fdisk -l o_ros.img
Disk o_ros.img: 14.5 GiB, 15523119104 bytes, 30318592 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x000c4046
Device Boot Start End Sectors Size Id Type
o_ros.img1 3072 266239 263168 128.5M 6 FAT16
o_ros.img2 266240 30317568 30051329 14.3G 83 Linux
&lt;/code>&lt;/pre>&lt;p>挂载此镜像&lt;code>/&lt;/code>分区&lt;/p>
&lt;pre tabindex="0">&lt;code>mkdir root
sudo mount -o loop,offset=136314880 o_ros.img root
# 其中偏移量(offset)是根据上面镜像信息的起点(266240)乘以单元数(512)得到
&lt;/code>&lt;/pre>&lt;p>拷贝所有&lt;code>/&lt;/code>内容到新的f2fs分区&lt;/p>
&lt;pre tabindex="0">&lt;code>mkdir f2fs
sudo mount /dev/sdb2 f2fs
sudo cp -a root/* f2fs
# 注意 -a 这个参数必须要加上
&lt;/code>&lt;/pre>&lt;h2 id="配置分区参数">配置分区参数&lt;/h2>
&lt;p>查看UUID
&lt;code>sudo blkid /dev/sdb*&lt;/code>&lt;/p>
&lt;pre tabindex="0">&lt;code>/dev/sdb: PTUUID=&amp;#34;000c4046&amp;#34; PTTYPE=&amp;#34;dos&amp;#34;
/dev/sdb1: SEC_TYPE=&amp;#34;msdos&amp;#34; LABEL=&amp;#34;BOOT&amp;#34; UUID=&amp;#34;6E35-5356&amp;#34; TYPE=&amp;#34;vfat&amp;#34; PARTUUID=&amp;#34;000c4046-01&amp;#34;
/dev/sdb2: UUID=&amp;#34;b1aa5440-7e59-40d1-ab11-0b9659ca3210&amp;#34; TYPE=&amp;#34;f2fs&amp;#34; PARTUUID=&amp;#34;000c4046-02&amp;#34;
/dev/sdb3: LABEL=&amp;#34;swap&amp;#34; UUID=&amp;#34;a6e99b01-86d1-4615-a2e0-fc424a452cd8&amp;#34; TYPE=&amp;#34;swap&amp;#34; PARTUUID=&amp;#34;000c4046-03&amp;#34;
&lt;/code>&lt;/pre>&lt;p>更改&lt;code>fstab&lt;/code>&lt;/p>
&lt;pre tabindex="0">&lt;code># UNCONFIGURED FSTAB FOR BASE SYSTEM
# UUID=e139ce78-9841-40fe-8823-96a304a09859 / ext4 errors=remount-ro,noatim
UUID=b1aa5440-7e59-40d1-ab11-0b9659ca3210 / f2fs errors=remount-ro,defaults,noatime,discard 0 1
UUID=6E35-5356 /media/boot vfat defaults,rw,owner,flush,umask=000 0 0
UUID=a6e99b01-86d1-4615-a2e0-fc424a452cd8 swap swap defaults 0 0
tmpfs /tmp tmpfs nodev,nosuid,mode=1777 0 0
&lt;/code>&lt;/pre>&lt;p>更改&lt;code>boot.ini&lt;/code>&lt;/p>
&lt;p>&lt;code>root=UUID&lt;/code>部分替换为格式化后的新&lt;code>uuid=b1aa5440-7e59-40d1-ab11-0b9659ca3210&lt;/code>&lt;/p>
&lt;h2 id="tf卡插入重启看效果">tf卡插入重启看效果&lt;/h2>
&lt;p>杯具了~~~系统一跪不起, 查了下文档, odroid kenerl还没加入&lt;code>f2fs&lt;/code>的驱动支持, 顿时感到世界深深的恶意...&lt;/p>
&lt;p>还好有备份, 刷回云云不提&lt;/p>
&lt;h2 id="备份备份备份说三遍">备份备份备份说三遍...&lt;/h2></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/odroid/">ODROID</category><category domain="https://blog.ferstar.org/tags/ros/">ROS</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>Odroidxu3/4_building_kernel</title><link>https://blog.ferstar.org/post/xu3-4-building-kernel/</link><guid isPermaLink="true">https://blog.ferstar.org/post/xu3-4-building-kernel/</guid><pubDate>Thu, 17 Dec 2015 11:55:14 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;h2 id="introduction">Introduction&lt;/h2>
&lt;p>This page introduce how you can download and compile the Linux system kernel for ODROID-XU3/XU4. Generic Linux system needs gcc version 4.6 to build the Kernel.&lt;/p>
&lt;h2 id="step-by-step-guide-to-building-an-odroid-xu34-kernel">Step-by-Step guide to building an ODROID-XU3/4 Kernel&lt;/h2>
&lt;h3 id="download-the-cross-tool-chain-package">Download the cross tool chain package&lt;/h3>
&lt;p>&lt;a href="http://dn.odroid.com/ODROID-XU/compiler/arm-eabi-4.6.tar.gz">http://dn.odroid.com/ODROID-XU/compiler/arm-eabi-4.6.tar.gz&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>Note:&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;blockquote>
&lt;p>This toolchain only used to build the kernel.
This toolchain is included in the Android source package. ($ANDROID_ROOT/prebuilts/gcc/linux-x86/arm/arm-eabi-4.6)
Copy the cross tool package to /opt/toolchains&lt;/p>
&lt;/blockquote>
&lt;/blockquote>
&lt;blockquote>
&lt;p>If the '/opt/toolchains' directory does not exist in host pc, then create the directory.&lt;/p>
&lt;/blockquote>
&lt;pre tabindex="0">&lt;code>$ sudo mkdir /opt/toolchains
$ sudo cp arm-eabi-4.6.tar.gz /opt/toolchains
$ cd /opt/toolchains
$ sudo tar zxvf arm-eabi-4.6.tar.gz
&lt;/code>&lt;/pre>&lt;h3 id="uncompress-the-cross-tool-with-tar-command">Uncompress the cross tool with tar command&lt;/h3>
&lt;pre tabindex="0">&lt;code>$ cd /opt/toolchains
$ sudo tar xvfz arm-eabi-4.6.tar.gz
&lt;/code>&lt;/pre>&lt;h3 id="add-path-in-your-environment-file">Add Path in your environment file&lt;/h3>
&lt;p>Modify your ~/.bashrc(or ~/.zshrc if you use zsh as your default shell) file to add a new path with editor (gedit or vi)&lt;/p>
&lt;pre tabindex="0">&lt;code>export ARCH=arm
export PATH=${PATH}:/opt/toolchains/arm-eabi-4.6/bin
export CROSS_COMPILE=arm-eabi-
&lt;/code>&lt;/pre>&lt;h3 id="to-apply-this-change-login-again-or-restart-the-bashrc">To apply this change, login again or restart the .bashrc&lt;/h3>
&lt;p>&lt;code>$ source ~/.bashrc&lt;/code>&lt;/p>
&lt;h3 id="check-the-tool-chain-path-to-see-if-it-is-set-up-correctly-or-not">Check the tool-chain path to see if it is set up correctly or not.&lt;/h3>
&lt;pre tabindex="0">&lt;code>$ arm-eabi-gcc -v
Using built-in specs.
COLLECT_GCC=arm-eabi-gcc
COLLECT_LTO_WRAPPER=/opt/toolchain/arm-eabi-4.6/bin/../libexec/gcc/arm-eabi/4.6.x-google/lto-wrapper
Target: arm-eabi
Configured with: /tmp/android-15472/src/build/../gcc/gcc-4.6/configure --prefix=/usr/local --target=arm-eabi --host=x86_64-linux-gnu
--build=x86_64-linux-gnu --with-gnu-as --with-gnu-ld --enable-languages=c,c++ --with-gmp=/tmp/android-15472/obj/temp-install --with-
mpfr=/tmp/android-15472/obj/temp-install --with-mpc=/tmp/android-15472/obj/temp-install --without-ppl --without-cloog --disable-libs
sp --enable-threads --disable-nls --disable-libmudflap --disable-libgomp --disable-libstdc__-v3 --disable-sjlj-exceptions --disable-
shared --disable-tls --disable-libitm --with-float=soft --with-fpu=vfp --with-arch=armv5te --enable-target-optspace --with-abi=aapcs
--with-gcc-version=4.6 --with-binutils-version=2.21 --with-gmp-version=4.2.4 --with-mpfr-version=2.4.1 --with-gdb-version=7.3.x --w
ith-arch=armv5te --with-sysroot=/tmp/android-15472/install/sysroot --with-prefix=/tmp/android-15472/install --with-gold-version=2.21
--enable-gold --disable-gold --disable-multilib --program-transform-name=&amp;#39;s&amp;amp;^&amp;amp;arm-eabi-&amp;amp;&amp;#39;
Thread model: single
gcc version 4.6.x-google 20120106 (prerelease) (GCC)
&lt;/code>&lt;/pre>&lt;h2 id="linux-odroid-xu34-works-as-follow">Linux ODROID-XU3/4 works as follow&lt;/h2>
&lt;h3 id="it-must-have-at-least-two-partitions">It must have at least two partitions&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>First Partition must be a FAT32/EXT4 partition.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Second Partition can be whatever the Filesystem that your kernel supports (must be built in).&lt;/p>
&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>Note: It is possible to use the first partition as ext4, however its strongly not recommended due to Windows Users lost the capability of changing boot.ini&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>Partition Contents&lt;/li>
&lt;/ul>
&lt;pre tabindex="0">&lt;code>Partition 1:
Kernel Image (zImage)
boot.scr
exynos5422-odroidxu3.dtb
uInitrd (if applicable)
Partition 2:
rootfs (a.k.a. File System)
Currently Supported Linux Distributions
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>Ubuntu 14.04 &lt;a href="http://forum.odroid.com/viewtopic.php?f=95&amp;amp;t=5985">Ubuntu 14.04 Forum Thread&lt;/a>&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>Note: More distribution support will come with time.&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>
&lt;p>HDMI Support On Linux
HDMI support should work out-of-box for everyone including framebuffer console if you experience any issue please contact us on the ODROID Forums
On the provided Ubuntu image there are several examples on how to configure the HDMI to your specific resolution or even lock to a certain resolution. You can check the configuration file on /media/boot/boot.ini of the Ubuntu Image&lt;/p>
&lt;/li>
&lt;li>
&lt;p>DisplayPort Support on Linux
For displayport configuration please follow this guide Displayport Guide on &lt;a href="http://forum.odroid.com/">ODROID Forums&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Kernel Sources
Kernel sources for ODROID-XU3/4 is on our &lt;a href="http://github.com/hardkernel/linux">Github&lt;/a>. Branch is &lt;strong>odroidxu3-3.10.y&lt;/strong> defconfig is &lt;strong>odroidxu3_defconfig&lt;/strong>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="kernel-rebuild-guide">Kernel Rebuild Guide&lt;/h2>
&lt;blockquote>
&lt;p>Note:
You can compile &lt;strong>kernel &amp;amp; dtb&lt;/strong> images in host PC using the cross compiler. But, you cannot create &lt;strong>uInitrd ramdisk image&lt;/strong> in host PC. Because the binary files in ramdisk image refer to current root file system during the executing &lt;code>update-initramfs&lt;/code> command.&lt;/p>
&lt;/blockquote>
&lt;p>Please follow the instructions below to rebuild the Linux Kernel for ODROID. Those instructions cover native build of the Kernel.&lt;/p>
&lt;h3 id="install-dependencies">Install dependencies&lt;/h3>
&lt;pre tabindex="0">&lt;code>pc@host:~$ sudo apt-get install build-essential libqt4-dev libncurses5-dev git
Clone Repo:
pc@host:~$ git clone --depth 1 https://github.com/hardkernel/linux.git -b odroidxu3-3.10.y odroidxu3-3.10.y
pc@host:~$ cd odroidxu3-3.10.y
&lt;/code>&lt;/pre>&lt;h3 id="configure-kernel">Configure Kernel&lt;/h3>
&lt;pre tabindex="0">&lt;code>pc@host:~$ make odroidxu3_defconfig
&lt;/code>&lt;/pre>&lt;h3 id="do-changes-if-you-needwant">Do changes if you need/want&lt;/h3>
&lt;pre tabindex="0">&lt;code>pc@host:~$ make menuconfig
&lt;/code>&lt;/pre>&lt;p>for my case, the official kernel can not recognise my &lt;strong>Logitech, Inc. F710 Wireless Gamepad&lt;/strong>, so I have to change it by myself:
&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/png/2015/12/310876d095ef89355a35de54838acad9.png" alt="内核定义">&lt;/p>
&lt;p>I alse changed the kernel default resolution to fit my 7' touchscreen:
&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/png/2015/12/3ad91156dcea84a78dab3f5643ea2832.png" alt="分辨率修改">&lt;/p>
&lt;h3 id="build-kernel-and-modules">Build Kernel and Modules&lt;/h3>
&lt;pre tabindex="0">&lt;code>pc@host:~$ make -j8
&lt;/code>&lt;/pre>&lt;blockquote>
&lt;p>This explanation assume that your USB memory CARD reader is assigned at /dev/sdb. Be careful!&lt;/p>
&lt;/blockquote>
&lt;h3 id="install-zimage--dtb-file">Install zImage &amp;amp; DTB file&lt;/h3>
&lt;pre tabindex="0">&lt;code>pc@host:~$ mkdir -p mount
pc@host:~$ sudo mount /dev/sdb1 ./mount
pc@host:~$ sudo cp arch/arm/boot/zImage arch/arm/boot/dts/exynos5422-odroidxu3.dtb /media/boot &amp;amp;&amp;amp; sync &amp;amp;&amp;amp; sudo umount ./mount
&lt;/code>&lt;/pre>&lt;h3 id="install-modules">Install Modules&lt;/h3>
&lt;pre tabindex="0">&lt;code>pc@host:~$ sudo mount /dev/sdb2 ./mount
pc@host:~$ sudo make modules_install ARCH=arm INSTALL_MOD_PATH=./mount
&lt;/code>&lt;/pre>&lt;h3 id="copy-config-to-boot-for-initramfs-creation">Copy .config to /boot for initramfs creation&lt;/h3>
&lt;pre tabindex="0">&lt;code>pc@host:~$ sudo cp .config ./mount/boot/config-`make kernelrelease`
&lt;/code>&lt;/pre>&lt;blockquote>
&lt;p>You must do the remaining steps in &lt;strong>ODROID-XU3/4 board&lt;/strong>. So plugin your tf card to odroid and boot it, then continue the following steps.&lt;/p>
&lt;/blockquote>
&lt;h3 id="create-initramfs">Create initramfs&lt;/h3>
&lt;pre tabindex="0">&lt;code>odroid@odroid:~$ sudo update-initramfs -c -k `uname -r`
&lt;/code>&lt;/pre>&lt;h3 id="create-uinitrd">Create uInitrd&lt;/h3>
&lt;pre tabindex="0">&lt;code>odroid@odroid:~$ sudo mkimage -A arm -O linux -T ramdisk -C none -a 0 -e 0 -n uInitrd -d /boot/initrd.img-`uname -r` /boot/uInitrd-`uname -r`
&lt;/code>&lt;/pre>&lt;h3 id="install-new-uinitrd">Install new uInitrd&lt;/h3>
&lt;pre tabindex="0">&lt;code>odroid@odroid:~$ sudo cp /boot/uInitrd-`uname -r` /media/boot/uInitrd
&lt;/code>&lt;/pre>&lt;h3 id="reboot-and-check-if-the-kernel-works-well-on-your-board">reboot and check if the kernel works well on your board&lt;/h3>
&lt;p>&lt;code>odroid@odroid:~$ sudo sync &amp;amp;&amp;amp; reboot&lt;/code>&lt;/p>
&lt;p>Your new kernel should be installed.&lt;/p>
&lt;h2 id="odroid-utility">ODROID Utility&lt;/h2>
&lt;p>Note for your own convenience we provide daily builds of Linux kernel that can be easily installed on Supported distros by using a ODROID Utility.&lt;/p>
&lt;pre tabindex="0">&lt;code>odroid@odroid:~$ sudo -s
root@odroid:~$ wget -O /usr/local/bin/odroid-utility.sh https://raw.githubusercontent.com/mdrjr/odroid-utility/master/odroid-utility.sh
root@odroid:~$ chmod +x /usr/local/bin/odroid-utility.sh
root@odroid:~$ odroid-utility.sh
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>unix 中 umask 是什么？(转)</title><link>https://blog.ferstar.org/post/what-is-umask-in-unix/</link><guid isPermaLink="true">https://blog.ferstar.org/post/what-is-umask-in-unix/</guid><pubDate>Wed, 02 Dec 2015 20:02:03 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>转自:&lt;a href="http://blog.csdn.net/xxd851116/article/details/9722127">http://blog.csdn.net&lt;/a>&lt;/p>
&lt;p>以前在用ftp的时候一直懵懵懂懂，不知所以然。最近遇到ftp上传问题，文件无法上传。查了很多资料终于弄明白了。
要知道umask是什么，必须先要了解unix的权限是怎么设计的。了解这个对我们平时做业务系统的权限设计有很好的参考作用。&lt;/p>
&lt;h2 id="unix权限">unix权限&lt;/h2>
&lt;p>一直崇拜uinx的权限设计
曾经有同事问我，用二进制到底怎么实现权限控制。我曾经回答过，似乎对方不是太明白。趁此总结一下。&lt;/p>
&lt;p>unix按三类群体设计权限，分别是：&lt;/p>
&lt;blockquote>
&lt;p>1、所有者权限
2、组权限
3、公共权限&lt;/p>
&lt;/blockquote>
&lt;p>Unix有组的概念，觉得设计的不错，WEB系统设计可以参考这种设计模式。&lt;/p>
&lt;p>某个文件（或目录）的上面三种权限可以通过一个非常简洁的表达式来展现。例如：&lt;/p>
&lt;blockquote>
&lt;p>rwxr-xr-x&lt;/p>
&lt;/blockquote>
&lt;p>它仅仅只有9个字符，每3个作为一组（rwx r-x r-x），依次分别表示所有者权限、组权限和公共权限。每组内r、w、x分别表示了文件在该用户群体中的读、写、执行权限（- 表示无权限）。&lt;/p>
&lt;p>字符的运算速度远比数字慢，为了表达这种表达式，设计师用了二进制来表示。由于二进制只有两种状态：0和1，恰好能表示事物互斥的两种特性“有”和“无”，“开”和“关”等。（javascript中就是用0和1来表示boolean型对象的值）&lt;/p>
&lt;p>我们知道，计算机中表示数据量的最小单位是“bit”，中文名称叫“比特”，我习惯称“位”。8位组成一个“Byte”，即“字节”。1024个“Byte”就是一个K的“Byte”，通常所写成“KB”。因此有下面的表达式：&lt;/p>
&lt;blockquote>
&lt;p>1Byte = 8bit
1KB = 1024Byte = 8 * 1024bit
1MB = 1024KB&lt;/p>
&lt;/blockquote>
&lt;p>那在计算机中，如何表示一个字符呢？&lt;/p>
&lt;p>如果我不知道字符编码我会这样做：把所有的字符都列出来，用序号表示，1表示a，2表示b，以此类推......然后再把序号转换成计算机可识别的二进制。好像是可以的。但是这样这个世界就乱了。因此字符编码产生了，它的作用就是指定计算机的“比特”和字符的映射关系。&lt;/p>
&lt;p>不同的字符编码对字符占用的的“比特”宽度是不一样的。标准ASCII字符编码规定了1个字符占用8个“比特”，即1个字节。&lt;/p>
&lt;p>如果这种权限表达式“rwxr-xr-x”用字符作存储，则需要 9 * 8 bit = 72 bit。&lt;/p>
&lt;p>这种设计在当今硬盘不值钱的年代，当然无关紧要，但你要知道unix是什么时候诞生的，那个时候存储的价格可谓天价，也因此造就了一种艺术性的设计。&lt;/p>
&lt;p>1、对于某个群体对象来说，具有三种操作：读r、写w、执行x。
2、每个操作用一个“比特”来表示，1表示具有该权限，0表示不具有该权限。&lt;/p>
&lt;p>所以：&lt;/p>
&lt;blockquote>
&lt;p>- - - = 000 = 0
- - x = 001 = 1
- w - = 010 = 2
- w x = 011 = 3
r - - = 100 = 4
r - x = 101 = 5
r w - = 110 = 6
r w x = 111 = 7&lt;/p>
&lt;/blockquote>
&lt;p>原来，这是充分利用了“最小单位”。其中的哲学在于“一个多选项如何用一个数字来表示”。&lt;/p>
&lt;p>至此，某个群体的权限可以使用数字来表示。&lt;/p>
&lt;p>下面是在aix6.1中用“ls -l”命令后显示的内容：&lt;/p>
&lt;blockquote>
&lt;p>drwxr-xr-x 5 root system 256 Jul 11 17:51 WEB-INF
-rw-r--r-- 1 root system 1392 Jul 11 17:51 index.jsp&lt;/p>
&lt;/blockquote>
&lt;p>1、第1列前有一个“d”或“-”，“d”表示这是一个目录，“-”表示不是目录。后面9位就是权限表达式了。
2、第2列表示文件硬链接的数目。
3、第3列“root”表示该文件的所有者，默认是该文件的创建者（当然，也可以通过chown修改所有者）。
4、第4列“system”表示该文件的群组，默认是该文件是创建者所在的群组（当然，也可以通过chgrp修改群组）。
5、第5列就是表示该文件的“字节”大小。
6、第6列表示创建时间。
7、第7列就是文件（或目录）名了。&lt;/p>
&lt;h2 id="umask含义">umask含义&lt;/h2>
&lt;p>umask指文件权限的掩码。它是从权限中“拿走”相应的“位”（即bit）,且文件创建时不能赋予执行权限。
可以去百度百科了解下更多信息：&lt;a href="http://baike.baidu.com/view/1867757.htm">http://baike.baidu.com/view/1867757.htm&lt;/a>&lt;/p>
&lt;p>您可以输入命令来查询当前系统的umask值：&lt;/p>
&lt;pre tabindex="0">&lt;code># umask
022
#
&lt;/code>&lt;/pre>&lt;p>这就表示，除了我之外（组成员和其他人）没有写（-w- = 010）权限。其实就是对“位”的“取反”。&lt;/p>
&lt;p>这种设计的好处在于，在创建文件的时候有掩码帮助您初始化默认权限，不用每次都去指定这个文件的权限。
“022”也是一般unix系统默认的掩码值。&lt;/p>
&lt;p>接下来创建文件（或目录）时，新创建的文件（或目录）的权限就是“755”。&lt;/p>
&lt;h2 id="ftp中的umask值的作用">FTP中的umask值的作用&lt;/h2>
&lt;p>aix中可以通过修改文件“/etc/inetd.conf”中ftp一行：
&lt;code>ftp stream tcp6 nowait root /usr/sbin/ftpd ftpd&lt;/code>&lt;/p>
&lt;p>将该行修改为：
&lt;code>ftp stream tcp6 nowait root /usr/sbin/ftpd ftpd -u xxx&lt;/code>
其中：“xxx”即掩码值。&lt;/p>
&lt;p>它用来初始化ftp上传的文件默认的权限。&lt;/p>
&lt;p>例如：
&lt;code>ftp stream tcp6 nowait root /usr/sbin/ftpd ftpd -u 022&lt;/code>&lt;/p>
&lt;p>ftp上传的文件的默认权限将是“755”，即其他人不给“写”权限。&lt;/p>
&lt;p>（完）。&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>利用vsftp搭建ftp服务器(匿名可上传)</title><link>https://blog.ferstar.org/post/vsftp-server/</link><guid isPermaLink="true">https://blog.ferstar.org/post/vsftp-server/</guid><pubDate>Wed, 02 Dec 2015 19:22:44 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;h2 id="配置文件">配置文件&lt;/h2>
&lt;p>&lt;code>cat /etc/vsftpd/vsftpd.conf | grep -v ^#&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">anonymous_enable&lt;/span>&lt;span class="o">=&lt;/span>YES &lt;span class="c1"># 使能匿名&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">local_enable&lt;/span>&lt;span class="o">=&lt;/span>YES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">write_enable&lt;/span>&lt;span class="o">=&lt;/span>YES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">local_umask&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">022&lt;/span> &lt;span class="c1"># 本地用户的umask值&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">anon_upload_enable&lt;/span>&lt;span class="o">=&lt;/span>YES &lt;span class="c1"># 使匿名用户可上传&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">anon_mkdir_write_enable&lt;/span>&lt;span class="o">=&lt;/span>YES &lt;span class="c1"># 匿名用户可以对目录进行写操作&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">anon_root&lt;/span>&lt;span class="o">=&lt;/span>/home/ftp &lt;span class="c1"># 匿名用户home目录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">anon_other_write_enable&lt;/span>&lt;span class="o">=&lt;/span>YES &lt;span class="c1"># 赋予匿名用户更多权限, 如删除重命名文件/夹的能力&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">anon_umask&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">022&lt;/span> &lt;span class="c1"># 匿名用户的umask值&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">dirmessage_enable&lt;/span>&lt;span class="o">=&lt;/span>YES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">xferlog_enable&lt;/span>&lt;span class="o">=&lt;/span>YES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">connect_from_port_20&lt;/span>&lt;span class="o">=&lt;/span>YES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">xferlog_std_format&lt;/span>&lt;span class="o">=&lt;/span>YES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">idle_session_timeout&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">600&lt;/span> &lt;span class="c1"># 空闲时间&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">data_connection_timeout&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">120&lt;/span> &lt;span class="c1"># 超时时间&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">ftpd_banner&lt;/span>&lt;span class="o">=&lt;/span>Welcome to TARSBOT&lt;span class="err">&amp;#39;&lt;/span>s FTP server!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">listen&lt;/span>&lt;span class="o">=&lt;/span>YES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">listen_ipv6&lt;/span>&lt;span class="o">=&lt;/span>NO
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">pam_service_name&lt;/span>&lt;span class="o">=&lt;/span>vsftpd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">userlist_enable&lt;/span>&lt;span class="o">=&lt;/span>YES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">tcp_wrappers&lt;/span>&lt;span class="o">=&lt;/span>YES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">use_localtime&lt;/span>&lt;span class="o">=&lt;/span>YES &lt;span class="c1"># 使用本地时间代替UTC&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="使用">使用&lt;/h2>
&lt;p>重启服务
&lt;code>service vsftpd restart&lt;/code>&lt;/p>
&lt;p>关闭selinux服务&lt;/p>
&lt;h2 id="问题记录">问题记录&lt;/h2>
&lt;ul>
&lt;li>主要记录下匿名用户上传文件无法下载的问题
默认配置文件中只有&lt;code>local_umask=022&lt;/code>的选项, 这也是一般unix系统默认的umask值, 他决定了用户新建文件/夹的权限. 默认文件权限是666, 文件夹是777, 减去umask值即默认权限, 文件644/文件夹755. 实际测试发现匿名用户上传的文件权限变成了600, 也就是说其他群组用户是不具备任何权限的, 怪不得无法下载, 同时也得出默认vsftpd服务对匿名用户的umask值是066, 略狠, 所以为了让匿名用户上传的文件可被下载, 我们需要修改匿名用户的umask值, 在vsftp中控制此项的设置为&lt;code>anon_umask=022&lt;/code>, 重启服务后即可发现匿名用户可以正常上传下载文件了&lt;/li>
&lt;/ul></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>使用七牛云存储创建自己的图床,用于写博客</title><link>https://blog.ferstar.org/post/qiniu4blog/</link><guid isPermaLink="true">https://blog.ferstar.org/post/qiniu4blog/</guid><pubDate>Mon, 16 Nov 2015 23:16:33 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>如题，静态博客图片等多媒体资源需要有个窝，目前在用七牛，看到有人写了&lt;code>qiniu4blog&lt;/code>，蛮好用的，拿来小改了下，以适应个人需求&lt;/p>
&lt;ul>
&lt;li>
&lt;p>fork from：
&lt;a href="https://github.com/bluesky4485/qiniu4blog">https://github.com/bluesky4485/qiniu4blog&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>source：
&lt;a href="https://github.com/wzyuliyang/qiniu4blog">https://github.com/wzyuliyang/qiniu4blog&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>modified：
&lt;a href="https://github.com/ferstar/qiniu4blog">https://github.com/ferstar/qiniu4blog&lt;/a>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="使用流程">使用流程&lt;/h2>
&lt;ol>
&lt;li>启动脚本监控指定文件夹
&lt;code>qiniu4blog&lt;/code>&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>配置文件&lt;code>qiniu.cfg&lt;/code>放在～目录下，注意监控目录路径需要指明绝对路径，自定义地址后面不要漏&lt;code>/&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;ol start="2">
&lt;li>
&lt;p>使用任意截图工具将截图保存到指定监控目录&lt;/p>
&lt;/li>
&lt;li>
&lt;p>剪贴板即可生成图片地址
&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/png/2015/11/8b265710971e64014657a9788f0b99dc.png" alt="DeepinScrot-2442.png">&lt;/p>
&lt;/li>
&lt;/ol></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>grep和find命令常用方式</title><link>https://blog.ferstar.org/post/grep%E5%92%8Cfind%E5%91%BD%E4%BB%A4%E5%B8%B8%E7%94%A8%E6%96%B9%E5%BC%8F/</link><guid isPermaLink="true">https://blog.ferstar.org/post/grep%E5%92%8Cfind%E5%91%BD%E4%BB%A4%E5%B8%B8%E7%94%A8%E6%96%B9%E5%BC%8F/</guid><pubDate>Mon, 16 Nov 2015 23:04:43 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>find和grep的使用权限是&lt;strong>所有用户&lt;/strong>&lt;/p>
&lt;h2 id="find命令的作用是在目录中根据文件名搜索文件">find命令的作用是在目录中根据文件名搜索文件&lt;/h2>
&lt;p>find 列出当前目录及其子目录的所有文件和文件夹的完整路径。
find -name Help.java 在当前目录及其子目录中搜索文件名为Help.java的文件。
find . -name Help.java 在当前目录及其子目录中搜索文件名为Help.java的文件(同上)。
find / -name Help.java 在整个硬盘中搜索文件名为Help.java的文件。
find -perm 755 在当前目录及其子目录中查找指定权限的文件
find -type b 在当前目录及其子目录下查找块设备文件。
find -type d 在当前目录及其子目录下查文件夹。
find -type c 在当前目录及其子目录下查找字符设备文件。
find -type p 在当前目录及其子目录下查找管道文件。
find -type l 在当前目录及其子目录下查找符号链接文件。
find -type f 在当前目录及其子目录下查找普通文件。
find -type d -exec ls -l {} ; 查找当前目录及其子目录下的文件夹，并将查找结果以ls -l的方式展现。
find -type d -ok rm -rf {} ;查找当前目录及其子目录下的文件夹，并将查找结果依次执行rm -rf命令，但是在执行命令前会有确认提示。&lt;/p>
&lt;h2 id="grep命令的作用是在目录中根据文件内容搜索文件">grep命令的作用是在目录中根据文件内容搜索文件&lt;/h2>
&lt;p>grep Clock * 查找当前目录下的所有文件中包含Clock字符串的文件，不查找子目录
grep -r Clock * 查找当前目录下的所有文件中包含Clock字符串的文件，查找子目录
grep -nr Clock * 查找当前目录下的所有文件中包含Clock字符串的文件，查找子目录，并显示行号&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/shell/">SHELL</category></item><item><title>i++ &amp; ++i效率</title><link>https://blog.ferstar.org/post/i++-++i%E6%95%88%E7%8E%87/</link><guid isPermaLink="true">https://blog.ferstar.org/post/i++-++i%E6%95%88%E7%8E%87/</guid><pubDate>Sun, 27 Sep 2015 21:48:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>偶然又看到关于&lt;code>i++ &amp;amp; ++i&lt;/code>哪个运行效率高低的讨论, 发现蛮有趣的, 记录下:&lt;/p>
&lt;h2 id="举个栗子">举个栗子&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-C" data-lang="C">&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">MAX_SIZE&lt;/span> &lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span> &lt;span class="p">...}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这种写法常见于各类语法速成书籍中, 循环范围不大的情况下, 效率问题似乎并不需要考虑; 但如果&lt;code>MAX_SIZE&lt;/code>太大, 效率问题就会比较明显了.
就字面意思而言&lt;/p>
&lt;ul>
&lt;li>++i 先将i+1, 然后再使用i的值, 放在循环里会比i++少一个循环 MAX_SIZE&lt;/li>
&lt;li>i++ &lt;strong>先使用i的值, 然后再对i+1&lt;/strong>, 放在循环里会比++i多一个循环 MAX_SIZE + 1&lt;/li>
&lt;/ul>
&lt;p>因此在迭代的时候, ++i比i++好, 省去了中间生成无名临时对象的构建过程&lt;/p>
&lt;h2 id="网上流行的经典分析">网上流行的经典分析&lt;/h2>
&lt;h3 id="1-从高级层面上解释">1. 从高级层面上解释&lt;/h3>
&lt;p>++i 是i=i+1,表达式的值就是i本身
i++ 也是i=i+1,但表达式的值是加1前的副本，由于要先保存副本，因此效率低一些。
对于C/C++内置类型而言，大部分编译器会做优化，因此效率没什么区别。但在自定义类型上，就未必有优化，++i 效率会高一些。&lt;/p>
&lt;h3 id="2-从底层汇编来看内置类型">2. 从底层汇编来看内置类型&lt;/h3>
&lt;p>int a,i=0; a=++i;汇编代码如下：&lt;/p>
&lt;pre tabindex="0">&lt;code>int a,i=0;
01221A4E mov dword ptr [i],0
a=++i;
01221A55 mov eax,dword ptr [i]
01221A58 add eax,1
01221A5B mov dword ptr [i],eax
01221A5E mov ecx,dword ptr [i]
01221A61 mov dword ptr [a],ecx
&lt;/code>&lt;/pre>&lt;p>int a,i=0; a=i++;汇编代码如下：&lt;/p>
&lt;pre tabindex="0">&lt;code>int a,i=0;
009E1A4E mov dword ptr [i],0
a=i++;
009E1A55 mov eax,dword ptr [i]
009E1A58 mov dword ptr [a],eax
009E1A5B mov ecx,dword ptr [i]
009E1A5E add ecx,1
009E1A61 mov dword ptr [i],ecx
&lt;/code>&lt;/pre>&lt;p>从上述汇编代码可以看到，对于内置类型，它们的执行数目是一样的，效率没有差别。而自定义类型中由于并不清楚编译器是否针对这一操作做优化, 所以最好是使用++i而不是i++。&lt;/p>
&lt;h3 id="3-从重载运算符来看自定义类型">3. 从重载运算符来看自定义类型&lt;/h3>
&lt;pre tabindex="0">&lt;code>Operator Operator::operator++()
{
++value; //内部成员变量
return *this;
}
Operator Operator::operator++(int)
{
Operator temp;
temp.value=value; //多了一个保存临时对象的操作
value++;
return temp;
}
&lt;/code>&lt;/pre>&lt;p>从上面代码可以看出，后置++多了一个保存临时对象的操作，因此效率自然低一些。&lt;/p>
&lt;h2 id="总结">总结&lt;/h2>
&lt;p>对于C/C++内置类型，两者的效率差别不大(编译器会自动优化)；
对于自定义的类而言，++i 的效率更高一些。&lt;/p>
&lt;h2 id="python怎么处理自增运算的">Python怎么处理自增运算的&lt;/h2>
&lt;p>Python doesn't support ++, but you can do:
&lt;code>number += 1&lt;/code>
壮哉我大python...&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>python数据分析</title><link>https://blog.ferstar.org/post/python%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/</link><guid isPermaLink="true">https://blog.ferstar.org/post/python%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/</guid><pubDate>Thu, 24 Sep 2015 22:30:28 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>直接放码：&lt;/p>
&lt;blockquote>
&lt;p>现在可以只执行一次就可以把&lt;code>text&lt;/code>目录下所有符合条件的文件数据格式化输出到&lt;code>excel&lt;/code>里面，不符合的文件会有提示，程序并不会中断&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;span class="lnt">107
&lt;/span>&lt;span class="lnt">108
&lt;/span>&lt;span class="lnt">109
&lt;/span>&lt;span class="lnt">110
&lt;/span>&lt;span class="lnt">111
&lt;/span>&lt;span class="lnt">112
&lt;/span>&lt;span class="lnt">113
&lt;/span>&lt;span class="lnt">114
&lt;/span>&lt;span class="lnt">115
&lt;/span>&lt;span class="lnt">116
&lt;/span>&lt;span class="lnt">117
&lt;/span>&lt;span class="lnt">118
&lt;/span>&lt;span class="lnt">119
&lt;/span>&lt;span class="lnt">120
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="ch">#!/usr/bin/env python3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">os&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">os.path&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">sys&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">re&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">xlwt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">get_file_list&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">root_dir&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 获得指定目录下所有文件路径，返回一个包含路径集合的列表&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">file_list&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">parent&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">dirnames&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">filenames&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">walk&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">root_dir&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">filename&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">filenames&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">peer_path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">parent&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">filename&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">file_list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">peer_path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">file_list&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">split_on_separators&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">original&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">separators&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 以特定字符为标记，分隔已知字符串为列表&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 这个是用正则实现的，可能不满足要求&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># return filter(lambda x:x.strip(), re.split(r&amp;#34;[%s]&amp;#34; % separators, original))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">original&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">sep&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">separators&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">temp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">r&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">temp&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">extend&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">filter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">lambda&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strip&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="n">r&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sep&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">temp&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">result&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">change_data_type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pattern&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">list&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 格式化数据类型&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;r&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">pf_file&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">line_result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">pf_file&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">readline&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">column&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">split_on_separators&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">line_result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pattern&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span> &lt;span class="ne">Exception&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="si">%s&lt;/span>&lt;span class="s1"> not found!&amp;#39;&lt;/span> &lt;span class="o">%&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># print(column, type(column), len(column))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;r&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">pf_file&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">column&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">time0&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">float&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">column&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">file_line&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">pf_file&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">readlines&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">file_result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">split_on_separators&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file_line&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pattern&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">time&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">float&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file_result&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">time0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rssi&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file_result&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file_result&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">epc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file_result&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">:])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">my_list&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">my_list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">my_list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rssi&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">my_list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">my_list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">epc&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">my_list&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">column&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">file_line&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">pf_file&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">readlines&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">file_result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">split_on_separators&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file_line&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pattern&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rssi&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file_result&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file_result&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">epc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file_result&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">:])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">my_list&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">my_list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rssi&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">my_list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">my_list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">epc&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">my_list&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">column&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">file_line&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">pf_file&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">readlines&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">file_result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">split_on_separators&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file_line&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pattern&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rssi&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file_result&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file_result&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">my_list&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">my_list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rssi&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">my_list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">count&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">my_list&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;我不认识这个文件：&lt;/span>&lt;span class="si">%s&lt;/span>&lt;span class="s1">！&amp;#39;&lt;/span> &lt;span class="o">%&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># list = []&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># sys.exit(1)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nb">list&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">print_into_excel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">list&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">excel&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 将处理后的数据写入excel中，行列自适应&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">list&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="p">[]:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">wb&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">xlwt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Workbook&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ws&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">wb&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">add_sheet&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;ferstar&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">heading_xf&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">xlwt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">easyxf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;font: bold on; align: wrap on, vert centre, horiz center&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rowx&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ws&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set_panes_frozen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ws&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set_horz_split_pos&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rowx&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ws&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set_remove_splits&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">row&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">enumerate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">list&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">j&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">col&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">enumerate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ws&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">j&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">col&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#ws.col(0).width = 256 * max([len(row[0]) for row in list])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">wb&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">save&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">excel&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">loop_files&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rootdir&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">string_pattern&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 遍历指定目录下所有文件数据，输出excel到上级目录中&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">log_files&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">get_file_list&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rootdir&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">log_file&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">log_files&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">total_list&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">excel_file&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">split_on_separators&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">log_file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;/.&amp;#34;&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s1">&amp;#39;.xls&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">data&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">change_data_type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">log_file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">string_pattern&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">total_list&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># print(excel_file, log_file)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">print_into_excel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">excel_file&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="vm">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;__main__&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;text&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pattern&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;-,&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">loop_files&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pattern&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span> &lt;span class="ne">Exception&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;oops, error happened!&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>RFID数据分析</title><link>https://blog.ferstar.org/post/rfid%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/</link><guid isPermaLink="true">https://blog.ferstar.org/post/rfid%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/</guid><pubDate>Tue, 22 Sep 2015 20:54:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>&lt;code>log&lt;/code>文件内容类似&lt;/p>
&lt;pre tabindex="0">&lt;code>-12,788
-11,889
-12,788
-12,788
-12,788
&lt;/code>&lt;/pre>&lt;p>脚本作用: 把&lt;code>log&lt;/code>文件内数据拆分成两列输出到&lt;code>excel&lt;/code>中供数据分析&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="ch">#!/usr/bin/env python3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">sys&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">re&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">xlwt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">split_on_separators&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">original&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">separators&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 这个是用正则实现的，可能不满足要求&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># return filter(lambda x:x.strip(), re.split(r&amp;#34;[%s]&amp;#34; % separators, original))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">original&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">sep&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">separators&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">temp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">r&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">temp&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">extend&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">filter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">lambda&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strip&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="n">r&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sep&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">temp&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">result&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">change_data_type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pattern&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">list&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 转换数据类型, 并交换时间和信号强度位置&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pf_file&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;r&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span> &lt;span class="ne">Exception&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="si">%s&lt;/span>&lt;span class="s1"> not found!&amp;#39;&lt;/span> &lt;span class="o">%&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">file_line&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">pf_file&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">readlines&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">file_result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">split_on_separators&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file_line&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pattern&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">file_result&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">time&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file_result&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rssi&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file_result&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">my_list&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">my_list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">my_list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rssi&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">my_list&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nb">list&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">print_into_excel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">list&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">excel&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file_name&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">wb&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">xlwt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Workbook&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ws&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">wb&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">add_sheet&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;ferstar&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">heading_xf&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">xlwt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">easyxf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;font: bold on; align: wrap on, vert centre, horiz center&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rowx&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ws&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set_panes_frozen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ws&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set_horz_split_pos&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rowx&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ws&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set_remove_splits&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">row&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">enumerate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">list&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">j&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">col&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">enumerate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ws&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">j&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">col&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#ws.col(0).width = 256 * max([len(row[0]) for row in list])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">wb&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">save&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">excel&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">log_file&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;log&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">total_list&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">string_pattern&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;,&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">excel_file&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">log_file&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s1">&amp;#39;.xls&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">data&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">change_data_type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">log_file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">string_pattern&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">total_list&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">print_into_excel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">excel_file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">log_file&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>python3基础语法回顾</title><link>https://blog.ferstar.org/post/python3%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95%E5%9B%9E%E9%A1%BE/</link><guid isPermaLink="true">https://blog.ferstar.org/post/python3%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95%E5%9B%9E%E9%A1%BE/</guid><pubDate>Fri, 18 Sep 2015 10:17:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;h1 id="python3基础语法回顾">python3基础语法回顾&lt;/h1>
&lt;h2 id="python保留字">python保留字&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">keyword&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">keyword&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">kwlist&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;False&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;None&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;True&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;and&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;as&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;assert&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;break&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;class&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;continue&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;def&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;del&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;elif&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;else&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;except&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;finally&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;for&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;from&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;global&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;if&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;import&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;in&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;is&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;lambda&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;nonlocal&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;not&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;or&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;pass&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;raise&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;return&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;try&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;while&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;with&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;yield&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="注释">注释&lt;/h2>
&lt;p>python中单行注释以#开头，多行注释用三个单引号或者三个双引号将注释括起来。&lt;/p>
&lt;h2 id="行与缩进">行与缩进&lt;/h2>
&lt;p>python最具特色的就是使用缩进来表示代码快。缩进的空格数是可以变化的，但同一代码块的语句必须包含同样的缩进空格数。&lt;/p>
&lt;blockquote>
&lt;p>注：一般是4个空格一缩进&lt;/p>
&lt;/blockquote>
&lt;h2 id="数据类型">数据类型&lt;/h2>
&lt;p>python中数有四种类型：整数int、长整数、浮点数和复数&lt;/p>
&lt;blockquote>
&lt;p>注：查看某一数据类型可以使用type(xxx)查看&lt;/p>
&lt;/blockquote>
&lt;h2 id="字符串">字符串&lt;/h2>
&lt;p>python中单引号和双引号使用完全相同&lt;/p>
&lt;p>使用三引号可以制定一个多行字符串&lt;/p>
&lt;h2 id="转义符-">转义符 \&lt;/h2>
&lt;p>自然字符串，通过在字符串前加r或者R。&lt;/p>
&lt;p>python允许处理unicode字符串，加前缀u或者U&lt;/p>
&lt;p>字符串是不可变的。&lt;/p>
&lt;p>按字面意思级联字符串，如&amp;quot;this&amp;quot; &amp;quot;is&amp;quot; &amp;quot;string&amp;quot;会被自动转换为this is string。&lt;/p>
&lt;h2 id="python基本数据类型">python基本数据类型&lt;/h2>
&lt;p>python中变量不需要声明。每个变量在使用前必须赋值，变量赋值后才会被创建。&lt;/p>
&lt;p>python中变量即是变量，没有类型。此处所说的类型是变量所在的内存中对象的类型。&lt;/p>
&lt;h3 id="python3中有6个标准的数据类型">python3中有6个标准的数据类型：&lt;/h3>
&lt;ol>
&lt;li>
&lt;p>Numbers 数字&lt;/p>
&lt;ul>
&lt;li>
&lt;p>支持int、float、boot、complex复数&lt;/p>
&lt;/li>
&lt;li>
&lt;p>数值运算： &lt;strong>+ 加法 - 减法 *乘法 / 除法，得到浮点数 // 除法，得到一个整数，即取整 % 取余 ** 乘方&lt;/strong>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>python可以同时为多个变量赋值， 如a, b=1, 2&lt;/p>
&lt;/li>
&lt;li>
&lt;p>一个变量可以通过赋值指向不同类型的对象&lt;/p>
&lt;/li>
&lt;li>
&lt;p>混合计算时，python会把整形转换为浮点数&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>String 字符串&lt;/p>
&lt;p>python中的字符串str用单引号或者双引号括起来，同时使用反斜杠转义特殊字符。如果不想让反斜杠发生转义，可以在字符串前面添加一个r表示原始字符串&lt;/p>
&lt;p>另外反斜杠也可以作为续行符，表示下一行是上一行的延续，也可以使用''' '''或&amp;quot;&amp;quot;&amp;quot; &amp;quot;&amp;quot;&amp;quot;跨越多行。&lt;/p>
&lt;p>字符串可以使用 + 运算符串连接在一起，或者使用 * 运算符重复：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;str&amp;#39;&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="s1">&amp;#39;ing&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;my&amp;#39;&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">string&lt;/span> &lt;span class="n">mymymy&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Python中的字符串有两种索引方式，第一种是从左往右，从0开始依次增加；第二种是从右往左，从-1开始依次减少&lt;/p>
&lt;blockquote>
&lt;p>注意，没有单独的字符类型，一个字符就是长度为1的字符串。&lt;/p>
&lt;/blockquote>
&lt;p>还可以对字符串进行切片，获取一段子串。用冒号分隔两个索引，形式位变量[头下标:尾下标]。&lt;/p>
&lt;p>截取范围是前闭后开的，两个索引都可以省略&lt;/p>
&lt;p>python中的字符串不能被改变&lt;/p>
&lt;/li>
&lt;li>
&lt;p>List 列表&lt;/p>
&lt;p>List（列表） 是 Python 中使用最频繁的数据类型。&lt;/p>
&lt;p>列表是写在方括号之间、用逗号分隔开的元素列表。列表中元素的类型可以不相同：&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; a = [&amp;#39;him&amp;#39;, 25, 100, &amp;#39;her&amp;#39;]
&amp;gt;&amp;gt;&amp;gt; print(a)[&amp;#39;him&amp;#39;, 25, 100, &amp;#39;her&amp;#39;]
&lt;/code>&lt;/pre>&lt;p>和字符串一样，列表同样可以被索引和切片，列表被切片后返回一个包含所需元素的新列表。详细的在这里就不赘述了。&lt;/p>
&lt;p>列表还支持串联操作，使用+操作符：&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; a = [1, 2, 3, 4, 5]
&amp;gt;&amp;gt;&amp;gt; a + [6, 7, 8][1, 2, 3, 4, 5, 6, 7, 8]
&lt;/code>&lt;/pre>&lt;p>与Python字符串不一样的是，列表中的元素是可以改变的：&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; a = [1, 2, 3, 4, 5, 6]
&amp;gt;&amp;gt;&amp;gt; a[0] = 9
&amp;gt;&amp;gt;&amp;gt; a[2:5] = [13, 14, 15]
&amp;gt;&amp;gt;&amp;gt; a[9, 2, 13, 14, 15, 6]
&amp;gt;&amp;gt;&amp;gt; a[2:5] = [] # 删除
&amp;gt;&amp;gt;&amp;gt; a[9, 2, 6]
&lt;/code>&lt;/pre>&lt;p>List内置了有很多方法，例如append()、pop()等等，这在后面会讲到。&lt;/p>
&lt;p>注意：&lt;/p>
&lt;ol>
&lt;li>List写在方括号之间，元素用逗号隔开。&lt;/li>
&lt;li>和字符串一样，list可以被索引和切片。&lt;/li>
&lt;li>List可以使用+操作符进行拼接。&lt;/li>
&lt;li>List中的元素是可以改变的。&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>
&lt;p>Tuple 元组&lt;/p>
&lt;p>元组（tuple）与列表类似，不同之处在于元组的元素不能修改。元组写在小括号里，元素之间用逗号隔开。&lt;/p>
&lt;p>元组中的元素类型也可以不相同：&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; a = (1991, 2014, &amp;#39;physics&amp;#39;, &amp;#39;math&amp;#39;)
&amp;gt;&amp;gt;&amp;gt; print(a, type(a), len(a))(1991, 2014, &amp;#39;physics&amp;#39;, &amp;#39;math&amp;#39;) &amp;lt;class &amp;#39;tuple&amp;#39;&amp;gt; 4
&lt;/code>&lt;/pre>&lt;p>元组与字符串类似，可以被索引且下标索引从0开始，也可以进行截取/切片（看上面，这里不再赘述）。&lt;/p>
&lt;p>其实，可以把字符串看作一种特殊的元组。&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; tup = (1, 2, 3, 4, 5, 6)
&amp;gt;&amp;gt;&amp;gt; print(tup[0], tup[1:5])1 (2, 3, 4, 5)
&amp;gt;&amp;gt;&amp;gt; tup[0] = 11 # 修改元组元素的操作是非法的
&lt;/code>&lt;/pre>&lt;p>虽然tuple的元素不可改变，但它可以包含可变的对象，比如list列表。&lt;/p>
&lt;p>构造包含0个或1个元素的tuple是个特殊的问题，所以有一些额外的语法规则：&lt;/p>
&lt;p>tup1 = () # 空元组tup2 = (20,) # 一个元素，需要在元素后添加逗号&lt;/p>
&lt;p>另外，元组也支持用+操作符：&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; tup1, tup2 = (1, 2, 3), (4, 5, 6)
&amp;gt;&amp;gt;&amp;gt; print(tup1+tup2)(1, 2, 3, 4, 5, 6)
&lt;/code>&lt;/pre>&lt;p>string、list和tuple都属于sequence（序列）。&lt;/p>
&lt;p>注意：&lt;/p>
&lt;ol>
&lt;li>与字符串一样，元组的元素不能修改。&lt;/li>
&lt;li>元组也可以被索引和切片，方法一样。&lt;/li>
&lt;li>注意构造包含0或1个元素的元组的特殊语法规则。&lt;/li>
&lt;li>元组也可以使用+操作符进行拼接。&lt;/li>
&lt;/ol>
&lt;p>元组（tuple）与列表类似，不同之处在于元组的元素不能修改。元组写在小括号里，元素之间用逗号隔开。&lt;/p>
&lt;p>元组中的元素类型也可以不相同：&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; a = (1991, 2014, &amp;#39;physics&amp;#39;, &amp;#39;math&amp;#39;)
&amp;gt;&amp;gt;&amp;gt; print(a, type(a), len(a))(1991, 2014, &amp;#39;physics&amp;#39;, &amp;#39;math&amp;#39;) &amp;lt;class &amp;#39;tuple&amp;#39;&amp;gt; 4
&lt;/code>&lt;/pre>&lt;p>元组与字符串类似，可以被索引且下标索引从0开始，也可以进行截取/切片（看上面，这里不再赘述）。&lt;/p>
&lt;p>其实，可以把字符串看作一种特殊的元组。&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; tup = (1, 2, 3, 4, 5, 6)
&amp;gt;&amp;gt;&amp;gt; print(tup[0], tup[1:5])1 (2, 3, 4, 5)&amp;gt;&amp;gt;&amp;gt; tup[0] = 11 # 修改元组元素的操作是非法的
&lt;/code>&lt;/pre>&lt;p>虽然tuple的元素不可改变，但它可以包含可变的对象，比如list列表。&lt;/p>
&lt;p>构造包含0个或1个元素的tuple是个特殊的问题，所以有一些额外的语法规则：&lt;/p>
&lt;p>tup1 = () # 空元组tup2 = (20,) # 一个元素，需要在元素后添加逗号&lt;/p>
&lt;p>另外，元组也支持用+操作符：&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; tup1, tup2 = (1, 2, 3), (4, 5, 6)
&amp;gt;&amp;gt;&amp;gt; print(tup1+tup2)(1, 2, 3, 4, 5, 6)
&lt;/code>&lt;/pre>&lt;p>string、list和tuple都属于sequence（序列）。&lt;/p>
&lt;p>注意：&lt;/p>
&lt;ol>
&lt;li>与字符串一样，元组的元素不能修改。&lt;/li>
&lt;li>元组也可以被索引和切片，方法一样。&lt;/li>
&lt;li>注意构造包含0或1个元素的元组的特殊语法规则。&lt;/li>
&lt;li>元组也可以使用+操作符进行拼接。&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>
&lt;p>Sets 集合&lt;/p>
&lt;p>集合（set）是一个无序不重复元素的集。&lt;/p>
&lt;p>基本功能是进行成员关系测试和消除重复元素。&lt;/p>
&lt;p>可以使用大括号 或者 set()函数创建set集合，注意：创建一个空集合必须用 set() 而不是 { }，因为{ }是用来创建一个空字典。&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; student = {&amp;#39;Tom&amp;#39;, &amp;#39;Jim&amp;#39;, &amp;#39;Mary&amp;#39;, &amp;#39;Tom&amp;#39;, &amp;#39;Jack&amp;#39;, &amp;#39;Rose&amp;#39;}
&amp;gt;&amp;gt;&amp;gt; print(student) # 重复的元素被自动去掉{&amp;#39;Jim&amp;#39;, &amp;#39;Jack&amp;#39;, &amp;#39;Mary&amp;#39;, &amp;#39;Tom&amp;#39;, &amp;#39;Rose&amp;#39;}
&amp;gt;&amp;gt;&amp;gt; &amp;#39;Rose&amp;#39; in student # membership testing（成员测试）True
&amp;gt;&amp;gt;&amp;gt; # set可以进行集合运算...
&amp;gt;&amp;gt;&amp;gt; a = set(&amp;#39;abracadabra&amp;#39;)
&amp;gt;&amp;gt;&amp;gt; b = set(&amp;#39;alacazam&amp;#39;)
&amp;gt;&amp;gt;&amp;gt; a{&amp;#39;a&amp;#39;, &amp;#39;b&amp;#39;, &amp;#39;c&amp;#39;, &amp;#39;d&amp;#39;, &amp;#39;r&amp;#39;}
&amp;gt;&amp;gt;&amp;gt; a - b # a和b的差集{&amp;#39;b&amp;#39;, &amp;#39;d&amp;#39;, &amp;#39;r&amp;#39;}
&amp;gt;&amp;gt;&amp;gt; a | b # a和b的并集{&amp;#39;l&amp;#39;, &amp;#39;m&amp;#39;, &amp;#39;a&amp;#39;, &amp;#39;b&amp;#39;, &amp;#39;c&amp;#39;, &amp;#39;d&amp;#39;, &amp;#39;z&amp;#39;, &amp;#39;r&amp;#39;}
&amp;gt;&amp;gt;&amp;gt; a &amp;amp; b # a和b的交集{&amp;#39;a&amp;#39;, &amp;#39;c&amp;#39;}&amp;gt;&amp;gt;&amp;gt; a ^ b # a和b中不同时存在的元素{&amp;#39;l&amp;#39;, &amp;#39;m&amp;#39;, &amp;#39;b&amp;#39;, &amp;#39;d&amp;#39;, &amp;#39;z&amp;#39;, &amp;#39;r&amp;#39;}
&lt;/code>&lt;/pre>&lt;/li>
&lt;li>
&lt;p>Dictionaries 字典&lt;/p>
&lt;p>字典（dictionary）是Python中另一个非常有用的内置数据类型。&lt;/p>
&lt;p>字典是一种映射类型（mapping type），它是一个无序的键 : 值对集合。&lt;/p>
&lt;p>关键字必须使用不可变类型，也就是说list和包含可变类型的tuple不能做关键字。&lt;/p>
&lt;p>在同一个字典中，关键字还必须互不相同。&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; dic = {} # 创建空字典
&amp;gt;&amp;gt;&amp;gt; tel = {&amp;#39;Jack&amp;#39;:1557, &amp;#39;Tom&amp;#39;:1320, &amp;#39;Rose&amp;#39;:1886}
&amp;gt;&amp;gt;&amp;gt; tel{&amp;#39;Tom&amp;#39;: 1320, &amp;#39;Jack&amp;#39;: 1557, &amp;#39;Rose&amp;#39;: 1886}
&amp;gt;&amp;gt;&amp;gt; tel[&amp;#39;Jack&amp;#39;] # 主要的操作：通过key查询1557
&amp;gt;&amp;gt;&amp;gt; del tel[&amp;#39;Rose&amp;#39;] # 删除一个键值对
&amp;gt;&amp;gt;&amp;gt; tel[&amp;#39;Mary&amp;#39;] = 4127 # 添加一个键值对
&amp;gt;&amp;gt;&amp;gt; tel{&amp;#39;Tom&amp;#39;: 1320, &amp;#39;Jack&amp;#39;: 1557, &amp;#39;Mary&amp;#39;: 4127}
&amp;gt;&amp;gt;&amp;gt; list(tel.keys()) # 返回所有key组成的list[&amp;#39;Tom&amp;#39;, &amp;#39;Jack&amp;#39;, &amp;#39;Mary&amp;#39;]
&amp;gt;&amp;gt;&amp;gt; sorted(tel.keys()) # 按key排序[&amp;#39;Jack&amp;#39;, &amp;#39;Mary&amp;#39;, &amp;#39;Tom&amp;#39;]
&amp;gt;&amp;gt;&amp;gt; &amp;#39;Tom&amp;#39; in tel # 成员测试True
&amp;gt;&amp;gt;&amp;gt; &amp;#39;Mary&amp;#39; not in tel # 成员测试False
&lt;/code>&lt;/pre>&lt;p>构造函数 dict() 直接从键值对sequence中构建字典，当然也可以进行推导，如下：&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; dict([(&amp;#39;sape&amp;#39;, 4139), (&amp;#39;guido&amp;#39;, 4127), (&amp;#39;jack&amp;#39;, 4098)]){&amp;#39;jack&amp;#39;: 4098, &amp;#39;sape&amp;#39;: 4139, &amp;#39;guido&amp;#39;: 4127}
&amp;gt;&amp;gt;&amp;gt; {x: x**2 for x in (2, 4, 6)}{2: 4, 4: 16, 6: 36}
&amp;gt;&amp;gt;&amp;gt; dict(sape=4139, guido=4127, jack=4098){&amp;#39;jack&amp;#39;: 4098, &amp;#39;sape&amp;#39;: 4139, &amp;#39;guido&amp;#39;: 4127}
&lt;/code>&lt;/pre>&lt;p>另外，字典类型也有一些内置的函数，例如clear()、keys()、values()等。&lt;/p>
&lt;p>注意：&lt;/p>
&lt;ol>
&lt;li>字典是一种映射类型，它的元素是键值对。&lt;/li>
&lt;li>字典的关键字必须为不可变类型，且不能重复。&lt;/li>
&lt;li>创建空字典使用{}。&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ol>
&lt;h2 id="python交换变量">python交换变量&lt;/h2>
&lt;p>可以通过临时变量交换也可以用一种优雅的方式x, y = y, x&lt;/p>
&lt;h2 id="九九乘法表">九九乘法表&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s1">x&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s1">=&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">j&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">end&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>代码结果&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">1x1&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">2x1&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">2&lt;/span> &lt;span class="nv">2x2&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">4&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">3x1&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">3&lt;/span> &lt;span class="nv">3x2&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">6&lt;/span> &lt;span class="nv">3x3&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">9&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">4x1&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">4&lt;/span> &lt;span class="nv">4x2&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">8&lt;/span> &lt;span class="nv">4x3&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">12&lt;/span> &lt;span class="nv">4x4&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">16&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">5x1&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">5&lt;/span> &lt;span class="nv">5x2&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">10&lt;/span> &lt;span class="nv">5x3&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">15&lt;/span> &lt;span class="nv">5x4&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">20&lt;/span> &lt;span class="nv">5x5&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">25&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">6x1&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">6&lt;/span> &lt;span class="nv">6x2&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">12&lt;/span> &lt;span class="nv">6x3&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">18&lt;/span> &lt;span class="nv">6x4&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">24&lt;/span> &lt;span class="nv">6x5&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">30&lt;/span> &lt;span class="nv">6x6&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">36&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">7x1&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">7&lt;/span> &lt;span class="nv">7x2&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">14&lt;/span> &lt;span class="nv">7x3&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">21&lt;/span> &lt;span class="nv">7x4&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">28&lt;/span> &lt;span class="nv">7x5&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">35&lt;/span> &lt;span class="nv">7x6&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">42&lt;/span> &lt;span class="nv">7x7&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">49&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">8x1&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">8&lt;/span> &lt;span class="nv">8x2&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">16&lt;/span> &lt;span class="nv">8x3&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">24&lt;/span> &lt;span class="nv">8x4&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">32&lt;/span> &lt;span class="nv">8x5&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">40&lt;/span> &lt;span class="nv">8x6&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">48&lt;/span> &lt;span class="nv">8x7&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">56&lt;/span> &lt;span class="nv">8x8&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">64&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">9x1&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">9&lt;/span> &lt;span class="nv">9x2&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">18&lt;/span> &lt;span class="nv">9x3&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">27&lt;/span> &lt;span class="nv">9x4&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">36&lt;/span> &lt;span class="nv">9x5&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">45&lt;/span> &lt;span class="nv">9x6&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">54&lt;/span> &lt;span class="nv">9x7&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">63&lt;/span> &lt;span class="nv">9x8&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">72&lt;/span> &lt;span class="nv">9x9&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">81&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>查询摄像头支持格式</title><link>https://blog.ferstar.org/post/%E6%9F%A5%E8%AF%A2%E6%91%84%E5%83%8F%E5%A4%B4%E6%94%AF%E6%8C%81%E6%A0%BC%E5%BC%8F/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E6%9F%A5%E8%AF%A2%E6%91%84%E5%83%8F%E5%A4%B4%E6%94%AF%E6%8C%81%E6%A0%BC%E5%BC%8F/</guid><pubDate>Fri, 18 Sep 2015 09:56:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>&lt;code>ffmpeg -f video4linux2 -list_formats all -i /dev/video0&lt;/code>
支持格式如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">ffmpeg version N-72043-g17b2630 Copyright &lt;span class="o">(&lt;/span>c&lt;span class="o">)&lt;/span> 2000-2015 the FFmpeg developers
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> built with gcc 4.8 &lt;span class="o">(&lt;/span>Raspbian 4.8.4-1&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> configuration: --enable-gpl --enable-libx264 --enable-nonfree --arch&lt;span class="o">=&lt;/span>armel --target-os&lt;span class="o">=&lt;/span>linux
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> libavutil 54. 23.101 / 54. 23.101
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> libavcodec 56. 38.100 / 56. 38.100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> libavformat 56. 32.100 / 56. 32.100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> libavdevice 56. 4.100 / 56. 4.100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> libavfilter 5. 16.101 / 5. 16.101
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> libswscale 3. 1.101 / 3. 1.101
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> libswresample 1. 1.100 / 1. 1.100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> libpostproc 53. 3.100 / 53. 3.100
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>video4linux2,v4l2 @ 0x1738ff0&lt;span class="o">]&lt;/span> Raw : yuyv422 : YUV 4:2:2 &lt;span class="o">(&lt;/span>YUYV&lt;span class="o">)&lt;/span> : 640x480 160x120 176x144 320x176 320x240 352x288 432x240 544x288 640x360 752x416 800x448 800x600 864x480 960x544 960x720 1024x576 1184x656 1280x720 1280x960
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>video4linux2,v4l2 @ 0x1738ff0&lt;span class="o">]&lt;/span> Compressed: mjpeg : MJPEG : 640x480 160x120 176x144 320x176 320x240 352x288 432x240 544x288 640x360 752x416 800x448 800x600 864x480 960x544 960x720 1024x576 1184x656 1280x720 1280x960
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>让python的json.dumps输出中文</title><link>https://blog.ferstar.org/post/%E8%AE%A9python%E7%9A%84json/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E8%AE%A9python%E7%9A%84json/</guid><pubDate>Fri, 18 Sep 2015 09:54:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>python的json.dumps方法默认会输出成这种格式
&lt;code>&amp;quot;\u535a\u5ba2\u56ed&amp;quot;&lt;/code>
要输出中文需要指定ensure_ascii参数为False，如下代码片段：
&lt;code>json.dumps({'text':&amp;quot;中文&amp;quot;},ensure_ascii=False,indent=2)&lt;/code>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>python处理二进制数据</title><link>https://blog.ferstar.org/post/python%E5%A4%84%E7%90%86%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%95%B0%E6%8D%AE/</link><guid isPermaLink="true">https://blog.ferstar.org/post/python%E5%A4%84%E7%90%86%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%95%B0%E6%8D%AE/</guid><pubDate>Fri, 18 Sep 2015 09:29:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>&lt;a href="http://pymotw.com/2/struct/index.html">http://pymotw.com/2/struct/index.html&lt;/a>
3.x的修正版
原地址的sample太老旧2.7x, 已经不适用于3.x, 我修正了下, 3.x测试通过&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="ch">#!/usr/bin/env python3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">struct&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">binascii&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">values&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sa">b&lt;/span>&lt;span class="s1">&amp;#39;ab&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mf">2.7&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">s&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">struct&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Struct&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;I 2s f&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">packed_data&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">pack&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">values&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Original values:&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">values&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Format string :&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Uses :&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;bytes&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Packed Value :&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">binascii&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">hexlify&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">packed_data&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>终端输出应该是这样的&lt;/p>
&lt;pre tabindex="0">&lt;code>$ python3 struct_pack.py
Original values: (1, b&amp;#39;ab&amp;#39;, 2.7)
Format string : b&amp;#39;I 2s f&amp;#39;
Uses : 12 bytes
Packed Value : b&amp;#39;0100000061620000cdcc2c40&amp;#39;
&lt;/code>&lt;/pre>&lt;p>解包，应该是这样:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="ch">#!/usr/bin/env python3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">struct&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">binascii&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">packed_data&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">binascii&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">unhexlify&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;0100000061620000cdcc2c40&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">s&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">struct&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Struct&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;I 2s f&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">unpacked_data&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">unpack&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">packed_data&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Unpacked Values:&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">unpacked_data&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>输出结果:&lt;/p>
&lt;pre tabindex="0">&lt;code>$ ./struct_unpack.py
Unpacked Values: (1, b&amp;#39;ab&amp;#39;, 2.700000047683716)
&lt;/code>&lt;/pre>&lt;p>struct_endianness.py&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="ch">#!/usr/bin/env python3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">struct&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">binascii&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">values&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sa">b&lt;/span>&lt;span class="s1">&amp;#39;ab&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mf">2.7&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Original values:&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">values&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">endianness&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;@&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;native, native&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;=&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;native, standard&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;&amp;lt;&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;little-endian&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;&amp;gt;&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;big-endian&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;!&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;network&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="n">code&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">name&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">endianness&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">s&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">struct&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Struct&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">code&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s1">&amp;#39; I 2s f&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">packed_data&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">pack&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">values&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Format string :&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;for&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Uses :&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;bytes&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Packed Value :&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">binascii&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">hexlify&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">packed_data&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Unpacked Value :&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">unpack&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">packed_data&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>运行结果:&lt;/p>
&lt;pre tabindex="0">&lt;code>./struct_endianness.py
Original values: (1, b&amp;#39;ab&amp;#39;, 2.7)
Format string : b&amp;#39;@ I 2s f&amp;#39; for native, native
Uses : 12 bytes
Packed Value : b&amp;#39;0100000061620000cdcc2c40&amp;#39;
Unpacked Value : (1, b&amp;#39;ab&amp;#39;, 2.700000047683716)
Format string : b&amp;#39;= I 2s f&amp;#39; for native, standard
Uses : 10 bytes
Packed Value : b&amp;#39;010000006162cdcc2c40&amp;#39;
Unpacked Value : (1, b&amp;#39;ab&amp;#39;, 2.700000047683716)
Format string : b&amp;#39;&amp;lt; I 2s f&amp;#39; for little-endian
Uses : 10 bytes
Packed Value : b&amp;#39;010000006162cdcc2c40&amp;#39;
Unpacked Value : (1, b&amp;#39;ab&amp;#39;, 2.700000047683716)
Format string : b&amp;#39;&amp;gt; I 2s f&amp;#39; for big-endian
Uses : 10 bytes
Packed Value : b&amp;#39;000000016162402ccccd&amp;#39;
Unpacked Value : (1, b&amp;#39;ab&amp;#39;, 2.700000047683716)
Format string : b&amp;#39;! I 2s f&amp;#39; for network
Uses : 10 bytes
Packed Value : b&amp;#39;000000016162402ccccd&amp;#39;
Unpacked Value : (1, b&amp;#39;ab&amp;#39;, 2.700000047683716)
&lt;/code>&lt;/pre>&lt;p>Buffers&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="ch">#!/usr/bin/env python3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">struct&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">binascii&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">s&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">struct&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Struct&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;I 2s f&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">values&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sa">b&lt;/span>&lt;span class="s1">&amp;#39;ab&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mf">2.7&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Original:&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">values&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;ctypes string buffer&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">ctypes&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ctypes&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">create_string_buffer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Before :&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">binascii&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">hexlify&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">b&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">raw&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">pack_into&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">b&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">values&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;After :&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">binascii&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">hexlify&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">b&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">raw&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Unpacked:&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">unpack_from&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">b&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;array&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">array&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">array&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">array&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;u&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="se">\0&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Before :&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">binascii&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">hexlify&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">pack_into&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">values&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;After :&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">binascii&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">hexlify&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Unpacked:&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">unpack_from&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>运行结果:&lt;/p>
&lt;pre tabindex="0">&lt;code>./struct_buffers.py
Original: (1, b&amp;#39;ab&amp;#39;, 2.7)
ctypes string buffer
Before : b&amp;#39;000000000000000000000000&amp;#39;
After : b&amp;#39;0100000061620000cdcc2c40&amp;#39;
Unpacked: (1, b&amp;#39;ab&amp;#39;, 2.700000047683716)
array
Before : b&amp;#39;000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&amp;#39;
After : b&amp;#39;0100000061620000cdcc2c40000000000000000000000000000000000000000000000000000000000000000000000000&amp;#39;
Unpacked: (1, b&amp;#39;ab&amp;#39;, 2.700000047683716)
&lt;/code>&lt;/pre>&lt;p>实战应用:
读写二进制数组数据
&lt;a href="http://python3-cookbook.readthedocs.org/zh_CN/latest/c06/p11_read_write_binary_arrays_of_structures.html">http://python3-cookbook.readthedocs.org/zh_CN/latest/c06/p11_read_write_binary_arrays_of_structures.html&lt;/a>
server.py&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="ch">#!/usr/bin/env python3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">socketserver&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="nn">subprocess&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="nn">sys&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">threading&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">Thread&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">struct&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">HOST&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">PORT&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">9527&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">BUF_SIZE&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1024&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">unpack_records&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;&amp;#39;&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1"> 解码
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1"> &amp;#39;&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 从头部取得str长度&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">llen&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">struct&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">unpack_from&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;!I&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 略过头部4byte取出x,y,body部分内容&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">text&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">struct&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">unpack_from&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;!II&lt;/span>&lt;span class="si">%d&lt;/span>&lt;span class="s1">s&amp;#39;&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="n">llen&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">text&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">SingleTCPHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">socketserver&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">BaseRequestHandler&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;One instance per connection. Override handle(self) to customize action.&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">handle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># self.request is the client connection&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;client connected:&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">client_address&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">data&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">recv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">BUF_SIZE&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">text&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">unpack_records&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Received: &lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;x = &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">text&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;y = &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">text&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;str is&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">bytes&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">text&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">]))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">text&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">encode&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">SimpleServer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">socketserver&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ThreadingMixIn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">socketserver&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">TCPServer&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Ctrl-C will cleanly kill all spawned threads&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">daemon_threads&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">True&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># much faster rebinding&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">allow_reuse_address&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">True&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="vm">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;__main__&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">server&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">SimpleServer&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">HOST&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PORT&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">SingleTCPHandler&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># terminate with Ctrl-C&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">server&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">serve_forever&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span> &lt;span class="ne">KeyboardInterrupt&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>client.py&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="ch">#!/usr/bin/env python3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">socket&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">struct&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">sys&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">BUF_SIZE&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1024&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">server_addr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;127.0.0.1&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">9527&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1234&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">4321&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">str&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;Hello, I&lt;/span>&lt;span class="se">\&amp;#39;&lt;/span>&lt;span class="s1">m Baymax!&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">pack_records&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;&amp;#39;&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1"> 编码整形
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1"> 4byte int len/4byte int x/4byte int y/&lt;/span>&lt;span class="si">{len}&lt;/span>&lt;span class="s1">byte string body
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1"> &amp;#39;&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">llen&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">str&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">values&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">llen&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">bytes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">str&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;utf8&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">format&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">struct&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Struct&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;!I I I &lt;/span>&lt;span class="si">%d&lt;/span>&lt;span class="s1">s&amp;#39;&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="n">llen&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">data&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">format&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">pack&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">values&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">data&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">try&lt;/span> &lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">socket&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">socket&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">socket&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">AF_INET&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">socket&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">SOCK_STREAM&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">except&lt;/span> &lt;span class="n">socket&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">error&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">msg&lt;/span> &lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Creating Socket Failure. Error Code : &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">msg&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s2">&amp;#34; Message : &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">msg&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">exit&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">connect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">server_addr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">data&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">pack_records&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sendall&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">received&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">recv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">BUF_SIZE&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">decode&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">finally&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Sent: &lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Received: &lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">received&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>星号表达式</title><link>https://blog.ferstar.org/post/%E6%98%9F%E5%8F%B7%E8%A1%A8%E8%BE%BE%E5%BC%8F/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E6%98%9F%E5%8F%B7%E8%A1%A8%E8%BE%BE%E5%BC%8F/</guid><pubDate>Fri, 18 Sep 2015 09:23:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>星号表达式在迭代元素为可变长元组的序列时是很有用的。 比如，下面是一个带有标签的元组序列：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">records&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;foo&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;bar&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;hello&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;foo&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">do_foo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;foo&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">do_bar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;bar&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="n">tag&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">args&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">records&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">tag&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;foo&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">do_foo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="n">tag&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;bar&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">do_bar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>星号解压语法在字符串操作的时候也会很有用，比如字符串的分割。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&amp;gt;&amp;gt;&amp;gt; &lt;span class="nv">line&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;nobody:*:-2:-2:Unprivileged User:/var/empty:/usr/bin/false&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt;&amp;gt;&amp;gt; uname, *fields, homedir, &lt;span class="nv">sh&lt;/span> &lt;span class="o">=&lt;/span> line.split&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;:&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt;&amp;gt;&amp;gt; uname
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">&amp;#39;nobody&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt;&amp;gt;&amp;gt; homedir
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">&amp;#39;/var/empty&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt;&amp;gt;&amp;gt; sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">&amp;#39;/usr/bin/false&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt;&amp;gt;&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>有时候, 需要解压一些元素, 然后丢弃掉无用的部分, 不能简单使用*, 不过可以使用一个普通的废弃名称, 比如_或者ign&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&amp;gt;&amp;gt;&amp;gt; &lt;span class="nv">record&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;ACME&amp;#39;&lt;/span>, 50, 123.45, &lt;span class="o">(&lt;/span>12, 18, 2012&lt;span class="o">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt;&amp;gt;&amp;gt; name, *_, &lt;span class="o">(&lt;/span>*_, year&lt;span class="o">)&lt;/span> &lt;span class="o">=&lt;/span> record
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt;&amp;gt;&amp;gt; name
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">&amp;#39;ACME&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt;&amp;gt;&amp;gt; year
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">2012&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt;&amp;gt;&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>unix系统能ping通ip但无法ping域名的解决方法</title><link>https://blog.ferstar.org/post/unix%E7%B3%BB%E7%BB%9F%E8%83%BDping%E9%80%9Aip%E4%BD%86%E6%97%A0%E6%B3%95ping%E5%9F%9F%E5%90%8D%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/</link><guid isPermaLink="true">https://blog.ferstar.org/post/unix%E7%B3%BB%E7%BB%9F%E8%83%BDping%E9%80%9Aip%E4%BD%86%E6%97%A0%E6%B3%95ping%E5%9F%9F%E5%90%8D%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/</guid><pubDate>Fri, 18 Sep 2015 09:22:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>from &lt;a href="http://www.cnblogs.com/laipdidi/articles/2213787.html">http://www.cnblogs.com/laipDIDI/articles/2213787.html&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">sudo vi /etc/nsswitch.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">&amp;#39;&amp;#39;&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">- hosts: files dns
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">- networks: files
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">@@
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">+ hosts: files dns wins
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">+ networks: files
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">&amp;#39;&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo systemctl restart network.service &lt;span class="c1">#重启rhel网络&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>生成随机字符串</title><link>https://blog.ferstar.org/post/%E7%94%9F%E6%88%90%E9%9A%8F%E6%9C%BA%E5%AD%97%E7%AC%A6%E4%B8%B2/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E7%94%9F%E6%88%90%E9%9A%8F%E6%9C%BA%E5%AD%97%E7%AC%A6%E4%B8%B2/</guid><pubDate>Fri, 18 Sep 2015 09:19:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">random&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">GenString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">length&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># return &amp;#39;&amp;#39;.join(random.sample(chars, 15)) # 得出的结果中字符不会有重复的&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="n">random&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">choice&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">string&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ascii_letters&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">length&lt;/span>&lt;span class="p">)])&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>Ubuntu查看crontab运行日志</title><link>https://blog.ferstar.org/post/ubuntu%E6%9F%A5%E7%9C%8Bcrontab%E8%BF%90%E8%A1%8C%E6%97%A5%E5%BF%97/</link><guid isPermaLink="true">https://blog.ferstar.org/post/ubuntu%E6%9F%A5%E7%9C%8Bcrontab%E8%BF%90%E8%A1%8C%E6%97%A5%E5%BF%97/</guid><pubDate>Fri, 18 Sep 2015 09:12:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>修改rsyslog
&lt;code>sudo vim /etc/rsyslog.d/50-default.conf&lt;/code>
cron.* /var/log/cron.log #将cron前面的注释符去掉
重启rsyslog
&lt;code>sudo service rsyslog restart&lt;/code>
查看crontab日志
&lt;code>less /var/log/cron.log &lt;/code>
crontab问题定位
查看日志
&lt;code>/var/log/cron.lo&lt;/code>g 和 &lt;code>/var/mail/$user&lt;/code>
因为crontab运行日志记录在cron.log，开启sendmail服务会给当前crontab运行属主发送邮件&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>Ubuntu使用dnsmasq作本地DNS缓存</title><link>https://blog.ferstar.org/post/ubuntu%E4%BD%BF%E7%94%A8dnsmasq%E4%BD%9C%E6%9C%AC%E5%9C%B0dns%E7%BC%93%E5%AD%98/</link><guid isPermaLink="true">https://blog.ferstar.org/post/ubuntu%E4%BD%BF%E7%94%A8dnsmasq%E4%BD%9C%E6%9C%AC%E5%9C%B0dns%E7%BC%93%E5%AD%98/</guid><pubDate>Thu, 17 Sep 2015 23:48:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>&lt;a href="http://mydf.github.io/blog/ubuntu-dnsmasq/">http://mydf.github.io/blog/ubuntu-dnsmasq/&lt;/a>&lt;/p>
&lt;pre tabindex="0">&lt;code>sudo apt-get install dnsmasq
sudo vi /etc/NetworkManager/NetworkManager.conf
注释#dns=dnsmasq
sudo vi /etc/dhcp/dhclient.conf
去掉注释prepend domain-name-servers 127.0.0.1;
sudo vi /etc/default/dnsmasq
去掉注释IGNORE_RESOLVCONF=yes
sudo vi /etc/dnsmasq.conf
resolv-file=/etc/resolv.dnsmasq
sudo service dnsmasq restart
sudo service network-manager restart
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>UBUNUT常用软件</title><link>https://blog.ferstar.org/post/ubunut%E5%B8%B8%E7%94%A8%E8%BD%AF%E4%BB%B6/</link><guid isPermaLink="true">https://blog.ferstar.org/post/ubunut%E5%B8%B8%E7%94%A8%E8%BD%AF%E4%BB%B6/</guid><pubDate>Thu, 17 Sep 2015 23:45:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;h2 id="officewps">Office：wps&lt;/h2>
&lt;h2 id="浏览器chromium-browser">浏览器：chromium-browser&lt;/h2>
&lt;pre>&lt;code>常用扩展：LastPass、SwitchyOmega、Adblock Plus、印象笔记剪藏、网易云笔记剪藏
&lt;/code>&lt;/pre>
&lt;h2 id="词典stardict">词典：stardict&lt;/h2>
&lt;pre>&lt;code>词典解压后放在～/.stardict/dic目录下
&lt;/code>&lt;/pre>
&lt;h2 id="输入法fcitx框架搜狗输入法">输入法：fcitx框架+搜狗输入法&lt;/h2>
&lt;pre>&lt;code> http://pinyin.sogou.com/linux/?r=pinyin
&lt;/code>&lt;/pre>
&lt;h2 id="聊天工具wine-qq">聊天工具：wine QQ&lt;/h2>
&lt;pre>&lt;code> http://www.ubuntukylin.com/applications/showimg.php?lang=cn&amp;amp;id=23
&lt;/code>&lt;/pre>
&lt;h2 id="ftpfilezilla">FTP：FileZilla&lt;/h2>
&lt;h2 id="系统微调ubuntu-tweak">系统微调：ubuntu tweak&lt;/h2>
&lt;h2 id="shellzsh">SHELL：ZSH&lt;/h2>
&lt;pre>&lt;code> http://ohmyz.sh/
&lt;/code>&lt;/pre>
&lt;h2 id="显卡驱动独显尽量在系统设置-软件更新-附加驱动里勾选专有驱动集显随意">显卡驱动：独显尽量在“系统设置-软件更新-附加驱动”里勾选专有驱动，集显随意&lt;/h2>
&lt;h2 id="邮件thunderbird系统默认即雷鸟不常用">邮件：thunderbird（系统默认），即雷鸟，不常用&lt;/h2>
&lt;h2 id="网盘同步bcloud百度网盘linux版">网盘同步：BCloud（百度网盘linux版）&lt;/h2>
&lt;pre>&lt;code> https://github.com/LiuLang/bcloud
&lt;/code>&lt;/pre>
&lt;h2 id="代理shadowsocks">代理：shadowsocks&lt;/h2></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>PyCharm快捷键补充</title><link>https://blog.ferstar.org/post/pycharm%E5%BF%AB%E6%8D%B7%E9%94%AE%E8%A1%A5%E5%85%85/</link><guid isPermaLink="true">https://blog.ferstar.org/post/pycharm%E5%BF%AB%E6%8D%B7%E9%94%AE%E8%A1%A5%E5%85%85/</guid><pubDate>Thu, 17 Sep 2015 23:24:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>替换：&lt;strong>Ctrl+R&lt;/strong>
删除当前行 CTRY Y
复制当前行：Ctrl+D
ALT F7: 查找哪些地方使用了选中的方法。&lt;br>
ALT UP: 移到上一个方法&lt;br>
ALT DOWN: 移到下一个方法&lt;br>
CTRL SHIFT UP: 将当前行上移一行&lt;br>
CTRL SHIFT UP: 将当前行下移一行&lt;/p>
&lt;p>&lt;img src="~/%E5%BF%AB%E6%8D%B7%E9%94%AE.png" alt="">&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>nohup 后台运行，以及重定向标准输出和标准错误输出</title><link>https://blog.ferstar.org/post/nohup-%E5%90%8E%E5%8F%B0%E8%BF%90%E8%A1%8C%E4%BB%A5%E5%8F%8A%E9%87%8D%E5%AE%9A%E5%90%91%E6%A0%87%E5%87%86%E8%BE%93%E5%87%BA/</link><guid isPermaLink="true">https://blog.ferstar.org/post/nohup-%E5%90%8E%E5%8F%B0%E8%BF%90%E8%A1%8C%E4%BB%A5%E5%8F%8A%E9%87%8D%E5%AE%9A%E5%90%91%E6%A0%87%E5%87%86%E8%BE%93%E5%87%BA/</guid><pubDate>Thu, 17 Sep 2015 23:16:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>nohup 加 &amp;amp;大家都知道是后台运行并把stdout输出到文件nohup.out中。其实&amp;amp;是后台运行的命令。
具体的命令我就不介绍了，
一般都是在linux下
nohup command_line
或者
nohup command_line &amp;amp;
这之间的差别是带&amp;amp;的命令行，即使terminal关闭，或者电脑死机程序依然运行（前提是你把程序递交到服务器上）；
它把标准输出（STDOUT）和标准错误（STDERR）结果输出到nohup.txt文件
这个看似很方便，但是当输出很大的时候，nohup.txt文件会非常大，或者多个后台命令的时候大家都会输出到nohup.txt文件，不利于查找结果和调试程序。
所以能够重定向输出会非常方便。
下面要介绍标准输出，标准输入 和标准错误了。
其实我门一直都在用，只是没有注意到，
比如
&lt;code>&amp;gt;./command.sh &amp;gt; output&lt;/code>
#这其中的&amp;gt;就是标准输出符号，其实是 1&amp;gt;output 的缩写
&lt;code>&amp;gt;./command.sh 2&amp;gt; output&lt;/code>
＃这里的2&amp;gt;就是将标准错误输出到output文件里。
而0&amp;lt; 则是标准输入了。
下面步入正题，重定向后台命令
&lt;code>&amp;gt;nohup ./command.sh &amp;gt; output 2&amp;gt;&amp;amp;1 &amp;amp;&lt;/code>
解释：前面的nohup 和后面的&amp;amp;我想大家都能明白了把。
主要是中间的 2&amp;gt;&amp;amp;1的意思
这个意思是把标准错误（2）重定向到标准输出中（1），而标准输出又导入文件output里面，
所以结果是标准错误和标准输出都导入文件output里面了。
至于为什么需要将标准错误重定向到标准输出的原因，那就归结为标准错误没有缓冲区，而stdout有。
这就会导致 &amp;gt;output 2&amp;gt;output 文件output被两次打开，而stdout和stderr将会竞争覆盖，这肯定不是我门想要的.
这就是为什么有人会写成：
&lt;code>nohup ./command.sh &amp;gt;output 2&amp;gt;output&lt;/code>出错的原因了
最后谈一下/dev/null文件的作用
这是一个无底洞，任何东西都可以定向到这里，但是却无法打开。
所以一般很大的stdou和stderr当你不关心的时候可以利用stdout和stderr定向到这里
&lt;code>&amp;gt;./command.sh &amp;gt;/dev/null 2&amp;gt;&amp;amp;1&lt;/code>&lt;/p>
&lt;p>好，就到这里，enjoy youself！！！&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/shell/">SHELL</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>视频监控存储空间计算方法</title><link>https://blog.ferstar.org/post/%E8%A7%86%E9%A2%91%E7%9B%91%E6%8E%A7%E5%AD%98%E5%82%A8%E7%A9%BA%E9%97%B4%E8%AE%A1%E7%AE%97%E6%96%B9%E6%B3%95/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E8%A7%86%E9%A2%91%E7%9B%91%E6%8E%A7%E5%AD%98%E5%82%A8%E7%A9%BA%E9%97%B4%E8%AE%A1%E7%AE%97%E6%96%B9%E6%B3%95/</guid><pubDate>Thu, 17 Sep 2015 17:24:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>在视频监控系统中，对存储空间容量的大小需求是与画面质量的高低、及视频线路等都有很大关系。下面对视频存储空间大小与传输带宽的之间的计算方法做以介绍。
比特率是指每秒传送的比特(bit)数。单位为bps(BitPerSecond)，比特率越高，传送的数据越大。比特率表示经过编码(压缩)后的音、视频数据每秒钟需要用多少个比特来表示，而比特就是二进制里面最小的单位，要么是0，要么是1。比特率与音、视频压缩的关系，简单的说就是比特率越高，音、视频的质量就越好，但编码后的文件就越大;如果比特率越少则情况刚好相反。
码流(DataRate)是指视频文件在单位时间内使用的数据流量，也叫码率，是视频编码中画面质量控制中最重要的部分。同样分辨率下，视频文件的码流越大，压缩比就越小，画面质量就越高。
上行带宽就是本地上传信息到网络上的带宽。上行速率是指用户电脑向网络发送信息时的数据传输速率，比如用FTP上传文件到网上去，影响上传速度的就是“上行速率”。
下行带宽就是从网络上下载信息的带宽。下行速率是指用户电脑从网络下载信息时的数据传输速率，比如从FTP服务器上文件下载到用户电脑，影响下传速度的就是“下行速率”。
不同的格式的比特率和码流的大小定义表：&lt;/p>
&lt;p>传输带宽计算：
比特率大小×摄像机的路数=网络带宽至少大小;
注：监控点的带宽是要求上行的最小限度带宽(监控点将视频信息上传到监控中心);监控中心的带宽是要求下行的最小限度带宽(将监控点的视频信息下载到监控中心);例：电信2Mbps的ADSL宽带，理论上其上行带宽是512kbps=64kb/s，其下行带宽是2Mbps=256kb/s
例：监控分布在5个不同的地方，各地方的摄像机的路数：n=10(20路)1个监控中心，远程监看及存储视频信息，存储时间为30天。不同视频格式的带宽及存储空间大小计算如下：
地方监控点：
CIF视频格式每路摄像头的比特率为512Kbps，即每路摄像头所需的数据传输带宽为512Kbps，10路摄像机所需的数据传输带宽为：
512Kbps(视频格式的比特率)×10(摄像机的路数)≈5120Kbps=5Mbps(上行带宽)
即：采用CIF视频格式各地方监控所需的网络上行带宽至少为5Mbps;
D1视频格式每路摄像头的比特率为1.5Mbps，即每路摄像头所需的数据传输带宽为1.5Mbps，10路摄像机所需的数据传输带宽为：
1.5Mbps(视频格式的比特率)×10(摄像机的路数)=15Mbps(上行带宽)
即：采用D1视频格式各地方监控所需的网络上行带宽至少为15Mbps;
720P(100万像素)的视频格式每路摄像头的比特率为2Mbps，即每路摄像头所需的数据传输带宽为2Mbps，10路摄像机所需的数据传输带宽为：
2Mbps(视频格式的比特率)×10(摄像机的路数)=20Mbps(上行带宽)
即：采用720P的视频格式各地方监控所需的网络上行带宽至少为20Mbps;
1080P(200万像素)的视频格式每路摄像头的比特率为4Mbps，即每路摄像头所需的数据传输带宽为4Mbps，10路摄像机所需的数据传输带宽为：
4Mbps(视频格式的比特率)×10(摄像机的路数)=40Mbps(上行带宽)
即：采用1080P的视频格式各地方监控所需的网络上行带宽至少为40Mbps;
监控中心：
CIF视频格式的所需带宽：
512Kbps(视频格式的比特率)×50(监控点的摄像机的总路数之和)=25600Kbps=25Mbps(下行带宽)
即：采用CIF视频格式监控中心所需的网络下行带宽至少25Mbps
D1视频格式的所需带宽：
1.5Mbps(视频格式的比特率)×50(监控点的摄像机的总路数之和)=75Mbps(下行带宽)
即：采用D1视频格式监控中心所需的网络下行带宽至少75Mbps
720P(100万像素)的视频格式的所需带宽：
2Mbps(视频格式的比特率)×50(监控点的摄像机的总路数之和)=100Mbps(下行带宽)
即：采用720P的视频格式监控中心所需的网络下行带宽至少100Mbps
1080P(200万像素)的视频格式的所需带宽：
4Mbps(视频格式的比特率)×50(监控点的摄像机的总路数之和)=200Mbps(下行带宽)
即：采用1080P的视频格式监控中心所需的网络下行带宽至少200Mbps
存储空间计算：
码流大小(单位：kb/s;即：比特率÷8)×3600(单位：秒;1小时的秒数)×24(单位：小时;一天的时间长)×30(保存的天数)×50(监控点要保存摄像机录像的总数)÷0.9(磁盘格式化的损失10%空间)=所需存储空间的大小(注：存储单位换算1TB=1024GB;1GB=1024MB;1MB=1024KB)
50路存储30天的CIF视频格式录像信息的存储空间所需大小为：
64×3600×24×30×50÷0.9=8789.1GB≈9TB
50路存储30天的D1视频格式录像信息的存储空间所需大小为：
192×3600×24×30×50÷0.9=26367.2GB≈26TB
50路存储30天的720P(100万像素)视频格式录像信息的存储空间所需大小为：
256×3600×24×30×50÷0.9=35156.3GB≈35TB
50路存储30天的1080P(200万像素)视频格式录像信息的存储空间所需大小为：
512×3600×24×30×50÷0.9=70312.5GB≈69TB
附常用分辨率视频对应码流参考图&lt;/p>
&lt;p>&lt;img src="~/%E5%B8%B8%E8%A7%81%E7%A0%81%E7%8E%87.jpg" alt="">&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>为什么明明可以在线看免费小说，却还有那么多人看收费小说？</title><link>https://blog.ferstar.org/post/%E4%B8%BA%E4%BB%80%E4%B9%88%E6%98%8E%E6%98%8E%E5%8F%AF%E4%BB%A5%E5%9C%A8%E7%BA%BF%E7%9C%8B%E5%85%8D%E8%B4%B9%E5%B0%8F%E8%AF%B4%E5%8D%B4%E8%BF%98%E6%9C%89%E9%82%A3%E4%B9%88%E5%A4%9A%E4%BA%BA%E7%9C%8B%E6%94%B6%E8%B4%B9%E5%B0%8F%E8%AF%B4/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E4%B8%BA%E4%BB%80%E4%B9%88%E6%98%8E%E6%98%8E%E5%8F%AF%E4%BB%A5%E5%9C%A8%E7%BA%BF%E7%9C%8B%E5%85%8D%E8%B4%B9%E5%B0%8F%E8%AF%B4%E5%8D%B4%E8%BF%98%E6%9C%89%E9%82%A3%E4%B9%88%E5%A4%9A%E4%BA%BA%E7%9C%8B%E6%94%B6%E8%B4%B9%E5%B0%8F%E8%AF%B4/</guid><pubDate>Wed, 16 Sep 2015 21:32:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>我记得很久以前我迷恋《兽血沸腾》的时候，爱屋及乌，就把作者静官还没成名前写的《血流》翻出来看。&lt;br>
我下载的那个免费版本《血流》里除了正常的热血碉堡剧情外，还有静官在PS里和为数不多的读者们的互动，我记得特别深刻的一个PS是：“这一章我是在网吧写的，因为今天要去面试一个厨师的职位，下午就要去，所以写得很烂，大家请将就着看。”&lt;br>
没错，那个时候的静官还是一个无业青年，待业厨师，在起点的写作《血流》只能算一个业余爱好因为根本没有赚到什么钱，或者说，赚到的那点点钱根本不足以让他改变生活专心写作。&lt;br>
因此，《血流》里的不少章节都是他去网吧写出来的，偶尔看着他PS里面的喃喃自语，能让你自动脑补出一个油腻的有着小说梦在网吧抽烟挠头发的大胖子，偶尔点份回锅肉炒饭都是奢侈。&lt;br>
而静官关于《血流》太监的原话是：“大家知道么，我每天都是在炒菜的间隙用油腻腻的菜单写下每一章的节段，平常是9：00起床，现在6：30就起来码字，打字又慢，1小时才1000字，痛苦ING！”&lt;br>
那时的静官很苦，但是经常在互动中提到他一定会写完《血流》，就算是为了一直在支持他的几个重要读者。&lt;br>
但《血流》为什么又太监了呢？就一个原因，穷。&lt;br>
这本书就我而言十分精彩，黑道题材顶级作品，什么因素都有，读着真实，畅快，比看武侠还觉着酣畅淋漓，虽然剧情有些时候很狗血，但是同比其余的一些烂书简直是精品佳作。但为什么这么好看，就写不下去了？&lt;br>
就一个原因，穷。&lt;br>
尽管他已经凑集到了不少的死忠书迷，但这些死忠书迷能够出的月票终究有限，而现实中静官只是一个月薪刚好能够保证不死的的小厨师，对于每一个渴望用自己的文字养活自己的，社会中的人（看清楚，社会中的人，学生除外）来说，如果自己写的东西迟迟得不到盈利而还要透支自己的休息时间，绞尽脑筋的创作，很多时候，是一种折磨。&lt;br>
静官很聪明，讲故事的天赋和文字朴实很容易讨到普通观众的G点，所以最终他果断抛弃了一直不温不热的《血流》，用《血流》里一开场就死去的刘震撼为原型，完善了他一直在写的另外一本YY小说，《兽血沸腾》。&lt;br>
后来的事情，我知道， 你也知道。《兽血沸腾》大火使得静官死忠书迷翻了几番，肯掏钱的人不停增加，他也因为这本书而摆脱困境，成为了年入百万的白金写手。&lt;br>
所以题主，我为什么要说上面这些？&lt;br>
上面也有人说过。&lt;br>
没有那些一直在支持作者，付费，帮忙推荐，转发，赞同，关注，投月票买实体书的人，你又是从哪里来的，看免费的机会？&lt;br>
在互联网上，谁都不认识谁，某一天好不容易你看到一特好玩的写手，特好玩的主播，特好玩的UP主，博主，答主能让你度过开心的一天触碰到你的G点，假使你害怕再过段时间就瞧不见他了，能怎么办？&lt;br>
还能怎么办？有鱼丸就送鱼丸，能点个订阅就点个订阅，能有张月票就建个号刷月票，能点个关注就点个关注。&lt;br>
什么都没有只剩下钱，那就送钱。&lt;br>
如果你是个小学生你肯定要问为什么。回答你，不为什么，因为你不做上面那些事情，其他人也不做，如果每个人都默默的通过一个平台看别人用脑子，用身体，用人生经历制作出来让你愉悦，让你感动，让你大笑的东西。&lt;br>
如果每个人表达喜欢表达崇敬表达爱的方法都是默默的看，看免费，用免费，用完看完后还要骂主播作者博主明星们不务正业接广告，搞淘宝店。&lt;br>
那那些文字，视频，电影，图像，图文的工作者们，大概都会消失殆尽。&lt;br>
毕竟，自始至终，支撑着一个行业运转下去的，永远是那些掏钱的人。&lt;br>
这些掏钱的，有广告商，有出版社，有订阅的读者，有公司企业，有淘宝商人，有运营团队，有网站本身，更重要的，永远是舍得掏钱的观众。创造出优良的东西制造了庞大的流量的作者们，如果谁都不掏钱养活，那么互联网社区创作平台本身的存在就毫无意义，说严重点，整个互联网都将毫无意义，还不如跟着地球一起大爆炸算了。&lt;br>
你不花钱，不订阅，不关注没有什么，很多人都这样。但请你在作者在主播们UP主们毫无办法只有靠接点广告来养活自己的时候，老老实实的接受安利。请你在其他人因为喜爱因为想看着别人继续创作下去而花钱的时候，闭嘴。&lt;br>
对，闭嘴，闭得严严的。如果你长大了出了社会整体意识变强一丁点了，还可以学学我，将以前影响你人生价值观的免费东西一点一点的还回去，将周星驰的电影多刷几遍，多买几本实体书，为字幕组打赏，为写小说的人宣传积人气投月票打赏，去B站你喜欢的UP主的淘宝店多买点零食来吃，遇到好看的东西好玩的人随手点个关注转发。&lt;br>
说太远，说说自己，我相信每一个玩弄文字的人，都希望自己能把自己的文字玩到值钱，所以我在奇妙世界的专栏里放了打赏的支付宝，我的家境不富裕，人也不强大，所以一直想知道自己到底到底是不是一块写东西的料，有没有人肯为我写的东西付钱。&lt;br>
截止到现在，放了大概三个月，我的收到打赏已经四位数，其中更是有一位不知名的豪直打过来的500块，并只附上了一句话，“请继续写下去。”&lt;br>
这就是我之所以一直在知乎保持写作，保持答题，磨练文字甚至写小说的动力，是这些打赏的，关注我的，经常评论我答案点我赞的，再关注我微博加我粉丝群的人让我知道，如果有朝一日我能够写出一本书，他们是一定会买的。是他们的刷取存在感以及支持让我有了无限的动力写下去，哪怕在我最忙最困难的时候也会想着写一些故事，写点好玩的字儿，写点还算能看的吐槽，让他们笑一笑，感一感动，骂一骂娘。&lt;br>
我很感激他们，但永远，永永远远也不会感激类似你这样看了免费还要指责付费付心人的你。&lt;br>
看到这，肯定会有人说：“我草，你写的那些垃圾玩意二逼东西都能收到打赏，那些东西谁写不出来，你还要脸吗？”&lt;br>
我的回答是。&lt;br>
对方辩友，我不要脸：）&lt;/p>
&lt;p>&lt;a href="http://mp.weixin.qq.com/s?__biz=MzAwOTEzMTkzNw==&amp;amp;mid=218923599&amp;amp;idx=1&amp;amp;sn=8bcca21e6fed8a656e8f6e416f9cd6f0&amp;amp;scene=0#rd">Source From 为什么明明可以在线看免费小说，却还有那么多人看收费小说？&lt;/a>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>Remove Bluetooth Manager in Xubuntu</title><link>https://blog.ferstar.org/post/remove-bluetooth-manager-in-xubuntu/</link><guid isPermaLink="true">https://blog.ferstar.org/post/remove-bluetooth-manager-in-xubuntu/</guid><pubDate>Tue, 15 Sep 2015 22:52:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>&lt;a href="http://askubuntu.com/questions/305856/how-to-remove-bluetooth-manager-in-xubuntu">How to Remove Bluetooth Manager in Xubuntu&lt;/a>&lt;/p>
&lt;h2 id="q-i-wanna-remove-bluetooth-manager-and-its-daemon-from-xubuntu-because-my-computer-doesnt-have-bluetooth-device-how-should-i-do">Q: I wanna remove bluetooth manager and its daemon from Xubuntu because my computer doesn't have bluetooth device. How should I do?&lt;/h2>
&lt;p>Note : I've searched questions &lt;a href="http://askubuntu.com/search?q=Remove+Bluetooth">http://askubuntu.com/search?q=Remove+Bluetooth&lt;/a> but I find nothing. Wish I don't create duplicate question&lt;/p>
&lt;h2 id="a-the-following-shell-command-will-remove-bluetooth-and-all-its-dependencies">A: The following shell command will remove bluetooth and all its dependencies:&lt;/h2>
&lt;pre tabindex="0">&lt;code>sudo apt-get purge &amp;#34;bluez*&amp;#34;
&lt;/code>&lt;/pre>&lt;p>If this prompts you to remove the xubuntu-desktop meta-package, do not be alarmed. This is acceptable.&lt;/p>
&lt;p>If installed, also remove the obex-data-server and the libopenobex package. The libbluetooth* package(s) must remain since too many stuff depends on it.&lt;/p>
&lt;p>Afterwards, you should also run:&lt;/p>
&lt;pre tabindex="0">&lt;code>sudo apt-get autoremove
&lt;/code>&lt;/pre>&lt;p>pretty good!&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>ubuntu14.04设置静态ip</title><link>https://blog.ferstar.org/post/%E6%9B%B4%E6%94%B9ubuntu-lan-ip/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E6%9B%B4%E6%94%B9ubuntu-lan-ip/</guid><pubDate>Tue, 15 Sep 2015 09:48:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;h2 id="desktop-with-networkmanager-installed">Desktop with NetworkManager installed&lt;/h2>
&lt;ol>
&lt;li>鼠标流
桌面版比较方便的就是点通知栏网络图标后编辑喽, 这个比较简单&lt;/li>
&lt;li>终端流
NetworkManager配置文件位置&lt;code>/etc/NetworkManager/system-connections&lt;/code>&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>有线&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>802-3-ethernet&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">duplex&lt;/span>&lt;span class="o">=&lt;/span>full
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mac-address&lt;span class="o">=&lt;/span>B8:27:EB:14:E0:BF
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>connection&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">id&lt;/span>&lt;span class="o">=&lt;/span>eth0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 这个uuid并没有任何含义, 可以随便用uuidgen产生的新值替换&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">uuid&lt;/span>&lt;span class="o">=&lt;/span>512de3e4-5bb7-11e5-8cbe-b827eb14e0bf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">type&lt;/span>&lt;span class="o">=&lt;/span>802-3-ethernet
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">timestamp&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1442327046&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>ipv6&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># ipv6一般是关的, 除非是幸福的高校用户&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">method&lt;/span>&lt;span class="o">=&lt;/span>ignore
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>ipv4&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 自动ip这里填auto, 静态如下&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">method&lt;/span>&lt;span class="o">=&lt;/span>manual
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">dns&lt;/span>&lt;span class="o">=&lt;/span>192.168.1.1&lt;span class="p">;&lt;/span>223.5.5.5&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">address1&lt;/span>&lt;span class="o">=&lt;/span>192.168.1.22/24,192.168.1.1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>无线&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>connection&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">id&lt;/span>&lt;span class="o">=&lt;/span>tars-2.4G
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">uuid&lt;/span>&lt;span class="o">=&lt;/span>fbc73a26-94f4-49aa-9c72-93e7e8db6655
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">type&lt;/span>&lt;span class="o">=&lt;/span>802-11-wireless
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">timestamp&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1442228433&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>802-11-wireless&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">ssid&lt;/span>&lt;span class="o">=&lt;/span>tars-2.4G
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">mode&lt;/span>&lt;span class="o">=&lt;/span>infrastructure
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mac-address&lt;span class="o">=&lt;/span>E8:4E:06:29:06:52
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 无线ap的mac地址&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">seen-bssids&lt;span class="o">=&lt;/span>04:A1:51:AE:0A:6F&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">security&lt;/span>&lt;span class="o">=&lt;/span>802-11-wireless-security
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>802-11-wireless-security&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 无线安全部分&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">key-mgmt&lt;span class="o">=&lt;/span>wpa-psk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">psk&lt;/span>&lt;span class="o">=&lt;/span>tarsbot.702
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>ipv4&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">method&lt;/span>&lt;span class="o">=&lt;/span>manual
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">dns&lt;/span>&lt;span class="o">=&lt;/span>192.168.1.1&lt;span class="p">;&lt;/span>223.5.5.5&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">address1&lt;/span>&lt;span class="o">=&lt;/span>192.168.1.33/24,192.168.1.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>ipv6&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">method&lt;/span>&lt;span class="o">=&lt;/span>ignore
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="server">Server&lt;/h2>
&lt;p>Setting up a static ip address is useful for a lot of things, especially if you run a web server for example and don’t want to change the port forwarding rules on your router each time it allocates a different ip to your Ubuntu server.&lt;/p>
&lt;p>Only use this guide if you already know the working network configuration (ip, mask, gateway and dns servers).&lt;/p>
&lt;p>First of all, open a terminal window and edit the network interfaces file:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">sudo nano /etc/network/interfaces
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>You will find here something like this:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">auto eth0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iface eth0 inet dhcp
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Edit that file accordingly and replace with your own ip configuration. The dns nameservers are actually Google’s dns servers so if you don’t know your own ISP ones, you can use those:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">auto eth0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iface eth0 inet static
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">address 192.168.100.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">netmask 255.255.255.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gateway 192.168.100.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dns-nameservers 8.8.4.4 8.8.8.8
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Restart the interface:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">sudo ifdown eth0 &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> sudo ifup eth0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>That’s it!&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/ubuntu/">UBUNTU</category></item><item><title>记一次好玩的微信刷票</title><link>https://blog.ferstar.org/post/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%A5%BD%E7%8E%A9%E7%9A%84%E5%BE%AE%E4%BF%A1%E5%88%B7%E7%A5%A8/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%A5%BD%E7%8E%A9%E7%9A%84%E5%BE%AE%E4%BF%A1%E5%88%B7%E7%A5%A8/</guid><pubDate>Sun, 13 Sep 2015 23:46:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>公司参加一个创新项目的比赛,活动主办方为了活跃气氛, 或者是扩大知名度, 发起了一个微信投票活动, 得票数前三位还是多少位就可以免机票去参加总决赛&lt;/p>
&lt;h1 id="过程">过程&lt;/h1>
&lt;p>整个过程比较狗血, 且将过程分为5阶段&lt;/p>
&lt;h2 id="1-安分守己">1. 安分守己&lt;/h2>
&lt;p>这个阶段活动刚刚开始, 小伙伴们都自觉转发到自己朋友圈求投票, 环顾其他参赛同行似乎也是这样, 这阶段基本和平竞争, 大家彼此得票差异并不明显
此阶段得票速度取决于朋友圈扩散速度&lt;/p>
&lt;h2 id="2-小打小闹">2. 小打小闹&lt;/h2>
&lt;p>此阶段开始狗血, 某君发现有个别友商得票开始突然暴增, 并且此次投票并未限制终端甚至ip, 也就是可以重复投票, 遂开按键精灵追击, 脚本内容如下:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-basic" data-lang="basic">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&amp;#39;==========以下是按键精灵录制的内容==========&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="vg">MoveTo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="il">575&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="il">369&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">#&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="vg">光标移动到这个点&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="vg">也就是翻页按钮&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="vg">For&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="il">13&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">#&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="vg">连点13次&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="vg">我们的页面在第13页&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="vg">so&lt;/span>&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="vg">LeftClick&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="il">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="vg">Delay&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="il">750&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="vg">Next&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="vg">MoveTo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="il">450&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="il">622&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">#&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="vg">移动到我司位置&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="vg">点击投票&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="vg">LeftClick&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="il">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="vg">Delay&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="il">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="vg">MoveTo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="il">464&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="il">622&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="vg">LeftClick&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="il">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="vg">Delay&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="il">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="vg">KeyDown&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;F5&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="il">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="err">#&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="vg">投完按F5刷新网页&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="vg">再来一遍&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="vg">Delay&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="il">2000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&amp;#39;==========以上是按键精灵录制的内容==========&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>按键精灵刷票速度其实只比手动点节省了一点点时间, 重要是解放了双手, 而且可以24小时工作, 此阶段投票速度&lt;code>5票/分&lt;/code>&lt;/p>
&lt;h2 id="3-疯狂开挂">3. 疯狂开挂&lt;/h2>
&lt;p>好不容易开几台机器刷到排行榜前四, 发现某同行票数像打了鸡血, 一路狂飙, 此时按键精灵已无力回天, 关键时刻, 老大虎躯一震:&amp;quot;本地帮派太没规矩!&amp;quot; 分析投票网站后写出刷票脚本, 众小弟无不膜拜:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">os&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cmd&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;curl xxx此处省略post字段&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">while&lt;/span> &lt;span class="kc">True&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">system&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cmd&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>省略post字段可以通过chrome或者firefox调试工具得到, 此阶段刷票速度&lt;code>660票/分&lt;/code>&lt;/p>
&lt;h2 id="4-外挂进化">4. 外挂进化&lt;/h2>
&lt;p>同行票数继续狂飙, 某君决定稍稍&lt;code>优化&lt;/code>下老大的脚本, 结果如下:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">os&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">multiprocessing&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">Pool&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">multiprocessing.dummy&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">Pool&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">ThreadPool&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cmd&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;curl xxx此处省略post字段&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cmds&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">cmds&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cmds&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">cmds&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cmds&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">cmds&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">while&lt;/span> &lt;span class="kc">True&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pool&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ThreadPool&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">8&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pool&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">map&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">system&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">cmds&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pool&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pool&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>优化源于此文:&lt;a href="http://www.zhangzhibo.net/2014/02/01/parallelism-in-one-line/">一行 Python 实现并行化 -- 日常多线程操作的新思路&lt;/a>
此阶段刷票速度&lt;code>4600票/分&lt;/code>&lt;/p>
&lt;h2 id="5-丧心病狂">5. 丧心病狂&lt;/h2>
&lt;p>此时我司排名已经稳居前三, 但发现第四有迎头赶上的趋势, 同时老盯着排行榜排名也太无聊, 于是全自动无人值守每分钟4600票刷票脚本诞生&lt;/p>
&lt;blockquote>
&lt;p>可设定刷票目标,锁定第N位,如果不是第N位狂刷,如果已经是第N位,则暂停刷票脚本,每三分钟检测一次&lt;/p>
&lt;/blockquote>
&lt;p>此脚本&lt;code>chk.py&lt;/code>用来检测排名&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">subprocess&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">json&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">signal&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">os&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">datetime&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">tm&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strftime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;%Y-%m-&lt;/span>&lt;span class="si">%d&lt;/span>&lt;span class="s1"> %H:%M:%S&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 得到刷票程序pid&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">chk_pid&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">subprocess&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">getoutput&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;ps aux | grep python3\ /root/shuapiao/shua.py | grep -v grep | awk &lt;/span>&lt;span class="se">\&amp;#39;&lt;/span>&lt;span class="s2">{print $2}&lt;/span>&lt;span class="se">\&amp;#39;&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 获取所有参赛项目票数key:value=项目编号,票数&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cmd&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;curl &amp;#34;此处省略get字段, 可自行利用浏览器debug功能分析得到&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">json&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">loads&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">subprocess&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">check_output&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cmd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">shell&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;utf-8&amp;#39;&lt;/span>&lt;span class="p">))[&lt;/span>&lt;span class="s1">&amp;#39;map&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">res&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 获取自己票数&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">myown&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;我司id&amp;#39;&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="n">key&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 截取选票数&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">res&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">]))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 将票数从大到小排序&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">res&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">reverse&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">True&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tm&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;The top four votes:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">res&lt;/span>&lt;span class="p">[:&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="n">myown&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">res&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">myown&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">res&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">chk_pid&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tm&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;already on the second position, kill shua.py!&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">kill&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">chk_pid&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">signal&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">SIGTERM&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tm&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;already on the second position, do nothing!&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="n">chk_pid&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tm&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;not on the second position, run shua.py!&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">subprocess&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;nohup python3 /root/shuapiao/shua.py &amp;gt; /dev/null &amp;amp;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">shell&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tm&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;not on the second position yet!&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">myown&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">elif&lt;/span> &lt;span class="n">chk_pid&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tm&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;oops! pass the first position, kill shua.py!&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">kill&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">chk_pid&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">signal&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">SIGTERM&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>利用&lt;code>crontab&lt;/code>任务定时调用检测脚本&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c#" data-lang="c#">&lt;span class="line">&lt;span class="cl">&lt;span class="n">crontab&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="n">e&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">#&lt;/span> &lt;span class="err">内容&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">*/&lt;/span>&lt;span class="m">3&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">python3&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">shuapiao&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">chk&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">py&lt;/span> &lt;span class="p">&amp;gt;&amp;gt;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">shuapiao&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">result&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">#&lt;/span> &lt;span class="err">每三分钟运行一次&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="err">将输出记录到&lt;/span>&lt;span class="n">result中&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>此阶段刷票速度未提升&lt;/p>
&lt;h1 id="战果">战果&lt;/h1>
&lt;p>票数稳居排行榜第2或3位, 达到BOSS心理预期&lt;/p>
&lt;h1 id="后记">后记&lt;/h1>
&lt;p>感触蛮深, 科学技术果然是第一生产力啊(笑)&lt;/p>
&lt;ul>
&lt;li>人生苦短, 我用python3&lt;/li>
&lt;li>懒人思维(自动化无人值守)&lt;/li>
&lt;/ul></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category></item><item><title>Ubuntu 16.04 系统调优</title><link>https://blog.ferstar.org/post/optimize-ubuntu/</link><guid isPermaLink="true">https://blog.ferstar.org/post/optimize-ubuntu/</guid><pubDate>Thu, 10 Sep 2015 11:37:25 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;h2 id="删除旧内核">删除旧内核&lt;/h2>
&lt;p>一个偷懒的脚本解决战斗&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># purge-old-kernels - remove old kernel packages&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Copyright (C) 2012 Dustin Kirkland &amp;lt;kirkland@ubuntu.com&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Authors: Dustin Kirkland &amp;lt;kirkland@ubuntu.com&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Kees Cook &amp;lt;kees@ubuntu.com&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># This program is free software: you can redistribute it and/or modify&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># it under the terms of the GNU General Public License as published by&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># the Free Software Foundation, version 3 of the License.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># This program is distributed in the hope that it will be useful,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># GNU General Public License for more details.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># You should have received a copy of the GNU General Public License&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># along with this program. If not, see &amp;lt;http://www.gnu.org/licenses/&amp;gt;.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Ensure we&amp;#39;re running as root&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>id -u&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> !&lt;span class="o">=&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;ERROR: This script must run as root. Hint...&amp;#34;&lt;/span> 1&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34; sudo &lt;/span>&lt;span class="nv">$0&lt;/span>&lt;span class="s2"> &lt;/span>&lt;span class="nv">$@&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> 1&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># NOTE: This script will ALWAYS keep the currently running kernel&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># NOTE: Default is to keep 2 more, user overrides with --keep N&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">KEEP&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># NOTE: Any unrecognized option will be passed straight through to apt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">APT_OPTS&lt;/span>&lt;span class="o">=&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">while&lt;/span> &lt;span class="o">[&lt;/span> ! -z &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> in
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --keep&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># User specified the number of kernels to keep&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">KEEP&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$2&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">shift&lt;/span> &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">;;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> *&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">APT_OPTS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$APT_OPTS&lt;/span>&lt;span class="s2"> &lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">shift&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">;;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">esac&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Build our list of kernel packages to purge&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">CANDIDATES&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>ls -tr /boot/vmlinuz-* &lt;span class="p">|&lt;/span> head -n -&lt;span class="si">${&lt;/span>&lt;span class="nv">KEEP&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="p">|&lt;/span> grep -v &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>uname -r&lt;span class="k">)&lt;/span>$&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> cut -d- -f2- &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;{print &amp;#34;linux-image-&amp;#34; $0 &amp;#34; linux-headers-&amp;#34; $0}&amp;#39;&lt;/span> &lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> c in &lt;span class="nv">$CANDIDATES&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dpkg-query -s &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$c&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &amp;gt;/dev/null 2&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">1&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nv">PURGE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$PURGE&lt;/span>&lt;span class="s2"> &lt;/span>&lt;span class="nv">$c&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> -z &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$PURGE&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;No kernels are eligible for removal&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">apt &lt;span class="nv">$APT_OPTS&lt;/span> remove --purge &lt;span class="nv">$PURGE&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="替换-firefox-为国内版">替换 Firefox 为国内版&lt;/h2>
&lt;p>火狐自 Quantum 之后的版本在 Linux 上的体验都很棒，火狐通行证的同步也很方便，不过 Ubuntu 自带的火狐是国际版本，个人感觉不如国内版的同步速度快，所以就研究了下替换国内版的操作。&lt;/p>
&lt;h3 id="1-下载国内版火狐">1. 下载国内版火狐&lt;/h3>
&lt;p>via: &lt;a href="https://download-ssl.firefox.com.cn/releases/firefox/59.0/zh-CN/Firefox-latest-x86_64.tar.bz2">Firefox-latest-x86_64.tar.bz2&lt;/a>&lt;/p>
&lt;h3 id="2-重命名系统自带">2. 重命名系统自带&lt;/h3>
&lt;p>&lt;code>sudo mv /usr/lib/firefox /usr/lib/firefox.bak&lt;/code>&lt;/p>
&lt;h3 id="3-解压下载的文件放到usrlibfirefox">3. 解压下载的文件放到/usr/lib/firefox&lt;/h3>
&lt;p>&lt;code>sudo cp firefox /usr/lib/&lt;/code>&lt;/p>
&lt;h3 id="4-复制原-firefox-启动脚本">4. 复制原 Firefox 启动脚本&lt;/h3>
&lt;p>&lt;code>sudo cp /usr/lib/firefox.bak/firefox.sh /usr/lib/firefox&lt;/code>&lt;/p>
&lt;h3 id="5-复制原-dictionaries-软链接可不做">5. 复制原 dictionaries 软链接[可不做]&lt;/h3>
&lt;p>&lt;code>sudo cp /usr/lib/firefox.bak/dictionaries /usr/lib/firefox&lt;/code>&lt;/p>
&lt;h3 id="6-删除原默认配置文件">6. 删除原默认配置文件&lt;/h3>
&lt;p>&lt;code>rm -rf ~/.mozilla&lt;/code>&lt;/p>
&lt;h2 id="安装一些版权受限的软件">安装一些版权受限的软件&lt;/h2>
&lt;pre tabindex="0">&lt;code>sudo apt-get install ubuntu-restricted-extras
&lt;/code>&lt;/pre>&lt;h2 id="换个趁手的oh-my-zsh">换个趁手的oh-my-zsh&lt;/h2>
&lt;p>&lt;a href="http://ohmyz.sh/">http://ohmyz.sh/&lt;/a>
&lt;code>sh -c &amp;quot;$(curl -fsSL https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh)&amp;quot;&lt;/code>&lt;/p>
&lt;h2 id="右键添加打开终端的选项">&lt;del>右键添加&lt;code>打开终端&lt;/code>的选项&lt;/del>&lt;/h2>
&lt;p>&lt;del>&lt;code>sudo apt-get install nautilus-open-terminal&lt;/code>&lt;/del>&lt;/p>
&lt;blockquote>
&lt;p>似乎15.04开始这个package自带了～&lt;/p>
&lt;/blockquote>
&lt;h2 id="某些应用indicator图标无法正常显示问题">某些应用&lt;code>indicator&lt;/code>图标无法正常显示问题&lt;/h2>
&lt;p>&lt;code>sudo apt-get install python-appindicator&lt;/code>&lt;/p>
&lt;h2 id="更改chromium浏览器缓存到tmp">更改Chromium浏览器缓存到/tmp&lt;/h2>
&lt;p>&lt;code>sudo vi /etc/chromium-browser/default&lt;/code>
改路径到/tmp&lt;/p>
&lt;pre tabindex="0">&lt;code># Default settings for chromium-browser. This file is sourced by /bin/sh from
# /usr/bin/chromium-browser
# Options to pass to chromium-browser
CHROMIUM_FLAGS=&amp;#34;--disk-cache-dir=/tmp/Chromium/&amp;#34;
&lt;/code>&lt;/pre>&lt;p>收工～啥？还在用火狐？启动那么慢能忍受么。。。&lt;/p>
&lt;h2 id="利用tmpfs文件系统要求ram4g">利用tmpfs文件系统（要求&lt;code>RAM&amp;gt;4G&lt;/code>）&lt;/h2>
&lt;p>&lt;code>sudo vi /etc/fstab&lt;/code>
新起一行，写入以下内容&lt;/p>
&lt;pre tabindex="0">&lt;code># temporary directories
tmpfs /tmp tmpfs defaults,noatime,mode=1777 0 0
tmpfs /var/tmp tmpfs defaults,noatime,mode=1777 0 0
tmpfs /var/spool tmpfs defaults,noatime,mode=1777 0 0
# log directories
tmpfs /var/log tmpfs defaults,noatime,mode=0755 0 0
&lt;/code>&lt;/pre>&lt;h2 id="调swappiness值">调&lt;code>swappiness&lt;/code>值&lt;/h2>
&lt;p>关于swap的介绍，挺详细
&lt;a href="https://help.ubuntu.com/community/SwapFaq">https://help.ubuntu.com/community/SwapFaq&lt;/a>
我机器内存够大，所以基本上是不分swap分区的
&lt;code>sudo gedit /etc/sysctl.conf&lt;/code>
Search for vm.swappiness and change its value as desired. If vm.swappiness does not exist, add it to the end of the file like so:
&lt;code>vm.swappiness=10&lt;/code>
内存如果够大，这里完全可以设为0，或者干脆干掉swap分区，机智如我～&lt;/p>
&lt;h2 id="关于磁盘分区格式的选择">关于磁盘分区格式的选择&lt;/h2>
&lt;ul>
&lt;li>我只分三个&lt;code>/efi fat16 # 100MB左右足够&lt;/code>、&lt;code>/ ext4 # 20GB左右&lt;/code>和&lt;code>/home ext4 #剩余空间全给&lt;/code>，如果是SSD，格式换为&lt;a href="https://wiki.archlinux.org/index.php/Btrfs">&lt;code>btrfs&lt;/code>&lt;/a>&lt;/li>
&lt;li>要不要swap分区？我的选择是不要，因为物理内存足够大，就算不够用，可以随时用swapfile启用，用完再删即可&lt;/li>
&lt;/ul>
&lt;h2 id="截图工具的选择">截图工具的选择&lt;/h2>
&lt;p>我比较喜欢用深度截图工具，简单好用
&lt;a href="http://packages.linuxdeepin.com/deepin/pool/main/d/deepin-scrot/deepin-scrot_2.0-0deepin_all.deb">deepin-scrot_2.0-0deepin_all.deb&lt;/a>&lt;/p>
&lt;pre tabindex="0">&lt;code>sudo dpkg -i deepin-scrot_2.0-0deepin_all.deb
sudo apt-get -f install
&lt;/code>&lt;/pre>&lt;p>然后设定快捷键呼出&lt;code>ctrl+alt+A&lt;/code>
&lt;code>system-settings --&amp;gt; keyboard --&amp;gt; custom shortcuts&lt;/code>添加&lt;code>command&lt;/code> &lt;code>deepin-scrot %u&lt;/code>绑定&lt;code>ctrl+alt+A&lt;/code>&lt;/p>
&lt;h2 id="禁用系统bug报告弹窗">禁用系统bug报告弹窗&lt;/h2>
&lt;p>bug报告本来是好事，但无奈弹的太多了些，多数情况除了影响心情外，并没有什么卵用，所以需要禁用之：
&lt;code>sudo vi /etc/default/apport&lt;/code>&lt;/p>
&lt;pre tabindex="0">&lt;code># set this to 0 to disable apport, or to 1 to enable it
# you can temporarily override this with
# sudo service apport start force_start=1
enabled=0
&lt;/code>&lt;/pre>&lt;h2 id="更改普通用户密码为简单密码">更改普通用户密码为简单密码&lt;/h2>
&lt;p>系统默认策略不允许普通用户设定简单密码，所以如果想要设定简单密码的话，可以先切到root然后再换&lt;/p>
&lt;pre tabindex="0">&lt;code>sudo -i
passwd uersname
&lt;/code>&lt;/pre>&lt;h2 id="安装deb二进制包">安装&lt;code>deb&lt;/code>二进制包&lt;/h2>
&lt;p>可以简单的双击安装， 或者命令行&lt;/p>
&lt;pre tabindex="0">&lt;code>sudo dpkg -i xxx.deb
sudo apt-get -f install
&lt;/code>&lt;/pre>&lt;h2 id="百度网盘bcloud">百度网盘&lt;code>bcloud&lt;/code>&lt;/h2>
&lt;p>&lt;a href="https://github.com/LiuLang/bcloud">https://github.com/LiuLang/bcloud&lt;/a>&lt;/p>
&lt;h2 id="为知笔记">为知笔记&lt;/h2>
&lt;p>&lt;a href="http://blog.wiz.cn/downloads-mac-linux.html">http://blog.wiz.cn/downloads-mac-linux.html&lt;/a>&lt;/p>
&lt;h2 id="wineqq">wineQQ&lt;/h2>
&lt;p>&lt;a href="http://www.ubuntukylin.com/application/show.php?lang=cn&amp;amp;amp;id=279">http://www.ubuntukylin.com/application/show.php?lang=cn&amp;amp;id=279&lt;/a>&lt;/p>
&lt;h2 id="wps">WPS&lt;/h2>
&lt;p>&lt;a href="http://www.ubuntukylin.com/application/show.php?lang=cn&amp;amp;amp;id=278">http://www.ubuntukylin.com/application/show.php?lang=cn&amp;amp;id=278&lt;/a>&lt;/p>
&lt;h2 id="正常挂载exfat分区">正常挂载exfat分区&lt;/h2>
&lt;p>&lt;code>sudo apt-get install exfat-utils&lt;/code>&lt;/p>
&lt;h2 id="搜狗输入法">搜狗输入法&lt;/h2>
&lt;p>&lt;a href="http://pinyin.sogou.com/linux/?r=pinyin">http://pinyin.sogou.com/linux/?r=pinyin&lt;/a>&lt;/p>
&lt;h2 id="ffmpeg-package">ffmpeg package&lt;/h2>
&lt;p>&lt;a href="https://launchpad.net/~mc3man/+archive/ubuntu/trusty-media">https://launchpad.net/~mc3man/+archive/ubuntu/trusty-media&lt;/a>&lt;/p>
&lt;h2 id="nodejshexo">nodejs&amp;amp;&amp;amp;hexo&lt;/h2>
&lt;p>&lt;a href="https://nodejs.org/en/">https://nodejs.org/en/&lt;/a>
默认的NPM太慢，可以转投淘宝镜像&lt;/p>
&lt;h2 id="优秀的markdown编辑器">优秀的markdown编辑器&lt;/h2>
&lt;p>现在转用这个了：https://typora.io&lt;/p>
&lt;p>&lt;a href="https://remarkableapp.github.io/linux/download.html">remarkableapp.github.io&lt;/a>&lt;/p>
&lt;h2 id="git可视化比较工具">git可视化比较工具&lt;/h2>
&lt;p>&lt;a href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Configuration#External-Merge-and-Diff-Tools">External-Merge-and-Diff-Tools&lt;/a>&lt;/p>
&lt;h2 id="局域网同步神器bittorrent-sync">局域网同步神器BitTorrent Sync&lt;/h2>
&lt;p>&lt;a href="https://www.getsync.com/">软件主页&lt;/a>
&lt;a href="https://program-think.blogspot.com/2015/01/BitTorrent-Sync.html">扫盲&lt;/a>
需要注意的几个设置选项如图
&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/png/2015/11/410402d76bcd052e7393eb449cdcbea6.png" alt="DeepinScrot-5830.png">&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/shell/">SHELL</category><category domain="https://blog.ferstar.org/tags/ubuntu/">UBUNTU</category></item><item><title>SwapFAQ</title><link>https://blog.ferstar.org/post/swapfaq/</link><guid isPermaLink="true">https://blog.ferstar.org/post/swapfaq/</guid><pubDate>Thu, 10 Sep 2015 11:26:52 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>关于swap的介绍，挺详细，值得一看：
&lt;a href="https://help.ubuntu.com/community/SwapFaq">https://help.ubuntu.com/community/SwapFaq&lt;/a>&lt;/p>
&lt;p>其中比较常用的就是调&lt;code>swappiness&lt;/code>值&lt;/p>
&lt;ul>
&lt;li>To check the swappiness value
&lt;code>cat /proc/sys/vm/swappiness&lt;/code>&lt;/li>
&lt;li>To change the swappiness value A temporary change (lost on reboot) with a swappiness value of 10 can be made with
&lt;code>sudo sysctl vm.swappiness=10&lt;/code>&lt;/li>
&lt;li>To make a change permanent, edit the configuration file with your favorite editor:
&lt;code>sudo gedit /etc/sysctl.conf&lt;/code>&lt;/li>
&lt;li>Search for vm.swappiness and change its value as desired. If vm.swappiness does not exist, add it to the end of the file like so:
&lt;code>vm.swappiness=10&lt;/code>内存如果够大，这里完全可以设为0，或者干脆干掉swap分区
Save the file and reboot.&lt;/li>
&lt;/ul></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>使用hexo来写博客</title><link>https://blog.ferstar.org/post/use-hexo-on-my-way/</link><guid isPermaLink="true">https://blog.ferstar.org/post/use-hexo-on-my-way/</guid><pubDate>Wed, 09 Sep 2015 10:25:22 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>&lt;a href="https://hexo.io/zh-cn/docs/">官方说明&lt;/a>&lt;/p>
&lt;h1 id="我的安装过程">我的安装过程&lt;/h1>
&lt;h2 id="装nodejs">装nodejs&lt;/h2>
&lt;p>访问官网下载
&lt;a href="https://nodejs.org/en/">https://nodejs.org/en/&lt;/a>
解压到&lt;code>～/.bin/&lt;/code>目录
添加环境变量
&lt;code>vim ～/.zshrc&lt;/code>如下（我用的zsh）&lt;/p>
&lt;pre tabindex="0">&lt;code># export MANPATH=&amp;#34;/usr/local/man:$MANPATH&amp;#34;
export PATH=&amp;#34;$HOME/.bin/node-v4.0.0-linux-x64/bin:$PATH&amp;#34;
source $ZSH/oh-my-zsh.sh
&lt;/code>&lt;/pre>&lt;p>然后source一下&lt;code>source ～/.zshrc&lt;/code>
检查是否正确指定&lt;code>node -v&lt;/code>正常应该显示版本号&lt;code>v4.0.0&lt;/code>&lt;/p>
&lt;h2 id="装git">装git&lt;/h2>
&lt;p>&lt;code>sudo apt-get install git&lt;/code>就这样&lt;/p>
&lt;h2 id="装淘宝cnpm替换npm">装淘宝cnpm替换npm&lt;/h2>
&lt;p>&lt;a href="http://ferstar.org/2015/09/04/%E6%B7%98%E5%AE%9DNPM%E9%95%9C%E5%83%8F/">淘宝npm镜像&lt;/a>&lt;/p>
&lt;pre tabindex="0">&lt;code>npm install -g cnpm --registry=https://registry.npm.taobao.org
&lt;/code>&lt;/pre>&lt;p>一切为了速度！&lt;/p>
&lt;h2 id="安装hexo">安装hexo&lt;/h2>
&lt;p>&lt;code>cnpm install -g hexo-cli&lt;/code>
是的你没看错，是cnpm而不是npm
检查下版本&lt;code>hexo -v&lt;/code>正确输出如下&lt;/p>
&lt;pre tabindex="0">&lt;code>hexo-cli: 0.1.8
os: Linux 3.19.0-26-generic linux x64
http_parser: 2.5.0
node: 4.0.0
v8: 4.5.103.30
uv: 1.7.3
zlib: 1.2.8
ares: 1.10.1-DEV
modules: 46
openssl: 1.0.2d
&lt;/code>&lt;/pre>&lt;h2 id="建站">建站&lt;/h2>
&lt;p>安装 Hexo 完成后，请执行下列命令，Hexo 将会在指定文件夹中新建所需要的文件
&lt;code>hexo init blog&lt;/code>输出如下&lt;/p>
&lt;pre tabindex="0">&lt;code>INFO Copying data to ~/blog
INFO You are almost done! Don&amp;#39;t forget to run &amp;#39;npm install&amp;#39; before you start blogging with Hexo!
&lt;/code>&lt;/pre>&lt;p>&lt;code>cd blog&lt;/code>and&lt;code>cnpm install&lt;/code>输出如下（截取一部分）&lt;/p>
&lt;pre tabindex="0">&lt;code>parser2@3.8.3)
├── nunjucks@1.3.4 (optimist@0.6.1, chokidar@0.12.6)
├── hexo-util@0.1.7 (ent@2.2.0, highlight.js@8.8.0)
├── bunyan@1.5.1 (safe-json-stringify@1.0.3, dtrace-provider@0.6.0, mv@2.1.1)
├── moment-timezone@0.3.1
├── lodash@3.10.1
├── moment@2.10.6
└── swig@1.4.2 (optimist@0.6.1, uglify-js@2.4.24)
&lt;/code>&lt;/pre>&lt;p>完成后，指定文件夹的目录如下：&lt;/p>
&lt;pre tabindex="0">&lt;code>├── _config.yml
├── node_modules
│ ├── hexo
│ ├── hexo-generator-archive
│ ├── hexo-generator-category
│ ├── hexo-generator-index
│ ├── hexo-generator-tag
│ ├── hexo-renderer-ejs
│ ├── hexo-renderer-marked
│ ├── hexo-renderer-stylus
│ └── hexo-server
├── package.json
├── scaffolds
│ ├── draft.md
│ ├── page.md
│ └── post.md
├── source
│ └── _posts
└── themes
└── landscape
&lt;/code>&lt;/pre>&lt;p>生成这个目录树的程序叫&lt;code>tree&lt;/code>可以&lt;code>man tree&lt;/code>查看他的具体用法
其他说明官网说明写的很清楚&lt;a href="https://hexo.io/zh-cn/docs/setup.html">hexo.io&lt;/a>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>把指定目录下所有源码汇集到一个md文件的脚本</title><link>https://blog.ferstar.org/post/generate-all-src-content-into-md/</link><guid isPermaLink="true">https://blog.ferstar.org/post/generate-all-src-content-into-md/</guid><pubDate>Fri, 04 Sep 2015 22:22:15 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>一个用来把指定目录下所有文本文件内容汇集到一个md文件的python脚本&lt;/p>
&lt;pre tabindex="0">&lt;code>import os
import os.path
rootdir = &amp;#39;/the_path_to_your_src&amp;#39;
for parent, dirnames, filenames in os.walk(rootdir):
for filename in filenames:
peer_path = os.path.join(parent,filename)
with open(peer_path, &amp;#34;r&amp;#34;) as src:
data = src.read()
with open(&amp;#34;out.md&amp;#34;, &amp;#34;a+&amp;#34;) as out
out.write(&amp;#34;# &amp;#34; + peer_path)
out.write(&amp;#34;\n\n```\n&amp;#34;)
out.write(data)
out.write(&amp;#34;\n```\n&amp;#34;)
&lt;/code>&lt;/pre>&lt;p>效果图&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/blog/image/2015-09-04%2023%3A03%3A58.png" alt="我是图">&lt;/p>
&lt;p>代码审核时可能会用到:-)&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/python/">PYTHON</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>使用docker构建hexo环境</title><link>https://blog.ferstar.org/post/deploy-hexo-to-docker/</link><guid isPermaLink="true">https://blog.ferstar.org/post/deploy-hexo-to-docker/</guid><pubDate>Fri, 04 Sep 2015 19:08:47 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;h1 id="前言">前言&lt;/h1>
&lt;p>最近花了点时间重整博客，由于受不了wordpress的日益臃肿，决定迁移到时下很火的&lt;a href="https://hexo.io/">hexo&lt;/a>，hexo基于node.js，所以首先需要搭建node环境，折腾起来略麻烦，实在不想在公司机器和自己的笔电上来回装，于是打算寻个一劳永逸的方法，偶然想到&lt;a href="https://www.docker.com/">docker&lt;/a> ，所以就有了下面的尝试……&lt;/p>
&lt;h1 id="开始尝试">开始尝试&lt;/h1>
&lt;h2 id="安装docker">安装docker&lt;/h2>
&lt;h3 id="懒人安装法">懒人安装法&lt;/h3>
&lt;p>&lt;code>apt-get install update &amp;amp;&amp;amp; apt-get install -y docker.io&lt;/code> &lt;br>
装完之后会自动启动docker服务，此方法安装的docker版本略低，所以并不推荐。&lt;/p>
&lt;h3 id="略高大的安装法">略高大的安装法&lt;/h3>
&lt;p>大部分Linux发行版均可以通过下面的命令安装：
&lt;code>curl -sSL https://get.daocloud.io/docker | sh&lt;/code>&lt;br>
为了下载docker镜像的速度能快些，建议配置好&lt;a href="https://www.daocloud.io/">daocloud&lt;/a> 加速。&lt;/p>
&lt;h2 id="获取镜像">获取镜像&lt;/h2>
&lt;p>本来的命令是&lt;code>docker pull ubuntu:14.04&lt;/code>，如果配置了daocloud加速的话，会是这样&lt;code>dao pull ubuntu:14.04&lt;/code>&lt;/p>
&lt;h2 id="运行容器">运行容器&lt;/h2>
&lt;p>&lt;code>docker run -t -i ubuntu:14.04 /bin/bash&lt;/code>
记住容器的id，比如&lt;code>0b2616b0e5a8&lt;/code>&lt;/p>
&lt;h2 id="更换容器sourceslist">更换容器sources.list&lt;/h2>
&lt;p>修改repo指向阿里云ubuntu镜像
&lt;code>sed -i ‘s/us.archive.ubuntu.com/mirrors.aliyun.com/g’ /etc/apt/sources.list&lt;/code>&lt;/p>
&lt;h2 id="容器中添加hexo相关应用">容器中添加hexo相关应用&lt;/h2>
&lt;ul>
&lt;li>&lt;code>apt-get update&lt;/code>&lt;br>
&lt;code>apt-get install -y git-core nodejs npm&lt;/code>&lt;/li>
&lt;li>软链接nodejs到node
&lt;code>ln -s /usr/bin/nodejs /usr/bin/node&lt;/code>&lt;/li>
&lt;li>安装hexo，也许你需要阿里cnpm的拯救，传送门：&lt;a href="http://ferstar.org/2015/09/04/%E6%B7%98%E5%AE%9DNPM%E9%95%9C%E5%83%8F/">淘宝NPM镜像&lt;/a>
&lt;code>cnpm install -g hexo&lt;/code>&lt;/li>
&lt;li>添加一个非root用户&lt;br>
&lt;code>adduser hexo&lt;/code>剩下的按照提示做即可&lt;/li>
&lt;li>完成后&lt;code>exit&lt;/code>退出，此时容器已经改变，用docker commit命令提交更新后的副本
&lt;code>sudo docker commit -m &amp;quot;Added hexo&amp;quot; -a &amp;quot;Docker hexo&amp;quot; 0b2616b0e5a8 hexo:v1&lt;/code>&lt;/li>
&lt;/ul>
&lt;h2 id="用dockerfile来创建镜像">用Dockerfile来创建镜像&lt;/h2>
&lt;p>dockerfile内容大概是这样子：&lt;/p>
&lt;pre tabindex="0">&lt;code>#
# Hexo Dockerfile
#
# Pull base image.
FROM hexo:v1
MAINTAINER ferstar &amp;lt;zhangjianfei3@gmail.com&amp;gt;
ENV HOME /home/hexo
# Mount a Host Directory as a Data Volume for hexo
VOLUME /blog
# Expose ports.
EXPOSE 4000
WORKDIR /blog
USER hexo
&lt;/code>&lt;/pre>&lt;p>根据dockerfile创建镜像
&lt;code>docker build -t hexo:v2 .&lt;/code>&lt;/p>
&lt;h2 id="测试容器hexo是否安装成功">测试容器hexo是否安装成功&lt;/h2>
&lt;p>&lt;code>docker run --rm -v &amp;quot;$PWD:/blog&amp;quot; -p 4000:4000 hexo:v2 hexo -v&lt;/code>
结果显示如下，说明安装成功&lt;/p>
&lt;pre tabindex="0">&lt;code>hexo: 3.1.1
os: Linux 3.19.0-28-generic linux x64
http_parser: 1.0
node: 0.10.25
v8: 3.14.5.9
ares: 1.10.0
uv: 0.10.23
zlib: 1.2.8
modules: 11
openssl: 1.0.1f
&lt;/code>&lt;/pre>&lt;h2 id="导出镜像到本地">导出镜像到本地&lt;/h2>
&lt;p>&lt;code>docker save -o hexo_v2.tar hexo:v2&lt;/code>&lt;/p>
&lt;h2 id="部署镜像到新系统">部署镜像到新系统&lt;/h2>
&lt;p>此时新系统只需要安装docker，然后将上一步生成的镜像导入docker中
&lt;code>docker load &amp;lt; hexo_v2.tar&lt;/code>&lt;/p>
&lt;h2 id="在新系统中部署hexo博客">在新系统中部署hexo博客&lt;/h2>
&lt;p>新建博客目录，如&lt;code>~/blog&lt;/code>&lt;/p>
&lt;pre tabindex="0">&lt;code>mkdir ~/blog
cd blog
&lt;/code>&lt;/pre>&lt;p>原本的初始化命令&lt;code>hexo init&lt;/code>变成了如下的命令
&lt;code>docker run --rm -v &amp;quot;$PWD:/blog&amp;quot; -p 4000:4000 hexo:v2 hexo init&lt;/code>
&lt;code>npm install&lt;/code>变成如下的命令
&lt;code>docker run --rm -v &amp;quot;$PWD:/blog&amp;quot; -p 4000:4000 hexo:v2 cnpm install&lt;/code>
至此，新的hexo blog即成功建立，当然为了简化命令，你可以把上述命令加入到bash或者zsh alias里面，如&lt;/p>
&lt;pre tabindex="0">&lt;code>docker-hexo=&amp;#34;docker run --rm -v &amp;#34;$PWD:/blog&amp;#34; -p 4000:4000 hexo:v2&amp;#34;
hexo=&amp;#34;docker-hexo hexo&amp;#34;
&lt;/code>&lt;/pre>&lt;p>重新打开终端后hexo命令就和原来一样用了，&lt;code>npm&lt;/code>命令则变成了&lt;code>docker-hexo cnpm&lt;/code>
安装插件的命令变成这样
&lt;code>docker-hexo cnpm install plugin_name --save&lt;/code>
至于平时写作发布指令跟原来别无二致&lt;/p>
&lt;h1 id="后记">后记&lt;/h1>
&lt;p>生成的docker镜像还是太大，417MB，过程也略繁琐，需要进一步选择轻量级的迁移方案。&lt;/p>
&lt;h1 id="参考文章">参考文章&lt;/h1>
&lt;ol>
&lt;li>&lt;a href="http://www.philo.top/1899/11/30/ubuntuChangeRepo/">ubuntu 修改repo直接成阿里云&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://open.daocloud.io/build-hexo-env-by-docker-under-osx/">在OSX下使用docker构建hexo环境&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://yeasy.gitbooks.io/docker_practice/content/index.html">Docker —— 从入门到实践&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/billryan/docker-hexo">Docker Container for Hexo&lt;/a>&lt;/li>
&lt;/ol></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/docker/">DOCKER</category><category domain="https://blog.ferstar.org/tags/hexo/">HEXO</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>淘宝NPM镜像</title><link>https://blog.ferstar.org/post/%E6%B7%98%E5%AE%9Dnpm%E9%95%9C%E5%83%8F/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E6%B7%98%E5%AE%9Dnpm%E9%95%9C%E5%83%8F/</guid><pubDate>Fri, 04 Sep 2015 16:47:32 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>这是一个完整 npmjs.org 镜像，你可以用此代替官方版本&lt;/p>
&lt;h1 id="使用说明">使用说明&lt;/h1>
&lt;p>使用阿里定制的cnpm工具代替默认的npm，也就是默认走阿里镜像的npm，可以方便天朝人民以一种比较和谐的速度同步nodejs软件包。
&lt;code>npm install -g cnpm --registry=https://registry.npm.taobao.org&lt;/code>&lt;br>
详情见官网说明：&lt;a href="https://npm.taobao.org/">https://npm.taobao.org/&lt;/a>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>build rtl8192 usb wireless drivers for nvidia jetson tk1 lt4-21-1 and permanently disable the power management</title><link>https://blog.ferstar.org/post/build-rtl8192-usb-wireless-drivers-for-nvidia-jetson-tk1-lt4-21-1-and-permanently-disable-the-power-management/</link><guid isPermaLink="true">https://blog.ferstar.org/post/build-rtl8192-usb-wireless-drivers-for-nvidia-jetson-tk1-lt4-21-1-and-permanently-disable-the-power-management/</guid><pubDate>Mon, 31 Aug 2015 23:20:43 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;ul>
&lt;li>
&lt;p>download the kernel sources from &lt;a href="http://developer.download.nvidia.com/mobile/tegra/l4t/r21.1.0/sources/kernel_src.tbz2">developer.download.nvidia.com&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>decompressed the files into /usr/src, the directory should like this /usr/src/kernel.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>#zcat /proc/config.gz &amp;gt; /usr/src/kernel/.config&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>$cd /usr/src/kernel &lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>#make prepare&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>#make modules_prepare&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>$cd /the/path/to/the/usb/driver/&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>$make ARCH=arm&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>#make install&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>block the default rtl8192cu driver&lt;br>
&lt;code>vi /etc/modprobe.d/blacklist-native-rtl8192.conf&lt;/code>
This file ships with the rtl8192-fixes DKMS module.
Blacklist the native (and currently broken) kernel driver so
ours gets loaded instead:
blacklist rtl8192cu
blacklist rtl8192c_common
blacklist rtlwifi
&lt;code>vi /etc/modprobe.d/8192cu.conf&lt;/code>
prevent power down of wireless when idle
options 8192cu rtw_power_mgnt=0&lt;/p>
&lt;/li>
&lt;li>
&lt;p>reboot the device
you can check the status if it is off:
&lt;code>cat /sys/module/8192cu/parameters/rtw_power_mgnt&lt;/code>
it should be 0 now.&lt;/p>
&lt;/li>
&lt;/ul></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>How to get the process ID to kill a nohup process?</title><link>https://blog.ferstar.org/post/how-to-get-the-process-id-to-kill-a-nohup-process/</link><guid isPermaLink="true">https://blog.ferstar.org/post/how-to-get-the-process-id-to-kill-a-nohup-process/</guid><pubDate>Mon, 31 Aug 2015 23:19:47 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>When using &lt;code>nohup&lt;/code>, it will give you the &lt;code>PID&lt;/code> at the command prompt. If your plan is to manually manage the process, you can save that &lt;code>PID&lt;/code> and use it later to kill the process if needed, via &lt;code>kill PID&lt;/code> or &lt;code>kill -9 PID&lt;/code> (if you need to force kill). Alternatively, you can find the PID later on by &lt;code>ps -ef output | grep &amp;quot;command name&amp;quot;&lt;/code> and locate the PID from there. Note that nohup does not appear in the ps output.&lt;/p>
&lt;p>If you used a script, you could do something like:&lt;/p>
&lt;pre tabindex="0">&lt;code>nohup my_command &amp;gt; my.log 2&amp;gt;&amp;amp;1&amp;amp;
echo $! &amp;gt; save_pid.txt
&lt;/code>&lt;/pre>&lt;p>This will run my_command saving all output into my.log (in a script, &lt;code>$!&lt;/code> represents the PID of the last process executed). If the command sends output on a regular basis, you can check the output occasionally with tail my.log, or if you want to follow it &amp;quot;live&amp;quot; you can use &lt;code>tail -f my.log&lt;/code>. Finally, if you need to kill the process, you can do it via:&lt;/p>
&lt;pre tabindex="0">&lt;code>kill -9 `cat save_pid.txt`
&lt;/code>&lt;/pre>&lt;p>来源： &lt;a href="http://stackoverflow.com/questions/17385794/how-to-get-the-process-id-to-kill-a-nohup-process">http://stackoverflow.com/questions/17385794/how-to-get-the-process-id-to-kill-a-nohup-process&lt;/a>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>树莓派视频监控折腾记录</title><link>https://blog.ferstar.org/post/%E6%A0%91%E8%8E%93%E6%B4%BE%E8%A7%86%E9%A2%91%E7%9B%91%E6%8E%A7%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E6%A0%91%E8%8E%93%E6%B4%BE%E8%A7%86%E9%A2%91%E7%9B%91%E6%8E%A7%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/</guid><pubDate>Mon, 31 Aug 2015 23:16:05 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>检查更新&lt;/p>
&lt;pre tabindex="0">&lt;code>sudo apt-get install rpi-update
sudo rpi-update
&lt;/code>&lt;/pre>&lt;p>默认的源在国外, 下载速度太慢, 所以需要修改默认源到国内, 试了好几个, 发现公司的网络访问阿里云的源速度不错&lt;/p>
&lt;pre tabindex="0">&lt;code>sudo vi /etc/apt/sources.list
deb http://mirrors.aliyun.com/raspbian/raspbian/ wheezy main non-free contrib
deb-src http://mirrors.aliyun.com/raspbian/raspbian/ wheezy main non-free contrib
&lt;/code>&lt;/pre>&lt;p>进行更新&lt;/p>
&lt;pre tabindex="0">&lt;code>sudo apt-get update
sudo apt-get upgrade
&lt;/code>&lt;/pre>&lt;p>&lt;code>注: tf卡居然是4G的, 容量不太够, 需要弄个大点的, 暂时就这样省着点花, 先瘦瘦身 后来发现其实卡是16G的, 只是原版系统是直接写入的镜像, 有大片的空间没用到, 很浪费有没有, 赶紧用gparted把未使用空间划给/rootfs, 瞬间清净, 想咋整就咋整.&lt;/code>&lt;/p>
&lt;pre tabindex="0">&lt;code>sudo apt-get autoremove #删除不需要的孤立包
sudo apt-get clean # 删除deb包
&lt;/code>&lt;/pre>&lt;p>更新操作完毕, 再次查看下更新有无问题&lt;/p>
&lt;pre tabindex="0">&lt;code>sudo apt-get install -f # 如果有安装错误, 修复之
&lt;/code>&lt;/pre>&lt;p>重启
&lt;code>sudo reboot&lt;/code>
使用摄像头uv4l原生驱动(系统自带驱动不太给力)
&lt;a href="http://www.ics.com/blog/raspberry-pi-camera-module">http://www.ics.com/blog/raspberry-pi-camera-module&lt;/a>
&lt;a href="http://www.linux-projects.org/modules/sections/index.php?op=viewarticle&amp;amp;artid=14">http://www.linux-projects.org/modules/sections/index.php?op=viewarticle&amp;amp;artid=14&lt;/a>
&lt;code>$ curl http://www.linux-projects.org/listing/uv4l_repo/lrkey.asc | sudo apt-key add -&lt;/code>
在/etc/apt/sources.list添加
&lt;code>deb http://www.linux-projects.org/listing/uv4l_repo/raspbian/ wheezy main&lt;/code>
更新软件列表&amp;amp;安装摄像头驱动包&lt;/p>
&lt;pre tabindex="0">&lt;code>sudo apt-get update
sudo apt-get install uv4l uv4l-raspicam uv4l-raspicam-extras
&lt;/code>&lt;/pre>&lt;p>着手编译mjpg-streamer
&lt;code>CFLAGS+=&amp;quot;-O2 -march=armv6 -mfpu=vfp -mfloat-abi=hard&amp;quot; make USE_LIBV4L2=true clean all&lt;/code>
from: &lt;a href="https://github.com/ferstar/rpi-mjpg-streamer">https://github.com/ferstar/rpi-mjpg-streamer&lt;/a> 当然是fork别人的了
mjpg-streamer编译后自带的sample页面比较挫, 把www里的内容换成rpi-mjpg-streamer/www里的
现在轮到测试了&lt;/p>
&lt;pre tabindex="0">&lt;code>./mjpg_streamer -i &amp;#39;./input_uvc.so -d /dev/video0 -y -n -r 320x240 -f 24&amp;#39; -o &amp;#39;./output_http.so -w ./www -p 8080&amp;#39;
# -n 的作用仅仅是屏蔽掉一些乱七八糟的warning提示而已
# -d /dev/video0 这里指定的是我们摄像头的挂载位置
# -r 分辨率, 越低实时性越好, 但画质越渣
# -f 帧率, 貌似最高支持到30
# -w /www web根目录
# -p 端口
#
# -y 指定视频采集格式为YUYV, 摄像头不支持mpeg格式
# from http://stackoverflow.com/questions/13437244/mjpg-streaming-with-a-raspberry-pi-and-a-webcam
#
&lt;/code>&lt;/pre>&lt;p>正常终端显示如下:&lt;/p>
&lt;pre tabindex="0">&lt;code>MJPG Streamer Version: svn rev: 3:172M
i: Using V4L2 device.: /dev/video0
i: Desired Resolution: 320 x 240
i: Frames Per Second.: 24
i: Format............: YUV
i: JPEG Quality......: 80
o: www-folder-path...: ./www/
o: HTTP TCP port.....: 8080
o: username:password.: disabled
o: commands..........: enabled
&lt;/code>&lt;/pre>&lt;p>浏览器访问: &lt;a href="http://your.pi">http://your.pi&lt;/a>'s.ip:8080 即可看到监控视频流
当然也可以使用VLC播放器播放 &lt;a href="http://your.pi">http://your.pi&lt;/a>'s.ip:8080/?action=stream&lt;/p>
&lt;p>接下来应该是折腾无线接入了
lsusb信息:
&lt;code>Bus 001 Device 005: ID 0bda:8176 Realtek Semiconductor Corp. RTL8188CUS 802.11n WLAN Adapter&lt;/code>
默认8192cu驱动会有电源管理自动休眠掉线问题, 需要关掉这个功能&lt;/p>
&lt;pre tabindex="0">&lt;code>vi /etc/modprobe.d/8192cu.conf
options 8192cu rtw_power_mgnt=0
&lt;/code>&lt;/pre>&lt;p>检查下生效没有:&lt;/p>
&lt;pre tabindex="0">&lt;code>sudo rmmod 8192cu # 卸载wifi驱动模块
sudo modprobe 8192cu # 重新挂载
cat /sys/module/8192cu/parameters/rtw_power_mgnt # 显示为0即表示关闭自动休眠(默认为1开启)
&lt;/code>&lt;/pre>&lt;p>配置网络连接:
&lt;code>sudo vi /etc/network/interfaces&lt;/code>
内容如下:&lt;/p>
&lt;pre tabindex="0">&lt;code>auto lo
iface lo inet loopback
iface eth0 inet dhcp
allow-hotplug wlan0
iface wlan0 inet manual
wpa-roam /etc/wpa_supplicant/wpa_supplicant.conf
iface default inet dhcp
iface wlan0 inet dhcp
wpa-ssid &amp;#34;xxx&amp;#34; #ssid
wpa-psk &amp;#34;xxx&amp;#34; #passwd
&lt;/code>&lt;/pre>&lt;p>添加无线信息:
&lt;code>sudo vi /etc/wpa_supplicant/wpa_supplicant.conf&lt;/code>
内容如下&lt;/p>
&lt;pre tabindex="0">&lt;code>ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1
network={
ssid=&amp;#34;xxx&amp;#34;
psk=&amp;#34;xxx&amp;#34;
proto=RSN
key_mgmt=WPA-PSK
pairwise=CCMP
auth_alg=OPEN
}
&lt;/code>&lt;/pre>&lt;p>然后启动wifi:
&lt;code>sudo ifup wlan0&lt;/code>
查看wifi连接信息:
&lt;code>ifconfig wlan0&lt;/code>
内容如下:&lt;/p>
&lt;pre tabindex="0">&lt;code>wlan0 Link encap:Ethernet HWaddr e8:4e:06:29:0f:3b
inet addr:192.168.1.199 Bcast:192.168.1.255 Mask:255.255.255.0
UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1
RX packets:2662 errors:0 dropped:1 overruns:0 frame:0
TX packets:30 errors:0 dropped:0 overruns:0 carrier:0
collisions:0 txqueuelen:1000
RX bytes:263097 (256.9 KiB) TX bytes:3227 (3.1 KiB)
&lt;/code>&lt;/pre>&lt;p>至此网络部分正常.&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>实用shell脚本整理（不定期更新）</title><link>https://blog.ferstar.org/post/%E5%AE%9E%E7%94%A8shell%E8%84%9A%E6%9C%AC%E6%95%B4%E7%90%86%E4%B8%8D%E5%AE%9A%E6%9C%9F%E6%9B%B4%E6%96%B0/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E5%AE%9E%E7%94%A8shell%E8%84%9A%E6%9C%AC%E6%95%B4%E7%90%86%E4%B8%8D%E5%AE%9A%E6%9C%9F%E6%9B%B4%E6%96%B0/</guid><pubDate>Mon, 31 Aug 2015 23:13:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;h2 id="转换时间和unix时间戳">转换时间和unix时间戳&lt;/h2>
&lt;pre tabindex="0">&lt;code># 时间转时间戳
date -d &amp;#34;2015-07-24 12:25:00&amp;#34; +%s
# 时间戳转时间
date -d &amp;#34;@1437711900&amp;#34;
&lt;/code>&lt;/pre>&lt;h2 id="分析nginx日志">分析nginx日志&lt;/h2>
&lt;pre tabindex="0">&lt;code>#查看访问地址次数排行
awk -F\&amp;#34; &amp;#39;{print $2}&amp;#39; blog_access.log | awk &amp;#39;{print $2}&amp;#39; | sort | uniq -c | sort -rn
&lt;/code>&lt;/pre>&lt;h2 id="输出当前目录下各个子目录所使用的空间">输出当前目录下各个子目录所使用的空间&lt;/h2>
&lt;pre tabindex="0">&lt;code>du -h --max-depth=1
&lt;/code>&lt;/pre>&lt;h2 id="查找文件内容">查找文件内容&lt;/h2>
&lt;pre tabindex="0">&lt;code>grep &amp;#34;search&amp;#34; filename
# 从文件内容查找与正则表达式匹配的行：
grep –e “/pattern/” filename
# 查找时不区分大小写：
grep –i &amp;#34;search&amp;#34; filename
# 查找匹配的行数：
grep -c &amp;#34;search&amp;#34; filename
# 从文件内容查找不匹配指定字符串的行：
grep –v &amp;#34;search&amp;#34; filename
# 结合find
find . -name &amp;#34;*.php&amp;#34; | xargs grep &amp;#34;function&amp;#34;
&lt;/code>&lt;/pre>&lt;h2 id="查看dd命令的进度">查看dd命令的进度&lt;/h2>
&lt;p>&lt;code>dd if=/dev/zero of=/tmp/zero.img bs=10M count=100000&lt;/code>
想要查看上面的dd命令的执行进度，可以使用下面几种方法：&lt;/p>
&lt;p>比如：每5秒输出dd的进度&lt;/p>
&lt;pre tabindex="0">&lt;code>方法一：
watch -n 5 pkill -USR1 ^dd$
方法二：
watch -n 5 killall -USR1 dd
方法三：
while killall -USR1 dd; do sleep 5; done
方法四：
while (ps auxww |grep &amp;#34; dd &amp;#34; |grep -v grep |awk &amp;#39;{print $2}&amp;#39; |while read pid; do kill -USR1 $pid; done) ; do sleep 5; done
上述四种方法中使用三个命令：pkill、killall、kill向dd命令发送SIGUSR1信息，dd命令进程接收到信号之后就打印出自己当前的进度。
&lt;/code>&lt;/pre>&lt;h2 id="判断远程主机端口是否开启">判断远程主机端口是否开启&lt;/h2>
&lt;ul>
&lt;li>TCP端口：
&lt;code>nc -w 1 127.0.0.1 9527 &amp;amp;&amp;amp; echo true || echo false&lt;/code>&lt;/li>
&lt;li>UDP端口：
&lt;code>nc -w 1 -u 127.0.0.1 9527 &amp;amp;&amp;amp; echo true || echo false&lt;/code>&lt;/li>
&lt;/ul>
&lt;h2 id="ubuntu删除过期内核方法">ubuntu删除过期内核方法&lt;/h2>
&lt;p>ubuntu 的一个让处女座人不舒服的地方就是 每次升级后原来的文件还保留在系统中，不会自动清理，所以对于有洁癖的人来说需要自己清理。
先来看看你的系统中已经存在的内核版本：
&lt;code>dpkg --get-selections | grep linux&lt;/code>
先别乱删，先看看系统正在运行的是什么版本，当然这个不可以删除的。&lt;code>uname -r&lt;/code> ，可以看到 &lt;code>3.2.0-60-generic-pae&lt;/code>，这个就是我的系统目前使用的内核版本。其他的就尽情的删除吧&lt;/p>
&lt;h2 id="git-删除远程分支">git 删除远程分支&lt;/h2>
&lt;p>&lt;code>git push origin :branch-name&lt;/code>
冒号前面的空格不能少，原理是把一个空分支push到server上，相当于删除该分支。&lt;/p>
&lt;h2 id="更改git默认nano编辑器为vim">更改git默认nano编辑器为vim&lt;/h2>
&lt;p>当然这可以是任意喜欢的编辑器
&lt;code>git config --global core.editor vim&lt;/code>&lt;/p>
&lt;h2 id="ubuntu-1404系统设置图标丢失解决方法">ubuntu 14.04系统设置图标丢失解决方法&lt;/h2>
&lt;p>&lt;code>sudo apt-get install ubuntu-desktop&lt;/code>
or
&lt;code>sudo apt-get install unity-control-center-signon gnome-control-center-unity&lt;/code>
Original Page: &lt;a href="http://askubuntu.com/questions/466720/system-settings-icons-missing-in-14-04">http://askubuntu.com/questions/466720/system-settings-icons-missing-in-14-04&lt;/a>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/shell/">SHELL</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>修改某寨厂U转串(cp2102模块)SN过程记录</title><link>https://blog.ferstar.org/post/%E4%BF%AE%E6%94%B9%E6%9F%90%E5%AF%A8%E5%8E%82u%E8%BD%AC%E4%B8%B2-cp2102%E6%A8%A1%E5%9D%97-sn%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E4%BF%AE%E6%94%B9%E6%9F%90%E5%AF%A8%E5%8E%82u%E8%BD%AC%E4%B8%B2-cp2102%E6%A8%A1%E5%9D%97-sn%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/</guid><pubDate>Mon, 31 Aug 2015 23:10:59 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;h2 id="背景">背景&lt;/h2>
&lt;p>项目需求，要在机器上挂几个传感器，所以买了几个U转串的模块做连接，买到傻眼了，寨厂的模块所有硬件信息甚至包括SN居然都是一模一样，这就出现一个问题，一台设备上只能插一个模块，多了没法识别，因为硬件信息全部一样，看&lt;a href="http://blog.163.com/lby147612@126/blog/static/170410452201382510318725">这位仁兄教程&lt;/a>说这个模块可以改ID，顿时大爽，于是兴冲冲的去找工具，找驱动，下载安装，以为真的so easy，还是想的太天真，下下来的所有工具只能看不能改，要么就是改了报错，于是继续google，原因大概是Silicon Labs公司刚开始的时候硬件还有驱动没有做限制，导致后来寨货横行，然后痛定思痛新驱动程序中屏蔽了修改设备ID的接口云云，好吧，也就是说新驱动不能用喽，开始找旧驱动，从15年找到04年，终于被我找到了！然后发现，那时候的驱动是不带数字签名的，也就是说04年的驱动无法在winxp以后的系统上面用，win7倒是勉强可以，不过需要开开发者模式什么的，醉了，只得默默的掏出吃灰N久的上网本，继续折腾，终于成功修改：&lt;/p>
&lt;h2 id="过程">过程&lt;/h2>
&lt;p>其实跟上面那位仁兄的教程一样，只是他帖子里只提了做法，并没有提供相关驱动链接，我这里附上千辛万苦找到的驱动还有修改工具：
&lt;a href="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/2015/08/454542992.zip">这个是驱动：CP210X驱动程序-xp专用.zip&lt;/a>
&lt;a href="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/2015/08/343120409.zip">这个是工具：CP210x_5x_AppNote_Archive.zip&lt;/a>&lt;/p>
&lt;p>打开&lt;code>CP210xSetIDs.exe&lt;/code>，如图：&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/2015/08/3855334421.jpg_xyz" alt="修改serialnumber.JPG">&lt;/p>
&lt;p>一般修改里面的&lt;code>serialnumber&lt;/code>即可满足需求, 改完后点击&lt;code>program devices&lt;/code>即可,改完后硬件信息如下, 可以发现&lt;code>sn&lt;/code>已经成功修改&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/2015/08/4259131112.png_xyz" alt="2015-08-08 17_36_03屏幕截图.png">&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>挂代理&amp;apt-fast多线程更新packages</title><link>https://blog.ferstar.org/post/%E6%8C%82%E4%BB%A3%E7%90%86-apt-fast%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%9B%B4%E6%96%B0packages/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E6%8C%82%E4%BB%A3%E7%90%86-apt-fast%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%9B%B4%E6%96%B0packages/</guid><pubDate>Mon, 31 Aug 2015 23:06:06 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>因为更新并不是频繁操作，所以只需要临时(&lt;strong>只在当前终端生效&lt;/strong>)在终端指定下proxy&lt;/p>
&lt;pre tabindex="0">&lt;code>sudo -i
# 这里当然需要你提前在内网90的机器上配好http fuck gfw代理喽
export http_proxy=http://192.168.1.90:8118/
&lt;/code>&lt;/pre>&lt;p>这样就在当前终端临时给root用户指定了内网代理&lt;/p>
&lt;p>&lt;code>apt-get&lt;/code>工具默认是单线程的，还是太慢，可以用另外的一个工具代替&lt;code>apt-fast&lt;/code>&lt;/p>
&lt;pre tabindex="0">&lt;code>apt-get install axel
axel -o /usr/bin/apt-fast http://www.mattparnell.com/linux/apt-fast/apt-fast.sh
chmod +x /usr/bin/apt-fast
&lt;/code>&lt;/pre>&lt;p>使用很简单，直接apt-fast替换apt-get即可&lt;/p>
&lt;p>经过上述折腾，在比较生僻的国外源拖packages的速度会大有改善&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>源//ROS on RaspBerry Pi2</title><link>https://blog.ferstar.org/post/%E6%BA%90-ros-on-raspberry-pi2/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E6%BA%90-ros-on-raspberry-pi2/</guid><pubDate>Mon, 31 Aug 2015 22:51:20 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>首先按照下面的连接在树莓派上安装ubuntu
&lt;a href="https://wiki.ubuntu.com/ARM/RaspberryPi">1. Raspberry Pi 2 (with Ubuntu 14.04.2 2015-04-06)&lt;/a>
&lt;a href="http://wiki.ros.org/indigo/Installation/UbuntuARM">2. Ubuntu ARM install of ROS Indigo&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>需要注意的是链接里提供的镜像是基本的系统，展开只有2G不到，而拿来做开发的话，tf卡至少都在8G以上，剩下没有使用的空间可以在PC系统安装gparted，把写好的卡第二分区resize一下就可以了。&lt;/p>
&lt;/blockquote>
&lt;p>因为是port源，所以mirror站点几乎没有，找到个比主站稍快点的一个&lt;/p>
&lt;p>注意：&lt;code>libraspberrypi-dev&lt;/code>这个包不要安装，装了会影响到后续ros环境的编译，万一手欠装了，出错的时候&lt;code>apt-get&lt;/code>是没法卸载的，那时候用&lt;code>dpkg --remove libraspberrypi-dev&lt;/code>卸载，当然root权限是必须的&lt;/p>
&lt;pre tabindex="0">&lt;code>#备份是个好习惯
sudo -i
cp /etc/apt/sources.list /etc/apt/sources.list.bak
vi /etc/apt/sources.list
&lt;/code>&lt;/pre>&lt;p>如下内容：&lt;/p>
&lt;pre tabindex="0">&lt;code># See http://help.ubuntu.com/community/UpgradeNotes for how to upgrade to
# newer versions of the distribution.
deb http://ftp.tu-chemnitz.de/pub/linux/ubuntu-ports/ trusty main restricted
deb-src http://ftp.tu-chemnitz.de/pub/linux/ubuntu-ports/ trusty main restricted
## Major bug fix updates produced after the final release of the
## distribution.
deb http://ftp.tu-chemnitz.de/pub/linux/ubuntu-ports/ trusty-updates main restricted
deb-src http://ftp.tu-chemnitz.de/pub/linux/ubuntu-ports/ trusty-updates main restricted
## Uncomment the following two lines to add software from the &amp;#39;universe&amp;#39;
## repository.
## N.B. software from this repository is ENTIRELY UNSUPPORTED by the Ubuntu
## team. Also, please note that software in universe WILL NOT receive any
## review or updates from the Ubuntu security team.
deb http://ftp.tu-chemnitz.de/pub/linux/ubuntu-ports/ trusty universe multiverse
deb-src http://ftp.tu-chemnitz.de/pub/linux/ubuntu-ports/ trusty universe multiverse
deb http://ftp.tu-chemnitz.de/pub/linux/ubuntu-ports/ trusty-updates universe multiverse
deb-src http://ftp.tu-chemnitz.de/pub/linux/ubuntu-ports/ trusty-updates universe multiverse
## N.B. software from this repository may not have been tested as
## extensively as that contained in the main release, although it includes
## newer versions of some applications which may provide useful features.
## Also, please note that software in backports WILL NOT receive any review
## or updates from the Ubuntu security team.
deb http://ftp.tu-chemnitz.de/pub/linux/ubuntu-ports/ trusty-backports main restricted
deb-src http://ftp.tu-chemnitz.de/pub/linux/ubuntu-ports/ trusty-backports main restricted
deb http://ftp.tu-chemnitz.de/pub/linux/ubuntu-ports/ trusty-security main restricted
deb-src http://ftp.tu-chemnitz.de/pub/linux/ubuntu-ports/ trusty-security main restricted
deb http://ftp.tu-chemnitz.de/pub/linux/ubuntu-ports/ trusty-security universe
deb-src http://ftp.tu-chemnitz.de/pub/linux/ubuntu-ports/ trusty-security universe
deb http://ftp.tu-chemnitz.de/pub/linux/ubuntu-ports/ trusty-security multiverse
deb-src http://ftp.tu-chemnitz.de/pub/linux/ubuntu-ports/ trusty-security multiverse
&lt;/code>&lt;/pre>&lt;h1 id="附加">附加：&lt;/h1>
&lt;p>新发现湾湾的两个源里有port源可以用，速度不错
&lt;a href="http://free.nchc.org.tw/ubuntu-ports/">http://free.nchc.org.tw/ubuntu-ports/&lt;/a>
&lt;a href="http://ftp.ubuntu-tw.org/mirror/ubuntu-ports/dists/">http://ftp.ubuntu-tw.org/mirror/ubuntu-ports/dists/&lt;/a>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>Static IP Setup On Arch Linux ARM</title><link>https://blog.ferstar.org/post/static-ip-setup-on-arch-linux-arm/</link><guid isPermaLink="true">https://blog.ferstar.org/post/static-ip-setup-on-arch-linux-arm/</guid><pubDate>Thu, 20 Aug 2015 15:52:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>&lt;a href="http://archlinuxarm.org/forum/viewtopic.php?f=58&amp;amp;t=8045">http://archlinuxarm.org/forum/viewtopic.php?f=58&amp;amp;t=8045&lt;/a>&lt;/p>
&lt;p>Try this, in a chroot (assumes you are root. you can always add sudo to the beginning of each command if you prefer sudo). Note in the below it is eth0.network not eth0-network as stated in your post. Systemd-networkd uses *.network files.&lt;/p>
&lt;p>nano /etc/systemd/network/eth0.network
`&lt;/pre>&lt;/p>
&lt;pre>&lt;code>Then paste this in:
&amp;lt;pre&amp;gt;`[Match]
Name=eth0
[Network]
Address=192.168.1.8/24
Gateway=192.168.1.1
DNS=8.8.8.8
DNS=8.8.4.4
`&amp;lt;/pre&amp;gt;
You will then need to disable netcl. To find out what is enabled that is netctl related, run this:
&amp;lt;pre&amp;gt;`systemctl list-unit-files
`&amp;lt;/pre&amp;gt;
Once you identify all netctl related stuff. Go through and disable all netctl related stuff. You may have more to disable than just the below:
&amp;lt;pre&amp;gt;`systemctl disable netctl@eth0.service
`&amp;lt;/pre&amp;gt;
You will then need systemd-networkd enabled:
&amp;lt;pre&amp;gt;`systemctl enable systemd-networkd
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>查询局域网在线ip及对应mac地址的方法</title><link>https://blog.ferstar.org/post/%E6%9F%A5%E8%AF%A2%E5%B1%80%E5%9F%9F%E7%BD%91%E5%9C%A8%E7%BA%BFip%E5%8F%8A%E5%AF%B9%E5%BA%94mac%E5%9C%B0%E5%9D%80%E7%9A%84%E6%96%B9%E6%B3%95/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E6%9F%A5%E8%AF%A2%E5%B1%80%E5%9F%9F%E7%BD%91%E5%9C%A8%E7%BA%BFip%E5%8F%8A%E5%AF%B9%E5%BA%94mac%E5%9C%B0%E5%9D%80%E7%9A%84%E6%96%B9%E6%B3%95/</guid><pubDate>Wed, 19 Aug 2015 21:25:43 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;h2 id="windows">windows&lt;/h2>
&lt;p>这个软件很不错 &lt;a href="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/2015/08/1360260925.rar">maxcanner.rar&lt;/a>，小巧快速，即开即用，有5档扫描方式，一般选择5或者4，可以得到主机名，如果有的话&lt;/p>
&lt;h2 id="ubuntu">ubuntu&lt;/h2>
&lt;p>arp-scan&lt;/p>
&lt;pre tabindex="0">&lt;code># apt-get install arp-scan
# arp-scan --interface=eth0 192.168.1.0/24
&lt;/code>&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>树莓派2B+7寸触摸屏折腾记录</title><link>https://blog.ferstar.org/post/%E6%A0%91%E8%8E%93%E6%B4%BE2b-7%E5%AF%B8%E8%A7%A6%E6%91%B8%E5%B1%8F%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E6%A0%91%E8%8E%93%E6%B4%BE2b-7%E5%AF%B8%E8%A7%A6%E6%91%B8%E5%B1%8F%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/</guid><pubDate>Sat, 15 Aug 2015 22:45:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;h1 id="硬件">硬件&lt;/h1>
&lt;ol>
&lt;li>
&lt;p>raspberry pi2B+8G tf卡，系统lubuntu14.04.3&lt;/p>
&lt;/li>
&lt;li>
&lt;p>某宝7寸800x480电容式触摸屏，厂商信息如下：&lt;/p>
&lt;p>&lt;code>0eef:0005 D-WAV Scientific Co., Ltd&lt;/code>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h1 id="过程">过程&lt;/h1>
&lt;h2 id="1-触屏驱动显示分辨率适配">1. 触屏驱动+显示分辨率适配&lt;/h2>
&lt;p>商家提供了预编译的内核，内容如下：&lt;/p>
&lt;pre>&lt;code>├── config.txt
├── kernel7.img
├── kernel.img
├── modules
│   └── 3.18.6-v7+
├── USB_TOUCH_CAP_7.0_RASPBIAN
└── xinput-calibrator_0.7.5-1_armhf.deb
其中`USB_TOUCH_CAP_7.0_RASPBIAN`是自动安装脚本，但其实路径指定完全是错的，我修改如下：
&lt;/code>&lt;/pre>
&lt;pre tabindex="0">&lt;code> #!/bin/sh -e
#
# modified by ferstar
#
# This script is executed at the end of each multiuser runlevel.
# Make sure that the script will &amp;amp;quot;exit 0&amp;amp;quot; on success or any other
# value on error.
#
sudo mv /boot/firmware/kernel7.img /boot/firmware/kernel7.img.`uname -r`
sudo cp kernel7.img /boot/firmware/kernel7.img
sudo mv /boot/firmware/initrd7.img /boot/firmware/initrd7.img.`uname -r`
sudo cp kernel.img /boot/firmware/initrd7.img
sudo cp /boot/firmware/config.txt /boot/firmware/config.txt.`uname -r`
# 这个是树莓派启动配置文件，里面一个参数比较重要max_usb_current=1，解除USB最大供电电流限制
sudo cp config.txt /boot/firmware/config.txt
sudo mv /lib/modules/`uname -r` /lib/modules/`uname -r`.bak
sudo cp -r ./modules /lib/
# 下面的这一步其实没必要，触屏校准xinput-calibrator软件在软件源里有提供，貌似还比这个版本新，不过用法都是一样的
sudo dpkg -i xinput-calibrator_0.7.5-1_armhf.deb
reboot
&lt;/code>&lt;/pre>&lt;pre>&lt;code>重启后内核版本为`3.18.6-v7+`，以后不能从源里更新官方内核，会花屏，商家并没有提供触屏驱动源码
&lt;/code>&lt;/pre>
&lt;h2 id="2-触屏校准">2. 触屏校准&lt;/h2>
&lt;pre>&lt;code>在设备开终端，运行`xinput-calibrator`，按提示戳四下，然后把类似如下输出字段
&lt;/code>&lt;/pre>
&lt;pre tabindex="0">&lt;code> Section InputClass
Identifier calibration
MatchProduct RPI_TOUCH By ZH851
Option Calibration 3 790 9 490
Option SwapAxes
EndSection
&lt;/code>&lt;/pre>&lt;pre>&lt;code>写入到`/usr/share/X11/xorg.conf.d/99-calibration.conf`中，没有就新建之
&lt;/code>&lt;/pre>
&lt;h2 id="3-触屏模拟右键">3. 触屏模拟右键&lt;/h2>
&lt;pre>&lt;code>编辑`/usr/share/X11/xorg.conf.d/99-calibration.conf`，加入三行：
&lt;/code>&lt;/pre>
&lt;pre tabindex="0">&lt;code> Option EmulateThirdButton 1
Option EmulateThirdButtonTimeout 750
Option EmulateThirdButtonThreshold 30
&lt;/code>&lt;/pre>&lt;pre>&lt;code>最终结果像这样：
&lt;/code>&lt;/pre>
&lt;pre tabindex="0">&lt;code> Section &amp;amp;quot;InputClass&amp;amp;quot;
Identifier calibration
MatchProduct RPI_TOUCH By ZH851
Option Calibration 3 790 9 490
Option SwapAxes 0
Option EmulateThirdButton 1
Option EmulateThirdButtonTimeout 750
Option EmulateThirdButtonThreshold 30
EndSection
&lt;/code>&lt;/pre>&lt;pre>&lt;code>保存重启后，长按屏幕==鼠标右键效果，模拟右键完成
&lt;/code>&lt;/pre>
&lt;h2 id="4-禁用系统bug报告弹窗">4. 禁用系统bug报告弹窗&lt;/h2>
&lt;pre>&lt;code>bug报告本来是好事，但无奈弹的太多了些，多数情况除了影响心情外，并没有什么卵用，所以需要禁用之：
`sudo vi /etc/default/apport`
&lt;/code>&lt;/pre>
&lt;pre tabindex="0">&lt;code> # set this to 0 to disable apport, or to 1 to enable it
# you can temporarily override this with
# sudo service apport start force_start=1
enabled=0
&lt;/code>&lt;/pre>&lt;h2 id="5-虚拟键盘matchbox-keyboard">5. 虚拟键盘&lt;code>matchbox-keyboard&lt;/code>&lt;/h2>
&lt;pre>&lt;code>起先照这里的说明[http://ozzmaker.com/2014/06/30/virtual-keyboard-for-the-raspberry-pi/](http://ozzmaker.com/2014/06/30/virtual-keyboard-for-the-raspberry-pi/)编译了下，发现键盘布局蛮丑的，后来手欠apt-get，发现原来有编译好的=。=，而且还长的略好看。
虚拟键盘装上后需要考虑按需弹出的问题，作者帖子里写的适用于自行编译的版本，deb包安装的不适用，需要略做修改：
`sudo vi /usr/bin/toggle-matchbox-keyboard.sh`
&lt;/code>&lt;/pre>
&lt;pre tabindex="0">&lt;code> #!/bin/bash
#This script toggle the virtual keyboard
PID=`pidof matchbox-keyboard`
if [ ! -e $PID ]; then
killall matchbox-keyboard
else
matchbox-keyboard extended &amp;amp;amp;
fi
&lt;/code>&lt;/pre>&lt;pre>&lt;code>`sudo chmod +x /usr/bin/toggle-matchbox-keyboard.sh`
`sudo vi /usr/share/applications/inputmethods/matchbox-keyboard.desktop`
&lt;/code>&lt;/pre>
&lt;pre tabindex="0">&lt;code> [Desktop Entry]
Name=Keyboard
Comment=Virtual Keyboard
# Exec=matchbox-keyboard 原本是这行，需要指向我们自己的脚本
Exec=toggle-matchbox-keyboard.sh
Type=Application
Icon=matchbox-keyboard.png
Categories=Panel;Utility;MB
X-MB-INPUT-MECHANSIM=True
&lt;/code>&lt;/pre>&lt;pre>&lt;code>`vi .config/lxpanel/Lubuntu/panels/panel`这个路径也跟作者说的不太一致
&lt;/code>&lt;/pre>
&lt;pre tabindex="0">&lt;code> Plugin {
type = launchbar
Config {
Button {
id=/usr/share/applications/inputmethods/matchbox-keyboard.desktop
}
}
}
Plugin {
type = volumealsa
}
# 我把键盘按钮放在音量键前，并把右下角的logout键去掉了，因为不小心触到会弹出很长的一个对话框，屏幕略小，显示不全
&lt;/code>&lt;/pre>&lt;pre>&lt;code>这样，注销后重登陆就会看到右下角键盘图标了，按下弹出，再按关闭，很方便～
&lt;/code>&lt;/pre>
&lt;h2 id="6-配置自动登陆">6. 配置自动登陆&lt;/h2>
&lt;pre>&lt;code>默认每次登陆都是要输入密码，但又没法弹出虚拟键盘，所以自动登陆很需要
`sudo vi /etc/lightdm/lightdm.conf`没有就新建，内容
&lt;/code>&lt;/pre>
&lt;p>[SeatDefaults]
# 这里填写用于自动登录的用户名
autologin-user=ubuntu
autologin-user-timeout=0
# Check &lt;a href="https://bugs.launchpad.net/lightdm/+bug/854261">https://bugs.launchpad.net/lightdm/+bug/854261&lt;/a> before setting a timeout
user-session=Lubuntu
greeter-session=lightdm-gtk-greeter&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>搭载罗技C270，树莓派变身IP摄像头(mjpg-streamer)</title><link>https://blog.ferstar.org/post/%E6%90%AD%E8%BD%BD%E7%BD%97%E6%8A%80c270%E6%A0%91%E8%8E%93%E6%B4%BE%E5%8F%98%E8%BA%ABip%E6%91%84%E5%83%8F%E5%A4%B4-mjpg-streamer/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E6%90%AD%E8%BD%BD%E7%BD%97%E6%8A%80c270%E6%A0%91%E8%8E%93%E6%B4%BE%E5%8F%98%E8%BA%ABip%E6%91%84%E5%83%8F%E5%A4%B4-mjpg-streamer/</guid><pubDate>Sat, 15 Aug 2015 22:00:21 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>最开始pi一代是搭配自带摄像头模块，采用这里的方案&lt;/p>
&lt;p>&lt;a href="https://github.com/mpromonet/h264_v4l2_rtspserver">h264_v4l2_rtspserver&lt;/a>&lt;/p>
&lt;p>最近pi二代推出，性能比一代强大了不少，可以装ubuntu跑ROS，顺路把玩了下罗技的C270摄像头&lt;/p>
&lt;p>开始用&lt;code>mjpg-streamer&lt;/code> &lt;code>MJPEG&lt;/code>格式黑屏无显示，加了参数&lt;code>-y&lt;/code>，也就是&lt;code>YUV&lt;/code>格式，正常，但CPU占用超高，达90%，负载长期1.2不下，google大法一番后，代码杂交结果如下，&lt;a href="https://github.com/ferstar/mjpg-streamer-diy/blob/master/README.md">成功启用MJPEG格式&lt;/a>，延迟尚可，系统负载影响几乎没有，CPU平均1.3～效果拔群&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>8192cu网卡重编译</title><link>https://blog.ferstar.org/post/8192cu%E7%BD%91%E5%8D%A1%E9%87%8D%E7%BC%96%E8%AF%91/</link><guid isPermaLink="true">https://blog.ferstar.org/post/8192cu%E7%BD%91%E5%8D%A1%E9%87%8D%E7%BC%96%E8%AF%91/</guid><pubDate>Wed, 12 Aug 2015 23:17:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;h1 id="详情步骤见">详情步骤见&lt;/h1>
&lt;p>&lt;a href="https://github.com/ferstar/rtl8192cu-fixes/blob/raspberry/README.md">8192CU driver for USB WiFi devices&lt;/a>&lt;/p>
&lt;h1 id="干掉ipv6">干掉ipv6：&lt;/h1>
&lt;pre>&lt;code>sudo vi /etc/sysctl.conf
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 1
&lt;/code>&lt;/pre>
&lt;h1 id="wicd和networkmanager之间的切换">wicd和networkmanager之间的切换&lt;/h1>
&lt;p>&lt;a href="http://petrkout.com/linux/kubuntu-replace-network-manager-with-wicd/">http://petrkout.com/linux/kubuntu-replace-network-manager-with-wicd/&lt;/a>&lt;/p>
&lt;h1 id="addition">addition&lt;/h1>
&lt;p>内核更换成触摸屏商家定制，没有对应的kernel-header，所以～这是不成的了。。。&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>备份内存卡分区到img</title><link>https://blog.ferstar.org/post/%E5%A4%87%E4%BB%BD%E5%86%85%E5%AD%98%E5%8D%A1%E5%88%86%E5%8C%BA%E5%88%B0img/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E5%A4%87%E4%BB%BD%E5%86%85%E5%AD%98%E5%8D%A1%E5%88%86%E5%8C%BA%E5%88%B0img/</guid><pubDate>Wed, 12 Aug 2015 19:15:43 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;pre>&lt;code># 将sdb分区拷贝到硬盘
sudo dd if=/dev/sdb of=ros_ready.img bs=4M
# bmaptool工具建立索引，提高下次写入内存卡速度，缩短写入时间
bmaptool create ros_ready.img &amp;amp;gt; ros_ready.bmap
# 压缩img，减小文件体积
tar cvzf ros_ready.tar.gz ros_ready.img ros_ready.bmap
`&amp;lt;/pre&amp;gt;
写入到内存卡
&amp;lt;pre&amp;gt;`sudo bmaptool copy --bmap ros_ready.bmap ros_ready.img /dev/sdb
&lt;/code>&lt;/pre>
&lt;p>展开内存卡剩余未用空间&lt;/p>
&lt;p>&lt;code>直接用gparted即可&lt;/code>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>Killed (program cc1plus)</title><link>https://blog.ferstar.org/post/solved-g-internal-compiler-error-killed-program-cc1plus/</link><guid isPermaLink="true">https://blog.ferstar.org/post/solved-g-internal-compiler-error-killed-program-cc1plus/</guid><pubDate>Wed, 12 Aug 2015 14:41:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>兴高采烈编译&lt;code>kobuki_bumper2pc_nodelet&lt;/code>中，突然蹦出这么个错，同时终端变的略卡，下意识的敲了下&lt;code>free -h&lt;/code>，囧，原来是内存用尽了～&lt;/p>
&lt;p>上swap拯救之&lt;/p>
&lt;pre>&lt;code># 在~目录建一个1G的swap文件，差不多应该够了
dd if=/dev/zero of=~/swap.img bs=1M count=1000
mkswap swap.img
sudo swapon swap.img
&lt;/code>&lt;/pre>
&lt;p>再敲&lt;code>free -h&lt;/code>确认下是否开启，结果如图&lt;/p>
&lt;p>&lt;img src="https://blog-1253877569.cos.ap-chengdu.myqcloud.com/ext/2015/08/1834023921.png_xyz" alt="2015-08-12 14:39:22屏幕截图.png">&lt;/p>
&lt;p>已经用超一半swap，还好编译通过，好险～&lt;/p>
&lt;p>阿西吧，编译&lt;code>pano_py&lt;/code>时内存又爆掉，还得再加点swap&lt;/p>
&lt;p>还是上面的方法，只需要新建一个&lt;code>swap1.img&lt;/code>的swap file就可以&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>Package ros-indigo-gazebo-ros has no installation candidate</title><link>https://blog.ferstar.org/post/e-package-ros-indigo-gazebo-ros-has-no-installation-candidate/</link><guid isPermaLink="true">https://blog.ferstar.org/post/e-package-ros-indigo-gazebo-ros-has-no-installation-candidate/</guid><pubDate>Wed, 12 Aug 2015 10:58:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>x，又找不见这个包。。。&lt;/p>
&lt;p>奶奶的，装之&lt;/p>
&lt;p>&lt;code>sudo -H apt-get install -y ros-indigo-gazebo-ros&lt;/code>&lt;/p>
&lt;p>然后提示没有这个包，好吧，通配符匹配之&lt;/p>
&lt;p>&lt;code>sudo -H apt-get install -y ros-indigo-gazebo-*&lt;/code>&lt;/p>
&lt;p>似乎也没搞定，挂起，等待后续解决&lt;/p>
&lt;h2 id="暂时跳过方法">暂时跳过，方法：&lt;/h2>
&lt;p>&lt;code>~/kobuki/src/kobuki_desktop$ mv kobuki_gazebo_plugins .kobuki_gazebo_plugins&lt;/code>&lt;/p>
&lt;p>即移开&lt;code>kobuki_gazebo_plugins&lt;/code>这个包&lt;/p>
&lt;h2 id="两种补全依赖包的做法">两种补全依赖包的做法&lt;/h2>
&lt;ol>
&lt;li>&lt;code>rosdep install --from-paths src -i -y&lt;/code>&lt;/li>
&lt;li>&lt;code>sudo -H apt-get install -y ros-indigo-***&lt;/code> 提示缺啥补上即可&lt;/li>
&lt;/ol>
&lt;h2 id="与之相关连的一个包kobuki_qtestsuite也需要跳过跳过后发现官方有deb包提供所以尝试安装">与之相关连的一个包&lt;code>kobuki_qtestsuite&lt;/code>也需要跳过，跳过后发现官方有deb包提供，所以尝试安装&lt;/h2>
&lt;p>&lt;code>sudo apt-get install ros-indigo-kobuki-qtestsuite&lt;/code>&lt;/p>
&lt;p>于是又安装了一坨deb。。。不过还好这个包算是装上了&lt;/p>
&lt;h2 id="编译到turtlebot的时候上面提到的跳过大法似乎失灵所以只能暴力删除">编译到&lt;code>turtlebot&lt;/code>的时候，上面提到的跳过大法似乎失灵，所以只能暴力删除&lt;/h2>
&lt;p>&lt;code>~/turtlebot/src/turtlebot_create_desktop$ rm -r create_gazebo_plugins&lt;/code>&lt;/p>
&lt;h2 id="总结">总结&lt;/h2>
&lt;p>顺利编译完成，只有&lt;code>kobuki_gazebo_plugins&lt;/code>和&lt;code>create_gazebo_plugins&lt;/code>两个包没有编译，其余全部搞定！&lt;/p>
&lt;h2 id="附加">附加&lt;/h2>
&lt;p>修改catkin_ws/devel中&lt;/p>
&lt;pre tabindex="0">&lt;code># environment at generation time
CMAKE_PREFIX_PATH = &amp;#39;/home/ubuntu/catkin_ws/devel;/home/ubuntu/turtlebot/devel;/home/ubuntu/kobuki/devel;/home/ubuntu/rocon/devel;/opt/ros/indigo&amp;#39;.split(&amp;#39;;&amp;#39;)
&lt;/code>&lt;/pre>&lt;p>环境变量
&lt;code>～/.bashrc&lt;/code>中只需要添加&lt;/p>
&lt;p>&lt;code>source ~/catkin_ws/devel/setup.bash&lt;/code>&lt;/p>
&lt;p>即可&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/ros/">ROS</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>[SOLVED]Could not find a package configuration file provided by "***" with any of the following names</title><link>https://blog.ferstar.org/post/solved-could-not-find-a-package-configuration-file-provided-by-quot-quot-with-any-of-the-following-names/</link><guid isPermaLink="true">https://blog.ferstar.org/post/solved-could-not-find-a-package-configuration-file-provided-by-quot-quot-with-any-of-the-following-names/</guid><pubDate>Wed, 12 Aug 2015 09:17:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>&lt;a href="http://wiki.ros.org/turtlebot/Tutorials/indigo/Turtlebot%20Installation">进行到Workspaces&lt;/a>&lt;/p>
&lt;p>源码编译果然坑&lt;/p>
&lt;p>&lt;code>rocon catkin_make&lt;/code>时报错如题，解决方法如下：&lt;/p>
&lt;p>&lt;code>sudo apt-get install ros-indigo-***&lt;/code>&lt;/p>
&lt;p>其中***可以替换为任意报错的包名字即可&lt;/p>
&lt;p>有些包可能提示的是下划线，比如&lt;code>yocs_msgs&lt;/code>，对应的deb包名字应该是&lt;code>ros-indigo-yocs-msgs&lt;/code>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>“CMAKE_CXX_</title><link>https://blog.ferstar.org/post/solved-cmake-error-your-cxx-compiler-cmake-cxx-compiler-notfound-was-not-found-please-set-cmake-cxx-compiler-to-a-valid-compiler-path-or-name-solved-cmake-error-your-cxx-compiler-cmake-cxx/</link><guid isPermaLink="true">https://blog.ferstar.org/post/solved-cmake-error-your-cxx-compiler-cmake-cxx-compiler-notfound-was-not-found-please-set-cmake-cxx-compiler-to-a-valid-compiler-path-or-name-solved-cmake-error-your-cxx-compiler-cmake-cxx/</guid><pubDate>Wed, 12 Aug 2015 08:56:25 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>c++没有指定，so，装之&lt;/p>
&lt;p>&lt;code>sudo apt-get install build-essential -y&lt;/code>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>利用手头设备搞定ss翻墙~</title><link>https://blog.ferstar.org/post/openwrt-shadowsocks-chinadns/</link><guid isPermaLink="true">https://blog.ferstar.org/post/openwrt-shadowsocks-chinadns/</guid><pubDate>Mon, 22 Dec 2014 21:59:04 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>设备1:Buffalo WZR-HP-G300NH2 现运行固件:&lt;a title="关于">DD-WRT v24-sp2 (03/29/14) giga&lt;/a>&lt;/p>
&lt;p>设备2:Linksys EA6500 现运行固件:OpenWrt Attitude Adjustment 12.09-beta&lt;/p>
&lt;p>起先用设备2刷dd-wrt折腾ss两天无果，后来发现固件iptables和dnsmasq缺失转发参数支持，ss能够运行但无法穿墙，遂放弃，转投设备1，挑现成openwrt方案，问题主要集中在给这货刷openwrt上面，刷好openwrt后，按部就班非常顺利，几个关键字google，goagent，shadowsocks，chinadns……&lt;/p>
&lt;p>贴几个折腾过程中的链接，不分先后（大部分是google+wiki获得）：&lt;/p>
&lt;p>&lt;a href="http://www.right.com.cn/forum/thread-117225-1-1.html">http://www.right.com.cn/forum/thread-117225-1-1.html&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://github.com/posborne/wzr-hp-g300nh2-openwrt-flasher">https://github.com/posborne/wzr-hp-g300nh2-openwrt-flasher&lt;/a>&lt;/p>
&lt;p>&lt;a href="http://sourceforge.net/projects/openwrt-dist/files/shadowsocks-libev/1.6.1-1e3ecb2/">http://sourceforge.net/projects/openwrt-dist/files/shadowsocks-libev/1.6.1-1e3ecb2/&lt;/a>&lt;/p>
&lt;p>&lt;a href="http://hong.im/2014/03/16/configure-an-openwrt-based-router-to-use-shadowsocks-and-redirect-foreign-traffic/">http://hong.im/2014/03/16/configure-an-openwrt-based-router-to-use-shadowsocks-and-redirect-foreign-traffic/&lt;/a>&lt;/p>
&lt;p>……&lt;/p>
&lt;p>最后总结下，非主流方案比如dd-wrt+ss的组合最好少试，吃力不讨好；&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/openwrt/">OPENWRT</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>syslink EA6500 v1刷dd-wrt需要注意的问题</title><link>https://blog.ferstar.org/post/ea6500-v1-flash-dd-wrt/</link><guid isPermaLink="true">https://blog.ferstar.org/post/ea6500-v1-flash-dd-wrt/</guid><pubDate>Fri, 19 Dec 2014 19:44:09 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>1.恢复出厂设置，或者捅菊花
2.升级官方最新固件
3.恢复出厂设置
4.刷dd。。。完全不需要传说中的303030大法&lt;/p>
&lt;p>固件版本：DD-WRT v24-sp2 (03/29/14) giga - build 23838 //这个版本比较稳定，刷完WIFI自动开启，无需太多设置&lt;/p>
&lt;p> &lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/openwrt/">OPENWRT</category></item><item><title>非国行5C开启自带九宫格的方法(需越狱)</title><link>https://blog.ferstar.org/post/%E9%9D%9E%E5%9B%BD%E8%A1%8C5c%E5%BC%80%E5%90%AF%E8%87%AA%E5%B8%A6%E4%B9%9D%E5%AE%AB%E6%A0%BC%E7%9A%84%E6%96%B9%E6%B3%95%E9%9C%80%E8%B6%8A%E7%8B%B1/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E9%9D%9E%E5%9B%BD%E8%A1%8C5c%E5%BC%80%E5%90%AF%E8%87%AA%E5%B8%A6%E4%B9%9D%E5%AE%AB%E6%A0%BC%E7%9A%84%E6%96%B9%E6%B3%95%E9%9C%80%E8%B6%8A%E7%8B%B1/</guid><pubDate>Sat, 29 Nov 2014 15:37:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>&lt;a href="http://bbs.feng.com/read-htm-tid-8643235.html">非行货版5C，想使用系统自带九宫格输入法的看这&lt;/a>&lt;/p>
&lt;ul>
&lt;li>越狱后，用ifile打开var/mobile/libray/caches&lt;/li>
&lt;li>找到com.apple.MobileGestalt.plist&lt;/li>
&lt;li>点击文件选择用属性编辑表打开， 往下拉，找到cacheExtra，点开&lt;/li>
&lt;li>把有关版本的3个地方，改成“MF368”、“CH”、“CH/A”&lt;/li>
&lt;li>然后注销一下，在设置里打开九宫格就可以了&lt;/li>
&lt;/ul></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>MOTO Atrix2 ATT替换19区cid刷国行&amp;魔趣双系统简单记录</title><link>https://blog.ferstar.org/post/moto-atrix2-att-replace-19cid-dual-sys/</link><guid isPermaLink="true">https://blog.ferstar.org/post/moto-atrix2-att-replace-19cid-dual-sys/</guid><pubDate>Wed, 26 Mar 2014 09:50:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>舍友手机杀手，撺掇其入了淘宝洋垃圾MB865，传说中的atrix2，近日手痒，拿来折腾了一番，留简单记录如下&lt;/p>
&lt;ul>
&lt;li>机器信息&lt;/li>
&lt;/ul>
&lt;p>att版mb865，bl=0A.72，基带版本2012-07-26 ***，系统版本4.0.4，此版本也就是这机子att官方给的所谓4.0.4正式版&lt;/p>
&lt;ul>
&lt;li>折腾开始&lt;/li>
&lt;/ul>
&lt;ol>
&lt;li>完整刷入att最新底包，名字是InlineFlashing_Edison_67.21.125_CFC_P3_APBP.xml&lt;/li>
&lt;li>root，我用的是root精灵&lt;/li>
&lt;li>安装bootmenu，取自魔趣论坛&lt;/li>
&lt;li>重启进入bootmenu，备份本机cid，boot（内核）&lt;em>重要&lt;/em>&lt;/li>
&lt;li>依然在bootmenu界面，替换国行cid，boot（内核）&lt;em>重要&lt;/em>&lt;/li>
&lt;li>找个国行4.0.4的包刷入第一系统，如V大1.88&lt;/li>
&lt;li>第二系统刷入魔趣os&lt;/li>
&lt;li>由于替换掉19区cid后开机会有cid错误的两行白字，可以替换默认黑底moto logo为白底_非必须_&lt;/li>
&lt;li>基本完美，重启第一系统时会卡到bootmenu引导界面，此时同时按住音量+、音量—、电源键6s左右即可正常开机_重要_&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>关于bug&lt;/li>
&lt;/ul>
&lt;ol>
&lt;li>语音台10086拨号后号码盘选键无效&lt;/li>
&lt;li>暂未发现&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>提到的底包，工具，cid等等网上都有，用点心不难找到&lt;/li>
&lt;/ul></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/%E6%89%8B%E6%9C%BA/">手机</category></item><item><title>minidlna Missing From Menuconfig</title><link>https://blog.ferstar.org/post/minidlna-missing-from-menuconfig/</link><guid isPermaLink="true">https://blog.ferstar.org/post/minidlna-missing-from-menuconfig/</guid><pubDate>Mon, 17 Feb 2014 20:48:41 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>To summarize the fix for no minidlna selection:&lt;/p>
&lt;p>written_direcon wrote:&lt;/p>
&lt;pre>&lt;code>./scripts/feeds update packages
./scripts/feeds install -d m minidlna
&lt;/code>&lt;/pre>
&lt;p>Then:&lt;/p>
&lt;p>In &amp;quot;make menuconfig&amp;quot; select: Libraries -&amp;gt; libffmpeg-full&lt;/p>
&lt;p>Then select: Multimedia -&amp;gt; minidlna&lt;/p>
&lt;p>And/or you can select&lt;/p>
&lt;p>minidlna support in the LuCI -&amp;gt; Applications section of &amp;quot;make menuconfig&amp;quot;&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/openwrt/">OPENWRT</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>开启android中telnetd远程登录服务</title><link>https://blog.ferstar.org/post/%E5%BC%80%E5%90%AFandroid%E4%B8%ADtelnetd%E8%BF%9C%E7%A8%8B%E7%99%BB%E5%BD%95%E6%9C%8D%E5%8A%A1/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E5%BC%80%E5%90%AFandroid%E4%B8%ADtelnetd%E8%BF%9C%E7%A8%8B%E7%99%BB%E5%BD%95%E6%9C%8D%E5%8A%A1/</guid><pubDate>Sun, 09 Feb 2014 10:14:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>通过数据线及adb命令登录手机android系统很不方便，若PC机及手机均有wifi功能，可使PC通过wifi远程登录android,会带来很多方便。&lt;/p>
&lt;h3 id="要实现这个功能首先要在手机上开启telnetd-服务方法如下">要实现这个功能，首先要在手机上开启telnetd 服务，方法如下：&lt;/h3>
&lt;ol>
&lt;li>确认手机上装有busybox软件，若没有需自行下载安装。&lt;/li>
&lt;li>运行busybox命令，确认输出中有telnetd，若无需更换其他busybox。&lt;/li>
&lt;li>要取得手机的root权限，手机上要装有terminal 软件。&lt;/li>
&lt;li>在terminal下使用 su 命令转为 root 用户， 键入命令 &lt;code>telnetd -l /system/bin/sh&lt;/code>（要事先检查/system/bin/sh是否存在）&lt;/li>
&lt;li>PC及手机连接同一个wifi 网络，在PC上telnet登录手机的 ip 地址即可。 作为客户端连接其他电脑也很简单： &lt;code>busybox telnet IPAdress Port&lt;/code> 即可&lt;/li>
&lt;/ol>
&lt;h3 id="注意事项">注意事项：&lt;/h3>
&lt;h4 id="telnet登录手机系统后默认的sh-shell可能不好用比如使用backspace键有乱码不能按上下箭头重复历史命令输出没有颜色等此时可自行选用bashcsh等常用的shell来解决可用以下两种方法">telnet登录手机系统后，默认的sh shell可能不好用，比如使用backspace键有乱码，不能按上下箭头重复历史命令，输出没有颜色等，此时可自行选用bash、csh等常用的shell来解决。可用以下两种方法：&lt;/h4>
&lt;ol>
&lt;li>直接在telnet窗口下运行bash或csh命令。&lt;/li>
&lt;li>在启动telnetd时直接指定需要的shell，如&lt;code>telnetd -l /system/xbin/bash&lt;/code>，这样telnet登录后默认shell就是bash 。&lt;/li>
&lt;/ol>
&lt;h3 id="另外为防止登录过程中手机wifi休眠造成网络中断要对手机wifi的休眠功能进行正确设置">另外，为防止登录过程中手机wifi休眠造成网络中断，要对手机wifi的休眠功能进行正确设置。&lt;/h3></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>linux下更改chrome浏览器cache路径</title><link>https://blog.ferstar.org/post/change-chrome-cache-dir/</link><guid isPermaLink="true">https://blog.ferstar.org/post/change-chrome-cache-dir/</guid><pubDate>Sun, 08 Dec 2013 18:27:04 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>gedit /etc/chromium-browser/default&lt;/p>
&lt;pre class="lang:default decode:true " ># Default settings for chromium-browser. This file is sourced by /bin/sh from
# /usr/bin/chromium-browser
# Options to pass to chromium-browser
CHROMIUM_FLAGS="--disk-cache-dir=/tmp/Chromium/"&lt;/pre></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>Package is missing dependencies for libraries</title><link>https://blog.ferstar.org/post/package-is-missing-dependencies-for-libraries/</link><guid isPermaLink="true">https://blog.ferstar.org/post/package-is-missing-dependencies-for-libraries/</guid><pubDate>Sun, 08 Dec 2013 18:22:50 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>&lt;a href="http://stackoverflow.com/questions/19184631/package-is-missing-dependencies-for-libraries-openwrt">&lt;/a>&lt;/p>
&lt;p>Finally got it, had to add change&lt;/p>
&lt;p>&lt;code>$(eval $(call BuildPackage,amld))&lt;/code>&lt;/p>
&lt;p>to&lt;/p>
&lt;p>&lt;code>$(eval $(call BuildPackage,amld,+libopenssl))&lt;/code>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>close has not been declared</title><link>https://blog.ferstar.org/post/elf-cpp685-error-close-has-not-been-declared/</link><guid isPermaLink="true">https://blog.ferstar.org/post/elf-cpp685-error-close-has-not-been-declared/</guid><pubDate>Wed, 06 Nov 2013 11:32:49 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>&lt;a href="http://www.openwrt.org.cn/bbs/forum.php?mod=viewthread&amp;amp;tid=12675">http://www.openwrt.org.cn/bbs/forum.php?mod=viewthread&amp;amp;tid=12675&lt;/a>&lt;/p>
&lt;p>参考trunk的源码和此问题&amp;quot;https://dev.openwrt.org.cn/ticket/45&amp;quot;&lt;/p>
&lt;p>修改 ./build_dir/host/mklibs/src/mklibs-readelf/elf.cpp&lt;/p>
&lt;div>
&lt;div id="code_ftf">
&lt;p>1.2. #include &amp;quot;elf_data.hpp&amp;quot;
3.4. #include &amp;lt;stdexcept&amp;gt;
5.6. #include &amp;lt;fcntl.h&amp;gt;
7. #include &amp;lt;sys/mman.h&amp;gt;
8. #include &amp;lt;sys/stat.h&amp;gt;&lt;/p>
&lt;/div>
复制代码
&lt;/div>
下面添加一行"#include &amp;lt;unistd.h&amp;gt;"成：
&lt;div>
&lt;div id="code_U9o">
&lt;p>1.2. #include &amp;quot;elf_data.hpp&amp;quot;
3.4. #include &amp;lt;stdexcept&amp;gt;
5.6. #include &amp;lt;fcntl.h&amp;gt;
7. #include &amp;lt;sys/mman.h&amp;gt;
8. #include &amp;lt;sys/stat.h&amp;gt;
9. #include &amp;lt;unistd.h&amp;gt;&lt;/p>
&lt;/div>
复制代码
&lt;/div>
解决问题。</description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/openwrt/">OPENWRT</category></item><item><title>*** [tools/m4/compile] Error 2 solved</title><link>https://blog.ferstar.org/post/toolsm4compile-error-2-solved/</link><guid isPermaLink="true">https://blog.ferstar.org/post/toolsm4compile-error-2-solved/</guid><pubDate>Wed, 06 Nov 2013 11:15:34 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>&lt;a href="http://www.openwrt.org.cn/bbs/forum.php?mod=viewthread&amp;amp;tid=13909&amp;amp;page=1#pid102019">http://www.openwrt.org.cn/bbs/forum.php?mod=viewthread&amp;amp;tid=13909&amp;amp;page=1#pid102019&lt;/a>&lt;/p>
&lt;p>解决方法如下：
先进入：`/home/jopark/Documents/openwrt-dreambox/build_dir/host/m4-1.4.15/lib'此路径。&lt;/p>
&lt;div>
&lt;div id="code_jc5">
&lt;ol>
&lt;li>cd /home/jopark/Documents/openwrt-dreambox/build_dir/host/m4-1.4.15/lib&lt;/li>
&lt;/ol>
&lt;/div>
复制代码
&lt;/div>
对应路径自行修改自己对应的。
&lt;p>然后再在命令行输入：&lt;/p>
&lt;div>
&lt;div id="code_ggv">
&lt;ol>
&lt;li>sed -i -e '/gets is a security/d' ./stdio.in.h&lt;/li>
&lt;/ol>
&lt;/div>
复制代码
&lt;/div>
再重新编译即可。
&lt;p>或者手动打开stdio.in.h文件编辑，删除下面那行即可。&lt;/p>
&lt;div>
&lt;div id="code_aDh">
&lt;ol>
&lt;li>_GL_WARN_ON_USE (gets, &amp;quot;gets is a security hole - use fgets instead&amp;quot;);&lt;/li>
&lt;/ol>
&lt;/div>
复制代码
&lt;/div></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>编译OpenWrt for HG255D后记</title><link>https://blog.ferstar.org/post/build-openwrt-for-hg255d-note/</link><guid isPermaLink="true">https://blog.ferstar.org/post/build-openwrt-for-hg255d-note/</guid><pubDate>Wed, 06 Nov 2013 10:39:49 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>使能默认开启wifi&lt;/p>
&lt;p>/package/mac80211/files/lib/wifi／mac80211.sh&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>一切回归系统默认设置</title><link>https://blog.ferstar.org/post/roll-back-ro-the-factory-settings/</link><guid isPermaLink="true">https://blog.ferstar.org/post/roll-back-ro-the-factory-settings/</guid><pubDate>Mon, 04 Nov 2013 12:53:31 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>win7 64位&lt;/p>
&lt;blockquote>
&lt;p>恢复虚拟内存为系统管理&lt;/p>
&lt;p>恢复tmp到默认位置&lt;/p>
&lt;p>开启系统还原10%&lt;/p>
&lt;p>superfetch恢复&lt;/p>
&lt;p>……
系统到底是拿来用的，折腾点到为止。&lt;/p>
&lt;/blockquote>
&lt;p> &lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>Ubuntu-BackupYourSystem/TAR</title><link>https://blog.ferstar.org/post/ubuntu-backupyoursystemtar/</link><guid isPermaLink="true">https://blog.ferstar.org/post/ubuntu-backupyoursystemtar/</guid><pubDate>Sat, 02 Nov 2013 15:49:59 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;h1 id="httpshelpubuntucomcommunitybackupyoursystemtarhttpshelpubuntucomcommunitybackupyoursystemtar-source-site">&lt;a href="https://help.ubuntu.com/community/BackupYourSystem/TAR" title="source site">https://help.ubuntu.com/community/BackupYourSystem/TAR&lt;/a>&lt;/h1>
&lt;h1 id="introduction-to-tar">Introduction to tar&lt;/h1>
&lt;p>This page is part of the &lt;a href="https://help.ubuntu.com/community/BackupYourSystem">BackupYourSystem&lt;/a> article, as such, ensure you've read that prior to continuing. This subpage will acquaint a user with the tar archival program, a CLI solution to the creation of compressed archival backups. It will detail the creation and restoration of archives, including operation over a network.&lt;/p>
&lt;p>Before continuing users are encouraged to read the &lt;a href="https://help.ubuntu.com/community/TerminalHowto">TerminalHowto&lt;/a> page which explains many basic concepts related to working with a terminal.&lt;/p>
&lt;p>&lt;img src="https://help.ubuntu.com/community/IconsPage?action=AttachFile&amp;amp;do=get&amp;amp;target=stop.png" alt="IconsPage/stop.png" title="IconsPage/stop.png"> Improper usage of any archival program can cause unintended data loss. Read the entire tutorial before proceeding and understand what you are doing.&lt;/p>
&lt;p> &lt;/p>
&lt;h1 id="preparing-for-backup">Preparing for Backup&lt;/h1>
&lt;p>In preparation for a complete backup of the system, it is a good idea to empty the trash and remove any unwanted files and programs from your current installation. This includes the home folder which can be filled with many files not needed. Doing so will reduce the size of the archive created in relation to how much space is liberated.&lt;/p>
&lt;p>A quick list of examples is below, decide for yourself what applies:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Delete all your emails.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Wipe your saved browser personal details and search history.&lt;/p>
&lt;ul>
&lt;li>If you are not worried about the security concerns, this step is not necessary. Many users explicitly &lt;strong>want&lt;/strong> backups of their email and browser settings.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Unmount any external drives and remove any optical media such as CDs or DVDs that you do not want to include in the backup.&lt;/p>
&lt;ul>
&lt;li>This will reduce the amount of exclusions you need to type later in the process.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Go through the contents of your user folder in &lt;tt>/home&lt;/tt> and delete all unwanted files in the subdirectories, often people download files and forget about them for instance.
 &lt;/p>
&lt;/li>
&lt;/ul>
&lt;h1 id="backing-up">Backing Up&lt;/h1>
&lt;p>To get started, please open up a terminal, in Ubuntu this can be done by &lt;strong>Applications Menu&lt;/strong> -&amp;gt; &lt;strong>Accessories&lt;/strong> -&amp;gt; &lt;strong>Terminal&lt;/strong>. Some directories require root or superuser permissions to read and write (needed for backup), for an explanation on why see &lt;a href="https://help.ubuntu.com/community/FilePermissions">FilePermissions&lt;/a>. To gain temporary root permission, simply preface any command you want to issue with sudo, as explained in &lt;a href="https://help.ubuntu.com/community/RootSudo">RootSudo&lt;/a>.&lt;/p>
&lt;p>For this example, we will change directories to root. This is where the backup will be made. This is an arbitrary decision, you should create the backup elsewhere. For instance to a mounted external hard drive, another partition or disk connected internally, even a folder in your home directory could be used. In all cases, ensure the location your saving the archive to has enough space. Simply use the cd command to navigate there.&lt;/p>
&lt;pre>cd /&lt;/pre>
&lt;p>The following is an exemplary command of how to archive your system.&lt;/p>
&lt;pre>tar -cvpzf backup.tar.gz --exclude=/backup.tar.gz --one-file-system /&lt;/pre>
&lt;p>To understand what is going on, we will dissect each part of the command.&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>tar&lt;/strong> - is the command that creates the archive. It is modified by each letter immediately following, each is explained bellow.&lt;/p>
&lt;ul>
&lt;li>&lt;strong>c&lt;/strong> - create a new backup archive.&lt;/li>
&lt;li>&lt;strong>v&lt;/strong> - verbose mode, tar will print what it's doing to the screen.&lt;/li>
&lt;li>&lt;strong>p&lt;/strong> - preserves the permissions of the files put in the archive for restoration later.&lt;/li>
&lt;li>&lt;strong>z&lt;/strong> - compress the backup file with 'gzip' to make it smaller.&lt;/li>
&lt;li>&lt;strong>f &amp;lt;filename&amp;gt;&lt;/strong> - specifies where to store the backup, &lt;em>backup.tar.gz&lt;/em> is the filename used in this example. It will be stored in the current working directory, the one you set when you used the cd command.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>--exclude=/example/path&lt;/strong> - The options following this model instruct tar what directories &lt;strong>NOT&lt;/strong> to backup. We don't want to backup everything since some directories aren't very useful to include. The first exclusion rule directs tar not to back itself up, this is important to avoid errors during the operation.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>--one-file-system&lt;/strong> - Do not include files on a different filesystem. If you want other filesystems, such as a &lt;tt>/home&lt;/tt> partition, or external media mounted in &lt;tt>/media&lt;/tt> backed up, you either need to back them up separately, or omit this flag. If you do omit this flag, you will need to add several more &lt;strong>--exclude=&lt;/strong> arguments to avoid filesystems you do not want. These would be &lt;tt>/proc&lt;/tt>, &lt;tt>/sys&lt;/tt>, &lt;tt>/mnt&lt;/tt>, &lt;tt>/media&lt;/tt>, &lt;tt>/run&lt;/tt> and &lt;tt>/dev&lt;/tt> directories in root. &lt;tt>/proc&lt;/tt> and &lt;tt>/sys&lt;/tt> are virtual filesystems that provide windows into variables of the running kernel, so you do not want to try and backup or restore them. &lt;tt>/dev&lt;/tt> is a tmpfs whose contents are created and deleted dynamically by udev, so you also do not want to backup or restore it. Likewise, &lt;tt>/run&lt;/tt> is a tmpfs that holds variables about the running system that do not need backed up.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>It is important to note that these exclusions are recursive. This means that all folders located within the one excluded will be ignored as well. In the example, excluding the &lt;tt>/media&lt;/tt> folder excludes all mounted drives and media there.&lt;/p>
&lt;ul>
&lt;li>
&lt;p>If there are certain partitions you wish to backup located in &lt;tt>/media&lt;/tt>, simply remove the exclusion and write a new one excluding the partitions you don't want backed up stored within it. For example:&lt;/p>
&lt;pre>&lt;code>* &amp;lt;pre&amp;gt;--exclude=/media/unwanted_partition&amp;lt;/pre&amp;gt;
&lt;/code>&lt;/pre>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>/&lt;/strong> - After all options is the directory to backup. Since we want to backup everything on the system we use &lt;tt>/&lt;/tt> for the root directory. Like exclusions, this recursively includes every folder below root not listed in the exclusions or other options.
See tips before operation for additional information.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>Once satisfied with the command, execute it and wait until it has completed. The duration of the operation depends on the amount of files and compression choses. Once completed, check the directory you set to find the archive. In our example, backup.tar.gz would be located in the &lt;tt>/&lt;/tt> directory once completed. This archive can then be moved to any other directory for long term storage.&lt;/p>
&lt;p>Note: At the end of the process you might get a message along the lines of 'tar: Error exit delayed from previous errors' or something, but in most cases you can just ignore that.&lt;/p>
&lt;p> &lt;/p>
&lt;h2 id="additional-tips">Additional Tips&lt;/h2>
&lt;ul>
&lt;li>To keep good records, you should include the date and a description of backup in the filename.&lt;/li>
&lt;li>Another option would be to use bzip2 to compress your backup instead of gzip. Bzip2 provides a higher compression ratio at the expense of speed. If compression is important to you, just substitute the &lt;tt>z&lt;/tt> in the command with &lt;tt>j&lt;/tt>, and change the file name to &lt;em>.tar.bz2&lt;/em>. The rest of this guides examples use gzip, make the subsequent changes to the examples before using them.&lt;/li>
&lt;li>If you want to exclude all other mounts other than the current - by this I mean partitions mounted to directories - then use the &lt;tt>--one-file-system&lt;/tt> option appended before the exclusion rules. This has the effect of stopping tar from crossing into any other mounts in any directory including /mnt or /media. For instance, many users create a separate mount for &lt;tt>/home&lt;/tt> to keep user folders separate from root, adding this option to our original example would exclude home's contents entirely.
 &lt;/li>
&lt;/ul>
&lt;h2 id="archive-splitting">Archive Splitting&lt;/h2>
&lt;p>If you want to burn the archive to discs, or transfer them to a filesystem with a limited max filesize (say FAT32 with a limit of 4GB per file) then you will have to split the file either during or after archive creation. A simple means is to use the &lt;tt>split&lt;/tt> command. Below are examples of both scenarios. More information than conveyed here can be found in the man pages of split, use &lt;tt>man split&lt;/tt> in a terminal to read. Ensure you keep these archives all together in a directory you label for extraction at a later date. Once the archives are split to a desirable size, they can be burned one at a time to disc.&lt;/p>
&lt;p>&lt;strong>To Split During Creation&lt;/strong>&lt;/p>
&lt;pre>tar -cvpz &amp;lt;put options here&amp;gt; / | split -d -b 3900m - /name/of/backup.tar.gz.&lt;/pre>
&lt;ul>
&lt;li>The first half until the pipe (|) is identical to our earlier example, except for the omission of the f option. Without this, tar will output the archive to standard output, this is then piped to the split command.&lt;/li>
&lt;li>&lt;strong>-d&lt;/strong> - This option means that the archive suffix will be numerical instead of alphabetical, each split will be sequential starting with 01 and increasing with each new split file.&lt;/li>
&lt;li>&lt;strong>-b&lt;/strong> - This option designates the size to split at, in this example I've made it 3900mB to fit into a FAT32 partition.&lt;/li>
&lt;li>&lt;strong>-&lt;/strong> - The hyphen is a placeholder for the input file (normally an actual file already created) and directs split to use standard input.&lt;/li>
&lt;li>&lt;strong>/name/of/backup.tar.gz.&lt;/strong> Is the prefix that will be applied to all generated split files. It should direct to the folder you want the archives to end up. In our example, the first split archive will be in the directory /name/of/ and be named backup.tar.gz.01 .
&lt;strong>To Split After Creation&lt;/strong>&lt;/li>
&lt;/ul>
&lt;pre>split -d -b 3900m /path/to/backup.tar.gz /name/of/backup.tar.gz.&lt;/pre>
&lt;ul>
&lt;li>Here instead of using standard input, we are simply splitting an existing file designated by /path/to/backup.tar.gz .
&lt;strong>To Reconstitute the Archive&lt;/strong>
Reconstructing the complete archive is easy, first &lt;tt>cd&lt;/tt> into the directory holding the split archives. Then simply use &lt;tt>cat&lt;/tt> to write all the archives into one and send over standard output to tar to extract to the specified directory.&lt;/li>
&lt;/ul>
&lt;p> &lt;/p>
&lt;pre>cat *tar.gz* | tar -xvpzf - -C /&lt;/pre>
&lt;ul>
&lt;li>The use of * as a wild card before and after tar.gz tells cat to start with first matching file and add every other that matches, a process known as catenation, how the command got its name.&lt;/li>
&lt;li>Afterwards, it simply passes all that through standard output to tar to be extracted into root in this example.&lt;/li>
&lt;li>For a more complete explanation of restoration, see &lt;a href="https://wiki.ubuntu.com/starcraft.man/Sandbox#Restoring">Restoring&lt;/a>.
 &lt;/li>
&lt;/ul>
&lt;h2 id="backup-over-a-network">Backup Over a Network&lt;/h2>
&lt;p>The command tar does not include network support within itself, but when used in conjunction with other programs this can be achieved. Two common options are netcat (nc) and ssh.&lt;/p>
&lt;p> &lt;/p>
&lt;h3 id="netcat">Netcat&lt;/h3>
&lt;p>The command &lt;tt>nc&lt;/tt> is designed to be a general purpose networking tool. It sets up a simple connection between two networked machines. This connection survives until the user manually disconnects it, unlike normal connections such as tcp which terminate upon completion of a file.&lt;/p>
&lt;p>&lt;strong>Receiving Computer&lt;/strong>
On the receiving end you'll setup netcat to write the backup file as in the following example. This command will setup a machine to receive standard input from network to port 1024 then write it to the file backup.tar.gz. The choice of port is entirely up to the user, as long as it is 1024 or larger. A simple example:&lt;/p>
&lt;pre>nc -l 1024 &amp;gt; backup.tar.gz&lt;/pre>
&lt;p>&lt;strong>Sending Computer&lt;/strong>
On the machine to be backed up, the tar command will be piped to nc which will then send the backup over the network to the port in question to be written in the file. Take note, where it says &amp;lt;receiving host&amp;gt; replace with the name of the computer on the network. The f option was omitted since we are not writing to a local file, but moving the archive through standard output. The following is an example:&lt;/p>
&lt;pre>tar -cvpz &amp;lt;all those other options like above&amp;gt; / | nc -q 0 &amp;lt;receiving host&amp;gt; 1024&lt;/pre>
&lt;p>If all goes well the backup will be piped through the network without touching the file system being read.&lt;/p>
&lt;p> &lt;/p>
&lt;h3 id="ssh">SSH&lt;/h3>
&lt;p>You can also use SSH. For a complete explanation of its proper use see &lt;a href="https://help.ubuntu.com/community/SSH">SSH&lt;/a>. The command below is an example of what is possible.&lt;/p>
&lt;pre>tar -cvpz &amp;lt;all those other options like above&amp;gt; / | ssh &amp;lt;backuphost&amp;gt; "( cat &amp;gt; ssh_backup.tar.gz )"&lt;/pre>
&lt;p>In the example:&lt;/p>
&lt;ul>
&lt;li>The tar half of the command is the same as above, with the omission of the f option to pipe the archive via standard output to ssh and onto the networked computer.&lt;/li>
&lt;li>&lt;strong>ssh_backup.tar.gz&lt;/strong> Is the name of the file that will be created on the machine indicated.&lt;/li>
&lt;li>&lt;strong>&amp;lt;backuphost&amp;gt;&lt;/strong> - Should be replaced with the name of the computer in question on the network.
 &lt;/li>
&lt;/ul>
&lt;h1 id="restoring">Restoring&lt;/h1>
&lt;p>You will want to restore from a Live CD. If needed, first partition and format the drive. You can do this with &lt;tt>gparted&lt;/tt>. Then simply mount the partition you are going to restore somewhere. If you open the drive in nautilus, it will be auto mounted somewhere under &lt;tt>/media&lt;/tt>. Take a look to find out where with:&lt;/p>
&lt;pre>ls /media&lt;/pre>
&lt;p>&lt;strong>Restore Your Backup&lt;/strong>&lt;/p>
&lt;pre>sudo tar -xvpzf /path/to/backup.tar.gz -C /media/whatever --numeric-owner&lt;/pre>
&lt;p>A brief explanation:&lt;/p>
&lt;ul>
&lt;li>&lt;strong>x&lt;/strong> - Tells tar to extract the file designated by the f option immediately after. In this case, the archive is &lt;tt>/home/test/backup.tar.gz&lt;/tt>&lt;/li>
&lt;li>&lt;strong>-C &amp;lt;directory&amp;gt;&lt;/strong> - This option tells tar to change to a specific directory before extracting. In this example, we are restoring to the root (/) directory.&lt;/li>
&lt;li>&lt;strong>--numeric-owner&lt;/strong> - This option tells tar to restore the numeric owners of the files in the archive, rather than matching to any user names in the environment you are restoring from. This is due to that the user id:s in the system you want to restore don't necessarily match the system you use to restore (eg a live CD).
&lt;img src="https://help.ubuntu.com/community/IconsPage?action=AttachFile&amp;amp;do=get&amp;amp;target=warning.png" alt="IconsPage/warning.png" title="IconsPage/warning.png"> &lt;strong>This will overwrite every single file and directory on the designated mount with the one in the archive.&lt;/strong> Any file created after the archive, will have no equivalent stored in the archive and thus will remain untouched&lt;/li>
&lt;/ul>
&lt;p>Allow the restoration the time it needs to complete. Once extraction is completed, you may need to recreate directories that were not included in the original archive because you excluded them with &lt;tt>--exclude&lt;/tt>. This does not apply to filesystems excluded with &lt;tt>--one-file-system&lt;/tt>. This can be done with the following command:&lt;/p>
&lt;pre>mkdir /proc /sys /mnt /media&lt;/pre>
&lt;p>Once finished, reboot and everything should be restored to the state of your system when you made the backup.&lt;/p>
&lt;p> &lt;/p>
&lt;h2 id="restoring-grub">Restoring GRUB&lt;/h2>
&lt;p>For the system to boot, you will need to restore grub. To do this, you will need to reconfigure it in a chroot:&lt;/p>
&lt;pre>sudo -s
for f in dev dev/pts proc ; do mount --bind /$f /media/whatever/$f ; done
chroot /media/whatever
dpkg-reconfigure grub-pc&lt;/pre>
&lt;p>You will get a menu asking you what drive(s) grub should be installed on. Choose whatever drive(s) the computer will be booting from.&lt;/p>
&lt;p>For more information on repairing grub, see &lt;a href="https://help.ubuntu.com/community/GrubHowto#Backup,%20Repairing%20and%20Reinstalling%20GRUB">GrubHowto&lt;/a>&lt;/p>
&lt;p> &lt;/p>
&lt;h2 id="restoring-over-a-network">Restoring Over a Network&lt;/h2>
&lt;p>This short guide, assumes you employed nc to make the original backup as described above.&lt;/p>
&lt;p>&lt;strong>Receiving Computer&lt;/strong>
Ensure the disk has been mounted and use the following command to accept input over the network that will then be extracted to the path indicated. In this example, the directory &lt;tt>/mnt/disk&lt;/tt> will be extracted to.&lt;/p>
&lt;pre>nc -l 1024 | sudo tar -xvpzf - -C /media/whatever&lt;/pre>
&lt;p>&lt;strong>Sending Computer&lt;/strong>
On the computer with the archive to send, use the following command:&lt;/p>
&lt;pre>cat backup.tar.gz | nc -q 0 &amp;lt;receiving host&amp;gt; 1024&lt;/pre>
&lt;p>A few comments:&lt;/p>
&lt;ul>
&lt;li>The &lt;strong>-&lt;/strong> character in the first command will tell tar to accept input from standard input rather than a file. In this case, input comes from the pipe.&lt;/li>
&lt;li>The backup file will be expanded without being saved on the disk of receiving computer, the same as when the backup was made.
 &lt;/li>
&lt;/ul>
&lt;h1 id="additional-resources">Additional Resources&lt;/h1>
&lt;ul>
&lt;li>&lt;a href="http://hddsaver.com/content/26/">&amp;quot;Backing Up Ubuntu&amp;quot;&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://weichen.wordpress.com/2007/01/01/howto-backup-my-ubuntu/">&amp;quot;Wei’s world: HOWTO: backup my Ubuntu&amp;quot;&lt;/a>&lt;/li>
&lt;/ul></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>梳理下hg255d完美刷op的步骤</title><link>https://blog.ferstar.org/post/flash-hg25d-steps/</link><guid isPermaLink="true">https://blog.ferstar.org/post/flash-hg25d-steps/</guid><pubDate>Thu, 31 Oct 2013 20:33:46 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;ol>
&lt;li>&lt;span style="line-height: 15px;">原版uboot下刷1102-0x20000_hg255d-squashfs-tftp.checksum2&lt;/span>&lt;/li>
&lt;li>备份本机eeprom：cat /dev/mtd2 &amp;gt;/tmp/eeprom.bin&lt;/li>
&lt;li>TTL更换uboot&lt;/li>
&lt;li>刷op固件和之前备份的eeprom&lt;/li>
&lt;li>完成&lt;/li>
&lt;/ol></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/openwrt/">OPENWRT</category></item><item><title>openwrt中把wan转为lan的设置</title><link>https://blog.ferstar.org/post/openwrt-wan-to-lan/</link><guid isPermaLink="true">https://blog.ferstar.org/post/openwrt-wan-to-lan/</guid><pubDate>Sat, 26 Oct 2013 13:38:18 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>买路由中奖，无线信号渣到爆胎，无奈只好拿来当交换机使了，为了不浪费wan口，需要把他搞成lan口。下面三个链接：&lt;/p>
&lt;p>&lt;a href="http://wiki.openwrt.org/doc/recipes/bridgedap">http://wiki.openwrt.org/doc/recipes/bridgedap&lt;/a>&lt;/p>
&lt;p>&lt;strong>&lt;a href="https://forum.openwrt.org/viewtopic.php?pid=118095#p118095">https://forum.openwrt.org/viewtopic.php?pid=118095#p118095&lt;/a>&lt;/strong>&lt;/p>
&lt;p>&lt;a href="http://qing.blog.sina.com.cn/tj/6e2c147f330021ef.html">http://qing.blog.sina.com.cn/tj/6e2c147f330021ef.html&lt;/a>&lt;/p>
&lt;p>说的是两种方案，一是把LAN的interface eth0.1和WAN的interface eth0.2进行桥接，但在HG255D上失败，WAN口无法获取上级路由ip地址；二是通过划分vlan来实现，&lt;span style="color: #ff9900;">前提是你需要刷带有VLAN功能的OP固件&lt;/span>，据说比桥接方式性能更好，事实上HG255D只有这种方式有效，路由缺省network配置信息如下：&lt;/p>
&lt;p>config 'interface' 'loopback'
option 'ifname' 'lo'
option 'proto' 'static'
option 'ipaddr' '127.0.0.1'
option 'netmask' '255.0.0.0'&lt;/p>
&lt;p>config 'interface' 'lan'
option 'ifname' 'eth0.1'
option 'type' 'bridge'
option 'proto' 'static'
option 'ipaddr' '192.168.1.1'
option 'netmask' '255.255.255.0'
option 'macaddr' '00:0c:43:30:52:77'&lt;/p>
&lt;p>&lt;span style="color: #ff0000;">config 'interface' 'wan'&lt;/span>
&lt;span style="color: #ff0000;"> option 'ifname' 'eth0.2'&lt;/span>
&lt;span style="color: #ff0000;"> option 'proto' 'dhcp'&lt;/span>
&lt;span style="color: #ff0000;"> option 'macaddr' '11:1c:43:31:52:74'&lt;/span>&lt;/p>
&lt;p>config 'switch'
option 'name' 'rt305x'
option 'reset' '1'
option 'enable_vlan' '1'&lt;/p>
&lt;p>config 'switch_vlan'
option 'device' 'rt305x'
option 'vlan' '1'
&lt;span style="color: #00ff00;">option 'ports' '1 2 3 4 5 6t'&lt;/span>&lt;/p>
&lt;p>&lt;span style="color: #ff0000;">config 'switch_vlan'&lt;/span>
&lt;span style="color: #ff0000;"> option 'device' 'rt305x'&lt;/span>
&lt;span style="color: #ff0000;"> option 'vlan' '2'&lt;/span>
&lt;span style="color: #ff0000;"> option 'ports' '0 6t'&lt;/span>&lt;/p>
&lt;p>需要修改的地方有三处，红色部分删掉，绿色部分改为option 'ports' '0 1 2 3 4 5 6‘即可。&lt;/p>
&lt;p>PS：此方法其实不需要关dnsmasq，dhcp，虽然建议关闭，但实际上关不关都无所谓，我没发现有什么影响。另外有网友提到照这样设置后无法进入路由web设置界面，其实是可以进去的，网卡手动设置ip地址即可，192.168.1.xxx的形式。&lt;/p>
&lt;p>over&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/openwrt/">OPENWRT</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>用手机播放电脑硬盘的片片</title><link>https://blog.ferstar.org/post/i200-ushare-files/</link><guid isPermaLink="true">https://blog.ferstar.org/post/i200-ushare-files/</guid><pubDate>Mon, 21 Oct 2013 20:24:30 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>有时候想看片，但喜欢用手机看，又不想插数据线往手机上传片，一是麻烦，二是如果片太大手机未必能存的住，于是便有了此番尝试。&lt;/p>
&lt;p>PS：不算啥新技术，折腾DNLA感觉不好，还是用老办法，局域网共享，还是蛮方便的&lt;/p>
&lt;p>设备：笔电、普通无线路由、手机（i200）&lt;/p>
&lt;p>软件：ES文件管理器、MXplayer&lt;/p>
&lt;p>方法：笔电设置一个存片的文件夹为共享状态，手机开wifi连接路由，当然笔电也要连到路由，安装ES文件管理器，打开局域网页面，搜索，即可搜到笔电共享文件夹，打开之，有啥看啥，局域网速度没说的。&lt;/p>
&lt;p>&lt;img src="http://wp-ferstar.bcs.duapp.com/2013/10/QQ%E6%88%AA%E5%9B%BE20131021195050.png" alt="">&lt;/p>
&lt;p>over&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/%E6%89%8B%E6%9C%BA/">手机</category></item><item><title>两个利用RAM的软件</title><link>https://blog.ferstar.org/post/make-full-use-of-free-memory/</link><guid isPermaLink="true">https://blog.ferstar.org/post/make-full-use-of-free-memory/</guid><pubDate>Sun, 20 Oct 2013 19:55:00 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>SuperCache
RamDisk Plus
组合搭配，很给力的软件，充分利用多余内存。&lt;/p>
&lt;p>当然，对于win7,最好关闭superfetch。&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/windows/">WINDOWS</category></item><item><title>Bumblebee双显卡切换安装完成后的惊喜</title><link>https://blog.ferstar.org/post/bumblebee-installation/</link><guid isPermaLink="true">https://blog.ferstar.org/post/bumblebee-installation/</guid><pubDate>Sat, 19 Oct 2013 20:03:25 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>我大华硕Fn亮度控制终于正常了，至此ubuntu13.04下所有HotKey功能均能正常使用，以下是官方wiki安装说明：&lt;a href="https://wiki.ubuntu.com/Bumblebee#Installation" title="官方wiki页面">https://wiki.ubuntu.com/Bumblebee#Installation&lt;/a>&lt;/p>
&lt;h2 id="bumblebee-project">Bumblebee Project&lt;/h2>
&lt;p>Bumblebee aims to provide support for &lt;a href="http://www.nvidia.com/object/optimus_technology.html">NVIDIA Optimus&lt;/a> laptops for GNU/Linux distributions. Using Bumblebee, you can use your NVIDIA card for rendering graphics which will be displayed using the Intel card. Bumblebee has now become officially supported in Saucy or newer. However, prior releases are supported by the &lt;a href="https://launchpad.net/~bumblebee">Bumblebee Project community&lt;/a> from Ubuntu version 12.04 up to 13.04.&lt;/p>
&lt;h2 id="installation">Installation&lt;/h2>
&lt;p>Basic Setup&lt;/p>
&lt;p>You need to open your &lt;a href="http://askubuntu.com/questions/38162/what-is-the-terminal">terminal&lt;/a> and enter the commands below.&lt;/p>
&lt;p>If on 12.04.3, replace linux-headers-generic with linux-headers-generic-lts-raring.&lt;/p>
&lt;ol>
&lt;li>(not needed for 13.10 Saucy and newer) &lt;tt>sudo add-apt-repository ppa:bumblebee/stable&lt;/tt>&lt;/li>
&lt;li>Enable the Universe and Multiverse repositories (for bumblebee and nvidia packages respectively).&lt;/li>
&lt;li>&lt;tt>sudo apt-get update&lt;/tt>&lt;/li>
&lt;li>Install Bumblebee using the default proprietary nvidia driver:&lt;tt>sudo apt-get install bumblebee virtualgl linux-headers-generic&lt;/tt>&lt;/li>
&lt;li>Reboot
Advanced Setups&lt;/li>
&lt;/ol>
&lt;p>For advanced users, if you do not want to use the proprietary nvidia driver or 32-bit libraries (for example, if you are only interested in power savings), you can do your custom installation.&lt;/p>
&lt;p>Minimal setup : &lt;tt>sudo apt-get install --no-install-recommends bumblebee&lt;/tt>&lt;/p>
&lt;p>Depending on your needs, add to this line:&lt;/p>
&lt;ul>
&lt;li>&lt;tt>bumblebee-nvidia&lt;/tt>: proprietary nvidia driver support (if installed, become default over nouveau)&lt;/li>
&lt;li>&lt;tt>virtualgl&lt;/tt>: VirtualGL as backend&lt;/li>
&lt;li>&lt;tt>virtualgl-libs-ia32&lt;/tt>: 32bit support for VirtualGL on 64bit system, necessary to run 32bit app through optirun&lt;/li>
&lt;li>&lt;tt>primus&lt;/tt>: primus/primusrun as backend (virtualgl Stays default, you need to run &lt;tt>optirun -b primus &amp;lt;app&amp;gt;&lt;/tt>)&lt;/li>
&lt;li>&lt;tt>primus-libs-ia32&lt;/tt>: 32bit support for primus/primurun on 64bit system, necessary to run 32bit app through optirun&lt;/li>
&lt;/ul>
&lt;h2 id="usage">Usage&lt;/h2>
&lt;p>To run your application with the discrete NVIDIA card run in the terminal:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>$ &lt;tt>optirun [options] &amp;lt;application&amp;gt; [application-parameters]&lt;/tt>
Example:&lt;/p>
&lt;/li>
&lt;li>
&lt;p>$ &lt;tt>optirun firefox&lt;/tt>
For a list of options for &lt;tt>optirun&lt;/tt> run:&lt;/p>
&lt;/li>
&lt;li>
&lt;p>$ &lt;tt>optirun --help&lt;/tt>
Normally you do &lt;strong>not&lt;/strong> use &lt;tt>optirun&lt;/tt> for your window manager, installations or other non graphic heavy demanding programs. The &lt;tt>optirun&lt;/tt> command is mainly used for graphic demanding programs or for games.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="power-management">Power Management&lt;/h2>
&lt;p>A primary goal of this project is to not only enable use of the discrete GPU for rendering, but also to enable smart power management of the dGPU when it's not in use. We're using either bbswitch (a module) or vga_switcheroo (kernel module, experimental) to do this in Bumblebee.&lt;/p>
&lt;p>Since Bumblebee 3.0, this feature is enabled by default, using &lt;a href="https://github.com/Bumblebee-Project/bbswitch">bbswitch&lt;/a>. This allow automatic power management, without any configuration needs.&lt;/p>
&lt;p>If Power Management doesn't work on your laptop, please go to this &lt;a href="http://wiki.bumblebee-project.org/Power-Management">Power Management (PM)&lt;/a> page and help to improve Bumblebee.&lt;/p>
&lt;h2 id="troubleshooting">Troubleshooting&lt;/h2>
&lt;p>&amp;quot;Cannot access secondary GPU&amp;quot; error&lt;/p>
&lt;p>In LTS 12.04.3, 13.04 and later, if your card seems to be inaccessible, i.e.&lt;tt>[ERROR]Cannot access secondary GPU - error: [XORG] (EE) No devices detected.&lt;/tt> you need to edit the /etc/bumblebee/xorg.conf.nvidia (or /etc/bumblebee/xorg.conf.nouveau if using the noveau driver) and specify the correct BusID by following the instructions therein.&lt;/p>
&lt;h2 id="updating-drivers">Updating drivers&lt;/h2>
&lt;p>The Bumblebee project recommends you install drivers only through APT and not drivers provided by nvidia.com directly. This said, whenever you update your drivers through the supported repositories, you need to setup the correct config values in &lt;tt>/etc/bumblebee/bumblebee.conf&lt;/tt>. See also &lt;a href="https://github.com/Bumblebee-Project/Bumblebee/wiki/Troubleshooting#bumblebeed-module-nvidia-is-not-found">this FAQ on github&lt;/a>&lt;/p>
&lt;h3 id="example-update-to-nvidia-319-driver">Example update to nvidia-319 driver&lt;/h3>
&lt;p>E.g. to update to the latest update of 319.x driver, you need to install it through apt.&lt;/p>
&lt;p>&lt;tt>sudo apt-get install nvidia-319-updates nvidia-settings-319-updates&lt;/tt>&lt;/p>
&lt;p>Then you need to edit &lt;tt>/etc/bumblebee/bumblebee.conf&lt;/tt> and set:&lt;/p>
&lt;p>&lt;tt>KernelDriver=nvidia_319_updates&lt;/tt>&lt;/p>
&lt;p>&lt;tt>LibraryPath=/usr/lib/nvidia-319-updates:/usr/lib32/nvidia-nvidia-319-updates&lt;/tt>&lt;/p>
&lt;p>&lt;tt>XorgModulePath=/usr/lib/nvidia-319-updates/xorg,/usr/lib/xorg/modules&lt;/tt>&lt;/p>
&lt;p>By running &lt;tt>optirun nvidia-settings&lt;/tt> (or &lt;tt>optirun -b none nvidia-settings -c :8&lt;/tt>) you can assert you are using the installed kernel module and driver.&lt;/p>
&lt;p> &lt;/p>
&lt;h2 id="irc">IRC&lt;/h2>
&lt;p>Please join &lt;a href="http://webchat.freenode.net/?channels=#bumblebee">#bumblebee&lt;/a> channel on Freenode if you wish to help testing and creating the installer.&lt;/p>
&lt;p> &lt;/p>
&lt;h2 id="reporting-bugsproblems">Reporting bugs/problems&lt;/h2>
&lt;p>First of all: If you have any problem, please read this article: &lt;a href="http://wiki.bumblebee-project.org/Troubleshooting">http://wiki.Bumblebee-Project.org/Troubleshooting&lt;/a>&lt;/p>
&lt;p>If your issue is not solved, you can join the &lt;a href="http://webchat.freenode.net/?channels=#bumblebee">#bumblebee&lt;/a> IRC channel to ask for help (recommended). See also &lt;a href="http://wiki.bumblebee-project.org/Reporting-Issues">http://wiki.Bumblebee-Project.org/Reporting-Issues&lt;/a>&lt;/p>
&lt;p>If you're asked to create a bugreport, run the next command in a terminal: &lt;tt>sudo bumblebee-bugreport&lt;/tt>&lt;/p>
&lt;p> &lt;/p>
&lt;h2 id="uninstall">Uninstall&lt;/h2>
&lt;p>If you're unsatisfied with Bumblebee, you can remove it via:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>&lt;tt>sudo apt-get install ppa-purge&lt;/tt>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;tt>sudo ppa-purge ppa:bumblebee/stable&lt;/tt>
If you want to keep some programs from the bumblebee repository, you can also suffice by removing Bumblebee only (including its dependencies):&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;tt>sudo apt-get purge bumblebee&lt;/tt>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;tt>sudo apt-get --purge autoremove&lt;/tt>
 &lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="social-media">Social Media&lt;/h2>
&lt;p>Follow us on: &lt;a href="http://www.facebook.com/BumblebeeProject">Facebook&lt;/a>, &lt;a href="https://twitter.com/#!/Team_Bumblebee">Twitter&lt;/a> and &lt;a href="http://gplus.to/Bumblebee">Google+&lt;/a>.&lt;/p>
&lt;p> &lt;/p>
&lt;h2 id="cuda">CUDA&lt;/h2>
&lt;p>There is sometimes confusion about CUDA. You don't need Bumblebee to run CUDA. Follow the &lt;a href="http://askubuntu.com/questions/131506/how-can-i-get-nvidia-cuda-or-opencl-working-on-a-laptop-with-nvidia-discrete-car">How-to&lt;/a> to get CUDA working under Ubuntu.&lt;/p>
&lt;p>There is however a new feature (--no-xorg option for optirun) in Bumblebee 3.2, which makes it possible to run CUDA / OpenCL applications that does not need the graphics rendering capabilities.&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>在hg255d中加入定时计划任务</title><link>https://blog.ferstar.org/post/hg255d-corn-tasks/</link><guid isPermaLink="true">https://blog.ferstar.org/post/hg255d-corn-tasks/</guid><pubDate>Sat, 19 Oct 2013 17:58:51 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>学校这学期很仁慈的晚上不断电，所以给路由器加个每天早上定时拨号的任务，省却手动web联网的麻烦，一张图说明真相：有个软件包必须装luci-app-ntpc，用来校正路由时间&lt;/p>
&lt;p>&lt;img src="http://wp-ferstar.bcs.duapp.com/2013/10/DeepinScrot-5508.png" alt="">&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/openwrt/">OPENWRT</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category></item><item><title>深度截图工具是个好东西</title><link>https://blog.ferstar.org/post/linux-deepin-scrot/</link><guid isPermaLink="true">https://blog.ferstar.org/post/linux-deepin-scrot/</guid><pubDate>Sat, 19 Oct 2013 17:45:18 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>深度截图工具比ubuntu比自带的截图强大很多，类qq截图，简单安装步骤如下&lt;/p>
&lt;ol>
&lt;li>git clone https://github.com/linuxdeepin-packages/deepin-scrot.git&lt;/li>
&lt;li>cd deep-scrot&lt;/li>
&lt;/ol>
&lt;ol start="3">
&lt;li>./updateTranslate.sh&lt;/li>
&lt;li>cd ./src/&lt;/li>
&lt;li>./deepinScrot.py #提示缺少Xlib&lt;/li>
&lt;li>sudo apt-fast install python-xlib&lt;/li>
&lt;li>键盘设置路径~/deepin-scrot/src/deepin-scrot %u 快捷键设置为ctrl+alt+A组合，如下链接所示&lt;a href="http://hi.baidu.com/ferstar/item/3508c70c2ba82413cd34ea35">http://hi.baidu.com/ferstar/item/3508c70c2ba82413cd34ea35&lt;/a>&lt;/li>
&lt;li>完成&lt;/li>
&lt;/ol></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/linux/">LINUX</category><category domain="https://blog.ferstar.org/tags/shell/">SHELL</category></item><item><title>好像发现i200频繁唤醒的原因</title><link>https://blog.ferstar.org/post/%E5%A5%BD%E5%83%8F%E5%8F%91%E7%8E%B0i200%E9%A2%91%E7%B9%81%E5%94%A4%E9%86%92%E7%9A%84%E5%8E%9F%E5%9B%A0/</link><guid isPermaLink="true">https://blog.ferstar.org/post/%E5%A5%BD%E5%83%8F%E5%8F%91%E7%8E%B0i200%E9%A2%91%E7%B9%81%E5%94%A4%E9%86%92%E7%9A%84%E5%8E%9F%E5%9B%A0/</guid><pubDate>Sun, 06 Oct 2013 18:57:51 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>应该是更改了sales_code.dat的问题，默认VZW改成CHN后增加了一些有趣的功能，比如原生归属地，日历农历显示等，不过却导致频繁唤醒，待机耗电增加，还有hidden menu功能无法使用，貌似得不偿失，再观察一段时间看看是不是这个问题&lt;/p>
&lt;p>仔细对比，没啥实质性区别，看来是心理作用，阿门！&lt;/p>
&lt;p>&lt;strong>准备用绿色守护折腾下，亚马逊下单搞起！&lt;/strong>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>I200/I535等洋垃圾上不了网或者信号不稳的解决方法</title><link>https://blog.ferstar.org/post/i200-solve-the-3g-connecting-problems/</link><guid isPermaLink="true">https://blog.ferstar.org/post/i200-solve-the-3g-connecting-problems/</guid><pubDate>Sun, 06 Oct 2013 14:54:07 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>源链接：&lt;a href="http://android.tgbus.com/Android/yizhi/201306/472570.shtml">http://android.tgbus.com/Android/yizhi/201306/472570.shtml&lt;/a> 完全可以适用于I200，或者三星所有**&lt;a href="http://www.baidu.com/s?wd=galaxy&amp;amp;f=12&amp;amp;rsp=0&amp;amp;oq=glaxy&amp;amp;ie=utf-8">galaxy&lt;/a> **系列洋垃圾手机，一般是V版定制机拿到国内后能通话但不能3G或者网络时断时续的问题，以下是原文，最好照做：&lt;/p>
&lt;p>I535/V版三星I9300上不了网怎么办？今天小编就来教教大家如何解决这个问题。&lt;/p>
&lt;p>i535 电信卡或其他卡上不了网都可以这样解决，小编测试的是官方4.12系统。--理论上所有三星V版机都能通用的上网设置。&lt;/p>
&lt;p>前言：&lt;/p>
&lt;p>无论你的是4.04还是4.11还是4.12，你首先要做的是下载官方的系统，你现在是什么系统就下什么系统，是4.01就下个4.01,4.11就下4.11的，4.12就下4.12的，必须是官方的。因为官方的系统可以进入隐藏的菜单。非官方的系统下，包括HTC,三星等等其它手机，在非官方系统下，有可能在拨号界面下输入“*#.....”之类的代码是无任何显示的，因为ROM制作者可能把系统过于优化，使得隐藏菜单无法打开。所以有些用户在输入网上的教程的代码无显示，这是正常现象。&lt;/p>
&lt;p>（已经是官方系统的朋友可以到下面1和2步骤，尝试完重启手机试一下能不能上网，不能就继续看下去）&lt;/p>
&lt;p>I535/V版三星I9300上不了网解决方法开始：&lt;/p>
&lt;p>电脑请先安装豌豆荚&lt;/p>
&lt;p>手机不用理会什么解锁之类的。直接先线刷好官方的系统（线刷官方系统之前先安装一张有信号能用的电信卡到手机上）&lt;/p>
&lt;p>刷完系统后手机自动重启，自动进入检测是否有电信卡，有电信卡，手机才进入设置向导，进入设置向导后，直接按手机中间的HOME键退出设置向导，手机直接跳到桌面。&lt;/p>
&lt;p>手机开机后进入桌面后。第一时间打开手机的：设置--开发人员选项--打开USB调试，退出到手机桌面。手机链接电脑，豌豆荚自动安装手机驱动。安装完之后。拔掉手机数据线。&lt;/p>
&lt;p>接下来，手机进入拨号界面（打电话的地方）。进入隐藏菜单修改USB设置,用于后面QPST连接手机--QPST是用来修改手机网络数据的软件。怎么进入隐藏菜单？请看：&lt;/p>
&lt;p>1.打开拨号界面后.输入*#22745927,自动进入.看到：Hidden Menu Disable的英文后点击这行英文,点完就会弹出一个窗口，点击enable这行英文,再点击OK,点完直接按手机中间HOME键回到手机桌面，第一步完成。&lt;/p>
&lt;p>2继续在拨号界面输入：*#197328640#,选择CDMA，进去后选择：DATA，再选ehrpd，再点击disable即可。直接按手机中间HOME键，这时候手机已经默认开启了eHRPD（已经是官方系统的朋友可以到这一步就可以尝试重启手机试一下能不能上网，不能就继续看下去）&lt;/p>
&lt;p>3再次打开拨号器,输入**87284,  看到英文PhoneUtil，点击进去.选择&amp;quot;PDA&amp;quot;.再点击下面的&amp;quot;Qualcomm USB Settings&amp;quot;， 选择 &amp;quot;DM+MODEM+ADB&amp;quot;这一行,点击&amp;quot;OK&amp;quot;.然后按手机中间HOME键退出。&lt;/p>
&lt;p>4上百度下载到电脑：QPST_2.7.378（低于这版本的话，手机设置完上面的1、2后无法被电脑识别的），下载完之后解压在电脑桌面。安装。装完继续看下面。&lt;/p>
&lt;p>5手机用数据线链接电脑，用电脑鼠标右键点击电脑桌面上的：我的电脑（WIN7系统叫计算机）选：设备管理器，再点击：端口，看到有SAMSUNG mobile USB...(COM数字)这一行，就代表链接上了，记下COM后面那个数字。记好。&lt;/p>
&lt;p>&lt;img src="http://img2.tgbusdata.cn/v2/thumb/jpg/NDVEMiw1ODAsMTAwLDQsMywxLC0xLDAscms1MCw2MS4xNTIuMjQyLjEx/u/android.tgbus.com/Android/UploadFiles_4504/201306/2013060517061684.jpg" alt="">&lt;/p>
&lt;p>　　6打开电脑的左下角的：开始，找到QPST这一行，点一下进去，看到：QPST Configuration，点击。电脑会弹出一个框，选择Ports&lt;/p>
&lt;p>点击被蓝色选中的那行。&lt;/p>
&lt;p>再点击右下角的Add New Port的英文,&lt;/p>
&lt;p>看到有两行英文，Port和Port Lable，在Port和port lable中都输入：COM24(你的电脑上的端口显示数字多少就输入多少),输入完成后，点击OK。点击完，关掉这个设置软件。&lt;/p>
&lt;p>7：i535插电信卡能语音但不能3G上网,一般是设置错误或原封机回来没有进行国内网络参数设置。下面继续：&lt;/p>
&lt;p>再次打开开始菜单选择QPST-找到Service Programming这一行，点击打开。&lt;/p>
&lt;p>&lt;img src="http://img2.tgbusdata.cn/v2/thumb/jpg/QTZFNyw1ODAsMTAwLDQsMywxLC0xLDAscms1MCw2MS4xNTIuMjQyLjEx/u/android.tgbus.com/Android/UploadFiles_4504/201306/2013060517061682.jpg" alt="">&lt;/p>
&lt;p>　　点击提示有红色涂改的一行英文，然后点击下面的：OK。电脑正常弹出个窗口提示 &amp;quot;服务器正在运行&amp;quot;什么的那个框,直接点：重试，如果没有进入下图一样的界面，请连续点重试：&lt;/p>
&lt;p>点击写着M.IP的地方（软件右上角有箭头移动的），进去M.IP后看到中间有：mobile IP 一行，点击选择Simple IP Only ,下面选2000ms,再勾选下面的勾，认真看上图，其实很简单，不要害怕，不要担心，你可以的。哪怕不懂英文，会看图就OK。其他东西一切不要动，就算和上图不同，就算你的是空白，也不要担心不要害怕，到这一步你已经差不多成功了。&lt;/p>
&lt;p>8继续在这个软件右上角点两个小箭头，&lt;/p>
&lt;p>点右边的箭头，看到PPP config，点击进去，中间第二项写着：Um，点UM进去后看软件的右边，User下面的空白处填：&lt;a href="mailto:ctwap@mycdma.cn">ctwap@mycdma.cn&lt;/a>，password这一行填：vnet.mobi&lt;/p>
&lt;p>其它不用动，哪怕是空白；&lt;/p>
&lt;p>9填完点这个软件的左下角的Write to Phone这一行：&lt;/p>
&lt;p>10--点完就会弹出一个框，写着0000的，不用管，直接点OK。&lt;/p>
&lt;p>点完OK软件左上角有东西会动，完成后手机自动重启动。电脑会弹出一个英文提示框，大概意思是USB链接失败，不用管。直接拔数据线。&lt;/p>
&lt;p>11：手机拨号界面重新输入：.输入*#22745927,自动进入.看到：Hidden Menu Disable的英文后点击这行英文,点完就会弹出一个窗口，点击enable这行英文,再点击OK,点完直接按手机中间HOME键回到手机桌面，再次打开拨号器,输入**87284,  看到英文PhoneUtil，点击进去.选择&amp;quot;PDA&amp;quot;.再点击下面的&amp;quot;Qualcomm USB Settings&amp;quot;，选择&amp;quot;MTP + ADB&amp;quot;，退出到桌面。OK搞定。&lt;/p>
&lt;p>第11步原因是--每次用QPST操作完后都要记得在Qualcomm USB Settings里恢复原来的&amp;quot;MTP + ADB&amp;quot;不恢复的话，手机接电脑是认不出USB的。&lt;/p>
&lt;p>12：这时候可以去下载官方或非官方的ROM（ROM是系统意思）并带权限的，刷完后，装个海卓，随便切换网络都有信号能上网啦，移动有E网，联通有E网（没试过 ）估计没H网，电信有3G。&lt;/p>
&lt;p>希望这篇教程能帮助大家解决I535/V版三星I9300上不了网的问题。&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/%E6%89%8B%E6%9C%BA/">手机</category></item><item><title>HG255D路由常见问题解决方法</title><link>https://blog.ferstar.org/post/some-questions-about-the-router/</link><guid isPermaLink="true">https://blog.ferstar.org/post/some-questions-about-the-router/</guid><pubDate>Wed, 02 Oct 2013 13:47:54 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>&lt;strong>手机浏览本文推荐UC浏览器，如发现显示不全的图片，只需要在图片上长按，点击查看图片即可看到全图，可双指缩放&lt;/strong>
打开wifi连接到路由器，然后手机浏览器登陆192.168.1.1，如图&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="http://wp-ferstar.bcs.duapp.com/2013/10/Screenshot_2013-10-02-13-32-12.png" alt="">&lt;/p>
&lt;p>&lt;span style="color: #ff0000;">&lt;strong>问题一：手机能连到路由，却不能上网&lt;/strong>&lt;/span>&lt;/p>
&lt;p>&lt;img src="http://wp-ferstar.bcs.duapp.com/2013/10/%E6%B2%A1%E6%9C%89%E7%99%BB%E5%BD%95%E7%9A%84%E7%8A%B6%E6%80%81.png" alt="">&lt;/p>
&lt;p>解决方法：依次点击“服务”-“校园网认证”如图，填入你的上网账号密码，只需一次以后都不用填，然后点击保存应用即可&lt;/p>
&lt;p>&lt;img src="http://wp-ferstar.bcs.duapp.com/2013/10/%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2.png" alt="">&lt;/p>
&lt;p>返回到总览页面，查看路由联网状态&lt;/p>
&lt;p>&lt;img src="http://wp-ferstar.bcs.duapp.com/2013/10/%E6%AD%A3%E5%B8%B8%E8%81%94%E7%BD%91%E7%8A%B6%E6%80%81.png" alt="">&lt;/p>
&lt;p>&lt;span style="color: #ff0000;">&lt;strong>问题二：手机连不到路由器，老是获取不到ip地址&lt;/strong>&lt;/span>&lt;/p>
&lt;p>解决方法：这是由于路由器DHCP服务（就是自动分配ip地址的作用）没有正常启动，所以需要手动分配ip地址连接路由去启动它（这里以安卓手机为例，其他手机大同小异）&lt;/p>
&lt;p>&lt;img src="http://wp-ferstar.bcs.duapp.com/2013/10/%E6%89%8B%E6%9C%BA%E7%AB%AF%E4%BF%AE%E6%94%B9%E7%BD%91%E7%BB%9C.png" alt="">&lt;/p>
&lt;p>在弹出的菜单里选择高级设置，把ip获取策略改为静态&lt;/p>
&lt;p>&lt;img src="http://wp-ferstar.bcs.duapp.com/2013/10/%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E8%AE%BE%E7%BD%AE.png" alt="">&lt;/p>
&lt;p>ip地址手动设置一般是192.168.1.x (x是大于100小于254的整数)，网关：192.168.1.1具体如图所示：&lt;/p>
&lt;p>[caption id=&amp;quot;&amp;quot; align=&amp;quot;alignnone&amp;quot; width=&amp;quot;480&amp;quot;]&lt;img src="http://wp-ferstar.bcs.duapp.com/2013/10/%E8%AF%A6%E7%BB%86ip%E8%AE%BE%E7%BD%AE.png" alt=""> 设置好后点连接[/caption]&lt;/p>
&lt;p>然后你的手机就可以正常连接路由了，可以开浏览器进入管理界面，如图设置&lt;/p>
&lt;p>&lt;img src="http://wp-ferstar.bcs.duapp.com/2013/10/%E9%87%8D%E5%90%AFdhcp%E6%9C%8D%E5%8A%A1.png" alt="">&lt;/p>
&lt;p>什么都不用更改，直接点击右下角保存应用，dhcp服务即可恢复正常，联网设备即可正常自动获取到ip。&lt;/p>
&lt;p>最后附一张正常工作状态图&lt;/p>
&lt;p>&lt;img src="http://wp-ferstar.bcs.duapp.com/2013/10/%E6%AD%A3%E5%B8%B8%E8%BF%90%E8%A1%8C%E7%8A%B6%E6%80%81.png" alt="">&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>路由器简单设置教程</title><link>https://blog.ferstar.org/post/simple-setting-tutorial/</link><guid isPermaLink="true">https://blog.ferstar.org/post/simple-setting-tutorial/</guid><pubDate>Mon, 30 Sep 2013 22:24:31 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;blockquote>
&lt;p>&lt;strong>&lt;span style="line-height: 1.714285714; font-size: 1rem;">手机浏览本文推荐使用UC浏览器，如发现显示不全的图片，只需要在图片上长按，点击查看图片即可看到全图，可双指缩放&lt;/span>&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;p>首先需要打开接入设备的WIFI开关，并搜索NWU_开头的无线信号&lt;/p>
&lt;p>&lt;img src="http://wp-ferstar.bcs.duapp.com/2013/09/0%E8%BF%9E%E6%8E%A5%E8%B7%AF%E7%94%B1%E5%99%A8.png" alt="">&lt;/p>
&lt;p>[caption id=&amp;quot;&amp;quot; align=&amp;quot;aligncenter&amp;quot; width=&amp;quot;1093&amp;quot;]&lt;img src="http://wp-ferstar.bcs.duapp.com/2013/09/1%E7%99%BB%E9%99%86.png" alt=""> 进入路由设置页面[/caption]&lt;/p>
&lt;p>[caption id=&amp;quot;&amp;quot; align=&amp;quot;aligncenter&amp;quot; width=&amp;quot;1091&amp;quot;]&lt;img src="http://wp-ferstar.bcs.duapp.com/2013/09/2%E6%80%BB%E8%A7%88.png" alt=""> 总览信息[/caption]&lt;/p>
&lt;p>[caption id=&amp;quot;&amp;quot; align=&amp;quot;aligncenter&amp;quot; width=&amp;quot;1092&amp;quot;]&lt;img src="http://wp-ferstar.bcs.duapp.com/2013/09/3%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%85%8D%E7%BD%AE%E7%95%8C%E9%9D%A2.png" alt=""> 内嵌客户端配置界面[/caption]&lt;/p>
&lt;p>[caption id=&amp;quot;&amp;quot; align=&amp;quot;aligncenter&amp;quot; width=&amp;quot;1093&amp;quot;]&lt;img src="http://wp-ferstar.bcs.duapp.com/2013/09/4%E6%9B%B4%E6%94%B9WiFi%E8%AE%BE%E7%BD%AE.png" alt=""> 更改无线设置[/caption]&lt;/p>
&lt;p>[caption id=&amp;quot;&amp;quot; align=&amp;quot;aligncenter&amp;quot; width=&amp;quot;1093&amp;quot;]&lt;img src="http://wp-ferstar.bcs.duapp.com/2013/09/5WiFi%E5%9F%BA%E6%9C%AC%E8%AE%BE%E7%BD%AE.png" alt=""> wifi基本设置[/caption]&lt;/p>
&lt;p>[caption id=&amp;quot;&amp;quot; align=&amp;quot;aligncenter&amp;quot; width=&amp;quot;1093&amp;quot;]&lt;img src="http://wp-ferstar.bcs.duapp.com/2013/09/6WiFi%E5%8A%A0%E5%AF%86.png" alt=""> wifi加密设置[/caption]&lt;/p>
&lt;p>[caption id=&amp;quot;&amp;quot; align=&amp;quot;aligncenter&amp;quot; width=&amp;quot;1093&amp;quot;]&lt;img src="http://wp-ferstar.bcs.duapp.com/2013/09/7%E6%9F%A5%E8%AF%A2%E8%81%94%E7%BD%91%E7%8A%B6%E6%80%81.png" alt=""> 联网状态查询[/caption]&lt;/p>
&lt;p>[caption id=&amp;quot;&amp;quot; align=&amp;quot;aligncenter&amp;quot; width=&amp;quot;1093&amp;quot;]&lt;img src="http://wp-ferstar.bcs.duapp.com/2013/09/8%E4%B8%8D%E7%94%A8%E6%8C%89%E5%BC%80%E5%85%B3%E7%9A%84%E9%87%8D%E5%90%AF%E6%96%B9%E5%BC%8F.png" alt=""> 遥控(不用手动按电源开关)重启路由器的方法[/caption]&lt;/p>
&lt;p> &lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item><item><title>三星i200电信屌丝机的一些资源</title><link>https://blog.ferstar.org/post/resource-for-samsung-i200/</link><guid isPermaLink="true">https://blog.ferstar.org/post/resource-for-samsung-i200/</guid><pubDate>Fri, 30 Aug 2013 20:54:24 +0800</pubDate><copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</copyright><description>&lt;p>刷机包、root工具、REC、超频补丁、个性化CSC配置文件等等，需要的自取&lt;/p>
&lt;p>&lt;a href="http://pan.baidu.com/share/link?shareid=1424759246&amp;amp;uk=1006992502" title="点我直达">http://pan.baidu.com/share/link?shareid=1424759246&amp;amp;uk=1006992502&lt;/a>&lt;/p></description><category domain="https://blog.ferstar.org/post/">post</category><category domain="https://blog.ferstar.org/tags/others/">OTHERS</category></item></channel></rss>